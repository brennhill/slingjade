<?xml version="1.0" encoding="UTF-8"?>
<jcr:root xmlns:cq="http://www.day.com/jcr/cq/1.0" xmlns:jcr="http://www.jcp.org/jcr/1.0"
          xmlns:nt="http://www.jcp.org/jcr/nt/1.0"
          jcr:primaryType="cq:Dialog"
          title="FAQ"
          height="600"
          width="900"
          xtype="dialog">
    <items
            jcr:primaryType="nt:unstructured"
            xtype="tabpanel">
       <items jcr:primaryType="cq:WidgetCollection">
            <questions
                    jcr:primaryType="cq:Widget"
                    title="Questions"
                    xtype="panel">
                <items jcr:primaryType="cq:WidgetCollection">
                     <multifield
                         jcr:primaryType="cq:Widget"
                         customMultiFieldName="./questions"
                         hideLabel="false"
                         fieldLabel="Questions: "
                         name="./questions"
                         xtype="custommultifield">
                         <fieldConfig jcr:primaryType="cq:WidgetCollection">
                             <questionId
                                    name="./questionId" 
                                    jcr:primaryType="cq:Widget"
                                    defaultValue="-1"
                                    xtype="hidden" >
                                <listeners
                                           jcr:primaryType="nt:unstructured"
                                           afterrender = "function(me) {
                                                                var max = 0;
                                                                if (me.getValue() == '') {
                                                                    var parent = me.findParentByType('custommultifield');
                                                                    if (parent == null) {
                                                                      return;
                                                                    }
                                                                    var catIds = parent.find('name', me.getName() );
                                                                    for (var i = 0; i &lt; catIds.length; i++) {
                                                                       var item = catIds[i];
                                                                       var value = parseInt(item.getValue());
                                                                       if (value != null &amp;&amp; value > max) max = value;
                                                                    }
                                                                    me.setValue(++max);
                                                                    me.fireEvent('loadcontent', me);
                                                                }
                                                                return true;
                                                            }" />
                             </questionId>
                             <categorySelection
                                     jcr:primaryType="cq:Widget"
                                     fieldLabel="Category"
                                     name="./category"
                                     type="select"
                                     allowBlank="false"
                                     xtype="selection"
                                     width="{Long}175"
                                     boxMaxWidth="{Long}200"
                                     options="$PATH.categories"
                                     optionsRoot="categories"
                                     optionsTextField="name"
                                     optionsValueField ="index">
                                 <listeners jcr:primaryType="nt:unstructured"
                                         afterrender ="function(me) {
                                            if (typeof window.CQext.faqModule !== 'undefined')
                                                window.CQext.faqModule.fillQuestionCategories(me);
                                            return true;
                                        }" />
                             </categorySelection>
                             <question
                                 jcr:primaryType="cq:Widget"
                                 fieldLabel="Question:"
                                 name="./question"
                                 xtype="textfield"/>
                             <answer
                                          jcr:primaryType="cq:Widget"
                                          fieldLabel="Answer:"
                                          name="./answer"
                                          xtype="richtext">
                                     <rtePlugins jcr:primaryType="nt:unstructured">
                                              <format
                                                      jcr:primaryType="nt:unstructured"
                                                      features="*"/>
                                              <image
                                                      jcr:primaryType="nt:unstructured"
                                                      features="*"/>
                                              <links
                                                      jcr:primaryType="nt:unstructured"
                                                      features="*"/>
                                              <misctools
                                                      jcr:primaryType="nt:unstructured"
                                                      features="*"/>
                                              <spellcheck
                                                      jcr:primaryType="nt:unstructured"
                                                      features="*"/>
                                          </rtePlugins>
                                 <listeners
                                         jcr:primaryType="nt:unstructured"
                                         destroy="function() {this.el.dom={};}"/>
                             </answer>
                         </fieldConfig>
                     </multifield> 
                </items>
                <listeners
                            jcr:primaryType="nt:unstructured"
                             added="function() {
                                         window.CQext = {};
                                         window.CQext.faqModule = {};
                                         window.CQext.faqModule.maxId = 0;
                                         window.CQext.faqModule.removedId = {};
                                         window.CQext.faqModule.fillQuestionCategories = function(me) {
                                             var qCategories = window.CQext.faqModule.getParent(me).findBy(function(item) {
                                                 return item.getXType() == 'selection' &amp;&amp; item.getName() == './category';
                                             });
                                             var categories = window.CQext.faqModule.categories;
                                             var options = [];
                                             var values = [];
                                             for (id in categories) {
                                                 var item = {
                                                     'text': categories[id],
                                                     'value': id
                                                 };
                                                 values.push(id);
                                                 options.push(item);
                                             }
                                             for (var i = 0; i &lt; qCategories.length; i++) {
                                                 var item = qCategories[i];
                                                 if ('setOptions' in item) item.setOptions(options);
                                                 if (item.getValue() in window.CQext.faqModule.removedId) item.setValue(-1);
                                             }
                                         };
                                         window.CQext.faqModule.rescanCategories = function(me) {
                                             window.CQext.faqModule.categories = {};
                                             var categoryIds = window.CQext.faqModule.findByName(me, './categoryId');
                                             for (var i = 0; i &lt; categoryIds.length; i++) {
                                                 var idItem = categoryIds[i];
                                                 var nameItem = idItem.previousSibling(); /*todo search by name*/
                                                 var id = idItem.getValue();
                                                 var name = nameItem.getValue();
                                                 window.CQext.faqModule.categories[id] = name;
                                                 id = parseInt(id);
                                                 if (id > window.CQext.faqModule.maxId) window.CQext.faqModule.maxId = id;
                                             }
                                         };
                                         window.CQext.faqModule.getParent = function(me) {
                                             var parent = me.findParentByType('tabpanel');
                                             return parent;
                                         };
                                         window.CQext.faqModule.findByName = function(me, value) {
                                             var parent = window.CQext.faqModule.getParent(me);
                                             if (parent == null) {
                                                 return [];
                                             }
                                             var result = parent.find('name', value);
                                             return result;
                                         };
                                     }"
                            activate="function(me) {
                                          window.CQext.faqModule.rescanCategories(me);
                                          window.CQext.faqModule.fillQuestionCategories(me);
                                          return true;
                                      }"/>
            </questions>
            <categories
                    jcr:primaryType="cq:Widget"
                    title="Categories"
                    xtype="panel">
                <items jcr:primaryType="cq:WidgetCollection">
                    <neutral
                            jcr:primaryType="cq:Widget"
                            fieldLabel="Neutral Message:"
                            name="./neutralMsg"
                            xtype="richtext">
                        <rtePlugins jcr:primaryType="nt:unstructured">
                            <format
                                    jcr:primaryType="nt:unstructured"
                                    features="*"/>
                            <image
                                    jcr:primaryType="nt:unstructured"
                                    features="*"/>
                            <links
                                    jcr:primaryType="nt:unstructured"
                                    features="*"/>
                            <misctools
                                    jcr:primaryType="nt:unstructured"
                                    features="*"/>
                            <spellcheck
                                    jcr:primaryType="nt:unstructured"
                                    features="*"/>
                        </rtePlugins>
                    </neutral>
                    <multifield
                        jcr:primaryType="cq:Widget"
                        customMultiFieldName="./categories"
                        hideLabel="false"
                        fieldLabel="Categories: "
                        name="./categories"
                        xtype="custommultifield">
                        <fieldConfig jcr:primaryType="cq:WidgetCollection">
                            <category
                                    jcr:primaryType="cq:Widget"
                                    fieldLabel="Category Name:"
                                    allowBlank="false"
                                    defaultValue="Category Name"
                                    name="./categoryName"
                                    xtype="textfield" />
                            <categoryId
                                    name="./categoryId" 
                                    jcr:primaryType="cq:Widget"
                                    defaultValue="-1"
                                    xtype="hidden" >
                                <listeners
                                           jcr:primaryType="nt:unstructured"
                                           afterrender = "function(me) {
                                                                var max = 0;
                                                                if (me.getValue() == '') {
                                                                    var parent = me.findParentByType('custommultifield');
                                                                    if (parent == null) {
                                                                      return;
                                                                    }
                                                                    var catIds = parent.find('name', me.getName() );
                                                                    for (var i = 0; i &lt; catIds.length; i++) {
                                                                       var item = catIds[i];
                                                                       var value = parseInt(item.getValue());
                                                                       if (value != null &amp;&amp; value > max) max = value;
                                                                    }
                                                                    me.setValue(++max);
                                                                    delete window.CQext.faqModule.removedId[max];
                                                                }
                                                                return true;
                                                            }"
                                            loadcontent="function(me) {
                                                            window.CQext.faqModule.rescanCategories(me);
                                            }"
                                            removed="function(me, cont) {
                                                        window.CQext.faqModule.removedId[me.getValue()] = true;
                                            }" />
                            </categoryId>
                        </fieldConfig>
                    </multifield>
                </items>
            </categories>
        </items>
    </items>
</jcr:root>
