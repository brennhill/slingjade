<?xml version="1.0" encoding="UTF-8"?>
<jcr:root xmlns:cq="http://www.day.com/jcr/cq/1.0" xmlns:jcr="http://www.jcp.org/jcr/1.0"
          jcr:primaryType="cq:Dialog"
          width="800"
          height="900"
          xtype="dialog">
  <items jcr:primaryType="cq:WidgetCollection">
    <tab
        jcr:primaryType="cq:Widget"
        hideMode="offsets"
        xtype="panel">
      <items jcr:primaryType="cq:WidgetCollection">
          <startDate
                  jcr:primaryType="cq:Widget"
                  name="./startDateCount"
                  hidden="{Boolean}true"
                  xtype="datetime"/>
          <title
                  jcr:primaryType="cq:Widget"
                  fieldLabel="Title"
                  name="./title"
                  allowBlank="{Boolean}false"
                  xtype="textfield"/>
          <quizzes
                  jcr:primaryType="cq:Widget"
                  fieldLabel="Quizzes"
                  hideLabel="false"
                  name="./quizzes"
                  xtype="multifield">
              <fieldConfig
                      jcr:primaryType="cq:Widget"
                      xtype="fixedmultifieldpanel">
                  <items jcr:primaryType="cq:WidgetCollection">
                      <question
                              jcr:primaryType="cq:Widget"
                              fieldLabel="Question"
                              width="300"
                              key="question"
                              allowBlank="{Boolean}false"
                              xtype="textfield"/>
                      <answer_1
                              jcr:primaryType="cq:Widget"
                              fieldLabel="Answer #1"
                              width="300"
                              key="answer_1"
                              allowBlank="{Boolean}false"
                              xtype="textfield"/>
                      <answer_2
                              jcr:primaryType="cq:Widget"
                              fieldLabel="Answer #2"
                              width="300"
                              key="answer_2"
                              allowBlank="{Boolean}false"
                              xtype="textfield"/>
                      <answer_3
                              jcr:primaryType="cq:Widget"
                              fieldLabel="Answer #3"
                              width="300"
                              key="answer_3"
                              xtype="textfield"/>
                      <answer_4
                              jcr:primaryType="cq:Widget"
                              fieldLabel="Answer #4"
                              width="300"
                              key="answer_4"
                              xtype="textfield"/>
                      <correctAnswer
                              jcr:primaryType="cq:Widget"
                              allowBlank="{Boolean}false"
                              fieldLabel="Correct answer #"
                              width="100"
                              key="correctAnswer"
                              type="select"
                              xtype="selection">
                          <options jcr:primaryType="cq:WidgetCollection">
                              <first
                                      text="#1"
                                      jcr:primaryType="nt:unstructured"
                                      value="1"/>
                              <second
                                      text="#2"
                                      jcr:primaryType="nt:unstructured"
                                      value="2"/>
                              <third
                                      text="#3"
                                      jcr:primaryType="nt:unstructured"
                                      value="3"/>
                              <fouth
                                      text="#4"
                                      jcr:primaryType="nt:unstructured"
                                      value="4"/>
                          </options>
                      </correctAnswer>
                      <answerSummary
                              jcr:primaryType="cq:Widget"
                              alowBlank="{Boolean}false"
                              fieldLabel="Answer Summary: "
                              key="answerSummary"
                              xtype="richtext">
                          <rtePlugins jcr:primaryType="nt:unstructured">
                              <edit
                                      jcr:primaryType="nt:unstructured"
                                      defaultPasteMode="plaintext"
                                      features="*">
                                  <htmlPasteRules
                                          jcr:primaryType="nt:unstructured"
                                          fallbackBlockTag="span"/>
                              </edit>
                              <format
                                      jcr:primaryType="nt:unstructured"
                                      features="*"/>
                              <customlinks
                                      jcr:primaryType="nt:unstructured"
                                      features="*"/>
                              <misctools
                                      jcr:primaryType="nt:unstructured"
                                      features="*"/>
                              <paraformat
                                      jcr:primaryType="nt:unstructured"
                                      features="*">
                                  <formats jcr:primaryType="cq:WidgetCollection">
                                      <span
                                              jcr:primaryType="nt:unstructured"
                                              description="Span"
                                              tag="span"/>
                                  </formats>
                              </paraformat>
                              <spellcheck
                                      jcr:primaryType="nt:unstructured"
                                      features="*"/>
                              <subsuperscript
                                      jcr:primaryType="nt:unstructured"
                                      features="*"/>
                          </rtePlugins>
                          <htmlRules jcr:primaryType="nt:unstructured">
                              <blockHandling
                                      jcr:primaryType="nt:unstructured"
                                      removeSingleParagraphContainer="{Boolean}true"/>
                          </htmlRules>
                          <listeners
                                  jcr:primaryType="nt:unstructured"
                                  destroy="function() {this.el.dom={};}"/>
                      </answerSummary>
                      <active
                          jcr:primaryType="cq:Widget"
                          defaultValue="false"
                          fieldLabel="Active"
                          key="active"
                          checkboxBoolTypeHint="{Boolean}true"
                          xtype="checkbox">
                          <listeners
                                  jcr:primaryType="nt:unstructured"
                                  check="
                                    function(component,checked){
                                        var panel = component.ownerCt.ownerCt.ownerCt.ownerCt.ownerCt;

                                        var dialogIsActive = false;

                                        panel.findByType('hidden').forEach(function(entry, index){
                                            if(entry.name=='./dialogIsActive') {
                                                dialogIsActive = entry.getValue();
                                                console.log('dialogIsActive', dialogIsActive);
                                            }
                                        });

                                        if(dialogIsActive &amp;&amp; checked) {
                                            var panel = component.ownerCt.ownerCt.ownerCt.ownerCt.ownerCt;

                                            var startDateCount;

                                            panel.findByType('datetime').forEach(function(entry, index){
                                                if(entry.name == './startDateCount') {
                                                    startDateCount = entry;
                                                }
                                            });

                                            panel.findByType('checkbox').forEach(function(entry, index){
                                                if(entry == component) {
                                                    var startDate = new Date(new Date().setDate(new Date().getDate() - new Date().getDay() - (7*index)));
                                                    if(startDateCount)
                                                        startDateCount.setValue(startDate.toISOString());
                                                }
                                                if(entry.key == 'active' &amp;&amp; entry != component) {
                                                    entry.reset();
                                                }
                                            });
                                        }
                                    }"
                                  />
                      </active>

                      <nodeNameHint
                              jcr:primaryType="cq:Widget"
                              ignoreData="{Boolean}true"
                              key="active@TypeHint"
                              value="Boolean"
                              xtype="hidden"/>
                  </items>
              </fieldConfig>
          </quizzes>
          <dialogIsActive
                  jcr:primaryType="cq:Widget"
                  name="./dialogIsActive"
                  hidden="{Boolean}true"
                  ignoreData="{Boolean}true"
                  xtype="hidden"/>
      </items>
    </tab>
  </items>
    <listeners
        jcr:primaryType="nt:unstructured"
        loadcontent="
            function(dialog){
                       console.log('dialog');

                dialog.findByType('hidden').forEach(function(entry, index){
                    if(entry.name == './dialogIsActive') {
                        entry.setValue(true);
                    }
                });

                var dayMultiplicator = 1000*60*60*24;

                var checkboxes = dialog.findByType('checkbox');

                var checkboxesAmount  = checkboxes.length;

                var actualIndex = 0;
                var startDateCount;

                dialog.findByType('datetime').forEach(function(entry, index){
                    if(entry.name == './startDateCount') {
                        startDateCount = entry.getValue();
                    }
                });

                if(startDateCount) {
                    var weeksDiff = parseInt((new Date().getTime() - startDateCount.getTime())/dayMultiplicator/7);

                    actualIndex = checkboxesAmount-(checkboxesAmount-(weeksDiff%checkboxesAmount));
                }

                checkboxes.forEach(function(entry, index){
                    if(entry.key == 'active') {
                        if(index == actualIndex) {
                            console.log('index == actualIndex');
                            entry.setValue(true);
                        } else {
                            console.log('index != actualIndex');
                            entry.reset();
                        }
                    }
                });
            }"
            beforesubmit="function(dialog){
                dialog.findByType('hidden').forEach(function(entry, index){
                    console.log('beforesubmit');
                    if(entry.name == './dialogIsActive') {
                        entry.setValue('');
                    }
                });
            }"

        />
</jcr:root>
