/* Build #1714 */ 
(function(undefined) {
    var __m4 = function() {
        var can = window.can || {};
        if (typeof GLOBALCAN === "undefined" || GLOBALCAN !== false) {
            window.can = can;
        }
        can.k = function() {};
        can.isDeferred = function(obj) {
            return obj && typeof obj.then === "function" && typeof obj.pipe === "function";
        };
        var cid = 0;
        can.cid = function(object, name) {
            if (!object._cid) {
                cid++;
                object._cid = (name || "") + cid;
            }
            return object._cid;
        };
        can.VERSION = "@EDGE";
        can.simpleExtend = function(d, s) {
            for (var prop in s) {
                d[prop] = s[prop];
            }
            return d;
        };
        can.frag = function(item) {
            var frag;
            if (!item || typeof item === "string") {
                frag = can.buildFragment(item == null ? "" : "" + item, document.body);
                if (!frag.childNodes.length) {
                    frag.appendChild(document.createTextNode(""));
                }
                return frag;
            } else if (item.nodeType === 11) {
                return item;
            } else if (typeof item.nodeType === "number") {
                frag = document.createDocumentFragment();
                frag.appendChild(item);
                return frag;
            } else if (typeof item.length === "number") {
                frag = document.createDocumentFragment();
                can.each(item, function(item) {
                    frag.appendChild(can.frag(item));
                });
                return frag;
            } else {
                frag = can.buildFragment("" + item, document.body);
                if (!frag.childNodes.length) {
                    frag.appendChild(document.createTextNode(""));
                }
                return frag;
            }
        };
        can.__reading = function() {};
        return can;
    }();
    var __m5 = function(can) {
        var setImmediate = window.setImmediate || function(cb) {
            return setTimeout(cb, 0);
        }, attr = {
            MutationObserver: window.MutationObserver || window.WebKitMutationObserver || window.MozMutationObserver,
            map: {
                "class": "className",
                value: "value",
                innerText: "innerText",
                textContent: "textContent",
                checked: true,
                disabled: true,
                readonly: true,
                required: true,
                src: function(el, val) {
                    if (val == null || val === "") {
                        el.removeAttribute("src");
                        return null;
                    } else {
                        el.setAttribute("src", val);
                        return val;
                    }
                },
                style: function(el, val) {
                    return el.style.cssText = val || "";
                }
            },
            defaultValue: [ "input", "textarea" ],
            set: function(el, attrName, val) {
                var oldValue;
                if (!attr.MutationObserver) {
                    oldValue = attr.get(el, attrName);
                }
                var tagName = el.nodeName.toString().toLowerCase(), prop = attr.map[attrName], newValue;
                if (typeof prop === "function") {
                    newValue = prop(el, val);
                } else if (prop === true) {
                    newValue = el[attrName] = true;
                    if (attrName === "checked" && el.type === "radio") {
                        if (can.inArray(tagName, attr.defaultValue) >= 0) {
                            el.defaultChecked = true;
                        }
                    }
                } else if (prop) {
                    newValue = el[prop] = val;
                    if (prop === "value" && can.inArray(tagName, attr.defaultValue) >= 0) {
                        el.defaultValue = val;
                    }
                } else {
                    el.setAttribute(attrName, val);
                    newValue = val;
                }
                if (!attr.MutationObserver && newValue !== oldValue) {
                    attr.trigger(el, attrName, oldValue);
                }
            },
            trigger: function(el, attrName, oldValue) {
                if (can.data(can.$(el), "canHasAttributesBindings")) {
                    return setImmediate(function() {
                        can.trigger(el, {
                            type: "attributes",
                            attributeName: attrName,
                            target: el,
                            oldValue: oldValue,
                            bubbles: false
                        }, []);
                    });
                }
            },
            get: function(el, attrName) {
                var prop = attr.map[attrName];
                if (typeof prop === "string" && el[prop]) {
                    return el[prop];
                }
                return el.getAttribute(attrName);
            },
            remove: function(el, attrName) {
                var oldValue;
                if (!attr.MutationObserver) {
                    oldValue = attr.get(el, attrName);
                }
                var setter = attr.map[attrName];
                if (typeof setter === "function") {
                    setter(el, undefined);
                }
                if (setter === true) {
                    el[attrName] = false;
                } else if (typeof setter === "string") {
                    el[setter] = "";
                } else {
                    el.removeAttribute(attrName);
                }
                if (!attr.MutationObserver && oldValue != null) {
                    attr.trigger(el, attrName, oldValue);
                }
            },
            has: function() {
                var el = document.createElement("div");
                if (el.hasAttribute) {
                    return function(el, name) {
                        return el.hasAttribute(name);
                    };
                } else {
                    return function(el, name) {
                        return el.getAttribute(name) !== null;
                    };
                }
            }()
        };
        return attr;
    }(__m4);
    var __m6 = function(can) {
        can.addEvent = function(event, handler) {
            var allEvents = this.__bindEvents || (this.__bindEvents = {}), eventList = allEvents[event] || (allEvents[event] = []);
            eventList.push({
                handler: handler,
                name: event
            });
            return this;
        };
        can.listenTo = function(other, event, handler) {
            var idedEvents = this.__listenToEvents;
            if (!idedEvents) {
                idedEvents = this.__listenToEvents = {};
            }
            var otherId = can.cid(other);
            var othersEvents = idedEvents[otherId];
            if (!othersEvents) {
                othersEvents = idedEvents[otherId] = {
                    obj: other,
                    events: {}
                };
            }
            var eventsEvents = othersEvents.events[event];
            if (!eventsEvents) {
                eventsEvents = othersEvents.events[event] = [];
            }
            eventsEvents.push(handler);
            can.bind.call(other, event, handler);
        };
        can.stopListening = function(other, event, handler) {
            var idedEvents = this.__listenToEvents, iterIdedEvents = idedEvents, i = 0;
            if (!idedEvents) {
                return this;
            }
            if (other) {
                var othercid = can.cid(other);
                (iterIdedEvents = {})[othercid] = idedEvents[othercid];
                if (!idedEvents[othercid]) {
                    return this;
                }
            }
            for (var cid in iterIdedEvents) {
                var othersEvents = iterIdedEvents[cid], eventsEvents;
                other = idedEvents[cid].obj;
                if (!event) {
                    eventsEvents = othersEvents.events;
                } else {
                    (eventsEvents = {})[event] = othersEvents.events[event];
                }
                for (var eventName in eventsEvents) {
                    var handlers = eventsEvents[eventName] || [];
                    i = 0;
                    while (i < handlers.length) {
                        if (handler && handler === handlers[i] || !handler) {
                            can.unbind.call(other, eventName, handlers[i]);
                            handlers.splice(i, 1);
                        } else {
                            i++;
                        }
                    }
                    if (!handlers.length) {
                        delete othersEvents.events[eventName];
                    }
                }
                if (can.isEmptyObject(othersEvents.events)) {
                    delete idedEvents[cid];
                }
            }
            return this;
        };
        can.removeEvent = function(event, fn, __validate) {
            if (!this.__bindEvents) {
                return this;
            }
            var events = this.__bindEvents[event] || [], i = 0, ev, isFunction = typeof fn === "function";
            while (i < events.length) {
                ev = events[i];
                if (__validate ? __validate(ev, event, fn) : isFunction && ev.handler === fn || !isFunction && (ev.cid === fn || !fn)) {
                    events.splice(i, 1);
                } else {
                    i++;
                }
            }
            return this;
        };
        can.dispatch = function(event, args) {
            var events = this.__bindEvents;
            if (!events) {
                return;
            }
            if (typeof event === "string") {
                event = {
                    type: event
                };
            }
            var eventName = event.type, handlers = (events[eventName] || []).slice(0), passed = [ event ];
            if (args) {
                passed.push.apply(passed, args);
            }
            for (var i = 0, len = handlers.length; i < len; i++) {
                handlers[i].handler.apply(this, passed);
            }
            return event;
        };
        can.one = function(event, handler) {
            var one = function() {
                can.unbind.call(this, event, one);
                return handler.apply(this, arguments);
            };
            can.bind.call(this, event, one);
            return this;
        };
        can.event = {
            on: function() {
                if (arguments.length === 0 && can.Control && this instanceof can.Control) {
                    return can.Control.prototype.on.call(this);
                } else {
                    return can.addEvent.apply(this, arguments);
                }
            },
            off: function() {
                if (arguments.length === 0 && can.Control && this instanceof can.Control) {
                    return can.Control.prototype.off.call(this);
                } else {
                    return can.removeEvent.apply(this, arguments);
                }
            },
            bind: can.addEvent,
            unbind: can.removeEvent,
            delegate: function(selector, event, handler) {
                return can.addEvent.call(this, event, handler);
            },
            undelegate: function(selector, event, handler) {
                return can.removeEvent.call(this, event, handler);
            },
            trigger: can.dispatch,
            one: can.one,
            addEvent: can.addEvent,
            removeEvent: can.removeEvent,
            listenTo: can.listenTo,
            stopListening: can.stopListening,
            dispatch: can.dispatch
        };
        return can.event;
    }(__m4);
    var __m7 = function(can) {
        var isArrayLike = function(obj) {
            var length = obj.length;
            return typeof arr !== "function" && (length === 0 || typeof length === "number" && length > 0 && length - 1 in obj);
        };
        can.each = function(elements, callback, context) {
            var i = 0, key, len, item;
            if (elements) {
                if (isArrayLike(elements)) {
                    if (can.List && elements instanceof can.List) {
                        for (len = elements.attr("length"); i < len; i++) {
                            item = elements.attr(i);
                            if (callback.call(context || item, item, i, elements) === false) {
                                break;
                            }
                        }
                    } else {
                        for (len = elements.length; i < len; i++) {
                            item = elements[i];
                            if (callback.call(context || item, item, i, elements) === false) {
                                break;
                            }
                        }
                    }
                } else if (typeof elements === "object") {
                    if (can.Map && elements instanceof can.Map || elements === can.route) {
                        var keys = can.Map.keys(elements);
                        for (i = 0, len = keys.length; i < len; i++) {
                            key = keys[i];
                            item = elements.attr(key);
                            if (callback.call(context || item, item, key, elements) === false) {
                                break;
                            }
                        }
                    } else {
                        for (key in elements) {
                            if (elements.hasOwnProperty(key) && callback.call(context || elements[key], elements[key], key, elements) === false) {
                                break;
                            }
                        }
                    }
                }
            }
            return elements;
        };
        return can;
    }(__m4);
    var __m8 = function(can) {
        can.inserted = function(elems) {
            elems = can.makeArray(elems);
            var inDocument = false, doc = can.$(document.contains ? document : document.body), children;
            for (var i = 0, elem; (elem = elems[i]) !== undefined; i++) {
                if (!inDocument) {
                    if (elem.getElementsByTagName) {
                        if (can.has(doc, elem).length) {
                            inDocument = true;
                        } else {
                            return;
                        }
                    } else {
                        continue;
                    }
                }
                if (inDocument && elem.getElementsByTagName) {
                    children = can.makeArray(elem.getElementsByTagName("*"));
                    can.trigger(elem, "inserted", [], false);
                    for (var j = 0, child; (child = children[j]) !== undefined; j++) {
                        can.trigger(child, "inserted", [], false);
                    }
                }
            }
        };
        can.appendChild = function(el, child) {
            var children;
            if (child.nodeType === 11) {
                children = can.makeArray(child.childNodes);
            } else {
                children = [ child ];
            }
            el.appendChild(child);
            can.inserted(children);
        };
        can.insertBefore = function(el, child, ref) {
            var children;
            if (child.nodeType === 11) {
                children = can.makeArray(child.childNodes);
            } else {
                children = [ child ];
            }
            el.insertBefore(child, ref);
            can.inserted(children);
        };
    }(__m4);
    var __m2 = function($, can, attr, event) {
        var isBindableElement = function(node) {
            return node.nodeName && (node.nodeType === 1 || node.nodeType === 9) || node == window;
        };
        $.extend(can, $, {
            trigger: function(obj, event, args, bubbles) {
                if (isBindableElement(obj)) {
                    $.event.trigger(event, args, obj, !bubbles);
                } else if (obj.trigger) {
                    obj.trigger(event, args);
                } else {
                    if (typeof event === "string") {
                        event = {
                            type: event
                        };
                    }
                    event.target = event.target || obj;
                    if (args) {
                        if (args.length && typeof args === "string") {
                            args = [ args ];
                        } else if (!args.length) {
                            args = [ args ];
                        }
                    }
                    if (!args) {
                        args = [];
                    }
                    can.dispatch.call(obj, event, args);
                }
            },
            event: can.event,
            addEvent: can.addEvent,
            removeEvent: can.removeEvent,
            buildFragment: function(elems, context) {
                var ret;
                elems = [ elems ];
                context = context || document;
                context = !context.nodeType && context[0] || context;
                context = context.ownerDocument || context;
                ret = $.buildFragment(elems, context);
                return ret.cacheable ? $.clone(ret.fragment) : ret.fragment || ret;
            },
            $: $,
            each: can.each,
            bind: function(ev, cb) {
                if (this.bind && this.bind !== can.bind) {
                    this.bind(ev, cb);
                } else if (isBindableElement(this)) {
                    $.event.add(this, ev, cb);
                } else {
                    can.addEvent.call(this, ev, cb);
                }
                return this;
            },
            unbind: function(ev, cb) {
                if (this.unbind && this.unbind !== can.unbind) {
                    this.unbind(ev, cb);
                } else if (isBindableElement(this)) {
                    $.event.remove(this, ev, cb);
                } else {
                    can.removeEvent.call(this, ev, cb);
                }
                return this;
            },
            delegate: function(selector, ev, cb) {
                if (this.delegate) {
                    this.delegate(selector, ev, cb);
                } else if (isBindableElement(this)) {
                    $(this).delegate(selector, ev, cb);
                } else {
                    can.bind.call(this, ev, cb);
                }
                return this;
            },
            undelegate: function(selector, ev, cb) {
                if (this.undelegate) {
                    this.undelegate(selector, ev, cb);
                } else if (isBindableElement(this)) {
                    $(this).undelegate(selector, ev, cb);
                } else {
                    can.unbind.call(this, ev, cb);
                }
                return this;
            },
            proxy: function(fn, context) {
                return function() {
                    return fn.apply(context, arguments);
                };
            },
            attr: attr
        });
        can.on = can.bind;
        can.off = can.unbind;
        $.each([ "append", "filter", "addClass", "remove", "data", "get", "has" ], function(i, name) {
            can[name] = function(wrapped) {
                return wrapped[name].apply(wrapped, can.makeArray(arguments).slice(1));
            };
        });
        var oldClean = $.cleanData;
        $.cleanData = function(elems) {
            $.each(elems, function(i, elem) {
                if (elem) {
                    can.trigger(elem, "removed", [], false);
                }
            });
            oldClean(elems);
        };
        var oldDomManip = $.fn.domManip, cbIndex;
        $.fn.domManip = function(args, cb1, cb2) {
            for (var i = 1; i < arguments.length; i++) {
                if (typeof arguments[i] === "function") {
                    cbIndex = i;
                    break;
                }
            }
            return oldDomManip.apply(this, arguments);
        };
        $(document.createElement("div")).append(document.createElement("div"));
        $.fn.domManip = cbIndex === 2 ? function(args, table, callback) {
            return oldDomManip.call(this, args, table, function(elem) {
                var elems;
                if (elem.nodeType === 11) {
                    elems = can.makeArray(elem.childNodes);
                }
                var ret = callback.apply(this, arguments);
                can.inserted(elems ? elems : [ elem ]);
                return ret;
            });
        } : function(args, callback) {
            return oldDomManip.call(this, args, function(elem) {
                var elems;
                if (elem.nodeType === 11) {
                    elems = can.makeArray(elem.childNodes);
                }
                var ret = callback.apply(this, arguments);
                can.inserted(elems ? elems : [ elem ]);
                return ret;
            });
        };
        if (!can.attr.MutationObserver) {
            var oldAttr = $.attr;
            $.attr = function(el, attrName) {
                var oldValue, newValue;
                if (arguments.length >= 3) {
                    oldValue = oldAttr.call(this, el, attrName);
                }
                var res = oldAttr.apply(this, arguments);
                if (arguments.length >= 3) {
                    newValue = oldAttr.call(this, el, attrName);
                }
                if (newValue !== oldValue) {
                    can.attr.trigger(el, attrName, oldValue);
                }
                return res;
            };
            var oldRemove = $.removeAttr;
            $.removeAttr = function(el, attrName) {
                var oldValue = oldAttr.call(this, el, attrName), res = oldRemove.apply(this, arguments);
                if (oldValue != null) {
                    can.attr.trigger(el, attrName, oldValue);
                }
                return res;
            };
            $.event.special.attributes = {
                setup: function() {
                    can.data(can.$(this), "canHasAttributesBindings", true);
                },
                teardown: function() {
                    $.removeData(this, "canHasAttributesBindings");
                }
            };
        } else {
            $.event.special.attributes = {
                setup: function() {
                    var self = this;
                    var observer = new can.attr.MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                            var copy = can.simpleExtend({}, mutation);
                            can.trigger(self, copy, []);
                        });
                    });
                    observer.observe(this, {
                        attributes: true,
                        attributeOldValue: true
                    });
                    can.data(can.$(this), "canAttributesObserver", observer);
                },
                teardown: function() {
                    can.data(can.$(this), "canAttributesObserver").disconnect();
                    $.removeData(this, "canAttributesObserver");
                }
            };
        }
        (function() {
            var text = "<-\n>", frag = can.buildFragment(text, document);
            if (text !== frag.childNodes[0].nodeValue) {
                var oldBuildFragment = can.buildFragment;
                can.buildFragment = function(content, context) {
                    var res = oldBuildFragment(content, context);
                    if (res.childNodes.length === 1 && res.childNodes[0].nodeType === 3) {
                        res.childNodes[0].nodeValue = content;
                    }
                    return res;
                };
            }
        })();
        $.event.special.inserted = {};
        $.event.special.removed = {};
        return can;
    }(jQuery, __m4, __m5, __m6, __m7, __m8);
    var __m10 = function(can) {
        var isFunction = can.isFunction, makeArray = can.makeArray, hookupId = 1;
        var makeRenderer = function(textRenderer) {
            var renderer = function() {
                return $view.frag(textRenderer.apply(this, arguments));
            };
            renderer.render = function() {
                return textRenderer.apply(textRenderer, arguments);
            };
            return renderer;
        };
        var checkText = function(text, url) {
            if (!text.length) {
                throw "can.view: No template or empty template:" + url;
            }
        };
        var getRenderer = function(obj, async) {
            if (isFunction(obj)) {
                var def = can.Deferred();
                return def.resolve(obj);
            }
            var url = typeof obj === "string" ? obj : obj.url, suffix = obj.engine && "." + obj.engine || url.match(/\.[\w\d]+$/), type, el, id;
            if (url.match(/^#/)) {
                url = url.substr(1);
            }
            if (el = document.getElementById(url)) {
                suffix = "." + el.type.match(/\/(x\-)?(.+)/)[2];
            }
            if (!suffix && !$view.cached[url]) {
                url += suffix = $view.ext;
            }
            if (can.isArray(suffix)) {
                suffix = suffix[0];
            }
            id = $view.toId(url);
            if (url.match(/^\/\//)) {
                url = url.substr(2);
                url = !window.steal ? url : steal.config().root.mapJoin("" + steal.id(url));
            }
            if (window.require) {
                if (require.toUrl) {
                    url = require.toUrl(url);
                }
            }
            type = $view.types[suffix];
            if ($view.cached[id]) {
                return $view.cached[id];
            } else if (el) {
                return $view.registerView(id, el.innerHTML, type);
            } else {
                var d = new can.Deferred();
                can.ajax({
                    async: async,
                    url: url,
                    dataType: "text",
                    error: function(jqXHR) {
                        checkText("", url);
                        d.reject(jqXHR);
                    },
                    success: function(text) {
                        checkText(text, url);
                        $view.registerView(id, text, type, d);
                    }
                });
                return d;
            }
        };
        var getDeferreds = function(data) {
            var deferreds = [];
            if (can.isDeferred(data)) {
                return [ data ];
            } else {
                for (var prop in data) {
                    if (can.isDeferred(data[prop])) {
                        deferreds.push(data[prop]);
                    }
                }
            }
            return deferreds;
        };
        var usefulPart = function(resolved) {
            return can.isArray(resolved) && resolved[1] === "success" ? resolved[0] : resolved;
        };
        var $view = can.view = can.template = function(view, data, helpers, callback) {
            if (isFunction(helpers)) {
                callback = helpers;
                helpers = undefined;
            }
            return $view.renderAs("fragment", view, data, helpers, callback);
        };
        can.extend($view, {
            frag: function(result, parentNode) {
                return $view.hookup($view.fragment(result), parentNode);
            },
            fragment: function(result) {
                if (typeof result !== "string" && result.nodeType === 11) {
                    return result;
                }
                var frag = can.buildFragment(result, document.body);
                if (!frag.childNodes.length) {
                    frag.appendChild(document.createTextNode(""));
                }
                return frag;
            },
            toId: function(src) {
                return can.map(src.toString().split(/\/|\./g), function(part) {
                    if (part) {
                        return part;
                    }
                }).join("_");
            },
            toStr: function(txt) {
                return txt == null ? "" : "" + txt;
            },
            hookup: function(fragment, parentNode) {
                var hookupEls = [], id, func;
                can.each(fragment.childNodes ? can.makeArray(fragment.childNodes) : fragment, function(node) {
                    if (node.nodeType === 1) {
                        hookupEls.push(node);
                        hookupEls.push.apply(hookupEls, can.makeArray(node.getElementsByTagName("*")));
                    }
                });
                can.each(hookupEls, function(el) {
                    if (el.getAttribute && (id = el.getAttribute("data-view-id")) && (func = $view.hookups[id])) {
                        func(el, parentNode, id);
                        delete $view.hookups[id];
                        el.removeAttribute("data-view-id");
                    }
                });
                return fragment;
            },
            hookups: {},
            hook: function(cb) {
                $view.hookups[++hookupId] = cb;
                return " data-view-id='" + hookupId + "'";
            },
            cached: {},
            cachedRenderers: {},
            cache: true,
            register: function(info) {
                this.types["." + info.suffix] = info;
                can[info.suffix] = $view[info.suffix] = function(id, text) {
                    var renderer, renderFunc;
                    if (!text) {
                        renderFunc = function() {
                            if (!renderer) {
                                if (info.fragRenderer) {
                                    renderer = info.fragRenderer(null, id);
                                } else {
                                    renderer = makeRenderer(info.renderer(null, id));
                                }
                            }
                            return renderer.apply(this, arguments);
                        };
                        renderFunc.render = function() {
                            var textRenderer = info.renderer(null, id);
                            return textRenderer.apply(textRenderer, arguments);
                        };
                        return renderFunc;
                    }
                    var registeredRenderer = function() {
                        if (!renderer) {
                            if (info.fragRenderer) {
                                renderer = info.fragRenderer(id, text);
                            } else {
                                renderer = info.renderer(id, text);
                            }
                        }
                        return renderer.apply(this, arguments);
                    };
                    if (info.fragRenderer) {
                        return $view.preload(id, registeredRenderer);
                    } else {
                        return $view.preloadStringRenderer(id, registeredRenderer);
                    }
                };
            },
            types: {},
            ext: ".ejs",
            registerScript: function(type, id, src) {
                return "can.view.preloadStringRenderer('" + id + "'," + $view.types["." + type].script(id, src) + ");";
            },
            preload: function(id, renderer) {
                var def = $view.cached[id] = new can.Deferred().resolve(function(data, helpers) {
                    return renderer.call(data, data, helpers);
                });
                def.__view_id = id;
                $view.cachedRenderers[id] = renderer;
                return renderer;
            },
            preloadStringRenderer: function(id, stringRenderer) {
                return this.preload(id, makeRenderer(stringRenderer));
            },
            render: function(view, data, helpers, callback) {
                return can.view.renderAs("string", view, data, helpers, callback);
            },
            renderTo: function(format, renderer, data, helpers) {
                return (format === "string" && renderer.render ? renderer.render : renderer)(data, helpers);
            },
            renderAs: function(format, view, data, helpers, callback) {
                if (isFunction(helpers)) {
                    callback = helpers;
                    helpers = undefined;
                }
                var deferreds = getDeferreds(data);
                var reading, deferred, dataCopy, async, response;
                if (deferreds.length) {
                    deferred = new can.Deferred();
                    dataCopy = can.extend({}, data);
                    deferreds.push(getRenderer(view, true));
                    can.when.apply(can, deferreds).then(function(resolved) {
                        var objs = makeArray(arguments), renderer = objs.pop(), result;
                        if (can.isDeferred(data)) {
                            dataCopy = usefulPart(resolved);
                        } else {
                            for (var prop in data) {
                                if (can.isDeferred(data[prop])) {
                                    dataCopy[prop] = usefulPart(objs.shift());
                                }
                            }
                        }
                        result = can.view.renderTo(format, renderer, dataCopy, helpers);
                        deferred.resolve(result, dataCopy);
                        if (callback) {
                            callback(result, dataCopy);
                        }
                    }, function() {
                        deferred.reject.apply(deferred, arguments);
                    });
                    return deferred;
                } else {
                    reading = can.__clearReading();
                    async = isFunction(callback);
                    deferred = getRenderer(view, async);
                    if (reading) {
                        can.__setReading(reading);
                    }
                    if (async) {
                        response = deferred;
                        deferred.then(function(renderer) {
                            callback(data ? can.view.renderTo(format, renderer, data, helpers) : renderer);
                        });
                    } else {
                        if (deferred.state() === "resolved" && deferred.__view_id) {
                            var currentRenderer = $view.cachedRenderers[deferred.__view_id];
                            return data ? can.view.renderTo(format, currentRenderer, data, helpers) : currentRenderer;
                        } else {
                            deferred.then(function(renderer) {
                                response = data ? can.view.renderTo(format, renderer, data, helpers) : renderer;
                            });
                        }
                    }
                    return response;
                }
            },
            registerView: function(id, text, type, def) {
                var info = typeof type === "object" ? type : $view.types[type || $view.ext], renderer;
                if (info.fragRenderer) {
                    renderer = info.fragRenderer(id, text);
                } else {
                    renderer = makeRenderer(info.renderer(id, text));
                }
                def = def || new can.Deferred();
                if ($view.cache) {
                    $view.cached[id] = def;
                    def.__view_id = id;
                    $view.cachedRenderers[id] = renderer;
                }
                return def.resolve(renderer);
            }
        });
        return can;
    }(__m2);
    var __m9 = function(can) {
        var attr = can.view.attr = function(attributeName, attrHandler) {
            if (attrHandler) {
                if (typeof attributeName === "string") {
                    attributes[attributeName] = attrHandler;
                } else {
                    regExpAttributes.push({
                        match: attributeName,
                        handler: attrHandler
                    });
                }
            } else {
                var cb = attributes[attributeName];
                if (!cb) {
                    for (var i = 0, len = regExpAttributes.length; i < len; i++) {
                        var attrMatcher = regExpAttributes[i];
                        if (attrMatcher.match.test(attributeName)) {
                            cb = attrMatcher.handler;
                            break;
                        }
                    }
                }
                return cb;
            }
        };
        var attributes = {}, regExpAttributes = [], automaticCustomElementCharacters = /[-\:]/;
        var tag = can.view.tag = function(tagName, tagHandler) {
            if (tagHandler) {
                if (window.html5) {
                    window.html5.elements += " " + tagName;
                    window.html5.shivDocument();
                }
                tags[tagName.toLowerCase()] = tagHandler;
            } else {
                var cb = tags[tagName.toLowerCase()];
                if (!cb && automaticCustomElementCharacters.test(tagName)) {
                    cb = function() {};
                }
                return cb;
            }
        };
        var tags = {};
        can.view.callbacks = {
            _tags: tags,
            _attributes: attributes,
            _regExpAttributes: regExpAttributes,
            tag: tag,
            attr: attr,
            tagHandler: function(el, tagName, tagData) {
                var helperTagCallback = tagData.options.attr("tags." + tagName), tagCallback = helperTagCallback || tags[tagName];
                var scope = tagData.scope, res;
                if (tagCallback) {
                    var reads = can.__clearReading();
                    res = tagCallback(el, tagData);
                    can.__setReading(reads);
                } else {
                    res = scope;
                }
                if (res && tagData.subtemplate) {
                    if (scope !== res) {
                        scope = scope.add(res);
                    }
                    var result = tagData.subtemplate(scope, tagData.options);
                    var frag = typeof result === "string" ? can.view.frag(result) : result;
                    can.appendChild(el, frag);
                }
            }
        };
        return can.view.callbacks;
    }(__m2, __m10);
    var __m13 = function(can) {
        var strUndHash = /_|-/, strColons = /\=\=/, strWords = /([A-Z]+)([A-Z][a-z])/g, strLowUp = /([a-z\d])([A-Z])/g, strDash = /([a-z\d])([A-Z])/g, strReplacer = /\{([^\}]+)\}/g, strQuote = /"/g, strSingleQuote = /'/g, strHyphenMatch = /-+(.)?/g, strCamelMatch = /[a-z][A-Z]/g, getNext = function(obj, prop, add) {
            var result = obj[prop];
            if (result === undefined && add === true) {
                result = obj[prop] = {};
            }
            return result;
        }, isContainer = function(current) {
            return /^f|^o/.test(typeof current);
        }, convertBadValues = function(content) {
            var isInvalid = content === null || content === undefined || isNaN(content) && "" + content === "NaN";
            return "" + (isInvalid ? "" : content);
        };
        can.extend(can, {
            esc: function(content) {
                return convertBadValues(content).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(strQuote, "&#34;").replace(strSingleQuote, "&#39;");
            },
            getObject: function(name, roots, add) {
                var parts = name ? name.split(".") : [], length = parts.length, current, r = 0, i, container, rootsLength;
                roots = can.isArray(roots) ? roots : [ roots || window ];
                rootsLength = roots.length;
                if (!length) {
                    return roots[0];
                }
                for (r; r < rootsLength; r++) {
                    current = roots[r];
                    container = undefined;
                    for (i = 0; i < length && isContainer(current); i++) {
                        container = current;
                        current = getNext(container, parts[i]);
                    }
                    if (container !== undefined && current !== undefined) {
                        break;
                    }
                }
                if (add === false && current !== undefined) {
                    delete container[parts[i - 1]];
                }
                if (add === true && current === undefined) {
                    current = roots[0];
                    for (i = 0; i < length && isContainer(current); i++) {
                        current = getNext(current, parts[i], true);
                    }
                }
                return current;
            },
            capitalize: function(s, cache) {
                return s.charAt(0).toUpperCase() + s.slice(1);
            },
            camelize: function(str) {
                return convertBadValues(str).replace(strHyphenMatch, function(match, chr) {
                    return chr ? chr.toUpperCase() : "";
                });
            },
            hyphenate: function(str) {
                return convertBadValues(str).replace(strCamelMatch, function(str, offset) {
                    return str.charAt(0) + "-" + str.charAt(1).toLowerCase();
                });
            },
            underscore: function(s) {
                return s.replace(strColons, "/").replace(strWords, "$1_$2").replace(strLowUp, "$1_$2").replace(strDash, "_").toLowerCase();
            },
            sub: function(str, data, remove) {
                var obs = [];
                str = str || "";
                obs.push(str.replace(strReplacer, function(whole, inside) {
                    var ob = can.getObject(inside, data, remove === true ? false : undefined);
                    if (ob === undefined || ob === null) {
                        obs = null;
                        return "";
                    }
                    if (isContainer(ob) && obs) {
                        obs.push(ob);
                        return "";
                    }
                    return "" + ob;
                }));
                return obs === null ? obs : obs.length <= 1 ? obs[0] : obs;
            },
            replacer: strReplacer,
            undHash: strUndHash
        });
        return can;
    }(__m2);
    var __m12 = function(can) {
        var initializing = 0;
        var getDescriptor = function(newProps, name) {
            var descriptor = Object.getOwnPropertyDescriptor(newProps, name);
            if (descriptor && (descriptor.get || descriptor.set)) {
                return descriptor;
            }
            return null;
        }, inheritGetterSetter = function(newProps, oldProps, addTo) {
            addTo = addTo || newProps;
            var descriptor;
            for (var name in newProps) {
                if (descriptor = getDescriptor(newProps, name)) {
                    this._defineProperty(addTo, oldProps, name, descriptor);
                } else {
                    can.Construct._overwrite(addTo, oldProps, name, newProps[name]);
                }
            }
        }, simpleInherit = function(newProps, oldProps, addTo) {
            addTo = addTo || newProps;
            for (var name in newProps) {
                can.Construct._overwrite(addTo, oldProps, name, newProps[name]);
            }
        };
        can.Construct = function() {
            if (arguments.length) {
                return can.Construct.extend.apply(can.Construct, arguments);
            }
        };
        can.extend(can.Construct, {
            constructorExtends: true,
            newInstance: function() {
                var inst = this.instance(), args;
                if (inst.setup) {
                    args = inst.setup.apply(inst, arguments);
                }
                if (inst.init) {
                    inst.init.apply(inst, args || arguments);
                }
                return inst;
            },
            _inherit: Object.getOwnPropertyDescriptor ? inheritGetterSetter : simpleInherit,
            _defineProperty: function(what, oldProps, propName, descriptor) {
                Object.defineProperty(what, propName, descriptor);
            },
            _overwrite: function(what, oldProps, propName, val) {
                what[propName] = val;
            },
            setup: function(base, fullName) {
                this.defaults = can.extend(true, {}, base.defaults, this.defaults);
            },
            instance: function() {
                initializing = 1;
                var inst = new this();
                initializing = 0;
                return inst;
            },
            extend: function(name, staticProperties, instanceProperties) {
                var fullName = name, klass = staticProperties, proto = instanceProperties;
                if (typeof fullName !== "string") {
                    proto = klass;
                    klass = fullName;
                    fullName = null;
                }
                if (!proto) {
                    proto = klass;
                    klass = null;
                }
                proto = proto || {};
                var _super_class = this, _super = this.prototype, parts, current, _fullName, _shortName, propName, shortName, namespace, prototype;
                prototype = this.instance();
                can.Construct._inherit(proto, _super, prototype);
                function Constructor() {
                    if (!initializing) {
                        return this.constructor !== Constructor && arguments.length && Constructor.constructorExtends ? Constructor.extend.apply(Constructor, arguments) : Constructor.newInstance.apply(Constructor, arguments);
                    }
                }
                for (propName in _super_class) {
                    if (_super_class.hasOwnProperty(propName)) {
                        Constructor[propName] = _super_class[propName];
                    }
                }
                can.Construct._inherit(klass, _super_class, Constructor);
                if (fullName) {
                    parts = fullName.split(".");
                    shortName = parts.pop();
                    current = can.getObject(parts.join("."), window, true);
                    namespace = current;
                    _fullName = can.underscore(fullName.replace(/\./g, "_"));
                    _shortName = can.underscore(shortName);
                    current[shortName] = Constructor;
                }
                can.extend(Constructor, {
                    constructor: Constructor,
                    prototype: prototype,
                    namespace: namespace,
                    _shortName: _shortName,
                    fullName: fullName,
                    _fullName: _fullName
                });
                if (shortName !== undefined) {
                    Constructor.shortName = shortName;
                }
                Constructor.prototype.constructor = Constructor;
                var t = [ _super_class ].concat(can.makeArray(arguments)), args = Constructor.setup.apply(Constructor, t);
                if (Constructor.init) {
                    Constructor.init.apply(Constructor, args || t);
                }
                return Constructor;
            }
        });
        can.Construct.prototype.setup = function() {};
        can.Construct.prototype.init = function() {};
        return can.Construct;
    }(__m13);
    var __m11 = function(can) {
        var bind = function(el, ev, callback) {
            can.bind.call(el, ev, callback);
            return function() {
                can.unbind.call(el, ev, callback);
            };
        }, isFunction = can.isFunction, extend = can.extend, each = can.each, slice = [].slice, paramReplacer = /\{([^\}]+)\}/g, special = can.getObject("$.event.special", [ can ]) || {}, delegate = function(el, selector, ev, callback) {
            can.delegate.call(el, selector, ev, callback);
            return function() {
                can.undelegate.call(el, selector, ev, callback);
            };
        }, binder = function(el, ev, callback, selector) {
            return selector ? delegate(el, can.trim(selector), ev, callback) : bind(el, ev, callback);
        }, basicProcessor;
        var Control = can.Control = can.Construct({
            setup: function() {
                can.Construct.setup.apply(this, arguments);
                if (can.Control) {
                    var control = this, funcName;
                    control.actions = {};
                    for (funcName in control.prototype) {
                        if (control._isAction(funcName)) {
                            control.actions[funcName] = control._action(funcName);
                        }
                    }
                }
            },
            _shifter: function(context, name) {
                var method = typeof name === "string" ? context[name] : name;
                if (!isFunction(method)) {
                    method = context[method];
                }
                return function() {
                    context.called = name;
                    return method.apply(context, [ this.nodeName ? can.$(this) : this ].concat(slice.call(arguments, 0)));
                };
            },
            _isAction: function(methodName) {
                var val = this.prototype[methodName], type = typeof val;
                return methodName !== "constructor" && (type === "function" || type === "string" && isFunction(this.prototype[val])) && !!(special[methodName] || processors[methodName] || /[^\w]/.test(methodName));
            },
            _action: function(methodName, options) {
                paramReplacer.lastIndex = 0;
                if (options || !paramReplacer.test(methodName)) {
                    var convertedName = options ? can.sub(methodName, this._lookup(options)) : methodName;
                    if (!convertedName) {
                        return null;
                    }
                    var arr = can.isArray(convertedName), name = arr ? convertedName[1] : convertedName, parts = name.split(/\s+/g), event = parts.pop();
                    return {
                        processor: processors[event] || basicProcessor,
                        parts: [ name, parts.join(" "), event ],
                        delegate: arr ? convertedName[0] : undefined
                    };
                }
            },
            _lookup: function(options) {
                return [ options, window ];
            },
            processors: {},
            defaults: {}
        }, {
            setup: function(element, options) {
                var cls = this.constructor, pluginname = cls.pluginName || cls._fullName, arr;
                this.element = can.$(element);
                if (pluginname && pluginname !== "can_control") {
                    this.element.addClass(pluginname);
                }
                arr = can.data(this.element, "controls");
                if (!arr) {
                    arr = [];
                    can.data(this.element, "controls", arr);
                }
                arr.push(this);
                this.options = extend({}, cls.defaults, options);
                this.on();
                return [ this.element, this.options ];
            },
            on: function(el, selector, eventName, func) {
                if (!el) {
                    this.off();
                    var cls = this.constructor, bindings = this._bindings, actions = cls.actions, element = this.element, destroyCB = can.Control._shifter(this, "destroy"), funcName, ready;
                    for (funcName in actions) {
                        if (actions.hasOwnProperty(funcName)) {
                            ready = actions[funcName] || cls._action(funcName, this.options, this);
                            if (ready) {
                                bindings.control[funcName] = ready.processor(ready.delegate || element, ready.parts[2], ready.parts[1], funcName, this);
                            }
                        }
                    }
                    can.bind.call(element, "removed", destroyCB);
                    bindings.user.push(function(el) {
                        can.unbind.call(el, "removed", destroyCB);
                    });
                    return bindings.user.length;
                }
                if (typeof el === "string") {
                    func = eventName;
                    eventName = selector;
                    selector = el;
                    el = this.element;
                }
                if (func === undefined) {
                    func = eventName;
                    eventName = selector;
                    selector = null;
                }
                if (typeof func === "string") {
                    func = can.Control._shifter(this, func);
                }
                this._bindings.user.push(binder(el, eventName, func, selector));
                return this._bindings.user.length;
            },
            off: function() {
                var el = this.element[0], bindings = this._bindings;
                if (bindings) {
                    each(bindings.user || [], function(value) {
                        value(el);
                    });
                    each(bindings.control || {}, function(value) {
                        value(el);
                    });
                }
                this._bindings = {
                    user: [],
                    control: {}
                };
            },
            destroy: function() {
                if (this.element === null) {
                    return;
                }
                var Class = this.constructor, pluginName = Class.pluginName || Class._fullName, controls;
                this.off();
                if (pluginName && pluginName !== "can_control") {
                    this.element.removeClass(pluginName);
                }
                controls = can.data(this.element, "controls");
                controls.splice(can.inArray(this, controls), 1);
                can.trigger(this, "destroyed");
                this.element = null;
            }
        });
        var processors = can.Control.processors;
        basicProcessor = function(el, event, selector, methodName, control) {
            return binder(el, event, can.Control._shifter(control, methodName), selector);
        };
        each([ "change", "click", "contextmenu", "dblclick", "keydown", "keyup", "keypress", "mousedown", "mousemove", "mouseout", "mouseover", "mouseup", "reset", "resize", "scroll", "select", "submit", "focusin", "focusout", "mouseenter", "mouseleave", "touchstart", "touchmove", "touchcancel", "touchend", "touchleave", "inserted", "removed" ], function(v) {
            processors[v] = basicProcessor;
        });
        return Control;
    }(__m2, __m12);
    var __m16 = function(can) {
        can.bindAndSetup = function() {
            can.addEvent.apply(this, arguments);
            if (!this._init) {
                if (!this._bindings) {
                    this._bindings = 1;
                    if (this._bindsetup) {
                        this._bindsetup();
                    }
                } else {
                    this._bindings++;
                }
            }
            return this;
        };
        can.unbindAndTeardown = function(ev, handler) {
            can.removeEvent.apply(this, arguments);
            if (this._bindings === null) {
                this._bindings = 0;
            } else {
                this._bindings--;
            }
            if (!this._bindings && this._bindteardown) {
                this._bindteardown();
            }
            return this;
        };
        return can;
    }(__m2);
    var __m17 = function(can) {
        var bubble = can.bubble = {
            event: function(map, eventName) {
                return map.constructor._bubbleRule(eventName, map);
            },
            childrenOf: function(parentMap, eventName) {
                parentMap._each(function(child, prop) {
                    if (child && child.bind) {
                        bubble.toParent(child, parentMap, prop, eventName);
                    }
                });
            },
            teardownChildrenFrom: function(parentMap, eventName) {
                parentMap._each(function(child) {
                    bubble.teardownFromParent(parentMap, child, eventName);
                });
            },
            toParent: function(child, parent, prop, eventName) {
                can.listenTo.call(parent, child, eventName, function() {
                    var args = can.makeArray(arguments), ev = args.shift();
                    args[0] = (can.List && parent instanceof can.List ? parent.indexOf(child) : prop) + (args[0] ? "." + args[0] : "");
                    ev.triggeredNS = ev.triggeredNS || {};
                    if (ev.triggeredNS[parent._cid]) {
                        return;
                    }
                    ev.triggeredNS[parent._cid] = true;
                    can.trigger(parent, ev, args);
                });
            },
            teardownFromParent: function(parent, child, eventName) {
                if (child && child.unbind) {
                    can.stopListening.call(parent, child, eventName);
                }
            },
            isBubbling: function(parent, eventName) {
                return parent._bubbleBindings && parent._bubbleBindings[eventName];
            },
            bind: function(parent, eventName) {
                if (!parent._init) {
                    var bubbleEvent = bubble.event(parent, eventName);
                    if (bubbleEvent) {
                        if (!parent._bubbleBindings) {
                            parent._bubbleBindings = {};
                        }
                        if (!parent._bubbleBindings[bubbleEvent]) {
                            parent._bubbleBindings[bubbleEvent] = 1;
                            bubble.childrenOf(parent, bubbleEvent);
                        } else {
                            parent._bubbleBindings[bubbleEvent]++;
                        }
                    }
                }
            },
            unbind: function(parent, eventName) {
                var bubbleEvent = bubble.event(parent, eventName);
                if (bubbleEvent) {
                    if (parent._bubbleBindings) {
                        parent._bubbleBindings[bubbleEvent]--;
                    }
                    if (parent._bubbleBindings && !parent._bubbleBindings[bubbleEvent]) {
                        delete parent._bubbleBindings[bubbleEvent];
                        bubble.teardownChildrenFrom(parent, bubbleEvent);
                        if (can.isEmptyObject(parent._bubbleBindings)) {
                            delete parent._bubbleBindings;
                        }
                    }
                }
            },
            add: function(parent, child, prop) {
                if (child instanceof can.Map && parent._bubbleBindings) {
                    for (var eventName in parent._bubbleBindings) {
                        if (parent._bubbleBindings[eventName]) {
                            bubble.teardownFromParent(parent, child, eventName);
                            bubble.toParent(child, parent, prop, eventName);
                        }
                    }
                }
            },
            removeMany: function(parent, children) {
                for (var i = 0, len = children.length; i < len; i++) {
                    bubble.remove(parent, children[i]);
                }
            },
            remove: function(parent, child) {
                if (child instanceof can.Map && parent._bubbleBindings) {
                    for (var eventName in parent._bubbleBindings) {
                        if (parent._bubbleBindings[eventName]) {
                            bubble.teardownFromParent(parent, child, eventName);
                        }
                    }
                }
            },
            set: function(parent, prop, value, current) {
                if (can.Map.helpers.isObservable(value)) {
                    bubble.add(parent, value, prop);
                }
                if (can.Map.helpers.isObservable(current)) {
                    bubble.remove(parent, current);
                }
                return value;
            }
        };
        return bubble;
    }(__m2);
    var __m18 = function(can) {
        var batchNum = 1, transactions = 0, batchEvents = [], stopCallbacks = [];
        can.batch = {
            start: function(batchStopHandler) {
                transactions++;
                if (batchStopHandler) {
                    stopCallbacks.push(batchStopHandler);
                }
            },
            stop: function(force, callStart) {
                if (force) {
                    transactions = 0;
                } else {
                    transactions--;
                }
                if (transactions === 0) {
                    var items = batchEvents.slice(0), callbacks = stopCallbacks.slice(0), i, len;
                    batchEvents = [];
                    stopCallbacks = [];
                    batchNum++;
                    if (callStart) {
                        can.batch.start();
                    }
                    for (i = 0, len = items.length; i < len; i++) {
                        can.dispatch.apply(items[i][0], items[i][1]);
                    }
                    for (i = 0, len = callbacks.length; i < callbacks.length; i++) {
                        callbacks[i]();
                    }
                }
            },
            trigger: function(item, event, args) {
                if (!item._init) {
                    if (transactions === 0) {
                        return can.dispatch.call(item, event, args);
                    } else {
                        event = typeof event === "string" ? {
                            type: event
                        } : event;
                        event.batchNum = batchNum;
                        batchEvents.push([ item, [ event, args ] ]);
                    }
                }
            }
        };
    }(__m4);
    var __m15 = function(can, bind, bubble) {
        var madeMap = null;
        var teardownMap = function() {
            for (var cid in madeMap) {
                if (madeMap[cid].added) {
                    delete madeMap[cid].obj._cid;
                }
            }
            madeMap = null;
        };
        var getMapFromObject = function(obj) {
            return madeMap && madeMap[obj._cid] && madeMap[obj._cid].instance;
        };
        var serializeMap = null;
        var Map = can.Map = can.Construct.extend({
            setup: function() {
                can.Construct.setup.apply(this, arguments);
                if (can.Map) {
                    if (!this.defaults) {
                        this.defaults = {};
                    }
                    this._computes = [];
                    for (var prop in this.prototype) {
                        if (prop !== "define" && prop !== "constructor" && (typeof this.prototype[prop] !== "function" || this.prototype[prop].prototype instanceof can.Construct)) {
                            this.defaults[prop] = this.prototype[prop];
                        } else if (this.prototype[prop].isComputed) {
                            this._computes.push(prop);
                        }
                    }
                    if (this.helpers.define) {
                        this.helpers.define(this);
                    }
                }
                if (can.List && !(this.prototype instanceof can.List)) {
                    this.List = Map.List.extend({
                        Map: this
                    }, {});
                }
            },
            _bubble: bubble,
            _bubbleRule: function(eventName) {
                return (eventName === "change" || eventName.indexOf(".") >= 0) && "change";
            },
            _computes: [],
            bind: can.bindAndSetup,
            on: can.bindAndSetup,
            unbind: can.unbindAndTeardown,
            off: can.unbindAndTeardown,
            id: "id",
            helpers: {
                define: null,
                attrParts: function(attr, keepKey) {
                    if (keepKey) {
                        return [ attr ];
                    }
                    return typeof attr === "object" ? attr : ("" + attr).split(".");
                },
                addToMap: function(obj, instance) {
                    var teardown;
                    if (!madeMap) {
                        teardown = teardownMap;
                        madeMap = {};
                    }
                    var hasCid = obj._cid;
                    var cid = can.cid(obj);
                    if (!madeMap[cid]) {
                        madeMap[cid] = {
                            obj: obj,
                            instance: instance,
                            added: !hasCid
                        };
                    }
                    return teardown;
                },
                isObservable: function(obj) {
                    return obj instanceof can.Map || obj && obj === can.route;
                },
                canMakeObserve: function(obj) {
                    return obj && !can.isDeferred(obj) && (can.isArray(obj) || can.isPlainObject(obj));
                },
                serialize: function(map, how, where) {
                    var cid = can.cid(map), firstSerialize = false;
                    if (!serializeMap) {
                        firstSerialize = true;
                        serializeMap = {
                            attr: {},
                            serialize: {}
                        };
                    }
                    serializeMap[how][cid] = where;
                    map.each(function(val, name) {
                        var result, isObservable = Map.helpers.isObservable(val), serialized = isObservable && serializeMap[how][can.cid(val)];
                        if (serialized) {
                            result = serialized;
                        } else {
                            if (how === "serialize") {
                                result = Map.helpers._serialize(map, name, val);
                            } else {
                                result = Map.helpers._getValue(map, name, val, how);
                            }
                        }
                        if (result !== undefined) {
                            where[name] = result;
                        }
                    });
                    can.__reading(map, "__keys");
                    if (firstSerialize) {
                        serializeMap = null;
                    }
                    return where;
                },
                _serialize: function(map, name, val) {
                    return Map.helpers._getValue(map, name, val, "serialize");
                },
                _getValue: function(map, name, val, how) {
                    if (Map.helpers.isObservable(val)) {
                        return val[how]();
                    } else {
                        return val;
                    }
                }
            },
            keys: function(map) {
                var keys = [];
                can.__reading(map, "__keys");
                for (var keyName in map._data) {
                    keys.push(keyName);
                }
                return keys;
            }
        }, {
            setup: function(obj) {
                if (obj instanceof can.Map) {
                    obj = obj.serialize();
                }
                this._data = {};
                can.cid(this, ".map");
                this._init = 1;
                this._computedBindings = {};
                var defaultValues = this._setupDefaults(obj);
                this._setupComputes(defaultValues);
                var teardownMapping = obj && can.Map.helpers.addToMap(obj, this);
                var data = can.extend(can.extend(true, {}, defaultValues), obj);
                this.attr(data);
                if (teardownMapping) {
                    teardownMapping();
                }
                this.bind("change", can.proxy(this._changes, this));
                delete this._init;
            },
            _setupComputes: function() {
                var computes = this.constructor._computes;
                for (var i = 0, len = computes.length, prop; i < len; i++) {
                    prop = computes[i];
                    this[prop] = this[prop].clone(this);
                    this._computedBindings[prop] = {
                        count: 0
                    };
                }
            },
            _setupDefaults: function() {
                return this.constructor.defaults || {};
            },
            _bindsetup: function() {},
            _bindteardown: function() {},
            _changes: function(ev, attr, how, newVal, oldVal) {
                can.batch.trigger(this, {
                    type: attr,
                    batchNum: ev.batchNum,
                    target: ev.target
                }, [ newVal, oldVal ]);
            },
            _triggerChange: function(attr, how, newVal, oldVal) {
                if (bubble.isBubbling(this, "change")) {
                    can.batch.trigger(this, {
                        type: "change",
                        target: this
                    }, [ attr, how, newVal, oldVal ]);
                } else {
                    can.batch.trigger(this, attr, [ newVal, oldVal ]);
                }
                if (how === "remove" || how === "add") {
                    can.batch.trigger(this, {
                        type: "__keys",
                        target: this
                    });
                }
            },
            _each: function(callback) {
                var data = this.__get();
                for (var prop in data) {
                    if (data.hasOwnProperty(prop)) {
                        callback(data[prop], prop);
                    }
                }
            },
            attr: function(attr, val) {
                var type = typeof attr;
                if (type !== "string" && type !== "number") {
                    return this._attrs(attr, val);
                } else if (arguments.length === 1) {
                    can.__reading(this, attr);
                    return this._get(attr);
                } else {
                    this._set(attr, val);
                    return this;
                }
            },
            each: function() {
                return can.each.apply(undefined, [ this ].concat(can.makeArray(arguments)));
            },
            removeAttr: function(attr) {
                var isList = can.List && this instanceof can.List, parts = can.Map.helpers.attrParts(attr), prop = parts.shift(), current = isList ? this[prop] : this._data[prop];
                if (parts.length && current) {
                    return current.removeAttr(parts);
                } else {
                    if (typeof attr === "string" && !!~attr.indexOf(".")) {
                        prop = attr;
                    }
                    this._remove(prop, current);
                    return current;
                }
            },
            _remove: function(prop, current) {
                if (prop in this._data) {
                    delete this._data[prop];
                    if (!(prop in this.constructor.prototype)) {
                        delete this[prop];
                    }
                    this._triggerChange(prop, "remove", undefined, current);
                }
            },
            _get: function(attr) {
                attr = "" + attr;
                var dotIndex = attr.indexOf(".");
                if (dotIndex >= 0) {
                    var value = this.__get(attr);
                    if (value !== undefined) {
                        return value;
                    }
                    var first = attr.substr(0, dotIndex), second = attr.substr(dotIndex + 1), current = this.__get(first);
                    return current && current._get ? current._get(second) : undefined;
                } else {
                    return this.__get(attr);
                }
            },
            __get: function(attr) {
                if (attr) {
                    if (this._computedBindings[attr]) {
                        return this[attr]();
                    } else {
                        return this._data[attr];
                    }
                } else {
                    return this._data;
                }
            },
            __type: function(value, prop) {
                if (!(value instanceof can.Map) && can.Map.helpers.canMakeObserve(value)) {
                    var cached = getMapFromObject(value);
                    if (cached) {
                        return cached;
                    }
                    if (can.isArray(value)) {
                        var List = can.List;
                        return new List(value);
                    } else {
                        var Map = this.constructor.Map || can.Map;
                        return new Map(value);
                    }
                }
                return value;
            },
            _set: function(attr, value, keepKey) {
                attr = "" + attr;
                var dotIndex = attr.indexOf("."), current;
                if (!keepKey && dotIndex >= 0) {
                    var first = attr.substr(0, dotIndex), second = attr.substr(dotIndex + 1);
                    current = this._init ? undefined : this.__get(first);
                    if (Map.helpers.isObservable(current)) {
                        current._set(second, value);
                    } else {
                        throw "can.Map: Object does not exist";
                    }
                } else {
                    if (this.__convert) {
                        value = this.__convert(attr, value);
                    }
                    current = this._init ? undefined : this.__get(attr);
                    this.__set(attr, this.__type(value, attr), current);
                }
            },
            __set: function(prop, value, current) {
                if (value !== current) {
                    var changeType = current !== undefined || this.__get().hasOwnProperty(prop) ? "set" : "add";
                    this.___set(prop, this.constructor._bubble.set(this, prop, value, current));
                    this._triggerChange(prop, changeType, value, current);
                    if (current) {
                        this.constructor._bubble.teardownFromParent(this, current);
                    }
                }
            },
            ___set: function(prop, val) {
                if (this._computedBindings[prop]) {
                    this[prop](val);
                } else {
                    this._data[prop] = val;
                }
                if (typeof this.constructor.prototype[prop] !== "function" && !this._computedBindings[prop]) {
                    this[prop] = val;
                }
            },
            bind: function(eventName, handler) {
                var computedBinding = this._computedBindings && this._computedBindings[eventName];
                if (computedBinding) {
                    if (!computedBinding.count) {
                        computedBinding.count = 1;
                        var self = this;
                        computedBinding.handler = function(ev, newVal, oldVal) {
                            can.batch.trigger(self, {
                                type: eventName,
                                batchNum: ev.batchNum,
                                target: self
                            }, [ newVal, oldVal ]);
                        };
                        this[eventName].bind("change", computedBinding.handler);
                    } else {
                        computedBinding.count++;
                    }
                }
                this.constructor._bubble.bind(this, eventName);
                return can.bindAndSetup.apply(this, arguments);
            },
            unbind: function(eventName, handler) {
                var computedBinding = this._computedBindings && this._computedBindings[eventName];
                if (computedBinding) {
                    if (computedBinding.count === 1) {
                        computedBinding.count = 0;
                        this[eventName].unbind("change", computedBinding.handler);
                        delete computedBinding.handler;
                    } else {
                        computedBinding.count--;
                    }
                }
                this.constructor._bubble.unbind(this, eventName);
                return can.unbindAndTeardown.apply(this, arguments);
            },
            serialize: function() {
                return can.Map.helpers.serialize(this, "serialize", {});
            },
            _attrs: function(props, remove) {
                if (props === undefined) {
                    return Map.helpers.serialize(this, "attr", {});
                }
                props = can.simpleExtend({}, props);
                var prop, self = this, newVal;
                can.batch.start();
                this.each(function(curVal, prop) {
                    if (prop === "_cid") {
                        return;
                    }
                    newVal = props[prop];
                    if (newVal === undefined) {
                        if (remove) {
                            self.removeAttr(prop);
                        }
                        return;
                    }
                    if (self.__convert) {
                        newVal = self.__convert(prop, newVal);
                    }
                    if (Map.helpers.isObservable(newVal)) {
                        self.__set(prop, self.__type(newVal, prop), curVal);
                    } else if (Map.helpers.isObservable(curVal) && Map.helpers.canMakeObserve(newVal)) {
                        curVal.attr(newVal, remove);
                    } else if (curVal !== newVal) {
                        self.__set(prop, self.__type(newVal, prop), curVal);
                    }
                    delete props[prop];
                });
                for (prop in props) {
                    if (prop !== "_cid") {
                        newVal = props[prop];
                        this._set(prop, newVal, true);
                    }
                }
                can.batch.stop();
                return this;
            },
            compute: function(prop) {
                if (can.isFunction(this.constructor.prototype[prop])) {
                    return can.compute(this[prop], this);
                } else {
                    var reads = prop.split("."), last = reads.length - 1, options = {
                        args: []
                    };
                    return can.compute(function(newVal) {
                        if (arguments.length) {
                            can.compute.read(this, reads.slice(0, last)).value.attr(reads[last], newVal);
                        } else {
                            return can.compute.read(this, reads, options).value;
                        }
                    }, this);
                }
            }
        });
        Map.prototype.on = Map.prototype.bind;
        Map.prototype.off = Map.prototype.unbind;
        return Map;
    }(__m2, __m16, __m17, __m12, __m18);
    var __m19 = function(can, Map, bubble) {
        var splice = [].splice, spliceRemovesProps = function() {
            var obj = {
                0: "a",
                length: 1
            };
            splice.call(obj, 0, 1);
            return !obj[0];
        }();
        var list = Map.extend({
            Map: Map
        }, {
            setup: function(instances, options) {
                this.length = 0;
                can.cid(this, ".map");
                this._init = 1;
                this._computedBindings = {};
                this._setupComputes();
                instances = instances || [];
                var teardownMapping;
                if (can.isDeferred(instances)) {
                    this.replace(instances);
                } else {
                    teardownMapping = instances.length && can.Map.helpers.addToMap(instances, this);
                    this.push.apply(this, can.makeArray(instances || []));
                }
                if (teardownMapping) {
                    teardownMapping();
                }
                this.bind("change", can.proxy(this._changes, this));
                can.simpleExtend(this, options);
                delete this._init;
            },
            _triggerChange: function(attr, how, newVal, oldVal) {
                Map.prototype._triggerChange.apply(this, arguments);
                var index = +attr;
                if (!~attr.indexOf(".") && !isNaN(index)) {
                    if (how === "add") {
                        can.batch.trigger(this, how, [ newVal, index ]);
                        can.batch.trigger(this, "length", [ this.length ]);
                    } else if (how === "remove") {
                        can.batch.trigger(this, how, [ oldVal, index ]);
                        can.batch.trigger(this, "length", [ this.length ]);
                    } else {
                        can.batch.trigger(this, how, [ newVal, index ]);
                    }
                }
            },
            __get: function(attr) {
                if (attr) {
                    if (this[attr] && this[attr].isComputed && can.isFunction(this.constructor.prototype[attr])) {
                        return this[attr]();
                    } else {
                        return this[attr];
                    }
                } else {
                    return this;
                }
            },
            ___set: function(attr, val) {
                this[attr] = val;
                if (+attr >= this.length) {
                    this.length = +attr + 1;
                }
            },
            _remove: function(prop, current) {
                if (isNaN(+prop)) {
                    delete this[prop];
                    this._triggerChange(prop, "remove", undefined, current);
                } else {
                    this.splice(prop, 1);
                }
            },
            _each: function(callback) {
                var data = this.__get();
                for (var i = 0; i < data.length; i++) {
                    callback(data[i], i);
                }
            },
            serialize: function() {
                return Map.helpers.serialize(this, "serialize", []);
            },
            splice: function(index, howMany) {
                var args = can.makeArray(arguments), added = [], i, len;
                for (i = 2, len = args.length; i < len; i++) {
                    args[i] = this.__type(args[i], i);
                    added.push(args[i]);
                }
                if (howMany === undefined) {
                    howMany = args[1] = this.length - index;
                }
                var removed = splice.apply(this, args);
                if (!spliceRemovesProps) {
                    for (i = this.length; i < removed.length + this.length; i++) {
                        delete this[i];
                    }
                }
                can.batch.start();
                if (howMany > 0) {
                    bubble.removeMany(this, removed);
                    this._triggerChange("" + index, "remove", undefined, removed);
                }
                if (args.length > 2) {
                    for (i = 0, len = added.length; i < len; i++) {
                        bubble.set(this, i, added[i]);
                    }
                    this._triggerChange("" + index, "add", added, removed);
                }
                can.batch.stop();
                return removed;
            },
            _attrs: function(items, remove) {
                if (items === undefined) {
                    return Map.helpers.serialize(this, "attr", []);
                }
                items = can.makeArray(items);
                can.batch.start();
                this._updateAttrs(items, remove);
                can.batch.stop();
            },
            _updateAttrs: function(items, remove) {
                var len = Math.min(items.length, this.length);
                for (var prop = 0; prop < len; prop++) {
                    var curVal = this[prop], newVal = items[prop];
                    if (Map.helpers.isObservable(curVal) && Map.helpers.canMakeObserve(newVal)) {
                        curVal.attr(newVal, remove);
                    } else if (curVal !== newVal) {
                        this._set(prop, newVal);
                    } else {}
                }
                if (items.length > this.length) {
                    this.push.apply(this, items.slice(this.length));
                } else if (items.length < this.length && remove) {
                    this.splice(items.length);
                }
            }
        }), getArgs = function(args) {
            return args[0] && can.isArray(args[0]) ? args[0] : can.makeArray(args);
        };
        can.each({
            push: "length",
            unshift: 0
        }, function(where, name) {
            var orig = [][name];
            list.prototype[name] = function() {
                var args = [], len = where ? this.length : 0, i = arguments.length, res, val;
                while (i--) {
                    val = arguments[i];
                    args[i] = bubble.set(this, i, this.__type(val, i));
                }
                res = orig.apply(this, args);
                if (!this.comparator || args.length) {
                    this._triggerChange("" + len, "add", args, undefined);
                }
                return res;
            };
        });
        can.each({
            pop: "length",
            shift: 0
        }, function(where, name) {
            list.prototype[name] = function() {
                var args = getArgs(arguments), len = where && this.length ? this.length - 1 : 0;
                var res = [][name].apply(this, args);
                this._triggerChange("" + len, "remove", undefined, [ res ]);
                if (res && res.unbind) {
                    bubble.remove(this, res);
                }
                return res;
            };
        });
        can.extend(list.prototype, {
            indexOf: function(item, fromIndex) {
                this.attr("length");
                return can.inArray(item, this, fromIndex);
            },
            join: function() {
                return [].join.apply(this.attr(), arguments);
            },
            reverse: function() {
                var list = can.makeArray([].reverse.call(this));
                this.replace(list);
            },
            slice: function() {
                var temp = Array.prototype.slice.apply(this, arguments);
                return new this.constructor(temp);
            },
            concat: function() {
                var args = [];
                can.each(can.makeArray(arguments), function(arg, i) {
                    args[i] = arg instanceof can.List ? arg.serialize() : arg;
                });
                return new this.constructor(Array.prototype.concat.apply(this.serialize(), args));
            },
            forEach: function(cb, thisarg) {
                return can.each(this, cb, thisarg || this);
            },
            replace: function(newList) {
                if (can.isDeferred(newList)) {
                    newList.then(can.proxy(this.replace, this));
                } else {
                    this.splice.apply(this, [ 0, this.length ].concat(can.makeArray(newList || [])));
                }
                return this;
            },
            filter: function(callback, thisArg) {
                var filteredList = new can.List(), self = this, filtered;
                this.each(function(item, index, list) {
                    filtered = callback.call(thisArg | self, item, index, self);
                    if (filtered) {
                        filteredList.push(item);
                    }
                });
                return filteredList;
            }
        });
        can.List = Map.List = list;
        return can.List;
    }(__m2, __m15, __m17);
    var __m20 = function(can, bind) {
        var stack = [];
        can.__read = function(func, self) {
            stack.push({});
            var value = func.call(self);
            return {
                value: value,
                observed: stack.pop()
            };
        };
        can.__reading = function(obj, event) {
            if (stack.length) {
                stack[stack.length - 1][obj._cid + "|" + event] = {
                    obj: obj,
                    event: event + ""
                };
            }
        };
        can.__clearReading = function() {
            if (stack.length) {
                var ret = stack[stack.length - 1];
                stack[stack.length - 1] = {};
                return ret;
            }
        };
        can.__setReading = function(o) {
            if (stack.length) {
                stack[stack.length - 1] = o;
            }
        };
        can.__addReading = function(o) {
            if (stack.length) {
                can.simpleExtend(stack[stack.length - 1], o);
            }
        };
        var getValueAndBind = function(func, context, oldObserved, onchanged) {
            var info = can.__read(func, context), newObserveSet = info.observed;
            bindNewSet(oldObserved, newObserveSet, onchanged);
            unbindOldSet(oldObserved, onchanged);
            return info;
        };
        var bindNewSet = function(oldObserved, newObserveSet, onchanged) {
            for (var name in newObserveSet) {
                bindOrPreventUnbinding(oldObserved, newObserveSet, name, onchanged);
            }
        };
        var bindOrPreventUnbinding = function(oldObserved, newObserveSet, name, onchanged) {
            if (oldObserved[name]) {
                delete oldObserved[name];
            } else {
                var obEv = newObserveSet[name];
                obEv.obj.bind(obEv.event, onchanged);
            }
        };
        var unbindOldSet = function(oldObserved, onchanged) {
            for (var name in oldObserved) {
                var obEv = oldObserved[name];
                obEv.obj.unbind(obEv.event, onchanged);
            }
        };
        var updateOnChange = function(compute, newValue, oldValue, batchNum) {
            if (newValue !== oldValue) {
                can.batch.trigger(compute, batchNum ? {
                    type: "change",
                    batchNum: batchNum
                } : "change", [ newValue, oldValue ]);
            }
        };
        var setupComputeHandlers = function(compute, func, context, setCachedValue) {
            var readInfo, onchanged, batchNum;
            return {
                on: function(updater) {
                    if (!onchanged) {
                        onchanged = function(ev) {
                            if (compute.bound && (ev.batchNum === undefined || ev.batchNum !== batchNum)) {
                                var oldValue = readInfo.value;
                                readInfo = getValueAndBind(func, context, readInfo.observed, onchanged);
                                updater(readInfo.value, oldValue, ev.batchNum);
                                batchNum = batchNum = ev.batchNum;
                            }
                        };
                    }
                    readInfo = getValueAndBind(func, context, {}, onchanged);
                    setCachedValue(readInfo.value);
                    compute.hasDependencies = !can.isEmptyObject(readInfo.observed);
                },
                off: function(updater) {
                    for (var name in readInfo.observed) {
                        var ob = readInfo.observed[name];
                        ob.obj.unbind(ob.event, onchanged);
                    }
                }
            };
        };
        var setupSingleBindComputeHandlers = function(compute, func, context, setCachedValue) {
            var readInfo, oldValue, onchanged, batchNum;
            return {
                on: function(updater) {
                    if (!onchanged) {
                        onchanged = function(ev) {
                            if (compute.bound && (ev.batchNum === undefined || ev.batchNum !== batchNum)) {
                                var reads = can.__clearReading();
                                var newValue = func.call(context);
                                can.__setReading(reads);
                                updater(newValue, oldValue, ev.batchNum);
                                oldValue = newValue;
                                batchNum = batchNum = ev.batchNum;
                            }
                        };
                    }
                    readInfo = getValueAndBind(func, context, {}, onchanged);
                    oldValue = readInfo.value;
                    setCachedValue(readInfo.value);
                    compute.hasDependencies = !can.isEmptyObject(readInfo.observed);
                },
                off: function(updater) {
                    for (var name in readInfo.observed) {
                        var ob = readInfo.observed[name];
                        ob.obj.unbind(ob.event, onchanged);
                    }
                }
            };
        };
        var isObserve = function(obj) {
            return obj instanceof can.Map || obj && obj.__get;
        }, k = function() {};
        can.compute = function(getterSetter, context, eventName, bindOnce) {
            if (getterSetter && getterSetter.isComputed) {
                return getterSetter;
            }
            var computed, on = k, off = k, value, get = function() {
                return value;
            }, set = function(newVal) {
                value = newVal;
            }, setCached = set, args = [], updater = function(newValue, oldValue, batchNum) {
                setCached(newValue);
                updateOnChange(computed, newValue, oldValue, batchNum);
            }, form;
            for (var i = 0, arglen = arguments.length; i < arglen; i++) {
                args[i] = arguments[i];
            }
            computed = function(newVal) {
                if (arguments.length) {
                    var old = value;
                    var setVal = set.call(context, newVal, old);
                    if (computed.hasDependencies) {
                        return get.call(context);
                    }
                    if (setVal === undefined) {
                        value = get.call(context);
                    } else {
                        value = setVal;
                    }
                    updateOnChange(computed, value, old);
                    return value;
                } else {
                    if (stack.length && computed.canReadForChangeEvent !== false) {
                        can.__reading(computed, "change");
                        if (!computed.bound) {
                            can.compute.temporarilyBind(computed);
                        }
                    }
                    if (computed.bound) {
                        return value;
                    } else {
                        return get.call(context);
                    }
                }
            };
            if (typeof getterSetter === "function") {
                set = getterSetter;
                get = getterSetter;
                computed.canReadForChangeEvent = eventName === false ? false : true;
                var handlers = bindOnce ? setupSingleBindComputeHandlers(computed, getterSetter, context || this, setCached) : setupComputeHandlers(computed, getterSetter, context || this, setCached);
                on = handlers.on;
                off = handlers.off;
            } else if (context) {
                if (typeof context === "string") {
                    var propertyName = context, isObserve = getterSetter instanceof can.Map;
                    if (isObserve) {
                        computed.hasDependencies = true;
                        var handler;
                        get = function() {
                            return getterSetter.attr(propertyName);
                        };
                        set = function(newValue) {
                            getterSetter.attr(propertyName, newValue);
                        };
                        on = function(update) {
                            handler = function(ev, newVal, oldVal) {
                                update(newVal, oldVal, ev.batchNum);
                            };
                            getterSetter.bind(eventName || propertyName, handler);
                            value = can.__read(get).value;
                        };
                        off = function(update) {
                            getterSetter.unbind(eventName || propertyName, handler);
                        };
                    } else {
                        get = function() {
                            return getterSetter[propertyName];
                        };
                        set = function(newValue) {
                            getterSetter[propertyName] = newValue;
                        };
                        on = function(update) {
                            handler = function() {
                                update(get(), value);
                            };
                            can.bind.call(getterSetter, eventName || propertyName, handler);
                            value = can.__read(get).value;
                        };
                        off = function(update) {
                            can.unbind.call(getterSetter, eventName || propertyName, handler);
                        };
                    }
                } else {
                    if (typeof context === "function") {
                        value = getterSetter;
                        set = context;
                        context = eventName;
                        form = "setter";
                    } else {
                        value = getterSetter;
                        var options = context, oldUpdater = updater;
                        context = options.context || options;
                        get = options.get || get;
                        set = options.set || function() {
                            return value;
                        };
                        if (options.fn) {
                            var fn = options.fn, data;
                            get = function() {
                                return fn.call(context, value);
                            };
                            if (fn.length === 0) {
                                data = setupComputeHandlers(computed, fn, context, setCached);
                            } else if (fn.length === 1) {
                                data = setupComputeHandlers(computed, function() {
                                    return fn.call(context, value);
                                }, context, setCached);
                            } else {
                                updater = function(newVal) {
                                    if (newVal !== undefined) {
                                        oldUpdater(newVal, value);
                                    }
                                };
                                data = setupComputeHandlers(computed, function() {
                                    var res = fn.call(context, value, function(newVal) {
                                        oldUpdater(newVal, value);
                                    });
                                    return res !== undefined ? res : value;
                                }, context, setCached);
                            }
                            on = data.on;
                            off = data.off;
                        } else {
                            updater = function() {
                                var newVal = get.call(context);
                                oldUpdater(newVal, value);
                            };
                        }
                        on = options.on || on;
                        off = options.off || off;
                    }
                }
            } else {
                value = getterSetter;
            }
            can.cid(computed, "compute");
            return can.simpleExtend(computed, {
                isComputed: true,
                _bindsetup: function() {
                    this.bound = true;
                    var oldReading = can.__clearReading();
                    on.call(this, updater);
                    can.__setReading(oldReading);
                },
                _bindteardown: function() {
                    off.call(this, updater);
                    this.bound = false;
                },
                bind: can.bindAndSetup,
                unbind: can.unbindAndTeardown,
                clone: function(context) {
                    if (context) {
                        if (form === "setter") {
                            args[2] = context;
                        } else {
                            args[1] = context;
                        }
                    }
                    return can.compute.apply(can, args);
                }
            });
        };
        var computes, unbindComputes = function() {
            for (var i = 0, len = computes.length; i < len; i++) {
                computes[i].unbind("change", k);
            }
            computes = null;
        };
        can.compute.temporarilyBind = function(compute) {
            compute.bind("change", k);
            if (!computes) {
                computes = [];
                setTimeout(unbindComputes, 10);
            }
            computes.push(compute);
        };
        can.compute.truthy = function(compute) {
            return can.compute(function() {
                var res = compute();
                if (typeof res === "function") {
                    res = res();
                }
                return !!res;
            });
        };
        can.compute.async = function(initialValue, asyncComputer, context) {
            return can.compute(initialValue, {
                fn: asyncComputer,
                context: context
            });
        };
        can.compute.read = function(parent, reads, options) {
            options = options || {};
            var cur = parent, type, prev, foundObs;
            for (var i = 0, readLength = reads.length; i < readLength; i++) {
                prev = cur;
                if (prev && prev.isComputed) {
                    if (options.foundObservable) {
                        options.foundObservable(prev, i);
                    }
                    prev = cur = prev();
                }
                if (isObserve(prev)) {
                    if (!foundObs && options.foundObservable) {
                        options.foundObservable(prev, i);
                    }
                    foundObs = 1;
                    if (typeof prev[reads[i]] === "function" && prev.constructor.prototype[reads[i]] === prev[reads[i]]) {
                        if (options.returnObserveMethods) {
                            cur = cur[reads[i]];
                        } else if (reads[i] === "constructor" && prev instanceof can.Construct || prev[reads[i]].prototype instanceof can.Construct) {
                            cur = prev[reads[i]];
                        } else {
                            cur = prev[reads[i]].apply(prev, options.args || []);
                        }
                    } else {
                        cur = cur.attr(reads[i]);
                    }
                } else {
                    if (cur == null) {
                        cur = undefined;
                    } else {
                        cur = prev[reads[i]];
                    }
                }
                type = typeof cur;
                if (cur && cur.isComputed && (!options.isArgument && i < readLength - 1)) {
                    if (!foundObs && options.foundObservable) {
                        options.foundObservable(prev, i + 1);
                    }
                    cur = cur();
                } else if (i < reads.length - 1 && type === "function" && options.executeAnonymousFunctions && !(can.Construct && cur.prototype instanceof can.Construct)) {
                    cur = cur();
                }
                if (i < reads.length - 1 && (cur === null || type !== "function" && type !== "object")) {
                    if (options.earlyExit) {
                        options.earlyExit(prev, i, cur);
                    }
                    return {
                        value: undefined,
                        parent: prev
                    };
                }
            }
            if (typeof cur === "function" && !(can.Construct && cur.prototype instanceof can.Construct) && !(can.route && cur === can.route)) {
                if (options.isArgument) {
                    if (!cur.isComputed && options.proxyMethods !== false) {
                        cur = can.proxy(cur, prev);
                    }
                } else {
                    if (cur.isComputed && !foundObs && options.foundObservable) {
                        options.foundObservable(cur, i);
                    }
                    cur = cur.call(prev);
                }
            }
            if (cur === undefined) {
                if (options.earlyExit) {
                    options.earlyExit(prev, i - 1);
                }
            }
            return {
                value: cur,
                parent: prev
            };
        };
        can.compute.set = function(parent, key, value) {
            if (isObserve(parent)) {
                return parent.attr(key, value);
            }
            if (parent[key] && parent[key].isComputed) {
                return parent[key](value);
            }
            if (typeof parent === "object") {
                parent[key] = value;
            }
        };
        return can.compute;
    }(__m2, __m16, __m18);
    var __m14 = function(can) {
        can.Observe = can.Map;
        can.Observe.startBatch = can.batch.start;
        can.Observe.stopBatch = can.batch.stop;
        can.Observe.triggerBatch = can.batch.trigger;
        return can;
    }(__m2, __m15, __m19, __m20);
    var __m22 = function(can) {
        var escapeReg = /(\\)?\./g, escapeDotReg = /\\\./g, getNames = function(attr) {
            var names = [], last = 0;
            attr.replace(escapeReg, function(first, second, index) {
                if (!second) {
                    names.push(attr.slice(last, index).replace(escapeDotReg, "."));
                    last = index + first.length;
                }
            });
            names.push(attr.slice(last).replace(escapeDotReg, "."));
            return names;
        };
        var Scope = can.Construct.extend({
            read: can.compute.read
        }, {
            init: function(context, parent) {
                this._context = context;
                this._parent = parent;
                this.__cache = {};
            },
            attr: function(key, value) {
                var previousReads = can.__clearReading(), res = this.read(key, {
                    isArgument: true,
                    returnObserveMethods: true,
                    proxyMethods: false
                });
                if (arguments.length === 2) {
                    var lastIndex = key.lastIndexOf("."), readKey = lastIndex !== -1 ? key.substring(0, lastIndex) : ".", obj = this.read(readKey, {
                        isArgument: true,
                        returnObserveMethods: true,
                        proxyMethods: false
                    }).value;
                    if (lastIndex !== -1) {
                        key = key.substring(lastIndex + 1, key.length);
                    }
                    can.compute.set(obj, key, value);
                }
                can.__setReading(previousReads);
                return res.value;
            },
            add: function(context) {
                if (context !== this._context) {
                    return new this.constructor(context, this);
                } else {
                    return this;
                }
            },
            computeData: function(key, options) {
                options = options || {
                    args: []
                };
                var self = this, rootObserve, rootReads, computeData = {
                    compute: can.compute(function(newVal) {
                        if (arguments.length) {
                            if (rootObserve.isComputed) {
                                rootObserve(newVal);
                            } else if (rootReads.length) {
                                var last = rootReads.length - 1;
                                var obj = rootReads.length ? can.compute.read(rootObserve, rootReads.slice(0, last)).value : rootObserve;
                                can.compute.set(obj, rootReads[last], newVal);
                            }
                        } else {
                            if (rootObserve) {
                                return can.compute.read(rootObserve, rootReads, options).value;
                            }
                            var data = self.read(key, options);
                            rootObserve = data.rootObserve;
                            rootReads = data.reads;
                            computeData.scope = data.scope;
                            computeData.initialValue = data.value;
                            computeData.reads = data.reads;
                            computeData.root = rootObserve;
                            return data.value;
                        }
                    })
                };
                return computeData;
            },
            compute: function(key, options) {
                return this.computeData(key, options).compute;
            },
            read: function(attr, options) {
                var stopLookup;
                if (attr.substr(0, 2) === "./") {
                    stopLookup = true;
                    attr = attr.substr(2);
                } else if (attr.substr(0, 3) === "../") {
                    return this._parent.read(attr.substr(3), options);
                } else if (attr === "..") {
                    return {
                        value: this._parent._context
                    };
                } else if (attr === "." || attr === "this") {
                    return {
                        value: this._context
                    };
                }
                var names = attr.indexOf("\\.") === -1 ? attr.split(".") : getNames(attr), context, scope = this, defaultObserve, defaultReads = [], defaultPropertyDepth = -1, defaultComputeReadings, defaultScope, currentObserve, currentReads;
                while (scope) {
                    context = scope._context;
                    if (context !== null) {
                        var data = can.compute.read(context, names, can.simpleExtend({
                            foundObservable: function(observe, nameIndex) {
                                currentObserve = observe;
                                currentReads = names.slice(nameIndex);
                            },
                            earlyExit: function(parentValue, nameIndex) {
                                if (nameIndex > defaultPropertyDepth) {
                                    defaultObserve = currentObserve;
                                    defaultReads = currentReads;
                                    defaultPropertyDepth = nameIndex;
                                    defaultScope = scope;
                                    defaultComputeReadings = can.__clearReading();
                                }
                            },
                            executeAnonymousFunctions: true
                        }, options));
                        if (data.value !== undefined) {
                            return {
                                scope: scope,
                                rootObserve: currentObserve,
                                value: data.value,
                                reads: currentReads
                            };
                        }
                    }
                    can.__clearReading();
                    if (!stopLookup) {
                        scope = scope._parent;
                    } else {
                        scope = null;
                    }
                }
                if (defaultObserve) {
                    can.__setReading(defaultComputeReadings);
                    return {
                        scope: defaultScope,
                        rootObserve: defaultObserve,
                        reads: defaultReads,
                        value: undefined
                    };
                } else {
                    return {
                        names: names,
                        value: undefined
                    };
                }
            }
        });
        can.view.Scope = Scope;
        return Scope;
    }(__m2, __m12, __m15, __m19, __m10, __m20);
    var __m24 = function(can) {
        var selectsCommentNodes = function() {
            return can.$(document.createComment("~")).length === 1;
        }();
        var elements = {
            tagToContentPropMap: {
                option: "textContent" in document.createElement("option") ? "textContent" : "innerText",
                textarea: "value"
            },
            attrMap: can.attr.map,
            attrReg: /([^\s=]+)[\s]*=[\s]*/,
            defaultValue: can.attr.defaultValue,
            tagMap: {
                "": "span",
                colgroup: "col",
                table: "tbody",
                tr: "td",
                ol: "li",
                ul: "li",
                tbody: "tr",
                thead: "tr",
                tfoot: "tr",
                select: "option",
                optgroup: "option"
            },
            reverseTagMap: {
                col: "colgroup",
                tr: "tbody",
                option: "select",
                td: "tr",
                th: "tr",
                li: "ul"
            },
            getParentNode: function(el, defaultParentNode) {
                return defaultParentNode && el.parentNode.nodeType === 11 ? defaultParentNode : el.parentNode;
            },
            setAttr: can.attr.set,
            getAttr: can.attr.get,
            removeAttr: can.attr.remove,
            contentText: function(text) {
                if (typeof text === "string") {
                    return text;
                }
                if (!text && text !== 0) {
                    return "";
                }
                return "" + text;
            },
            after: function(oldElements, newFrag) {
                var last = oldElements[oldElements.length - 1];
                if (last.nextSibling) {
                    can.insertBefore(last.parentNode, newFrag, last.nextSibling);
                } else {
                    can.appendChild(last.parentNode, newFrag);
                }
            },
            replace: function(oldElements, newFrag) {
                elements.after(oldElements, newFrag);
                if (can.remove(can.$(oldElements)).length < oldElements.length && !selectsCommentNodes) {
                    can.each(oldElements, function(el) {
                        if (el.nodeType === 8) {
                            el.parentNode.removeChild(el);
                        }
                    });
                }
            }
        };
        can.view.elements = elements;
        return elements;
    }(__m2, __m10);
    var __m23 = function(can, elements, viewCallbacks) {
        var newLine = /(\r|\n)+/g, notEndTag = /\//, clean = function(content) {
            return content.split("\\").join("\\\\").split("\n").join("\\n").split('"').join('\\"').split("	").join("\\t");
        }, getTag = function(tagName, tokens, i) {
            if (tagName) {
                return tagName;
            } else {
                while (i < tokens.length) {
                    if (tokens[i] === "<" && !notEndTag.test(tokens[i + 1])) {
                        return elements.reverseTagMap[tokens[i + 1]] || "span";
                    }
                    i++;
                }
            }
            return "";
        }, bracketNum = function(content) {
            return --content.split("{").length - --content.split("}").length;
        }, myEval = function(script) {
            eval(script);
        }, attrReg = /([^\s]+)[\s]*=[\s]*$/, startTxt = "var ___v1ew = [];", finishTxt = "return ___v1ew.join('')", put_cmd = "___v1ew.push(\n", insert_cmd = put_cmd, htmlTag = null, quote = null, beforeQuote = null, rescan = null, getAttrName = function() {
            var matches = beforeQuote.match(attrReg);
            return matches && matches[1];
        }, status = function() {
            return quote ? "'" + getAttrName() + "'" : htmlTag ? 1 : 0;
        }, top = function(stack) {
            return stack[stack.length - 1];
        }, Scanner;
        can.view.Scanner = Scanner = function(options) {
            can.extend(this, {
                text: {},
                tokens: []
            }, options);
            this.text.options = this.text.options || "";
            this.tokenReg = [];
            this.tokenSimple = {
                "<": "<",
                ">": ">",
                '"': '"',
                "'": "'"
            };
            this.tokenComplex = [];
            this.tokenMap = {};
            for (var i = 0, token; token = this.tokens[i]; i++) {
                if (token[2]) {
                    this.tokenReg.push(token[2]);
                    this.tokenComplex.push({
                        abbr: token[1],
                        re: new RegExp(token[2]),
                        rescan: token[3]
                    });
                } else {
                    this.tokenReg.push(token[1]);
                    this.tokenSimple[token[1]] = token[0];
                }
                this.tokenMap[token[0]] = token[1];
            }
            this.tokenReg = new RegExp("(" + this.tokenReg.slice(0).concat([ "<", ">", '"', "'" ]).join("|") + ")", "g");
        };
        Scanner.prototype = {
            helpers: [],
            scan: function(source, name) {
                var tokens = [], last = 0, simple = this.tokenSimple, complex = this.tokenComplex;
                source = source.replace(newLine, "\n");
                if (this.transform) {
                    source = this.transform(source);
                }
                source.replace(this.tokenReg, function(whole, part) {
                    var offset = arguments[arguments.length - 2];
                    if (offset > last) {
                        tokens.push(source.substring(last, offset));
                    }
                    if (simple[whole]) {
                        tokens.push(whole);
                    } else {
                        for (var i = 0, token; token = complex[i]; i++) {
                            if (token.re.test(whole)) {
                                tokens.push(token.abbr);
                                if (token.rescan) {
                                    tokens.push(token.rescan(part));
                                }
                                break;
                            }
                        }
                    }
                    last = offset + part.length;
                });
                if (last < source.length) {
                    tokens.push(source.substr(last));
                }
                var content = "", buff = [ startTxt + (this.text.start || "") ], put = function(content, bonus) {
                    buff.push(put_cmd, '"', clean(content), '"' + (bonus || "") + ");");
                }, endStack = [], lastToken, startTag = null, magicInTag = false, specialStates = {
                    attributeHookups: [],
                    tagHookups: [],
                    lastTagHookup: ""
                }, popTagHookup = function() {
                    specialStates.lastTagHookup = specialStates.tagHookups.pop() + specialStates.tagHookups.length;
                }, tagName = "", tagNames = [], popTagName = false, bracketCount, specialAttribute = false, i = 0, token, tmap = this.tokenMap, attrName;
                htmlTag = quote = beforeQuote = null;
                for (;(token = tokens[i++]) !== undefined; ) {
                    if (startTag === null) {
                        switch (token) {
                          case tmap.left:
                          case tmap.escapeLeft:
                          case tmap.returnLeft:
                            magicInTag = htmlTag && 1;

                          case tmap.commentLeft:
                            startTag = token;
                            if (content.length) {
                                put(content);
                            }
                            content = "";
                            break;

                          case tmap.escapeFull:
                            magicInTag = htmlTag && 1;
                            rescan = 1;
                            startTag = tmap.escapeLeft;
                            if (content.length) {
                                put(content);
                            }
                            rescan = tokens[i++];
                            content = rescan.content || rescan;
                            if (rescan.before) {
                                put(rescan.before);
                            }
                            tokens.splice(i, 0, tmap.right);
                            break;

                          case tmap.commentFull:
                            break;

                          case tmap.templateLeft:
                            content += tmap.left;
                            break;

                          case "<":
                            if (tokens[i].indexOf("!--") !== 0) {
                                htmlTag = 1;
                                magicInTag = 0;
                            }
                            content += token;
                            break;

                          case ">":
                            htmlTag = 0;
                            var emptyElement = content.substr(content.length - 1) === "/" || content.substr(content.length - 2) === "--", attrs = "";
                            if (specialStates.attributeHookups.length) {
                                attrs = "attrs: ['" + specialStates.attributeHookups.join("','") + "'], ";
                                specialStates.attributeHookups = [];
                            }
                            if (tagName + specialStates.tagHookups.length !== specialStates.lastTagHookup && tagName === top(specialStates.tagHookups)) {
                                if (emptyElement) {
                                    content = content.substr(0, content.length - 1);
                                }
                                buff.push(put_cmd, '"', clean(content), '"', ",can.view.pending({tagName:'" + tagName + "'," + attrs + "scope: " + (this.text.scope || "this") + this.text.options);
                                if (emptyElement) {
                                    buff.push("}));");
                                    content = "/>";
                                    popTagHookup();
                                } else if (tokens[i] === "<" && tokens[i + 1] === "/" + tagName) {
                                    buff.push("}));");
                                    content = token;
                                    popTagHookup();
                                } else {
                                    buff.push(",subtemplate: function(" + this.text.argNames + "){\n" + startTxt + (this.text.start || ""));
                                    content = "";
                                }
                            } else if (magicInTag || !popTagName && elements.tagToContentPropMap[tagNames[tagNames.length - 1]] || attrs) {
                                var pendingPart = ",can.view.pending({" + attrs + "scope: " + (this.text.scope || "this") + this.text.options + '}),"';
                                if (emptyElement) {
                                    put(content.substr(0, content.length - 1), pendingPart + '/>"');
                                } else {
                                    put(content, pendingPart + '>"');
                                }
                                content = "";
                                magicInTag = 0;
                            } else {
                                content += token;
                            }
                            if (emptyElement || popTagName) {
                                tagNames.pop();
                                tagName = tagNames[tagNames.length - 1];
                                popTagName = false;
                            }
                            specialStates.attributeHookups = [];
                            break;

                          case "'":
                          case '"':
                            if (htmlTag) {
                                if (quote && quote === token) {
                                    quote = null;
                                    var attr = getAttrName();
                                    if (viewCallbacks.attr(attr)) {
                                        specialStates.attributeHookups.push(attr);
                                    }
                                    if (specialAttribute) {
                                        content += token;
                                        put(content);
                                        buff.push(finishTxt, "}));\n");
                                        content = "";
                                        specialAttribute = false;
                                        break;
                                    }
                                } else if (quote === null) {
                                    quote = token;
                                    beforeQuote = lastToken;
                                    attrName = getAttrName();
                                    if (tagName === "img" && attrName === "src" || attrName === "style") {
                                        put(content.replace(attrReg, ""));
                                        content = "";
                                        specialAttribute = true;
                                        buff.push(insert_cmd, "can.view.txt(2,'" + getTag(tagName, tokens, i) + "'," + status() + ",this,function(){", startTxt);
                                        put(attrName + "=" + token);
                                        break;
                                    }
                                }
                            }

                          default:
                            if (lastToken === "<") {
                                tagName = token.substr(0, 3) === "!--" ? "!--" : token.split(/\s/)[0];
                                var isClosingTag = false, cleanedTagName;
                                if (tagName.indexOf("/") === 0) {
                                    isClosingTag = true;
                                    cleanedTagName = tagName.substr(1);
                                }
                                if (isClosingTag) {
                                    if (top(tagNames) === cleanedTagName) {
                                        tagName = cleanedTagName;
                                        popTagName = true;
                                    }
                                    if (top(specialStates.tagHookups) === cleanedTagName) {
                                        put(content.substr(0, content.length - 1));
                                        buff.push(finishTxt + "}}) );");
                                        content = "><";
                                        popTagHookup();
                                    }
                                } else {
                                    if (tagName.lastIndexOf("/") === tagName.length - 1) {
                                        tagName = tagName.substr(0, tagName.length - 1);
                                    }
                                    if (tagName !== "!--" && viewCallbacks.tag(tagName)) {
                                        if (tagName === "content" && elements.tagMap[top(tagNames)]) {
                                            token = token.replace("content", elements.tagMap[top(tagNames)]);
                                        }
                                        specialStates.tagHookups.push(tagName);
                                    }
                                    tagNames.push(tagName);
                                }
                            }
                            content += token;
                            break;
                        }
                    } else {
                        switch (token) {
                          case tmap.right:
                          case tmap.returnRight:
                            switch (startTag) {
                              case tmap.left:
                                bracketCount = bracketNum(content);
                                if (bracketCount === 1) {
                                    buff.push(insert_cmd, "can.view.txt(0,'" + getTag(tagName, tokens, i) + "'," + status() + ",this,function(){", startTxt, content);
                                    endStack.push({
                                        before: "",
                                        after: finishTxt + "}));\n"
                                    });
                                } else {
                                    last = endStack.length && bracketCount === -1 ? endStack.pop() : {
                                        after: ";"
                                    };
                                    if (last.before) {
                                        buff.push(last.before);
                                    }
                                    buff.push(content, ";", last.after);
                                }
                                break;

                              case tmap.escapeLeft:
                              case tmap.returnLeft:
                                bracketCount = bracketNum(content);
                                if (bracketCount) {
                                    endStack.push({
                                        before: finishTxt,
                                        after: "}));\n"
                                    });
                                }
                                var escaped = startTag === tmap.escapeLeft ? 1 : 0, commands = {
                                    insert: insert_cmd,
                                    tagName: getTag(tagName, tokens, i),
                                    status: status(),
                                    specialAttribute: specialAttribute
                                };
                                for (var ii = 0; ii < this.helpers.length; ii++) {
                                    var helper = this.helpers[ii];
                                    if (helper.name.test(content)) {
                                        content = helper.fn(content, commands);
                                        if (helper.name.source === /^>[\s]*\w*/.source) {
                                            escaped = 0;
                                        }
                                        break;
                                    }
                                }
                                if (typeof content === "object") {
                                    if (content.startTxt && content.end && specialAttribute) {
                                        buff.push(insert_cmd, "can.view.toStr( ", content.content, "() ) );");
                                    } else {
                                        if (content.startTxt) {
                                            buff.push(insert_cmd, "can.view.txt(\n" + (typeof status() === "string" || (content.escaped != null ? content.escaped : escaped)) + ",\n'" + tagName + "',\n" + status() + ",\nthis,\n");
                                        } else if (content.startOnlyTxt) {
                                            buff.push(insert_cmd, "can.view.onlytxt(this,\n");
                                        }
                                        buff.push(content.content);
                                        if (content.end) {
                                            buff.push("));");
                                        }
                                    }
                                } else if (specialAttribute) {
                                    buff.push(insert_cmd, content, ");");
                                } else {
                                    buff.push(insert_cmd, "can.view.txt(\n" + (typeof status() === "string" || escaped) + ",\n'" + tagName + "',\n" + status() + ",\nthis,\nfunction(){ " + (this.text.escape || "") + "return ", content, bracketCount ? startTxt : "}));\n");
                                }
                                if (rescan && rescan.after && rescan.after.length) {
                                    put(rescan.after.length);
                                    rescan = null;
                                }
                                break;
                            }
                            startTag = null;
                            content = "";
                            break;

                          case tmap.templateLeft:
                            content += tmap.left;
                            break;

                          default:
                            content += token;
                            break;
                        }
                    }
                    lastToken = token;
                }
                if (content.length) {
                    put(content);
                }
                buff.push(";");
                var template = buff.join(""), out = {
                    out: (this.text.outStart || "") + template + " " + finishTxt + (this.text.outEnd || "")
                };
                myEval.call(out, "this.fn = (function(" + this.text.argNames + "){" + out.out + "});\r\n//# sourceURL=" + name + ".js");
                return out;
            }
        };
        can.view.pending = function(viewData) {
            var hooks = can.view.getHooks();
            return can.view.hook(function(el) {
                can.each(hooks, function(fn) {
                    fn(el);
                });
                viewData.templateType = "legacy";
                if (viewData.tagName) {
                    viewCallbacks.tagHandler(el, viewData.tagName, viewData);
                }
                can.each(viewData && viewData.attrs || [], function(attributeName) {
                    viewData.attributeName = attributeName;
                    var callback = viewCallbacks.attr(attributeName);
                    if (callback) {
                        callback(el, viewData);
                    }
                });
            });
        };
        can.view.tag("content", function(el, tagData) {
            return tagData.scope;
        });
        can.view.Scanner = Scanner;
        return Scanner;
    }(__m10, __m24, __m9);
    var __m27 = function(can) {
        var canExpando = true;
        try {
            document.createTextNode("")._ = 0;
        } catch (ex) {
            canExpando = false;
        }
        var nodeMap = {}, textNodeMap = {}, expando = "ejs_" + Math.random(), _id = 0, id = function(node, localMap) {
            var _textNodeMap = localMap || textNodeMap;
            var id = readId(node, _textNodeMap);
            if (id) {
                return id;
            } else {
                if (canExpando || node.nodeType !== 3) {
                    ++_id;
                    return node[expando] = (node.nodeName ? "element_" : "obj_") + _id;
                } else {
                    ++_id;
                    _textNodeMap["text_" + _id] = node;
                    return "text_" + _id;
                }
            }
        }, readId = function(node, textNodeMap) {
            if (canExpando || node.nodeType !== 3) {
                return node[expando];
            } else {
                for (var textNodeID in textNodeMap) {
                    if (textNodeMap[textNodeID] === node) {
                        return textNodeID;
                    }
                }
            }
        }, splice = [].splice, push = [].push, itemsInChildListTree = function(list) {
            var count = 0;
            for (var i = 0, len = list.length; i < len; i++) {
                var item = list[i];
                if (item.nodeType) {
                    count++;
                } else {
                    count += itemsInChildListTree(item);
                }
            }
            return count;
        }, replacementMap = function(replacements, idMap) {
            var map = {};
            for (var i = 0, len = replacements.length; i < len; i++) {
                var node = nodeLists.first(replacements[i]);
                map[id(node, idMap)] = replacements[i];
            }
            return map;
        };
        var nodeLists = {
            id: id,
            update: function(nodeList, newNodes) {
                var oldNodes = nodeLists.unregisterChildren(nodeList);
                newNodes = can.makeArray(newNodes);
                var oldListLength = nodeList.length;
                splice.apply(nodeList, [ 0, oldListLength ].concat(newNodes));
                if (nodeList.replacements) {
                    nodeLists.nestReplacements(nodeList);
                } else {
                    nodeLists.nestList(nodeList);
                }
                return oldNodes;
            },
            nestReplacements: function(list) {
                var index = 0, idMap = {}, rMap = replacementMap(list.replacements, idMap), rCount = list.replacements.length;
                while (index < list.length && rCount) {
                    var node = list[index], replacement = rMap[readId(node, idMap)];
                    if (replacement) {
                        list.splice(index, itemsInChildListTree(replacement), replacement);
                        rCount--;
                    }
                    index++;
                }
                list.replacements = [];
            },
            nestList: function(list) {
                var index = 0;
                while (index < list.length) {
                    var node = list[index], childNodeList = nodeMap[id(node)];
                    if (childNodeList) {
                        if (childNodeList !== list) {
                            list.splice(index, itemsInChildListTree(childNodeList), childNodeList);
                        }
                    } else {
                        nodeMap[id(node)] = list;
                    }
                    index++;
                }
            },
            last: function(nodeList) {
                var last = nodeList[nodeList.length - 1];
                if (last.nodeType) {
                    return last;
                } else {
                    return nodeLists.last(last);
                }
            },
            first: function(nodeList) {
                var first = nodeList[0];
                if (first.nodeType) {
                    return first;
                } else {
                    return nodeLists.first(first);
                }
            },
            register: function(nodeList, unregistered, parent) {
                nodeList.unregistered = unregistered;
                nodeList.parentList = parent;
                if (parent === true) {
                    nodeList.replacements = [];
                } else if (parent) {
                    parent.replacements.push(nodeList);
                    nodeList.replacements = [];
                } else {
                    nodeLists.nestList(nodeList);
                }
                return nodeList;
            },
            unregisterChildren: function(nodeList) {
                var nodes = [];
                can.each(nodeList, function(node) {
                    if (node.nodeType) {
                        if (!nodeList.replacements) {
                            delete nodeMap[id(node)];
                        }
                        nodes.push(node);
                    } else {
                        push.apply(nodes, nodeLists.unregister(node));
                    }
                });
                return nodes;
            },
            unregister: function(nodeList) {
                var nodes = nodeLists.unregisterChildren(nodeList);
                if (nodeList.unregistered) {
                    var unregisteredCallback = nodeList.unregistered;
                    delete nodeList.unregistered;
                    delete nodeList.replacements;
                    unregisteredCallback();
                }
                return nodes;
            },
            nodeMap: nodeMap
        };
        can.view.nodeLists = nodeLists;
        return nodeLists;
    }(__m2, __m24);
    var __m28 = function(can) {
        function makeMap(str) {
            var obj = {}, items = str.split(",");
            for (var i = 0; i < items.length; i++) {
                obj[items[i]] = true;
            }
            return obj;
        }
        var alphaNumericHU = "-:A-Za-z0-9_", attributeNames = "[a-zA-Z_:][" + alphaNumericHU + ":.]*", spaceEQspace = "\\s*=\\s*", dblQuote2dblQuote = '"((?:\\\\.|[^"])*)"', quote2quote = "'((?:\\\\.|[^'])*)'", attributeEqAndValue = "(?:" + spaceEQspace + "(?:" + "(?:\"[^\"]*\")|(?:'[^']*')|[^>\\s]+))?", matchStash = "\\{\\{[^\\}]*\\}\\}\\}?", stash = "\\{\\{([^\\}]*)\\}\\}\\}?", startTag = new RegExp("^<([" + alphaNumericHU + "]+)" + "(" + "(?:\\s*" + "(?:(?:" + "(?:" + attributeNames + ")?" + attributeEqAndValue + ")|" + "(?:" + matchStash + ")+)" + ")*" + ")\\s*(\\/?)>"), endTag = new RegExp("^<\\/([" + alphaNumericHU + "]+)[^>]*>"), attr = new RegExp("(?:" + "(?:(" + attributeNames + ")|" + stash + ")" + "(?:" + spaceEQspace + "(?:" + "(?:" + dblQuote2dblQuote + ")|(?:" + quote2quote + ")|([^>\\s]+)" + ")" + ")?)", "g"), mustache = new RegExp(stash, "g"), txtBreak = /<|\{\{/;
        var empty = makeMap("area,base,basefont,br,col,frame,hr,img,input,isindex,link,meta,param,embed");
        var block = makeMap("a,address,article,applet,aside,audio,blockquote,button,canvas,center,dd,del,dir,div,dl,dt,fieldset,figcaption,figure,footer,form,frameset,h1,h2,h3,h4,h5,h6,header,hgroup,hr,iframe,ins,isindex,li,map,menu,noframes,noscript,object,ol,output,p,pre,section,script,table,tbody,td,tfoot,th,thead,tr,ul,video");
        var inline = makeMap("abbr,acronym,applet,b,basefont,bdo,big,br,button,cite,code,del,dfn,em,font,i,iframe,img,input,ins,kbd,label,map,object,q,s,samp,script,select,small,span,strike,strong,sub,sup,textarea,tt,u,var");
        var closeSelf = makeMap("colgroup,dd,dt,li,options,p,td,tfoot,th,thead,tr");
        var fillAttrs = makeMap("checked,compact,declare,defer,disabled,ismap,multiple,nohref,noresize,noshade,nowrap,readonly,selected");
        var special = makeMap("script,style");
        var HTMLParser = function(html, handler) {
            function parseStartTag(tag, tagName, rest, unary) {
                tagName = tagName.toLowerCase();
                if (block[tagName]) {
                    while (stack.last() && inline[stack.last()]) {
                        parseEndTag("", stack.last());
                    }
                }
                if (closeSelf[tagName] && stack.last() === tagName) {
                    parseEndTag("", tagName);
                }
                unary = empty[tagName] || !!unary;
                handler.start(tagName, unary);
                if (!unary) {
                    stack.push(tagName);
                }
                HTMLParser.parseAttrs(rest, handler);
                handler.end(tagName, unary);
            }
            function parseEndTag(tag, tagName) {
                var pos;
                if (!tagName) {
                    pos = 0;
                } else {
                    for (pos = stack.length - 1; pos >= 0; pos--) {
                        if (stack[pos] === tagName) {
                            break;
                        }
                    }
                }
                if (pos >= 0) {
                    for (var i = stack.length - 1; i >= pos; i--) {
                        if (handler.close) {
                            handler.close(stack[i]);
                        }
                    }
                    stack.length = pos;
                }
            }
            function parseMustache(mustache, inside) {
                if (handler.special) {
                    handler.special(inside);
                }
            }
            var index, chars, match, stack = [], last = html;
            stack.last = function() {
                return this[this.length - 1];
            };
            while (html) {
                chars = true;
                if (!stack.last() || !special[stack.last()]) {
                    if (html.indexOf("<!--") === 0) {
                        index = html.indexOf("-->");
                        if (index >= 0) {
                            if (handler.comment) {
                                handler.comment(html.substring(4, index));
                            }
                            html = html.substring(index + 3);
                            chars = false;
                        }
                    } else if (html.indexOf("</") === 0) {
                        match = html.match(endTag);
                        if (match) {
                            html = html.substring(match[0].length);
                            match[0].replace(endTag, parseEndTag);
                            chars = false;
                        }
                    } else if (html.indexOf("<") === 0) {
                        match = html.match(startTag);
                        if (match) {
                            html = html.substring(match[0].length);
                            match[0].replace(startTag, parseStartTag);
                            chars = false;
                        }
                    } else if (html.indexOf("{{") === 0) {
                        match = html.match(mustache);
                        if (match) {
                            html = html.substring(match[0].length);
                            match[0].replace(mustache, parseMustache);
                        }
                    }
                    if (chars) {
                        index = html.search(txtBreak);
                        var text = index < 0 ? html : html.substring(0, index);
                        html = index < 0 ? "" : html.substring(index);
                        if (handler.chars && text) {
                            handler.chars(text);
                        }
                    }
                } else {
                    html = html.replace(new RegExp("([\\s\\S]*?)</" + stack.last() + "[^>]*>"), function(all, text) {
                        text = text.replace(/<!--([\s\S]*?)-->|<!\[CDATA\[([\s\S]*?)]]>/g, "$1$2");
                        if (handler.chars) {
                            handler.chars(text);
                        }
                        return "";
                    });
                    parseEndTag("", stack.last());
                }
                if (html === last) {
                    throw "Parse Error: " + html;
                }
                last = html;
            }
            parseEndTag();
            handler.done();
        };
        HTMLParser.parseAttrs = function(rest, handler) {
            (rest != null ? rest : "").replace(attr, function(text, name, special, dblQuote, singleQuote, val) {
                if (special) {
                    handler.special(special);
                }
                if (name || dblQuote || singleQuote || val) {
                    var value = arguments[3] ? arguments[3] : arguments[4] ? arguments[4] : arguments[5] ? arguments[5] : fillAttrs[name.toLowerCase()] ? name : "";
                    handler.attrStart(name || "");
                    var last = mustache.lastIndex = 0, res = mustache.exec(value), chars;
                    while (res) {
                        chars = value.substring(last, mustache.lastIndex - res[0].length);
                        if (chars.length) {
                            handler.attrValue(chars);
                        }
                        handler.special(res[1]);
                        last = mustache.lastIndex;
                        res = mustache.exec(value);
                    }
                    chars = value.substr(last, value.length);
                    if (chars) {
                        handler.attrValue(chars);
                    }
                    handler.attrEnd(name || "");
                }
            });
        };
        can.view.parser = HTMLParser;
        return HTMLParser;
    }(__m10);
    var __m26 = function(can, elements, view, nodeLists, parser) {
        elements = elements || can.view.elements;
        nodeLists = nodeLists || can.view.NodeLists;
        parser = parser || can.view.parser;
        var setup = function(el, bind, unbind) {
            var tornDown = false, teardown = function() {
                if (!tornDown) {
                    tornDown = true;
                    unbind(data);
                    can.unbind.call(el, "removed", teardown);
                }
                return true;
            }, data = {
                teardownCheck: function(parent) {
                    return parent ? false : teardown();
                }
            };
            can.bind.call(el, "removed", teardown);
            bind(data);
            return data;
        }, listen = function(el, compute, change) {
            return setup(el, function() {
                compute.bind("change", change);
            }, function(data) {
                compute.unbind("change", change);
                if (data.nodeList) {
                    nodeLists.unregister(data.nodeList);
                }
            });
        }, getAttributeParts = function(newVal) {
            var attrs = {}, attr;
            parser.parseAttrs(newVal, {
                attrStart: function(name) {
                    attrs[name] = "";
                    attr = name;
                },
                attrValue: function(value) {
                    attrs[attr] += value;
                },
                attrEnd: function() {}
            });
            return attrs;
        }, splice = [].splice, isNode = function(obj) {
            return obj && obj.nodeType;
        }, addTextNodeIfNoChildren = function(frag) {
            if (!frag.childNodes.length) {
                frag.appendChild(document.createTextNode(""));
            }
        };
        var live = {
            list: function(el, compute, render, context, parentNode, nodeList) {
                var masterNodeList = nodeList || [ el ], indexMap = [], add = function(ev, items, index) {
                    var frag = document.createDocumentFragment(), newNodeLists = [], newIndicies = [];
                    can.each(items, function(item, key) {
                        var itemNodeList = [];
                        if (nodeList) {
                            nodeLists.register(itemNodeList, null, true);
                        }
                        var itemIndex = can.compute(key + index), itemHTML = render.call(context, item, itemIndex, itemNodeList), gotText = typeof itemHTML === "string", itemFrag = can.frag(itemHTML);
                        itemFrag = gotText ? can.view.hookup(itemFrag) : itemFrag;
                        var childNodes = can.makeArray(itemFrag.childNodes);
                        if (nodeList) {
                            nodeLists.update(itemNodeList, childNodes);
                            newNodeLists.push(itemNodeList);
                        } else {
                            newNodeLists.push(nodeLists.register(childNodes));
                        }
                        frag.appendChild(itemFrag);
                        newIndicies.push(itemIndex);
                    });
                    var masterListIndex = index + 1;
                    if (!masterNodeList[masterListIndex]) {
                        elements.after(masterListIndex === 1 ? [ text ] : [ nodeLists.last(masterNodeList[masterListIndex - 1]) ], frag);
                    } else {
                        var el = nodeLists.first(masterNodeList[masterListIndex]);
                        can.insertBefore(el.parentNode, frag, el);
                    }
                    splice.apply(masterNodeList, [ masterListIndex, 0 ].concat(newNodeLists));
                    splice.apply(indexMap, [ index, 0 ].concat(newIndicies));
                    for (var i = index + newIndicies.length, len = indexMap.length; i < len; i++) {
                        indexMap[i](i);
                    }
                }, remove = function(ev, items, index, duringTeardown, fullTeardown) {
                    if (!duringTeardown && data.teardownCheck(text.parentNode)) {
                        return;
                    }
                    if (index < 0) {
                        index = indexMap.length + index;
                    }
                    var removedMappings = masterNodeList.splice(index + 1, items.length), itemsToRemove = [];
                    can.each(removedMappings, function(nodeList) {
                        var nodesToRemove = nodeLists.unregister(nodeList);
                        [].push.apply(itemsToRemove, nodesToRemove);
                    });
                    indexMap.splice(index, items.length);
                    for (var i = index, len = indexMap.length; i < len; i++) {
                        indexMap[i](i);
                    }
                    if (!fullTeardown) {
                        can.remove(can.$(itemsToRemove));
                    }
                }, text = document.createTextNode(""), list, teardownList = function(fullTeardown) {
                    if (list && list.unbind) {
                        list.unbind("add", add).unbind("remove", remove);
                    }
                    remove({}, {
                        length: masterNodeList.length - 1
                    }, 0, true, fullTeardown);
                }, updateList = function(ev, newList, oldList) {
                    teardownList();
                    list = newList || [];
                    if (list.bind) {
                        list.bind("add", add).bind("remove", remove);
                    }
                    add({}, list, 0);
                };
                parentNode = elements.getParentNode(el, parentNode);
                var data = setup(parentNode, function() {
                    if (can.isFunction(compute)) {
                        compute.bind("change", updateList);
                    }
                }, function() {
                    if (can.isFunction(compute)) {
                        compute.unbind("change", updateList);
                    }
                    teardownList(true);
                });
                if (!nodeList) {
                    live.replace(masterNodeList, text, data.teardownCheck);
                } else {
                    elements.replace(masterNodeList, text);
                    nodeLists.update(masterNodeList, [ text ]);
                    nodeList.unregistered = data.teardownCheck;
                }
                updateList({}, can.isFunction(compute) ? compute() : compute);
            },
            html: function(el, compute, parentNode, nodeList) {
                var data;
                parentNode = elements.getParentNode(el, parentNode);
                data = listen(parentNode, compute, function(ev, newVal, oldVal) {
                    var attached = nodeLists.first(nodes).parentNode;
                    if (attached) {
                        makeAndPut(newVal);
                    }
                    data.teardownCheck(nodeLists.first(nodes).parentNode);
                });
                var nodes = nodeList || [ el ], makeAndPut = function(val) {
                    var isString = !isNode(val), frag = can.frag(val), oldNodes = can.makeArray(nodes);
                    addTextNodeIfNoChildren(frag);
                    if (isString) {
                        frag = can.view.hookup(frag, parentNode);
                    }
                    oldNodes = nodeLists.update(nodes, frag.childNodes);
                    elements.replace(oldNodes, frag);
                };
                data.nodeList = nodes;
                if (!nodeList) {
                    nodeLists.register(nodes, data.teardownCheck);
                } else {
                    nodeList.unregistered = data.teardownCheck;
                }
                makeAndPut(compute());
            },
            replace: function(nodes, val, teardown) {
                var oldNodes = nodes.slice(0), frag = can.frag(val);
                nodeLists.register(nodes, teardown);
                if (typeof val === "string") {
                    frag = can.view.hookup(frag, nodes[0].parentNode);
                }
                nodeLists.update(nodes, frag.childNodes);
                elements.replace(oldNodes, frag);
                return nodes;
            },
            text: function(el, compute, parentNode, nodeList) {
                var parent = elements.getParentNode(el, parentNode);
                var data = listen(parent, compute, function(ev, newVal, oldVal) {
                    if (typeof node.nodeValue !== "unknown") {
                        node.nodeValue = can.view.toStr(newVal);
                    }
                    data.teardownCheck(node.parentNode);
                });
                var node = document.createTextNode(can.view.toStr(compute()));
                if (nodeList) {
                    nodeList.unregistered = data.teardownCheck;
                    data.nodeList = nodeList;
                    nodeLists.update(nodeList, [ node ]);
                    elements.replace([ el ], node);
                } else {
                    data.nodeList = live.replace([ el ], node, data.teardownCheck);
                }
            },
            setAttributes: function(el, newVal) {
                var attrs = getAttributeParts(newVal);
                for (var name in attrs) {
                    can.attr.set(el, name, attrs[name]);
                }
            },
            attributes: function(el, compute, currentValue) {
                var oldAttrs = {};
                var setAttrs = function(newVal) {
                    var newAttrs = getAttributeParts(newVal), name;
                    for (name in newAttrs) {
                        var newValue = newAttrs[name], oldValue = oldAttrs[name];
                        if (newValue !== oldValue) {
                            can.attr.set(el, name, newValue);
                        }
                        delete oldAttrs[name];
                    }
                    for (name in oldAttrs) {
                        elements.removeAttr(el, name);
                    }
                    oldAttrs = newAttrs;
                };
                listen(el, compute, function(ev, newVal) {
                    setAttrs(newVal);
                });
                if (arguments.length >= 3) {
                    oldAttrs = getAttributeParts(currentValue);
                } else {
                    setAttrs(compute());
                }
            },
            attributePlaceholder: "__!!__",
            attributeReplace: /__!!__/g,
            attribute: function(el, attributeName, compute) {
                listen(el, compute, function(ev, newVal) {
                    elements.setAttr(el, attributeName, hook.render());
                });
                var wrapped = can.$(el), hooks;
                hooks = can.data(wrapped, "hooks");
                if (!hooks) {
                    can.data(wrapped, "hooks", hooks = {});
                }
                var attr = elements.getAttr(el, attributeName), parts = attr.split(live.attributePlaceholder), goodParts = [], hook;
                goodParts.push(parts.shift(), parts.join(live.attributePlaceholder));
                if (hooks[attributeName]) {
                    hooks[attributeName].computes.push(compute);
                } else {
                    hooks[attributeName] = {
                        render: function() {
                            var i = 0, newAttr = attr ? attr.replace(live.attributeReplace, function() {
                                return elements.contentText(hook.computes[i++]());
                            }) : elements.contentText(hook.computes[i++]());
                            return newAttr;
                        },
                        computes: [ compute ],
                        batchNum: undefined
                    };
                }
                hook = hooks[attributeName];
                goodParts.splice(1, 0, compute());
                elements.setAttr(el, attributeName, goodParts.join(""));
            },
            specialAttribute: function(el, attributeName, compute) {
                listen(el, compute, function(ev, newVal) {
                    elements.setAttr(el, attributeName, getValue(newVal));
                });
                elements.setAttr(el, attributeName, getValue(compute()));
            },
            simpleAttribute: function(el, attributeName, compute) {
                listen(el, compute, function(ev, newVal) {
                    elements.setAttr(el, attributeName, newVal);
                });
                elements.setAttr(el, attributeName, compute());
            }
        };
        live.attr = live.simpleAttribute;
        live.attrs = live.attributes;
        var newLine = /(\r|\n)+/g;
        var getValue = function(val) {
            var regexp = /^["'].*["']$/;
            val = val.replace(elements.attrReg, "").replace(newLine, "");
            return regexp.test(val) ? val.substr(1, val.length - 2) : val;
        };
        can.view.live = live;
        return live;
    }(__m2, __m24, __m10, __m27, __m28);
    var __m25 = function(can, elements, live) {
        var pendingHookups = [], tagChildren = function(tagName) {
            var newTag = elements.tagMap[tagName] || "span";
            if (newTag === "span") {
                return "@@!!@@";
            }
            return "<" + newTag + ">" + tagChildren(newTag) + "</" + newTag + ">";
        }, contentText = function(input, tag) {
            if (typeof input === "string") {
                return input;
            }
            if (!input && input !== 0) {
                return "";
            }
            var hook = input.hookup && function(el, id) {
                input.hookup.call(input, el, id);
            } || typeof input === "function" && input;
            if (hook) {
                if (tag) {
                    return "<" + tag + " " + can.view.hook(hook) + "></" + tag + ">";
                } else {
                    pendingHookups.push(hook);
                }
                return "";
            }
            return "" + input;
        }, contentEscape = function(txt, tag) {
            return typeof txt === "string" || typeof txt === "number" ? can.esc(txt) : contentText(txt, tag);
        }, withinTemplatedSectionWithinAnElement = false, emptyHandler = function() {};
        var lastHookups;
        can.extend(can.view, {
            live: live,
            setupLists: function() {
                var old = can.view.lists, data;
                can.view.lists = function(list, renderer) {
                    data = {
                        list: list,
                        renderer: renderer
                    };
                    return Math.random();
                };
                return function() {
                    can.view.lists = old;
                    return data;
                };
            },
            getHooks: function() {
                var hooks = pendingHookups.slice(0);
                lastHookups = hooks;
                pendingHookups = [];
                return hooks;
            },
            onlytxt: function(self, func) {
                return contentEscape(func.call(self));
            },
            txt: function(escape, tagName, status, self, func) {
                var tag = elements.tagMap[tagName] || "span", setupLiveBinding = false, value, listData, compute, unbind = emptyHandler, attributeName;
                if (withinTemplatedSectionWithinAnElement) {
                    value = func.call(self);
                } else {
                    if (typeof status === "string" || status === 1) {
                        withinTemplatedSectionWithinAnElement = true;
                    }
                    var listTeardown = can.view.setupLists();
                    unbind = function() {
                        compute.unbind("change", emptyHandler);
                    };
                    compute = can.compute(func, self, false);
                    compute.bind("change", emptyHandler);
                    listData = listTeardown();
                    value = compute();
                    withinTemplatedSectionWithinAnElement = false;
                    setupLiveBinding = compute.hasDependencies;
                }
                if (listData) {
                    unbind();
                    return "<" + tag + can.view.hook(function(el, parentNode) {
                        live.list(el, listData.list, listData.renderer, self, parentNode);
                    }) + "></" + tag + ">";
                }
                if (!setupLiveBinding || typeof value === "function") {
                    unbind();
                    return (withinTemplatedSectionWithinAnElement || escape === 2 || !escape ? contentText : contentEscape)(value, status === 0 && tag);
                }
                var contentProp = elements.tagToContentPropMap[tagName];
                if (status === 0 && !contentProp) {
                    return "<" + tag + can.view.hook(escape && typeof value !== "object" ? function(el, parentNode) {
                        live.text(el, compute, parentNode);
                        unbind();
                    } : function(el, parentNode) {
                        live.html(el, compute, parentNode);
                        unbind();
                    }) + ">" + tagChildren(tag) + "</" + tag + ">";
                } else if (status === 1) {
                    pendingHookups.push(function(el) {
                        live.attributes(el, compute, compute());
                        unbind();
                    });
                    return compute();
                } else if (escape === 2) {
                    attributeName = status;
                    pendingHookups.push(function(el) {
                        live.specialAttribute(el, attributeName, compute);
                        unbind();
                    });
                    return compute();
                } else {
                    attributeName = status === 0 ? contentProp : status;
                    (status === 0 ? lastHookups : pendingHookups).push(function(el) {
                        live.attribute(el, attributeName, compute);
                        unbind();
                    });
                    return live.attributePlaceholder;
                }
            }
        });
        return can;
    }(__m10, __m24, __m26, __m13);
    var __m21 = function(can) {
        can.view.ext = ".mustache";
        var SCOPE = "scope", HASH = "___h4sh", CONTEXT_OBJ = "{scope:" + SCOPE + ",options:options}", SPECIAL_CONTEXT_OBJ = "{scope:" + SCOPE + ",options:options, special: true}", ARG_NAMES = SCOPE + ",options", argumentsRegExp = /((([^'"\s]+?=)?('.*?'|".*?"))|.*?)\s/g, literalNumberStringBooleanRegExp = /^(('.*?'|".*?"|[0-9]+\.?[0-9]*|true|false|null|undefined)|((.+?)=(('.*?'|".*?"|[0-9]+\.?[0-9]*|true|false)|(.+))))$/, makeLookupLiteral = function(type) {
            return '{get:"' + type.replace(/"/g, '\\"') + '"}';
        }, isLookup = function(obj) {
            return obj && typeof obj.get === "string";
        }, isObserveLike = function(obj) {
            return obj instanceof can.Map || obj && !!obj._get;
        }, isArrayLike = function(obj) {
            return obj && obj.splice && typeof obj.length === "number";
        }, makeConvertToScopes = function(original, scope, options) {
            var originalWithScope = function(ctx, opts) {
                return original(ctx || scope, opts);
            };
            return function(updatedScope, updatedOptions) {
                if (updatedScope !== undefined && !(updatedScope instanceof can.view.Scope)) {
                    updatedScope = scope.add(updatedScope);
                }
                if (updatedOptions !== undefined && !(updatedOptions instanceof can.view.Options)) {
                    updatedOptions = options.add(updatedOptions);
                }
                return originalWithScope(updatedScope, updatedOptions || options);
            };
        };
        var Mustache = function(options, helpers) {
            if (this.constructor !== Mustache) {
                var mustache = new Mustache(options);
                return function(data, options) {
                    return mustache.render(data, options);
                };
            }
            if (typeof options === "function") {
                this.template = {
                    fn: options
                };
                return;
            }
            can.extend(this, options);
            this.template = this.scanner.scan(this.text, this.name);
        };
        can.Mustache = window.Mustache = Mustache;
        Mustache.prototype.render = function(data, options) {
            if (!(data instanceof can.view.Scope)) {
                data = new can.view.Scope(data || {});
            }
            if (!(options instanceof can.view.Options)) {
                options = new can.view.Options(options || {});
            }
            options = options || {};
            return this.template.fn.call(data, data, options);
        };
        can.extend(Mustache.prototype, {
            scanner: new can.view.Scanner({
                text: {
                    start: "",
                    scope: SCOPE,
                    options: ",options: options",
                    argNames: ARG_NAMES
                },
                tokens: [ [ "returnLeft", "{{{", "{{[{&]" ], [ "commentFull", "{{!}}", "^[\\s\\t]*{{!.+?}}\\n" ], [ "commentLeft", "{{!", "(\\n[\\s\\t]*{{!|{{!)" ], [ "escapeFull", "{{}}", "(^[\\s\\t]*{{[#/^][^}]+?}}\\n|\\n[\\s\\t]*{{[#/^][^}]+?}}\\n|\\n[\\s\\t]*{{[#/^][^}]+?}}$)", function(content) {
                    return {
                        before: /^\n.+?\n$/.test(content) ? "\n" : "",
                        content: content.match(/\{\{(.+?)\}\}/)[1] || ""
                    };
                } ], [ "escapeLeft", "{{" ], [ "returnRight", "}}}" ], [ "right", "}}" ] ],
                helpers: [ {
                    name: /^>[\s]*\w*/,
                    fn: function(content, cmd) {
                        var templateName = can.trim(content.replace(/^>\s?/, "")).replace(/["|']/g, "");
                        return "can.Mustache.renderPartial('" + templateName + "'," + ARG_NAMES + ")";
                    }
                }, {
                    name: /^\s*data\s/,
                    fn: function(content, cmd) {
                        var attr = content.match(/["|'](.*)["|']/)[1];
                        return "can.proxy(function(__){" + "can.data(can.$(__),'" + attr + "', this.attr('.')); }, " + SCOPE + ")";
                    }
                }, {
                    name: /\s*\(([\$\w]+)\)\s*->([^\n]*)/,
                    fn: function(content) {
                        var quickFunc = /\s*\(([\$\w]+)\)\s*->([^\n]*)/, parts = content.match(quickFunc);
                        return "can.proxy(function(__){var " + parts[1] + "=can.$(__);with(" + SCOPE + ".attr('.')){" + parts[2] + "}}, this);";
                    }
                }, {
                    name: /^.*$/,
                    fn: function(content, cmd) {
                        var mode = false, result = {
                            content: "",
                            startTxt: false,
                            startOnlyTxt: false,
                            end: false
                        };
                        content = can.trim(content);
                        if (content.length && (mode = content.match(/^([#^/]|else$)/))) {
                            mode = mode[0];
                            switch (mode) {
                              case "#":
                              case "^":
                                if (cmd.specialAttribute) {
                                    result.startOnlyTxt = true;
                                } else {
                                    result.startTxt = true;
                                    result.escaped = 0;
                                }
                                break;

                              case "/":
                                result.end = true;
                                result.content += 'return ___v1ew.join("");}}])';
                                return result;
                            }
                            content = content.substring(1);
                        }
                        if (mode !== "else") {
                            var args = [], hashes = [], i = 0, m;
                            result.content += "can.Mustache.txt(\n" + (cmd.specialAttribute ? SPECIAL_CONTEXT_OBJ : CONTEXT_OBJ) + ",\n" + (mode ? '"' + mode + '"' : "null") + ",";
                            (can.trim(content) + " ").replace(argumentsRegExp, function(whole, arg) {
                                if (i && (m = arg.match(literalNumberStringBooleanRegExp))) {
                                    if (m[2]) {
                                        args.push(m[0]);
                                    } else {
                                        hashes.push(m[4] + ":" + (m[6] ? m[6] : makeLookupLiteral(m[5])));
                                    }
                                } else {
                                    args.push(makeLookupLiteral(arg));
                                }
                                i++;
                            });
                            result.content += args.join(",");
                            if (hashes.length) {
                                result.content += ",{" + HASH + ":{" + hashes.join(",") + "}}";
                            }
                        }
                        if (mode && mode !== "else") {
                            result.content += ",[\n\n";
                        }
                        switch (mode) {
                          case "^":
                          case "#":
                            result.content += "{fn:function(" + ARG_NAMES + "){var ___v1ew = [];";
                            break;

                          case "else":
                            result.content += 'return ___v1ew.join("");}},\n{inverse:function(' + ARG_NAMES + "){\nvar ___v1ew = [];";
                            break;

                          default:
                            result.content += ")";
                            break;
                        }
                        if (!mode) {
                            result.startTxt = true;
                            result.end = true;
                        }
                        return result;
                    }
                } ]
            })
        });
        var helpers = can.view.Scanner.prototype.helpers;
        for (var i = 0; i < helpers.length; i++) {
            Mustache.prototype.scanner.helpers.unshift(helpers[i]);
        }
        Mustache.txt = function(scopeAndOptions, mode, name) {
            var scope = scopeAndOptions.scope, options = scopeAndOptions.options, args = [], helperOptions = {
                fn: function() {},
                inverse: function() {}
            }, hash, context = scope.attr("."), getHelper = true, helper;
            for (var i = 3; i < arguments.length; i++) {
                var arg = arguments[i];
                if (mode && can.isArray(arg)) {
                    helperOptions = can.extend.apply(can, [ helperOptions ].concat(arg));
                } else if (arg && arg[HASH]) {
                    hash = arg[HASH];
                    for (var prop in hash) {
                        if (isLookup(hash[prop])) {
                            hash[prop] = Mustache.get(hash[prop].get, scopeAndOptions, false, true);
                        }
                    }
                } else if (arg && isLookup(arg)) {
                    args.push(Mustache.get(arg.get, scopeAndOptions, false, true, true));
                } else {
                    args.push(arg);
                }
            }
            if (isLookup(name)) {
                var get = name.get;
                name = Mustache.get(name.get, scopeAndOptions, args.length, false);
                getHelper = get === name;
            }
            helperOptions.fn = makeConvertToScopes(helperOptions.fn, scope, options);
            helperOptions.inverse = makeConvertToScopes(helperOptions.inverse, scope, options);
            if (mode === "^") {
                var tmp = helperOptions.fn;
                helperOptions.fn = helperOptions.inverse;
                helperOptions.inverse = tmp;
            }
            if (helper = getHelper && (typeof name === "string" && Mustache.getHelper(name, options)) || can.isFunction(name) && !name.isComputed && {
                fn: name
            }) {
                can.extend(helperOptions, {
                    context: context,
                    scope: scope,
                    contexts: scope,
                    hash: hash
                });
                args.push(helperOptions);
                return function() {
                    return helper.fn.apply(context, args) || "";
                };
            }
            return function() {
                var value;
                if (can.isFunction(name) && name.isComputed) {
                    value = name();
                } else {
                    value = name;
                }
                var validArgs = args.length ? args : [ value ], valid = true, result = [], i, argIsObserve, arg;
                if (mode) {
                    for (i = 0; i < validArgs.length; i++) {
                        arg = validArgs[i];
                        argIsObserve = typeof arg !== "undefined" && isObserveLike(arg);
                        if (isArrayLike(arg)) {
                            if (mode === "#") {
                                valid = valid && !!(argIsObserve ? arg.attr("length") : arg.length);
                            } else if (mode === "^") {
                                valid = valid && !(argIsObserve ? arg.attr("length") : arg.length);
                            }
                        } else {
                            valid = mode === "#" ? valid && !!arg : mode === "^" ? valid && !arg : valid;
                        }
                    }
                }
                if (valid) {
                    if (mode === "#") {
                        if (isArrayLike(value)) {
                            var isObserveList = isObserveLike(value);
                            for (i = 0; i < value.length; i++) {
                                result.push(helperOptions.fn(isObserveList ? value.attr("" + i) : value[i]));
                            }
                            return result.join("");
                        } else {
                            return helperOptions.fn(value || {}) || "";
                        }
                    } else if (mode === "^") {
                        return helperOptions.inverse(value || {}) || "";
                    } else {
                        return "" + (value != null ? value : "");
                    }
                }
                return "";
            };
        };
        Mustache.get = function(key, scopeAndOptions, isHelper, isArgument, isLookup) {
            var context = scopeAndOptions.scope.attr("."), options = scopeAndOptions.options || {};
            if (isHelper) {
                if (Mustache.getHelper(key, options)) {
                    return key;
                }
                if (scopeAndOptions.scope && can.isFunction(context[key])) {
                    return context[key];
                }
            }
            var computeData = scopeAndOptions.scope.computeData(key, {
                isArgument: isArgument,
                args: [ context, scopeAndOptions.scope ]
            }), compute = computeData.compute;
            can.compute.temporarilyBind(compute);
            var initialValue = computeData.initialValue, helperObj = Mustache.getHelper(key, options);
            if (!isLookup && (initialValue === undefined || computeData.scope !== scopeAndOptions.scope) && Mustache.getHelper(key, options)) {
                return key;
            }
            if (!compute.hasDependencies) {
                return initialValue;
            } else {
                return compute;
            }
        };
        Mustache.resolve = function(value) {
            if (isObserveLike(value) && isArrayLike(value) && value.attr("length")) {
                return value;
            } else if (can.isFunction(value)) {
                return value();
            } else {
                return value;
            }
        };
        can.view.Options = can.view.Scope.extend({
            init: function(data, parent) {
                if (!data.helpers && !data.partials && !data.tags) {
                    data = {
                        helpers: data
                    };
                }
                can.view.Scope.prototype.init.apply(this, arguments);
            }
        });
        Mustache._helpers = {};
        Mustache.registerHelper = function(name, fn) {
            this._helpers[name] = {
                name: name,
                fn: fn
            };
        };
        Mustache.getHelper = function(name, options) {
            var helper;
            if (options) {
                helper = options.attr("helpers." + name);
            }
            return helper ? {
                fn: helper
            } : this._helpers[name];
        };
        Mustache.render = function(partial, scope, options) {
            if (!can.view.cached[partial]) {
                var reads = can.__clearReading();
                if (scope.attr("partial")) {
                    partial = scope.attr("partial");
                }
                can.__setReading(reads);
            }
            return can.view.render(partial, scope, options);
        };
        Mustache.safeString = function(str) {
            return {
                toString: function() {
                    return str;
                }
            };
        };
        Mustache.renderPartial = function(partialName, scope, options) {
            var partial = options.attr("partials." + partialName);
            if (partial) {
                return partial.render ? partial.render(scope, options) : partial(scope, options);
            } else {
                return can.Mustache.render(partialName, scope, options);
            }
        };
        can.each({
            "if": function(expr, options) {
                var value;
                if (can.isFunction(expr)) {
                    value = can.compute.truthy(expr)();
                } else {
                    value = !!Mustache.resolve(expr);
                }
                if (value) {
                    return options.fn(options.contexts || this);
                } else {
                    return options.inverse(options.contexts || this);
                }
            },
            unless: function(expr, options) {
                return Mustache._helpers["if"].fn.apply(this, [ can.isFunction(expr) ? can.compute(function() {
                    return !expr();
                }) : !expr, options ]);
            },
            each: function(expr, options) {
                var resolved = Mustache.resolve(expr), result = [], keys, key, i;
                if (can.view.lists && (resolved instanceof can.List || expr && expr.isComputed && resolved === undefined)) {
                    return can.view.lists(expr, function(item, index) {
                        return options.fn(options.scope.add({
                            "@index": index
                        }).add(item));
                    });
                }
                expr = resolved;
                if (!!expr && isArrayLike(expr)) {
                    for (i = 0; i < expr.length; i++) {
                        result.push(options.fn(options.scope.add({
                            "@index": i
                        }).add(expr[i])));
                    }
                    return result.join("");
                } else if (isObserveLike(expr)) {
                    keys = can.Map.keys(expr);
                    for (i = 0; i < keys.length; i++) {
                        key = keys[i];
                        result.push(options.fn(options.scope.add({
                            "@key": key
                        }).add(expr[key])));
                    }
                    return result.join("");
                } else if (expr instanceof Object) {
                    for (key in expr) {
                        result.push(options.fn(options.scope.add({
                            "@key": key
                        }).add(expr[key])));
                    }
                    return result.join("");
                }
            },
            "with": function(expr, options) {
                var ctx = expr;
                expr = Mustache.resolve(expr);
                if (!!expr) {
                    return options.fn(ctx);
                }
            },
            log: function(expr, options) {
                if (typeof console !== "undefined" && console.log) {
                    if (!options) {
                        console.log(expr.context);
                    } else {
                        console.log(expr, options.context);
                    }
                }
            },
            "@index": function(offset, options) {
                if (!options) {
                    options = offset;
                    offset = 0;
                }
                var index = options.scope.attr("@index");
                return "" + ((can.isFunction(index) ? index() : index) + offset);
            }
        }, function(fn, name) {
            Mustache.registerHelper(name, fn);
        });
        can.view.register({
            suffix: "mustache",
            contentType: "x-mustache-template",
            script: function(id, src) {
                return "can.Mustache(function(" + ARG_NAMES + ") { " + new Mustache({
                    text: src,
                    name: id
                }).template.out + " })";
            },
            renderer: function(id, text) {
                return Mustache({
                    text: text,
                    name: id
                });
            }
        });
        can.mustache.registerHelper = can.proxy(can.Mustache.registerHelper, can.Mustache);
        can.mustache.safeString = can.Mustache.safeString;
        return can;
    }(__m2, __m22, __m10, __m23, __m20, __m25);
    var __m29 = function(can) {
        var isContentEditable = function() {
            var values = {
                "": true,
                "true": true,
                "false": false
            };
            var editable = function(el) {
                if (!el || !el.getAttribute) {
                    return;
                }
                var attr = el.getAttribute("contenteditable");
                return values[attr];
            };
            return function(el) {
                var val = editable(el);
                if (typeof val === "boolean") {
                    return val;
                } else {
                    return !!editable(el.parentNode);
                }
            };
        }(), removeCurly = function(value) {
            if (value[0] === "{" && value[value.length - 1] === "}") {
                return value.substr(1, value.length - 2);
            }
            return value;
        };
        can.view.attr("can-value", function(el, data) {
            var attr = removeCurly(el.getAttribute("can-value")), value = data.scope.computeData(attr, {
                args: []
            }).compute, trueValue, falseValue;
            if (el.nodeName.toLowerCase() === "input") {
                if (el.type === "checkbox") {
                    if (can.attr.has(el, "can-true-value")) {
                        trueValue = el.getAttribute("can-true-value");
                    } else {
                        trueValue = true;
                    }
                    if (can.attr.has(el, "can-false-value")) {
                        falseValue = el.getAttribute("can-false-value");
                    } else {
                        falseValue = false;
                    }
                }
                if (el.type === "checkbox" || el.type === "radio") {
                    new Checked(el, {
                        value: value,
                        trueValue: trueValue,
                        falseValue: falseValue
                    });
                    return;
                }
            }
            if (el.nodeName.toLowerCase() === "select" && el.multiple) {
                new Multiselect(el, {
                    value: value
                });
                return;
            }
            if (isContentEditable(el)) {
                new Content(el, {
                    value: value
                });
                return;
            }
            new Value(el, {
                value: value
            });
        });
        var special = {
            enter: function(data, el, original) {
                return {
                    event: "keyup",
                    handler: function(ev) {
                        if (ev.keyCode === 13) {
                            return original.call(this, ev);
                        }
                    }
                };
            }
        };
        can.view.attr(/can-[\w\.]+/, function(el, data) {
            var attributeName = data.attributeName, event = attributeName.substr("can-".length), handler = function(ev) {
                var attr = removeCurly(el.getAttribute(attributeName)), scopeData = data.scope.read(attr, {
                    returnObserveMethods: true,
                    isArgument: true
                });
                return scopeData.value.call(scopeData.parent, data.scope._context, can.$(this), ev);
            };
            if (special[event]) {
                var specialData = special[event](data, el, handler);
                handler = specialData.handler;
                event = specialData.event;
            }
            can.bind.call(el, event, handler);
        });
        var Value = can.Control.extend({
            init: function() {
                if (this.element[0].nodeName.toUpperCase() === "SELECT") {
                    setTimeout(can.proxy(this.set, this), 1);
                } else {
                    this.set();
                }
            },
            "{value} change": "set",
            set: function() {
                if (!this.element) {
                    return;
                }
                var val = this.options.value();
                this.element[0].value = val == null ? "" : val;
            },
            change: function() {
                if (!this.element) {
                    return;
                }
                this.options.value(this.element[0].value);
            }
        }), Checked = can.Control.extend({
            init: function() {
                this.isCheckbox = this.element[0].type.toLowerCase() === "checkbox";
                this.check();
            },
            "{value} change": "check",
            check: function() {
                if (this.isCheckbox) {
                    var value = this.options.value(), trueValue = this.options.trueValue || true;
                    this.element[0].checked = value === trueValue;
                } else {
                    var setOrRemove = this.options.value() == this.element[0].value ? "set" : "remove";
                    can.attr[setOrRemove](this.element[0], "checked", true);
                }
            },
            change: function() {
                if (this.isCheckbox) {
                    this.options.value(this.element[0].checked ? this.options.trueValue : this.options.falseValue);
                } else {
                    if (this.element[0].checked) {
                        this.options.value(this.element[0].value);
                    }
                }
            }
        }), Multiselect = Value.extend({
            init: function() {
                this.delimiter = ";";
                this.set();
            },
            set: function() {
                var newVal = this.options.value();
                if (typeof newVal === "string") {
                    newVal = newVal.split(this.delimiter);
                    this.isString = true;
                } else if (newVal) {
                    newVal = can.makeArray(newVal);
                }
                var isSelected = {};
                can.each(newVal, function(val) {
                    isSelected[val] = true;
                });
                can.each(this.element[0].childNodes, function(option) {
                    if (option.value) {
                        option.selected = !!isSelected[option.value];
                    }
                });
            },
            get: function() {
                var values = [], children = this.element[0].childNodes;
                can.each(children, function(child) {
                    if (child.selected && child.value) {
                        values.push(child.value);
                    }
                });
                return values;
            },
            change: function() {
                var value = this.get(), currentValue = this.options.value();
                if (this.isString || typeof currentValue === "string") {
                    this.isString = true;
                    this.options.value(value.join(this.delimiter));
                } else if (currentValue instanceof can.List) {
                    currentValue.attr(value, true);
                } else {
                    this.options.value(value);
                }
            }
        }), Content = can.Control.extend({
            init: function() {
                this.set();
                this.on("blur", "setValue");
            },
            "{value} change": "set",
            set: function() {
                var val = this.options.value();
                this.element[0].innerHTML = typeof val === "undefined" ? "" : val;
            },
            setValue: function() {
                this.options.value(this.element[0].innerHTML);
            }
        });
    }(__m2, __m21, __m11);
    var __m1 = function(can, viewCallbacks) {
        var ignoreAttributesRegExp = /^(dataViewId|class|id)$/i, paramReplacer = /\{([^\}]+)\}/g;
        var Component = can.Component = can.Construct.extend({
            setup: function() {
                can.Construct.setup.apply(this, arguments);
                if (can.Component) {
                    var self = this, scope = this.prototype.scope;
                    this.Control = ComponentControl.extend(this.prototype.events);
                    if (!scope || typeof scope === "object" && !(scope instanceof can.Map)) {
                        this.Map = can.Map.extend(scope || {});
                    } else if (scope.prototype instanceof can.Map) {
                        this.Map = scope;
                    }
                    this.attributeScopeMappings = {};
                    can.each(this.Map ? this.Map.defaults : {}, function(val, prop) {
                        if (val === "@") {
                            self.attributeScopeMappings[prop] = prop;
                        }
                    });
                    if (this.prototype.template) {
                        if (typeof this.prototype.template === "function") {
                            var temp = this.prototype.template;
                            this.renderer = function() {
                                return can.view.frag(temp.apply(null, arguments));
                            };
                        } else {
                            this.renderer = can.view.mustache(this.prototype.template);
                        }
                    }
                    can.view.tag(this.prototype.tag, function(el, options) {
                        new self(el, options);
                    });
                }
            }
        }, {
            setup: function(el, hookupOptions) {
                var initalScopeData = {}, component = this, twoWayBindings = {}, scopePropertyUpdating, componentScope, frag;
                can.each(this.constructor.attributeScopeMappings, function(val, prop) {
                    initalScopeData[prop] = el.getAttribute(can.hyphenate(val));
                });
                can.each(can.makeArray(el.attributes), function(node, index) {
                    var name = can.camelize(node.nodeName.toLowerCase()), value = node.value;
                    if (component.constructor.attributeScopeMappings[name] || ignoreAttributesRegExp.test(name) || viewCallbacks.attr(node.nodeName)) {
                        return;
                    }
                    if (value[0] === "{" && value[value.length - 1] === "}") {
                        value = value.substr(1, value.length - 2);
                    } else {
                        if (hookupOptions.templateType !== "legacy") {
                            initalScopeData[name] = value;
                            return;
                        }
                    }
                    var computeData = hookupOptions.scope.computeData(value, {
                        args: []
                    }), compute = computeData.compute;
                    var handler = function(ev, newVal) {
                        scopePropertyUpdating = name;
                        componentScope.attr(name, newVal);
                        scopePropertyUpdating = null;
                    };
                    compute.bind("change", handler);
                    initalScopeData[name] = compute();
                    if (!compute.hasDependencies) {
                        compute.unbind("change", handler);
                    } else {
                        can.bind.call(el, "removed", function() {
                            compute.unbind("change", handler);
                        });
                        twoWayBindings[name] = computeData;
                    }
                });
                if (this.constructor.Map) {
                    componentScope = new this.constructor.Map(initalScopeData);
                } else if (this.scope instanceof can.Map) {
                    componentScope = this.scope;
                } else if (can.isFunction(this.scope)) {
                    var scopeResult = this.scope(initalScopeData, hookupOptions.scope, el);
                    if (scopeResult instanceof can.Map) {
                        componentScope = scopeResult;
                    } else if (scopeResult.prototype instanceof can.Map) {
                        componentScope = new scopeResult(initalScopeData);
                    } else {
                        componentScope = new (can.Map.extend(scopeResult))(initalScopeData);
                    }
                }
                var handlers = {};
                can.each(twoWayBindings, function(computeData, prop) {
                    handlers[prop] = function(ev, newVal) {
                        if (scopePropertyUpdating !== prop) {
                            computeData.compute(newVal);
                        }
                    };
                    componentScope.bind(prop, handlers[prop]);
                });
                can.bind.call(el, "removed", function() {
                    can.each(handlers, function(handler, prop) {
                        componentScope.unbind(prop, handlers[prop]);
                    });
                });
                if (!can.isEmptyObject(this.constructor.attributeScopeMappings) || hookupOptions.templateType !== "legacy") {
                    can.bind.call(el, "attributes", function(ev) {
                        var camelized = can.camelize(ev.attributeName);
                        if (!twoWayBindings[camelized] && !ignoreAttributesRegExp.test(camelized)) {
                            componentScope.attr(camelized, el.getAttribute(ev.attributeName));
                        }
                    });
                }
                this.scope = componentScope;
                can.data(can.$(el), "scope", this.scope);
                var renderedScope = hookupOptions.scope.add(this.scope), options = {
                    helpers: {}
                };
                can.each(this.helpers || {}, function(val, prop) {
                    if (can.isFunction(val)) {
                        options.helpers[prop] = function() {
                            return val.apply(componentScope, arguments);
                        };
                    }
                });
                this._control = new this.constructor.Control(el, {
                    scope: this.scope
                });
                if (this.constructor.renderer) {
                    if (!options.tags) {
                        options.tags = {};
                    }
                    options.tags.content = function contentHookup(el, rendererOptions) {
                        var subtemplate = hookupOptions.subtemplate || rendererOptions.subtemplate;
                        if (subtemplate) {
                            delete options.tags.content;
                            can.view.live.replace([ el ], subtemplate(rendererOptions.scope, rendererOptions.options));
                            options.tags.content = contentHookup;
                        }
                    };
                    frag = this.constructor.renderer(renderedScope, hookupOptions.options.add(options));
                } else {
                    if (hookupOptions.templateType === "legacy") {
                        frag = can.view.frag(hookupOptions.subtemplate ? hookupOptions.subtemplate(renderedScope, hookupOptions.options.add(options)) : "");
                    } else {
                        frag = hookupOptions.subtemplate ? hookupOptions.subtemplate(renderedScope, hookupOptions.options.add(options)) : document.createDocumentFragment();
                    }
                }
                can.appendChild(el, frag);
            }
        });
        var ComponentControl = can.Control.extend({
            _lookup: function(options) {
                return [ options.scope, options, window ];
            },
            _action: function(methodName, options, controlInstance) {
                var hasObjectLookup, readyCompute;
                paramReplacer.lastIndex = 0;
                hasObjectLookup = paramReplacer.test(methodName);
                if (!controlInstance && hasObjectLookup) {
                    return;
                } else if (!hasObjectLookup) {
                    return can.Control._action.apply(this, arguments);
                } else {
                    readyCompute = can.compute(function() {
                        var delegate;
                        var name = methodName.replace(paramReplacer, function(matched, key) {
                            var value;
                            if (key === "scope") {
                                delegate = options.scope;
                                return "";
                            }
                            key = key.replace(/^scope\./, "");
                            value = can.compute.read(options.scope, key.split("."), {
                                isArgument: true
                            }).value;
                            if (value === undefined) {
                                value = can.getObject(key);
                            }
                            if (typeof value === "string") {
                                return value;
                            } else {
                                delegate = value;
                                return "";
                            }
                        });
                        var parts = name.split(/\s+/g), event = parts.pop();
                        return {
                            processor: this.processors[event] || this.processors.click,
                            parts: [ name, parts.join(" "), event ],
                            delegate: delegate || undefined
                        };
                    }, this);
                    var handler = function(ev, ready) {
                        controlInstance._bindings.control[methodName](controlInstance.element);
                        controlInstance._bindings.control[methodName] = ready.processor(ready.delegate || controlInstance.element, ready.parts[2], ready.parts[1], methodName, controlInstance);
                    };
                    readyCompute.bind("change", handler);
                    controlInstance._bindings.readyComputes[methodName] = {
                        compute: readyCompute,
                        handler: handler
                    };
                    return readyCompute();
                }
            }
        }, {
            setup: function(el, options) {
                this.scope = options.scope;
                return can.Control.prototype.setup.call(this, el, options);
            },
            off: function() {
                if (this._bindings) {
                    can.each(this._bindings.readyComputes || {}, function(value) {
                        value.compute.unbind("change", value.handler);
                    });
                }
                can.Control.prototype.off.apply(this, arguments);
                this._bindings.readyComputes = {};
            }
        });
        if (window.jQuery && jQuery.fn) {
            jQuery.fn.scope = function(attr) {
                if (attr) {
                    return this.data("scope").attr(attr);
                } else {
                    return this.data("scope");
                }
            };
        }
        can.scope = function(el, attr) {
            el = can.$(el);
            if (attr) {
                return can.data(el, "scope").attr(attr);
            } else {
                return can.data(el, "scope");
            }
        };
        return Component;
    }(__m2, __m9, __m11, __m14, __m21, __m29);
    var __m30 = function(can) {
        var pipe = function(def, thisArg, func) {
            var d = new can.Deferred();
            def.then(function() {
                var args = can.makeArray(arguments), success = true;
                try {
                    args[0] = func.apply(thisArg, args);
                } catch (e) {
                    success = false;
                    d.rejectWith(d, [ e ].concat(args));
                }
                if (success) {
                    d.resolveWith(d, args);
                }
            }, function() {
                d.rejectWith(this, arguments);
            });
            if (typeof def.abort === "function") {
                d.abort = function() {
                    return def.abort();
                };
            }
            return d;
        }, modelNum = 0, getId = function(inst) {
            can.__reading(inst, inst.constructor.id);
            return inst.__get(inst.constructor.id);
        }, ajax = function(ajaxOb, data, type, dataType, success, error) {
            var params = {};
            if (typeof ajaxOb === "string") {
                var parts = ajaxOb.split(/\s+/);
                params.url = parts.pop();
                if (parts.length) {
                    params.type = parts.pop();
                }
            } else {
                can.extend(params, ajaxOb);
            }
            params.data = typeof data === "object" && !can.isArray(data) ? can.extend(params.data || {}, data) : data;
            params.url = can.sub(params.url, params.data, true);
            return can.ajax(can.extend({
                type: type || "post",
                dataType: dataType || "json",
                success: success,
                error: error
            }, params));
        }, makeRequest = function(modelObj, type, success, error, method) {
            var args;
            if (can.isArray(modelObj)) {
                args = modelObj[1];
                modelObj = modelObj[0];
            } else {
                args = modelObj.serialize();
            }
            args = [ args ];
            var deferred, model = modelObj.constructor, jqXHR;
            if (type === "update" || type === "destroy") {
                args.unshift(getId(modelObj));
            }
            jqXHR = model[type].apply(model, args);
            deferred = pipe(jqXHR, modelObj, function(data) {
                modelObj[method || type + "d"](data, jqXHR);
                return modelObj;
            });
            if (jqXHR.abort) {
                deferred.abort = function() {
                    jqXHR.abort();
                };
            }
            deferred.then(success, error);
            return deferred;
        }, converters = {
            models: function(instancesRawData, oldList, xhr) {
                can.Model._reqs++;
                if (!instancesRawData) {
                    return;
                }
                if (instancesRawData instanceof this.List) {
                    return instancesRawData;
                }
                var self = this, tmp = [], ListClass = self.List || ML, modelList = oldList instanceof can.List ? oldList : new ListClass(), rawDataIsList = instancesRawData instanceof ML, raw = rawDataIsList ? instancesRawData.serialize() : instancesRawData;
                raw = self.parseModels(raw, xhr);
                if (raw.data) {
                    instancesRawData = raw;
                    raw = raw.data;
                }
                if (typeof raw === "undefined") {
                    throw new Error("Could not get any raw data while converting using .models");
                }
                if (modelList.length) {
                    modelList.splice(0);
                }
                can.each(raw, function(rawPart) {
                    tmp.push(self.model(rawPart, xhr));
                });
                modelList.push.apply(modelList, tmp);
                if (!can.isArray(instancesRawData)) {
                    can.each(instancesRawData, function(val, prop) {
                        if (prop !== "data") {
                            modelList.attr(prop, val);
                        }
                    });
                }
                setTimeout(can.proxy(this._clean, this), 1);
                return modelList;
            },
            model: function(attributes, oldModel, xhr) {
                if (!attributes) {
                    return;
                }
                if (typeof attributes.serialize === "function") {
                    attributes = attributes.serialize();
                } else {
                    attributes = this.parseModel(attributes, xhr);
                }
                var id = attributes[this.id];
                if ((id || id === 0) && this.store[id]) {
                    oldModel = this.store[id];
                }
                var model = oldModel && can.isFunction(oldModel.attr) ? oldModel.attr(attributes, this.removeAttr || false) : new this(attributes);
                return model;
            }
        }, makeParser = {
            parseModel: function(prop) {
                return function(attributes) {
                    return prop ? can.getObject(prop, attributes) : attributes;
                };
            },
            parseModels: function(prop) {
                return function(attributes) {
                    if (can.isArray(attributes)) {
                        return attributes;
                    }
                    prop = prop || "data";
                    var result = can.getObject(prop, attributes);
                    if (!can.isArray(result)) {
                        throw new Error("Could not get any raw data while converting using .models");
                    }
                    return result;
                };
            }
        }, ajaxMethods = {
            create: {
                url: "_shortName",
                type: "post"
            },
            update: {
                data: function(id, attrs) {
                    attrs = attrs || {};
                    var identity = this.id;
                    if (attrs[identity] && attrs[identity] !== id) {
                        attrs["new" + can.capitalize(id)] = attrs[identity];
                        delete attrs[identity];
                    }
                    attrs[identity] = id;
                    return attrs;
                },
                type: "put"
            },
            destroy: {
                type: "delete",
                data: function(id, attrs) {
                    attrs = attrs || {};
                    attrs.id = attrs[this.id] = id;
                    return attrs;
                }
            },
            findAll: {
                url: "_shortName"
            },
            findOne: {}
        }, ajaxMaker = function(ajaxMethod, str) {
            return function(data) {
                data = ajaxMethod.data ? ajaxMethod.data.apply(this, arguments) : data;
                return ajax(str || this[ajaxMethod.url || "_url"], data, ajaxMethod.type || "get");
            };
        }, createURLFromResource = function(model, name) {
            if (!model.resource) {
                return;
            }
            var resource = model.resource.replace(/\/+$/, "");
            if (name === "findAll" || name === "create") {
                return resource;
            } else {
                return resource + "/{" + model.id + "}";
            }
        };
        can.Model = can.Map.extend({
            fullName: "can.Model",
            _reqs: 0,
            setup: function(base, fullName, staticProps, protoProps) {
                if (typeof fullName !== "string") {
                    protoProps = staticProps;
                    staticProps = fullName;
                }
                if (!protoProps) {
                    protoProps = staticProps;
                }
                this.store = {};
                can.Map.setup.apply(this, arguments);
                if (!can.Model) {
                    return;
                }
                if (staticProps && staticProps.List) {
                    this.List = staticProps.List;
                    this.List.Map = this;
                } else {
                    this.List = base.List.extend({
                        Map: this
                    }, {});
                }
                var self = this, clean = can.proxy(this._clean, self);
                can.each(ajaxMethods, function(method, name) {
                    if (staticProps && staticProps[name] && (typeof staticProps[name] === "string" || typeof staticProps[name] === "object")) {
                        self[name] = ajaxMaker(method, staticProps[name]);
                    } else if (staticProps && staticProps.resource && !can.isFunction(staticProps[name])) {
                        self[name] = ajaxMaker(method, createURLFromResource(self, name));
                    }
                    if (self["make" + can.capitalize(name)]) {
                        var newMethod = self["make" + can.capitalize(name)](self[name]);
                        can.Construct._overwrite(self, base, name, function() {
                            can.Model._reqs++;
                            var def = newMethod.apply(this, arguments);
                            var then = def.then(clean, clean);
                            then.abort = def.abort;
                            return then;
                        });
                    }
                });
                var hasCustomConverter = {};
                can.each(converters, function(converter, name) {
                    var parseName = "parse" + can.capitalize(name), dataProperty = staticProps && staticProps[name] || self[name];
                    if (typeof dataProperty === "string") {
                        self[parseName] = dataProperty;
                        can.Construct._overwrite(self, base, name, converter);
                    } else if (staticProps && staticProps[name]) {
                        hasCustomConverter[parseName] = true;
                    }
                });
                can.each(makeParser, function(maker, parseName) {
                    var prop = staticProps && staticProps[parseName] || self[parseName];
                    if (typeof prop === "string") {
                        can.Construct._overwrite(self, base, parseName, maker(prop));
                    } else if ((!staticProps || !can.isFunction(staticProps[parseName])) && !self[parseName]) {
                        var madeParser = maker();
                        madeParser.useModelConverter = hasCustomConverter[parseName];
                        can.Construct._overwrite(self, base, parseName, madeParser);
                    }
                });
                if (self.fullName === "can.Model" || !self.fullName) {
                    self.fullName = "Model" + ++modelNum;
                }
                can.Model._reqs = 0;
                this._url = this._shortName + "/{" + this.id + "}";
            },
            _ajax: ajaxMaker,
            _makeRequest: makeRequest,
            _clean: function() {
                can.Model._reqs--;
                if (!can.Model._reqs) {
                    for (var id in this.store) {
                        if (!this.store[id]._bindings) {
                            delete this.store[id];
                        }
                    }
                }
                return arguments[0];
            },
            models: converters.models,
            model: converters.model
        }, {
            setup: function(attrs) {
                var id = attrs && attrs[this.constructor.id];
                if (can.Model._reqs && id != null) {
                    this.constructor.store[id] = this;
                }
                can.Map.prototype.setup.apply(this, arguments);
            },
            isNew: function() {
                var id = getId(this);
                return !(id || id === 0);
            },
            save: function(success, error) {
                return makeRequest(this, this.isNew() ? "create" : "update", success, error);
            },
            destroy: function(success, error) {
                if (this.isNew()) {
                    var self = this;
                    var def = can.Deferred();
                    def.then(success, error);
                    return def.done(function(data) {
                        self.destroyed(data);
                    }).resolve(self);
                }
                return makeRequest(this, "destroy", success, error, "destroyed");
            },
            _bindsetup: function() {
                this.constructor.store[this.__get(this.constructor.id)] = this;
                return can.Map.prototype._bindsetup.apply(this, arguments);
            },
            _bindteardown: function() {
                delete this.constructor.store[getId(this)];
                return can.Map.prototype._bindteardown.apply(this, arguments);
            },
            ___set: function(prop, val) {
                can.Map.prototype.___set.call(this, prop, val);
                if (prop === this.constructor.id && this._bindings) {
                    this.constructor.store[getId(this)] = this;
                }
            }
        });
        var makeGetterHandler = function(name) {
            return function(data, readyState, xhr) {
                return this[name](data, null, xhr);
            };
        }, createUpdateDestroyHandler = function(data) {
            if (this.parseModel.useModelConverter) {
                return this.model(data);
            }
            return this.parseModel(data);
        };
        var responseHandlers = {
            makeFindAll: makeGetterHandler("models"),
            makeFindOne: makeGetterHandler("model"),
            makeCreate: createUpdateDestroyHandler,
            makeUpdate: createUpdateDestroyHandler
        };
        can.each(responseHandlers, function(method, name) {
            can.Model[name] = function(oldMethod) {
                return function() {
                    var args = can.makeArray(arguments), oldArgs = can.isFunction(args[1]) ? args.splice(0, 1) : args.splice(0, 2), def = pipe(oldMethod.apply(this, oldArgs), this, method);
                    def.then(args[0], args[1]);
                    return def;
                };
            };
        });
        can.each([ "created", "updated", "destroyed" ], function(funcName) {
            can.Model.prototype[funcName] = function(attrs) {
                var self = this, constructor = self.constructor;
                if (attrs && typeof attrs === "object") {
                    this.attr(can.isFunction(attrs.attr) ? attrs.attr() : attrs);
                }
                can.dispatch.call(this, {
                    type: "change",
                    target: this
                }, [ funcName ]);
                can.dispatch.call(constructor, funcName, [ this ]);
            };
        });
        var ML = can.Model.List = can.List.extend({
            _bubbleRule: function(eventName, list) {
                return can.List._bubbleRule(eventName, list) || "destroyed";
            }
        }, {
            setup: function(params) {
                if (can.isPlainObject(params) && !can.isArray(params)) {
                    can.List.prototype.setup.apply(this);
                    this.replace(can.isDeferred(params) ? params : this.constructor.Map.findAll(params));
                } else {
                    can.List.prototype.setup.apply(this, arguments);
                }
                this._init = 1;
                this.bind("destroyed", can.proxy(this._destroyed, this));
                delete this._init;
            },
            _destroyed: function(ev, attr) {
                if (/\w+/.test(attr)) {
                    var index;
                    while ((index = this.indexOf(ev.target)) > -1) {
                        this.splice(index, 1);
                    }
                }
            }
        });
        return can.Model;
    }(__m2, __m15, __m19);
    var __m32 = function(can) {
        var digitTest = /^\d+$/, keyBreaker = /([^\[\]]+)|(\[\])/g, paramTest = /([^?#]*)(#.*)?$/, prep = function(str) {
            return decodeURIComponent(str.replace(/\+/g, " "));
        };
        can.extend(can, {
            deparam: function(params) {
                var data = {}, pairs, lastPart;
                if (params && paramTest.test(params)) {
                    pairs = params.split("&");
                    can.each(pairs, function(pair) {
                        var parts = pair.split("="), key = prep(parts.shift()), value = prep(parts.join("=")), current = data;
                        if (key) {
                            parts = key.match(keyBreaker);
                            for (var j = 0, l = parts.length - 1; j < l; j++) {
                                if (!current[parts[j]]) {
                                    current[parts[j]] = digitTest.test(parts[j + 1]) || parts[j + 1] === "[]" ? [] : {};
                                }
                                current = current[parts[j]];
                            }
                            lastPart = parts.pop();
                            if (lastPart === "[]") {
                                current.push(value);
                            } else {
                                current[lastPart] = value;
                            }
                        }
                    });
                }
                return data;
            }
        });
        return can;
    }(__m2, __m13);
    var __m31 = function(can) {
        var matcher = /\:([\w\.]+)/g, paramsMatcher = /^(?:&[^=]+=[^&]*)+/, makeProps = function(props) {
            var tags = [];
            can.each(props, function(val, name) {
                tags.push((name === "className" ? "class" : name) + '="' + (name === "href" ? val : can.esc(val)) + '"');
            });
            return tags.join(" ");
        }, matchesData = function(route, data) {
            var count = 0, i = 0, defaults = {};
            for (var name in route.defaults) {
                if (route.defaults[name] === data[name]) {
                    defaults[name] = 1;
                    count++;
                }
            }
            for (;i < route.names.length; i++) {
                if (!data.hasOwnProperty(route.names[i])) {
                    return -1;
                }
                if (!defaults[route.names[i]]) {
                    count++;
                }
            }
            return count;
        }, location = window.location, wrapQuote = function(str) {
            return (str + "").replace(/([.?*+\^$\[\]\\(){}|\-])/g, "\\$1");
        }, each = can.each, extend = can.extend, stringify = function(obj) {
            if (obj && typeof obj === "object") {
                if (obj instanceof can.Map) {
                    obj = obj.attr();
                } else {
                    obj = can.isFunction(obj.slice) ? obj.slice() : can.extend({}, obj);
                }
                can.each(obj, function(val, prop) {
                    obj[prop] = stringify(val);
                });
            } else if (obj !== undefined && obj !== null && can.isFunction(obj.toString)) {
                obj = obj.toString();
            }
            return obj;
        }, removeBackslash = function(str) {
            return str.replace(/\\/g, "");
        }, timer, curParams, lastHash, changingData, onRouteDataChange = function(ev, attr, how, newval) {
            changingData = 1;
            clearTimeout(timer);
            timer = setTimeout(function() {
                changingData = 0;
                var serialized = can.route.data.serialize(), path = can.route.param(serialized, true);
                can.route._call("setURL", path);
                can.batch.trigger(eventsObject, "__url", [ path, lastHash ]);
                lastHash = path;
            }, 10);
        }, eventsObject = can.extend({}, can.event);
        can.route = function(url, defaults) {
            var root = can.route._call("root");
            if (root.lastIndexOf("/") === root.length - 1 && url.indexOf("/") === 0) {
                url = url.substr(1);
            }
            defaults = defaults || {};
            var names = [], res, test = "", lastIndex = matcher.lastIndex = 0, next, querySeparator = can.route._call("querySeparator"), matchSlashes = can.route._call("matchSlashes");
            while (res = matcher.exec(url)) {
                names.push(res[1]);
                test += removeBackslash(url.substring(lastIndex, matcher.lastIndex - res[0].length));
                next = "\\" + (removeBackslash(url.substr(matcher.lastIndex, 1)) || querySeparator + (matchSlashes ? "" : "|/"));
                test += "([^" + next + "]" + (defaults[res[1]] ? "*" : "+") + ")";
                lastIndex = matcher.lastIndex;
            }
            test += url.substr(lastIndex).replace("\\", "");
            can.route.routes[url] = {
                test: new RegExp("^" + test + "($|" + wrapQuote(querySeparator) + ")"),
                route: url,
                names: names,
                defaults: defaults,
                length: url.split("/").length
            };
            return can.route;
        };
        extend(can.route, {
            param: function(data, _setRoute) {
                var route, matches = 0, matchCount, routeName = data.route, propCount = 0;
                delete data.route;
                each(data, function() {
                    propCount++;
                });
                each(can.route.routes, function(temp, name) {
                    matchCount = matchesData(temp, data);
                    if (matchCount > matches) {
                        route = temp;
                        matches = matchCount;
                    }
                    if (matchCount >= propCount) {
                        return false;
                    }
                });
                if (can.route.routes[routeName] && matchesData(can.route.routes[routeName], data) === matches) {
                    route = can.route.routes[routeName];
                }
                if (route) {
                    var cpy = extend({}, data), res = route.route.replace(matcher, function(whole, name) {
                        delete cpy[name];
                        return data[name] === route.defaults[name] ? "" : encodeURIComponent(data[name]);
                    }).replace("\\", ""), after;
                    each(route.defaults, function(val, name) {
                        if (cpy[name] === val) {
                            delete cpy[name];
                        }
                    });
                    after = can.param(cpy);
                    if (_setRoute) {
                        can.route.attr("route", route.route);
                    }
                    return res + (after ? can.route._call("querySeparator") + after : "");
                }
                return can.isEmptyObject(data) ? "" : can.route._call("querySeparator") + can.param(data);
            },
            deparam: function(url) {
                var root = can.route._call("root");
                if (root.lastIndexOf("/") === root.length - 1 && url.indexOf("/") === 0) {
                    url = url.substr(1);
                }
                var route = {
                    length: -1
                }, querySeparator = can.route._call("querySeparator"), paramsMatcher = can.route._call("paramsMatcher");
                each(can.route.routes, function(temp, name) {
                    if (temp.test.test(url) && temp.length > route.length) {
                        route = temp;
                    }
                });
                if (route.length > -1) {
                    var parts = url.match(route.test), start = parts.shift(), remainder = url.substr(start.length - (parts[parts.length - 1] === querySeparator ? 1 : 0)), obj = remainder && paramsMatcher.test(remainder) ? can.deparam(remainder.slice(1)) : {};
                    obj = extend(true, {}, route.defaults, obj);
                    each(parts, function(part, i) {
                        if (part && part !== querySeparator) {
                            obj[route.names[i]] = decodeURIComponent(part);
                        }
                    });
                    obj.route = route.route;
                    return obj;
                }
                if (url.charAt(0) !== querySeparator) {
                    url = querySeparator + url;
                }
                return paramsMatcher.test(url) ? can.deparam(url.slice(1)) : {};
            },
            data: new can.Map({}),
            map: function(data) {
                var appState;
                if (data.prototype instanceof can.Map) {
                    appState = new data();
                } else {
                    appState = data;
                }
                can.route.data = appState;
            },
            routes: {},
            ready: function(val) {
                if (val !== true) {
                    can.route._setup();
                    can.route.setState();
                }
                return can.route;
            },
            url: function(options, merge) {
                if (merge) {
                    options = can.extend({}, can.route.deparam(can.route._call("matchingPartOfURL")), options);
                }
                return can.route._call("root") + can.route.param(options);
            },
            link: function(name, options, props, merge) {
                return "<a " + makeProps(extend({
                    href: can.route.url(options, merge)
                }, props)) + ">" + name + "</a>";
            },
            current: function(options) {
                can.__reading(eventsObject, "__url");
                return this._call("matchingPartOfURL") === can.route.param(options);
            },
            bindings: {
                hashchange: {
                    paramsMatcher: paramsMatcher,
                    querySeparator: "&",
                    matchSlashes: false,
                    bind: function() {
                        can.bind.call(window, "hashchange", setState);
                    },
                    unbind: function() {
                        can.unbind.call(window, "hashchange", setState);
                    },
                    matchingPartOfURL: function() {
                        return location.href.split(/#!?/)[1] || "";
                    },
                    setURL: function(path) {
                        location.hash = "#!" + path;
                        return path;
                    },
                    root: "#!"
                }
            },
            defaultBinding: "hashchange",
            currentBinding: null,
            _setup: function() {
                if (!can.route.currentBinding) {
                    can.route._call("bind");
                    can.route.bind("change", onRouteDataChange);
                    can.route.currentBinding = can.route.defaultBinding;
                }
            },
            _teardown: function() {
                if (can.route.currentBinding) {
                    can.route._call("unbind");
                    can.route.unbind("change", onRouteDataChange);
                    can.route.currentBinding = null;
                }
                clearTimeout(timer);
                changingData = 0;
            },
            _call: function() {
                var args = can.makeArray(arguments), prop = args.shift(), binding = can.route.bindings[can.route.currentBinding || can.route.defaultBinding], method = binding[prop];
                if (method.apply) {
                    return method.apply(binding, args);
                } else {
                    return method;
                }
            }
        });
        each([ "bind", "unbind", "on", "off", "delegate", "undelegate", "removeAttr", "compute", "_get", "__get", "each" ], function(name) {
            can.route[name] = function() {
                if (!can.route.data[name]) {
                    return;
                }
                return can.route.data[name].apply(can.route.data, arguments);
            };
        });
        can.route.attr = function(attr, val) {
            var type = typeof attr, newArguments;
            if (val === undefined) {
                newArguments = arguments;
            } else if (type !== "string" && type !== "number") {
                newArguments = [ stringify(attr), val ];
            } else {
                newArguments = [ attr, stringify(val) ];
            }
            return can.route.data.attr.apply(can.route.data, newArguments);
        };
        var setState = can.route.setState = function() {
            var hash = can.route._call("matchingPartOfURL");
            var oldParams = curParams;
            curParams = can.route.deparam(hash);
            if (!changingData || hash !== lastHash) {
                can.batch.start();
                for (var attr in oldParams) {
                    if (!curParams[attr]) {
                        can.route.removeAttr(attr);
                    }
                }
                can.route.attr(curParams);
                can.batch.trigger(eventsObject, "__url", [ hash, lastHash ]);
                can.batch.stop();
            }
        };
        return can.route;
    }(__m2, __m15, __m19, __m32);
    var __m33 = function(can) {
        can.Control.processors.route = function(el, event, selector, funcName, controller) {
            selector = selector || "";
            if (!can.route.routes[selector]) {
                if (selector[0] === "/") {
                    selector = selector.substring(1);
                }
                can.route(selector);
            }
            var batchNum, check = function(ev, attr, how) {
                if (can.route.attr("route") === selector && (ev.batchNum === undefined || ev.batchNum !== batchNum)) {
                    batchNum = ev.batchNum;
                    var d = can.route.attr();
                    delete d.route;
                    if (can.isFunction(controller[funcName])) {
                        controller[funcName](d);
                    } else {
                        controller[controller[funcName]](d);
                    }
                }
            };
            can.route.bind("change", check);
            return function() {
                can.route.unbind("change", check);
            };
        };
        return can;
    }(__m2, __m31, __m11);
    var __m35 = function(can, elements) {
        var processNodes = function(nodes, paths, location) {
            var frag = document.createDocumentFragment();
            for (var i = 0, len = nodes.length; i < len; i++) {
                var node = nodes[i];
                frag.appendChild(processNode(node, paths, location.concat(i)));
            }
            return frag;
        }, keepsTextNodes = function() {
            var testFrag = document.createDocumentFragment();
            var div = document.createElement("div");
            div.appendChild(document.createTextNode(""));
            div.appendChild(document.createTextNode(""));
            testFrag.appendChild(div);
            var cloned = testFrag.cloneNode(true);
            return cloned.childNodes[0].childNodes.length === 2;
        }(), clonesWork = function() {
            var a = document.createElement("a");
            a.innerHTML = "<xyz></xyz>";
            var clone = a.cloneNode(true);
            return clone.innerHTML === "<xyz></xyz>";
        }();
        var cloneNode = clonesWork ? function(el) {
            return el.cloneNode(true);
        } : function(node) {
            var copy;
            if (node.nodeType === 1) {
                copy = document.createElement(node.nodeName);
            } else if (node.nodeType === 3) {
                copy = document.createTextNode(node.nodeValue);
            } else if (node.nodeType === 8) {
                copy = document.createComment(node.nodeValue);
            } else if (node.nodeType === 11) {
                copy = document.createDocumentFragment();
            }
            if (node.attributes) {
                var attributes = can.makeArray(node.attributes);
                can.each(attributes, function(node) {
                    if (node && node.specified) {
                        copy.setAttribute(node.nodeName, node.nodeValue);
                    }
                });
            }
            if (node.childNodes) {
                can.each(node.childNodes, function(child) {
                    copy.appendChild(cloneNode(child));
                });
            }
            return copy;
        };
        function processNode(node, paths, location) {
            var callback, loc = location, nodeType = typeof node, el, p, i, len;
            var getCallback = function() {
                if (!callback) {
                    callback = {
                        path: location,
                        callbacks: []
                    };
                    paths.push(callback);
                    loc = [];
                }
                return callback;
            };
            if (nodeType === "object") {
                if (node.tag) {
                    el = document.createElement(node.tag);
                    if (node.attrs) {
                        for (var attrName in node.attrs) {
                            var value = node.attrs[attrName];
                            if (typeof value === "function") {
                                getCallback().callbacks.push({
                                    callback: value
                                });
                            } else {
                                el.setAttribute(attrName, value);
                            }
                        }
                    }
                    if (node.attributes) {
                        for (i = 0, len = node.attributes.length; i < len; i++) {
                            getCallback().callbacks.push({
                                callback: node.attributes[i]
                            });
                        }
                    }
                    if (node.children && node.children.length) {
                        if (callback) {
                            p = callback.paths = [];
                        } else {
                            p = paths;
                        }
                        el.appendChild(processNodes(node.children, p, loc));
                    }
                } else if (node.comment) {
                    el = document.createComment(node.comment);
                    if (node.callbacks) {
                        for (i = 0, len = node.attributes.length; i < len; i++) {
                            getCallback().callbacks.push({
                                callback: node.callbacks[i]
                            });
                        }
                    }
                }
            } else if (nodeType === "string") {
                el = document.createTextNode(node);
            } else if (nodeType === "function") {
                if (keepsTextNodes) {
                    el = document.createTextNode("");
                    getCallback().callbacks.push({
                        callback: node
                    });
                } else {
                    el = document.createComment("~");
                    getCallback().callbacks.push({
                        callback: function() {
                            var el = document.createTextNode("");
                            elements.replace([ this ], el);
                            return node.apply(el, arguments);
                        }
                    });
                }
            }
            return el;
        }
        function hydratePath(el, pathData, args) {
            var path = pathData.path, callbacks = pathData.callbacks, paths = pathData.paths, callbackData, child = el;
            for (var i = 0, len = path.length; i < len; i++) {
                child = child.childNodes[path[i]];
            }
            for (i = 0, len = callbacks.length; i < len; i++) {
                callbackData = callbacks[i];
                callbackData.callback.apply(child, args);
            }
            if (paths && paths.length) {
                for (i = paths.length - 1; i >= 0; i--) {
                    hydratePath(child, paths[i], args);
                }
            }
        }
        function makeTarget(nodes) {
            var paths = [];
            var frag = processNodes(nodes, paths, []);
            return {
                paths: paths,
                clone: frag,
                hydrate: function() {
                    var cloned = cloneNode(this.clone);
                    var args = can.makeArray(arguments);
                    for (var i = paths.length - 1; i >= 0; i--) {
                        hydratePath(cloned, paths[i], args);
                    }
                    return cloned;
                }
            };
        }
        makeTarget.keepsTextNodes = keepsTextNodes;
        can.view.target = makeTarget;
        return makeTarget;
    }(__m2, __m24);
    var __m37 = function() {
        return {
            isArrayLike: function(obj) {
                return obj && obj.splice && typeof obj.length === "number";
            },
            isObserveLike: function(obj) {
                return obj instanceof can.Map || obj && !!obj._get;
            },
            emptyHandler: function() {},
            jsonParse: function(str) {
                if (str[0] === "'") {
                    return str.substr(1, str.length - 2);
                } else if (str === "undefined") {
                    return undefined;
                } else if (window.JSON) {
                    return JSON.parse(str);
                } else {
                    return eval("(" + str + ")");
                }
            },
            mixins: {
                last: function() {
                    return this.stack[this.stack.length - 1];
                },
                add: function(chars) {
                    this.last().add(chars);
                },
                subSectionDepth: function() {
                    return this.stack.length - 1;
                }
            }
        };
    }(__m2);
    var __m39 = function(can, utils, live) {
        live = live || can.view.live;
        var resolve = function(value) {
            if (utils.isObserveLike(value) && utils.isArrayLike(value) && value.attr("length")) {
                return value;
            } else if (can.isFunction(value)) {
                return value();
            } else {
                return value;
            }
        };
        var helpers = {
            each: function(items, options) {
                var resolved = resolve(items), result = [], keys, key, i;
                if (resolved instanceof can.List || items && items.isComputed && resolved === undefined) {
                    return function(el) {
                        var cb = function(item, index, parentNodeList) {
                            return options.fn(options.scope.add({
                                "@index": index
                            }).add(item), options.options, parentNodeList);
                        };
                        live.list(el, items, cb, options.context, el.parentNode, options.nodeList);
                    };
                }
                var expr = resolved;
                if (!!expr && utils.isArrayLike(expr)) {
                    for (i = 0; i < expr.length; i++) {
                        result.push(options.fn(options.scope.add({
                            "@index": i
                        }).add(expr[i])));
                    }
                } else if (utils.isObserveLike(expr)) {
                    keys = can.Map.keys(expr);
                    for (i = 0; i < keys.length; i++) {
                        key = keys[i];
                        result.push(options.fn(options.scope.add({
                            "@key": key
                        }).add(expr[key])));
                    }
                } else if (expr instanceof Object) {
                    for (key in expr) {
                        result.push(options.fn(options.scope.add({
                            "@key": key
                        }).add(expr[key])));
                    }
                }
                return result;
            },
            "@index": function(offset, options) {
                if (!options) {
                    options = offset;
                    offset = 0;
                }
                var index = options.scope.attr("@index");
                return "" + ((can.isFunction(index) ? index() : index) + offset);
            },
            "if": function(expr, options) {
                var value;
                if (can.isFunction(expr)) {
                    value = can.compute.truthy(expr)();
                } else {
                    value = !!resolve(expr);
                }
                if (value) {
                    return options.fn(options.scope || this);
                } else {
                    return options.inverse(options.scope || this);
                }
            },
            unless: function(expr, options) {
                return helpers["if"].apply(this, [ can.isFunction(expr) ? can.compute(function() {
                    return !expr();
                }) : !expr, options ]);
            },
            "with": function(expr, options) {
                var ctx = expr;
                expr = resolve(expr);
                if (!!expr) {
                    return options.fn(ctx);
                }
            },
            log: function(expr, options) {
                if (typeof console !== "undefined" && console.log) {
                    if (!options) {
                        console.log(expr.context);
                    } else {
                        console.log(expr, options.context);
                    }
                }
            },
            data: function(attr) {
                var data = arguments.length === 2 ? this : arguments[1];
                return function(el) {
                    can.data(can.$(el), attr, data || this.context);
                };
            }
        };
        return {
            registerHelper: function(name, callback) {
                helpers[name] = callback;
            },
            getHelper: function(name, options) {
                var helper = options.attr("helpers." + name);
                if (!helper) {
                    helper = helpers[name];
                }
                if (helper) {
                    return {
                        fn: helper
                    };
                }
            }
        };
    }(__m2, __m37, __m26);
    var __m38 = function(can, utils, mustacheHelpers, live, elements, Scope, nodeLists) {
        live = live || can.view.live;
        elements = elements || can.view.elements;
        Scope = Scope || can.view.Scope;
        nodeLists = nodeLists || can.view.nodeLists;
        var argumentsRegExp = /((([^'"\s]+?=)?('.*?'|".*?"))|.*?)\s/g, literalNumberStringBooleanRegExp = /^(?:(?:('.*?'|".*?")|([0-9]+\.?[0-9]*|true|false|null|undefined))|(?:(.+?)=(?:(?:('.*?'|".*?")|([0-9]+\.?[0-9]*|true|false|null|undefined))|(.+))))$/, mustacheLineBreakRegExp = /(?:(?:^|(\r?)\n)(\s*)(\{\{([^\}]*)\}\}\}?)([^\S\n\r]*)($|\r?\n))|(\{\{([^\}]*)\}\}\}?)/g, isLookup = function(obj) {
            return obj && typeof obj.get === "string";
        }, getItemsFragContent = function(items, isObserveList, helperOptions, options) {
            var frag = document.createDocumentFragment();
            for (var i = 0, len = items.length; i < len; i++) {
                append(frag, helperOptions.fn(isObserveList ? items.attr("" + i) : items[i], options));
            }
            return frag;
        }, append = function(frag, content) {
            if (content) {
                frag.appendChild(typeof content === "string" ? document.createTextNode(content) : content);
            }
        }, getItemsStringContent = function(items, isObserveList, helperOptions, options) {
            var txt = "";
            for (var i = 0, len = items.length; i < len; i++) {
                txt += helperOptions.fn(isObserveList ? items.attr("" + i) : items[i], options);
            }
            return txt;
        }, getKeyComputeData = function(key, scope, isArgument) {
            var data = scope.computeData(key, {
                isArgument: isArgument,
                args: [ scope.attr("."), scope ]
            });
            can.compute.temporarilyBind(data.compute);
            return data;
        }, getKeyArgValue = function(key, scope) {
            var data = getKeyComputeData(key, scope, true);
            if (!data.compute.hasDependencies) {
                return data.initialValue;
            } else {
                return data.compute;
            }
        }, convertToScopes = function(helperOptions, scope, options, nodeList, truthyRenderer, falseyRenderer) {
            if (truthyRenderer) {
                helperOptions.fn = makeRendererConvertScopes(truthyRenderer, scope, options, nodeList);
            }
            if (falseyRenderer) {
                helperOptions.inverse = makeRendererConvertScopes(falseyRenderer, scope, options, nodeList);
            }
        }, makeRendererConvertScopes = function(renderer, parentScope, parentOptions, nodeList) {
            var rendererWithScope = function(ctx, opts, parentNodeList) {
                return renderer(ctx || parentScope, opts, parentNodeList);
            };
            return function(newScope, newOptions, parentNodeList) {
                var reads = can.__clearReading();
                if (newScope !== undefined && !(newScope instanceof can.view.Scope)) {
                    newScope = parentScope.add(newScope);
                }
                if (newOptions !== undefined && !(newOptions instanceof core.Options)) {
                    newOptions = parentOptions.add(newOptions);
                }
                var result = rendererWithScope(newScope, newOptions || parentOptions, parentNodeList || nodeList);
                can.__setReading(reads);
                return result;
            };
        };
        var core = {
            expressionData: function(expression) {
                var args = [], hashes = {}, i = 0;
                (can.trim(expression) + " ").replace(argumentsRegExp, function(whole, arg) {
                    var m;
                    if (i && (m = arg.match(literalNumberStringBooleanRegExp))) {
                        if (m[1] || m[2]) {
                            args.push(utils.jsonParse(m[1] || m[2]));
                        } else {
                            hashes[m[3]] = m[6] ? {
                                get: m[6]
                            } : utils.jsonParse(m[4] || m[5]);
                        }
                    } else {
                        args.push({
                            get: arg
                        });
                    }
                    i++;
                });
                return {
                    name: args.shift(),
                    args: args,
                    hash: hashes
                };
            },
            makeEvaluator: function(scope, options, nodeList, mode, exprData, truthyRenderer, falseyRenderer, stringOnly) {
                var args = [], hash = {}, helperOptions = {
                    fn: function() {},
                    inverse: function() {}
                }, context = scope.attr("."), name = exprData.name, helper, looksLikeAHelper = exprData.args.length || !can.isEmptyObject(exprData.hash), initialValue;
                for (var i = 0, len = exprData.args.length; i < len; i++) {
                    var arg = exprData.args[i];
                    if (arg && isLookup(arg)) {
                        args.push(getKeyArgValue(arg.get, scope, true));
                    } else {
                        args.push(arg);
                    }
                }
                for (var prop in exprData.hash) {
                    if (isLookup(exprData.hash[prop])) {
                        hash[prop] = getKeyArgValue(exprData.hash[prop].get, scope);
                    } else {
                        hash[prop] = exprData.hash[prop];
                    }
                }
                if (isLookup(name)) {
                    if (looksLikeAHelper) {
                        helper = mustacheHelpers.getHelper(name.get, options);
                        if (!helper && typeof context[name.get] === "function") {
                            helper = {
                                fn: context[name.get]
                            };
                        }
                    }
                    if (!helper) {
                        var get = name.get;
                        var computeData = getKeyComputeData(name.get, scope, false), compute = computeData.compute;
                        initialValue = computeData.initialValue;
                        if (computeData.reads && computeData.reads.length === 1 && computeData.root instanceof can.Map && !can.isFunction(computeData.root[computeData.reads[0]])) {
                            compute = can.compute(computeData.root, computeData.reads[0]);
                        }
                        if (computeData.compute.hasDependencies) {
                            name = compute;
                        } else {
                            name = initialValue;
                        }
                        if (!looksLikeAHelper && initialValue === undefined) {
                            helper = mustacheHelpers.getHelper(get, options);
                        } else if (typeof initialValue === "function") {
                            helper = {
                                fn: initialValue
                            };
                        }
                    }
                }
                if (mode === "^") {
                    var temp = truthyRenderer;
                    truthyRenderer = falseyRenderer;
                    falseyRenderer = temp;
                }
                if (helper) {
                    convertToScopes(helperOptions, scope, options, nodeList, truthyRenderer, falseyRenderer);
                    can.simpleExtend(helperOptions, {
                        context: context,
                        scope: scope,
                        contexts: scope,
                        hash: hash,
                        nodeList: nodeList
                    });
                    args.push(helperOptions);
                    return function() {
                        return helper.fn.apply(context, args) || "";
                    };
                }
                if (!mode) {
                    if (name && name.isComputed) {
                        return name;
                    } else {
                        return function() {
                            return "" + (name != null ? name : "");
                        };
                    }
                } else if (mode === "#" || mode === "^") {
                    convertToScopes(helperOptions, scope, options, nodeList, truthyRenderer, falseyRenderer);
                    return function() {
                        var value;
                        if (can.isFunction(name) && name.isComputed) {
                            value = name();
                        } else {
                            value = name;
                        }
                        if (utils.isArrayLike(value)) {
                            var isObserveList = utils.isObserveLike(value);
                            if (isObserveList ? value.attr("length") : value.length) {
                                return (stringOnly ? getItemsStringContent : getItemsFragContent)(value, isObserveList, helperOptions, options);
                            } else {
                                return helperOptions.inverse(scope, options);
                            }
                        } else {
                            return value ? helperOptions.fn(value || scope, options) : helperOptions.inverse(scope, options);
                        }
                    };
                } else {}
            },
            makeLiveBindingPartialRenderer: function(partialName, state) {
                partialName = can.trim(partialName);
                return function(scope, options, parentSectionNodeList) {
                    var partial = options.attr("partials." + partialName), res;
                    if (partial) {
                        res = partial.render ? partial.render(scope, options) : partial(scope, options);
                    } else {
                        res = can.view.render(partialName, scope, options);
                    }
                    res = can.frag(res);
                    var nodeList = [ this ];
                    nodeLists.register(nodeList, null, state.directlyNested ? parentSectionNodeList || true : true);
                    nodeLists.update(nodeList, res.childNodes);
                    elements.replace([ this ], res);
                };
            },
            makeStringBranchRenderer: function(mode, expression) {
                var exprData = expressionData(expression), fullExpression = mode + expression;
                return function branchRenderer(scope, options, truthyRenderer, falseyRenderer) {
                    var evaluator = scope.__cache[fullExpression];
                    if (mode || !evaluator) {
                        evaluator = makeEvaluator(scope, options, null, mode, exprData, truthyRenderer, falseyRenderer, true);
                        if (!mode) {
                            scope.__cache[fullExpression] = evaluator;
                        }
                    }
                    var res = evaluator();
                    return res == null ? "" : "" + res;
                };
            },
            makeLiveBindingBranchRenderer: function(mode, expression, state) {
                var exprData = expressionData(expression);
                return function branchRenderer(scope, options, parentSectionNodeList, truthyRenderer, falseyRenderer) {
                    var nodeList = [ this ];
                    nodeList.expression = expression;
                    nodeLists.register(nodeList, null, state.directlyNested ? parentSectionNodeList || true : true);
                    var evaluator = makeEvaluator(scope, options, nodeList, mode, exprData, truthyRenderer, falseyRenderer, state.tag);
                    var compute = can.compute(evaluator, null, false, true);
                    compute.bind("change", can.k);
                    var value = compute();
                    if (typeof value === "function") {
                        var old = can.__clearReading();
                        value(this);
                        can.__setReading(old);
                    } else if (compute.hasDependencies) {
                        if (state.attr) {
                            live.simpleAttribute(this, state.attr, compute);
                        } else if (state.tag) {
                            live.attributes(this, compute);
                        } else if (state.text && typeof value !== "object") {
                            live.text(this, compute, this.parentNode, nodeList);
                        } else {
                            live.html(this, compute, this.parentNode, nodeList);
                        }
                    } else {
                        if (state.attr) {
                            can.attr.set(this, state.attr, value);
                        } else if (state.tag) {
                            live.setAttributes(this, value);
                        } else if (state.text && typeof value === "string") {
                            this.nodeValue = value;
                        } else if (value) {
                            elements.replace([ this ], can.frag(value));
                        }
                    }
                    compute.unbind("change", can.k);
                };
            },
            splitModeFromExpression: function(expression, state) {
                expression = can.trim(expression);
                var mode = expression.charAt(0);
                if ("#/{&^>!".indexOf(mode) >= 0) {
                    expression = can.trim(expression.substr(1));
                } else {
                    mode = null;
                }
                if (mode === "{" && state.node) {
                    mode = null;
                }
                return {
                    mode: mode,
                    expression: expression
                };
            },
            cleanLineEndings: function(template) {
                return template.replace(mustacheLineBreakRegExp, function(whole, returnBefore, spaceBefore, special, expression, spaceAfter, returnAfter, spaceLessSpecial, spaceLessExpression, matchIndex) {
                    spaceAfter = spaceAfter || "";
                    returnBefore = returnBefore || "";
                    spaceBefore = spaceBefore || "";
                    var modeAndExpression = splitModeFromExpression(expression || spaceLessExpression, {});
                    if (spaceLessSpecial || ">{".indexOf(modeAndExpression.mode) >= 0) {
                        return whole;
                    } else if ("^#!/".indexOf(modeAndExpression.mode) >= 0) {
                        return special + (matchIndex !== 0 && returnAfter.length ? returnBefore + "\n" : "");
                    } else {
                        return spaceBefore + special + spaceAfter + (spaceBefore.length || matchIndex !== 0 ? returnBefore + "\n" : "");
                    }
                });
            },
            Options: can.view.Scope.extend({
                init: function(data, parent) {
                    if (!data.helpers && !data.partials && !data.tags) {
                        data = {
                            helpers: data
                        };
                    }
                    can.view.Scope.prototype.init.apply(this, arguments);
                }
            })
        };
        var makeEvaluator = core.makeEvaluator, expressionData = core.expressionData, splitModeFromExpression = core.splitModeFromExpression;
        return core;
    }(__m2, __m37, __m39, __m26, __m24, __m22, __m27);
    var __m36 = function(can, target, utils, mustacheCore) {
        var decodeHTML = function() {
            var el = document.createElement("div");
            return function(html) {
                if (html.indexOf("&") === -1) {
                    return html.replace(/\r\n/g, "\n");
                }
                el.innerHTML = html;
                return el.childNodes.length === 0 ? "" : el.childNodes[0].nodeValue;
            };
        }();
        var HTMLSectionBuilder = function() {
            this.stack = [ new HTMLSection() ];
        };
        can.extend(HTMLSectionBuilder.prototype, utils.mixins);
        can.extend(HTMLSectionBuilder.prototype, {
            startSubSection: function(process) {
                var newSection = new HTMLSection(process);
                this.stack.push(newSection);
                return newSection;
            },
            endSubSectionAndReturnRenderer: function() {
                if (this.last().isEmpty()) {
                    this.stack.pop();
                    return null;
                } else {
                    var htmlSection = this.endSection();
                    return can.proxy(htmlSection.compiled.hydrate, htmlSection.compiled);
                }
            },
            startSection: function(process) {
                var newSection = new HTMLSection(process);
                this.last().add(newSection.targetCallback);
                this.stack.push(newSection);
            },
            endSection: function() {
                this.last().compile();
                return this.stack.pop();
            },
            inverse: function() {
                this.last().inverse();
            },
            compile: function() {
                var compiled = this.stack.pop().compile();
                return function(scope, options) {
                    if (!(scope instanceof can.view.Scope)) {
                        scope = new can.view.Scope(scope || {});
                    }
                    if (!(options instanceof mustacheCore.Options)) {
                        options = new mustacheCore.Options(options || {});
                    }
                    return compiled.hydrate(scope, options);
                };
            },
            push: function(chars) {
                this.last().push(chars);
            },
            pop: function() {
                return this.last().pop();
            }
        });
        var HTMLSection = function(process) {
            this.data = "targetData";
            this.targetData = [];
            this.targetStack = [];
            var self = this;
            this.targetCallback = function(scope, options, sectionNode) {
                process.call(this, scope, options, sectionNode, can.proxy(self.compiled.hydrate, self.compiled), self.inverseCompiled && can.proxy(self.inverseCompiled.hydrate, self.inverseCompiled));
            };
        };
        can.extend(HTMLSection.prototype, {
            inverse: function() {
                this.inverseData = [];
                this.data = "inverseData";
            },
            push: function(data) {
                this.add(data);
                this.targetStack.push(data);
            },
            pop: function() {
                return this.targetStack.pop();
            },
            add: function(data) {
                if (typeof data === "string") {
                    data = decodeHTML(data);
                }
                if (this.targetStack.length) {
                    this.targetStack[this.targetStack.length - 1].children.push(data);
                } else {
                    this[this.data].push(data);
                }
            },
            compile: function() {
                this.compiled = target(this.targetData);
                if (this.inverseData) {
                    this.inverseCompiled = target(this.inverseData);
                    delete this.inverseData;
                }
                delete this.targetData;
                delete this.targetStack;
                return this.compiled;
            },
            children: function() {
                if (this.targetStack.length) {
                    return this.targetStack[this.targetStack.length - 1].children;
                } else {
                    return this[this.data];
                }
            },
            isEmpty: function() {
                return !this.targetData.length;
            }
        });
        return HTMLSectionBuilder;
    }(__m2, __m35, __m37, __m38);
    var __m40 = function(can, live, utils) {
        live = live || can.view.live;
        var TextSectionBuilder = function() {
            this.stack = [ new TextSection() ];
        }, emptyHandler = function() {};
        can.extend(TextSectionBuilder.prototype, utils.mixins);
        can.extend(TextSectionBuilder.prototype, {
            startSection: function(process) {
                var subSection = new TextSection();
                this.last().add({
                    process: process,
                    truthy: subSection
                });
                this.stack.push(subSection);
            },
            endSection: function() {
                this.stack.pop();
            },
            inverse: function() {
                this.stack.pop();
                var falseySection = new TextSection();
                this.last().last().falsey = falseySection;
                this.stack.push(falseySection);
            },
            compile: function(state) {
                var renderer = this.stack[0].compile();
                return function(scope, options) {
                    var compute = can.compute(function() {
                        return renderer(scope, options);
                    }, this, false, true);
                    compute.bind("change", emptyHandler);
                    var value = compute();
                    if (compute.hasDependencies) {
                        if (state.attr) {
                            live.simpleAttribute(this, state.attr, compute);
                        } else {
                            live.attributes(this, compute);
                        }
                        compute.unbind("change", emptyHandler);
                    } else {
                        if (state.attr) {
                            can.attr.set(this, state.attr, value);
                        } else {
                            live.setAttributes(this, value);
                        }
                    }
                };
            }
        });
        var passTruthyFalsey = function(process, truthy, falsey) {
            return function(scope, options) {
                return process.call(this, scope, options, truthy, falsey);
            };
        };
        var TextSection = function() {
            this.values = [];
        };
        can.extend(TextSection.prototype, {
            add: function(data) {
                this.values.push(data);
            },
            last: function() {
                return this.values[this.values.length - 1];
            },
            compile: function() {
                var values = this.values, len = values.length;
                for (var i = 0; i < len; i++) {
                    var value = this.values[i];
                    if (typeof value === "object") {
                        values[i] = passTruthyFalsey(value.process, value.truthy && value.truthy.compile(), value.falsey && value.falsey.compile());
                    }
                }
                return function(scope, options) {
                    var txt = "", value;
                    for (var i = 0; i < len; i++) {
                        value = values[i];
                        txt += typeof value === "string" ? value : value.call(this, scope, options);
                    }
                    return txt;
                };
            }
        });
        return TextSectionBuilder;
    }(__m2, __m26, __m37);
    var __m34 = function(can, parser, target, HTMLSectionBuilder, TextSectionBuilder, mustacheCore, mustacheHelpers, viewCallbacks) {
        parser = parser || can.view.parser;
        viewCallbacks = viewCallbacks || can.view.callbacks;
        function stache(template) {
            template = mustacheCore.cleanLineEndings(template);
            var section = new HTMLSectionBuilder(), state = {
                node: null,
                attr: null,
                sectionElementStack: [],
                text: false
            }, makeRendererAndUpdateSection = function(section, mode, stache) {
                if (mode === ">") {
                    section.add(mustacheCore.makeLiveBindingPartialRenderer(stache, state));
                } else if (mode === "/") {
                    section.endSection();
                    if (section instanceof HTMLSectionBuilder) {
                        state.sectionElementStack.pop();
                    }
                } else if (mode === "else") {
                    section.inverse();
                } else {
                    var makeRenderer = section instanceof HTMLSectionBuilder ? mustacheCore.makeLiveBindingBranchRenderer : mustacheCore.makeStringBranchRenderer;
                    if (mode === "{" || mode === "&") {
                        section.add(makeRenderer(null, stache, copyState()));
                    } else if (mode === "#" || mode === "^") {
                        section.startSection(makeRenderer(mode, stache, copyState()));
                        if (section instanceof HTMLSectionBuilder) {
                            state.sectionElementStack.push("section");
                        }
                    } else {
                        section.add(makeRenderer(null, stache, copyState({
                            text: true
                        })));
                    }
                }
            }, copyState = function(overwrites) {
                var cur = {
                    tag: state.node && state.node.tag,
                    attr: state.attr && state.attr.name,
                    directlyNested: state.sectionElementStack[state.sectionElementStack.length - 1] === "section"
                };
                return overwrites ? can.simpleExtend(cur, overwrites) : cur;
            }, addAttributesCallback = function(node, callback) {
                if (!node.attributes) {
                    node.attributes = [];
                }
                node.attributes.push(callback);
            };
            parser(template, {
                start: function(tagName, unary) {
                    state.node = {
                        tag: tagName,
                        children: []
                    };
                },
                end: function(tagName, unary) {
                    var isCustomTag = viewCallbacks.tag(tagName);
                    if (unary) {
                        section.add(state.node);
                        if (isCustomTag) {
                            addAttributesCallback(state.node, function(scope, options) {
                                viewCallbacks.tagHandler(this, tagName, {
                                    scope: scope,
                                    options: options,
                                    subtemplate: null,
                                    templateType: "stache"
                                });
                            });
                        }
                    } else {
                        section.push(state.node);
                        state.sectionElementStack.push("element");
                        if (isCustomTag) {
                            section.startSubSection();
                        }
                    }
                    state.node = null;
                },
                close: function(tagName) {
                    var isCustomTag = viewCallbacks.tag(tagName), renderer;
                    if (isCustomTag) {
                        renderer = section.endSubSectionAndReturnRenderer();
                    }
                    var oldNode = section.pop();
                    if (isCustomTag) {
                        addAttributesCallback(oldNode, function(scope, options) {
                            viewCallbacks.tagHandler(this, tagName, {
                                scope: scope,
                                options: options,
                                subtemplate: renderer,
                                templateType: "stache"
                            });
                        });
                    }
                    state.sectionElementStack.pop();
                },
                attrStart: function(attrName) {
                    if (state.node.section) {
                        state.node.section.add(attrName + '="');
                    } else {
                        state.attr = {
                            name: attrName,
                            value: ""
                        };
                    }
                },
                attrEnd: function(attrName) {
                    if (state.node.section) {
                        state.node.section.add('" ');
                    } else {
                        if (!state.node.attrs) {
                            state.node.attrs = {};
                        }
                        state.node.attrs[state.attr.name] = state.attr.section ? state.attr.section.compile(copyState()) : state.attr.value;
                        var attrCallback = viewCallbacks.attr(attrName);
                        if (attrCallback) {
                            if (!state.node.attributes) {
                                state.node.attributes = [];
                            }
                            state.node.attributes.push(function(scope, options) {
                                attrCallback(this, {
                                    attributeName: attrName,
                                    scope: scope,
                                    options: options
                                });
                            });
                        }
                        state.attr = null;
                    }
                },
                attrValue: function(value) {
                    var section = state.node.section || state.attr.section;
                    if (section) {
                        section.add(value);
                    } else {
                        state.attr.value += value;
                    }
                },
                chars: function(text) {
                    section.add(text);
                },
                special: function(text) {
                    var firstAndText = mustacheCore.splitModeFromExpression(text, state), mode = firstAndText.mode, expression = firstAndText.expression;
                    if (expression === "else") {
                        (state.attr && state.attr.section ? state.attr.section : section).inverse();
                        return;
                    }
                    if (mode === "!") {
                        return;
                    }
                    if (state.node && state.node.section) {
                        makeRendererAndUpdateSection(state.node.section, mode, expression);
                        if (state.node.section.subSectionDepth() === 0) {
                            state.node.attributes.push(state.node.section.compile(copyState()));
                            delete state.node.section;
                        }
                    } else if (state.attr) {
                        if (!state.attr.section) {
                            state.attr.section = new TextSectionBuilder();
                            if (state.attr.value) {
                                state.attr.section.add(state.attr.value);
                            }
                        }
                        makeRendererAndUpdateSection(state.attr.section, mode, expression);
                    } else if (state.node) {
                        if (!state.node.attributes) {
                            state.node.attributes = [];
                        }
                        if (!mode) {
                            state.node.attributes.push(mustacheCore.makeLiveBindingBranchRenderer(null, expression, copyState()));
                        } else if (mode === "#" || mode === "^") {
                            if (!state.node.section) {
                                state.node.section = new TextSectionBuilder();
                            }
                            makeRendererAndUpdateSection(state.node.section, mode, expression);
                        } else {
                            throw mode + " is currently not supported within a tag.";
                        }
                    } else {
                        makeRendererAndUpdateSection(section, mode, expression);
                    }
                },
                comment: function(text) {
                    section.add({
                        comment: text
                    });
                },
                done: function() {}
            });
            return section.compile();
        }
        var escMap = {
            "\n": "\\n",
            "\r": "\\r",
            "\u2028": "\\u2028",
            "\u2029": "\\u2029"
        };
        var esc = function(string) {
            return ("" + string).replace(/["'\\\n\r\u2028\u2029]/g, function(character) {
                if ("'\"\\".indexOf(character) >= 0) {
                    return "\\" + character;
                } else {
                    return escMap[character];
                }
            });
        };
        can.view.register({
            suffix: "stache",
            contentType: "x-stache-template",
            fragRenderer: function(id, text) {
                return stache(text);
            },
            script: function(id, src) {
                return 'can.stache("' + esc(src) + '")';
            }
        });
        can.view.ext = ".stache";
        can.extend(can.stache, mustacheHelpers);
        can.extend(stache, mustacheHelpers);
        can.stache.safeString = stache.safeString = function(text) {
            return {
                toString: function() {
                    return text;
                }
            };
        };
        return stache;
    }(__m2, __m28, __m35, __m36, __m40, __m38, __m39, __m9);
    var __m41 = function(can, Construct) {
        var isFunction = can.isFunction, fnTest = /xyz/.test(function() {
            return this.xyz;
        }) ? /\b_super\b/ : /.*/, getset = [ "get", "set" ], getSuper = function(base, name, fn) {
            return function() {
                var tmp = this._super, ret;
                this._super = base[name];
                ret = fn.apply(this, arguments);
                this._super = tmp;
                return ret;
            };
        };
        can.Construct._defineProperty = function(addTo, base, name, descriptor) {
            var _super = Object.getOwnPropertyDescriptor(base, name);
            if (_super) {
                can.each(getset, function(method) {
                    if (isFunction(_super[method]) && isFunction(descriptor[method])) {
                        descriptor[method] = getSuper(_super, method, descriptor[method]);
                    } else if (!isFunction(descriptor[method])) {
                        descriptor[method] = _super[method];
                    }
                });
            }
            Object.defineProperty(addTo, name, descriptor);
        };
        can.Construct._overwrite = function(addTo, base, name, val) {
            addTo[name] = isFunction(val) && isFunction(base[name]) && fnTest.test(val) ? getSuper(base, name, val) : val;
        };
        return can;
    }(__m2, __m12);
    var __m42 = function(can, Construct) {
        var isFunction = can.isFunction, isArray = can.isArray, makeArray = can.makeArray, proxy = function(funcs) {
            var args = makeArray(arguments), self;
            funcs = args.shift();
            if (!isArray(funcs)) {
                funcs = [ funcs ];
            }
            self = this;
            return function class_cb() {
                var cur = args.concat(makeArray(arguments)), isString, length = funcs.length, f = 0, func;
                for (;f < length; f++) {
                    func = funcs[f];
                    if (!func) {
                        continue;
                    }
                    isString = typeof func === "string";
                    cur = (isString ? self[func] : func).apply(self, cur || []);
                    if (f < length - 1) {
                        cur = !isArray(cur) || cur._use_call ? [ cur ] : cur;
                    }
                }
                return cur;
            };
        };
        can.Construct.proxy = can.Construct.prototype.proxy = proxy;
        var correctedClasses = [ can.Map, can.Control, can.Model ], i = 0;
        for (;i < correctedClasses.length; i++) {
            if (correctedClasses[i]) {
                correctedClasses[i].proxy = proxy;
            }
        }
        return can;
    }(__m2, __m12);
    var __m43 = function(can, Map) {
        can.each([ can.Map, can.Model ], function(clss) {
            if (clss === undefined) {
                return;
            }
            var isObject = function(obj) {
                return typeof obj === "object" && obj !== null && obj;
            };
            can.extend(clss, {
                attributes: {},
                convert: {
                    date: function(str) {
                        var type = typeof str;
                        if (type === "string") {
                            str = Date.parse(str);
                            return isNaN(str) ? null : new Date(str);
                        } else if (type === "number") {
                            return new Date(str);
                        } else {
                            return str;
                        }
                    },
                    number: function(val) {
                        return parseFloat(val);
                    },
                    "boolean": function(val) {
                        if (val === "false" || val === "0" || !val) {
                            return false;
                        }
                        return true;
                    },
                    "default": function(val, oldVal, error, type) {
                        if (can.Map.prototype.isPrototypeOf(type.prototype) && typeof type.model === "function" && typeof type.models === "function") {
                            return type[can.isArray(val) ? "models" : "model"](val);
                        }
                        if (can.Map.prototype.isPrototypeOf(type.prototype)) {
                            if (can.isArray(val) && typeof type.List === "function") {
                                return new type.List(val);
                            }
                            return new type(val);
                        }
                        if (typeof type === "function") {
                            return type(val, oldVal);
                        }
                        var construct = can.getObject(type), context = window, realType;
                        if (type.indexOf(".") >= 0) {
                            realType = type.substring(0, type.lastIndexOf("."));
                            context = can.getObject(realType);
                        }
                        return typeof construct === "function" ? construct.call(context, val, oldVal) : val;
                    }
                },
                serialize: {
                    "default": function(val, type) {
                        return isObject(val) && val.serialize ? val.serialize() : val;
                    },
                    date: function(val) {
                        return val && val.getTime();
                    }
                }
            });
            var oldSetup = clss.setup;
            clss.setup = function(superClass, stat, proto) {
                var self = this;
                oldSetup.call(self, superClass, stat, proto);
                can.each([ "attributes" ], function(name) {
                    if (!self[name] || superClass[name] === self[name]) {
                        self[name] = {};
                    }
                });
                can.each([ "convert", "serialize" ], function(name) {
                    if (superClass[name] !== self[name]) {
                        self[name] = can.extend({}, superClass[name], self[name]);
                    }
                });
            };
        });
        can.Map.prototype.__convert = function(prop, value) {
            var Class = this.constructor, oldVal = this.__get(prop), type, converter;
            if (Class.attributes) {
                type = Class.attributes[prop];
                converter = Class.convert[type] || Class.convert["default"];
            }
            return value === null || !type ? value : converter.call(Class, value, oldVal, function() {}, type);
        };
        var oldSerialize = can.Map.helpers._serialize;
        can.Map.helpers._serialize = function(map, name, val) {
            var constructor = map.constructor, type = constructor.attributes ? constructor.attributes[name] : 0, converter = constructor.serialize ? constructor.serialize[type] : 0;
            return val && typeof val.serialize === "function" ? oldSerialize.apply(this, arguments) : converter ? converter(val, type) : oldSerialize.apply(this, arguments);
        };
        var mapSerialize = can.Map.prototype.serialize;
        can.Map.prototype.serialize = function(attrName) {
            var baseResult = mapSerialize.apply(this, arguments);
            if (attrName) {
                return baseResult[attrName];
            } else {
                return baseResult;
            }
        };
        return can.Map;
    }(__m2, __m15, __m19);
    var __m44 = function(can) {
        can.extend(can.List.prototype, {
            filter: function(callback) {
                var filtered = new this.constructor();
                var self = this;
                var generator = function(element, index) {
                    var binder = function(ev, val) {
                        var index = filtered.indexOf(element);
                        if (!val && index !== -1) {
                            filtered.splice(index, 1);
                        }
                        if (val && index === -1) {
                            filtered.push(element);
                        }
                    };
                    var compute = can.compute(function() {
                        return callback(element, self.indexOf(element), self);
                    });
                    compute.bind("change", binder);
                    binder(null, compute());
                };
                this.bind("add", function(ev, data, index) {
                    can.each(data, function(element, i) {
                        generator(element, index + i);
                    });
                });
                this.bind("remove", function(ev, data, index) {
                    can.each(data, function(element, i) {
                        var index = filtered.indexOf(element);
                        if (index !== -1) {
                            filtered.splice(index, 1);
                        }
                    });
                });
                this.forEach(generator);
                return filtered;
            },
            map: function(callback) {
                var mapped = new can.List();
                var self = this;
                var generator = function(element, index) {
                    var compute = can.compute(function() {
                        return callback(element, index, self);
                    });
                    compute.bind("change", function(ev, val) {
                        mapped.splice(index, 1, val);
                    });
                    mapped.splice(index, 0, compute());
                };
                this.forEach(generator);
                this.bind("add", function(ev, data, index) {
                    can.each(data, function(element, i) {
                        generator(element, index + i);
                    });
                });
                this.bind("remove", function(ev, data, index) {
                    mapped.splice(index, data.length);
                });
                return mapped;
            }
        });
        return can.List;
    }(__m2, __m15, __m19, __m20);
    var __m45 = function(can) {
        can.Map.helpers.define = function(Map) {
            var define = Map.prototype.define;
            Map.defaultGenerators = {};
            for (var prop in define) {
                if ("value" in define[prop]) {
                    if (typeof define[prop].value === "function") {
                        Map.defaultGenerators[prop] = define[prop].value;
                    } else {
                        Map.defaults[prop] = define[prop].value;
                    }
                }
                if (typeof define[prop].Value === "function") {
                    (function(Constructor) {
                        Map.defaultGenerators[prop] = function() {
                            return new Constructor();
                        };
                    })(define[prop].Value);
                }
            }
        };
        var oldSetupDefaults = can.Map.prototype._setupDefaults;
        can.Map.prototype._setupDefaults = function(obj) {
            var defaults = oldSetupDefaults.call(this), propsCommittedToAttr = {}, Map = this.constructor, originalGet = this._get;
            this._get = function(originalProp) {
                prop = originalProp.indexOf(".") !== -1 ? originalProp.substr(0, originalProp.indexOf(".")) : prop;
                if (prop in defaults && !(prop in propsCommittedToAttr)) {
                    this.attr(prop, defaults[prop]);
                    propsCommittedToAttr[prop] = true;
                }
                return originalGet.apply(this, arguments);
            };
            for (var prop in Map.defaultGenerators) {
                if (!obj || !(prop in obj)) {
                    defaults[prop] = Map.defaultGenerators[prop].call(this);
                }
            }
            this._get = originalGet;
            return defaults;
        };
        var proto = can.Map.prototype, oldSet = proto.__set;
        proto.__set = function(prop, value, current, success, error) {
            var errorCallback = function(errors) {
                var stub = error && error.call(self, errors);
                if (stub !== false) {
                    can.trigger(self, "error", [ prop, errors ], true);
                }
                return false;
            }, self = this, define = this.define && this.define[prop], setter = define && define.set, getter = define && define.get;
            if (setter) {
                can.batch.start();
                var setterCalled = false, setValue = setter.call(this, value, function(value) {
                    oldSet.call(self, prop, value, current, success, errorCallback);
                    setterCalled = true;
                }, errorCallback);
                if (getter) {
                    can.batch.stop();
                    return;
                } else if (setValue === undefined && !setterCalled && setter.length >= 2) {
                    can.batch.stop();
                    return;
                } else {
                    if (!setterCalled) {
                        oldSet.call(self, prop, setter.length === 0 && setValue === undefined ? value : setValue, current, success, errorCallback);
                    }
                    can.batch.stop();
                    return this;
                }
            } else {
                oldSet.call(self, prop, value, current, success, errorCallback);
            }
            return this;
        };
        var converters = {
            date: function(str) {
                var type = typeof str;
                if (type === "string") {
                    str = Date.parse(str);
                    return isNaN(str) ? null : new Date(str);
                } else if (type === "number") {
                    return new Date(str);
                } else {
                    return str;
                }
            },
            number: function(val) {
                return +val;
            },
            "boolean": function(val) {
                if (val === "false" || val === "0" || !val) {
                    return false;
                }
                return true;
            },
            "*": function(val) {
                return val;
            },
            string: function(val) {
                return "" + val;
            }
        };
        var oldType = proto.__type;
        proto.__type = function(value, prop) {
            var def = this.define && this.define[prop], type = def && def.type, Type = def && def.Type, newValue = value;
            if (typeof type === "string") {
                type = converters[type];
            }
            if (type || Type) {
                if (type) {
                    newValue = type.call(this, newValue, prop);
                }
                if (Type && !(newValue instanceof Type)) {
                    newValue = new Type(newValue);
                }
                return newValue;
            }
            return oldType.call(this, newValue, prop);
        };
        var oldRemove = proto._remove;
        proto._remove = function(prop, current) {
            var remove = this.define && this.define[prop] && this.define[prop].remove, res;
            if (remove) {
                can.batch.start();
                res = remove.call(this, current);
                if (res === false) {
                    can.batch.stop();
                    return;
                } else {
                    res = oldRemove.call(this, prop, current);
                    can.batch.stop();
                    return res;
                }
            }
            return oldRemove.call(this, prop, current);
        };
        var oldSetupComputes = proto._setupComputes;
        proto._setupComputes = function(defaultsValues) {
            oldSetupComputes.apply(this, arguments);
            for (var attr in this.define) {
                var def = this.define[attr], get = def.get;
                if (get) {
                    this[attr] = can.compute.async(defaultsValues[attr], get, this);
                    this._computedBindings[attr] = {
                        count: 0
                    };
                }
            }
        };
        var oldSingleSerialize = can.Map.helpers._serialize;
        can.Map.helpers._serialize = function(map, name, val) {
            return serializeProp(map, name, val);
        };
        var serializeProp = function(map, attr, val) {
            var serializer = map.define && map.define[attr] && map.define[attr].serialize;
            if (serializer === undefined) {
                return oldSingleSerialize.apply(this, arguments);
            } else if (serializer !== false) {
                return typeof serializer === "function" ? serializer.call(map, val, attr) : oldSingleSerialize.apply(this, arguments);
            }
        };
        var oldSerialize = proto.serialize;
        proto.serialize = function(property) {
            var serialized = oldSerialize.apply(this, arguments);
            if (property) {
                return serialized;
            }
            var serializer, val;
            for (var attr in this.define) {
                if (!(attr in serialized)) {
                    serializer = this.define && this.define[attr] && this.define[attr].serialize;
                    if (serializer) {
                        val = serializeProp(this, attr, this.attr(attr));
                        if (val !== undefined) {
                            serialized[attr] = val;
                        }
                    }
                }
            }
            return serialized;
        };
        return can.Map;
    }(__m2, __m14);
    var __m46 = function(can) {
        var oldBubbleRule = can.List._bubbleRule;
        can.List._bubbleRule = function(eventName, list) {
            if (list.comparator) {
                return "change";
            }
            return oldBubbleRule.apply(this, arguments);
        };
        if (can.Model) {
            var oldModelListBubble = can.Model.List._bubbleRule;
            can.Model.List._bubbleRule = function(eventName, list) {
                if (list.comparator) {
                    return "change";
                }
                return oldModelListBubble.apply(this, arguments);
            };
        }
        var proto = can.List.prototype, _changes = proto._changes, setup = proto.setup;
        can.extend(proto, {
            comparator: undefined,
            sortIndexes: [],
            sortedIndex: function(item) {
                var itemCompare = item.attr(this.comparator), equaled = 0;
                for (var i = 0, length = this.length; i < length; i++) {
                    if (item === this[i]) {
                        equaled = -1;
                        continue;
                    }
                    if (itemCompare <= this[i].attr(this.comparator)) {
                        return i + equaled;
                    }
                }
                return i + equaled;
            },
            sort: function(method, silent) {
                var comparator = this.comparator, args = comparator ? [ function(a, b) {
                    a = typeof a[comparator] === "function" ? a[comparator]() : a[comparator];
                    b = typeof b[comparator] === "function" ? b[comparator]() : b[comparator];
                    return a === b ? 0 : a < b ? -1 : 1;
                } ] : [ method ];
                if (!silent) {
                    can.trigger(this, "reset");
                }
                return Array.prototype.sort.apply(this, args);
            }
        });
        var getArgs = function(args) {
            return args[0] && can.isArray(args[0]) ? args[0] : can.makeArray(args);
        };
        can.each({
            push: "length",
            unshift: 0
        }, function(where, name) {
            var proto = can.List.prototype, old = proto[name];
            proto[name] = function() {
                var args = getArgs(arguments), len = where ? this.length : 0;
                var res = old.apply(this, arguments);
                if (this.comparator && args.length) {
                    this.sort(null, true);
                    can.batch.trigger(this, "reset", [ args ]);
                    this._triggerChange("" + len, "add", args, undefined);
                }
                return res;
            };
        });
        proto._changes = function(ev, attr, how, newVal, oldVal) {
            if (this.comparator && /^\d+./.test(attr)) {
                var index = +/^\d+/.exec(attr)[0], item = this[index];
                if (typeof item !== "undefined") {
                    var newIndex = this.sortedIndex(item);
                    if (newIndex !== index) {
                        [].splice.call(this, index, 1);
                        [].splice.call(this, newIndex, 0, item);
                        can.trigger(this, "move", [ item, newIndex, index ]);
                        can.trigger(this, "change", [ attr.replace(/^\d+/, newIndex), how, newVal, oldVal ]);
                        return;
                    }
                }
            }
            _changes.apply(this, arguments);
        };
        proto.setup = function(instances, options) {
            setup.apply(this, arguments);
            if (this.comparator) {
                this.sort();
            }
        };
        return can.Map;
    }(__m2, __m19);
    var __m47 = function($, can) {
        var convert, modify, isTemplate, isHTML, isDOM, getCallback, noHookup = {
            val: true,
            text: true
        };
        convert = function(func_name) {
            var old = $.fn[func_name];
            $.fn[func_name] = function() {
                var args = can.makeArray(arguments), callbackNum, callback, self = this, result;
                if (can.isDeferred(args[0])) {
                    args[0].done(function(res) {
                        modify.call(self, [ res ], old);
                    });
                    return this;
                } else if (isTemplate(args)) {
                    if (callbackNum = getCallback(args)) {
                        callback = args[callbackNum];
                        args[callbackNum] = function(result) {
                            modify.call(self, [ result ], old);
                            callback.call(self, result);
                        };
                        can.view.apply(can.view, args);
                        return this;
                    }
                    result = can.view.apply(can.view, args);
                    if (!can.isDeferred(result)) {
                        args = [ result ];
                    } else {
                        result.done(function(res) {
                            modify.call(self, [ res ], old);
                        });
                        return this;
                    }
                }
                return noHookup[func_name] ? old.apply(this, args) : modify.call(this, args, old);
            };
        };
        modify = function(args, old) {
            var res;
            for (var hasHookups in can.view.hookups) {
                break;
            }
            if (hasHookups && args[0] && isHTML(args[0])) {
                args[0] = can.view.frag(args[0]).childNodes;
            }
            res = old.apply(this, args);
            return res;
        };
        isTemplate = function(args) {
            var secArgType = typeof args[1];
            return typeof args[0] === "string" && (secArgType === "object" || secArgType === "function") && !isDOM(args[1]);
        };
        isDOM = function(arg) {
            return arg.nodeType || arg[0] && arg[0].nodeType;
        };
        isHTML = function(arg) {
            if (isDOM(arg)) {
                return true;
            } else if (typeof arg === "string") {
                arg = can.trim(arg);
                return arg.substr(0, 1) === "<" && arg.substr(arg.length - 1, 1) === ">" && arg.length >= 3;
            } else {
                return false;
            }
        };
        getCallback = function(args) {
            return typeof args[3] === "function" ? 3 : typeof args[2] === "function" && 2;
        };
        $.fn.hookup = function() {
            can.view.frag(this);
            return this;
        };
        can.each([ "prepend", "append", "after", "before", "text", "html", "replaceWith", "val" ], function(func) {
            convert(func);
        });
        return can;
    }(jQuery, __m2, __m10);
    var __m48 = function(can) {
        var isArray = can.isArray;
        can.Object = {};
        var same = can.Object.same = function(a, b, compares, aParent, bParent, deep) {
            var aType = typeof a, aArray = isArray(a), comparesType = typeof compares, compare;
            if (comparesType === "string" || compares === null) {
                compares = compareMethods[compares];
                comparesType = "function";
            }
            if (comparesType === "function") {
                return compares(a, b, aParent, bParent);
            }
            compares = compares || {};
            if (a === null || b === null) {
                return a === b;
            }
            if (a instanceof Date || b instanceof Date) {
                return a === b;
            }
            if (deep === -1) {
                return aType === "object" || a === b;
            }
            if (aType !== typeof b || aArray !== isArray(b)) {
                return false;
            }
            if (a === b) {
                return true;
            }
            if (aArray) {
                if (a.length !== b.length) {
                    return false;
                }
                for (var i = 0; i < a.length; i++) {
                    compare = compares[i] === undefined ? compares["*"] : compares[i];
                    if (!same(a[i], b[i], a, b, compare)) {
                        return false;
                    }
                }
                return true;
            } else if (aType === "object" || aType === "function") {
                var bCopy = can.extend({}, b);
                for (var prop in a) {
                    compare = compares[prop] === undefined ? compares["*"] : compares[prop];
                    if (!same(a[prop], b[prop], compare, a, b, deep === false ? -1 : undefined)) {
                        return false;
                    }
                    delete bCopy[prop];
                }
                for (prop in bCopy) {
                    if (compares[prop] === undefined || !same(undefined, b[prop], compares[prop], a, b, deep === false ? -1 : undefined)) {
                        return false;
                    }
                }
                return true;
            }
            return false;
        };
        can.Object.subsets = function(checkSet, sets, compares) {
            var len = sets.length, subsets = [];
            for (var i = 0; i < len; i++) {
                var set = sets[i];
                if (can.Object.subset(checkSet, set, compares)) {
                    subsets.push(set);
                }
            }
            return subsets;
        };
        can.Object.subset = function(subset, set, compares) {
            compares = compares || {};
            for (var prop in set) {
                if (!same(subset[prop], set[prop], compares[prop], subset, set)) {
                    return false;
                }
            }
            return true;
        };
        var compareMethods = {
            "null": function() {
                return true;
            },
            i: function(a, b) {
                return ("" + a).toLowerCase() === ("" + b).toLowerCase();
            },
            eq: function(a, b) {
                return a === b;
            },
            similar: function(a, b) {
                return a == b;
            }
        };
        compareMethods.eqeq = compareMethods.similar;
        return can.Object;
    }(__m2);
    var __m49 = function(can) {
        if (!can.Object) {
            throw new Error("can.fixture depends on can.Object. Please include it before can.fixture.");
        }
        var getUrl = function(url) {
            if (typeof steal !== "undefined") {
                if (can.isFunction(steal.config)) {
                    return steal.config().root.mapJoin(url).toString();
                }
                return steal.root.join(url).toString();
            }
            return (can.fixture.rootUrl || "") + url;
        };
        var updateSettings = function(settings, originalOptions) {
            if (!can.fixture.on) {
                return;
            }
            var log = function() {};
            settings.type = settings.type || settings.method || "GET";
            var data = overwrite(settings);
            if (!settings.fixture) {
                if (window.location.protocol === "file:") {
                    log("ajax request to " + settings.url + ", no fixture found");
                }
                return;
            }
            if (typeof settings.fixture === "string" && can.fixture[settings.fixture]) {
                settings.fixture = can.fixture[settings.fixture];
            }
            if (typeof settings.fixture === "string") {
                var url = settings.fixture;
                if (/^\/\//.test(url)) {
                    url = getUrl(settings.fixture.substr(2));
                }
                if (data) {
                    url = can.sub(url, data);
                }
                delete settings.fixture;
                settings.url = url;
                settings.data = null;
                settings.type = "GET";
                if (!settings.error) {
                    settings.error = function(xhr, error, message) {
                        throw "fixtures.js Error " + error + " " + message;
                    };
                }
            } else {
                if (settings.dataTypes) {
                    settings.dataTypes.splice(0, 0, "fixture");
                }
                if (data && originalOptions) {
                    originalOptions.data = originalOptions.data || {};
                    can.extend(originalOptions.data, data);
                }
            }
        }, extractResponse = function(status, statusText, responses, headers) {
            if (typeof status !== "number") {
                headers = statusText;
                responses = status;
                statusText = "success";
                status = 200;
            }
            if (typeof statusText !== "string") {
                headers = responses;
                responses = statusText;
                statusText = "success";
            }
            if (status >= 400 && status <= 599) {
                this.dataType = "text";
            }
            return [ status, statusText, extractResponses(this, responses), headers ];
        }, extractResponses = function(settings, responses) {
            var next = settings.dataTypes ? settings.dataTypes[0] : settings.dataType || "json";
            if (!responses || !responses[next]) {
                var tmp = {};
                tmp[next] = responses;
                responses = tmp;
            }
            return responses;
        };
        if (can.ajaxPrefilter && can.ajaxTransport) {
            can.ajaxPrefilter(updateSettings);
            can.ajaxTransport("fixture", function(s, original) {
                s.dataTypes.shift();
                var timeout, stopped = false;
                return {
                    send: function(headers, callback) {
                        timeout = setTimeout(function() {
                            var success = function() {
                                if (stopped === false) {
                                    callback.apply(null, extractResponse.apply(s, arguments));
                                }
                            }, result = s.fixture(original, success, headers, s);
                            if (result !== undefined) {
                                callback(200, "success", extractResponses(s, result), {});
                            }
                        }, can.fixture.delay);
                    },
                    abort: function() {
                        stopped = true;
                        clearTimeout(timeout);
                    }
                };
            });
        } else {
            var AJAX = can.ajax;
            can.ajax = function(settings) {
                updateSettings(settings, settings);
                if (settings.fixture) {
                    var timeout, deferred = new can.Deferred(), stopped = false;
                    deferred.getResponseHeader = function() {};
                    deferred.then(settings.success, settings.fail);
                    deferred.abort = function() {
                        clearTimeout(timeout);
                        stopped = true;
                        deferred.reject(deferred);
                    };
                    timeout = setTimeout(function() {
                        var success = function() {
                            var response = extractResponse.apply(settings, arguments), status = response[0];
                            if ((status >= 200 && status < 300 || status === 304) && stopped === false) {
                                deferred.resolve(response[2][settings.dataType]);
                            } else {
                                deferred.reject(deferred, "error", response[1]);
                            }
                        }, result = settings.fixture(settings, success, settings.headers, settings);
                        if (result !== undefined) {
                            deferred.resolve(result);
                        }
                    }, can.fixture.delay);
                    return deferred;
                } else {
                    return AJAX(settings);
                }
            };
        }
        var overwrites = [], find = function(settings, exact) {
            for (var i = 0; i < overwrites.length; i++) {
                if ($fixture._similar(settings, overwrites[i], exact)) {
                    return i;
                }
            }
            return -1;
        }, overwrite = function(settings) {
            var index = find(settings);
            if (index > -1) {
                settings.fixture = overwrites[index].fixture;
                return $fixture._getData(overwrites[index].url, settings.url);
            }
        }, getId = function(settings) {
            var id = settings.data.id;
            if (id === undefined && typeof settings.data === "number") {
                id = settings.data;
            }
            if (id === undefined) {
                settings.url.replace(/\/(\d+)(\/|$|\.)/g, function(all, num) {
                    id = num;
                });
            }
            if (id === undefined) {
                id = settings.url.replace(/\/(\w+)(\/|$|\.)/g, function(all, num) {
                    if (num !== "update") {
                        id = num;
                    }
                });
            }
            if (id === undefined) {
                id = Math.round(Math.random() * 1e3);
            }
            return id;
        };
        var $fixture = can.fixture = function(settings, fixture) {
            if (fixture !== undefined) {
                if (typeof settings === "string") {
                    var matches = settings.match(/(GET|POST|PUT|DELETE) (.+)/i);
                    if (!matches) {
                        settings = {
                            url: settings
                        };
                    } else {
                        settings = {
                            url: matches[2],
                            type: matches[1]
                        };
                    }
                }
                var index = find(settings, !!fixture);
                if (index > -1) {
                    overwrites.splice(index, 1);
                }
                if (fixture == null) {
                    return;
                }
                settings.fixture = fixture;
                overwrites.push(settings);
            } else {
                can.each(settings, function(fixture, url) {
                    $fixture(url, fixture);
                });
            }
        };
        var replacer = can.replacer;
        can.extend(can.fixture, {
            _similar: function(settings, overwrite, exact) {
                if (exact) {
                    return can.Object.same(settings, overwrite, {
                        fixture: null
                    });
                } else {
                    return can.Object.subset(settings, overwrite, can.fixture._compare);
                }
            },
            _compare: {
                url: function(a, b) {
                    return !!$fixture._getData(b, a);
                },
                fixture: null,
                type: "i"
            },
            _getData: function(fixtureUrl, url) {
                var order = [], fixtureUrlAdjusted = fixtureUrl.replace(".", "\\.").replace("?", "\\?"), res = new RegExp(fixtureUrlAdjusted.replace(replacer, function(whole, part) {
                    order.push(part);
                    return "([^/]+)";
                }) + "$").exec(url), data = {};
                if (!res) {
                    return null;
                }
                res.shift();
                can.each(order, function(name) {
                    data[name] = res.shift();
                });
                return data;
            },
            store: function(count, make, filter) {
                var currentId = 0, findOne = function(id) {
                    for (var i = 0; i < items.length; i++) {
                        if (id == items[i].id) {
                            return items[i];
                        }
                    }
                }, methods = {}, types, items, reset;
                if (can.isArray(count) && typeof count[0] === "string") {
                    types = count;
                    count = make;
                    make = filter;
                    filter = arguments[3];
                } else if (typeof count === "string") {
                    types = [ count + "s", count ];
                    count = make;
                    make = filter;
                    filter = arguments[3];
                }
                if (typeof count === "number") {
                    items = [];
                    reset = function() {
                        items = [];
                        for (var i = 0; i < count; i++) {
                            var item = make(i, items);
                            if (!item.id) {
                                item.id = i;
                            }
                            currentId = Math.max(item.id + 1, currentId + 1) || items.length;
                            items.push(item);
                        }
                        if (can.isArray(types)) {
                            can.fixture["~" + types[0]] = items;
                            can.fixture["-" + types[0]] = methods.findAll;
                            can.fixture["-" + types[1]] = methods.findOne;
                            can.fixture["-" + types[1] + "Update"] = methods.update;
                            can.fixture["-" + types[1] + "Destroy"] = methods.destroy;
                            can.fixture["-" + types[1] + "Create"] = methods.create;
                        }
                    };
                } else {
                    filter = make;
                    var initialItems = count;
                    reset = function() {
                        items = initialItems.slice(0);
                    };
                }
                can.extend(methods, {
                    findAll: function(request) {
                        request = request || {};
                        var retArr = items.slice(0);
                        request.data = request.data || {};
                        can.each((request.data.order || []).slice(0).reverse(), function(name) {
                            var split = name.split(" ");
                            retArr = retArr.sort(function(a, b) {
                                if (split[1].toUpperCase() !== "ASC") {
                                    if (a[split[0]] < b[split[0]]) {
                                        return 1;
                                    } else if (a[split[0]] === b[split[0]]) {
                                        return 0;
                                    } else {
                                        return -1;
                                    }
                                } else {
                                    if (a[split[0]] < b[split[0]]) {
                                        return -1;
                                    } else if (a[split[0]] === b[split[0]]) {
                                        return 0;
                                    } else {
                                        return 1;
                                    }
                                }
                            });
                        });
                        can.each((request.data.group || []).slice(0).reverse(), function(name) {
                            var split = name.split(" ");
                            retArr = retArr.sort(function(a, b) {
                                return a[split[0]] > b[split[0]];
                            });
                        });
                        var offset = parseInt(request.data.offset, 10) || 0, limit = parseInt(request.data.limit, 10) || items.length - offset, i = 0;
                        for (var param in request.data) {
                            i = 0;
                            if (request.data[param] !== undefined && (param.indexOf("Id") !== -1 || param.indexOf("_id") !== -1)) {
                                while (i < retArr.length) {
                                    if (request.data[param] != retArr[i][param]) {
                                        retArr.splice(i, 1);
                                    } else {
                                        i++;
                                    }
                                }
                            }
                        }
                        if (typeof filter === "function") {
                            i = 0;
                            while (i < retArr.length) {
                                if (!filter(retArr[i], request)) {
                                    retArr.splice(i, 1);
                                } else {
                                    i++;
                                }
                            }
                        } else if (typeof filter === "object") {
                            i = 0;
                            while (i < retArr.length) {
                                if (!can.Object.subset(retArr[i], request.data, filter)) {
                                    retArr.splice(i, 1);
                                } else {
                                    i++;
                                }
                            }
                        }
                        return {
                            count: retArr.length,
                            limit: request.data.limit,
                            offset: request.data.offset,
                            data: retArr.slice(offset, offset + limit)
                        };
                    },
                    findOne: function(request, response) {
                        var item = findOne(getId(request));
                        if (typeof item === "undefined") {
                            return response(404, "Requested resource not found");
                        }
                        response(item);
                    },
                    update: function(request, response) {
                        var id = getId(request), item = findOne(id);
                        if (typeof item === "undefined") {
                            return response(404, "Requested resource not found");
                        }
                        can.extend(item, request.data);
                        response({
                            id: id
                        }, {
                            location: request.url || "/" + getId(request)
                        });
                    },
                    destroy: function(request, response) {
                        var id = getId(request), item = findOne(id);
                        if (typeof item === "undefined") {
                            return response(404, "Requested resource not found");
                        }
                        for (var i = 0; i < items.length; i++) {
                            if (items[i].id == id) {
                                items.splice(i, 1);
                                break;
                            }
                        }
                        return {};
                    },
                    create: function(settings, response) {
                        var item = make(items.length, items);
                        can.extend(item, settings.data);
                        if (!item.id) {
                            item.id = currentId++;
                        }
                        items.push(item);
                        response({
                            id: item.id
                        }, {
                            location: settings.url + "/" + item.id
                        });
                    }
                });
                reset();
                return can.extend({
                    getId: getId,
                    find: function(settings) {
                        return findOne(getId(settings));
                    },
                    reset: reset
                }, methods);
            },
            rand: function randomize(arr, min, max) {
                if (typeof arr === "number") {
                    if (typeof min === "number") {
                        return arr + Math.floor(Math.random() * (min - arr));
                    } else {
                        return Math.floor(Math.random() * arr);
                    }
                }
                var rand = randomize;
                if (min === undefined) {
                    return rand(arr, rand(arr.length + 1));
                }
                var res = [];
                arr = arr.slice(0);
                if (!max) {
                    max = min;
                }
                max = min + Math.round(rand(max - min));
                for (var i = 0; i < max; i++) {
                    res.push(arr.splice(rand(arr.length), 1)[0]);
                }
                return res;
            },
            xhr: function(xhr) {
                return can.extend({}, {
                    abort: can.noop,
                    getAllResponseHeaders: function() {
                        return "";
                    },
                    getResponseHeader: function() {
                        return "";
                    },
                    open: can.noop,
                    overrideMimeType: can.noop,
                    readyState: 4,
                    responseText: "",
                    responseXML: null,
                    send: can.noop,
                    setRequestHeader: can.noop,
                    status: 200,
                    statusText: "OK"
                }, xhr);
            },
            on: true
        });
        can.fixture.delay = 200;
        can.fixture.rootUrl = getUrl("");
        can.fixture["-handleFunction"] = function(settings) {
            if (typeof settings.fixture === "string" && can.fixture[settings.fixture]) {
                settings.fixture = can.fixture[settings.fixture];
            }
            if (typeof settings.fixture === "function") {
                setTimeout(function() {
                    if (settings.success) {
                        settings.success.apply(null, settings.fixture(settings, "success"));
                    }
                    if (settings.complete) {
                        settings.complete.apply(null, settings.fixture(settings, "complete"));
                    }
                }, can.fixture.delay);
                return true;
            }
            return false;
        };
        can.fixture.overwrites = overwrites;
        can.fixture.make = can.fixture.store;
        return can.fixture;
    }(__m2, __m13, __m48);
    window["can"] = __m4;
})();

(function(undefined) {
    var __m1 = function(can) {
        var validate = function(attrNames, options, proc) {
            if (!proc) {
                proc = options;
                options = {};
            }
            options = options || {};
            attrNames = typeof attrNames === "string" ? [ attrNames ] : can.makeArray(attrNames);
            if (options.testIf && !options.testIf.call(this)) {
                return;
            }
            var self = this;
            can.each(attrNames, function(attrName) {
                if (!self.validations[attrName]) {
                    self.validations[attrName] = [];
                }
                self.validations[attrName].push(function(newVal) {
                    var res = proc.call(this, newVal, attrName);
                    return res === undefined ? undefined : options.message || res;
                });
            });
        };
        var old = can.Map.prototype.__set;
        can.Map.prototype.__set = function(prop, value, current, success, error) {
            var self = this, validations = self.constructor.validations, errorCallback = function(errors) {
                var stub = error && error.call(self, errors);
                if (stub !== false) {
                    can.trigger(self, "error", [ prop, errors ], true);
                }
                return false;
            };
            old.call(self, prop, value, current, success, errorCallback);
            if (validations && validations[prop]) {
                var errors = self.errors(prop);
                if (errors) {
                    errorCallback(errors);
                }
            }
            return this;
        };
        can.each([ can.Map, can.Model ], function(clss) {
            if (clss === undefined) {
                return;
            }
            var oldSetup = clss.setup;
            can.extend(clss, {
                setup: function(superClass) {
                    oldSetup.apply(this, arguments);
                    if (!this.validations || superClass.validations === this.validations) {
                        this.validations = {};
                    }
                },
                validate: validate,
                validationMessages: {
                    format: "is invalid",
                    inclusion: "is not a valid option (perhaps out of range)",
                    lengthShort: "is too short",
                    lengthLong: "is too long",
                    presence: "can't be empty",
                    range: "is out of range",
                    numericality: "must be a number"
                },
                validateFormatOf: function(attrNames, regexp, options) {
                    validate.call(this, attrNames, options, function(value) {
                        if (typeof value !== "undefined" && value !== null && value !== "" && String(value).match(regexp) === null) {
                            return this.constructor.validationMessages.format;
                        }
                    });
                },
                validateInclusionOf: function(attrNames, inArray, options) {
                    validate.call(this, attrNames, options, function(value) {
                        if (typeof value === "undefined") {
                            return;
                        }
                        for (var i = 0; i < inArray.length; i++) {
                            if (inArray[i] === value) {
                                return;
                            }
                        }
                        return this.constructor.validationMessages.inclusion;
                    });
                },
                validateLengthOf: function(attrNames, min, max, options) {
                    validate.call(this, attrNames, options, function(value) {
                        if ((typeof value === "undefined" || value === null) && min > 0 || typeof value !== "undefined" && value !== null && value.length < min) {
                            return this.constructor.validationMessages.lengthShort + " (min=" + min + ")";
                        } else if (typeof value !== "undefined" && value !== null && value.length > max) {
                            return this.constructor.validationMessages.lengthLong + " (max=" + max + ")";
                        }
                    });
                },
                validatePresenceOf: function(attrNames, options) {
                    validate.call(this, attrNames, options, function(value) {
                        if (typeof value === "undefined" || value === "" || value === null) {
                            return this.constructor.validationMessages.presence;
                        }
                    });
                },
                validateRangeOf: function(attrNames, low, hi, options) {
                    validate.call(this, attrNames, options, function(value) {
                        if ((typeof value === "undefined" || value === null) && low > 0 || typeof value !== "undefined" && value !== null && (value < low || value > hi)) {
                            return this.constructor.validationMessages.range + " [" + low + "," + hi + "]";
                        }
                    });
                },
                validatesNumericalityOf: function(attrNames) {
                    validate.call(this, attrNames, function(value) {
                        var res = !isNaN(parseFloat(value)) && isFinite(value);
                        if (!res) {
                            return this.constructor.validationMessages.numericality;
                        }
                    });
                }
            });
        });
        can.extend(can.Map.prototype, {
            errors: function(attrs, newVal) {
                if (attrs) {
                    attrs = can.isArray(attrs) ? attrs : [ attrs ];
                }
                var errors = {}, self = this, addErrors = function(attr, funcs) {
                    can.each(funcs, function(func) {
                        var res = func.call(self, isTest ? self.__convert ? self.__convert(attr, newVal) : newVal : self.attr(attr));
                        if (res) {
                            if (!errors[attr]) {
                                errors[attr] = [];
                            }
                            errors[attr].push(res);
                        }
                    });
                }, validations = this.constructor.validations || {}, isTest = attrs && attrs.length === 1 && arguments.length === 2;
                can.each(attrs || validations, function(funcs, attr) {
                    if (typeof attr === "number") {
                        attr = funcs;
                        funcs = validations[attr];
                    }
                    addErrors(attr, funcs || []);
                });
                return can.isEmptyObject(errors) ? null : isTest ? errors[attrs[0]] : errors;
            }
        });
        return can.Map;
    }(window.can, undefined);
})();

!function(a) {
    function d() {
        a(".dropdown-backdrop").remove(), a(b).each(function() {
            e(a(this)).removeClass("open");
        });
    }
    function e(b) {
        var c = b.attr("data-target"), d;
        c || (c = b.attr("href"), c = c && /#/.test(c) && c.replace(/.*(?=#[^\s]*$)/, "")), 
        d = c && a(c);
        if (!d || !d.length) d = b.parent();
        return d;
    }
    var b = "[data-toggle=dropdown]", c = function(b) {
        var c = a(b).on("click.dropdown.data-api", this.toggle);
        a("html").on("click.dropdown.data-api", function() {
            c.parent().removeClass("open");
        });
    };
    c.prototype = {
        constructor: c,
        toggle: function(b) {
            var c = a(this), f, g;
            if (c.is(".disabled, :disabled")) return;
            return f = e(c), g = f.hasClass("open"), d(), g || ("ontouchstart" in document.documentElement && a('<div class="dropdown-backdrop"/>').insertBefore(a(this)).on("click", d), 
            f.toggleClass("open")), c.focus(), !1;
        },
        keydown: function(c) {
            var d, f, g, h, i, j;
            if (!/(38|40|27)/.test(c.keyCode)) return;
            d = a(this), c.preventDefault(), c.stopPropagation();
            if (d.is(".disabled, :disabled")) return;
            h = e(d), i = h.hasClass("open");
            if (!i || i && c.keyCode == 27) return c.which == 27 && h.find(b).focus(), d.click();
            f = a("[role=menu] li:not(.divider):visible a", h);
            if (!f.length) return;
            j = f.index(f.filter(":focus")), c.keyCode == 38 && j > 0 && j--, c.keyCode == 40 && j < f.length - 1 && j++, 
            ~j || (j = 0), f.eq(j).focus();
        }
    };
    var f = a.fn.dropdown;
    a.fn.dropdown = function(b) {
        return this.each(function() {
            var d = a(this), e = d.data("dropdown");
            e || d.data("dropdown", e = new c(this)), typeof b == "string" && e[b].call(d);
        });
    }, a.fn.dropdown.Constructor = c, a.fn.dropdown.noConflict = function() {
        return a.fn.dropdown = f, this;
    }, a(document).on("click.dropdown.data-api", d).on("click.dropdown.data-api", ".dropdown form", function(a) {
        a.stopPropagation();
    }).on("click.dropdown.data-api", b, c.prototype.toggle).on("keydown.dropdown.data-api", b + ", [role=menu]", c.prototype.keydown);
}(window.jQuery), !function(a) {
    var b = function(b) {
        this.element = a(b);
    };
    b.prototype = {
        constructor: b,
        show: function() {
            var b = this.element, c = b.closest("ul:not(.dropdown-menu)"), d = b.attr("data-target"), e, f, g;
            d || (d = b.attr("href"), d = d && d.replace(/.*(?=#[^\s]*$)/, ""));
            if (b.parent("li").hasClass("active")) return;
            e = c.find(".active:last a")[0], g = a.Event("show", {
                relatedTarget: e
            }), b.trigger(g);
            if (g.isDefaultPrevented()) return;
            f = a(d), this.activate(b.parent("li"), c), this.activate(f, f.parent(), function() {
                b.trigger({
                    type: "shown",
                    relatedTarget: e
                });
            });
        },
        activate: function(b, c, d) {
            function g() {
                e.removeClass("active").find("> .dropdown-menu > .active").removeClass("active"), 
                b.addClass("active"), f ? (b[0].offsetWidth, b.addClass("in")) : b.removeClass("fade"), 
                b.parent(".dropdown-menu") && b.closest("li.dropdown").addClass("active"), d && d();
            }
            var e = c.find("> .active"), f = d && a.support.transition && e.hasClass("fade");
            f ? e.one(a.support.transition.end, g) : g(), e.removeClass("in");
        }
    };
    var c = a.fn.tab;
    a.fn.tab = function(c) {
        return this.each(function() {
            var d = a(this), e = d.data("tab");
            e || d.data("tab", e = new b(this)), typeof c == "string" && e[c]();
        });
    }, a.fn.tab.Constructor = b, a.fn.tab.noConflict = function() {
        return a.fn.tab = c, this;
    }, a(document).on("click.tab.data-api", '[data-toggle="tab"], [data-toggle="pill"]', function(b) {
        b.preventDefault(), a(this).tab("show");
    });
}(window.jQuery);

!function($) {
    var WinReszier = function() {
        var registered = [];
        var inited = false;
        var timer;
        var resize = function(ev) {
            clearTimeout(timer);
            timer = setTimeout(notify, 100);
        };
        var notify = function() {
            for (var i = 0, cnt = registered.length; i < cnt; i++) {
                registered[i].apply();
            }
        };
        return {
            register: function(fn) {
                registered.push(fn);
                if (inited === false) {
                    $(window).bind("resize", resize);
                    inited = true;
                }
            },
            unregister: function(fn) {
                for (var i = 0, cnt = registered.length; i < cnt; i++) {
                    if (registered[i] == fn) {
                        delete registered[i];
                        break;
                    }
                }
            }
        };
    }();
    var TabDrop = function(element, options) {
        this.element = $(element);
        this.checkActiveTab();
        this.initSmallTabs(options.updateSelect);
        this.initAdvAPI();
        var dropdownMarkup = '<li class="dropdown hide pull-right tabdrop"><a class="dropdown-toggle" data-toggle="dropdown" href="#">' + options.text + ' </a><ul class="dropdown-menu"></ul></li>';
        this.dropdown = $(dropdownMarkup).prependTo(this.element);
        if (this.element.parent().is(".tabs-below")) {
            this.dropdown.addClass("dropup");
        }
        this.checkTabSource();
        WinReszier.register($.proxy(this.layout, this));
        this.layout();
    };
    TabDrop.prototype = {
        constructor: TabDrop,
        layout: function() {
            var collection = [];
            var showDropdown = false;
            this.dropdown.addClass("hide");
            this.element.append(this.dropdown.find("li")).find(">li:visible").not(".tabdrop").each(function() {
                if (this.offsetTop > 0) {
                    showDropdown = true;
                }
            });
            this.dropdown.removeClass("hide");
            if (showDropdown) {
                this.element.append(this.dropdown.find("li")).find(">li:visible").not(".tabdrop").each(function() {
                    if (this.offsetTop > 0) {
                        collection.push(this);
                    }
                });
            }
            if (collection.length > 0) {
                collection = $(collection);
                this.dropdown.find("ul").empty().append(collection);
                if (this.dropdown.find(".active").length == 1) {
                    this.dropdown.addClass("active");
                } else {
                    this.dropdown.removeClass("active");
                }
            } else {
                this.dropdown.addClass("hide");
            }
            var select = this.select.find("select");
            select.css("width", "");
            select.trigger("update");
        },
        checkActiveTab: function() {
            var activeTabs = this.element.find("li.active");
            var tab = activeTabs;
            if (activeTabs.length == 0) {
                var tabs = this.element.find("li:not(.tabbable-title)");
                if (tabs.length > 0) {
                    tab = $(tabs[0]);
                    tab.addClass("active");
                } else {
                    return;
                }
            }
            var href = tab.find("a").attr("href");
            if (href[0] != "#") {
                return;
            }
            var tabId = href.substring(1);
            var tabComponent = this.element.closest(".tabbable");
            if (tabComponent.length == 0) {
                tabComponent = this.element.closest(".tabs");
            }
            var tabContent = tabComponent.find("#" + tabId);
            if (tabContent.length > 0) {
                $(tabContent[0]).addClass("active").siblings().removeClass("active");
            }
            this.triggerTabChangeEvent(tabId);
        },
        initSmallTabs: function(updateSelect) {
            var smallSelectMarkup = '<div class="small-tab-selector dropdown-gray"><select>';
            var tabs = this.element.find("li:not(.hidden-small)");
            for (var i = 0; i < tabs.length; i++) {
                var tab = $(tabs[i]);
                if (!tab.hasClass("tabbable-title")) {
                    var link = tab.find("a");
                    var item = "<option " + (tab.hasClass("active") ? "selected " : "") + 'value="' + link.attr("href") + '">' + link.html() + "</option>";
                    smallSelectMarkup += item;
                }
            }
            smallSelectMarkup += "</select></div>";
            this.select = $(smallSelectMarkup).insertAfter(this.element.parent());
            var me = this;
            var selectbox = this.select.find("select");
            if (selectbox.find("option").length < 2) {
                selectbox.attr("disabled", "disabled");
            }
            selectbox.bind("change", function(evt) {
                var item = $(evt.currentTarget);
                var value = item.val();
                if (value[0] == "#") {
                    var tabId = value.substring(1);
                    var tabHeader = me.element.find("li a[href=" + value + "]");
                    tabHeader.parent().addClass("active").siblings().removeClass("active");
                    var tab = item.closest(".tabbable").find("#" + tabId);
                    tab.addClass("active").siblings().removeClass("active");
                    setTimeout(function() {
                        me.triggerTabChangeEvent(tabId);
                    }, 100);
                } else {
                    window.location.assign(value);
                }
            });
            if (updateSelect) {
                this.element.on("tabChange", $.proxy(function(event, tabId) {
                    this.select.find("select").trigger("chosen:updated");
                }, this));
            }
            this.select.find("select").chosen({
                width: "100%",
                disable_search_threshold: 10
            });
        },
        initAdvAPI: function() {
            var head = this.element.parent();
            var advBlock = head.find(".js-ad");
            if (advBlock.length) {
                var advAPI = advBlock.data("ad-api");
                if (advAPI) {
                    var self = this;
                    advAPI.onRender = function(adv) {
                        var size = adv.getContentSize();
                        var requiredWidth = adv.hasContent() ? size.width + 30 : 0;
                        var currentWidth = parseInt(head.css("padding-right").replace("px", ""));
                        if (currentWidth != requiredWidth) {
                            head.css("padding-right", requiredWidth);
                            self.layout();
                        }
                    };
                }
            }
        },
        triggerTabChangeEvent: function(tabId) {
            this.element.trigger("tabChange", tabId);
        },
        checkTabSource: function() {
            var me = this;
            this.element.find("a").bind("show", function(evt) {
                var el = $(evt.currentTarget);
                var href = el.attr("href");
                if (href[0] != "#") {
                    window.location.assign(href);
                    evt.preventDefault();
                } else {
                    if (me.select) {
                        me.select.find("select").val(href);
                    }
                    setTimeout(function() {
                        me.triggerTabChangeEvent(href.substring(1));
                    }, 100);
                }
            });
        }
    };
    $.fn.tabdrop = function(option) {
        return this.each(function() {
            var $this = $(this), data = $this.data("tabdrop"), options = typeof option === "object" && option;
            if (!data) {
                $this.data("tabdrop", data = new TabDrop(this, $.extend({}, $.fn.tabdrop.defaults, options)));
            }
            if (typeof option == "string") {
                data[option]();
            }
        });
    };
    $.fn.tabdrop.defaults = {
        text: 'More<i class="icon-chevron-down"></i>'
    };
    $.fn.tabdrop.Constructor = TabDrop;
}(window.jQuery);

(function($) {
    var plugin = {};
    var defaults = {
        mode: "horizontal",
        slideSelector: "",
        infiniteLoop: true,
        hideControlOnEnd: false,
        speed: 500,
        easing: null,
        slideMargin: 0,
        startSlide: 0,
        randomStart: false,
        captions: false,
        ticker: false,
        tickerHover: false,
        adaptiveHeight: false,
        adaptiveHeightSpeed: 500,
        video: false,
        useCSS: true,
        preloadImages: "visible",
        responsive: true,
        slideZIndex: 50,
        wrapperClass: "bx-wrapper",
        adjustOnResize: false,
        touchEnabled: true,
        swipeThreshold: 50,
        oneToOneTouch: true,
        preventDefaultSwipeX: true,
        preventDefaultSwipeY: false,
        pager: true,
        pagerType: "full",
        pagerShortSeparator: " / ",
        pagerSelector: null,
        buildPager: null,
        pagerCustom: null,
        controls: true,
        nextText: "Next",
        prevText: "Prev",
        nextSelector: null,
        prevSelector: null,
        autoControls: false,
        startText: "Start",
        stopText: "Stop",
        autoControlsCombine: false,
        autoControlsSelector: null,
        auto: false,
        pause: 4e3,
        autoStart: true,
        autoDirection: "next",
        autoHover: false,
        autoDelay: 0,
        autoSlideForOnePage: false,
        minSlides: 1,
        maxSlides: 1,
        moveSlides: 0,
        slideWidth: 0,
        onSliderLoad: function() {},
        onSlideBefore: function() {},
        onSlideAfter: function() {},
        onSlideNext: function() {},
        onSlidePrev: function() {},
        onSliderResize: function() {}
    };
    $.fn.bxSlider = function(options) {
        if (this.length == 0) return this;
        if (this.length > 1) {
            this.each(function() {
                $(this).bxSlider(options);
            });
            return this;
        }
        var slider = {};
        var el = this;
        plugin.el = this;
        var windowWidth = $(window).width();
        var windowHeight = $(window).height();
        var init = function() {
            slider.settings = $.extend({}, defaults, options);
            slider.settings.slideWidth = parseInt(slider.settings.slideWidth);
            slider.children = el.children(slider.settings.slideSelector);
            if (slider.children.length < slider.settings.minSlides) slider.settings.minSlides = slider.children.length;
            if (slider.children.length < slider.settings.maxSlides) slider.settings.maxSlides = slider.children.length;
            if (slider.settings.randomStart) slider.settings.startSlide = Math.floor(Math.random() * slider.children.length);
            slider.active = {
                index: slider.settings.startSlide
            };
            slider.carousel = slider.settings.minSlides > 1 || slider.settings.maxSlides > 1;
            if (slider.carousel) slider.settings.preloadImages = "all";
            slider.minThreshold = slider.settings.minSlides * slider.settings.slideWidth + (slider.settings.minSlides - 1) * slider.settings.slideMargin;
            slider.maxThreshold = slider.settings.maxSlides * slider.settings.slideWidth + (slider.settings.maxSlides - 1) * slider.settings.slideMargin;
            slider.working = false;
            slider.controls = {};
            slider.interval = null;
            slider.animProp = slider.settings.mode == "vertical" ? "top" : "left";
            slider.usingCSS = slider.settings.useCSS && slider.settings.mode != "fade" && function() {
                var div = document.createElement("div");
                var props = [ "WebkitPerspective", "MozPerspective", "OPerspective", "msPerspective" ];
                for (var i in props) {
                    if (div.style[props[i]] !== undefined) {
                        slider.cssPrefix = props[i].replace("Perspective", "").toLowerCase();
                        slider.animProp = "-" + slider.cssPrefix + "-transform";
                        return true;
                    }
                }
                return false;
            }();
            if (slider.settings.mode == "vertical") slider.settings.maxSlides = slider.settings.minSlides;
            el.data("origStyle", el.attr("style"));
            el.children(slider.settings.slideSelector).each(function() {
                $(this).data("origStyle", $(this).attr("style"));
            });
            setup();
        };
        var setup = function() {
            el.wrap('<div class="' + slider.settings.wrapperClass + '"><div class="bx-viewport"></div></div>');
            slider.viewport = el.parent();
            slider.loader = $('<div class="bx-loading" />');
            slider.viewport.prepend(slider.loader);
            el.css({
                width: slider.settings.mode == "horizontal" ? slider.children.length * 100 + 215 + "%" : "auto",
                position: "relative"
            });
            if (slider.usingCSS && slider.settings.easing) {
                el.css("-" + slider.cssPrefix + "-transition-timing-function", slider.settings.easing);
            } else if (!slider.settings.easing) {
                slider.settings.easing = "swing";
            }
            var slidesShowing = getNumberSlidesShowing();
            slider.viewport.css({
                width: "100%",
                overflow: "hidden",
                position: "relative"
            });
            slider.viewport.parent().css({
                maxWidth: getViewportMaxWidth()
            });
            if (!slider.settings.pager) {
                slider.viewport.parent().css({
                    margin: "0 auto 0px"
                });
            }
            slider.children.css({
                "float": slider.settings.mode == "horizontal" ? "left" : "none",
                listStyle: "none",
                position: "relative"
            });
            slider.children.css("width", getSlideWidth());
            if (slider.settings.mode == "horizontal" && slider.settings.slideMargin > 0) slider.children.css("marginRight", slider.settings.slideMargin);
            if (slider.settings.mode == "vertical" && slider.settings.slideMargin > 0) slider.children.css("marginBottom", slider.settings.slideMargin);
            if (slider.settings.mode == "fade") {
                slider.children.css({
                    position: "absolute",
                    zIndex: 0,
                    display: "none"
                });
                slider.children.eq(slider.settings.startSlide).css({
                    zIndex: slider.settings.slideZIndex,
                    display: "block"
                });
            }
            slider.controls.el = $('<div class="bx-controls" />');
            if (slider.settings.captions) appendCaptions();
            slider.active.last = slider.settings.startSlide == getPagerQty() - 1;
            if (slider.settings.video) el.fitVids();
            var preloadSelector = slider.children.eq(slider.settings.startSlide);
            if (slider.settings.preloadImages == "all") preloadSelector = slider.children;
            if (!slider.settings.ticker) {
                if (slider.settings.pager) appendPager();
                if (slider.settings.controls) appendControls();
                if (slider.settings.auto && slider.settings.autoControls) appendControlsAuto();
                if (slider.settings.controls || slider.settings.autoControls || slider.settings.pager) slider.viewport.after(slider.controls.el);
            } else {
                slider.settings.pager = false;
            }
            loadElements(preloadSelector, start);
        };
        var loadElements = function(selector, callback) {
            var total = selector.find("img, iframe").length;
            if (total == 0) {
                callback();
                return;
            }
            var count = 0;
            selector.find("img, iframe").each(function() {
                $(this).one("load", function() {
                    if (++count == total) callback();
                }).each(function() {
                    if (this.complete) {
                        $(this).load();
                    } else {
                        $(this).attr("src", $(this).attr("src"));
                    }
                });
            });
        };
        var start = function() {
            if (slider.settings.infiniteLoop && slider.settings.mode != "fade" && !slider.settings.ticker) {
                var slice = slider.settings.mode == "vertical" ? slider.settings.minSlides : slider.settings.maxSlides;
                var sliceAppend = slider.children.slice(0, slice).clone().addClass("bx-clone");
                var slicePrepend = slider.children.slice(-slice).clone().addClass("bx-clone");
                el.append(sliceAppend).prepend(slicePrepend);
            }
            slider.loader.remove();
            setSlidePosition();
            if (slider.settings.mode == "vertical") slider.settings.adaptiveHeight = true;
            slider.viewport.height(getViewportHeight());
            el.redrawSlider();
            slider.settings.onSliderLoad(slider.active.index);
            slider.initialized = true;
            if (slider.settings.responsive) $(window).bind("resize", resizeWindow);
            if (slider.settings.auto && slider.settings.autoStart && (getPagerQty() > 1 || slider.settings.autoSlideForOnePage)) initAuto();
            if (slider.settings.ticker) initTicker();
            if (slider.settings.pager) updatePagerActive(slider.settings.startSlide);
            if (slider.settings.controls) updateDirectionControls();
            if (slider.settings.touchEnabled && !slider.settings.ticker) initTouch();
        };
        var getViewportHeight = function() {
            var height = 0;
            var children = $();
            if (slider.settings.mode != "vertical" && !slider.settings.adaptiveHeight) {
                children = slider.children;
            } else {
                if (!slider.carousel) {
                    children = slider.children.eq(slider.active.index);
                } else {
                    var currentIndex = slider.settings.moveSlides == 1 ? slider.active.index : slider.active.index * getMoveBy();
                    children = slider.children.eq(currentIndex);
                    for (i = 1; i <= slider.settings.maxSlides - 1; i++) {
                        if (currentIndex + i >= slider.children.length) {
                            children = children.add(slider.children.eq(i - 1));
                        } else {
                            children = children.add(slider.children.eq(currentIndex + i));
                        }
                    }
                }
            }
            if (slider.settings.mode == "vertical") {
                children.each(function(index) {
                    height += $(this).outerHeight();
                });
                if (slider.settings.slideMargin > 0) {
                    height += slider.settings.slideMargin * (slider.settings.minSlides - 1);
                }
            } else {
                height = Math.max.apply(Math, children.map(function() {
                    return $(this).outerHeight(false);
                }).get());
            }
            if (slider.viewport.css("box-sizing") == "border-box") {
                height += parseFloat(slider.viewport.css("padding-top")) + parseFloat(slider.viewport.css("padding-bottom")) + parseFloat(slider.viewport.css("border-top-width")) + parseFloat(slider.viewport.css("border-bottom-width"));
            } else if (slider.viewport.css("box-sizing") == "padding-box") {
                height += parseFloat(slider.viewport.css("padding-top")) + parseFloat(slider.viewport.css("padding-bottom"));
            }
            return height;
        };
        var getViewportMaxWidth = function() {
            var width = "100%";
            if (slider.settings.slideWidth > 0) {
                if (slider.settings.mode == "horizontal") {
                    width = slider.settings.maxSlides * slider.settings.slideWidth + (slider.settings.maxSlides - 1) * slider.settings.slideMargin;
                } else {
                    width = slider.settings.slideWidth;
                }
            }
            return width;
        };
        var getSlideWidth = function() {
            var newElWidth = slider.settings.slideWidth;
            var wrapWidth = slider.viewport.width();
            if (slider.settings.slideWidth == 0 || slider.settings.slideWidth > wrapWidth && !slider.carousel || slider.settings.mode == "vertical") {
                newElWidth = wrapWidth;
            } else if (slider.settings.maxSlides > 1 && slider.settings.mode == "horizontal") {
                if (wrapWidth > slider.maxThreshold) {} else if (wrapWidth < slider.minThreshold) {
                    newElWidth = (wrapWidth - slider.settings.slideMargin * (slider.settings.minSlides - 1)) / slider.settings.minSlides;
                }
            }
            return newElWidth;
        };
        var getNumberSlidesShowing = function() {
            var slidesShowing = 1;
            if (slider.settings.mode == "horizontal" && slider.settings.slideWidth > 0) {
                if (slider.viewport.width() < slider.minThreshold) {
                    slidesShowing = slider.settings.minSlides;
                } else if (slider.viewport.width() > slider.maxThreshold) {
                    slidesShowing = slider.settings.maxSlides;
                } else {
                    var childWidth = slider.children.first().width() + slider.settings.slideMargin;
                    slidesShowing = Math.floor((slider.viewport.width() + slider.settings.slideMargin) / childWidth);
                }
            } else if (slider.settings.mode == "vertical") {
                slidesShowing = slider.settings.minSlides;
            }
            return slidesShowing;
        };
        var getPagerQty = function() {
            var pagerQty = 0;
            if (slider.settings.moveSlides > 0) {
                if (slider.settings.infiniteLoop) {
                    pagerQty = Math.ceil(slider.children.length / getMoveBy());
                } else {
                    var breakPoint = 0;
                    var counter = 0;
                    while (breakPoint < slider.children.length) {
                        ++pagerQty;
                        breakPoint = counter + getNumberSlidesShowing();
                        counter += slider.settings.moveSlides <= getNumberSlidesShowing() ? slider.settings.moveSlides : getNumberSlidesShowing();
                    }
                }
            } else {
                pagerQty = Math.ceil(slider.children.length / getNumberSlidesShowing());
            }
            return pagerQty;
        };
        var getMoveBy = function() {
            if (slider.settings.moveSlides > 0 && slider.settings.moveSlides <= getNumberSlidesShowing()) {
                return slider.settings.moveSlides;
            }
            return getNumberSlidesShowing();
        };
        var setSlidePosition = function() {
            if (slider.children.length >= slider.settings.maxSlides && slider.active.last && !slider.settings.infiniteLoop || slider.settings.adjustOnResize) {
                if (slider.settings.mode == "horizontal") {
                    var lastChild = slider.children.last();
                    var position = lastChild.position();
                    setPositionProperty(-(position.left - (slider.viewport.width() - lastChild.outerWidth())), "reset", 0);
                } else if (slider.settings.mode == "vertical") {
                    var lastShowingIndex = slider.children.length - slider.settings.minSlides;
                    var position = slider.children.eq(lastShowingIndex).position();
                    setPositionProperty(-position.top, "reset", 0);
                }
            } else {
                var position = slider.children.eq(slider.active.index * getMoveBy()).position();
                if (slider.active.index == getPagerQty() - 1) slider.active.last = true;
                if (position != undefined) {
                    if (slider.settings.mode == "horizontal") setPositionProperty(-position.left, "reset", 0); else if (slider.settings.mode == "vertical") setPositionProperty(-position.top, "reset", 0);
                }
            }
        };
        var setPositionProperty = function(value, type, duration, params) {
            if (slider.usingCSS) {
                var propValue = slider.settings.mode == "vertical" ? "translate3d(0, " + value + "px, 0)" : "translate3d(" + value + "px, 0, 0)", prevPropCssValue = el.css(slider.animProp), propCssValue = "matrix(1, 0, 0, 1, " + (slider.settings.mode == "vertical" ? "0, " + value : value + ", 0") + ")";
                if (prevPropCssValue.indexOf("matrix3d") === 0) {
                    propCssValue = "matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, " + (slider.settings.mode == "vertical" ? "0, " + value : value + ", 0") + ", 0, 1)";
                }
                el.css("-" + slider.cssPrefix + "-transition-duration", duration / 1e3 + "s");
                if (type == "slide") {
                    el.on("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd", function afterTransition() {
                        $(this).off("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd");
                        updateAfterSlideTransition();
                    });
                    el.css(slider.animProp, propValue);
                    if (propCssValue === prevPropCssValue) {
                        el.trigger("transitionend");
                    }
                } else if (type == "reset") {
                    el.css(slider.animProp, propValue);
                } else if (type == "ticker") {
                    el.css("-" + slider.cssPrefix + "-transition-timing-function", "linear");
                    el.css(slider.animProp, propValue);
                    el.bind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd", function() {
                        el.unbind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd");
                        setPositionProperty(params["resetValue"], "reset", 0);
                        tickerLoop();
                    });
                }
            } else {
                var animateObj = {};
                animateObj[slider.animProp] = value;
                if (type == "slide") {
                    el.animate(animateObj, duration, slider.settings.easing, function() {
                        updateAfterSlideTransition();
                    });
                } else if (type == "reset") {
                    el.css(slider.animProp, value);
                } else if (type == "ticker") {
                    el.animate(animateObj, speed, "linear", function() {
                        setPositionProperty(params["resetValue"], "reset", 0);
                        tickerLoop();
                    });
                }
            }
        };
        var populatePager = function() {
            var pagerHtml = "";
            var pagerQty = getPagerQty();
            for (var i = 0; i < pagerQty; i++) {
                var linkContent = "";
                if (slider.settings.buildPager && $.isFunction(slider.settings.buildPager)) {
                    linkContent = slider.settings.buildPager(i);
                    slider.pagerEl.addClass("bx-custom-pager");
                } else {
                    linkContent = i + 1;
                    slider.pagerEl.addClass("bx-default-pager");
                }
                pagerHtml += '<div class="bx-pager-item"><a href="" data-slide-index="' + i + '" class="bx-pager-link">' + linkContent + "</a></div>";
            }
            slider.pagerEl.html(pagerHtml);
        };
        var appendPager = function() {
            if (!slider.settings.pagerCustom) {
                slider.pagerEl = $('<div class="bx-pager" />');
                if (slider.settings.pagerSelector) {
                    $(slider.settings.pagerSelector).html(slider.pagerEl);
                } else {
                    slider.controls.el.addClass("bx-has-pager").append(slider.pagerEl);
                }
                populatePager();
            } else {
                slider.pagerEl = $(slider.settings.pagerCustom);
            }
            slider.pagerEl.on("click", "a", clickPagerBind);
        };
        var appendControls = function() {
            slider.controls.next = $('<a class="bx-next" href="">' + slider.settings.nextText + "</a>");
            slider.controls.prev = $('<a class="bx-prev" href="">' + slider.settings.prevText + "</a>");
            slider.controls.next.bind("click", clickNextBind);
            slider.controls.prev.bind("click", clickPrevBind);
            if (slider.settings.nextSelector) {
                $(slider.settings.nextSelector).append(slider.controls.next);
            }
            if (slider.settings.prevSelector) {
                $(slider.settings.prevSelector).append(slider.controls.prev);
            }
            if (!slider.settings.nextSelector && !slider.settings.prevSelector) {
                slider.controls.directionEl = $('<div class="bx-controls-direction" />');
                slider.controls.directionEl.append(slider.controls.prev).append(slider.controls.next);
                slider.controls.el.addClass("bx-has-controls-direction").append(slider.controls.directionEl);
            }
        };
        var appendControlsAuto = function() {
            slider.controls.start = $('<div class="bx-controls-auto-item"><a class="bx-start" href="">' + slider.settings.startText + "</a></div>");
            slider.controls.stop = $('<div class="bx-controls-auto-item"><a class="bx-stop" href="">' + slider.settings.stopText + "</a></div>");
            slider.controls.autoEl = $('<div class="bx-controls-auto" />');
            slider.controls.autoEl.on("click", ".bx-start", clickStartBind);
            slider.controls.autoEl.on("click", ".bx-stop", clickStopBind);
            if (slider.settings.autoControlsCombine) {
                slider.controls.autoEl.append(slider.controls.start);
            } else {
                slider.controls.autoEl.append(slider.controls.start).append(slider.controls.stop);
            }
            if (slider.settings.autoControlsSelector) {
                $(slider.settings.autoControlsSelector).html(slider.controls.autoEl);
            } else {
                slider.controls.el.addClass("bx-has-controls-auto").append(slider.controls.autoEl);
            }
            updateAutoControls(slider.settings.autoStart ? "stop" : "start");
        };
        var appendCaptions = function() {
            slider.children.each(function(index) {
                var title = $(this).find("img:first").attr("title");
                if (title != undefined && ("" + title).length) {
                    $(this).append('<div class="bx-caption"><span>' + title + "</span></div>");
                }
            });
        };
        var clickNextBind = function(e) {
            if (slider.settings.auto) el.stopAuto();
            el.goToNextSlide();
            e.preventDefault();
        };
        var clickPrevBind = function(e) {
            if (slider.settings.auto) el.stopAuto();
            el.goToPrevSlide();
            e.preventDefault();
        };
        var clickStartBind = function(e) {
            el.startAuto();
            e.preventDefault();
        };
        var clickStopBind = function(e) {
            el.stopAuto();
            e.preventDefault();
        };
        var clickPagerBind = function(e) {
            if (slider.settings.auto) el.stopAuto();
            var pagerLink = $(e.currentTarget);
            if (pagerLink.attr("data-slide-index") !== undefined) {
                var pagerIndex = parseInt(pagerLink.attr("data-slide-index"));
                if (pagerIndex != slider.active.index) el.goToSlide(pagerIndex);
                e.preventDefault();
            }
        };
        var updatePagerActive = function(slideIndex) {
            var len = slider.children.length;
            if (slider.settings.pagerType == "short") {
                if (slider.settings.maxSlides > 1) {
                    len = Math.ceil(slider.children.length / slider.settings.maxSlides);
                }
                slider.pagerEl.html(slideIndex + 1 + slider.settings.pagerShortSeparator + len);
                return;
            }
            slider.pagerEl.find("a").removeClass("active");
            slider.pagerEl.each(function(i, el) {
                $(el).find("a").eq(slideIndex).addClass("active");
            });
        };
        var updateAfterSlideTransition = function() {
            if (slider.settings.infiniteLoop) {
                var position = "";
                if (slider.active.index == 0) {
                    position = slider.children.eq(0).position();
                } else if (slider.active.index == getPagerQty() - 1 && slider.carousel) {
                    position = slider.children.eq((getPagerQty() - 1) * getMoveBy()).position();
                } else if (slider.active.index == slider.children.length - 1) {
                    position = slider.children.eq(slider.children.length - 1).position();
                }
                if (position) {
                    if (slider.settings.mode == "horizontal") {
                        setPositionProperty(-position.left, "reset", 0);
                    } else if (slider.settings.mode == "vertical") {
                        setPositionProperty(-position.top, "reset", 0);
                    }
                }
            }
            slider.working = false;
            slider.settings.onSlideAfter(slider.children.eq(slider.active.index), slider.oldIndex, slider.active.index);
        };
        var updateAutoControls = function(state) {
            if (slider.settings.autoControlsCombine) {
                slider.controls.autoEl.html(slider.controls[state]);
            } else {
                slider.controls.autoEl.find("a").removeClass("active");
                slider.controls.autoEl.find("a:not(.bx-" + state + ")").addClass("active");
            }
        };
        var updateDirectionControls = function() {
            if (getPagerQty() == 1) {
                slider.controls.prev.addClass("disabled");
                slider.controls.next.addClass("disabled");
            } else if (!slider.settings.infiniteLoop && slider.settings.hideControlOnEnd) {
                if (slider.active.index == 0) {
                    slider.controls.prev.addClass("disabled");
                    slider.controls.next.removeClass("disabled");
                } else if (slider.active.index == getPagerQty() - 1) {
                    slider.controls.next.addClass("disabled");
                    slider.controls.prev.removeClass("disabled");
                } else {
                    slider.controls.prev.removeClass("disabled");
                    slider.controls.next.removeClass("disabled");
                }
            }
        };
        var initAuto = function() {
            if (slider.settings.autoDelay > 0) {
                var timeout = setTimeout(el.startAuto, slider.settings.autoDelay);
            } else {
                el.startAuto();
            }
            if (slider.settings.autoHover) {
                el.hover(function() {
                    if (slider.interval) {
                        el.stopAuto(true);
                        slider.autoPaused = true;
                    }
                }, function() {
                    if (slider.autoPaused) {
                        el.startAuto(true);
                        slider.autoPaused = null;
                    }
                });
            }
        };
        var initTicker = function() {
            var startPosition = 0;
            if (slider.settings.autoDirection == "next") {
                el.append(slider.children.clone().addClass("bx-clone"));
            } else {
                el.prepend(slider.children.clone().addClass("bx-clone"));
                var position = slider.children.first().position();
                startPosition = slider.settings.mode == "horizontal" ? -position.left : -position.top;
            }
            setPositionProperty(startPosition, "reset", 0);
            slider.settings.pager = false;
            slider.settings.controls = false;
            slider.settings.autoControls = false;
            if (slider.settings.tickerHover && !slider.usingCSS) {
                slider.viewport.hover(function() {
                    el.stop();
                }, function() {
                    var totalDimens = 0;
                    slider.children.each(function(index) {
                        totalDimens += slider.settings.mode == "horizontal" ? $(this).outerWidth(true) : $(this).outerHeight(true);
                    });
                    var ratio = slider.settings.speed / totalDimens;
                    var property = slider.settings.mode == "horizontal" ? "left" : "top";
                    var newSpeed = ratio * (totalDimens - Math.abs(parseInt(el.css(property))));
                    tickerLoop(newSpeed);
                });
            }
            tickerLoop();
        };
        var tickerLoop = function(resumeSpeed) {
            speed = resumeSpeed ? resumeSpeed : slider.settings.speed;
            var position = {
                left: 0,
                top: 0
            };
            var reset = {
                left: 0,
                top: 0
            };
            if (slider.settings.autoDirection == "next") {
                position = el.find(".bx-clone").first().position();
            } else {
                reset = slider.children.first().position();
            }
            var animateProperty = slider.settings.mode == "horizontal" ? -position.left : -position.top;
            var resetValue = slider.settings.mode == "horizontal" ? -reset.left : -reset.top;
            var params = {
                resetValue: resetValue
            };
            setPositionProperty(animateProperty, "ticker", speed, params);
        };
        var initTouch = function() {
            slider.touch = {
                start: {
                    x: 0,
                    y: 0
                },
                end: {
                    x: 0,
                    y: 0
                }
            };
            slider.viewport.bind("touchstart", onTouchStart);
        };
        var onTouchStart = function(e) {
            if (slider.working) {
                e.preventDefault();
            } else {
                slider.touch.originalPos = el.position();
                var orig = e.originalEvent;
                slider.touch.start.x = orig.changedTouches[0].pageX;
                slider.touch.start.y = orig.changedTouches[0].pageY;
                slider.viewport.bind("touchmove", onTouchMove);
                slider.viewport.bind("touchend", onTouchEnd);
            }
        };
        var onTouchMove = function(e) {
            var orig = e.originalEvent;
            var xMovement = Math.abs(orig.changedTouches[0].pageX - slider.touch.start.x);
            var yMovement = Math.abs(orig.changedTouches[0].pageY - slider.touch.start.y);
            if (xMovement * 3 > yMovement && slider.settings.preventDefaultSwipeX) {
                e.preventDefault();
            } else if (yMovement * 3 > xMovement && slider.settings.preventDefaultSwipeY) {
                e.preventDefault();
            }
            if (slider.settings.mode != "fade" && slider.settings.oneToOneTouch) {
                var value = 0;
                if (slider.settings.mode == "horizontal") {
                    var change = orig.changedTouches[0].pageX - slider.touch.start.x;
                    value = slider.touch.originalPos.left + change;
                } else {
                    var change = orig.changedTouches[0].pageY - slider.touch.start.y;
                    value = slider.touch.originalPos.top + change;
                }
                setPositionProperty(value, "reset", 0);
            }
        };
        var onTouchEnd = function(e) {
            slider.viewport.unbind("touchmove", onTouchMove);
            var orig = e.originalEvent;
            var value = 0;
            slider.touch.end.x = orig.changedTouches[0].pageX;
            slider.touch.end.y = orig.changedTouches[0].pageY;
            if (slider.settings.mode == "fade") {
                var distance = Math.abs(slider.touch.start.x - slider.touch.end.x);
                if (distance >= slider.settings.swipeThreshold) {
                    slider.touch.start.x > slider.touch.end.x ? el.goToNextSlide() : el.goToPrevSlide();
                    el.stopAuto();
                }
            } else {
                var distance = 0;
                if (slider.settings.mode == "horizontal") {
                    distance = slider.touch.end.x - slider.touch.start.x;
                    value = slider.touch.originalPos.left;
                } else {
                    distance = slider.touch.end.y - slider.touch.start.y;
                    value = slider.touch.originalPos.top;
                }
                if (!slider.settings.infiniteLoop && (slider.active.index == 0 && distance > 0 || slider.active.last && distance < 0)) {
                    setPositionProperty(value, "reset", 200);
                } else {
                    if (Math.abs(distance) >= slider.settings.swipeThreshold) {
                        distance < 0 ? el.goToNextSlide() : el.goToPrevSlide();
                        el.stopAuto();
                    } else {
                        setPositionProperty(value, "reset", 200);
                    }
                }
            }
            slider.viewport.unbind("touchend", onTouchEnd);
        };
        var resizeWindow = function(e) {
            if (!slider.initialized) return;
            var windowWidthNew = $(window).width();
            var windowHeightNew = $(window).height();
            if (windowWidth != windowWidthNew || windowHeight != windowHeightNew) {
                windowWidth = windowWidthNew;
                windowHeight = windowHeightNew;
                el.redrawSlider();
                slider.working = false;
                slider.settings.onSliderResize.call(el, slider.active.index);
            }
        };
        el.goToSlide = function(slideIndex, direction) {
            if (slider.working || slider.active.index == slideIndex) return;
            slider.working = true;
            slider.oldIndex = slider.active.index;
            if (slideIndex < 0) {
                slider.active.index = getPagerQty() - 1;
            } else if (slideIndex >= getPagerQty()) {
                slider.active.index = 0;
            } else {
                slider.active.index = slideIndex;
            }
            slider.settings.onSlideBefore(slider.children.eq(slider.active.index), slider.oldIndex, slider.active.index);
            if (direction == "next") {
                slider.settings.onSlideNext(slider.children.eq(slider.active.index), slider.oldIndex, slider.active.index);
            } else if (direction == "prev") {
                slider.settings.onSlidePrev(slider.children.eq(slider.active.index), slider.oldIndex, slider.active.index);
            }
            slider.active.last = slider.active.index >= getPagerQty() - 1;
            if (slider.settings.pager) updatePagerActive(slider.active.index);
            if (slider.settings.controls) updateDirectionControls();
            if (slider.settings.mode == "fade") {
                if (slider.settings.adaptiveHeight && slider.viewport.height() != getViewportHeight()) {
                    slider.viewport.animate({
                        height: getViewportHeight()
                    }, slider.settings.adaptiveHeightSpeed);
                }
                slider.children.filter(":visible").fadeOut(slider.settings.speed).css({
                    zIndex: 0
                });
                slider.children.eq(slider.active.index).css("zIndex", slider.settings.slideZIndex + 1).fadeIn(slider.settings.speed, function() {
                    $(this).css("zIndex", slider.settings.slideZIndex);
                    updateAfterSlideTransition();
                });
            } else {
                if (slider.settings.adaptiveHeight && slider.viewport.height() != getViewportHeight()) {
                    slider.viewport.animate({
                        height: getViewportHeight()
                    }, slider.settings.adaptiveHeightSpeed);
                }
                var moveBy = 0;
                var position = {
                    left: 0,
                    top: 0
                };
                if (!slider.settings.infiniteLoop && slider.carousel && slider.active.last) {
                    if (slider.settings.mode == "horizontal") {
                        var lastChild = slider.children.eq(slider.children.length - 1);
                        position = lastChild.position();
                        moveBy = slider.viewport.width() - lastChild.outerWidth();
                    } else {
                        var lastShowingIndex = slider.children.length - slider.settings.minSlides;
                        position = slider.children.eq(lastShowingIndex).position();
                    }
                } else if (slider.carousel && slider.active.last && direction == "prev") {
                    var eq = slider.settings.moveSlides == 1 ? slider.settings.maxSlides - getMoveBy() : (getPagerQty() - 1) * getMoveBy() - (slider.children.length - slider.settings.maxSlides);
                    var lastChild = el.children(".bx-clone").eq(eq);
                    position = lastChild.position();
                } else if (direction == "next" && slider.active.index == 0) {
                    position = el.find("> .bx-clone").eq(slider.settings.maxSlides).position();
                    slider.active.last = false;
                } else if (slideIndex >= 0) {
                    var requestEl = slideIndex * getMoveBy();
                    position = slider.children.eq(requestEl).position();
                }
                if ("undefined" !== typeof position) {
                    var value = slider.settings.mode == "horizontal" ? -(position.left - moveBy) : -position.top;
                    setPositionProperty(value, "slide", slider.settings.speed);
                }
            }
        };
        el.goToNextSlide = function() {
            if (!slider.settings.infiniteLoop && slider.active.last) return;
            var pagerIndex = parseInt(slider.active.index) + 1;
            el.goToSlide(pagerIndex, "next");
        };
        el.goToPrevSlide = function() {
            if (!slider.settings.infiniteLoop && slider.active.index == 0) return;
            var pagerIndex = parseInt(slider.active.index) - 1;
            el.goToSlide(pagerIndex, "prev");
        };
        el.startAuto = function(preventControlUpdate) {
            if (slider.interval) return;
            slider.interval = setInterval(function() {
                slider.settings.autoDirection == "next" ? el.goToNextSlide() : el.goToPrevSlide();
            }, slider.settings.pause);
            if (slider.settings.autoControls && preventControlUpdate != true) updateAutoControls("stop");
        };
        el.stopAuto = function(preventControlUpdate) {
            if (!slider.interval) return;
            clearInterval(slider.interval);
            slider.interval = null;
            if (slider.settings.autoControls && preventControlUpdate != true) updateAutoControls("start");
        };
        el.getCurrentSlide = function() {
            return slider.active.index;
        };
        el.getCurrentSlideElement = function() {
            return slider.children.eq(slider.active.index);
        };
        el.getSlideCount = function() {
            return slider.children.length;
        };
        el.redrawSlider = function() {
            slider.children.add(el.find(".bx-clone")).width(getSlideWidth());
            slider.viewport.css("height", getViewportHeight());
            if (!slider.settings.ticker) setSlidePosition();
            if (slider.active.last) slider.active.index = getPagerQty() - 1;
            if (slider.active.index >= getPagerQty()) slider.active.last = true;
            if (slider.settings.pager && !slider.settings.pagerCustom) {
                populatePager();
                updatePagerActive(slider.active.index);
            }
        };
        el.destroySlider = function() {
            if (!slider.initialized) return;
            slider.initialized = false;
            $(".bx-clone", this).remove();
            slider.children.each(function() {
                $(this).data("origStyle") != undefined ? $(this).attr("style", $(this).data("origStyle")) : $(this).removeAttr("style");
            });
            $(this).data("origStyle") != undefined ? this.attr("style", $(this).data("origStyle")) : $(this).removeAttr("style");
            $(this).unwrap().unwrap();
            if (slider.controls.el) slider.controls.el.remove();
            if (slider.controls.next) slider.controls.next.remove();
            if (slider.controls.prev) slider.controls.prev.remove();
            if (slider.pagerEl && slider.settings.controls) slider.pagerEl.remove();
            $(".bx-caption", this).remove();
            if (slider.controls.autoEl) slider.controls.autoEl.remove();
            clearInterval(slider.interval);
            if (slider.settings.responsive) $(window).unbind("resize", resizeWindow);
        };
        el.reloadSlider = function(settings) {
            if (settings != undefined) options = settings;
            el.destroySlider();
            init();
        };
        init();
        return this;
    };
})(jQuery);

(function() {
    var $, AbstractChosen, Chosen, SelectParser, _ref, __hasProp = {}.hasOwnProperty, __extends = function(child, parent) {
        for (var key in parent) {
            if (__hasProp.call(parent, key)) child[key] = parent[key];
        }
        function ctor() {
            this.constructor = child;
        }
        ctor.prototype = parent.prototype;
        child.prototype = new ctor();
        child.__super__ = parent.prototype;
        return child;
    };
    SelectParser = function() {
        function SelectParser() {
            this.options_index = 0;
            this.parsed = [];
        }
        SelectParser.prototype.add_node = function(child) {
            if (child.nodeName.toUpperCase() === "OPTGROUP") {
                return this.add_group(child);
            } else {
                return this.add_option(child);
            }
        };
        SelectParser.prototype.add_group = function(group) {
            var group_position, option, _i, _len, _ref, _results;
            group_position = this.parsed.length;
            this.parsed.push({
                array_index: group_position,
                group: true,
                label: this.escapeExpression(group.label),
                children: 0,
                disabled: group.disabled
            });
            _ref = group.childNodes;
            _results = [];
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                option = _ref[_i];
                _results.push(this.add_option(option, group_position, group.disabled));
            }
            return _results;
        };
        SelectParser.prototype.add_option = function(option, group_position, group_disabled) {
            if (option.nodeName.toUpperCase() === "OPTION") {
                if (option.text !== "") {
                    if (group_position != null) {
                        this.parsed[group_position].children += 1;
                    }
                    this.parsed.push({
                        array_index: this.parsed.length,
                        options_index: this.options_index,
                        value: option.value,
                        text: option.text,
                        html: option.innerHTML,
                        selected: option.selected,
                        disabled: group_disabled === true ? group_disabled : option.disabled,
                        group_array_index: group_position,
                        classes: option.className,
                        style: option.style.cssText
                    });
                } else {
                    this.parsed.push({
                        array_index: this.parsed.length,
                        options_index: this.options_index,
                        empty: true
                    });
                }
                return this.options_index += 1;
            }
        };
        SelectParser.prototype.escapeExpression = function(text) {
            var map, unsafe_chars;
            if (text == null || text === false) {
                return "";
            }
            if (!/[\&\<\>\"\'\`]/.test(text)) {
                return text;
            }
            map = {
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#x27;",
                "`": "&#x60;"
            };
            unsafe_chars = /&(?!\w+;)|[\<\>\"\'\`]/g;
            return text.replace(unsafe_chars, function(chr) {
                return map[chr] || "&amp;";
            });
        };
        return SelectParser;
    }();
    SelectParser.select_to_array = function(select) {
        var child, parser, _i, _len, _ref;
        parser = new SelectParser();
        _ref = select.childNodes;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            child = _ref[_i];
            parser.add_node(child);
        }
        return parser.parsed;
    };
    AbstractChosen = function() {
        function AbstractChosen(form_field, options) {
            this.form_field = form_field;
            this.options = options != null ? options : {};
            if (!AbstractChosen.browser_is_supported()) {
                return;
            }
            this.is_multiple = this.form_field.multiple;
            this.set_default_text();
            this.set_default_values();
            this.setup();
            this.set_up_html();
            this.register_observers();
        }
        AbstractChosen.prototype.set_default_values = function() {
            var _this = this;
            this.click_test_action = function(evt) {
                return _this.test_active_click(evt);
            };
            this.activate_action = function(evt) {
                return _this.activate_field(evt);
            };
            this.active_field = false;
            this.mouse_on_container = false;
            this.results_showing = false;
            this.result_highlighted = null;
            this.allow_single_deselect = this.options.allow_single_deselect != null && this.form_field.options[0] != null && this.form_field.options[0].text === "" ? this.options.allow_single_deselect : false;
            this.disable_search_threshold = this.options.disable_search_threshold || 0;
            this.disable_search = this.options.disable_search || false;
            this.enable_split_word_search = this.options.enable_split_word_search != null ? this.options.enable_split_word_search : true;
            this.group_search = this.options.group_search != null ? this.options.group_search : true;
            this.search_contains = this.options.search_contains || false;
            this.single_backstroke_delete = this.options.single_backstroke_delete != null ? this.options.single_backstroke_delete : true;
            this.max_selected_options = this.options.max_selected_options || Infinity;
            this.inherit_select_classes = this.options.inherit_select_classes || false;
            this.display_selected_options = this.options.display_selected_options != null ? this.options.display_selected_options : true;
            return this.display_disabled_options = this.options.display_disabled_options != null ? this.options.display_disabled_options : true;
        };
        AbstractChosen.prototype.set_default_text = function() {
            if (this.form_field.getAttribute("data-placeholder")) {
                this.default_text = this.form_field.getAttribute("data-placeholder");
            } else if (this.is_multiple) {
                this.default_text = this.options.placeholder_text_multiple || this.options.placeholder_text || AbstractChosen.default_multiple_text;
            } else {
                this.default_text = this.options.placeholder_text_single || this.options.placeholder_text || AbstractChosen.default_single_text;
            }
            return this.results_none_found = this.form_field.getAttribute("data-no_results_text") || this.options.no_results_text || AbstractChosen.default_no_result_text;
        };
        AbstractChosen.prototype.mouse_enter = function() {
            return this.mouse_on_container = true;
        };
        AbstractChosen.prototype.mouse_leave = function() {
            return this.mouse_on_container = false;
        };
        AbstractChosen.prototype.input_focus = function(evt) {
            var _this = this;
            if (this.is_multiple) {
                if (!this.active_field) {
                    return setTimeout(function() {
                        return _this.container_mousedown();
                    }, 50);
                }
            } else {
                if (!this.active_field) {
                    return this.activate_field();
                }
            }
        };
        AbstractChosen.prototype.input_blur = function(evt) {
            var _this = this;
            if (!this.mouse_on_container) {
                this.active_field = false;
                return setTimeout(function() {
                    return _this.blur_test();
                }, 100);
            }
        };
        AbstractChosen.prototype.results_option_build = function(options) {
            var content, data, _i, _len, _ref;
            content = "";
            _ref = this.results_data;
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                data = _ref[_i];
                if (data.group) {
                    content += this.result_add_group(data);
                } else {
                    content += this.result_add_option(data);
                }
                if (options != null ? options.first : void 0) {
                    if (data.selected && this.is_multiple) {
                        this.choice_build(data);
                    } else if (data.selected && !this.is_multiple) {
                        this.single_set_selected_text(data.text);
                    }
                }
            }
            return content;
        };
        AbstractChosen.prototype.result_add_option = function(option) {
            var classes, option_el;
            if (!option.search_match) {
                return "";
            }
            if (!this.include_option_in_results(option)) {
                return "";
            }
            classes = [];
            if (!option.disabled && !(option.selected && this.is_multiple)) {
                classes.push("active-result");
            }
            if (option.disabled && !(option.selected && this.is_multiple)) {
                classes.push("disabled-result");
            }
            if (option.selected) {
                classes.push("result-selected");
            }
            if (option.group_array_index != null) {
                classes.push("group-option");
            }
            if (option.classes !== "") {
                classes.push(option.classes);
            }
            option_el = document.createElement("li");
            option_el.className = classes.join(" ");
            option_el.style.cssText = option.style;
            option_el.setAttribute("data-option-array-index", option.array_index);
            option_el.innerHTML = option.search_text;
            return this.outerHTML(option_el);
        };
        AbstractChosen.prototype.result_add_group = function(group) {
            var group_el;
            if (!(group.search_match || group.group_match)) {
                return "";
            }
            if (!(group.active_options > 0)) {
                return "";
            }
            group_el = document.createElement("li");
            group_el.className = "group-result";
            group_el.innerHTML = group.search_text;
            return this.outerHTML(group_el);
        };
        AbstractChosen.prototype.results_update_field = function() {
            this.set_default_text();
            if (!this.is_multiple) {
                this.results_reset_cleanup();
            }
            this.result_clear_highlight();
            this.results_build();
            if (this.results_showing) {
                return this.winnow_results();
            }
        };
        AbstractChosen.prototype.reset_single_select_options = function() {
            var result, _i, _len, _ref, _results;
            _ref = this.results_data;
            _results = [];
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                result = _ref[_i];
                if (result.selected) {
                    _results.push(result.selected = false);
                } else {
                    _results.push(void 0);
                }
            }
            return _results;
        };
        AbstractChosen.prototype.results_toggle = function() {
            if (this.results_showing) {
                return this.results_hide();
            } else {
                return this.results_show();
            }
        };
        AbstractChosen.prototype.results_search = function(evt) {
            if (this.results_showing) {
                return this.winnow_results();
            } else {
                return this.results_show();
            }
        };
        AbstractChosen.prototype.winnow_results = function() {
            var escapedSearchText, option, regex, results, results_group, searchText, startpos, text, zregex, _i, _len, _ref;
            this.no_results_clear();
            results = 0;
            searchText = this.get_search_text();
            escapedSearchText = searchText.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, "\\$&");
            zregex = new RegExp(escapedSearchText, "i");
            regex = this.get_search_regex(escapedSearchText);
            _ref = this.results_data;
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                option = _ref[_i];
                option.search_match = false;
                results_group = null;
                if (this.include_option_in_results(option)) {
                    if (option.group) {
                        option.group_match = false;
                        option.active_options = 0;
                    }
                    if (option.group_array_index != null && this.results_data[option.group_array_index]) {
                        results_group = this.results_data[option.group_array_index];
                        if (results_group.active_options === 0 && results_group.search_match) {
                            results += 1;
                        }
                        results_group.active_options += 1;
                    }
                    if (!(option.group && !this.group_search)) {
                        option.search_text = option.group ? option.label : option.text;
                        option.search_match = this.search_string_match(option.search_text, regex);
                        if (option.search_match && !option.group) {
                            results += 1;
                        }
                        if (option.search_match) {
                            if (searchText.length) {
                                startpos = option.search_text.search(zregex);
                                text = option.search_text.substr(0, startpos + searchText.length) + "</em>" + option.search_text.substr(startpos + searchText.length);
                                option.search_text = text.substr(0, startpos) + "<em>" + text.substr(startpos);
                            }
                            if (results_group != null) {
                                results_group.group_match = true;
                            }
                        } else if (option.group_array_index != null && this.results_data[option.group_array_index].search_match) {
                            option.search_match = true;
                        }
                    }
                }
            }
            this.result_clear_highlight();
            if (results < 1 && searchText.length) {
                this.update_results_content("");
                return this.no_results(searchText);
            } else {
                this.update_results_content(this.results_option_build());
                return this.winnow_results_set_highlight();
            }
        };
        AbstractChosen.prototype.get_search_regex = function(escaped_search_string) {
            var regex_anchor;
            regex_anchor = this.search_contains ? "" : "^";
            return new RegExp(regex_anchor + escaped_search_string, "i");
        };
        AbstractChosen.prototype.search_string_match = function(search_string, regex) {
            var part, parts, _i, _len;
            if (regex.test(search_string)) {
                return true;
            } else if (this.enable_split_word_search && (search_string.indexOf(" ") >= 0 || search_string.indexOf("[") === 0)) {
                parts = search_string.replace(/\[|\]/g, "").split(" ");
                if (parts.length) {
                    for (_i = 0, _len = parts.length; _i < _len; _i++) {
                        part = parts[_i];
                        if (regex.test(part)) {
                            return true;
                        }
                    }
                }
            }
        };
        AbstractChosen.prototype.choices_count = function() {
            var option, _i, _len, _ref;
            if (this.selected_option_count != null) {
                return this.selected_option_count;
            }
            this.selected_option_count = 0;
            _ref = this.form_field.options;
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                option = _ref[_i];
                if (option.selected) {
                    this.selected_option_count += 1;
                }
            }
            return this.selected_option_count;
        };
        AbstractChosen.prototype.choices_click = function(evt) {
            evt.preventDefault();
            if (!(this.results_showing || this.is_disabled)) {
                return this.results_show();
            }
        };
        AbstractChosen.prototype.keyup_checker = function(evt) {
            var stroke, _ref;
            stroke = (_ref = evt.which) != null ? _ref : evt.keyCode;
            this.search_field_scale();
            switch (stroke) {
              case 8:
                if (this.is_multiple && this.backstroke_length < 1 && this.choices_count() > 0) {
                    return this.keydown_backstroke();
                } else if (!this.pending_backstroke) {
                    this.result_clear_highlight();
                    return this.results_search();
                }
                break;

              case 13:
                evt.preventDefault();
                if (this.results_showing) {
                    return this.result_select(evt);
                }
                break;

              case 27:
                if (this.results_showing) {
                    this.results_hide();
                }
                return true;

              case 9:
              case 38:
              case 40:
              case 16:
              case 91:
              case 17:
                break;

              default:
                return this.results_search();
            }
        };
        AbstractChosen.prototype.clipboard_event_checker = function(evt) {
            var _this = this;
            return setTimeout(function() {
                return _this.results_search();
            }, 50);
        };
        AbstractChosen.prototype.container_width = function() {
            if (this.options.width != null) {
                return this.options.width;
            } else {
                return "" + this.form_field.offsetWidth + "px";
            }
        };
        AbstractChosen.prototype.include_option_in_results = function(option) {
            if (this.is_multiple && (!this.display_selected_options && option.selected)) {
                return false;
            }
            if (!this.display_disabled_options && option.disabled) {
                return false;
            }
            if (option.empty) {
                return false;
            }
            return true;
        };
        AbstractChosen.prototype.search_results_touchstart = function(evt) {
            this.touch_started = true;
            return this.search_results_mouseover(evt);
        };
        AbstractChosen.prototype.search_results_touchmove = function(evt) {
            this.touch_started = false;
            return this.search_results_mouseout(evt);
        };
        AbstractChosen.prototype.search_results_touchend = function(evt) {
            if (this.touch_started) {
                return this.search_results_mouseup(evt);
            }
        };
        AbstractChosen.prototype.outerHTML = function(element) {
            var tmp;
            if (element.outerHTML) {
                return element.outerHTML;
            }
            tmp = document.createElement("div");
            tmp.appendChild(element);
            return tmp.innerHTML;
        };
        AbstractChosen.browser_is_supported = function() {
            if (window.navigator.appName === "Microsoft Internet Explorer") {
                return document.documentMode >= 8;
            }
            if (/iP(od|hone)/i.test(window.navigator.userAgent)) {
                return false;
            }
            if (/Android/i.test(window.navigator.userAgent)) {
                if (/Mobile/i.test(window.navigator.userAgent)) {
                    return false;
                }
            }
            return true;
        };
        AbstractChosen.default_multiple_text = "Select Some Options";
        AbstractChosen.default_single_text = "Select an Option";
        AbstractChosen.default_no_result_text = "No results match";
        return AbstractChosen;
    }();
    $ = jQuery;
    $.fn.extend({
        chosen: function(options) {
            if (!AbstractChosen.browser_is_supported()) {
                return this;
            }
            return this.each(function(input_field) {
                var $this, chosen;
                $this = $(this);
                chosen = $this.data("chosen");
                if (options === "destroy" && chosen instanceof Chosen) {
                    chosen.destroy();
                } else if (!(chosen instanceof Chosen)) {
                    $this.data("chosen", new Chosen(this, options));
                }
            });
        }
    });
    Chosen = function(_super) {
        __extends(Chosen, _super);
        function Chosen() {
            _ref = Chosen.__super__.constructor.apply(this, arguments);
            return _ref;
        }
        Chosen.prototype.setup = function() {
            this.form_field_jq = $(this.form_field);
            this.current_selectedIndex = this.form_field.selectedIndex;
            return this.is_rtl = this.form_field_jq.hasClass("chosen-rtl");
        };
        Chosen.prototype.set_up_html = function() {
            var container_classes, container_props;
            container_classes = [ "chosen-container" ];
            container_classes.push("chosen-container-" + (this.is_multiple ? "multi" : "single"));
            if (this.inherit_select_classes && this.form_field.className) {
                container_classes.push(this.form_field.className);
            }
            if (this.is_rtl) {
                container_classes.push("chosen-rtl");
            }
            container_props = {
                "class": container_classes.join(" "),
                style: "width: " + this.container_width() + ";",
                title: this.form_field.title
            };
            if (this.form_field.id.length) {
                container_props.id = this.form_field.id.replace(/[^\w]/g, "_") + "_chosen";
            }
            this.container = $("<div />", container_props);
            if (this.is_multiple) {
                this.container.html('<ul class="chosen-choices"><li class="search-field"><input type="text" value="' + this.default_text + '" class="default" autocomplete="off" style="width:25px;" /></li></ul><div class="chosen-drop"><ul class="chosen-results"></ul></div>');
            } else {
                this.container.html('<a class="chosen-single chosen-default" tabindex="-1"><span>' + this.default_text + '</span><div><b></b></div></a><div class="chosen-drop"><div class="chosen-search"><input type="text" autocomplete="off" /></div><ul class="chosen-results"></ul></div>');
            }
            this.form_field_jq.hide().after(this.container);
            this.$dropdown = this.container.find("div.chosen-drop").first();
            this.search_field = this.container.find("input").first();
            this.search_results = this.container.find("ul.chosen-results").first();
            this.search_field_scale();
            this.search_no_results = this.container.find("li.no-results").first();
            if (this.is_multiple) {
                this.search_choices = this.container.find("ul.chosen-choices").first();
                this.search_container = this.container.find("li.search-field").first();
            } else {
                this.search_container = this.container.find("div.chosen-search").first();
                this.selected_item = this.container.find(".chosen-single").first();
            }
            this.results_build();
            this.set_tab_index();
            this.set_label_behavior();
            return this.form_field_jq.trigger("chosen:ready", {
                chosen: this
            });
        };
        Chosen.prototype.register_observers = function() {
            var _this = this;
            this.container.bind("touchstart.chosen", function(evt) {
                _this.container_mousedown(evt);
            });
            this.container.bind("touchend.chosen", function(evt) {
                _this.container_mouseup(evt);
            });
            this.container.bind("mousedown.chosen", function(evt) {
                _this.container_mousedown(evt);
            });
            this.container.bind("mouseup.chosen", function(evt) {
                _this.container_mouseup(evt);
            });
            this.container.bind("mouseenter.chosen", function(evt) {
                _this.mouse_enter(evt);
            });
            this.container.bind("mouseleave.chosen", function(evt) {
                _this.mouse_leave(evt);
            });
            this.search_results.bind("mouseup.chosen", function(evt) {
                _this.search_results_mouseup(evt);
            });
            this.search_results.bind("mouseover.chosen", function(evt) {
                _this.search_results_mouseover(evt);
            });
            this.search_results.bind("mouseout.chosen", function(evt) {
                _this.search_results_mouseout(evt);
            });
            this.search_results.bind("mousewheel.chosen DOMMouseScroll.chosen", function(evt) {
                _this.search_results_mousewheel(evt);
            });
            this.search_results.bind("touchstart.chosen", function(evt) {
                _this.search_results_touchstart(evt);
            });
            this.search_results.bind("touchmove.chosen", function(evt) {
                _this.search_results_touchmove(evt);
            });
            this.search_results.bind("touchend.chosen", function(evt) {
                _this.search_results_touchend(evt);
            });
            this.form_field_jq.bind("chosen:updated.chosen", function(evt) {
                _this.results_update_field(evt);
            });
            this.form_field_jq.bind("chosen:activate.chosen", function(evt) {
                _this.activate_field(evt);
            });
            this.form_field_jq.bind("chosen:open.chosen", function(evt) {
                _this.container_mousedown(evt);
            });
            this.form_field_jq.bind("chosen:close.chosen", function(evt) {
                _this.input_blur(evt);
            });
            this.search_field.bind("blur.chosen", function(evt) {
                _this.input_blur(evt);
            });
            this.search_field.bind("keyup.chosen", function(evt) {
                _this.keyup_checker(evt);
            });
            this.search_field.bind("keydown.chosen", function(evt) {
                _this.keydown_checker(evt);
            });
            this.search_field.bind("focus.chosen", function(evt) {
                _this.input_focus(evt);
            });
            this.search_field.bind("cut.chosen", function(evt) {
                _this.clipboard_event_checker(evt);
            });
            this.search_field.bind("paste.chosen", function(evt) {
                _this.clipboard_event_checker(evt);
            });
            if (this.is_multiple) {
                return this.search_choices.bind("click.chosen", function(evt) {
                    _this.choices_click(evt);
                });
            } else {
                return this.container.bind("click.chosen", function(evt) {
                    evt.preventDefault();
                });
            }
        };
        Chosen.prototype.destroy = function() {
            $(this.container[0].ownerDocument).unbind("click.chosen", this.click_test_action);
            if (this.search_field[0].tabIndex) {
                this.form_field_jq[0].tabIndex = this.search_field[0].tabIndex;
            }
            this.container.remove();
            this.form_field_jq.removeData("chosen");
            return this.form_field_jq.show();
        };
        Chosen.prototype.search_field_disabled = function() {
            this.is_disabled = this.form_field_jq[0].disabled;
            if (this.is_disabled) {
                this.container.addClass("chosen-disabled");
                this.search_field[0].disabled = true;
                if (!this.is_multiple) {
                    this.selected_item.unbind("focus.chosen", this.activate_action);
                }
                return this.close_field();
            } else {
                this.container.removeClass("chosen-disabled");
                this.search_field[0].disabled = false;
                if (!this.is_multiple) {
                    return this.selected_item.bind("focus.chosen", this.activate_action);
                }
            }
        };
        Chosen.prototype.container_mousedown = function(evt) {
            if (!this.is_disabled) {
                if (evt && evt.type === "mousedown" && !this.results_showing) {
                    evt.preventDefault();
                }
                if (window.navigator.msMaxTouchPoints === 0 && evt.type === "touchstart") {
                    return;
                }
                if (!(evt != null && $(evt.target).hasClass("search-choice-close"))) {
                    if (!this.active_field) {
                        if (this.is_multiple) {
                            this.search_field.val("");
                        }
                        $(this.container[0].ownerDocument).bind("click.chosen", this.click_test_action);
                        this.results_show();
                    } else if (!this.is_multiple && evt && ($(evt.target)[0] === this.selected_item[0] || $(evt.target).parents("a.chosen-single").length)) {
                        evt.preventDefault();
                        this.results_toggle();
                    }
                    return this.activate_field();
                }
            }
        };
        Chosen.prototype.container_mouseup = function(evt) {
            if (evt.target.nodeName === "ABBR" && !this.is_disabled) {
                return this.results_reset(evt);
            }
        };
        Chosen.prototype.search_results_mousewheel = function(evt) {
            var delta;
            if (evt.originalEvent) {
                delta = evt.originalEvent.deltaY || -evt.originalEvent.wheelDelta || evt.originalEvent.detail;
            }
            if (delta != null) {
                evt.preventDefault();
                if (evt.type === "DOMMouseScroll") {
                    delta = delta * 40;
                }
                return this.search_results.scrollTop(delta + this.search_results.scrollTop());
            }
        };
        Chosen.prototype.blur_test = function(evt) {
            if (!this.active_field && this.container.hasClass("chosen-container-active")) {
                return this.close_field();
            }
        };
        Chosen.prototype.close_field = function() {
            $(this.container[0].ownerDocument).unbind("click.chosen", this.click_test_action);
            this.active_field = false;
            this.results_hide();
            this.container.removeClass("chosen-container-active");
            this.clear_backstroke();
            this.show_search_field_default();
            return this.search_field_scale();
        };
        Chosen.prototype.activate_field = function() {
            this.container.addClass("chosen-container-active");
            this.active_field = true;
            this.search_field.val(this.search_field.val());
            return this.search_field.focus();
        };
        Chosen.prototype.test_active_click = function(evt) {
            var active_container;
            active_container = $(evt.target).closest(".chosen-container");
            if (active_container.length && this.container[0] === active_container[0]) {
                return this.active_field = true;
            } else {
                return this.close_field();
            }
        };
        Chosen.prototype.results_build = function() {
            this.parsing = true;
            this.selected_option_count = null;
            this.results_data = SelectParser.select_to_array(this.form_field);
            if (this.is_multiple) {
                this.search_choices.find("li.search-choice").remove();
            } else if (!this.is_multiple) {
                this.single_set_selected_text();
                if (this.disable_search || this.form_field.options.length <= this.disable_search_threshold) {
                    this.search_field[0].readOnly = true;
                    this.container.addClass("chosen-container-single-nosearch");
                } else {
                    this.search_field[0].readOnly = false;
                    this.container.removeClass("chosen-container-single-nosearch");
                }
            }
            this.update_results_content(this.results_option_build({
                first: true
            }));
            this.search_field_disabled();
            this.show_search_field_default();
            this.search_field_scale();
            return this.parsing = false;
        };
        Chosen.prototype.result_do_highlight = function(el) {
            var high_bottom, high_top, maxHeight, visible_bottom, visible_top;
            if (el.length) {
                this.result_clear_highlight();
                this.result_highlight = el;
                this.result_highlight.addClass("highlighted");
                maxHeight = parseInt(this.search_results.css("maxHeight"), 10);
                visible_top = this.search_results.scrollTop();
                visible_bottom = maxHeight + visible_top;
                high_top = this.result_highlight.position().top + this.search_results.scrollTop();
                high_bottom = high_top + this.result_highlight.outerHeight();
                if (high_bottom >= visible_bottom) {
                    return this.search_results.scrollTop(high_bottom - maxHeight > 0 ? high_bottom - maxHeight : 0);
                } else if (high_top < visible_top) {
                    return this.search_results.scrollTop(high_top);
                }
            }
        };
        Chosen.prototype.result_clear_highlight = function() {
            if (this.result_highlight) {
                this.result_highlight.removeClass("highlighted");
            }
            return this.result_highlight = null;
        };
        Chosen.prototype.results_show = function() {
            if (this.is_multiple && this.max_selected_options <= this.choices_count()) {
                this.form_field_jq.trigger("chosen:maxselected", {
                    chosen: this
                });
                return false;
            }
            this.container.addClass("chosen-with-drop");
            this.results_showing = true;
            this.search_field.focus();
            this.search_field.val(this.search_field.val());
            this.winnow_results();
            return this.form_field_jq.trigger("chosen:showing_dropdown", {
                chosen: this
            });
        };
        Chosen.prototype.update_results_content = function(content) {
            return this.search_results.html(content);
        };
        Chosen.prototype.results_hide = function() {
            if (this.results_showing) {
                this.result_clear_highlight();
                this.container.removeClass("chosen-with-drop");
                this.form_field_jq.trigger("chosen:hiding_dropdown", {
                    chosen: this
                });
            }
            return this.results_showing = false;
        };
        Chosen.prototype.set_tab_index = function(el) {
            var ti;
            if (this.form_field.tabIndex) {
                ti = this.form_field.tabIndex;
                this.form_field.tabIndex = -1;
                return this.search_field[0].tabIndex = ti;
            }
        };
        Chosen.prototype.set_label_behavior = function() {
            var _this = this;
            this.form_field_label = this.form_field_jq.parents("label");
            if (!this.form_field_label.length && this.form_field.id.length) {
                this.form_field_label = $("label[for='" + this.form_field.id + "']");
            }
            if (this.form_field_label.length > 0) {
                return this.form_field_label.bind("click.chosen", function(evt) {
                    if (_this.is_multiple) {
                        return _this.container_mousedown(evt);
                    } else {
                        return _this.activate_field();
                    }
                });
            }
        };
        Chosen.prototype.show_search_field_default = function() {
            if (this.is_multiple && this.choices_count() < 1 && !this.active_field) {
                this.search_field.val(this.default_text);
                return this.search_field.addClass("default");
            } else {
                this.search_field.val("");
                return this.search_field.removeClass("default");
            }
        };
        Chosen.prototype.search_results_mouseup = function(evt) {
            var target;
            target = $(evt.target).hasClass("active-result") ? $(evt.target) : $(evt.target).parents(".active-result").first();
            if (target.length) {
                this.result_highlight = target;
                this.result_select(evt);
                return this.search_field.focus();
            }
        };
        Chosen.prototype.search_results_mouseover = function(evt) {
            var target;
            target = $(evt.target).hasClass("active-result") ? $(evt.target) : $(evt.target).parents(".active-result").first();
            if (target) {
                return this.result_do_highlight(target);
            }
        };
        Chosen.prototype.search_results_mouseout = function(evt) {
            if ($(evt.target).hasClass("active-result" || $(evt.target).parents(".active-result").first())) {
                return this.result_clear_highlight();
            }
        };
        Chosen.prototype.choice_build = function(item) {
            var choice, close_link, _this = this;
            choice = $("<li />", {
                "class": "search-choice"
            }).html("<span>" + item.html + "</span>");
            if (item.disabled) {
                choice.addClass("search-choice-disabled");
            } else {
                close_link = $("<a />", {
                    "class": "search-choice-close",
                    "data-option-array-index": item.array_index
                });
                close_link.bind("click.chosen", function(evt) {
                    return _this.choice_destroy_link_click(evt);
                });
                choice.append(close_link);
            }
            return this.search_container.before(choice);
        };
        Chosen.prototype.choice_destroy_link_click = function(evt) {
            evt.preventDefault();
            evt.stopPropagation();
            if (!this.is_disabled) {
                return this.choice_destroy($(evt.target));
            }
        };
        Chosen.prototype.choice_destroy = function(link) {
            if (this.result_deselect(link[0].getAttribute("data-option-array-index"))) {
                this.show_search_field_default();
                if (this.is_multiple && this.choices_count() > 0 && this.search_field.val().length < 1) {
                    this.results_hide();
                }
                link.parents("li").first().remove();
                return this.search_field_scale();
            }
        };
        Chosen.prototype.results_reset = function() {
            this.reset_single_select_options();
            this.form_field.options[0].selected = true;
            this.single_set_selected_text();
            this.show_search_field_default();
            this.results_reset_cleanup();
            this.form_field_jq.trigger("change");
            if (this.active_field) {
                return this.results_hide();
            }
        };
        Chosen.prototype.results_reset_cleanup = function() {
            this.current_selectedIndex = this.form_field.selectedIndex;
            return this.selected_item.find("abbr").remove();
        };
        Chosen.prototype.result_select = function(evt) {
            var high, item;
            if (this.result_highlight) {
                high = this.result_highlight;
                this.result_clear_highlight();
                if (this.is_multiple && this.max_selected_options <= this.choices_count()) {
                    this.form_field_jq.trigger("chosen:maxselected", {
                        chosen: this
                    });
                    return false;
                }
                if (this.is_multiple) {
                    high.removeClass("active-result");
                } else {
                    this.reset_single_select_options();
                }
                item = this.results_data[high[0].getAttribute("data-option-array-index")];
                item.selected = true;
                this.form_field.options[item.options_index].selected = true;
                this.selected_option_count = null;
                if (this.is_multiple) {
                    this.choice_build(item);
                } else {
                    this.single_set_selected_text(item.text);
                }
                if (!((evt.metaKey || evt.ctrlKey) && this.is_multiple)) {
                    this.results_hide();
                }
                this.search_field.val("");
                if (this.is_multiple || this.form_field.selectedIndex !== this.current_selectedIndex) {
                    this.form_field_jq.trigger("change", {
                        selected: this.form_field.options[item.options_index].value
                    });
                }
                this.current_selectedIndex = this.form_field.selectedIndex;
                return this.search_field_scale();
            }
        };
        Chosen.prototype.single_set_selected_text = function(text) {
            if (text == null) {
                text = this.default_text;
            }
            if (text === this.default_text) {
                this.selected_item.addClass("chosen-default");
            } else {
                this.single_deselect_control_build();
                this.selected_item.removeClass("chosen-default");
            }
            return this.selected_item.find("span").text(text);
        };
        Chosen.prototype.result_deselect = function(pos) {
            var result_data;
            result_data = this.results_data[pos];
            if (!this.form_field.options[result_data.options_index].disabled) {
                result_data.selected = false;
                this.form_field.options[result_data.options_index].selected = false;
                this.selected_option_count = null;
                this.result_clear_highlight();
                if (this.results_showing) {
                    this.winnow_results();
                }
                this.form_field_jq.trigger("change", {
                    deselected: this.form_field.options[result_data.options_index].value
                });
                this.search_field_scale();
                return true;
            } else {
                return false;
            }
        };
        Chosen.prototype.single_deselect_control_build = function() {
            if (!this.allow_single_deselect) {
                return;
            }
            if (!this.selected_item.find("abbr").length) {
                this.selected_item.find("span").first().after('<abbr class="search-choice-close"></abbr>');
            }
            return this.selected_item.addClass("chosen-single-with-deselect");
        };
        Chosen.prototype.get_search_text = function() {
            if (this.search_field.val() === this.default_text) {
                return "";
            } else {
                return $("<div/>").text($.trim(this.search_field.val())).html();
            }
        };
        Chosen.prototype.winnow_results_set_highlight = function() {
            var do_high, selected_results;
            selected_results = !this.is_multiple ? this.search_results.find(".result-selected.active-result") : [];
            do_high = selected_results.length ? selected_results.first() : this.search_results.find(".active-result").first();
            if (do_high != null) {
                return this.result_do_highlight(do_high);
            }
        };
        Chosen.prototype.no_results = function(terms) {
            var no_results_html;
            no_results_html = $('<li class="no-results">' + this.results_none_found + ' "<span></span>"</li>');
            no_results_html.find("span").first().html(terms);
            this.search_results.append(no_results_html);
            return this.form_field_jq.trigger("chosen:no_results", {
                chosen: this
            });
        };
        Chosen.prototype.no_results_clear = function() {
            return this.search_results.find(".no-results").remove();
        };
        Chosen.prototype.keydown_arrow = function() {
            var next_sib;
            if (this.results_showing && this.result_highlight) {
                next_sib = this.result_highlight.nextAll("li.active-result").first();
                if (next_sib) {
                    return this.result_do_highlight(next_sib);
                }
            } else {
                return this.results_show();
            }
        };
        Chosen.prototype.keyup_arrow = function() {
            var prev_sibs;
            if (!this.results_showing && !this.is_multiple) {
                return this.results_show();
            } else if (this.result_highlight) {
                prev_sibs = this.result_highlight.prevAll("li.active-result");
                if (prev_sibs.length) {
                    return this.result_do_highlight(prev_sibs.first());
                } else {
                    if (this.choices_count() > 0) {
                        this.results_hide();
                    }
                    return this.result_clear_highlight();
                }
            }
        };
        Chosen.prototype.keydown_backstroke = function() {
            var next_available_destroy;
            if (this.pending_backstroke) {
                this.choice_destroy(this.pending_backstroke.find("a").first());
                return this.clear_backstroke();
            } else {
                next_available_destroy = this.search_container.siblings("li.search-choice").last();
                if (next_available_destroy.length && !next_available_destroy.hasClass("search-choice-disabled")) {
                    this.pending_backstroke = next_available_destroy;
                    if (this.single_backstroke_delete) {
                        return this.keydown_backstroke();
                    } else {
                        return this.pending_backstroke.addClass("search-choice-focus");
                    }
                }
            }
        };
        Chosen.prototype.clear_backstroke = function() {
            if (this.pending_backstroke) {
                this.pending_backstroke.removeClass("search-choice-focus");
            }
            return this.pending_backstroke = null;
        };
        Chosen.prototype.keydown_checker = function(evt) {
            var stroke, _ref1;
            stroke = (_ref1 = evt.which) != null ? _ref1 : evt.keyCode;
            this.search_field_scale();
            if (stroke !== 8 && this.pending_backstroke) {
                this.clear_backstroke();
            }
            switch (stroke) {
              case 8:
                this.backstroke_length = this.search_field.val().length;
                break;

              case 9:
                if (this.results_showing && !this.is_multiple) {
                    this.result_select(evt);
                }
                this.mouse_on_container = false;
                break;

              case 13:
                if (this.results_showing) {
                    evt.preventDefault();
                }
                break;

              case 32:
                if (this.disable_search) {
                    evt.preventDefault();
                }
                break;

              case 38:
                evt.preventDefault();
                this.keyup_arrow();
                break;

              case 40:
                evt.preventDefault();
                this.keydown_arrow();
                break;
            }
        };
        Chosen.prototype.search_field_scale = function() {
            var div, f_width, h, style, style_block, styles, w, _i, _len;
            if (this.is_multiple) {
                h = 0;
                w = 0;
                style_block = "position:absolute; left: -1000px; top: -1000px; display:none;";
                styles = [ "font-size", "font-style", "font-weight", "font-family", "line-height", "text-transform", "letter-spacing" ];
                for (_i = 0, _len = styles.length; _i < _len; _i++) {
                    style = styles[_i];
                    style_block += style + ":" + this.search_field.css(style) + ";";
                }
                div = $("<div />", {
                    style: style_block
                });
                div.text(this.search_field.val());
                $("body").append(div);
                w = div.width() + 25;
                div.remove();
                f_width = this.container.outerWidth();
                if (w > f_width - 10) {
                    w = f_width - 10;
                }
                return this.search_field.css({
                    width: w + "px"
                });
            }
        };
        return Chosen;
    }(AbstractChosen);
}).call(this);

(function(factory) {
    "use strict";
    if (typeof define === "function" && define.amd) {
        define([ "jquery", "jquery.ui.widget", "jquery.iframe-transport", "jquery.fileupload" ], factory);
    } else {
        var $ = window.jQuery;
        factory($);
        $(function() {
            if ($.fn.cloudinary_fileupload !== undefined) {
                $("input.cloudinary-fileupload[type=file]").cloudinary_fileupload();
            }
        });
    }
})(function($) {
    "use strict";
    var CF_SHARED_CDN = "d3jpl91pxevbkh.cloudfront.net";
    var OLD_AKAMAI_SHARED_CDN = "cloudinary-a.akamaihd.net";
    var AKAMAI_SHARED_CDN = "res.cloudinary.com";
    var SHARED_CDN = AKAMAI_SHARED_CDN;
    function utf8_encode(argString) {
        if (argString === null || typeof argString === "undefined") {
            return "";
        }
        var string = argString + "";
        var utftext = "", start, end, stringl = 0;
        start = end = 0;
        stringl = string.length;
        for (var n = 0; n < stringl; n++) {
            var c1 = string.charCodeAt(n);
            var enc = null;
            if (c1 < 128) {
                end++;
            } else if (c1 > 127 && c1 < 2048) {
                enc = String.fromCharCode(c1 >> 6 | 192, c1 & 63 | 128);
            } else {
                enc = String.fromCharCode(c1 >> 12 | 224, c1 >> 6 & 63 | 128, c1 & 63 | 128);
            }
            if (enc !== null) {
                if (end > start) {
                    utftext += string.slice(start, end);
                }
                utftext += enc;
                start = end = n + 1;
            }
        }
        if (end > start) {
            utftext += string.slice(start, stringl);
        }
        return utftext;
    }
    function crc32(str) {
        str = utf8_encode(str);
        var table = "00000000 77073096 EE0E612C 990951BA 076DC419 706AF48F E963A535 9E6495A3 0EDB8832 79DCB8A4 E0D5E91E 97D2D988 09B64C2B 7EB17CBD E7B82D07 90BF1D91 1DB71064 6AB020F2 F3B97148 84BE41DE 1ADAD47D 6DDDE4EB F4D4B551 83D385C7 136C9856 646BA8C0 FD62F97A 8A65C9EC 14015C4F 63066CD9 FA0F3D63 8D080DF5 3B6E20C8 4C69105E D56041E4 A2677172 3C03E4D1 4B04D447 D20D85FD A50AB56B 35B5A8FA 42B2986C DBBBC9D6 ACBCF940 32D86CE3 45DF5C75 DCD60DCF ABD13D59 26D930AC 51DE003A C8D75180 BFD06116 21B4F4B5 56B3C423 CFBA9599 B8BDA50F 2802B89E 5F058808 C60CD9B2 B10BE924 2F6F7C87 58684C11 C1611DAB B6662D3D 76DC4190 01DB7106 98D220BC EFD5102A 71B18589 06B6B51F 9FBFE4A5 E8B8D433 7807C9A2 0F00F934 9609A88E E10E9818 7F6A0DBB 086D3D2D 91646C97 E6635C01 6B6B51F4 1C6C6162 856530D8 F262004E 6C0695ED 1B01A57B 8208F4C1 F50FC457 65B0D9C6 12B7E950 8BBEB8EA FCB9887C 62DD1DDF 15DA2D49 8CD37CF3 FBD44C65 4DB26158 3AB551CE A3BC0074 D4BB30E2 4ADFA541 3DD895D7 A4D1C46D D3D6F4FB 4369E96A 346ED9FC AD678846 DA60B8D0 44042D73 33031DE5 AA0A4C5F DD0D7CC9 5005713C 270241AA BE0B1010 C90C2086 5768B525 206F85B3 B966D409 CE61E49F 5EDEF90E 29D9C998 B0D09822 C7D7A8B4 59B33D17 2EB40D81 B7BD5C3B C0BA6CAD EDB88320 9ABFB3B6 03B6E20C 74B1D29A EAD54739 9DD277AF 04DB2615 73DC1683 E3630B12 94643B84 0D6D6A3E 7A6A5AA8 E40ECF0B 9309FF9D 0A00AE27 7D079EB1 F00F9344 8708A3D2 1E01F268 6906C2FE F762575D 806567CB 196C3671 6E6B06E7 FED41B76 89D32BE0 10DA7A5A 67DD4ACC F9B9DF6F 8EBEEFF9 17B7BE43 60B08ED5 D6D6A3E8 A1D1937E 38D8C2C4 4FDFF252 D1BB67F1 A6BC5767 3FB506DD 48B2364B D80D2BDA AF0A1B4C 36034AF6 41047A60 DF60EFC3 A867DF55 316E8EEF 4669BE79 CB61B38C BC66831A 256FD2A0 5268E236 CC0C7795 BB0B4703 220216B9 5505262F C5BA3BBE B2BD0B28 2BB45A92 5CB36A04 C2D7FFA7 B5D0CF31 2CD99E8B 5BDEAE1D 9B64C2B0 EC63F226 756AA39C 026D930A 9C0906A9 EB0E363F 72076785 05005713 95BF4A82 E2B87A14 7BB12BAE 0CB61B38 92D28E9B E5D5BE0D 7CDCEFB7 0BDBDF21 86D3D2D4 F1D4E242 68DDB3F8 1FDA836E 81BE16CD F6B9265B 6FB077E1 18B74777 88085AE6 FF0F6A70 66063BCA 11010B5C 8F659EFF F862AE69 616BFFD3 166CCF45 A00AE278 D70DD2EE 4E048354 3903B3C2 A7672661 D06016F7 4969474D 3E6E77DB AED16A4A D9D65ADC 40DF0B66 37D83BF0 A9BCAE53 DEBB9EC5 47B2CF7F 30B5FFE9 BDBDF21C CABAC28A 53B39330 24B4A3A6 BAD03605 CDD70693 54DE5729 23D967BF B3667A2E C4614AB8 5D681B02 2A6F2B94 B40BBE37 C30C8EA1 5A05DF1B 2D02EF8D";
        var crc = 0;
        var x = 0;
        var y = 0;
        crc = crc ^ -1;
        for (var i = 0, iTop = str.length; i < iTop; i++) {
            y = (crc ^ str.charCodeAt(i)) & 255;
            x = "0x" + table.substr(y * 9, 8);
            crc = crc >>> 8 ^ x;
        }
        crc = crc ^ -1;
        if (crc < 0) {
            crc += 4294967296;
        }
        return crc;
    }
    function option_consume(options, option_name, default_value) {
        var result = options[option_name];
        delete options[option_name];
        return typeof result == "undefined" ? default_value : result;
    }
    function build_array(arg) {
        if (!arg) {
            return [];
        } else if ($.isArray(arg)) {
            return arg;
        } else {
            return [ arg ];
        }
    }
    function present(value) {
        return typeof value != "undefined" && ("" + value).length > 0;
    }
    function process_base_transformations(options) {
        var transformations = build_array(options.transformation);
        var all_named = true;
        for (var i = 0; i < transformations.length; i++) {
            all_named = all_named && typeof transformations[i] == "string";
        }
        if (all_named) {
            return [];
        }
        delete options.transformation;
        var base_transformations = [];
        for (var i = 0; i < transformations.length; i++) {
            var transformation = transformations[i];
            if (typeof transformation == "string") {
                base_transformations.push("t_" + transformation);
            } else {
                base_transformations.push(generate_transformation_string($.extend({}, transformation)));
            }
        }
        return base_transformations;
    }
    function process_size(options) {
        var size = option_consume(options, "size");
        if (size) {
            var split_size = size.split("x");
            options.width = split_size[0];
            options.height = split_size[1];
        }
    }
    function process_html_dimensions(options) {
        var width = options.width, height = options.height;
        var has_layer = options.overlay || options.underlay;
        var crop = options.crop;
        var use_as_html_dimensions = !has_layer && !options.angle && crop != "fit" && crop != "limit" && crop != "lfill";
        if (use_as_html_dimensions) {
            if (width && !options.html_width && width !== "auto" && parseFloat(width) >= 1) options.html_width = width;
            if (height && !options.html_height && parseFloat(height) >= 1) options.html_height = height;
        }
        if (!crop && !has_layer) {
            delete options.width;
            delete options.height;
        }
    }
    var TRANSFORMATION_PARAM_NAME_MAPPING = {
        angle: "a",
        background: "b",
        border: "bo",
        color: "co",
        color_space: "cs",
        crop: "c",
        default_image: "d",
        delay: "dl",
        density: "dn",
        dpr: "dpr",
        effect: "e",
        fetch_format: "f",
        flags: "fl",
        gravity: "g",
        height: "h",
        opacity: "o",
        overlay: "l",
        page: "pg",
        prefix: "p",
        quality: "q",
        radius: "r",
        transformation: "t",
        underlay: "u",
        width: "w",
        x: "x",
        y: "y"
    };
    var TRANSFORMATION_PARAM_VALUE_MAPPING = {
        angle: function(angle) {
            return build_array(angle).join(".");
        },
        background: function(background) {
            return background.replace(/^#/, "rgb:");
        },
        border: function(border) {
            if ($.isPlainObject(border)) {
                var border_width = "" + (border.width || 2);
                var border_color = (border.color || "black").replace(/^#/, "rgb:");
                border = border_width + "px_solid_" + border_color;
            }
            return border;
        },
        color: function(color) {
            return color.replace(/^#/, "rgb:");
        },
        dpr: function(dpr) {
            dpr = dpr.toString();
            if (dpr === "auto") {
                return "1.0";
            } else if (dpr.match(/^\d+$/)) {
                return dpr + ".0";
            } else {
                return dpr;
            }
        },
        effect: function(effect) {
            return build_array(effect).join(":");
        },
        flags: function(flags) {
            return build_array(flags).join(".");
        },
        transformation: function(transformation) {
            return build_array(transformation).join(".");
        }
    };
    function generate_transformation_string(options) {
        var base_transformations = process_base_transformations(options);
        process_size(options);
        process_html_dimensions(options);
        var params = [];
        for (var param in TRANSFORMATION_PARAM_NAME_MAPPING) {
            var value = option_consume(options, param);
            if (!present(value)) continue;
            if (TRANSFORMATION_PARAM_VALUE_MAPPING[param]) {
                value = TRANSFORMATION_PARAM_VALUE_MAPPING[param](value);
            }
            if (!present(value)) continue;
            params.push(TRANSFORMATION_PARAM_NAME_MAPPING[param] + "_" + value);
        }
        params.sort();
        var raw_transformation = option_consume(options, "raw_transformation");
        if (present(raw_transformation)) params.push(raw_transformation);
        var transformation = params.join(",");
        if (present(transformation)) base_transformations.push(transformation);
        return base_transformations.join("/");
    }
    function absolutize(url) {
        if (!url.match(/^https?:\//)) {
            var prefix = document.location.protocol + "//" + document.location.host;
            if (url[0] == "?") {
                prefix += document.location.pathname;
            } else if (url[0] != "/") {
                prefix += document.location.pathname.replace(/\/[^\/]*$/, "/");
            }
            url = prefix + url;
        }
        return url;
    }
    function cloudinary_url(public_id, options) {
        options = options || {};
        var type = option_consume(options, "type", "upload");
        if (type == "fetch") {
            options.fetch_format = options.fetch_format || option_consume(options, "format");
        }
        var transformation = generate_transformation_string(options);
        var resource_type = option_consume(options, "resource_type", "image");
        var version = option_consume(options, "version");
        var format = option_consume(options, "format");
        var cloud_name = option_consume(options, "cloud_name", $.cloudinary.config().cloud_name);
        if (!cloud_name) throw "Unknown cloud_name";
        var private_cdn = option_consume(options, "private_cdn", $.cloudinary.config().private_cdn);
        var secure_distribution = option_consume(options, "secure_distribution", $.cloudinary.config().secure_distribution);
        var cname = option_consume(options, "cname", $.cloudinary.config().cname);
        var cdn_subdomain = option_consume(options, "cdn_subdomain", $.cloudinary.config().cdn_subdomain);
        var shorten = option_consume(options, "shorten", $.cloudinary.config().shorten);
        var secure = option_consume(options, "secure", window.location.protocol == "https:");
        var protocol = option_consume(options, "protocol", $.cloudinary.config().protocol);
        var trust_public_id = option_consume(options, "trust_public_id");
        if (type == "fetch") {
            public_id = absolutize(public_id);
        }
        if (public_id.match(/^https?:/)) {
            if (type == "upload" || type == "asset") return public_id;
            public_id = encodeURIComponent(public_id).replace(/%3A/g, ":").replace(/%2F/g, "/");
        } else {
            public_id = encodeURIComponent(decodeURIComponent(public_id)).replace(/%3A/g, ":").replace(/%2F/g, "/");
            if (format) {
                if (!trust_public_id) public_id = public_id.replace(/\.(jpg|jpeg|png|gif|webp)$/, "");
                public_id = public_id + "." + format;
            }
        }
        var prefix = secure ? "https://" : window.location.protocol === "file:" ? "file://" : "http://";
        prefix = protocol ? protocol + "//" : prefix;
        if (cloud_name.match(/^\//) && !secure) {
            prefix = "/res" + cloud_name;
        } else {
            var shared_domain = !private_cdn;
            if (secure) {
                if (!secure_distribution || secure_distribution == OLD_AKAMAI_SHARED_CDN) {
                    secure_distribution = private_cdn ? cloud_name + "-res.cloudinary.com" : SHARED_CDN;
                }
                shared_domain = shared_domain || secure_distribution == SHARED_CDN;
                prefix += secure_distribution;
            } else {
                var subdomain = cdn_subdomain ? "a" + (crc32(public_id) % 5 + 1) + "." : "";
                var host = cname || (private_cdn ? cloud_name + "-res.cloudinary.com" : "res.cloudinary.com");
                prefix += subdomain + host;
            }
            if (shared_domain) prefix += "/" + cloud_name;
        }
        if (shorten && resource_type == "image" && type == "upload") {
            resource_type = "iu";
            type = undefined;
        }
        if (public_id.search("/") >= 0 && !public_id.match(/^v[0-9]+/) && !public_id.match(/^https?:\//) && !present(version)) {
            version = 1;
        }
        var url = [ prefix, resource_type, type, transformation, version ? "v" + version : "", public_id ].join("/").replace(/([^:])\/+/g, "$1/");
        return url;
    }
    function default_stoppoints(width) {
        return 10 * Math.ceil(width / 10);
    }
    function prepare_html_url(public_id, options) {
        if ($.cloudinary.config("dpr") && !options.dpr) {
            options.dpr = $.cloudinary.config("dpr");
        }
        var url = cloudinary_url(public_id, options);
        var width = option_consume(options, "html_width");
        var height = option_consume(options, "html_height");
        if (width) options.width = width;
        if (height) options.height = height;
        return url;
    }
    function get_config(name, options, default_value) {
        var value = options[name] || $.cloudinary.config(name);
        if (typeof value == "undefined") value = default_value;
        return value;
    }
    var cloudinary_config = null;
    var responsive_config = null;
    var responsive_resize_initialized = false;
    var device_pixel_ratio_cache = {};
    $.cloudinary = {
        CF_SHARED_CDN: CF_SHARED_CDN,
        OLD_AKAMAI_SHARED_CDN: OLD_AKAMAI_SHARED_CDN,
        AKAMAI_SHARED_CDN: AKAMAI_SHARED_CDN,
        SHARED_CDN: SHARED_CDN,
        config: function(new_config, new_value) {
            if (!cloudinary_config) {
                cloudinary_config = {};
                $('meta[name^="cloudinary_"]').each(function() {
                    cloudinary_config[$(this).attr("name").replace("cloudinary_", "")] = $(this).attr("content");
                });
            }
            if (typeof new_value != "undefined") {
                cloudinary_config[new_config] = new_value;
            } else if (typeof new_config == "string") {
                return cloudinary_config[new_config];
            } else if (new_config) {
                cloudinary_config = new_config;
            }
            return cloudinary_config;
        },
        url: function(public_id, options) {
            options = $.extend({}, options);
            return cloudinary_url(public_id, options);
        },
        url_internal: cloudinary_url,
        transformation_string: function(options) {
            options = $.extend({}, options);
            return generate_transformation_string(options);
        },
        image: function(public_id, options) {
            options = $.extend({}, options);
            var url = prepare_html_url(public_id, options);
            var img = $("<img/>").data("src-cache", url).attr(options).cloudinary_update(options);
            return img;
        },
        facebook_profile_image: function(public_id, options) {
            return $.cloudinary.image(public_id, $.extend({
                type: "facebook"
            }, options));
        },
        twitter_profile_image: function(public_id, options) {
            return $.cloudinary.image(public_id, $.extend({
                type: "twitter"
            }, options));
        },
        twitter_name_profile_image: function(public_id, options) {
            return $.cloudinary.image(public_id, $.extend({
                type: "twitter_name"
            }, options));
        },
        gravatar_image: function(public_id, options) {
            return $.cloudinary.image(public_id, $.extend({
                type: "gravatar"
            }, options));
        },
        fetch_image: function(public_id, options) {
            return $.cloudinary.image(public_id, $.extend({
                type: "fetch"
            }, options));
        },
        sprite_css: function(public_id, options) {
            options = $.extend({
                type: "sprite"
            }, options);
            if (!public_id.match(/.css$/)) options.format = "css";
            return $.cloudinary.url(public_id, options);
        },
        responsive: function(options) {
            responsive_config = $.extend(responsive_config || {}, options);
            $("img.cld-responsive, img.cld-hidpi").cloudinary_update(responsive_config);
            var responsive_resize = get_config("responsive_resize", responsive_config, true);
            if (responsive_resize && !responsive_resize_initialized) {
                responsive_config.resizing = responsive_resize_initialized = true;
                var timeout = null;
                $(window).on("resize", function() {
                    var debounce = get_config("responsive_debounce", responsive_config, 100);
                    function reset() {
                        if (timeout) {
                            clearTimeout(timeout);
                            timeout = null;
                        }
                    }
                    function run() {
                        $("img.cld-responsive").cloudinary_update(responsive_config);
                    }
                    function wait() {
                        reset();
                        setTimeout(function() {
                            reset();
                            run();
                        }, debounce);
                    }
                    if (debounce) {
                        wait();
                    } else {
                        run();
                    }
                });
            }
        },
        calc_stoppoint: function(element, width) {
            var stoppoints = $(element).data("stoppoints") || $.cloudinary.config().stoppoints || default_stoppoints;
            if (typeof stoppoints === "function") {
                return stoppoints(width);
            }
            if (typeof stoppoints === "string") {
                stoppoints = $.map(stoppoints.split(","), function(val) {
                    return parseInt(val);
                });
            }
            var i = stoppoints.length - 2;
            while (i >= 0 && stoppoints[i] >= width) {
                i--;
            }
            return stoppoints[i + 1];
        },
        device_pixel_ratio: function() {
            var dpr = window.devicePixelRatio || 1;
            var dpr_string = device_pixel_ratio_cache[dpr];
            if (!dpr_string) {
                dpr_string = dpr.toString();
                if (dpr_string.match(/^\d+$/)) dpr_string += ".0";
                device_pixel_ratio_cache[dpr] = dpr_string;
            }
            return dpr_string;
        }
    };
    $.fn.cloudinary = function(options) {
        this.filter("img").each(function() {
            var img_options = $.extend({
                width: $(this).attr("width"),
                height: $(this).attr("height"),
                src: $(this).attr("src")
            }, $(this).data(), options);
            var public_id = option_consume(img_options, "source", option_consume(img_options, "src"));
            var url = prepare_html_url(public_id, img_options);
            $(this).data("src-cache", url).attr({
                width: img_options.width,
                height: img_options.height
            });
        }).cloudinary_update(options);
        return this;
    };
    $.fn.cloudinary_update = function(options) {
        options = options || {};
        var responsive_use_stoppoints = get_config("responsive_use_stoppoints", options, "resize");
        var exact = responsive_use_stoppoints === false || responsive_use_stoppoints == "resize" && !options.resizing;
        this.filter("img").each(function() {
            if (options.responsive) {
                $(this).addClass("cld-responsive");
            }
            var attrs = {};
            var src = $(this).data("src-cache") || $(this).data("src");
            if (!src) return;
            var responsive = $(this).hasClass("cld-responsive") && src.match(/\bw_auto\b/);
            if (responsive) {
                var container = $(this).parent()[0];
                var containerWidth = container ? container.clientWidth : 0;
                if (containerWidth == 0) {
                    return;
                }
                var requestedWidth = exact ? containerWidth : $.cloudinary.calc_stoppoint(this, containerWidth);
                var currentWidth = $(this).data("width") || 0;
                if (requestedWidth > currentWidth) {
                    $(this).data("width", requestedWidth);
                } else {
                    requestedWidth = currentWidth;
                }
                src = src.replace(/\bw_auto\b/g, "w_" + requestedWidth);
                attrs.width = null;
                attrs.height = null;
            }
            attrs.src = src.replace(/\bdpr_(1\.0|auto)\b/g, "dpr_" + $.cloudinary.device_pixel_ratio());
            $(this).attr(attrs);
        });
        return this;
    };
    var webp = null;
    $.fn.webpify = function(options, webp_options) {
        var that = this;
        options = options || {};
        webp_options = webp_options || options;
        if (!webp) {
            webp = $.Deferred();
            var webp_canary = new Image();
            webp_canary.onerror = webp.reject;
            webp_canary.onload = webp.resolve;
            webp_canary.src = "data:image/webp;base64,UklGRi4AAABXRUJQVlA4TCEAAAAvAUAAEB8wAiMwAgSSNtse/cXjxyCCmrYNWPwmHRH9jwMA";
        }
        $(function() {
            webp.done(function() {
                $(that).cloudinary($.extend({}, webp_options, {
                    format: "webp"
                }));
            }).fail(function() {
                $(that).cloudinary(options);
            });
        });
        return this;
    };
    $.fn.fetchify = function(options) {
        return this.cloudinary($.extend(options, {
            type: "fetch"
        }));
    };
    if (!$.fn.fileupload) {
        return;
    }
    $.cloudinary.delete_by_token = function(delete_token, options) {
        options = options || {};
        var url = options.url;
        if (!url) {
            var cloud_name = options.cloud_name || $.cloudinary.config().cloud_name;
            url = "https://api.cloudinary.com/v1_1/" + cloud_name + "/delete_by_token";
        }
        var dataType = $.support.xhrFileUpload ? "json" : "iframe json";
        return $.ajax({
            url: url,
            method: "POST",
            data: {
                token: delete_token
            },
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            },
            dataType: dataType
        });
    };
    $.fn.cloudinary_fileupload = function(options) {
        var initializing = !this.data("blueimpFileupload");
        if (initializing) {
            options = $.extend({
                maxFileSize: 2e7,
                dataType: "json",
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                }
            }, options);
        }
        this.fileupload(options);
        if (initializing) {
            this.bind("fileuploaddone", function(e, data) {
                if (data.result.error) return;
                data.result.path = [ "v", data.result.version, "/", data.result.public_id, data.result.format ? "." + data.result.format : "" ].join("");
                if (data.cloudinaryField && data.form.length > 0) {
                    var upload_info = [ data.result.resource_type, data.result.type, data.result.path ].join("/") + "#" + data.result.signature;
                    var multiple = $(e.target).prop("multiple");
                    var add_field = function() {
                        $("<input></input>").attr({
                            type: "hidden",
                            name: data.cloudinaryField
                        }).val(upload_info).appendTo(data.form);
                    };
                    if (multiple) {
                        add_field();
                    } else {
                        var field = $(data.form).find('input[name="' + data.cloudinaryField + '"]');
                        if (field.length > 0) {
                            field.val(upload_info);
                        } else {
                            add_field();
                        }
                    }
                }
                $(e.target).trigger("cloudinarydone", data);
            });
            this.bind("fileuploadstart", function(e) {
                $(e.target).trigger("cloudinarystart");
            });
            this.bind("fileuploadstop", function(e) {
                $(e.target).trigger("cloudinarystop");
            });
            this.bind("fileuploadprogress", function(e, data) {
                $(e.target).trigger("cloudinaryprogress", data);
            });
            this.bind("fileuploadprogressall", function(e, data) {
                $(e.target).trigger("cloudinaryprogressall", data);
            });
            this.bind("fileuploadfail", function(e, data) {
                $(e.target).trigger("cloudinaryfail", data);
            });
            this.bind("fileuploadalways", function(e, data) {
                $(e.target).trigger("cloudinaryalways", data);
            });
            if (!this.fileupload("option").url) {
                var cloud_name = options.cloud_name || $.cloudinary.config().cloud_name;
                var upload_url = "https://api.cloudinary.com/v1_1/" + cloud_name + "/upload";
                this.fileupload("option", "url", upload_url);
            }
        }
        return this;
    };
    $.fn.cloudinary_upload_url = function(remote_url) {
        this.fileupload("option", "formData").file = remote_url;
        this.fileupload("add", {
            files: [ remote_url ]
        });
        delete this.fileupload("option", "formData").file;
    };
    $.fn.unsigned_cloudinary_upload = function(upload_preset, upload_params, options) {
        options = options || {};
        upload_params = $.extend({}, upload_params) || {};
        if (upload_params.cloud_name) {
            options.cloud_name = upload_params.cloud_name;
            delete upload_params.cloud_name;
        }
        for (var key in upload_params) {
            var value = upload_params[key];
            if ($.isPlainObject(value)) {
                upload_params[key] = $.map(value, function(v, k) {
                    return k + "=" + v;
                }).join("|");
            } else if ($.isArray(value)) {
                if (value.length > 0 && $.isArray(value[0])) {
                    upload_params[key] = $.map(value, function(array_value) {
                        return array_value.join(",");
                    }).join("|");
                } else {
                    upload_params[key] = value.join(",");
                }
            }
        }
        if (!upload_params.callback) {
            upload_params.callback = "/cloudinary_cors.html";
        }
        upload_params.upload_preset = upload_preset;
        options.formData = upload_params;
        if (options.cloudinary_field) {
            options.cloudinaryField = options.cloudinary_field;
            delete options.cloudinary_field;
        }
        var html_options = options.html || {};
        html_options["class"] = "cloudinary_fileupload " + (html_options["class"] || "");
        if (options.multiple) html_options.multiple = true;
        this.attr(html_options).cloudinary_fileupload(options);
        return this;
    };
    $.cloudinary.unsigned_upload_tag = function(upload_preset, upload_params, options) {
        return $("<input/>").attr({
            type: "file",
            name: "file"
        }).unsigned_cloudinary_upload(upload_preset, upload_params, options);
    };
});

(function(factory) {
    if (typeof define === "function" && define.amd) {
        define([ "jquery" ], factory);
    } else if (typeof exports === "object") {
        factory(require("jquery"));
    } else {
        factory(jQuery);
    }
})(function($) {
    var pluses = /\+/g;
    function encode(s) {
        return config.raw ? s : encodeURIComponent(s);
    }
    function decode(s) {
        return config.raw ? s : decodeURIComponent(s);
    }
    function stringifyCookieValue(value) {
        return encode(config.json ? JSON.stringify(value) : String(value));
    }
    function parseCookieValue(s) {
        if (s.indexOf('"') === 0) {
            s = s.slice(1, -1).replace(/\\"/g, '"').replace(/\\\\/g, "\\");
        }
        try {
            s = decodeURIComponent(s.replace(pluses, " "));
            return config.json ? JSON.parse(s) : s;
        } catch (e) {}
    }
    function read(s, converter) {
        var value = config.raw ? s : parseCookieValue(s);
        return $.isFunction(converter) ? converter(value) : value;
    }
    var config = $.cookie = function(key, value, options) {
        if (value !== undefined && !$.isFunction(value)) {
            options = $.extend({}, config.defaults, options);
            if (typeof options.expires === "number") {
                var days = options.expires, t = options.expires = new Date();
                t.setTime(+t + days * 864e5);
            }
            return document.cookie = [ encode(key), "=", stringifyCookieValue(value), options.expires ? "; expires=" + options.expires.toUTCString() : "", options.path ? "; path=" + options.path : "", options.domain ? "; domain=" + options.domain : "", options.secure ? "; secure" : "" ].join("");
        }
        var result = key ? undefined : {};
        var cookies = document.cookie ? document.cookie.split("; ") : [];
        for (var i = 0, l = cookies.length; i < l; i++) {
            var parts = cookies[i].split("=");
            var name = decode(parts.shift());
            var cookie = parts.join("=");
            if (key && key === name) {
                result = read(cookie, value);
                break;
            }
            if (!key && (cookie = read(cookie)) !== undefined) {
                result[name] = cookie;
            }
        }
        return result;
    };
    config.defaults = {};
    $.removeCookie = function(key, options) {
        if ($.cookie(key) === undefined) {
            return false;
        }
        $.cookie(key, "", $.extend({}, options, {
            expires: -1
        }));
        return !$.cookie(key);
    };
});

!function(a, b) {
    var c = function(c) {
        return a(c, b);
    };
    "function" == typeof define && define.amd ? define([ "jquery" ], c) : "object" == typeof exports ? module.exports = c : c(jQuery);
}(function(a, b, c) {
    a.fn.jScrollPane = function(d) {
        function e(d, e) {
            function f(b) {
                var e, h, j, l, m, n, q = !1, r = !1;
                if (P = b, Q === c) m = d.scrollTop(), n = d.scrollLeft(), d.css({
                    overflow: "hidden",
                    padding: 0
                }), R = d.innerWidth() + tb, S = d.innerHeight(), d.width(R), Q = a('<div class="jspPane" />').css("padding", sb).append(d.children()), 
                T = a('<div class="jspContainer" />').css({
                    width: R + "px",
                    height: S + "px"
                }).append(Q).appendTo(d); else {
                    if (d.css("width", ""), q = P.stickToBottom && C(), r = P.stickToRight && D(), l = d.innerWidth() + tb != R || d.outerHeight() != S, 
                    l && (R = d.innerWidth() + tb, S = d.innerHeight(), T.css({
                        width: R + "px",
                        height: S + "px"
                    })), !l && ub == U && Q.outerHeight() == V) return void d.width(R);
                    ub = U, Q.css("width", ""), d.width(R), T.find(">.jspVerticalBar,>.jspHorizontalBar").remove().end();
                }
                Q.css("overflow", "auto"), U = b.contentWidth ? b.contentWidth : Q[0].scrollWidth, 
                V = Q[0].scrollHeight, Q.css("overflow", ""), W = U / R, X = V / S, Y = X > 1, Z = W > 1, 
                Z || Y ? (d.addClass("jspScrollable"), e = P.maintainPosition && (ab || db), e && (h = A(), 
                j = B()), g(), i(), k(), e && (y(r ? U - R : h, !1), x(q ? V - S : j, !1)), H(), 
                E(), N(), P.enableKeyboardNavigation && J(), P.clickOnTrack && o(), L(), P.hijackInternalLinks && M()) : (d.removeClass("jspScrollable"), 
                Q.css({
                    top: 0,
                    left: 0,
                    width: T.width() - tb
                }), F(), I(), K(), p()), P.autoReinitialise && !rb ? rb = setInterval(function() {
                    f(P);
                }, P.autoReinitialiseDelay) : !P.autoReinitialise && rb && clearInterval(rb), m && d.scrollTop(0) && x(m, !1), 
                n && d.scrollLeft(0) && y(n, !1), d.trigger("jsp-initialised", [ Z || Y ]);
            }
            function g() {
                Y && (T.append(a('<div class="jspVerticalBar" />').append(a('<div class="jspCap jspCapTop" />'), a('<div class="jspTrack" />').append(a('<div class="jspDrag" />').append(a('<div class="jspDragTop" />'), a('<div class="jspDragBottom" />'))), a('<div class="jspCap jspCapBottom" />'))), 
                eb = T.find(">.jspVerticalBar"), fb = eb.find(">.jspTrack"), $ = fb.find(">.jspDrag"), 
                P.showArrows && (jb = a('<a class="jspArrow jspArrowUp" />').bind("mousedown.jsp", m(0, -1)).bind("click.jsp", G), 
                kb = a('<a class="jspArrow jspArrowDown" />').bind("mousedown.jsp", m(0, 1)).bind("click.jsp", G), 
                P.arrowScrollOnHover && (jb.bind("mouseover.jsp", m(0, -1, jb)), kb.bind("mouseover.jsp", m(0, 1, kb))), 
                l(fb, P.verticalArrowPositions, jb, kb)), hb = S, T.find(">.jspVerticalBar>.jspCap:visible,>.jspVerticalBar>.jspArrow").each(function() {
                    hb -= a(this).outerHeight();
                }), $.hover(function() {
                    $.addClass("jspHover");
                }, function() {
                    $.removeClass("jspHover");
                }).bind("mousedown.jsp", function(b) {
                    a("html").bind("dragstart.jsp selectstart.jsp", G), $.addClass("jspActive");
                    var c = b.pageY - $.position().top;
                    return a("html").bind("mousemove.jsp", function(a) {
                        r(a.pageY - c, !1);
                    }).bind("mouseup.jsp mouseleave.jsp", q), !1;
                }), h());
            }
            function h() {
                fb.height(hb + "px"), ab = 0, gb = P.verticalGutter + fb.outerWidth(), Q.width(R - gb - tb);
                try {
                    0 === eb.position().left && Q.css("margin-left", gb + "px");
                } catch (a) {}
            }
            function i() {
                Z && (T.append(a('<div class="jspHorizontalBar" />').append(a('<div class="jspCap jspCapLeft" />'), a('<div class="jspTrack" />').append(a('<div class="jspDrag" />').append(a('<div class="jspDragLeft" />'), a('<div class="jspDragRight" />'))), a('<div class="jspCap jspCapRight" />'))), 
                lb = T.find(">.jspHorizontalBar"), mb = lb.find(">.jspTrack"), bb = mb.find(">.jspDrag"), 
                P.showArrows && (pb = a('<a class="jspArrow jspArrowLeft" />').bind("mousedown.jsp", m(-1, 0)).bind("click.jsp", G), 
                qb = a('<a class="jspArrow jspArrowRight" />').bind("mousedown.jsp", m(1, 0)).bind("click.jsp", G), 
                P.arrowScrollOnHover && (pb.bind("mouseover.jsp", m(-1, 0, pb)), qb.bind("mouseover.jsp", m(1, 0, qb))), 
                l(mb, P.horizontalArrowPositions, pb, qb)), bb.hover(function() {
                    bb.addClass("jspHover");
                }, function() {
                    bb.removeClass("jspHover");
                }).bind("mousedown.jsp", function(b) {
                    a("html").bind("dragstart.jsp selectstart.jsp", G), bb.addClass("jspActive");
                    var c = b.pageX - bb.position().left;
                    return a("html").bind("mousemove.jsp", function(a) {
                        t(a.pageX - c, !1);
                    }).bind("mouseup.jsp mouseleave.jsp", q), !1;
                }), nb = T.innerWidth(), j());
            }
            function j() {
                T.find(">.jspHorizontalBar>.jspCap:visible,>.jspHorizontalBar>.jspArrow").each(function() {
                    nb -= a(this).outerWidth();
                }), mb.width(nb + "px"), db = 0;
            }
            function k() {
                if (Z && Y) {
                    var b = mb.outerHeight(), c = fb.outerWidth();
                    hb -= b, a(lb).find(">.jspCap:visible,>.jspArrow").each(function() {
                        nb += a(this).outerWidth();
                    }), nb -= c, S -= c, R -= b, mb.parent().append(a('<div class="jspCorner" />').css("width", b + "px")), 
                    h(), j();
                }
                Z && Q.width(T.outerWidth() - tb + "px"), V = Q.outerHeight(), X = V / S, Z && (ob = Math.ceil(1 / W * nb), 
                ob > P.horizontalDragMaxWidth ? ob = P.horizontalDragMaxWidth : ob < P.horizontalDragMinWidth && (ob = P.horizontalDragMinWidth), 
                bb.width(ob + "px"), cb = nb - ob, u(db)), Y && (ib = Math.ceil(1 / X * hb), ib > P.verticalDragMaxHeight ? ib = P.verticalDragMaxHeight : ib < P.verticalDragMinHeight && (ib = P.verticalDragMinHeight), 
                $.height(ib + "px"), _ = hb - ib, s(ab));
            }
            function l(a, b, c, d) {
                var e, f = "before", g = "after";
                "os" == b && (b = /Mac/.test(navigator.platform) ? "after" : "split"), b == f ? g = b : b == g && (f = b, 
                e = c, c = d, d = e), a[f](c)[g](d);
            }
            function m(a, b, c) {
                return function() {
                    return n(a, b, this, c), this.blur(), !1;
                };
            }
            function n(b, c, d, e) {
                d = a(d).addClass("jspActive");
                var f, g, h = !0, i = function() {
                    0 !== b && vb.scrollByX(b * P.arrowButtonSpeed), 0 !== c && vb.scrollByY(c * P.arrowButtonSpeed), 
                    g = setTimeout(i, h ? P.initialDelay : P.arrowRepeatFreq), h = !1;
                };
                i(), f = e ? "mouseout.jsp" : "mouseup.jsp", e = e || a("html"), e.bind(f, function() {
                    d.removeClass("jspActive"), g && clearTimeout(g), g = null, e.unbind(f);
                });
            }
            function o() {
                p(), Y && fb.bind("mousedown.jsp", function(b) {
                    if (b.originalTarget === c || b.originalTarget == b.currentTarget) {
                        var d, e = a(this), f = e.offset(), g = b.pageY - f.top - ab, h = !0, i = function() {
                            var a = e.offset(), c = b.pageY - a.top - ib / 2, f = S * P.scrollPagePercent, k = _ * f / (V - S);
                            if (0 > g) ab - k > c ? vb.scrollByY(-f) : r(c); else {
                                if (!(g > 0)) return void j();
                                c > ab + k ? vb.scrollByY(f) : r(c);
                            }
                            d = setTimeout(i, h ? P.initialDelay : P.trackClickRepeatFreq), h = !1;
                        }, j = function() {
                            d && clearTimeout(d), d = null, a(document).unbind("mouseup.jsp", j);
                        };
                        return i(), a(document).bind("mouseup.jsp", j), !1;
                    }
                }), Z && mb.bind("mousedown.jsp", function(b) {
                    if (b.originalTarget === c || b.originalTarget == b.currentTarget) {
                        var d, e = a(this), f = e.offset(), g = b.pageX - f.left - db, h = !0, i = function() {
                            var a = e.offset(), c = b.pageX - a.left - ob / 2, f = R * P.scrollPagePercent, k = cb * f / (U - R);
                            if (0 > g) db - k > c ? vb.scrollByX(-f) : t(c); else {
                                if (!(g > 0)) return void j();
                                c > db + k ? vb.scrollByX(f) : t(c);
                            }
                            d = setTimeout(i, h ? P.initialDelay : P.trackClickRepeatFreq), h = !1;
                        }, j = function() {
                            d && clearTimeout(d), d = null, a(document).unbind("mouseup.jsp", j);
                        };
                        return i(), a(document).bind("mouseup.jsp", j), !1;
                    }
                });
            }
            function p() {
                mb && mb.unbind("mousedown.jsp"), fb && fb.unbind("mousedown.jsp");
            }
            function q() {
                a("html").unbind("dragstart.jsp selectstart.jsp mousemove.jsp mouseup.jsp mouseleave.jsp"), 
                $ && $.removeClass("jspActive"), bb && bb.removeClass("jspActive");
            }
            function r(a, b) {
                Y && (0 > a ? a = 0 : a > _ && (a = _), b === c && (b = P.animateScroll), b ? vb.animate($, "top", a, s) : ($.css("top", a), 
                s(a)));
            }
            function s(a) {
                a === c && (a = $.position().top), T.scrollTop(0), ab = a;
                var b = 0 === ab, e = ab == _, f = a / _, g = -f * (V - S);
                (wb != b || yb != e) && (wb = b, yb = e, d.trigger("jsp-arrow-change", [ wb, yb, xb, zb ])), 
                v(b, e), Q.css("top", g), d.trigger("jsp-scroll-y", [ -g, b, e ]).trigger("scroll");
            }
            function t(a, b) {
                Z && (0 > a ? a = 0 : a > cb && (a = cb), b === c && (b = P.animateScroll), b ? vb.animate(bb, "left", a, u) : (bb.css("left", a), 
                u(a)));
            }
            function u(a) {
                a === c && (a = bb.position().left), T.scrollTop(0), db = a;
                var b = 0 === db, e = db == cb, f = a / cb, g = -f * (U - R);
                (xb != b || zb != e) && (xb = b, zb = e, d.trigger("jsp-arrow-change", [ wb, yb, xb, zb ])), 
                w(b, e), Q.css("left", g), d.trigger("jsp-scroll-x", [ -g, b, e ]).trigger("scroll");
            }
            function v(a, b) {
                P.showArrows && (jb[a ? "addClass" : "removeClass"]("jspDisabled"), kb[b ? "addClass" : "removeClass"]("jspDisabled"));
            }
            function w(a, b) {
                P.showArrows && (pb[a ? "addClass" : "removeClass"]("jspDisabled"), qb[b ? "addClass" : "removeClass"]("jspDisabled"));
            }
            function x(a, b) {
                var c = a / (V - S);
                r(c * _, b);
            }
            function y(a, b) {
                var c = a / (U - R);
                t(c * cb, b);
            }
            function z(b, c, d) {
                var e, f, g, h, i, j, k, l, m, n = 0, o = 0;
                try {
                    e = a(b);
                } catch (p) {
                    return;
                }
                for (f = e.outerHeight(), g = e.outerWidth(), T.scrollTop(0), T.scrollLeft(0); !e.is(".jspPane"); ) if (n += e.position().top, 
                o += e.position().left, e = e.offsetParent(), /^body|html$/i.test(e[0].nodeName)) return;
                h = B(), j = h + S, h > n || c ? l = n - P.horizontalGutter : n + f > j && (l = n - S + f + P.horizontalGutter), 
                isNaN(l) || x(l, d), i = A(), k = i + R, i > o || c ? m = o - P.horizontalGutter : o + g > k && (m = o - R + g + P.horizontalGutter), 
                isNaN(m) || y(m, d);
            }
            function A() {
                return -Q.position().left;
            }
            function B() {
                return -Q.position().top;
            }
            function C() {
                var a = V - S;
                return a > 20 && a - B() < 10;
            }
            function D() {
                var a = U - R;
                return a > 20 && a - A() < 10;
            }
            function E() {
                T.unbind(Bb).bind(Bb, function(a, b, c, d) {
                    var e = db, f = ab, g = a.deltaFactor || P.mouseWheelSpeed;
                    return vb.scrollBy(c * g, -d * g, !1), e == db && f == ab;
                });
            }
            function F() {
                T.unbind(Bb);
            }
            function G() {
                return !1;
            }
            function H() {
                Q.find(":input,a").unbind("focus.jsp").bind("focus.jsp", function(a) {
                    z(a.target, !1);
                });
            }
            function I() {
                Q.find(":input,a").unbind("focus.jsp");
            }
            function J() {
                function b() {
                    var a = db, b = ab;
                    switch (c) {
                      case 40:
                        vb.scrollByY(P.keyboardSpeed, !1);
                        break;

                      case 38:
                        vb.scrollByY(-P.keyboardSpeed, !1);
                        break;

                      case 34:
                      case 32:
                        vb.scrollByY(S * P.scrollPagePercent, !1);
                        break;

                      case 33:
                        vb.scrollByY(-S * P.scrollPagePercent, !1);
                        break;

                      case 39:
                        vb.scrollByX(P.keyboardSpeed, !1);
                        break;

                      case 37:
                        vb.scrollByX(-P.keyboardSpeed, !1);
                    }
                    return e = a != db || b != ab;
                }
                var c, e, f = [];
                Z && f.push(lb[0]), Y && f.push(eb[0]), Q.focus(function() {
                    d.focus();
                }), d.attr("tabindex", 0).unbind("keydown.jsp keypress.jsp").bind("keydown.jsp", function(d) {
                    if (d.target === this || f.length && a(d.target).closest(f).length) {
                        var g = db, h = ab;
                        switch (d.keyCode) {
                          case 40:
                          case 38:
                          case 34:
                          case 32:
                          case 33:
                          case 39:
                          case 37:
                            c = d.keyCode, b();
                            break;

                          case 35:
                            x(V - S), c = null;
                            break;

                          case 36:
                            x(0), c = null;
                        }
                        return e = d.keyCode == c && g != db || h != ab, !e;
                    }
                }).bind("keypress.jsp", function(a) {
                    return a.keyCode == c && b(), !e;
                }), P.hideFocus ? (d.css("outline", "none"), "hideFocus" in T[0] && d.attr("hideFocus", !0)) : (d.css("outline", ""), 
                "hideFocus" in T[0] && d.attr("hideFocus", !1));
            }
            function K() {
                d.attr("tabindex", "-1").removeAttr("tabindex").unbind("keydown.jsp keypress.jsp");
            }
            function L() {
                if (location.hash && location.hash.length > 1) {
                    var b, c, d = escape(location.hash.substr(1));
                    try {
                        b = a("#" + d + ', a[name="' + d + '"]');
                    } catch (e) {
                        return;
                    }
                    b.length && Q.find(d) && (0 === T.scrollTop() ? c = setInterval(function() {
                        T.scrollTop() > 0 && (z(b, !0), a(document).scrollTop(T.position().top), clearInterval(c));
                    }, 50) : (z(b, !0), a(document).scrollTop(T.position().top)));
                }
            }
            function M() {
                a(document.body).data("jspHijack") || (a(document.body).data("jspHijack", !0), a(document.body).delegate("a[href*=#]", "click", function(c) {
                    var d, e, f, g, h, i, j = this.href.substr(0, this.href.indexOf("#")), k = location.href;
                    if (-1 !== location.href.indexOf("#") && (k = location.href.substr(0, location.href.indexOf("#"))), 
                    j === k) {
                        d = escape(this.href.substr(this.href.indexOf("#") + 1));
                        try {
                            e = a("#" + d + ', a[name="' + d + '"]');
                        } catch (l) {
                            return;
                        }
                        e.length && (f = e.closest(".jspScrollable"), g = f.data("jsp"), g.scrollToElement(e, !0), 
                        f[0].scrollIntoView && (h = a(b).scrollTop(), i = e.offset().top, (h > i || i > h + a(b).height()) && f[0].scrollIntoView()), 
                        c.preventDefault());
                    }
                }));
            }
            function N() {
                var a, b, c, d, e, f = !1;
                T.unbind("touchstart.jsp touchmove.jsp touchend.jsp click.jsp-touchclick").bind("touchstart.jsp", function(g) {
                    var h = g.originalEvent.touches[0];
                    a = A(), b = B(), c = h.pageX, d = h.pageY, e = !1, f = !0;
                }).bind("touchmove.jsp", function(g) {
                    if (f) {
                        var h = g.originalEvent.touches[0], i = db, j = ab;
                        return vb.scrollTo(a + c - h.pageX, b + d - h.pageY), e = e || Math.abs(c - h.pageX) > 5 || Math.abs(d - h.pageY) > 5, 
                        i == db && j == ab;
                    }
                }).bind("touchend.jsp", function() {
                    f = !1;
                }).bind("click.jsp-touchclick", function() {
                    return e ? (e = !1, !1) : void 0;
                });
            }
            function O() {
                var a = B(), b = A();
                d.removeClass("jspScrollable").unbind(".jsp"), d.replaceWith(Ab.append(Q.children())), 
                Ab.scrollTop(a), Ab.scrollLeft(b), rb && clearInterval(rb);
            }
            var P, Q, R, S, T, U, V, W, X, Y, Z, $, _, ab, bb, cb, db, eb, fb, gb, hb, ib, jb, kb, lb, mb, nb, ob, pb, qb, rb, sb, tb, ub, vb = this, wb = !0, xb = !0, yb = !1, zb = !1, Ab = d.clone(!1, !1).empty(), Bb = a.fn.mwheelIntent ? "mwheelIntent.jsp" : "mousewheel.jsp";
            "border-box" === d.css("box-sizing") ? (sb = 0, tb = 0) : (sb = d.css("paddingTop") + " " + d.css("paddingRight") + " " + d.css("paddingBottom") + " " + d.css("paddingLeft"), 
            tb = (parseInt(d.css("paddingLeft"), 10) || 0) + (parseInt(d.css("paddingRight"), 10) || 0)), 
            a.extend(vb, {
                reinitialise: function(b) {
                    b = a.extend({}, P, b), f(b);
                },
                scrollToElement: function(a, b, c) {
                    z(a, b, c);
                },
                scrollTo: function(a, b, c) {
                    y(a, c), x(b, c);
                },
                scrollToX: function(a, b) {
                    y(a, b);
                },
                scrollToY: function(a, b) {
                    x(a, b);
                },
                scrollToPercentX: function(a, b) {
                    y(a * (U - R), b);
                },
                scrollToPercentY: function(a, b) {
                    x(a * (V - S), b);
                },
                scrollBy: function(a, b, c) {
                    vb.scrollByX(a, c), vb.scrollByY(b, c);
                },
                scrollByX: function(a, b) {
                    var c = A() + Math[0 > a ? "floor" : "ceil"](a), d = c / (U - R);
                    t(d * cb, b);
                },
                scrollByY: function(a, b) {
                    var c = B() + Math[0 > a ? "floor" : "ceil"](a), d = c / (V - S);
                    r(d * _, b);
                },
                positionDragX: function(a, b) {
                    t(a, b);
                },
                positionDragY: function(a, b) {
                    r(a, b);
                },
                animate: function(a, b, c, d) {
                    var e = {};
                    e[b] = c, a.animate(e, {
                        duration: P.animateDuration,
                        easing: P.animateEase,
                        queue: !1,
                        step: d
                    });
                },
                getContentPositionX: function() {
                    return A();
                },
                getContentPositionY: function() {
                    return B();
                },
                getContentWidth: function() {
                    return U;
                },
                getContentHeight: function() {
                    return V;
                },
                getPercentScrolledX: function() {
                    return A() / (U - R);
                },
                getPercentScrolledY: function() {
                    return B() / (V - S);
                },
                getIsScrollableH: function() {
                    return Z;
                },
                getIsScrollableV: function() {
                    return Y;
                },
                getContentPane: function() {
                    return Q;
                },
                scrollToBottom: function(a) {
                    r(_, a);
                },
                hijackInternalLinks: a.noop,
                destroy: function() {
                    O();
                }
            }), f(e);
        }
        return d = a.extend({}, a.fn.jScrollPane.defaults, d), a.each([ "arrowButtonSpeed", "trackClickSpeed", "keyboardSpeed" ], function() {
            d[this] = d[this] || d.speed;
        }), this.each(function() {
            var b = a(this), c = b.data("jsp");
            c ? c.reinitialise(d) : (a("script", b).filter('[type="text/javascript"],:not([type])').remove(), 
            c = new e(b, d), b.data("jsp", c));
        });
    }, a.fn.jScrollPane.defaults = {
        showArrows: !1,
        maintainPosition: !0,
        stickToBottom: !1,
        stickToRight: !1,
        clickOnTrack: !0,
        autoReinitialise: !1,
        autoReinitialiseDelay: 500,
        verticalDragMinHeight: 0,
        verticalDragMaxHeight: 99999,
        horizontalDragMinWidth: 0,
        horizontalDragMaxWidth: 99999,
        contentWidth: c,
        animateScroll: !1,
        animateDuration: 300,
        animateEase: "linear",
        hijackInternalLinks: !1,
        verticalGutter: 4,
        horizontalGutter: 4,
        mouseWheelSpeed: 3,
        arrowButtonSpeed: 0,
        arrowRepeatFreq: 50,
        arrowScrollOnHover: !1,
        trackClickSpeed: 0,
        trackClickRepeatFreq: 70,
        verticalArrowPositions: "split",
        horizontalArrowPositions: "split",
        enableKeyboardNavigation: !0,
        hideFocus: !1,
        keyboardSpeed: 0,
        initialDelay: 300,
        speed: 30,
        scrollPagePercent: .8
    };
}, this);

(function(factory) {
    if (typeof define === "function" && define.amd) {
        define([ "jquery" ], factory);
    } else if (typeof exports === "object") {
        module.exports = factory;
    } else {
        factory(jQuery);
    }
})(function($) {
    var toFix = [ "wheel", "mousewheel", "DOMMouseScroll", "MozMousePixelScroll" ], toBind = "onwheel" in document || document.documentMode >= 9 ? [ "wheel" ] : [ "mousewheel", "DomMouseScroll", "MozMousePixelScroll" ], slice = Array.prototype.slice, nullLowestDeltaTimeout, lowestDelta;
    if ($.event.fixHooks) {
        for (var i = toFix.length; i; ) {
            $.event.fixHooks[toFix[--i]] = $.event.mouseHooks;
        }
    }
    var special = $.event.special.mousewheel = {
        version: "3.1.9",
        setup: function() {
            if (this.addEventListener) {
                for (var i = toBind.length; i; ) {
                    this.addEventListener(toBind[--i], handler, false);
                }
            } else {
                this.onmousewheel = handler;
            }
            $.data(this, "mousewheel-line-height", special.getLineHeight(this));
            $.data(this, "mousewheel-page-height", special.getPageHeight(this));
        },
        teardown: function() {
            if (this.removeEventListener) {
                for (var i = toBind.length; i; ) {
                    this.removeEventListener(toBind[--i], handler, false);
                }
            } else {
                this.onmousewheel = null;
            }
        },
        getLineHeight: function(elem) {
            return parseInt($(elem)["offsetParent" in $.fn ? "offsetParent" : "parent"]().css("fontSize"), 10);
        },
        getPageHeight: function(elem) {
            return $(elem).height();
        },
        settings: {
            adjustOldDeltas: true
        }
    };
    $.fn.extend({
        mousewheel: function(fn) {
            return fn ? this.bind("mousewheel", fn) : this.trigger("mousewheel");
        },
        unmousewheel: function(fn) {
            return this.unbind("mousewheel", fn);
        }
    });
    function handler(event) {
        var orgEvent = event || window.event, args = slice.call(arguments, 1), delta = 0, deltaX = 0, deltaY = 0, absDelta = 0;
        event = $.event.fix(orgEvent);
        event.type = "mousewheel";
        if ("detail" in orgEvent) {
            deltaY = orgEvent.detail * -1;
        }
        if ("wheelDelta" in orgEvent) {
            deltaY = orgEvent.wheelDelta;
        }
        if ("wheelDeltaY" in orgEvent) {
            deltaY = orgEvent.wheelDeltaY;
        }
        if ("wheelDeltaX" in orgEvent) {
            deltaX = orgEvent.wheelDeltaX * -1;
        }
        if ("axis" in orgEvent && orgEvent.axis === orgEvent.HORIZONTAL_AXIS) {
            deltaX = deltaY * -1;
            deltaY = 0;
        }
        delta = deltaY === 0 ? deltaX : deltaY;
        if ("deltaY" in orgEvent) {
            deltaY = orgEvent.deltaY * -1;
            delta = deltaY;
        }
        if ("deltaX" in orgEvent) {
            deltaX = orgEvent.deltaX;
            if (deltaY === 0) {
                delta = deltaX * -1;
            }
        }
        if (deltaY === 0 && deltaX === 0) {
            return;
        }
        if (orgEvent.deltaMode === 1) {
            var lineHeight = $.data(this, "mousewheel-line-height");
            delta *= lineHeight;
            deltaY *= lineHeight;
            deltaX *= lineHeight;
        } else if (orgEvent.deltaMode === 2) {
            var pageHeight = $.data(this, "mousewheel-page-height");
            delta *= pageHeight;
            deltaY *= pageHeight;
            deltaX *= pageHeight;
        }
        absDelta = Math.max(Math.abs(deltaY), Math.abs(deltaX));
        if (!lowestDelta || absDelta < lowestDelta) {
            lowestDelta = absDelta;
            if (shouldAdjustOldDeltas(orgEvent, absDelta)) {
                lowestDelta /= 40;
            }
        }
        if (shouldAdjustOldDeltas(orgEvent, absDelta)) {
            delta /= 40;
            deltaX /= 40;
            deltaY /= 40;
        }
        delta = Math[delta >= 1 ? "floor" : "ceil"](delta / lowestDelta);
        deltaX = Math[deltaX >= 1 ? "floor" : "ceil"](deltaX / lowestDelta);
        deltaY = Math[deltaY >= 1 ? "floor" : "ceil"](deltaY / lowestDelta);
        event.deltaX = deltaX;
        event.deltaY = deltaY;
        event.deltaFactor = lowestDelta;
        event.deltaMode = 0;
        args.unshift(event, delta, deltaX, deltaY);
        if (nullLowestDeltaTimeout) {
            clearTimeout(nullLowestDeltaTimeout);
        }
        nullLowestDeltaTimeout = setTimeout(nullLowestDelta, 200);
        return ($.event.dispatch || $.event.handle).apply(this, args);
    }
    function nullLowestDelta() {
        lowestDelta = null;
    }
    function shouldAdjustOldDeltas(orgEvent, absDelta) {
        return special.settings.adjustOldDeltas && orgEvent.type === "mousewheel" && absDelta % 120 === 0;
    }
});

(function($) {
    "use strict";
    $.fn.selectOrDie = function(method) {
        var $defaults = {
            customID: null,
            customClass: "",
            placeholder: null,
            placeholderOption: false,
            prefix: null,
            cycle: false,
            stripEmpty: false,
            links: false,
            linksExternal: false,
            size: 0,
            tabIndex: 0,
            onChange: $.noop
        }, $_settings = {}, $_sodKeysWhenClosed = false, $_sodFilterTimeout, $_sodViewportTimeout;
        var _private = {
            initSoD: function(options) {
                $_settings = $.extend({}, $defaults, options);
                return this.each(function() {
                    if (!$(this).parent().hasClass("sod_select")) {
                        var $select = $(this), $settingsId = $select.data("custom-id") ? $select.data("custom-id") : $_settings.customID, $settingsClass = $select.data("custom-class") ? $select.data("custom-class") : $_settings.customClass, $settingsPrefix = $select.data("prefix") ? $select.data("prefix") : $_settings.prefix, $settingsPlaceholder = $select.data("placeholder") ? $select.data("placeholder") : $_settings.placeholder, $settingsPlaceholderOption = $select.data("placeholder-option") ? $select.data("placeholder-option") : $_settings.placeholderOption, $settingsCycle = $select.data("cycle") ? $select.data("cycle") : $_settings.cycle, $settingsLinks = $select.data("links") ? $select.data("links") : $_settings.links, $settingsLinksExternal = $select.data("links-external") ? $select.data("links-external") : $_settings.linksExternal, $settingsSize = parseInt($select.data("size")) ? $select.data("size") : $_settings.size, $settingsTabIndex = parseInt($select.data("tabindex")) ? $select.data("tabindex") : $_settings.tabIndex ? $_settings.tabIndex : $select.attr("tabindex") ? $select.attr("tabindex") : $_settings.tabIndex, $settingsStripEmpty = $select.data("strip-empty") ? $select.data("strip-empty") : $_settings.stripEmpty, $selectTitle = $select.prop("title") ? $select.prop("title") : null, $selectDisabled = $select.is(":disabled") ? " disabled" : "", $sodPrefix = "", $sodHtml = "", $sodHeight = 0, $sod, $sodListWrapper, $sodList;
                        if ($settingsPrefix) {
                            $sodPrefix = '<span class="sod_prefix">' + $settingsPrefix + "</span> ";
                        }
                        if ($settingsPlaceholder && !$settingsPrefix) {
                            $sodHtml += '<span class="sod_label sod_placeholder">' + $settingsPlaceholder + "</span>";
                        } else {
                            $sodHtml += '<span class="sod_label">' + $sodPrefix + "</span>";
                        }
                        $sod = $("<span/>", {
                            id: $settingsId,
                            "class": "sod_select " + $settingsClass + $selectDisabled,
                            title: $selectTitle,
                            tabindex: $settingsTabIndex,
                            html: $sodHtml,
                            "data-cycle": $settingsCycle,
                            "data-links": $settingsLinks,
                            "data-links-external": $settingsLinksExternal,
                            "data-placeholder": $settingsPlaceholder,
                            "data-placeholder-option": $settingsPlaceholderOption,
                            "data-prefix": $settingsPrefix,
                            "data-filter": ""
                        }).insertAfter(this);
                        if (_private.isTouch()) {
                            $sod.addClass("touch");
                        }
                        $sodListWrapper = $("<span/>", {
                            "class": "sod_list_wrapper"
                        }).appendTo($sod);
                        $sodList = $("<span/>", {
                            "class": "sod_list"
                        }).appendTo($sodListWrapper);
                        $("option, optgroup", $select).each(function(i) {
                            var $this = $(this);
                            if ($settingsStripEmpty && !$.trim($this.text())) {
                                $this.remove();
                            } else if (i === 0 && $settingsPlaceholderOption && !$sodPrefix) _private.populateSoD($this, $sodList, $sod, true); else {
                                _private.populateSoD($this, $sodList, $sod, false);
                            }
                        });
                        if ($settingsSize) {
                            $sodListWrapper.show();
                            $(".sod_option:lt(" + $settingsSize + ")", $sodList).each(function() {
                                $sodHeight += $(this).outerHeight();
                            });
                            $sodListWrapper.removeAttr("style");
                            $sodList.css({
                                "max-height": $sodHeight
                            });
                        }
                        $select.appendTo($sod);
                        $sod.on("focusin", _private.focusSod).on("click", _private.triggerSod).on("click", ".sod_option", _private.optionClick).on("mousemove", ".sod_option", _private.optionHover).on("keydown", _private.keyboardUse);
                        $select.on("change", _private.selectChange);
                        $(document).on("click", "label[for='" + $select.attr("id") + "']", function(e) {
                            e.preventDefault();
                            $sod.focus();
                        });
                    } else {
                        console.log("Select or Die: It looks like the SoD already exists");
                    }
                });
            },
            populateSoD: function($option, $sodList, $sod, $isPlaceholder) {
                var $sodPlaceholder = $sod.data("placeholder"), $sodPlaceholderOption = $sod.data("placeholder-option"), $sodPrefix = $sod.data("prefix"), $sodLabel = $sod.find(".sod_label"), $optionParent = $option.parent(), $optionText = $option.text(), $optionValue = $option.val(), $optionCustomId = $option.data("custom-id") ? $option.data("custom-id") : null, $optionCustomClass = $option.data("custom-class") ? $option.data("custom-class") : "", $optionIsDisabled = $option.is(":disabled") ? " disabled " : "", $optionIsSelected = $option.is(":selected") ? " selected active " : "", $optionLink = $option.data("link") ? " link " : "", $optionLinkExternal = $option.data("link-external") ? " linkexternal" : "", $optgroupLabel = $option.prop("label");
                if ($option.is("option")) {
                    $("<span/>", {
                        "class": "sod_option " + $optionCustomClass + $optionIsDisabled + $optionIsSelected + $optionLink + $optionLinkExternal,
                        id: $optionCustomId,
                        title: $optionText,
                        html: $optionText,
                        "data-value": $optionValue
                    }).appendTo($sodList);
                    if ($isPlaceholder && !$sodPrefix) {
                        $sod.data("label", $optionText);
                        $sod.data("placeholder", $optionText);
                        $option.prop("disabled", true);
                        $sodList.find(".sod_option:last").addClass("is-placeholder disabled");
                        if ($optionIsSelected) {
                            $sodLabel.addClass("sod_placeholder");
                        }
                    } else if ($optionIsSelected && $sodPlaceholder && !$sodPlaceholderOption && !$sodPrefix) {
                        $sod.data("label", $sodPlaceholder);
                    } else if ($optionIsSelected) {
                        $sod.data("label", $optionText);
                    }
                    if ($optionIsSelected && !$sodPlaceholder || $optionIsSelected && $sodPlaceholderOption || $optionIsSelected && $sodPrefix) {
                        $sodLabel.append($optionText);
                    }
                    if ($optionParent.is("optgroup")) {
                        $sodList.find(".sod_option:last").addClass("groupchild");
                        if ($optionParent.is(":disabled")) {
                            $sodList.find(".sod_option:last").addClass("disabled");
                        }
                    }
                } else {
                    $("<span/>", {
                        "class": "sod_option optgroup " + $optionIsDisabled,
                        title: $optgroupLabel,
                        html: $optgroupLabel,
                        "data-label": $optgroupLabel
                    }).appendTo($sodList);
                }
            },
            focusSod: function() {
                var $sod = $(this);
                if (!$sod.hasClass("disabled")) {
                    _private.blurSod($(".sod_select.focus").not($sod));
                    $sod.addClass("focus");
                    $("html").on("click.sodBlur", function() {
                        _private.blurSod($sod);
                    });
                } else {
                    _private.blurSod($sod);
                }
            },
            triggerSod: function(e) {
                e.stopPropagation();
                var $sod = $(this), $sodList = $sod.find(".sod_list"), $sodPlaceholder = $sod.data("placeholder"), $optionActive = $sod.find(".active"), $optionSelected = $sod.find(".selected");
                if (!$sod.hasClass("disabled") && !$sod.hasClass("open") && !$sod.hasClass("touch")) {
                    $sod.addClass("open");
                    if ($sodPlaceholder && !$sod.data("prefix")) {
                        $sod.find(".sod_label").addClass("sod_placeholder").html($sodPlaceholder);
                    }
                    _private.listScroll($sodList, $optionSelected);
                    _private.checkViewport($sod, $sodList);
                } else {
                    clearTimeout($_sodViewportTimeout);
                    $sod.removeClass("open");
                    if ($sodPlaceholder) {
                        $sod.find(".sod_label").get(0).lastChild.nodeValue = $optionActive.text();
                    }
                }
            },
            keyboardUse: function(e) {
                var $sod = $(this), $sodList = $sod.find(".sod_list"), $sodOptions = $sod.find(".sod_option"), $sodLabel = $sod.find(".sod_label"), $sodCycle = $sod.data("cycle"), $optionActive = $sodOptions.filter(".active"), $sodFilterHit, $optionNext, $optionCycle;
                if (e.which > 36 && e.which < 41) {
                    if (e.which === 37 || e.which === 38) {
                        $optionNext = $optionActive.prevAll(":not('.disabled, .optgroup')").first();
                        $optionCycle = $sodOptions.not(".disabled, .optgroup").last();
                    } else if (e.which === 39 || e.which === 40) {
                        $optionNext = $optionActive.nextAll(":not('.disabled, .optgroup')").first();
                        $optionCycle = $sodOptions.not(".disabled, .optgroup").first();
                    }
                    if (!$optionNext.hasClass("sod_option") && $sodCycle) {
                        $optionNext = $optionCycle;
                    }
                    if ($optionNext.hasClass("sod_option") || $sodCycle) {
                        $optionActive.removeClass("active");
                        $optionNext.addClass("active");
                        $sodLabel.get(0).lastChild.nodeValue = $optionNext.text();
                        _private.listScroll($sodList, $optionNext);
                        if (!$sod.hasClass("open")) {
                            $_sodKeysWhenClosed = true;
                        }
                    }
                    return false;
                } else if (e.which === 13 || e.which === 32 && $sod.hasClass("open") && ($sod.data("filter")[0] === " " || $sod.data("filter") === "")) {
                    e.preventDefault();
                    $optionActive.click();
                } else if (e.which === 32 && !$sod.hasClass("open") && ($sod.data("filter")[0] === " " || $sod.data("filter") === "")) {
                    e.preventDefault();
                    $_sodKeysWhenClosed = false;
                    $sod.click();
                } else if (e.which === 27) {
                    _private.blurSod($sod);
                }
                if (e.which !== 0) {
                    clearTimeout($_sodFilterTimeout);
                    $sod.data("filter", $sod.data("filter") + String.fromCharCode(e.which));
                    $sodFilterHit = $sodOptions.filter(function() {
                        return $(this).text().toLowerCase().indexOf($sod.data("filter").toLowerCase()) === 0;
                    }).not(".disabled, .optgroup").first();
                    if ($sodFilterHit.length) {
                        $optionActive.removeClass("active");
                        $sodFilterHit.addClass("active");
                        _private.listScroll($sodList, $sodFilterHit);
                        $sodLabel.get(0).lastChild.nodeValue = $sodFilterHit.text();
                        if (!$sod.hasClass("open")) {
                            $_sodKeysWhenClosed = true;
                        }
                    }
                    $_sodFilterTimeout = setTimeout(function() {
                        $sod.data("filter", "");
                    }, 500);
                }
            },
            optionHover: function() {
                var $option = $(this);
                if (!$option.hasClass("disabled") && !$option.hasClass("optgroup")) {
                    $option.siblings().removeClass("active").end().addClass("active");
                }
            },
            optionClick: function(e) {
                e.stopPropagation();
                var $clicked = $(this), $sod = $clicked.closest(".sod_select"), $optionDisabled = $clicked.hasClass("disabled"), $optionOptgroup = $clicked.hasClass("optgroup"), $optionIndex = $sod.find(".sod_option:not('.optgroup')").index(this);
                if ($sod.hasClass("touch")) {
                    return;
                }
                if (!$optionDisabled && !$optionOptgroup) {
                    $sod.find(".selected, .sod_placeholder").removeClass("selected sod_placeholder");
                    $clicked.addClass("selected");
                    $sod.find("select option")[$optionIndex].selected = true;
                    $sod.find("select").change();
                }
                clearTimeout($_sodViewportTimeout);
                $sod.removeClass("open");
            },
            selectChange: function() {
                var $select = $(this), $optionSelected = $select.find(":selected"), $optionText = $optionSelected.text(), $sod = $select.closest(".sod_select");
                $sod.find(".sod_label").get(0).lastChild.nodeValue = $optionText;
                $sod.data("label", $optionText);
                $_settings.onChange.call(this);
                if (($sod.data("links") || $optionSelected.data("link")) && !$optionSelected.data("link-external")) {
                    window.location.href = $optionSelected.val();
                } else if ($sod.data("links-external") || $optionSelected.data("link-external")) {
                    window.open($optionSelected.val(), "_blank");
                }
            },
            blurSod: function($sod) {
                if ($("body").find($sod).length) {
                    var $sodLabel = $sod.data("label"), $sodPlaceholder = $sod.data("placeholder"), $optionActive = $sod.find(".active"), $optionSelected = $sod.find(".selected"), $optionHasChanged = false;
                    clearTimeout($_sodViewportTimeout);
                    if ($_sodKeysWhenClosed && !$optionActive.hasClass("selected")) {
                        $optionActive.click();
                        $optionHasChanged = true;
                    } else if (!$optionActive.hasClass("selected")) {
                        $optionActive.removeClass("active");
                        $optionSelected.addClass("active");
                    }
                    if (!$optionHasChanged && $sodPlaceholder) {
                        $sod.find(".sod_label").get(0).lastChild.nodeValue = $optionSelected.text();
                    } else if (!$optionHasChanged) {
                        $sod.find(".sod_label").get(0).lastChild.nodeValue = $sodLabel;
                    }
                    $_sodKeysWhenClosed = false;
                    $sod.removeClass("open focus");
                    $sod.blur();
                    $("html").off(".sodBlur");
                }
            },
            checkViewport: function($sod, $sodList) {
                var $sodPosition = $sod[0].getBoundingClientRect(), $sodListHeight = $sodList.outerHeight();
                if ($sodPosition.bottom + $sodListHeight + 10 > $(window).height() && $sodPosition.top - $sodListHeight > 10) {
                    $sod.addClass("above");
                } else {
                    $sod.removeClass("above");
                }
                $_sodViewportTimeout = setTimeout(function() {
                    _private.checkViewport($sod, $sodList);
                }, 200);
            },
            listScroll: function($sodList, $option) {
                var $scrollList = $sodList[0].getBoundingClientRect(), $scrollOption = $option[0].getBoundingClientRect();
                if ($scrollList.top > $scrollOption.top) {
                    $sodList.scrollTop($sodList.scrollTop() - $scrollList.top + $scrollOption.top);
                } else if ($scrollList.bottom < $scrollOption.bottom) {
                    $sodList.scrollTop($sodList.scrollTop() - $scrollList.bottom + $scrollOption.bottom);
                }
            },
            isTouch: function() {
                return "ontouchstart" in window || navigator.MaxTouchPoints > 0 || navigator.msMaxTouchPoints > 0;
            }
        };
        var methods = {
            destroy: function() {
                return this.each(function() {
                    var $select = $(this), $sod = $select.parent();
                    if ($sod.hasClass("sod_select")) {
                        $select.off("change");
                        $sod.find("span").remove();
                        $select.unwrap();
                    } else {}
                });
            },
            update: function() {
                return this.each(function() {
                    var $select = $(this), $sod = $select.parent(), $sodList = $sod.find(".sod_list:first");
                    if ($sod.hasClass("sod_select")) {
                        $sodList.empty();
                        $sod.find(".sod_label").get(0).lastChild.nodeValue = "";
                        if ($select.is(":disabled")) {
                            $sod.addClass("disabled");
                        }
                        $("option, optgroup", $select).each(function() {
                            _private.populateSoD($(this), $sodList, $sod);
                        });
                    } else {
                        console.log("Select or Die: There's no SoD to update");
                    }
                });
            },
            disable: function($value) {
                return this.each(function() {
                    var $select = $(this), $sod = $select.parent();
                    if ($sod.hasClass("sod_select")) {
                        if (typeof $value !== "undefined") {
                            $sod.find(".sod_list:first .sod_option[data-value='" + $value + "']").addClass("disabled");
                            $sod.find(".sod_list:first .sod_option[data-label='" + $value + "']").nextUntil(":not(.groupchild)").addClass("disabled");
                            $("option[value='" + $value + "'], optgroup[label='" + $value + "']", this).prop("disabled", true);
                        } else if ($sod.hasClass("sod_select")) {
                            $sod.addClass("disabled");
                            $select.prop("disabled", true);
                        }
                    } else {
                        console.log("Select or Die: There's no SoD to disable");
                    }
                });
            },
            enable: function($value) {
                return this.each(function() {
                    var $select = $(this), $sod = $select.parent();
                    if ($sod.hasClass("sod_select")) {
                        if (typeof $value !== "undefined") {
                            $sod.find(".sod_list:first .sod_option[data-value='" + $value + "']").removeClass("disabled");
                            $sod.find(".sod_list:first .sod_option[data-label='" + $value + "']").nextUntil(":not(.groupchild)").removeClass("disabled");
                            $("option[value='" + $value + "'], optgroup[label='" + $value + "']", this).prop("disabled", false);
                        } else if ($sod.hasClass("sod_select")) {
                            $sod.removeClass("disabled");
                            $select.prop("disabled", false);
                        }
                    } else {
                        console.log("Select or Die: There's no SoD to enable");
                    }
                });
            }
        };
        if (methods[method]) {
            return methods[method].apply(this, Array.prototype.slice.call(arguments, 1));
        } else if (typeof method === "object" || !method) {
            return _private.initSoD.apply(this, arguments);
        } else {
            $.error('Select or Die: Oh no! No such method "' + method + '" for the SoD instance');
        }
    };
})(jQuery);

!function(a) {
    "use strict";
    "function" == typeof define && define.amd ? define([ "jquery" ], a) : "undefined" != typeof exports ? module.exports = a(require("jquery")) : a(jQuery);
}(function(a) {
    "use strict";
    var b = window.Slick || {};
    b = function() {
        function c(c, d) {
            var f, g, h, e = this;
            if (e.defaults = {
                accessibility: !0,
                adaptiveHeight: !1,
                appendArrows: a(c),
                appendDots: a(c),
                arrows: !0,
                asNavFor: null,
                prevArrow: '<button type="button" data-role="none" class="slick-prev">Previous</button>',
                nextArrow: '<button type="button" data-role="none" class="slick-next">Next</button>',
                autoplay: !1,
                autoplaySpeed: 3e3,
                centerMode: !1,
                centerPadding: "50px",
                cssEase: "ease",
                customPaging: function(a, b) {
                    return '<button type="button" data-role="none">' + (b + 1) + "</button>";
                },
                dots: !1,
                dotsClass: "slick-dots",
                draggable: !0,
                easing: "linear",
                edgeFriction: .35,
                fade: !1,
                focusOnSelect: !1,
                infinite: !0,
                initialSlide: 0,
                lazyLoad: "ondemand",
                mobileFirst: !1,
                pauseOnHover: !0,
                pauseOnDotsHover: !1,
                respondTo: "window",
                responsive: null,
                rtl: !1,
                slide: "",
                slidesToShow: 1,
                slidesToScroll: 1,
                speed: 500,
                swipe: !0,
                swipeToSlide: !1,
                touchMove: !0,
                touchThreshold: 5,
                useCSS: !0,
                variableWidth: !1,
                vertical: !1,
                waitForAnimate: !0
            }, e.initials = {
                animating: !1,
                dragging: !1,
                autoPlayTimer: null,
                currentDirection: 0,
                currentLeft: null,
                currentSlide: 0,
                direction: 1,
                $dots: null,
                listWidth: null,
                listHeight: null,
                loadIndex: 0,
                $nextArrow: null,
                $prevArrow: null,
                slideCount: null,
                slideWidth: null,
                $slideTrack: null,
                $slides: null,
                sliding: !1,
                slideOffset: 0,
                swipeLeft: null,
                $list: null,
                touchObject: {},
                transformsEnabled: !1
            }, a.extend(e, e.initials), e.activeBreakpoint = null, e.animType = null, e.animProp = null, 
            e.breakpoints = [], e.breakpointSettings = [], e.cssTransitions = !1, e.hidden = "hidden", 
            e.paused = !1, e.positionProp = null, e.respondTo = null, e.shouldClick = !0, e.$slider = a(c), 
            e.$slidesCache = null, e.transformType = null, e.transitionType = null, e.visibilityChange = "visibilitychange", 
            e.windowWidth = 0, e.windowTimer = null, f = a(c).data("slick") || {}, e.options = a.extend({}, e.defaults, f, d), 
            e.currentSlide = e.options.initialSlide, e.originalSettings = e.options, g = e.options.responsive || null, 
            g && g.length > -1) {
                e.respondTo = e.options.respondTo || "window";
                for (h in g) g.hasOwnProperty(h) && (e.breakpoints.push(g[h].breakpoint), e.breakpointSettings[g[h].breakpoint] = g[h].settings);
                e.breakpoints.sort(function(a, b) {
                    return e.options.mobileFirst === !0 ? a - b : b - a;
                });
            }
            "undefined" != typeof document.mozHidden ? (e.hidden = "mozHidden", e.visibilityChange = "mozvisibilitychange") : "undefined" != typeof document.msHidden ? (e.hidden = "msHidden", 
            e.visibilityChange = "msvisibilitychange") : "undefined" != typeof document.webkitHidden && (e.hidden = "webkitHidden", 
            e.visibilityChange = "webkitvisibilitychange"), e.autoPlay = a.proxy(e.autoPlay, e), 
            e.autoPlayClear = a.proxy(e.autoPlayClear, e), e.changeSlide = a.proxy(e.changeSlide, e), 
            e.clickHandler = a.proxy(e.clickHandler, e), e.selectHandler = a.proxy(e.selectHandler, e), 
            e.setPosition = a.proxy(e.setPosition, e), e.swipeHandler = a.proxy(e.swipeHandler, e), 
            e.dragHandler = a.proxy(e.dragHandler, e), e.keyHandler = a.proxy(e.keyHandler, e), 
            e.autoPlayIterator = a.proxy(e.autoPlayIterator, e), e.instanceUid = b++, e.htmlExpr = /^(?:\s*(<[\w\W]+>)[^>]*)$/, 
            e.init(), e.checkResponsive(!0);
        }
        var b = 0;
        return c;
    }(), b.prototype.addSlide = b.prototype.slickAdd = function(b, c, d) {
        var e = this;
        if ("boolean" == typeof c) d = c, c = null; else if (0 > c || c >= e.slideCount) return !1;
        e.unload(), "number" == typeof c ? 0 === c && 0 === e.$slides.length ? a(b).appendTo(e.$slideTrack) : d ? a(b).insertBefore(e.$slides.eq(c)) : a(b).insertAfter(e.$slides.eq(c)) : d === !0 ? a(b).prependTo(e.$slideTrack) : a(b).appendTo(e.$slideTrack), 
        e.$slides = e.$slideTrack.children(this.options.slide), e.$slideTrack.children(this.options.slide).detach(), 
        e.$slideTrack.append(e.$slides), e.$slides.each(function(b, c) {
            a(c).attr("data-slick-index", b);
        }), e.$slidesCache = e.$slides, e.reinit();
    }, b.prototype.animateHeight = function() {
        var a = this;
        if (1 === a.options.slidesToShow && a.options.adaptiveHeight === !0 && a.options.vertical === !1) {
            var b = a.$slides.eq(a.currentSlide).outerHeight(!0);
            a.$list.animate({
                height: b
            }, a.options.speed);
        }
    }, b.prototype.animateSlide = function(b, c) {
        var d = {}, e = this;
        e.animateHeight(), e.options.rtl === !0 && e.options.vertical === !1 && (b = -b), 
        e.transformsEnabled === !1 ? e.options.vertical === !1 ? e.$slideTrack.animate({
            left: b
        }, e.options.speed, e.options.easing, c) : e.$slideTrack.animate({
            top: b
        }, e.options.speed, e.options.easing, c) : e.cssTransitions === !1 ? (e.options.rtl === !0 && (e.currentLeft = -e.currentLeft), 
        a({
            animStart: e.currentLeft
        }).animate({
            animStart: b
        }, {
            duration: e.options.speed,
            easing: e.options.easing,
            step: function(a) {
                a = Math.ceil(a), e.options.vertical === !1 ? (d[e.animType] = "translate(" + a + "px, 0px)", 
                e.$slideTrack.css(d)) : (d[e.animType] = "translate(0px," + a + "px)", e.$slideTrack.css(d));
            },
            complete: function() {
                c && c.call();
            }
        })) : (e.applyTransition(), b = Math.ceil(b), d[e.animType] = e.options.vertical === !1 ? "translate3d(" + b + "px, 0px, 0px)" : "translate3d(0px," + b + "px, 0px)", 
        e.$slideTrack.css(d), c && setTimeout(function() {
            e.disableTransition(), c.call();
        }, e.options.speed));
    }, b.prototype.asNavFor = function(b) {
        var c = this, d = null !== c.options.asNavFor ? a(c.options.asNavFor).slick("getSlick") : null;
        null !== d && d.slideHandler(b, !0);
    }, b.prototype.applyTransition = function(a) {
        var b = this, c = {};
        c[b.transitionType] = b.options.fade === !1 ? b.transformType + " " + b.options.speed + "ms " + b.options.cssEase : "opacity " + b.options.speed + "ms " + b.options.cssEase, 
        b.options.fade === !1 ? b.$slideTrack.css(c) : b.$slides.eq(a).css(c);
    }, b.prototype.autoPlay = function() {
        var a = this;
        a.autoPlayTimer && clearInterval(a.autoPlayTimer), a.slideCount > a.options.slidesToShow && a.paused !== !0 && (a.autoPlayTimer = setInterval(a.autoPlayIterator, a.options.autoplaySpeed));
    }, b.prototype.autoPlayClear = function() {
        var a = this;
        a.autoPlayTimer && clearInterval(a.autoPlayTimer);
    }, b.prototype.autoPlayIterator = function() {
        var a = this;
        a.options.infinite === !1 ? 1 === a.direction ? (a.currentSlide + 1 === a.slideCount - 1 && (a.direction = 0), 
        a.slideHandler(a.currentSlide + a.options.slidesToScroll)) : (0 === a.currentSlide - 1 && (a.direction = 1), 
        a.slideHandler(a.currentSlide - a.options.slidesToScroll)) : a.slideHandler(a.currentSlide + a.options.slidesToScroll);
    }, b.prototype.buildArrows = function() {
        var b = this;
        b.options.arrows === !0 && b.slideCount > b.options.slidesToShow && (b.$prevArrow = a(b.options.prevArrow), 
        b.$nextArrow = a(b.options.nextArrow), b.htmlExpr.test(b.options.prevArrow) && b.$prevArrow.appendTo(b.options.appendArrows), 
        b.htmlExpr.test(b.options.nextArrow) && b.$nextArrow.appendTo(b.options.appendArrows), 
        b.options.infinite !== !0 && b.$prevArrow.addClass("slick-disabled"));
    }, b.prototype.buildDots = function() {
        var c, d, b = this;
        if (b.options.dots === !0 && b.slideCount > b.options.slidesToShow) {
            for (d = '<ul class="' + b.options.dotsClass + '">', c = 0; c <= b.getDotCount(); c += 1) d += "<li>" + b.options.customPaging.call(this, b, c) + "</li>";
            d += "</ul>", b.$dots = a(d).appendTo(b.options.appendDots), b.$dots.find("li").first().addClass("slick-active");
        }
    }, b.prototype.buildOut = function() {
        var b = this;
        b.$slides = b.$slider.children(b.options.slide + ":not(.slick-cloned)").addClass("slick-slide"), 
        b.slideCount = b.$slides.length, b.$slides.each(function(b, c) {
            a(c).attr("data-slick-index", b);
        }), b.$slidesCache = b.$slides, b.$slider.addClass("slick-slider"), b.$slideTrack = 0 === b.slideCount ? a('<div class="slick-track"/>').appendTo(b.$slider) : b.$slides.wrapAll('<div class="slick-track"/>').parent(), 
        b.$list = b.$slideTrack.wrap('<div class="slick-list"/>').parent(), b.$slideTrack.css("opacity", 0), 
        (b.options.centerMode === !0 || b.options.swipeToSlide === !0) && (b.options.slidesToScroll = 1), 
        a("img[data-lazy]", b.$slider).not("[src]").addClass("slick-loading"), b.setupInfinite(), 
        b.buildArrows(), b.buildDots(), b.updateDots(), b.options.accessibility === !0 && b.$list.prop("tabIndex", 0), 
        b.setSlideClasses("number" == typeof this.currentSlide ? this.currentSlide : 0), 
        b.options.draggable === !0 && b.$list.addClass("draggable");
    }, b.prototype.checkResponsive = function(b) {
        var d, e, f, c = this, g = c.$slider.width(), h = window.innerWidth || a(window).width();
        if ("window" === c.respondTo ? f = h : "slider" === c.respondTo ? f = g : "min" === c.respondTo && (f = Math.min(h, g)), 
        c.originalSettings.responsive && c.originalSettings.responsive.length > -1 && null !== c.originalSettings.responsive) {
            e = null;
            for (d in c.breakpoints) c.breakpoints.hasOwnProperty(d) && (c.originalSettings.mobileFirst === !1 ? f < c.breakpoints[d] && (e = c.breakpoints[d]) : f > c.breakpoints[d] && (e = c.breakpoints[d]));
            null !== e ? null !== c.activeBreakpoint ? e !== c.activeBreakpoint && (c.activeBreakpoint = e, 
            "unslick" === c.breakpointSettings[e] ? c.unslick() : (c.options = a.extend({}, c.originalSettings, c.breakpointSettings[e]), 
            b === !0 && (c.currentSlide = c.options.initialSlide), c.refresh())) : (c.activeBreakpoint = e, 
            "unslick" === c.breakpointSettings[e] ? c.unslick() : (c.options = a.extend({}, c.originalSettings, c.breakpointSettings[e]), 
            b === !0 && (c.currentSlide = c.options.initialSlide), c.refresh())) : null !== c.activeBreakpoint && (c.activeBreakpoint = null, 
            c.options = c.originalSettings, b === !0 && (c.currentSlide = c.options.initialSlide), 
            c.refresh());
        }
    }, b.prototype.changeSlide = function(b, c) {
        var f, g, h, d = this, e = a(b.target);
        switch (e.is("a") && b.preventDefault(), h = 0 !== d.slideCount % d.options.slidesToScroll, 
        f = h ? 0 : (d.slideCount - d.currentSlide) % d.options.slidesToScroll, b.data.message) {
          case "previous":
            g = 0 === f ? d.options.slidesToScroll : d.options.slidesToShow - f, d.slideCount > d.options.slidesToShow && d.slideHandler(d.currentSlide - g, !1, c);
            break;

          case "next":
            g = 0 === f ? d.options.slidesToScroll : f, d.slideCount > d.options.slidesToShow && d.slideHandler(d.currentSlide + g, !1, c);
            break;

          case "index":
            var i = 0 === b.data.index ? 0 : b.data.index || a(b.target).parent().index() * d.options.slidesToScroll;
            d.slideHandler(d.checkNavigable(i), !1, c);
            break;

          default:
            return;
        }
    }, b.prototype.checkNavigable = function(a) {
        var c, d, b = this;
        if (c = b.getNavigableIndexes(), d = 0, a > c[c.length - 1]) a = c[c.length - 1]; else for (var e in c) {
            if (a < c[e]) {
                a = d;
                break;
            }
            d = c[e];
        }
        return a;
    }, b.prototype.clickHandler = function(a) {
        var b = this;
        b.shouldClick === !1 && (a.stopImmediatePropagation(), a.stopPropagation(), a.preventDefault());
    }, b.prototype.destroy = function() {
        var b = this;
        b.autoPlayClear(), b.touchObject = {}, a(".slick-cloned", b.$slider).remove(), b.$dots && b.$dots.remove(), 
        b.$prevArrow && "object" != typeof b.options.prevArrow && b.$prevArrow.remove(), 
        b.$nextArrow && "object" != typeof b.options.nextArrow && b.$nextArrow.remove(), 
        b.$slides.removeClass("slick-slide slick-active slick-center slick-visible").removeAttr("data-slick-index").css({
            position: "",
            left: "",
            top: "",
            zIndex: "",
            opacity: "",
            width: ""
        }), b.$slider.removeClass("slick-slider"), b.$slider.removeClass("slick-initialized"), 
        b.$list.off(".slick"), a(window).off(".slick-" + b.instanceUid), a(document).off(".slick-" + b.instanceUid), 
        b.$slider.html(b.$slides);
    }, b.prototype.disableTransition = function(a) {
        var b = this, c = {};
        c[b.transitionType] = "", b.options.fade === !1 ? b.$slideTrack.css(c) : b.$slides.eq(a).css(c);
    }, b.prototype.fadeSlide = function(a, b) {
        var c = this;
        c.cssTransitions === !1 ? (c.$slides.eq(a).css({
            zIndex: 1e3
        }), c.$slides.eq(a).animate({
            opacity: 1
        }, c.options.speed, c.options.easing, b)) : (c.applyTransition(a), c.$slides.eq(a).css({
            opacity: 1,
            zIndex: 1e3
        }), b && setTimeout(function() {
            c.disableTransition(a), b.call();
        }, c.options.speed));
    }, b.prototype.filterSlides = b.prototype.slickFilter = function(a) {
        var b = this;
        null !== a && (b.unload(), b.$slideTrack.children(this.options.slide).detach(), 
        b.$slidesCache.filter(a).appendTo(b.$slideTrack), b.reinit());
    }, b.prototype.getCurrent = b.prototype.slickCurrentSlide = function() {
        var a = this;
        return a.currentSlide;
    }, b.prototype.getDotCount = function() {
        var a = this, b = 0, c = 0, d = 0;
        if (a.options.infinite === !0) d = Math.ceil(a.slideCount / a.options.slidesToScroll); else if (a.options.centerMode === !0) d = a.slideCount; else for (;b < a.slideCount; ) ++d, 
        b = c + a.options.slidesToShow, c += a.options.slidesToScroll <= a.options.slidesToShow ? a.options.slidesToScroll : a.options.slidesToShow;
        return d - 1;
    }, b.prototype.getLeft = function(a) {
        var c, d, f, b = this, e = 0;
        return b.slideOffset = 0, d = b.$slides.first().outerHeight(), b.options.infinite === !0 ? (b.slideCount > b.options.slidesToShow && (b.slideOffset = -1 * b.slideWidth * b.options.slidesToShow, 
        e = -1 * d * b.options.slidesToShow), 0 !== b.slideCount % b.options.slidesToScroll && a + b.options.slidesToScroll > b.slideCount && b.slideCount > b.options.slidesToShow && (a > b.slideCount ? (b.slideOffset = -1 * (b.options.slidesToShow - (a - b.slideCount)) * b.slideWidth, 
        e = -1 * (b.options.slidesToShow - (a - b.slideCount)) * d) : (b.slideOffset = -1 * b.slideCount % b.options.slidesToScroll * b.slideWidth, 
        e = -1 * b.slideCount % b.options.slidesToScroll * d))) : a + b.options.slidesToShow > b.slideCount && (b.slideOffset = (a + b.options.slidesToShow - b.slideCount) * b.slideWidth, 
        e = (a + b.options.slidesToShow - b.slideCount) * d), b.slideCount <= b.options.slidesToShow && (b.slideOffset = 0, 
        e = 0), b.options.centerMode === !0 && b.options.infinite === !0 ? b.slideOffset += b.slideWidth * Math.floor(b.options.slidesToShow / 2) - b.slideWidth : b.options.centerMode === !0 && (b.slideOffset = 0, 
        b.slideOffset += b.slideWidth * Math.floor(b.options.slidesToShow / 2)), c = b.options.vertical === !1 ? -1 * a * b.slideWidth + b.slideOffset : -1 * a * d + e, 
        b.options.variableWidth === !0 && (f = b.slideCount <= b.options.slidesToShow || b.options.infinite === !1 ? b.$slideTrack.children(".slick-slide").eq(a) : b.$slideTrack.children(".slick-slide").eq(a + b.options.slidesToShow), 
        c = f[0] ? -1 * f[0].offsetLeft : 0, b.options.centerMode === !0 && (f = b.options.infinite === !1 ? b.$slideTrack.children(".slick-slide").eq(a) : b.$slideTrack.children(".slick-slide").eq(a + b.options.slidesToShow + 1), 
        c = f[0] ? -1 * f[0].offsetLeft : 0, c += (b.$list.width() - f.outerWidth()) / 2)), 
        c;
    }, b.prototype.getOption = b.prototype.slickGetOption = function(a) {
        var b = this;
        return b.options[a];
    }, b.prototype.getNavigableIndexes = function() {
        var e, a = this, b = 0, c = 0, d = [];
        for (a.options.infinite === !1 ? (e = a.slideCount - a.options.slidesToShow + 1, 
        a.options.centerMode === !0 && (e = a.slideCount)) : (b = -1 * a.slideCount, c = -1 * a.slideCount, 
        e = 2 * a.slideCount); e > b; ) d.push(b), b = c + a.options.slidesToScroll, c += a.options.slidesToScroll <= a.options.slidesToShow ? a.options.slidesToScroll : a.options.slidesToShow;
        return d;
    }, b.prototype.getSlick = function() {
        return this;
    }, b.prototype.getSlideCount = function() {
        var c, d, e, b = this;
        return e = b.options.centerMode === !0 ? b.slideWidth * Math.floor(b.options.slidesToShow / 2) : 0, 
        b.options.swipeToSlide === !0 ? (b.$slideTrack.find(".slick-slide").each(function(c, f) {
            return f.offsetLeft - e + a(f).outerWidth() / 2 > -1 * b.swipeLeft ? (d = f, !1) : void 0;
        }), c = Math.abs(a(d).attr("data-slick-index") - b.currentSlide) || 1) : b.options.slidesToScroll;
    }, b.prototype.goTo = b.prototype.slickGoTo = function(a, b) {
        var c = this;
        c.changeSlide({
            data: {
                message: "index",
                index: parseInt(a)
            }
        }, b);
    }, b.prototype.init = function() {
        var b = this;
        a(b.$slider).hasClass("slick-initialized") || (a(b.$slider).addClass("slick-initialized"), 
        b.buildOut(), b.setProps(), b.startLoad(), b.loadSlider(), b.initializeEvents(), 
        b.updateArrows(), b.updateDots()), b.$slider.trigger("init", [ b ]);
    }, b.prototype.initArrowEvents = function() {
        var a = this;
        a.options.arrows === !0 && a.slideCount > a.options.slidesToShow && (a.$prevArrow.on("click.slick", {
            message: "previous"
        }, a.changeSlide), a.$nextArrow.on("click.slick", {
            message: "next"
        }, a.changeSlide));
    }, b.prototype.initDotEvents = function() {
        var b = this;
        b.options.dots === !0 && b.slideCount > b.options.slidesToShow && a("li", b.$dots).on("click.slick", {
            message: "index"
        }, b.changeSlide), b.options.dots === !0 && b.options.pauseOnDotsHover === !0 && b.options.autoplay === !0 && a("li", b.$dots).on("mouseenter.slick", function() {
            b.paused = !0, b.autoPlayClear();
        }).on("mouseleave.slick", function() {
            b.paused = !1, b.autoPlay();
        });
    }, b.prototype.initializeEvents = function() {
        var b = this;
        b.initArrowEvents(), b.initDotEvents(), b.$list.on("touchstart.slick mousedown.slick", {
            action: "start"
        }, b.swipeHandler), b.$list.on("touchmove.slick mousemove.slick", {
            action: "move"
        }, b.swipeHandler), b.$list.on("touchend.slick mouseup.slick", {
            action: "end"
        }, b.swipeHandler), b.$list.on("touchcancel.slick mouseleave.slick", {
            action: "end"
        }, b.swipeHandler), b.$list.on("click.slick", b.clickHandler), b.options.autoplay === !0 && (a(document).on(b.visibilityChange, function() {
            b.visibility();
        }), b.options.pauseOnHover === !0 && (b.$list.on("mouseenter.slick", function() {
            b.paused = !0, b.autoPlayClear();
        }), b.$list.on("mouseleave.slick", function() {
            b.paused = !1, b.autoPlay();
        }))), b.options.accessibility === !0 && b.$list.on("keydown.slick", b.keyHandler), 
        b.options.focusOnSelect === !0 && a(b.$slideTrack).children().on("click.slick", b.selectHandler), 
        a(window).on("orientationchange.slick.slick-" + b.instanceUid, function() {
            b.checkResponsive(), b.setPosition();
        }), a(window).on("resize.slick.slick-" + b.instanceUid, function() {
            a(window).width() !== b.windowWidth && (clearTimeout(b.windowDelay), b.windowDelay = window.setTimeout(function() {
                b.windowWidth = a(window).width(), b.checkResponsive(), b.setPosition();
            }, 50));
        }), a("*[draggable!=true]", b.$slideTrack).on("dragstart", function(a) {
            a.preventDefault();
        }), a(window).on("load.slick.slick-" + b.instanceUid, b.setPosition), a(document).on("ready.slick.slick-" + b.instanceUid, b.setPosition);
    }, b.prototype.initUI = function() {
        var a = this;
        a.options.arrows === !0 && a.slideCount > a.options.slidesToShow && (a.$prevArrow.show(), 
        a.$nextArrow.show()), a.options.dots === !0 && a.slideCount > a.options.slidesToShow && a.$dots.show(), 
        a.options.autoplay === !0 && a.autoPlay();
    }, b.prototype.keyHandler = function(a) {
        var b = this;
        37 === a.keyCode && b.options.accessibility === !0 ? b.changeSlide({
            data: {
                message: "previous"
            }
        }) : 39 === a.keyCode && b.options.accessibility === !0 && b.changeSlide({
            data: {
                message: "next"
            }
        });
    }, b.prototype.lazyLoad = function() {
        function g(b) {
            a("img[data-lazy]", b).each(function() {
                var b = a(this), c = a(this).attr("data-lazy");
                b.load(function() {
                    b.animate({
                        opacity: 1
                    }, 200);
                }).css({
                    opacity: 0
                }).attr("src", c).removeAttr("data-lazy").removeClass("slick-loading");
            });
        }
        var c, d, e, f, b = this;
        b.options.centerMode === !0 ? b.options.infinite === !0 ? (e = b.currentSlide + (b.options.slidesToShow / 2 + 1), 
        f = e + b.options.slidesToShow + 2) : (e = Math.max(0, b.currentSlide - (b.options.slidesToShow / 2 + 1)), 
        f = 2 + (b.options.slidesToShow / 2 + 1) + b.currentSlide) : (e = b.options.infinite ? b.options.slidesToShow + b.currentSlide : b.currentSlide, 
        f = e + b.options.slidesToShow, b.options.fade === !0 && (e > 0 && e--, f <= b.slideCount && f++)), 
        c = b.$slider.find(".slick-slide").slice(e, f), g(c), b.slideCount <= b.options.slidesToShow ? (d = b.$slider.find(".slick-slide"), 
        g(d)) : b.currentSlide >= b.slideCount - b.options.slidesToShow ? (d = b.$slider.find(".slick-cloned").slice(0, b.options.slidesToShow), 
        g(d)) : 0 === b.currentSlide && (d = b.$slider.find(".slick-cloned").slice(-1 * b.options.slidesToShow), 
        g(d));
    }, b.prototype.loadSlider = function() {
        var a = this;
        a.setPosition(), a.$slideTrack.css({
            opacity: 1
        }), a.$slider.removeClass("slick-loading"), a.initUI(), "progressive" === a.options.lazyLoad && a.progressiveLazyLoad();
    }, b.prototype.next = b.prototype.slickNext = function() {
        var a = this;
        a.changeSlide({
            data: {
                message: "next"
            }
        });
    }, b.prototype.pause = b.prototype.slickPause = function() {
        var a = this;
        a.autoPlayClear(), a.paused = !0;
    }, b.prototype.play = b.prototype.slickPlay = function() {
        var a = this;
        a.paused = !1, a.autoPlay();
    }, b.prototype.postSlide = function(a) {
        var b = this;
        b.$slider.trigger("afterChange", [ b, a ]), b.animating = !1, b.setPosition(), b.swipeLeft = null, 
        b.options.autoplay === !0 && b.paused === !1 && b.autoPlay();
    }, b.prototype.prev = b.prototype.slickPrev = function() {
        var a = this;
        a.changeSlide({
            data: {
                message: "previous"
            }
        });
    }, b.prototype.progressiveLazyLoad = function() {
        var c, d, b = this;
        c = a("img[data-lazy]", b.$slider).length, c > 0 && (d = a("img[data-lazy]", b.$slider).first(), 
        d.attr("src", d.attr("data-lazy")).removeClass("slick-loading").load(function() {
            d.removeAttr("data-lazy"), b.progressiveLazyLoad();
        }).error(function() {
            d.removeAttr("data-lazy"), b.progressiveLazyLoad();
        }));
    }, b.prototype.refresh = function() {
        var b = this, c = b.currentSlide;
        b.destroy(), a.extend(b, b.initials), b.init(), b.changeSlide({
            data: {
                message: "index",
                index: c
            }
        }, !0);
    }, b.prototype.reinit = function() {
        var b = this;
        b.$slides = b.$slideTrack.children(b.options.slide).addClass("slick-slide"), b.slideCount = b.$slides.length, 
        b.currentSlide >= b.slideCount && 0 !== b.currentSlide && (b.currentSlide = b.currentSlide - b.options.slidesToScroll), 
        b.slideCount <= b.options.slidesToShow && (b.currentSlide = 0), b.setProps(), b.setupInfinite(), 
        b.buildArrows(), b.updateArrows(), b.initArrowEvents(), b.buildDots(), b.updateDots(), 
        b.initDotEvents(), b.options.focusOnSelect === !0 && a(b.$slideTrack).children().on("click.slick", b.selectHandler), 
        b.setSlideClasses(0), b.setPosition(), b.$slider.trigger("reInit", [ b ]);
    }, b.prototype.removeSlide = b.prototype.slickRemove = function(a, b, c) {
        var d = this;
        return "boolean" == typeof a ? (b = a, a = b === !0 ? 0 : d.slideCount - 1) : a = b === !0 ? --a : a, 
        d.slideCount < 1 || 0 > a || a > d.slideCount - 1 ? !1 : (d.unload(), c === !0 ? d.$slideTrack.children().remove() : d.$slideTrack.children(this.options.slide).eq(a).remove(), 
        d.$slides = d.$slideTrack.children(this.options.slide), d.$slideTrack.children(this.options.slide).detach(), 
        d.$slideTrack.append(d.$slides), d.$slidesCache = d.$slides, d.reinit(), void 0);
    }, b.prototype.setCSS = function(a) {
        var d, e, b = this, c = {};
        b.options.rtl === !0 && (a = -a), d = "left" == b.positionProp ? Math.ceil(a) + "px" : "0px", 
        e = "top" == b.positionProp ? Math.ceil(a) + "px" : "0px", c[b.positionProp] = a, 
        b.transformsEnabled === !1 ? b.$slideTrack.css(c) : (c = {}, b.cssTransitions === !1 ? (c[b.animType] = "translate(" + d + ", " + e + ")", 
        b.$slideTrack.css(c)) : (c[b.animType] = "translate3d(" + d + ", " + e + ", 0px)", 
        b.$slideTrack.css(c)));
    }, b.prototype.setDimensions = function() {
        var a = this;
        if (a.options.vertical === !1 ? a.options.centerMode === !0 && a.$list.css({
            padding: "0px " + a.options.centerPadding
        }) : (a.$list.height(a.$slides.first().outerHeight(!0) * a.options.slidesToShow), 
        a.options.centerMode === !0 && a.$list.css({
            padding: a.options.centerPadding + " 0px"
        })), a.listWidth = a.$list.width(), a.listHeight = a.$list.height(), a.options.vertical === !1 && a.options.variableWidth === !1) a.slideWidth = Math.ceil(a.listWidth / a.options.slidesToShow), 
        a.$slideTrack.width(Math.ceil(a.slideWidth * a.$slideTrack.children(".slick-slide").length)); else if (a.options.variableWidth === !0) {
            var b = 0;
            a.slideWidth = Math.ceil(a.listWidth / a.options.slidesToShow), a.$slideTrack.children(".slick-slide").each(function() {
                b += a.listWidth;
            }), a.$slideTrack.width(Math.ceil(b) + 1);
        } else a.slideWidth = Math.ceil(a.listWidth), a.$slideTrack.height(Math.ceil(a.$slides.first().outerHeight(!0) * a.$slideTrack.children(".slick-slide").length));
        var c = a.$slides.first().outerWidth(!0) - a.$slides.first().width();
        a.options.variableWidth === !1 && a.$slideTrack.children(".slick-slide").width(a.slideWidth - c);
    }, b.prototype.setFade = function() {
        var c, b = this;
        b.$slides.each(function(d, e) {
            c = -1 * b.slideWidth * d, b.options.rtl === !0 ? a(e).css({
                position: "relative",
                right: c,
                top: 0,
                zIndex: 800,
                opacity: 0
            }) : a(e).css({
                position: "relative",
                left: c,
                top: 0,
                zIndex: 800,
                opacity: 0
            });
        }), b.$slides.eq(b.currentSlide).css({
            zIndex: 900,
            opacity: 1
        });
    }, b.prototype.setHeight = function() {
        var a = this;
        if (1 === a.options.slidesToShow && a.options.adaptiveHeight === !0 && a.options.vertical === !1) {
            var b = a.$slides.eq(a.currentSlide).outerHeight(!0);
            a.$list.css("height", b);
        }
    }, b.prototype.setOption = b.prototype.slickSetOption = function(a, b, c) {
        var d = this;
        d.options[a] = b, c === !0 && (d.unload(), d.reinit());
    }, b.prototype.setPosition = function() {
        var a = this;
        a.setDimensions(), a.setHeight(), a.options.fade === !1 ? a.setCSS(a.getLeft(a.currentSlide)) : a.setFade(), 
        a.$slider.trigger("setPosition", [ a ]);
    }, b.prototype.setProps = function() {
        var a = this, b = document.body.style;
        a.positionProp = a.options.vertical === !0 ? "top" : "left", "top" === a.positionProp ? a.$slider.addClass("slick-vertical") : a.$slider.removeClass("slick-vertical"), 
        (void 0 !== b.WebkitTransition || void 0 !== b.MozTransition || void 0 !== b.msTransition) && a.options.useCSS === !0 && (a.cssTransitions = !0), 
        void 0 !== b.OTransform && (a.animType = "OTransform", a.transformType = "-o-transform", 
        a.transitionType = "OTransition", void 0 === b.perspectiveProperty && void 0 === b.webkitPerspective && (a.animType = !1)), 
        void 0 !== b.MozTransform && (a.animType = "MozTransform", a.transformType = "-moz-transform", 
        a.transitionType = "MozTransition", void 0 === b.perspectiveProperty && void 0 === b.MozPerspective && (a.animType = !1)), 
        void 0 !== b.webkitTransform && (a.animType = "webkitTransform", a.transformType = "-webkit-transform", 
        a.transitionType = "webkitTransition", void 0 === b.perspectiveProperty && void 0 === b.webkitPerspective && (a.animType = !1)), 
        void 0 !== b.msTransform && (a.animType = "msTransform", a.transformType = "-ms-transform", 
        a.transitionType = "msTransition", void 0 === b.msTransform && (a.animType = !1)), 
        void 0 !== b.transform && a.animType !== !1 && (a.animType = "transform", a.transformType = "transform", 
        a.transitionType = "transition"), a.transformsEnabled = null !== a.animType && a.animType !== !1;
    }, b.prototype.setSlideClasses = function(a) {
        var c, d, e, f, b = this;
        b.$slider.find(".slick-slide").removeClass("slick-active").removeClass("slick-center"), 
        d = b.$slider.find(".slick-slide"), b.options.centerMode === !0 ? (c = Math.floor(b.options.slidesToShow / 2), 
        b.options.infinite === !0 && (a >= c && a <= b.slideCount - 1 - c ? b.$slides.slice(a - c, a + c + 1).addClass("slick-active") : (e = b.options.slidesToShow + a, 
        d.slice(e - c + 1, e + c + 2).addClass("slick-active")), 0 === a ? d.eq(d.length - 1 - b.options.slidesToShow).addClass("slick-center") : a === b.slideCount - 1 && d.eq(b.options.slidesToShow).addClass("slick-center")), 
        b.$slides.eq(a).addClass("slick-center")) : a >= 0 && a <= b.slideCount - b.options.slidesToShow ? b.$slides.slice(a, a + b.options.slidesToShow).addClass("slick-active") : d.length <= b.options.slidesToShow ? d.addClass("slick-active") : (f = b.slideCount % b.options.slidesToShow, 
        e = b.options.infinite === !0 ? b.options.slidesToShow + a : a, b.options.slidesToShow == b.options.slidesToScroll && b.slideCount - a < b.options.slidesToShow ? d.slice(e - (b.options.slidesToShow - f), e + f).addClass("slick-active") : d.slice(e, e + b.options.slidesToShow).addClass("slick-active")), 
        "ondemand" === b.options.lazyLoad && b.lazyLoad();
    }, b.prototype.setupInfinite = function() {
        var c, d, e, b = this;
        if (b.options.fade === !0 && (b.options.centerMode = !1), b.options.infinite === !0 && b.options.fade === !1 && (d = null, 
        b.slideCount > b.options.slidesToShow)) {
            for (e = b.options.centerMode === !0 ? b.options.slidesToShow + 1 : b.options.slidesToShow, 
            c = b.slideCount; c > b.slideCount - e; c -= 1) d = c - 1, a(b.$slides[d]).clone(!0).attr("id", "").attr("data-slick-index", d - b.slideCount).prependTo(b.$slideTrack).addClass("slick-cloned");
            for (c = 0; e > c; c += 1) d = c, a(b.$slides[d]).clone(!0).attr("id", "").attr("data-slick-index", d + b.slideCount).appendTo(b.$slideTrack).addClass("slick-cloned");
            b.$slideTrack.find(".slick-cloned").find("[id]").each(function() {
                a(this).attr("id", "");
            });
        }
    }, b.prototype.selectHandler = function(b) {
        var c = this, d = parseInt(a(b.target).parents(".slick-slide").attr("data-slick-index"));
        return d || (d = 0), c.slideCount <= c.options.slidesToShow ? (c.$slider.find(".slick-slide").removeClass("slick-active"), 
        c.$slides.eq(d).addClass("slick-active"), c.options.centerMode === !0 && (c.$slider.find(".slick-slide").removeClass("slick-center"), 
        c.$slides.eq(d).addClass("slick-center")), c.asNavFor(d), void 0) : (c.slideHandler(d), 
        void 0);
    }, b.prototype.slideHandler = function(a, b, c) {
        var d, e, f, g, h = null, i = this;
        return b = b || !1, i.animating === !0 && i.options.waitForAnimate === !0 || i.options.fade === !0 && i.currentSlide === a || i.slideCount <= i.options.slidesToShow ? void 0 : (b === !1 && i.asNavFor(a), 
        d = a, h = i.getLeft(d), g = i.getLeft(i.currentSlide), i.currentLeft = null === i.swipeLeft ? g : i.swipeLeft, 
        i.options.infinite === !1 && i.options.centerMode === !1 && (0 > a || a > i.getDotCount() * i.options.slidesToScroll) ? (i.options.fade === !1 && (d = i.currentSlide, 
        c !== !0 ? i.animateSlide(g, function() {
            i.postSlide(d);
        }) : i.postSlide(d)), void 0) : i.options.infinite === !1 && i.options.centerMode === !0 && (0 > a || a > i.slideCount - i.options.slidesToScroll) ? (i.options.fade === !1 && (d = i.currentSlide, 
        c !== !0 ? i.animateSlide(g, function() {
            i.postSlide(d);
        }) : i.postSlide(d)), void 0) : (i.options.autoplay === !0 && clearInterval(i.autoPlayTimer), 
        e = 0 > d ? 0 !== i.slideCount % i.options.slidesToScroll ? i.slideCount - i.slideCount % i.options.slidesToScroll : i.slideCount + d : d >= i.slideCount ? 0 !== i.slideCount % i.options.slidesToScroll ? 0 : d - i.slideCount : d, 
        i.animating = !0, i.$slider.trigger("beforeChange", [ i, i.currentSlide, e ]), f = i.currentSlide, 
        i.currentSlide = e, i.setSlideClasses(i.currentSlide), i.updateDots(), i.updateArrows(), 
        i.options.fade === !0 ? (c !== !0 ? i.fadeSlide(e, function() {
            i.postSlide(e);
        }) : i.postSlide(e), i.animateHeight(), void 0) : (c !== !0 ? i.animateSlide(h, function() {
            i.postSlide(e);
        }) : i.postSlide(e), void 0)));
    }, b.prototype.startLoad = function() {
        var a = this;
        a.options.arrows === !0 && a.slideCount > a.options.slidesToShow && (a.$prevArrow.hide(), 
        a.$nextArrow.hide()), a.options.dots === !0 && a.slideCount > a.options.slidesToShow && a.$dots.hide(), 
        a.$slider.addClass("slick-loading");
    }, b.prototype.swipeDirection = function() {
        var a, b, c, d, e = this;
        return a = e.touchObject.startX - e.touchObject.curX, b = e.touchObject.startY - e.touchObject.curY, 
        c = Math.atan2(b, a), d = Math.round(180 * c / Math.PI), 0 > d && (d = 360 - Math.abs(d)), 
        45 >= d && d >= 0 ? e.options.rtl === !1 ? "left" : "right" : 360 >= d && d >= 315 ? e.options.rtl === !1 ? "left" : "right" : d >= 135 && 225 >= d ? e.options.rtl === !1 ? "right" : "left" : "vertical";
    }, b.prototype.swipeEnd = function() {
        var c, b = this;
        if (b.dragging = !1, b.shouldClick = b.touchObject.swipeLength > 10 ? !1 : !0, void 0 === b.touchObject.curX) return !1;
        if (b.touchObject.edgeHit === !0 && b.$slider.trigger("edge", [ b, b.swipeDirection() ]), 
        b.touchObject.swipeLength >= b.touchObject.minSwipe) switch (b.swipeDirection()) {
          case "left":
            c = b.options.swipeToSlide ? b.checkNavigable(b.currentSlide + b.getSlideCount()) : b.currentSlide + b.getSlideCount(), 
            b.slideHandler(c), b.currentDirection = 0, b.touchObject = {}, b.$slider.trigger("swipe", [ b, "left" ]);
            break;

          case "right":
            c = b.options.swipeToSlide ? b.checkNavigable(b.currentSlide - b.getSlideCount()) : b.currentSlide - b.getSlideCount(), 
            b.slideHandler(c), b.currentDirection = 1, b.touchObject = {}, b.$slider.trigger("swipe", [ b, "right" ]);
        } else b.touchObject.startX !== b.touchObject.curX && (b.slideHandler(b.currentSlide), 
        b.touchObject = {});
    }, b.prototype.swipeHandler = function(a) {
        var b = this;
        if (!(b.options.swipe === !1 || "ontouchend" in document && b.options.swipe === !1 || b.options.draggable === !1 && -1 !== a.type.indexOf("mouse"))) switch (b.touchObject.fingerCount = a.originalEvent && void 0 !== a.originalEvent.touches ? a.originalEvent.touches.length : 1, 
        b.touchObject.minSwipe = b.listWidth / b.options.touchThreshold, a.data.action) {
          case "start":
            b.swipeStart(a);
            break;

          case "move":
            b.swipeMove(a);
            break;

          case "end":
            b.swipeEnd(a);
        }
    }, b.prototype.swipeMove = function(a) {
        var d, e, f, g, h, b = this;
        return h = void 0 !== a.originalEvent ? a.originalEvent.touches : null, !b.dragging || h && 1 !== h.length ? !1 : (d = b.getLeft(b.currentSlide), 
        b.touchObject.curX = void 0 !== h ? h[0].pageX : a.clientX, b.touchObject.curY = void 0 !== h ? h[0].pageY : a.clientY, 
        b.touchObject.swipeLength = Math.round(Math.sqrt(Math.pow(b.touchObject.curX - b.touchObject.startX, 2))), 
        e = b.swipeDirection(), "vertical" !== e ? (void 0 !== a.originalEvent && b.touchObject.swipeLength > 4 && a.preventDefault(), 
        g = (b.options.rtl === !1 ? 1 : -1) * (b.touchObject.curX > b.touchObject.startX ? 1 : -1), 
        f = b.touchObject.swipeLength, b.touchObject.edgeHit = !1, b.options.infinite === !1 && (0 === b.currentSlide && "right" === e || b.currentSlide >= b.getDotCount() && "left" === e) && (f = b.touchObject.swipeLength * b.options.edgeFriction, 
        b.touchObject.edgeHit = !0), b.swipeLeft = b.options.vertical === !1 ? d + f * g : d + f * (b.$list.height() / b.listWidth) * g, 
        b.options.fade === !0 || b.options.touchMove === !1 ? !1 : b.animating === !0 ? (b.swipeLeft = null, 
        !1) : (b.setCSS(b.swipeLeft), void 0)) : void 0);
    }, b.prototype.swipeStart = function(a) {
        var c, b = this;
        return 1 !== b.touchObject.fingerCount || b.slideCount <= b.options.slidesToShow ? (b.touchObject = {}, 
        !1) : (void 0 !== a.originalEvent && void 0 !== a.originalEvent.touches && (c = a.originalEvent.touches[0]), 
        b.touchObject.startX = b.touchObject.curX = void 0 !== c ? c.pageX : a.clientX, 
        b.touchObject.startY = b.touchObject.curY = void 0 !== c ? c.pageY : a.clientY, 
        b.dragging = !0, void 0);
    }, b.prototype.unfilterSlides = b.prototype.slickUnfilter = function() {
        var a = this;
        null !== a.$slidesCache && (a.unload(), a.$slideTrack.children(this.options.slide).detach(), 
        a.$slidesCache.appendTo(a.$slideTrack), a.reinit());
    }, b.prototype.unload = function() {
        var b = this;
        a(".slick-cloned", b.$slider).remove(), b.$dots && b.$dots.remove(), b.$prevArrow && "object" != typeof b.options.prevArrow && b.$prevArrow.remove(), 
        b.$nextArrow && "object" != typeof b.options.nextArrow && b.$nextArrow.remove(), 
        b.$slides.removeClass("slick-slide slick-active slick-visible").css("width", "");
    }, b.prototype.unslick = function() {
        var a = this;
        a.destroy();
    }, b.prototype.updateArrows = function() {
        var b, a = this;
        b = Math.floor(a.options.slidesToShow / 2), a.options.arrows === !0 && a.options.infinite !== !0 && a.slideCount > a.options.slidesToShow && (a.$prevArrow.removeClass("slick-disabled"), 
        a.$nextArrow.removeClass("slick-disabled"), 0 === a.currentSlide ? (a.$prevArrow.addClass("slick-disabled"), 
        a.$nextArrow.removeClass("slick-disabled")) : a.currentSlide >= a.slideCount - a.options.slidesToShow && a.options.centerMode === !1 ? (a.$nextArrow.addClass("slick-disabled"), 
        a.$prevArrow.removeClass("slick-disabled")) : a.currentSlide >= a.slideCount - 1 && a.options.centerMode === !0 && (a.$nextArrow.addClass("slick-disabled"), 
        a.$prevArrow.removeClass("slick-disabled")));
    }, b.prototype.updateDots = function() {
        var a = this;
        null !== a.$dots && (a.$dots.find("li").removeClass("slick-active"), a.$dots.find("li").eq(Math.floor(a.currentSlide / a.options.slidesToScroll)).addClass("slick-active"));
    }, b.prototype.visibility = function() {
        var a = this;
        document[a.hidden] ? (a.paused = !0, a.autoPlayClear()) : (a.paused = !1, a.autoPlay());
    }, a.fn.slick = function() {
        var g, a = this, c = arguments[0], d = Array.prototype.slice.call(arguments, 1), e = a.length, f = 0;
        for (f; e > f; f++) if ("object" == typeof c || "undefined" == typeof c ? a[f].slick = new b(a[f], c) : g = a[f].slick[c].apply(a[f].slick, d), 
        "undefined" != typeof g) return g;
        return a;
    }, a(function() {
        a("[data-slick]").slick();
    });
});

(function() {
    "use strict";
    window.Swiper = function(container, params) {
        var defaults = {
            direction: "horizontal",
            touchEventsTarget: "container",
            initialSlide: 0,
            speed: 300,
            autoplay: false,
            autoplayDisableOnInteraction: true,
            freeMode: false,
            freeModeMomentum: true,
            freeModeMomentumRatio: 1,
            freeModeMomentumBounce: true,
            freeModeMomentumBounceRatio: 1,
            effect: "slide",
            coverflow: {
                rotate: 50,
                stretch: 0,
                depth: 100,
                modifier: 1,
                slideShadows: true
            },
            cube: {
                slideShadows: true,
                shadow: true,
                shadowOffset: 20,
                shadowScale: .94
            },
            fade: {
                crossFade: false
            },
            parallax: false,
            scrollbar: null,
            scrollbarHide: true,
            keyboardControl: false,
            mousewheelControl: false,
            mousewheelForceToAxis: false,
            hashnav: false,
            spaceBetween: 0,
            slidesPerView: 1,
            slidesPerColumn: 1,
            slidesPerColumnFill: "column",
            slidesPerGroup: 1,
            centeredSlides: false,
            touchRatio: 1,
            touchAngle: 45,
            simulateTouch: true,
            shortSwipes: true,
            longSwipes: true,
            longSwipesRatio: .5,
            longSwipesMs: 300,
            followFinger: true,
            onlyExternal: false,
            threshold: 0,
            touchMoveStopPropagation: true,
            pagination: null,
            paginationClickable: false,
            paginationHide: false,
            paginationBulletRender: null,
            resistance: true,
            resistanceRatio: .85,
            nextButton: null,
            prevButton: null,
            watchSlidesProgress: false,
            watchSlidesVisibility: false,
            grabCursor: false,
            preventClicks: true,
            preventClicksPropagation: true,
            slideToClickedSlide: false,
            lazyLoading: false,
            lazyLoadingInPrevNext: false,
            lazyLoadingOnTransitionStart: false,
            preloadImages: true,
            updateOnImagesReady: true,
            loop: false,
            loopAdditionalSlides: 0,
            loopedSlides: null,
            control: undefined,
            controlInverse: false,
            allowSwipeToPrev: true,
            allowSwipeToNext: true,
            swipeHandler: null,
            noSwiping: true,
            noSwipingClass: "swiper-no-swiping",
            slideClass: "swiper-slide",
            slideActiveClass: "swiper-slide-active",
            slideVisibleClass: "swiper-slide-visible",
            slideDuplicateClass: "swiper-slide-duplicate",
            slideNextClass: "swiper-slide-next",
            slidePrevClass: "swiper-slide-prev",
            wrapperClass: "swiper-wrapper",
            bulletClass: "swiper-pagination-bullet",
            bulletActiveClass: "swiper-pagination-bullet-active",
            buttonDisabledClass: "swiper-button-disabled",
            paginationHiddenClass: "swiper-pagination-hidden",
            observer: false,
            observeParents: false,
            runCallbacksOnInit: true
        };
        params = params || {};
        for (var def in defaults) {
            if (typeof params[def] === "undefined") {
                params[def] = defaults[def];
            } else if (typeof params[def] === "object") {
                for (var deepDef in defaults[def]) {
                    if (typeof params[def][deepDef] === "undefined") {
                        params[def][deepDef] = defaults[def][deepDef];
                    }
                }
            }
        }
        var s = this;
        s.params = params;
        var $;
        if (typeof Dom7 === "undefined") {
            $ = window.Dom7 || window.Zepto || window.jQuery;
        } else {
            $ = Dom7;
        }
        if (!$) return;
        s.container = $(container);
        if (s.container.length === 0) return;
        if (s.container.length > 1) {
            s.container.each(function() {
                new Swiper(this, params);
            });
            return;
        }
        s.container[0].swiper = s;
        s.container.data("swiper", s);
        s.container.addClass("swiper-container-" + s.params.direction);
        if (s.params.freeMode) {
            s.container.addClass("swiper-container-free-mode");
        }
        if (s.params.parallax || s.params.watchSlidesVisibility) {
            s.params.watchSlidesProgress = true;
        }
        if ([ "cube", "coverflow" ].indexOf(s.params.effect) >= 0) {
            if (s.support.transforms3d) {
                s.params.watchSlidesProgress = true;
                s.container.addClass("swiper-container-3d");
            } else {
                s.params.effect = "slide";
            }
        }
        if (s.params.effect !== "slide") {
            s.container.addClass("swiper-container-" + s.params.effect);
        }
        if (s.params.effect === "cube") {
            s.params.resistanceRatio = 0;
            s.params.slidesPerView = 1;
            s.params.slidesPerColumn = 1;
            s.params.slidesPerGroup = 1;
            s.params.centeredSlides = false;
            s.params.spaceBetween = 0;
        }
        if (s.params.effect === "fade") {
            s.params.watchSlidesProgress = true;
            s.params.spaceBetween = 0;
        }
        if (s.params.grabCursor && s.support.touch) {
            s.params.grabCursor = false;
        }
        s.wrapper = s.container.children("." + s.params.wrapperClass);
        if (s.params.pagination) {
            s.paginationContainer = $(s.params.pagination);
            if (s.params.paginationClickable) {
                s.paginationContainer.addClass("swiper-pagination-clickable");
            }
        }
        function isH() {
            return s.params.direction === "horizontal";
        }
        s.rtl = isH() && (s.container[0].dir.toLowerCase() === "rtl" || s.container.css("direction") === "rtl");
        if (s.rtl) s.container.addClass("swiper-container-rtl");
        if (s.rtl) {
            s.wrongRTL = s.wrapper.css("display") === "-webkit-box";
        }
        s.translate = 0;
        s.progress = 0;
        s.velocity = 0;
        s.lockSwipeToNext = function() {
            s.params.allowSwipeToNext = false;
        };
        s.lockSwipeToPrev = function() {
            s.params.allowSwipeToPrev = false;
        };
        s.lockSwipes = function() {
            s.params.allowSwipeToNext = s.params.allowSwipeToPrev = false;
        };
        s.unlockSwipeToNext = function() {
            s.params.allowSwipeToNext = true;
        };
        s.unlockSwipeToPrev = function() {
            s.params.allowSwipeToPrev = true;
        };
        s.unlockSwipes = function() {
            s.params.allowSwipeToNext = s.params.allowSwipeToPrev = true;
        };
        if (s.params.slidesPerColumn > 1) {
            s.container.addClass("swiper-container-multirow");
        }
        if (s.params.grabCursor) {
            s.container[0].style.cursor = "move";
            s.container[0].style.cursor = "-webkit-grab";
            s.container[0].style.cursor = "-moz-grab";
            s.container[0].style.cursor = "grab";
        }
        s.imagesToLoad = [];
        s.imagesLoaded = 0;
        s.loadImage = function(imgElement, src, checkForComplete, callback) {
            var image;
            function onReady() {
                if (callback) callback();
            }
            if (!imgElement.complete || !checkForComplete) {
                if (src) {
                    image = new Image();
                    image.onload = onReady;
                    image.onerror = onReady;
                    image.src = src;
                } else {
                    onReady();
                }
            } else {
                onReady();
            }
        };
        s.preloadImages = function() {
            s.imagesToLoad = s.container.find("img");
            function _onReady() {
                if (typeof s === "undefined" || s === null) return;
                if (s.imagesLoaded !== undefined) s.imagesLoaded++;
                if (s.imagesLoaded === s.imagesToLoad.length) {
                    if (s.params.updateOnImagesReady) s.update();
                    if (s.params.onImagesReady) s.params.onImagesReady(s);
                }
            }
            for (var i = 0; i < s.imagesToLoad.length; i++) {
                s.loadImage(s.imagesToLoad[i], s.imagesToLoad[i].currentSrc || s.imagesToLoad[i].getAttribute("src"), true, _onReady);
            }
        };
        s.autoplayTimeoutId = undefined;
        s.autoplaying = false;
        s.autoplayPaused = false;
        function autoplay() {
            s.autoplayTimeoutId = setTimeout(function() {
                if (s.params.loop) {
                    s.fixLoop();
                    s._slideNext();
                } else {
                    if (!s.isEnd) {
                        s._slideNext();
                    } else {
                        if (!params.autoplayStopOnLast) {
                            s._slideTo(0);
                        } else {
                            s.stopAutoplay();
                        }
                    }
                }
            }, s.params.autoplay);
        }
        s.startAutoplay = function() {
            if (typeof s.autoplayTimeoutId !== "undefined") return false;
            if (!s.params.autoplay) return false;
            if (s.autoplaying) return false;
            s.autoplaying = true;
            if (s.params.onAutoplayStart) s.params.onAutoplayStart(s);
            autoplay();
        };
        s.stopAutoplay = function(internal) {
            if (!s.autoplayTimeoutId) return;
            if (s.autoplayTimeoutId) clearTimeout(s.autoplayTimeoutId);
            s.autoplaying = false;
            s.autoplayTimeoutId = undefined;
            if (s.params.onAutoplayStop) s.params.onAutoplayStop(s);
        };
        s.pauseAutoplay = function(speed) {
            if (s.autoplayPaused) return;
            if (s.autoplayTimeoutId) clearTimeout(s.autoplayTimeoutId);
            s.autoplayPaused = true;
            if (speed === 0) {
                s.autoplayPaused = false;
                autoplay();
            } else {
                s.wrapper.transitionEnd(function() {
                    s.autoplayPaused = false;
                    if (!s.autoplaying) {
                        s.stopAutoplay();
                    } else {
                        autoplay();
                    }
                });
            }
        };
        s.minTranslate = function() {
            return -s.snapGrid[0];
        };
        s.maxTranslate = function() {
            return -s.snapGrid[s.snapGrid.length - 1];
        };
        s.updateContainerSize = function() {
            s.width = s.container[0].clientWidth;
            s.height = s.container[0].clientHeight;
            s.size = isH() ? s.width : s.height;
        };
        s.updateSlidesSize = function() {
            s.slides = s.wrapper.children("." + s.params.slideClass);
            s.snapGrid = [];
            s.slidesGrid = [];
            s.slidesSizesGrid = [];
            var spaceBetween = s.params.spaceBetween, slidePosition = 0, i, prevSlideSize = 0, index = 0;
            if (typeof spaceBetween === "string" && spaceBetween.indexOf("%") >= 0) {
                spaceBetween = parseFloat(spaceBetween.replace("%", "")) / 100 * s.size;
            }
            s.virtualWidth = -spaceBetween;
            if (s.rtl) s.slides.css({
                marginLeft: "",
                marginTop: ""
            }); else s.slides.css({
                marginRight: "",
                marginBottom: ""
            });
            var slidesNumberEvenToRows;
            if (s.params.slidesPerColumn > 1) {
                if (Math.floor(s.slides.length / s.params.slidesPerColumn) === s.slides.length / s.params.slidesPerColumn) {
                    slidesNumberEvenToRows = s.slides.length;
                } else {
                    slidesNumberEvenToRows = Math.ceil(s.slides.length / s.params.slidesPerColumn) * s.params.slidesPerColumn;
                }
            }
            var slideSize;
            for (i = 0; i < s.slides.length; i++) {
                slideSize = 0;
                var slide = s.slides.eq(i);
                if (s.params.slidesPerColumn > 1) {
                    var newSlideOrderIndex;
                    var column, row;
                    var slidesPerColumn = s.params.slidesPerColumn;
                    var slidesPerRow;
                    if (s.params.slidesPerColumnFill === "column") {
                        column = Math.floor(i / slidesPerColumn);
                        row = i - column * slidesPerColumn;
                        newSlideOrderIndex = column + row * slidesNumberEvenToRows / slidesPerColumn;
                        slide.css({
                            "-webkit-box-ordinal-group": newSlideOrderIndex,
                            "-moz-box-ordinal-group": newSlideOrderIndex,
                            "-ms-flex-order": newSlideOrderIndex,
                            "-webkit-order": newSlideOrderIndex,
                            order: newSlideOrderIndex
                        });
                    } else {
                        slidesPerRow = slidesNumberEvenToRows / slidesPerColumn;
                        row = Math.floor(i / slidesPerRow);
                        column = i - row * slidesPerRow;
                    }
                    slide.css({
                        "margin-top": row !== 0 && s.params.spaceBetween && s.params.spaceBetween + "px"
                    }).attr("data-swiper-column", column).attr("data-swiper-row", row);
                }
                if (slide.css("display") === "none") continue;
                if (s.params.slidesPerView === "auto") {
                    slideSize = isH() ? slide.outerWidth(true) : slide.outerHeight(true);
                } else {
                    slideSize = (s.size - (s.params.slidesPerView - 1) * spaceBetween) / s.params.slidesPerView;
                    if (isH()) {
                        s.slides[i].style.width = slideSize + "px";
                    } else {
                        s.slides[i].style.height = slideSize + "px";
                    }
                }
                s.slides[i].swiperSlideSize = slideSize;
                s.slidesSizesGrid.push(slideSize);
                if (s.params.centeredSlides) {
                    slidePosition = slidePosition + slideSize / 2 + prevSlideSize / 2 + spaceBetween;
                    if (i === 0) slidePosition = slidePosition - s.size / 2 - spaceBetween;
                    if (Math.abs(slidePosition) < 1 / 1e3) slidePosition = 0;
                    if (index % s.params.slidesPerGroup === 0) s.snapGrid.push(slidePosition);
                    s.slidesGrid.push(slidePosition);
                } else {
                    if (index % s.params.slidesPerGroup === 0) s.snapGrid.push(slidePosition);
                    s.slidesGrid.push(slidePosition);
                    slidePosition = slidePosition + slideSize + spaceBetween;
                }
                s.virtualWidth += slideSize + spaceBetween;
                prevSlideSize = slideSize;
                index++;
            }
            s.virtualWidth = Math.max(s.virtualWidth, s.size);
            var newSlidesGrid;
            if (s.rtl && s.wrongRTL && (s.params.effect === "slide" || s.params.effect === "coverflow")) {
                s.wrapper.css({
                    width: s.virtualWidth + s.params.spaceBetween + "px"
                });
            }
            if (s.params.slidesPerColumn > 1) {
                s.virtualWidth = (slideSize + s.params.spaceBetween) * slidesNumberEvenToRows;
                s.virtualWidth = Math.ceil(s.virtualWidth / s.params.slidesPerColumn) - s.params.spaceBetween;
                s.wrapper.css({
                    width: s.virtualWidth + s.params.spaceBetween + "px"
                });
                if (s.params.centeredSlides) {
                    newSlidesGrid = [];
                    for (i = 0; i < s.snapGrid.length; i++) {
                        if (s.snapGrid[i] < s.virtualWidth + s.snapGrid[0]) newSlidesGrid.push(s.snapGrid[i]);
                    }
                    s.snapGrid = newSlidesGrid;
                }
            }
            if (!s.params.centeredSlides) {
                newSlidesGrid = [];
                for (i = 0; i < s.snapGrid.length; i++) {
                    if (s.snapGrid[i] <= s.virtualWidth - s.size) {
                        newSlidesGrid.push(s.snapGrid[i]);
                    }
                }
                s.snapGrid = newSlidesGrid;
                if (Math.floor(s.virtualWidth - s.size) > Math.floor(s.snapGrid[s.snapGrid.length - 1])) {
                    s.snapGrid.push(s.virtualWidth - s.size);
                }
            }
            if (s.snapGrid.length === 0) s.snapGrid = [ 0 ];
            if (s.params.spaceBetween !== 0) {
                if (isH()) {
                    if (s.rtl) s.slides.css({
                        marginLeft: spaceBetween + "px"
                    }); else s.slides.css({
                        marginRight: spaceBetween + "px"
                    });
                } else s.slides.css({
                    marginBottom: spaceBetween + "px"
                });
            }
            if (s.params.watchSlidesProgress) {
                s.updateSlidesOffset();
            }
        };
        s.updateSlidesOffset = function() {
            for (var i = 0; i < s.slides.length; i++) {
                s.slides[i].swiperSlideOffset = isH() ? s.slides[i].offsetLeft : s.slides[i].offsetTop;
            }
        };
        s.updateSlidesProgress = function(translate) {
            if (typeof translate === "undefined") {
                translate = s.translate || 0;
            }
            if (s.slides.length === 0) return;
            if (typeof s.slides[0].swiperSlideOffset === "undefined") s.updateSlidesOffset();
            var offsetCenter = s.params.centeredSlides ? -translate + s.size / 2 : -translate;
            if (s.rtl) offsetCenter = s.params.centeredSlides ? translate - s.size / 2 : translate;
            var containerBox = s.container[0].getBoundingClientRect();
            var sideBefore = isH() ? "left" : "top";
            var sideAfter = isH() ? "right" : "bottom";
            s.slides.removeClass(s.params.slideVisibleClass);
            for (var i = 0; i < s.slides.length; i++) {
                var slide = s.slides[i];
                var slideCenterOffset = s.params.centeredSlides === true ? slide.swiperSlideSize / 2 : 0;
                var slideProgress = (offsetCenter - slide.swiperSlideOffset - slideCenterOffset) / (slide.swiperSlideSize + s.params.spaceBetween);
                if (s.params.watchSlidesVisibility) {
                    var slideBefore = -(offsetCenter - slide.swiperSlideOffset - slideCenterOffset);
                    var slideAfter = slideBefore + s.slidesSizesGrid[i];
                    var isVisible = slideBefore >= 0 && slideBefore < s.size || slideAfter > 0 && slideAfter <= s.size || slideBefore <= 0 && slideAfter >= s.size;
                    if (isVisible) {
                        s.slides.eq(i).addClass(s.params.slideVisibleClass);
                    }
                }
                slide.progress = s.rtl ? -slideProgress : slideProgress;
            }
        };
        s.updateProgress = function(translate) {
            if (typeof translate === "undefined") {
                translate = s.translate || 0;
            }
            var translatesDiff = s.maxTranslate() - s.minTranslate();
            if (translatesDiff === 0) {
                s.progress = 0;
                s.isBeginning = s.isEnd = true;
            } else {
                s.progress = (translate - s.minTranslate()) / translatesDiff;
                s.isBeginning = s.progress <= 0;
                s.isEnd = s.progress >= 1;
            }
            if (s.isBeginning && s.params.onReachBeginning) s.params.onReachBeginning(s);
            if (s.isEnd && s.params.onReachEnd) s.params.onReachEnd(s);
            if (s.params.watchSlidesProgress) s.updateSlidesProgress(translate);
            if (s.params.onProgress) s.params.onProgress(s, s.progress);
        };
        s.updateActiveIndex = function() {
            var translate = s.rtl ? s.translate : -s.translate;
            var newActiveIndex, i, snapIndex;
            for (i = 0; i < s.slidesGrid.length; i++) {
                if (typeof s.slidesGrid[i + 1] !== "undefined") {
                    if (translate >= s.slidesGrid[i] && translate < s.slidesGrid[i + 1] - (s.slidesGrid[i + 1] - s.slidesGrid[i]) / 2) {
                        newActiveIndex = i;
                    } else if (translate >= s.slidesGrid[i] && translate < s.slidesGrid[i + 1]) {
                        newActiveIndex = i + 1;
                    }
                } else {
                    if (translate >= s.slidesGrid[i]) {
                        newActiveIndex = i;
                    }
                }
            }
            if (newActiveIndex < 0 || typeof newActiveIndex === "undefined") newActiveIndex = 0;
            snapIndex = Math.floor(newActiveIndex / s.params.slidesPerGroup);
            if (snapIndex >= s.snapGrid.length) snapIndex = s.snapGrid.length - 1;
            if (newActiveIndex === s.activeIndex) {
                return;
            }
            s.snapIndex = snapIndex;
            s.previousIndex = s.activeIndex;
            s.activeIndex = newActiveIndex;
            s.updateClasses();
        };
        s.updateClasses = function() {
            s.slides.removeClass(s.params.slideActiveClass + " " + s.params.slideNextClass + " " + s.params.slidePrevClass);
            var activeSlide = s.slides.eq(s.activeIndex);
            activeSlide.addClass(s.params.slideActiveClass);
            activeSlide.next("." + s.params.slideClass).addClass(s.params.slideNextClass);
            activeSlide.prev("." + s.params.slideClass).addClass(s.params.slidePrevClass);
            if (s.bullets && s.bullets.length > 0) {
                s.bullets.removeClass(s.params.bulletActiveClass);
                var bulletIndex;
                if (s.params.loop) {
                    bulletIndex = s.activeIndex - s.loopedSlides;
                    if (bulletIndex > s.slides.length - 1 - s.loopedSlides * 2) {
                        bulletIndex = bulletIndex - (s.slides.length - s.loopedSlides * 2);
                    }
                } else {
                    if (typeof s.snapIndex !== "undefined") {
                        bulletIndex = s.snapIndex;
                    } else {
                        bulletIndex = s.activeIndex || 0;
                    }
                }
                s.bullets.eq(bulletIndex).addClass(s.params.bulletActiveClass);
            }
            if (!s.params.loop) {
                if (s.params.prevButton) {
                    if (s.isBeginning) $(s.params.prevButton).addClass(s.params.buttonDisabledClass); else $(s.params.prevButton).removeClass(s.params.buttonDisabledClass);
                }
                if (s.params.nextButton) {
                    if (s.isEnd) $(s.params.nextButton).addClass(s.params.buttonDisabledClass); else $(s.params.nextButton).removeClass(s.params.buttonDisabledClass);
                }
            }
        };
        s.updatePagination = function() {
            if (!s.params.pagination) return;
            if (s.paginationContainer && s.paginationContainer.length > 0) {
                var bulletsHTML = "";
                var numberOfBullets = s.params.loop ? s.slides.length - s.loopedSlides * 2 : s.snapGrid.length;
                for (var i = 0; i < numberOfBullets; i++) {
                    if (s.params.paginationBulletRender) {
                        bulletsHTML += s.params.paginationBulletRender(i, s.params.bulletClass);
                    } else {
                        bulletsHTML += '<span class="' + s.params.bulletClass + '"></span>';
                    }
                }
                s.paginationContainer.html(bulletsHTML);
                s.bullets = s.paginationContainer.find("." + s.params.bulletClass);
            }
        };
        s.update = function(updateTranslate) {
            s.updateContainerSize();
            s.updateSlidesSize();
            s.updateProgress();
            s.updatePagination();
            s.updateClasses();
            if (s.params.scrollbar && s.scrollbar) {
                s.scrollbar.set();
            }
            function forceSetTranslate() {
                newTranslate = Math.min(Math.max(s.translate, s.maxTranslate()), s.minTranslate());
                s.setWrapperTranslate(newTranslate);
                s.updateActiveIndex();
                s.updateClasses();
            }
            if (updateTranslate) {
                var translated, newTranslate;
                if (s.params.freeMode) {
                    forceSetTranslate();
                } else {
                    if (s.params.slidesPerView === "auto" && s.isEnd && !s.params.centeredSlides) {
                        translated = s.slideTo(s.slides.length - 1, 0, false, true);
                    } else {
                        translated = s.slideTo(s.activeIndex, 0, false, true);
                    }
                    if (!translated) {
                        forceSetTranslate();
                    }
                }
            }
        };
        s.onResize = function() {
            s.updateContainerSize();
            s.updateSlidesSize();
            s.updateProgress();
            if (s.params.slidesPerView === "auto" || s.params.freeMode) s.updatePagination();
            if (s.params.scrollbar && s.scrollbar) {
                s.scrollbar.set();
            }
            if (s.params.freeMode) {
                var newTranslate = Math.min(Math.max(s.translate, s.maxTranslate()), s.minTranslate());
                s.setWrapperTranslate(newTranslate);
                s.updateActiveIndex();
                s.updateClasses();
            } else {
                s.updateClasses();
                if (s.params.slidesPerView === "auto" && s.isEnd && !s.params.centeredSlides) {
                    s.slideTo(s.slides.length - 1, 0, false, true);
                } else {
                    s.slideTo(s.activeIndex, 0, false, true);
                }
            }
        };
        var desktopEvents = [ "mousedown", "mousemove", "mouseup" ];
        if (window.navigator.pointerEnabled) desktopEvents = [ "pointerdown", "pointermove", "pointerup" ]; else if (window.navigator.msPointerEnabled) desktopEvents = [ "MSPointerDown", "MSPointerMove", "MSPointerUp" ];
        s.touchEvents = {
            start: s.support.touch || !s.params.simulateTouch ? "touchstart" : desktopEvents[0],
            move: s.support.touch || !s.params.simulateTouch ? "touchmove" : desktopEvents[1],
            end: s.support.touch || !s.params.simulateTouch ? "touchend" : desktopEvents[2]
        };
        if (window.navigator.pointerEnabled || window.navigator.msPointerEnabled) {
            (s.params.touchEventsTarget === "container" ? s.container : s.wrapper).addClass("swiper-wp8-" + s.params.direction);
        }
        s.events = function(detach) {
            var actionDom = detach ? "off" : "on";
            var action = detach ? "removeEventListener" : "addEventListener";
            var touchEventsTarget = s.params.touchEventsTarget === "container" ? s.container[0] : s.wrapper[0];
            var target = s.support.touch ? touchEventsTarget : document;
            var moveCapture = s.params.nested ? true : false;
            if (s.browser.ie) {
                touchEventsTarget[action](s.touchEvents.start, s.onTouchStart, false);
                target[action](s.touchEvents.move, s.onTouchMove, moveCapture);
                target[action](s.touchEvents.end, s.onTouchEnd, false);
            } else {
                if (s.support.touch) {
                    touchEventsTarget[action](s.touchEvents.start, s.onTouchStart, false);
                    touchEventsTarget[action](s.touchEvents.move, s.onTouchMove, moveCapture);
                    touchEventsTarget[action](s.touchEvents.end, s.onTouchEnd, false);
                }
                if (params.simulateTouch && !s.device.ios && !s.device.android) {
                    touchEventsTarget[action]("mousedown", s.onTouchStart, false);
                    target[action]("mousemove", s.onTouchMove, moveCapture);
                    target[action]("mouseup", s.onTouchEnd, false);
                }
            }
            window[action]("resize", s.onResize);
            if (s.params.nextButton) $(s.params.nextButton)[actionDom]("click", s.onClickNext);
            if (s.params.prevButton) $(s.params.prevButton)[actionDom]("click", s.onClickPrev);
            if (s.params.pagination && s.params.paginationClickable) {
                $(s.paginationContainer)[actionDom]("click", "." + s.params.bulletClass, s.onClickIndex);
            }
            if (s.params.preventClicks || s.params.preventClicksPropagation) touchEventsTarget[action]("click", s.preventClicks, true);
        };
        s.attachEvents = function(detach) {
            s.events();
        };
        s.detachEvents = function() {
            s.events(true);
        };
        s.allowClick = true;
        s.preventClicks = function(e) {
            if (!s.allowClick) {
                if (s.params.preventClicks) e.preventDefault();
                if (s.params.preventClicksPropagation) {
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                }
            }
        };
        s.onClickNext = function(e) {
            e.preventDefault();
            s.slideNext();
        };
        s.onClickPrev = function(e) {
            e.preventDefault();
            s.slidePrev();
        };
        s.onClickIndex = function(e) {
            e.preventDefault();
            var index = $(this).index() * s.params.slidesPerGroup;
            if (s.params.loop) index = index + s.loopedSlides;
            s.slideTo(index);
        };
        function findElementInEvent(e, selector) {
            var el = $(e.target);
            if (!el.is(selector)) {
                if (typeof selector === "string") {
                    el = el.parents(selector);
                } else if (selector.nodeType) {
                    var found;
                    el.parents().each(function(index, _el) {
                        if (_el === selector) found = selector;
                    });
                    if (!found) return undefined; else return selector;
                }
            }
            if (el.length === 0) {
                return undefined;
            }
            return el[0];
        }
        s.updateClickedSlide = function(e) {
            var slide = findElementInEvent(e, "." + s.params.slideClass);
            if (slide) {
                s.clickedSlide = slide;
                s.clickedIndex = $(slide).index();
            } else {
                s.clickedSlide = undefined;
                s.clickedIndex = undefined;
                return;
            }
            if (s.params.slideToClickedSlide && s.clickedIndex !== undefined && s.clickedIndex !== s.activeIndex) {
                var slideToIndex = s.clickedIndex, realIndex;
                if (s.params.loop) {
                    realIndex = $(s.clickedSlide).attr("data-swiper-slide-index");
                    if (slideToIndex > s.slides.length - s.params.slidesPerView) {
                        s.fixLoop();
                        slideToIndex = s.wrapper.children("." + s.params.slideClass + '[data-swiper-slide-index="' + realIndex + '"]').eq(0).index();
                        setTimeout(function() {
                            s.slideTo(slideToIndex);
                        }, 0);
                    } else if (slideToIndex < s.params.slidesPerView - 1) {
                        s.fixLoop();
                        var duplicatedSlides = s.wrapper.children("." + s.params.slideClass + '[data-swiper-slide-index="' + realIndex + '"]');
                        slideToIndex = duplicatedSlides.eq(duplicatedSlides.length - 1).index();
                        setTimeout(function() {
                            s.slideTo(slideToIndex);
                        }, 0);
                    } else {
                        s.slideTo(slideToIndex);
                    }
                } else {
                    s.slideTo(slideToIndex);
                }
            }
        };
        var isTouched, isMoved, touchStartTime, isScrolling, currentTranslate, startTranslate, allowThresholdMove, formElements = "input, select, textarea, button", lastClickTime = Date.now(), clickTimeout, velocities = [], allowMomentumBounce;
        s.animating = false;
        s.touches = {
            startX: 0,
            startY: 0,
            currentX: 0,
            currentY: 0,
            diff: 0
        };
        var isTouchEvent;
        s.onTouchStart = function(e) {
            if (e.originalEvent) e = e.originalEvent;
            isTouchEvent = e.type === "touchstart";
            if (!isTouchEvent && "which" in e && e.which === 3) return;
            if (s.params.noSwiping && findElementInEvent(e, "." + s.params.noSwipingClass)) {
                s.allowClick = true;
                return;
            }
            if (s.params.swipeHandler) {
                if (!findElementInEvent(e, s.params.swipeHandler)) return;
            }
            isTouched = true;
            isMoved = false;
            isScrolling = undefined;
            s.touches.startX = s.touches.currentX = e.type === "touchstart" ? e.targetTouches[0].pageX : e.pageX;
            s.touches.startY = s.touches.currentY = e.type === "touchstart" ? e.targetTouches[0].pageY : e.pageY;
            touchStartTime = Date.now();
            s.allowClick = true;
            s.updateContainerSize();
            s.swipeDirection = undefined;
            if (s.params.threshold > 0) allowThresholdMove = false;
            if (e.type !== "touchstart") {
                var preventDefault = true;
                if ($(e.target).is(formElements)) preventDefault = false;
                if (document.activeElement && $(document.activeElement).is(formElements)) {
                    document.activeElement.blur();
                }
                if (preventDefault) {
                    e.preventDefault();
                }
            }
            if (s.params.onTouchStart) s.params.onTouchStart(s, e);
        };
        s.onTouchMove = function(e) {
            if (e.originalEvent) e = e.originalEvent;
            if (isTouchEvent && e.type === "mousemove") return;
            if (e.preventedByNestedSwiper) return;
            if (s.params.onlyExternal) {
                isMoved = true;
                s.allowClick = false;
                return;
            }
            if (isTouchEvent && document.activeElement) {
                if (e.target === document.activeElement && $(e.target).is(formElements)) {
                    isMoved = true;
                    s.allowClick = false;
                    return;
                }
            }
            if (s.params.onTouchMove) s.params.onTouchMove(s, e);
            s.allowClick = false;
            if (e.targetTouches && e.targetTouches.length > 1) return;
            s.touches.currentX = e.type === "touchmove" ? e.targetTouches[0].pageX : e.pageX;
            s.touches.currentY = e.type === "touchmove" ? e.targetTouches[0].pageY : e.pageY;
            if (typeof isScrolling === "undefined") {
                var touchAngle = Math.atan2(Math.abs(s.touches.currentY - s.touches.startY), Math.abs(s.touches.currentX - s.touches.startX)) * 180 / Math.PI;
                isScrolling = isH() ? touchAngle > s.params.touchAngle : 90 - touchAngle > s.params.touchAngle;
            }
            if (isScrolling && s.params.onTouchMoveOpposite) {
                s.params.onTouchMoveOpposite(s, e);
            }
            if (!isTouched) return;
            if (isScrolling) {
                isTouched = false;
                return;
            }
            if (s.params.onSliderMove) s.params.onSliderMove(s, e);
            e.preventDefault();
            if (s.params.touchMoveStopPropagation && !s.params.nested) {
                e.stopPropagation();
            }
            if (!isMoved) {
                if (params.loop) {
                    s.fixLoop();
                }
                startTranslate = s.params.effect === "cube" ? (s.rtl ? -s.translate : s.translate) || 0 : s.getWrapperTranslate();
                s.setWrapperTransition(0);
                if (s.animating) {
                    s.wrapper.trigger("webkitTransitionEnd transitionend oTransitionEnd MSTransitionEnd msTransitionEnd");
                }
                if (s.params.autoplay && s.autoplaying) {
                    if (s.params.autoplayDisableOnInteraction) {
                        s.stopAutoplay();
                    } else {
                        s.pauseAutoplay();
                    }
                }
                allowMomentumBounce = false;
                if (s.params.grabCursor) {
                    s.container[0].style.cursor = "move";
                    s.container[0].style.cursor = "-webkit-grabbing";
                    s.container[0].style.cursor = "-moz-grabbin";
                    s.container[0].style.cursor = "grabbing";
                }
            }
            isMoved = true;
            var diff = s.touches.diff = isH() ? s.touches.currentX - s.touches.startX : s.touches.currentY - s.touches.startY;
            diff = diff * s.params.touchRatio;
            if (s.rtl) diff = -diff;
            s.swipeDirection = diff > 0 ? "prev" : "next";
            currentTranslate = diff + startTranslate;
            var disableParentSwiper = true;
            if (diff > 0 && currentTranslate > s.minTranslate()) {
                disableParentSwiper = false;
                if (s.params.resistance) currentTranslate = s.minTranslate() - 1 + Math.pow(-s.minTranslate() + startTranslate + diff, s.params.resistanceRatio);
            } else if (diff < 0 && currentTranslate < s.maxTranslate()) {
                disableParentSwiper = false;
                if (s.params.resistance) currentTranslate = s.maxTranslate() + 1 - Math.pow(s.maxTranslate() - startTranslate - diff, s.params.resistanceRatio);
            }
            if (disableParentSwiper) {
                e.preventedByNestedSwiper = true;
            }
            if (!s.params.allowSwipeToNext && s.swipeDirection === "next" && currentTranslate < startTranslate) {
                currentTranslate = startTranslate;
            }
            if (!s.params.allowSwipeToPrev && s.swipeDirection === "prev" && currentTranslate > startTranslate) {
                currentTranslate = startTranslate;
            }
            if (!s.params.followFinger) return;
            if (s.params.threshold > 0) {
                if (Math.abs(diff) > s.params.threshold || allowThresholdMove) {
                    if (!allowThresholdMove) {
                        allowThresholdMove = true;
                        s.touches.startX = s.touches.currentX;
                        s.touches.startY = s.touches.currentY;
                        currentTranslate = startTranslate;
                        s.touches.diff = isH() ? s.touches.currentX - s.touches.startX : s.touches.currentY - s.touches.startY;
                        return;
                    }
                } else {
                    currentTranslate = startTranslate;
                    return;
                }
            }
            if (s.params.freeMode || s.params.watchSlidesProgress) {
                s.updateActiveIndex();
            }
            if (s.params.freeMode) {
                if (velocities.length === 0) {
                    velocities.push({
                        position: s.touches[isH() ? "startX" : "startY"],
                        time: touchStartTime
                    });
                }
                velocities.push({
                    position: s.touches[isH() ? "currentX" : "currentY"],
                    time: new Date().getTime()
                });
            }
            s.updateProgress(currentTranslate);
            s.setWrapperTranslate(currentTranslate);
        };
        s.onTouchEnd = function(e) {
            if (e.originalEvent) e = e.originalEvent;
            if (s.params.onTouchEnd) s.params.onTouchEnd(s, e);
            if (!isTouched) return;
            if (s.params.grabCursor && isMoved && isTouched) {
                s.container[0].style.cursor = "move";
                s.container[0].style.cursor = "-webkit-grab";
                s.container[0].style.cursor = "-moz-grab";
                s.container[0].style.cursor = "grab";
            }
            var touchEndTime = Date.now();
            var timeDiff = touchEndTime - touchStartTime;
            if (s.allowClick) {
                s.updateClickedSlide(e);
                if (s.params.onTap) s.params.onTap(s, e);
                if (timeDiff < 300 && touchEndTime - lastClickTime > 300) {
                    if (clickTimeout) clearTimeout(clickTimeout);
                    clickTimeout = setTimeout(function() {
                        if (!s) return;
                        if (s.params.paginationHide && s.paginationContainer.length > 0 && !$(e.target).hasClass(s.params.bulletClass)) {
                            s.paginationContainer.toggleClass(s.params.paginationHiddenClass);
                        }
                        if (s.params.onClick) s.params.onClick(s, e);
                    }, 300);
                }
                if (timeDiff < 300 && touchEndTime - lastClickTime < 300) {
                    if (clickTimeout) clearTimeout(clickTimeout);
                    if (s.params.onDoubleTap) {
                        s.params.onDoubleTap(s, e);
                    }
                }
            }
            lastClickTime = Date.now();
            setTimeout(function() {
                if (s && s.allowClick) s.allowClick = true;
            }, 0);
            if (!isTouched || !isMoved || !s.swipeDirection || s.touches.diff === 0 || currentTranslate === startTranslate) {
                isTouched = isMoved = false;
                return;
            }
            isTouched = isMoved = false;
            var currentPos;
            if (s.params.followFinger) {
                currentPos = s.rtl ? s.translate : -s.translate;
            } else {
                currentPos = -currentTranslate;
            }
            if (s.params.freeMode) {
                if (currentPos < -s.minTranslate()) {
                    s.slideTo(s.activeIndex);
                    return;
                } else if (currentPos > -s.maxTranslate()) {
                    s.slideTo(s.slides.length - 1);
                    return;
                }
                if (s.params.freeModeMomentum) {
                    if (velocities.length > 1) {
                        var lastMoveEvent = velocities.pop(), velocityEvent = velocities.pop();
                        var distance = lastMoveEvent.position - velocityEvent.position;
                        var time = lastMoveEvent.time - velocityEvent.time;
                        s.velocity = distance / time;
                        s.velocity = s.velocity / 2;
                        if (Math.abs(s.velocity) < .02) {
                            s.velocity = 0;
                        }
                        if (time > 150 || new Date().getTime() - lastMoveEvent.time > 300) {
                            s.velocity = 0;
                        }
                    } else {
                        s.velocity = 0;
                    }
                    velocities.length = 0;
                    var momentumDuration = 1e3 * s.params.freeModeMomentumRatio;
                    var momentumDistance = s.velocity * momentumDuration;
                    var newPosition = s.translate + momentumDistance;
                    if (s.rtl) newPosition = -newPosition;
                    var doBounce = false;
                    var afterBouncePosition;
                    var bounceAmount = Math.abs(s.velocity) * 20 * s.params.freeModeMomentumBounceRatio;
                    if (newPosition < s.maxTranslate()) {
                        if (s.params.freeModeMomentumBounce) {
                            if (newPosition + s.maxTranslate() < -bounceAmount) {
                                newPosition = s.maxTranslate() - bounceAmount;
                            }
                            afterBouncePosition = s.maxTranslate();
                            doBounce = true;
                            allowMomentumBounce = true;
                        } else {
                            newPosition = s.maxTranslate();
                        }
                    }
                    if (newPosition > s.minTranslate()) {
                        if (s.params.freeModeMomentumBounce) {
                            if (newPosition - s.minTranslate() > bounceAmount) {
                                newPosition = s.minTranslate() + bounceAmount;
                            }
                            afterBouncePosition = s.minTranslate();
                            doBounce = true;
                            allowMomentumBounce = true;
                        } else {
                            newPosition = s.minTranslate();
                        }
                    }
                    if (s.velocity !== 0) {
                        if (s.rtl) {
                            momentumDuration = Math.abs((-newPosition - s.translate) / s.velocity);
                        } else {
                            momentumDuration = Math.abs((newPosition - s.translate) / s.velocity);
                        }
                    }
                    if (s.params.freeModeMomentumBounce && doBounce) {
                        s.updateProgress(afterBouncePosition);
                        s.setWrapperTransition(momentumDuration);
                        s.setWrapperTranslate(newPosition);
                        s.onTransitionStart();
                        s.animating = true;
                        s.wrapper.transitionEnd(function() {
                            if (!allowMomentumBounce) return;
                            if (s.params.onMomentumBounce) s.params.onMomentumBounce(s);
                            s.setWrapperTransition(s.params.speed);
                            s.setWrapperTranslate(afterBouncePosition);
                            s.wrapper.transitionEnd(function() {
                                s.onTransitionEnd();
                            });
                        });
                    } else if (s.velocity) {
                        s.updateProgress(newPosition);
                        s.setWrapperTransition(momentumDuration);
                        s.setWrapperTranslate(newPosition);
                        s.onTransitionStart();
                        if (!s.animating) {
                            s.animating = true;
                            s.wrapper.transitionEnd(function() {
                                s.onTransitionEnd();
                            });
                        }
                    } else {
                        s.updateProgress(newPosition);
                    }
                    s.updateActiveIndex();
                }
                if (!s.params.freeModeMomentum || timeDiff >= s.params.longSwipesMs) {
                    s.updateProgress();
                    s.updateActiveIndex();
                }
                return;
            }
            var i, stopIndex = 0, groupSize = s.slidesSizesGrid[0];
            for (i = 0; i < s.slidesGrid.length; i += s.params.slidesPerGroup) {
                if (typeof s.slidesGrid[i + s.params.slidesPerGroup] !== "undefined") {
                    if (currentPos >= s.slidesGrid[i] && currentPos < s.slidesGrid[i + s.params.slidesPerGroup]) {
                        stopIndex = i;
                        groupSize = s.slidesGrid[i + s.params.slidesPerGroup] - s.slidesGrid[i];
                    }
                } else {
                    if (currentPos >= s.slidesGrid[i]) {
                        stopIndex = i;
                        groupSize = s.slidesGrid[s.slidesGrid.length - 1] - s.slidesGrid[s.slidesGrid.length - 2];
                    }
                }
            }
            var ratio = (currentPos - s.slidesGrid[stopIndex]) / groupSize;
            if (timeDiff > s.params.longSwipesMs) {
                if (!s.params.longSwipes) {
                    s.slideTo(s.activeIndex);
                    return;
                }
                if (s.swipeDirection === "next") {
                    if (ratio >= s.params.longSwipesRatio) s.slideTo(stopIndex + s.params.slidesPerGroup); else s.slideTo(stopIndex);
                }
                if (s.swipeDirection === "prev") {
                    if (ratio > 1 - s.params.longSwipesRatio) s.slideTo(stopIndex + s.params.slidesPerGroup); else s.slideTo(stopIndex);
                }
            } else {
                if (!s.params.shortSwipes) {
                    s.slideTo(s.activeIndex);
                    return;
                }
                if (s.swipeDirection === "next") {
                    s.slideTo(stopIndex + s.params.slidesPerGroup);
                }
                if (s.swipeDirection === "prev") {
                    s.slideTo(stopIndex);
                }
            }
        };
        s._slideTo = function(slideIndex, speed) {
            return s.slideTo(slideIndex, speed, true, true);
        };
        s.slideTo = function(slideIndex, speed, runCallbacks, internal) {
            if (typeof runCallbacks === "undefined") runCallbacks = true;
            if (typeof slideIndex === "undefined") slideIndex = 0;
            if (slideIndex < 0) slideIndex = 0;
            s.snapIndex = Math.floor(slideIndex / s.params.slidesPerGroup);
            if (s.snapIndex >= s.snapGrid.length) s.snapIndex = s.snapGrid.length - 1;
            var translate = -s.snapGrid[s.snapIndex];
            if (s.params.autoplay && s.autoplaying) {
                if (internal || !s.params.autoplayDisableOnInteraction) {
                    s.pauseAutoplay(speed);
                } else {
                    s.stopAutoplay();
                }
            }
            s.updateProgress(translate);
            for (var i = 0; i < s.slidesGrid.length; i++) {
                if (-translate >= s.slidesGrid[i]) {
                    slideIndex = i;
                }
            }
            if (typeof speed === "undefined") speed = s.params.speed;
            s.previousIndex = s.activeIndex || 0;
            s.activeIndex = slideIndex;
            if (translate === s.translate) {
                s.updateClasses();
                return false;
            }
            s.onTransitionStart(runCallbacks);
            var translateX = isH() ? translate : 0, translateY = isH() ? 0 : translate;
            if (speed === 0) {
                s.setWrapperTransition(0);
                s.setWrapperTranslate(translate);
                s.onTransitionEnd(runCallbacks);
            } else {
                s.setWrapperTransition(speed);
                s.setWrapperTranslate(translate);
                if (!s.animating) {
                    s.animating = true;
                    s.wrapper.transitionEnd(function() {
                        s.onTransitionEnd(runCallbacks);
                    });
                }
            }
            s.updateClasses();
            return true;
        };
        s.onTransitionStart = function(runCallbacks) {
            if (typeof runCallbacks === "undefined") runCallbacks = true;
            if (s.lazy) s.lazy.onTransitionStart();
            if (runCallbacks) {
                if (s.params.onTransitionStart) s.params.onTransitionStart(s);
                if (s.params.onSlideChangeStart && s.activeIndex !== s.previousIndex) s.params.onSlideChangeStart(s);
            }
        };
        s.onTransitionEnd = function(runCallbacks) {
            s.animating = false;
            s.setWrapperTransition(0);
            if (typeof runCallbacks === "undefined") runCallbacks = true;
            if (s.lazy) s.lazy.onTransitionEnd();
            if (runCallbacks) {
                if (s.params.onTransitionEnd) s.params.onTransitionEnd(s);
                if (s.params.onSlideChangeEnd && s.activeIndex !== s.previousIndex) s.params.onSlideChangeEnd(s);
            }
        };
        s.slideNext = function(runCallbacks, speed, internal) {
            if (s.params.loop) {
                if (s.animating) return false;
                s.fixLoop();
                var clientLeft = s.container[0].clientLeft;
                return s.slideTo(s.activeIndex + s.params.slidesPerGroup, speed, runCallbacks, internal);
            } else return s.slideTo(s.activeIndex + s.params.slidesPerGroup, speed, runCallbacks, internal);
        };
        s._slideNext = function(speed) {
            return s.slideNext(true, speed, true);
        };
        s.slidePrev = function(runCallbacks, speed, internal) {
            if (s.params.loop) {
                if (s.animating) return false;
                s.fixLoop();
                var clientLeft = s.container[0].clientLeft;
                return s.slideTo(s.activeIndex - 1, speed, runCallbacks, internal);
            } else return s.slideTo(s.activeIndex - 1, speed, runCallbacks, internal);
        };
        s._slidePrev = function(speed) {
            return s.slidePrev(true, speed, true);
        };
        s.slideReset = function(runCallbacks, speed, internal) {
            return s.slideTo(s.activeIndex, speed, runCallbacks);
        };
        s.setWrapperTransition = function(duration, byController) {
            s.wrapper.transition(duration);
            if (s.params.onSetTransition) s.params.onSetTransition(s, duration);
            if (s.params.effect !== "slide" && s.effects[s.params.effect]) {
                s.effects[s.params.effect].setTransition(duration);
            }
            if (s.params.parallax && s.parallax) {
                s.parallax.setTransition(duration);
            }
            if (s.params.scrollbar && s.scrollbar) {
                s.scrollbar.setTransition(duration);
            }
            if (s.params.control && s.controller) {
                s.controller.setTransition(duration, byController);
            }
        };
        s.setWrapperTranslate = function(translate, updateActiveIndex, byController) {
            var x = 0, y = 0, z = 0;
            if (isH()) {
                x = s.rtl ? -translate : translate;
            } else {
                y = translate;
            }
            if (s.support.transforms3d) s.wrapper.transform("translate3d(" + x + "px, " + y + "px, " + z + "px)"); else s.wrapper.transform("translate(" + x + "px, " + y + "px)");
            s.translate = isH() ? x : y;
            if (updateActiveIndex) s.updateActiveIndex();
            if (s.params.effect !== "slide" && s.effects[s.params.effect]) {
                s.effects[s.params.effect].setTranslate(s.translate);
            }
            if (s.params.parallax && s.parallax) {
                s.parallax.setTranslate(s.translate);
            }
            if (s.params.scrollbar && s.scrollbar) {
                s.scrollbar.setTranslate(s.translate);
            }
            if (s.params.control && s.controller) {
                s.controller.setTranslate(s.translate, byController);
            }
            if (s.params.hashnav && s.hashnav) {
                s.hashnav.setHash();
            }
            if (s.params.onSetTranslate) s.params.onSetTranslate(s, s.translate);
        };
        s.getTranslate = function(el, axis) {
            var matrix, curTransform, curStyle, transformMatrix;
            if (typeof axis === "undefined") {
                axis = "x";
            }
            curStyle = window.getComputedStyle(el, null);
            if (window.WebKitCSSMatrix) {
                transformMatrix = new WebKitCSSMatrix(curStyle.webkitTransform === "none" ? "" : curStyle.webkitTransform);
            } else {
                transformMatrix = curStyle.MozTransform || curStyle.OTransform || curStyle.MsTransform || curStyle.msTransform || curStyle.transform || curStyle.getPropertyValue("transform").replace("translate(", "matrix(1, 0, 0, 1,");
                matrix = transformMatrix.toString().split(",");
            }
            if (axis === "x") {
                if (window.WebKitCSSMatrix) curTransform = transformMatrix.m41; else if (matrix.length === 16) curTransform = parseFloat(matrix[12]); else curTransform = parseFloat(matrix[4]);
            }
            if (axis === "y") {
                if (window.WebKitCSSMatrix) curTransform = transformMatrix.m42; else if (matrix.length === 16) curTransform = parseFloat(matrix[13]); else curTransform = parseFloat(matrix[5]);
            }
            if (s.rtl && curTransform) curTransform = -curTransform;
            return curTransform || 0;
        };
        s.getWrapperTranslate = function(axis) {
            if (typeof axis === "undefined") {
                axis = isH() ? "x" : "y";
            }
            return s.getTranslate(s.wrapper[0], axis);
        };
        s.observers = [];
        function initObserver(target, options) {
            options = options || {};
            var ObserverFunc = window.MutationObserver || window.WebkitMutationObserver;
            var observer = new ObserverFunc(function(mutations) {
                mutations.forEach(function(mutation) {
                    s.onResize();
                    if (s.params.onObserverUpdate) s.params.onObserverUpdate(s, mutation);
                });
            });
            observer.observe(target, {
                attributes: typeof options.attributes === "undefined" ? true : options.attributes,
                childList: typeof options.childList === "undefined" ? true : options.childList,
                characterData: typeof options.characterData === "undefined" ? true : options.characterData
            });
            s.observers.push(observer);
        }
        s.initObservers = function() {
            if (s.params.observeParents) {
                var containerParents = s.container.parents();
                for (var i = 0; i < containerParents.length; i++) {
                    initObserver(containerParents[i]);
                }
            }
            initObserver(s.container[0], {
                childList: false
            });
            initObserver(s.wrapper[0], {
                attributes: false
            });
        };
        s.disconnectObservers = function() {
            for (var i = 0; i < s.observers.length; i++) {
                s.observers[i].disconnect();
            }
            s.observers = [];
        };
        s.createLoop = function() {
            s.wrapper.children("." + s.params.slideClass + "." + s.params.slideDuplicateClass).remove();
            var slides = s.wrapper.children("." + s.params.slideClass);
            s.loopedSlides = parseInt(s.params.loopedSlides || s.params.slidesPerView, 10);
            s.loopedSlides = s.loopedSlides + s.params.loopAdditionalSlides;
            if (s.loopedSlides > slides.length) {
                s.loopedSlides = slides.length;
            }
            var prependSlides = [], appendSlides = [], i;
            slides.each(function(index, el) {
                var slide = $(this);
                if (index < s.loopedSlides) appendSlides.push(el);
                if (index < slides.length && index >= slides.length - s.loopedSlides) prependSlides.push(el);
                slide.attr("data-swiper-slide-index", index);
            });
            for (i = 0; i < appendSlides.length; i++) {
                s.wrapper.append($(appendSlides[i].cloneNode(true)).addClass(s.params.slideDuplicateClass));
            }
            for (i = prependSlides.length - 1; i >= 0; i--) {
                s.wrapper.prepend($(prependSlides[i].cloneNode(true)).addClass(s.params.slideDuplicateClass));
            }
        };
        s.destroyLoop = function() {
            s.wrapper.children("." + s.params.slideClass + "." + s.params.slideDuplicateClass).remove();
        };
        s.fixLoop = function() {
            var newIndex;
            if (s.activeIndex < s.loopedSlides) {
                newIndex = s.slides.length - s.loopedSlides * 3 + s.activeIndex;
                newIndex = newIndex + s.loopedSlides;
                s.slideTo(newIndex, 0, false, true);
            } else if (s.params.slidesPerView === "auto" && s.activeIndex >= s.loopedSlides * 2 || s.activeIndex > s.slides.length - s.params.slidesPerView * 2) {
                newIndex = -s.slides.length + s.activeIndex + s.loopedSlides;
                newIndex = newIndex + s.loopedSlides;
                s.slideTo(newIndex, 0, false, true);
            }
        };
        s.appendSlide = function(slides) {
            if (s.params.loop) {
                s.destroyLoop();
            }
            if (typeof slides === "object" && slides.length) {
                for (var i = 0; i < slides.length; i++) {
                    if (slides[i]) s.wrapper.append(slides[i]);
                }
            } else {
                s.wrapper.append(slides);
            }
            if (s.params.loop) {
                s.createLoop();
            }
            if (!(s.params.observer && s.support.observer)) {
                s.update(true);
            }
        };
        s.prependSlide = function(slides) {
            if (s.params.loop) {
                s.destroyLoop();
            }
            var newActiveIndex = s.activeIndex + 1;
            if (typeof slides === "object" && slides.length) {
                for (var i = 0; i < slides.length; i++) {
                    if (slides[i]) s.wrapper.prepend(slides[i]);
                }
                newActiveIndex = s.activeIndex + slides.length;
            } else {
                s.wrapper.prepend(slides);
            }
            if (s.params.loop) {
                s.createLoop();
            }
            if (!(s.params.observer && s.support.observer)) {
                s.update(true);
            }
            s.slideTo(newActiveIndex, 0, false);
        };
        s.removeSlide = function(slidesIndexes) {
            if (s.params.loop) {
                s.destroyLoop();
            }
            var newActiveIndex = s.activeIndex, indexToRemove;
            if (typeof slidesIndexes === "object" && slidesIndexes.length) {
                for (var i = 0; i < slidesIndexes.length; i++) {
                    indexToRemove = slidesIndexes[i];
                    if (s.slides[indexToRemove]) s.slides.eq(indexToRemove).remove();
                    if (indexToRemove < newActiveIndex) newActiveIndex--;
                }
                newActiveIndex = Math.max(newActiveIndex, 0);
            } else {
                indexToRemove = slidesIndexes;
                if (s.slides[indexToRemove]) s.slides.eq(indexToRemove).remove();
                if (indexToRemove < newActiveIndex) newActiveIndex--;
                newActiveIndex = Math.max(newActiveIndex, 0);
            }
            if (!(s.params.observer && s.support.observer)) {
                s.update(true);
            }
            s.slideTo(newActiveIndex, 0, false);
        };
        s.removeAllSlides = function() {
            var slidesIndexes = [];
            for (var i = 0; i < s.slides.length; i++) {
                slidesIndexes.push(i);
            }
            s.removeSlide(slidesIndexes);
        };
        s.effects = {
            fade: {
                setTranslate: function() {
                    for (var i = 0; i < s.slides.length; i++) {
                        var slide = s.slides.eq(i);
                        var offset = slide[0].swiperSlideOffset;
                        var tx = -offset - s.translate;
                        var ty = 0;
                        if (!isH()) {
                            ty = tx;
                            tx = 0;
                        }
                        var slideOpacity = s.params.fade.crossFade ? Math.max(1 - Math.abs(slide[0].progress), 0) : 1 + Math.min(Math.max(slide[0].progress, -1), 0);
                        slide.css({
                            opacity: slideOpacity
                        }).transform("translate3d(" + tx + "px, " + ty + "px, 0px)");
                    }
                },
                setTransition: function(duration) {
                    s.slides.transition(duration);
                }
            },
            cube: {
                setTranslate: function() {
                    var wrapperRotate = 0, cubeShadow;
                    if (s.params.cube.shadow) {
                        if (isH()) {
                            cubeShadow = s.wrapper.find(".swiper-cube-shadow");
                            if (cubeShadow.length === 0) {
                                cubeShadow = $('<div class="swiper-cube-shadow"></div>');
                                s.wrapper.append(cubeShadow);
                            }
                            cubeShadow.css({
                                height: s.width + "px"
                            });
                        } else {
                            cubeShadow = s.container.find(".swiper-cube-shadow");
                            if (cubeShadow.length === 0) {
                                cubeShadow = $('<div class="swiper-cube-shadow"></div>');
                                s.container.append(cubeShadow);
                            }
                        }
                    }
                    for (var i = 0; i < s.slides.length; i++) {
                        var slide = s.slides.eq(i);
                        var slideAngle = i * 90;
                        var round = Math.floor(slideAngle / 360);
                        if (s.rtl) {
                            slideAngle = -slideAngle;
                            round = Math.floor(-slideAngle / 360);
                        }
                        var progress = Math.max(Math.min(slide[0].progress, 1), -1);
                        var tx = 0, ty = 0, tz = 0;
                        if (i % 4 === 0) {
                            tx = -round * 4 * s.size;
                            tz = 0;
                        } else if ((i - 1) % 4 === 0) {
                            tx = 0;
                            tz = -round * 4 * s.size;
                        } else if ((i - 2) % 4 === 0) {
                            tx = s.size + round * 4 * s.size;
                            tz = s.size;
                        } else if ((i - 3) % 4 === 0) {
                            tx = -s.size;
                            tz = 3 * s.size + s.size * 4 * round;
                        }
                        if (s.rtl) {
                            tx = -tx;
                        }
                        if (!isH()) {
                            ty = tx;
                            tx = 0;
                        }
                        var transform = "rotateX(" + (isH() ? 0 : -slideAngle) + "deg) rotateY(" + (isH() ? slideAngle : 0) + "deg) translate3d(" + tx + "px, " + ty + "px, " + tz + "px)";
                        if (progress <= 1 && progress > -1) {
                            wrapperRotate = i * 90 + progress * 90;
                            if (s.rtl) wrapperRotate = -i * 90 - progress * 90;
                        }
                        slide.transform(transform);
                        if (s.params.cube.slideShadows) {
                            var shadowBefore = isH() ? slide.find(".swiper-slide-shadow-left") : slide.find(".swiper-slide-shadow-top");
                            var shadowAfter = isH() ? slide.find(".swiper-slide-shadow-right") : slide.find(".swiper-slide-shadow-bottom");
                            if (shadowBefore.length === 0) {
                                shadowBefore = $('<div class="swiper-slide-shadow-' + (isH() ? "left" : "top") + '"></div>');
                                slide.append(shadowBefore);
                            }
                            if (shadowAfter.length === 0) {
                                shadowAfter = $('<div class="swiper-slide-shadow-' + (isH() ? "right" : "bottom") + '"></div>');
                                slide.append(shadowAfter);
                            }
                            var shadowOpacity = slide[0].progress;
                            if (shadowBefore.length) shadowBefore[0].style.opacity = -slide[0].progress;
                            if (shadowAfter.length) shadowAfter[0].style.opacity = slide[0].progress;
                        }
                    }
                    s.wrapper.css({
                        "-webkit-transform-origin": "50% 50% -" + s.size / 2 + "px",
                        "-moz-transform-origin": "50% 50% -" + s.size / 2 + "px",
                        "-ms-transform-origin": "50% 50% -" + s.size / 2 + "px",
                        "transform-origin": "50% 50% -" + s.size / 2 + "px"
                    });
                    if (s.params.cube.shadow) {
                        if (isH()) {
                            cubeShadow.transform("translate3d(0px, " + (s.width / 2 + s.params.cube.shadowOffset) + "px, " + -s.width / 2 + "px) rotateX(90deg) rotateZ(0deg) scale(" + s.params.cube.shadowScale + ")");
                        } else {
                            var shadowAngle = Math.abs(wrapperRotate) - Math.floor(Math.abs(wrapperRotate) / 90) * 90;
                            var multiplier = 1.5 - (Math.sin(shadowAngle * 2 * Math.PI / 360) / 2 + Math.cos(shadowAngle * 2 * Math.PI / 360) / 2);
                            var scale1 = s.params.cube.shadowScale, scale2 = s.params.cube.shadowScale / multiplier, offset = s.params.cube.shadowOffset;
                            cubeShadow.transform("scale3d(" + scale1 + ", 1, " + scale2 + ") translate3d(0px, " + (s.height / 2 + offset) + "px, " + -s.height / 2 / scale2 + "px) rotateX(-90deg)");
                        }
                    }
                    var zFactor = s.isSafari || s.isUiWebView ? -s.size / 2 : 0;
                    s.wrapper.transform("translate3d(0px,0," + zFactor + "px) rotateX(" + (isH() ? 0 : wrapperRotate) + "deg) rotateY(" + (isH() ? -wrapperRotate : 0) + "deg)");
                },
                setTransition: function(duration) {
                    s.slides.transition(duration).find(".swiper-slide-shadow-top, .swiper-slide-shadow-right, .swiper-slide-shadow-bottom, .swiper-slide-shadow-left").transition(duration);
                    if (s.params.cube.shadow && !isH()) {
                        s.container.find(".swiper-cube-shadow").transition(duration);
                    }
                }
            },
            coverflow: {
                setTranslate: function() {
                    var transform = s.translate;
                    var center = isH() ? -transform + s.width / 2 : -transform + s.height / 2;
                    var rotate = isH() ? s.params.coverflow.rotate : -s.params.coverflow.rotate;
                    var translate = s.params.coverflow.depth;
                    for (var i = 0, length = s.slides.length; i < length; i++) {
                        var slide = s.slides.eq(i);
                        var slideSize = s.slidesSizesGrid[i];
                        var slideOffset = slide[0].swiperSlideOffset;
                        var offsetMultiplier = (center - slideOffset - slideSize / 2) / slideSize * s.params.coverflow.modifier;
                        var rotateY = isH() ? rotate * offsetMultiplier : 0;
                        var rotateX = isH() ? 0 : rotate * offsetMultiplier;
                        var translateZ = -translate * Math.abs(offsetMultiplier);
                        var translateY = isH() ? 0 : s.params.coverflow.stretch * offsetMultiplier;
                        var translateX = isH() ? s.params.coverflow.stretch * offsetMultiplier : 0;
                        if (Math.abs(translateX) < .001) translateX = 0;
                        if (Math.abs(translateY) < .001) translateY = 0;
                        if (Math.abs(translateZ) < .001) translateZ = 0;
                        if (Math.abs(rotateY) < .001) rotateY = 0;
                        if (Math.abs(rotateX) < .001) rotateX = 0;
                        var slideTransform = "translate3d(" + translateX + "px," + translateY + "px," + translateZ + "px)  rotateX(" + rotateX + "deg) rotateY(" + rotateY + "deg)";
                        slide.transform(slideTransform);
                        slide[0].style.zIndex = -Math.abs(Math.round(offsetMultiplier)) + 1;
                        if (s.params.coverflow.slideShadows) {
                            var shadowBefore = isH() ? slide.find(".swiper-slide-shadow-left") : slide.find(".swiper-slide-shadow-top");
                            var shadowAfter = isH() ? slide.find(".swiper-slide-shadow-right") : slide.find(".swiper-slide-shadow-bottom");
                            if (shadowBefore.length === 0) {
                                shadowBefore = $('<div class="swiper-slide-shadow-' + (isH() ? "left" : "top") + '"></div>');
                                slide.append(shadowBefore);
                            }
                            if (shadowAfter.length === 0) {
                                shadowAfter = $('<div class="swiper-slide-shadow-' + (isH() ? "right" : "bottom") + '"></div>');
                                slide.append(shadowAfter);
                            }
                            if (shadowBefore.length) shadowBefore[0].style.opacity = offsetMultiplier > 0 ? offsetMultiplier : 0;
                            if (shadowAfter.length) shadowAfter[0].style.opacity = -offsetMultiplier > 0 ? -offsetMultiplier : 0;
                        }
                    }
                    if (window.navigator.pointerEnabled || window.navigator.msPointerEnabled) {
                        var ws = s.wrapper.style;
                        ws.perspectiveOrigin = center + "px 50%";
                    }
                },
                setTransition: function(duration) {
                    s.slides.transition(duration).find(".swiper-slide-shadow-top, .swiper-slide-shadow-right, .swiper-slide-shadow-bottom, .swiper-slide-shadow-left").transition(duration);
                }
            }
        };
        s.lazy = {
            initialImageLoaded: false,
            loadImageInSlide: function(index) {
                if (typeof index === "undefined") return;
                if (s.slides.length === 0) return;
                var slide = s.slides.eq(index);
                var img = slide.find("img.swiper-lazy:not(.swiper-lazy-loaded):not(.swiper-lazy-loading)");
                if (img.length === 0) return;
                img.each(function() {
                    var _img = $(this);
                    _img.addClass("swiper-lazy-loading");
                    var src = _img.attr("data-src");
                    s.loadImage(_img[0], src, false, function() {
                        _img.attr("src", src);
                        _img.removeAttr("data-src");
                        _img.addClass("swiper-lazy-loaded").removeClass("swiper-lazy-loading");
                        slide.find(".swiper-lazy-preloader, .preloader").remove();
                        if (s.params.onLazyImageLoaded) {
                            s.params.onLazyImageLoaded(s, slide[0], _img[0]);
                        }
                    });
                    if (s.params.onLazyImageLoad) {
                        s.params.onLazyImageLoad(s, slide[0], _img[0]);
                    }
                });
            },
            load: function() {
                if (s.params.watchSlidesVisibility) {
                    s.wrapper.children("." + s.params.slideVisibleClass).each(function() {
                        s.lazy.loadImageInSlide($(this).index());
                    });
                } else {
                    if (s.params.slidesPerView > 1) {
                        for (var i = s.activeIndex; i < s.activeIndex + s.params.slidesPerView; i++) {
                            if (s.slides[i]) s.lazy.loadImageInSlide(i);
                        }
                    } else {
                        s.lazy.loadImageInSlide(s.activeIndex);
                    }
                }
                if (s.params.lazyLoadingInPrevNext) {
                    var nextSlide = s.wrapper.children("." + s.params.slideNextClass);
                    if (nextSlide.length > 0) s.lazy.loadImageInSlide(nextSlide.index());
                    var prevSlide = s.wrapper.children("." + s.params.slidePrevClass);
                    if (prevSlide.length > 0) s.loadImageInSlide(prevSlide.index());
                }
            },
            onTransitionStart: function() {
                if (s.params.lazyLoading) {
                    if (s.params.lazyLoadingOnTransitionStart || !s.params.lazyLoadingOnTransitionStart && !s.lazy.initialImageLoaded) {
                        s.lazy.initialImageLoaded = true;
                        s.lazy.load();
                    }
                }
            },
            onTransitionEnd: function() {
                if (s.params.lazyLoading && !s.params.lazyLoadingOnTransitionStart) {
                    s.lazy.load();
                }
            }
        };
        s.scrollbar = {
            set: function() {
                if (!s.params.scrollbar) return;
                var sb = s.scrollbar;
                sb.track = $(s.params.scrollbar);
                sb.drag = sb.track.find(".swiper-scrollbar-drag");
                if (sb.drag.length === 0) {
                    sb.drag = $('<div class="swiper-scrollbar-drag"></div>');
                    sb.track.append(sb.drag);
                }
                sb.drag[0].style.width = "";
                sb.drag[0].style.height = "";
                sb.trackSize = isH() ? sb.track[0].offsetWidth : sb.track[0].offsetHeight;
                sb.divider = s.size / s.virtualWidth;
                sb.moveDivider = sb.divider * (sb.trackSize / s.size);
                sb.dragSize = sb.trackSize * sb.divider;
                if (isH()) {
                    sb.drag[0].style.width = sb.dragSize + "px";
                } else {
                    sb.drag[0].style.height = sb.dragSize + "px";
                }
                if (sb.divider >= 1) {
                    sb.track[0].style.display = "none";
                } else {
                    sb.track[0].style.display = "";
                }
                if (s.params.scrollbarHide) {
                    sb.track[0].style.opacity = 0;
                }
            },
            setTranslate: function() {
                if (!s.params.scrollbar) return;
                var diff;
                var sb = s.scrollbar;
                var translate = s.translate || 0;
                var newPos;
                var newSize = sb.dragSize;
                newPos = (sb.trackSize - sb.dragSize) * s.progress;
                if (s.rtl && isH()) {
                    newPos = -newPos;
                    if (newPos > 0) {
                        newSize = sb.dragSize - newPos;
                        newPos = 0;
                    } else if (-newPos + sb.dragSize > sb.trackSize) {
                        newSize = sb.trackSize + newPos;
                    }
                } else {
                    if (newPos < 0) {
                        newSize = sb.dragSize + newPos;
                        newPos = 0;
                    } else if (newPos + sb.dragSize > sb.trackSize) {
                        newSize = sb.trackSize - newPos;
                    }
                }
                if (isH()) {
                    sb.drag.transform("translate3d(" + newPos + "px, 0, 0)");
                    sb.drag[0].style.width = newSize + "px";
                } else {
                    sb.drag.transform("translate3d(0px, " + newPos + "px, 0)");
                    sb.drag[0].style.height = newSize + "px";
                }
                if (s.params.scrollbarHide) {
                    clearTimeout(sb.timeout);
                    sb.track[0].style.opacity = 1;
                    sb.timeout = setTimeout(function() {
                        sb.track[0].style.opacity = 0;
                        sb.track.transition(400);
                    }, 1e3);
                }
            },
            setTransition: function(duration) {
                if (!s.params.scrollbar) return;
                s.scrollbar.drag.transition(duration);
            }
        };
        s.controller = {
            setTranslate: function(translate, byController) {
                var controlled = s.params.control;
                var multiplier, controlledTranslate;
                if (s.isArray(controlled)) {
                    for (var i = 0; i < controlled.length; i++) {
                        if (controlled[i] !== byController && controlled[i] instanceof Swiper) {
                            translate = controlled[i].rtl && controlled[i].params.direction === "horizontal" ? -s.translate : s.translate;
                            multiplier = (controlled[i].maxTranslate() - controlled[i].minTranslate()) / (s.maxTranslate() - s.minTranslate());
                            controlledTranslate = (translate - s.minTranslate()) * multiplier + controlled[i].minTranslate();
                            if (s.params.controlInverse) {
                                controlledTranslate = controlled[i].maxTranslate() - controlledTranslate;
                            }
                            controlled[i].updateProgress(controlledTranslate);
                            controlled[i].setWrapperTranslate(controlledTranslate, false, s);
                            controlled[i].updateActiveIndex();
                        }
                    }
                } else if (controlled instanceof Swiper && byController !== controlled) {
                    translate = controlled.rtl && controlled.params.direction === "horizontal" ? -s.translate : s.translate;
                    multiplier = (controlled.maxTranslate() - controlled.minTranslate()) / (s.maxTranslate() - s.minTranslate());
                    controlledTranslate = (translate - s.minTranslate()) * multiplier + controlled.minTranslate();
                    if (s.params.controlInverse) {
                        controlledTranslate = controlled.maxTranslate() - controlledTranslate;
                    }
                    controlled.updateProgress(controlledTranslate);
                    controlled.setWrapperTranslate(controlledTranslate, false, s);
                    controlled.updateActiveIndex();
                }
            },
            setTransition: function(duration, byController) {
                var controlled = s.params.control;
                if (s.isArray(controlled)) {
                    for (var i = 0; i < controlled.length; i++) {
                        if (controlled[i] !== byController && controlled[i] instanceof Swiper) {
                            controlled[i].setWrapperTransition(duration, s);
                        }
                    }
                } else if (controlled instanceof Swiper && byController !== controlled) {
                    controlled.setWrapperTransition(duration, s);
                }
            }
        };
        s.hashnav = {
            init: function() {
                if (!s.params.hashnav) return;
                s.hashnav.initialized = true;
                var hash = document.location.hash.replace("#", "");
                if (!hash) return;
                var speed = 0;
                for (var i = 0, length = s.slides.length; i < length; i++) {
                    var slide = s.slides.eq(i);
                    var slideHash = slide.attr("data-hash");
                    if (slideHash === hash && !slide.hasClass(s.params.slideDuplicateClass)) {
                        var index = slide.index();
                        s.slideTo(index, speed, s.params.runCallbacksOnInit, true);
                    }
                }
            },
            setHash: function() {
                if (!s.hashnav.initialized || !s.params.hashnav) return;
                document.location.hash = s.slides.eq(s.activeIndex).attr("data-hash") || "";
            }
        };
        function handleKeyboard(e) {
            if (e.originalEvent) e = e.originalEvent;
            var kc = e.keyCode || e.charCode;
            if (e.shiftKey || e.altKey || e.ctrlKey || e.metaKey) {
                return;
            }
            if (document.activeElement && document.activeElement.nodeName && (document.activeElement.nodeName.toLowerCase() === "input" || document.activeElement.nodeName.toLowerCase() === "textarea")) {
                return;
            }
            if (kc === 37 || kc === 39 || kc === 38 || kc === 40) {
                var inView = false;
                if (s.container.parents(".swiper-slide").length > 0 && s.container.parents(".swiper-slide-active").length === 0) {
                    return;
                }
                var windowScroll = {
                    left: window.pageXOffset,
                    top: window.pageYOffset
                };
                var windowWidth = window.innerWidth;
                var windowHeight = window.innerHeight;
                var swiperOffset = s.container.offset();
                var swiperCoord = [ [ swiperOffset.left, swiperOffset.top ], [ swiperOffset.left + s.width, swiperOffset.top ], [ swiperOffset.left, swiperOffset.top + s.height ], [ swiperOffset.left + s.width, swiperOffset.top + s.height ] ];
                for (var i = 0; i < swiperCoord.length; i++) {
                    var point = swiperCoord[i];
                    if (point[0] >= windowScroll.left && point[0] <= windowScroll.left + windowWidth && point[1] >= windowScroll.top && point[1] <= windowScroll.top + windowHeight) {
                        inView = true;
                    }
                }
                if (!inView) return;
            }
            if (isH()) {
                if (kc === 37 || kc === 39) {
                    if (e.preventDefault) e.preventDefault(); else e.returnValue = false;
                }
                if (kc === 39) s.slideNext();
                if (kc === 37) s.slidePrev();
            } else {
                if (kc === 38 || kc === 40) {
                    if (e.preventDefault) e.preventDefault(); else e.returnValue = false;
                }
                if (kc === 40) s.slideNext();
                if (kc === 38) s.slidePrev();
            }
        }
        s.disableKeyboardControl = function() {
            $(document).off("keydown", handleKeyboard);
        };
        s.enableKeyboardControl = function() {
            $(document).on("keydown", handleKeyboard);
        };
        s._wheelEvent = false;
        s._lastWheelScrollTime = new Date().getTime();
        if (s.params.mousewheelControl) {
            if (document.onmousewheel !== undefined) {
                s._wheelEvent = "mousewheel";
            }
            if (!s._wheelEvent) {
                try {
                    new WheelEvent("wheel");
                    s._wheelEvent = "wheel";
                } catch (e) {}
            }
            if (!s._wheelEvent) {
                s._wheelEvent = "DOMMouseScroll";
            }
        }
        function handleMousewheel(e) {
            if (e.originalEvent) e = e.originalEvent;
            var we = s._wheelEvent;
            var delta = 0;
            if (e.detail) delta = -e.detail; else if (we === "mousewheel") {
                if (s.params.mousewheelForceToAxis) {
                    if (isH()) {
                        if (Math.abs(e.wheelDeltaX) > Math.abs(e.wheelDeltaY)) delta = e.wheelDeltaX; else return;
                    } else {
                        if (Math.abs(e.wheelDeltaY) > Math.abs(e.wheelDeltaX)) delta = e.wheelDeltaY; else return;
                    }
                } else {
                    delta = e.wheelDelta;
                }
            } else if (we === "DOMMouseScroll") delta = -e.detail; else if (we === "wheel") {
                if (s.params.mousewheelForceToAxis) {
                    if (isH()) {
                        if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) delta = -e.deltaX; else return;
                    } else {
                        if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) delta = -e.deltaY; else return;
                    }
                } else {
                    delta = Math.abs(e.deltaX) > Math.abs(e.deltaY) ? -e.deltaX : -e.deltaY;
                }
            }
            if (!s.params.freeMode) {
                if (new Date().getTime() - s._lastWheelScrollTime > 60) {
                    if (delta < 0) s.slideNext(); else s.slidePrev();
                }
                s._lastWheelScrollTime = new Date().getTime();
            } else {
                var position = s.getWrapperTranslate() + delta;
                if (position > 0) position = 0;
                if (position < s.maxTranslate()) position = s.maxTranslate();
                s.setWrapperTransition(0);
                s.setWrapperTranslate(position);
                s.updateProgress();
                s.updateActiveIndex();
                if (position === 0 || position === s.maxTranslate()) return;
            }
            if (s.params.autoplay) s.stopAutoplay();
            if (e.preventDefault) e.preventDefault(); else e.returnValue = false;
            return false;
        }
        s.disableMousewheelControl = function() {
            if (!s._wheelEvent) return false;
            s.container.off(s._wheelEvent, handleMousewheel);
            return true;
        };
        s.enableMousewheelControl = function() {
            if (!s._wheelEvent) return false;
            s.container.on(s._wheelEvent, handleMousewheel);
            return true;
        };
        function setParallaxTransform(el, progress) {
            el = $(el);
            var p, pX, pY, tX, tY;
            p = el.attr("data-swiper-parallax");
            pX = el.attr("data-swiper-parallax-x");
            pY = el.attr("data-swiper-parallax-y");
            if (!pX && !pY && p) {
                if (isH()) {
                    pX = p;
                    pY = "0";
                } else {
                    pY = p;
                    pX = "0";
                }
            } else {
                if (pX) pX = pX; else pX = "0";
                if (pY) pY = pY; else pY = "0";
            }
            if (pX.indexOf("%") >= 0) {
                pX = parseInt(pX, 10) * progress + "%";
            } else {
                pX = pX * progress + "px";
            }
            if (pY.indexOf("%") >= 0) {
                pY = parseInt(pY, 10) * progress + "%";
            } else {
                pY = pY * progress + "px";
            }
            tX = pX;
            tY = pY;
            el.transform("translate3d(" + tX + ", " + tY + ",0px)");
        }
        s.parallax = {
            setTranslate: function() {
                s.container.children("[data-swiper-parallax], [data-swiper-parallax-x], [data-swiper-parallax-y]").each(function() {
                    setParallaxTransform(this, s.progress);
                });
                s.slides.each(function() {
                    var slide = $(this);
                    slide.find("[data-swiper-parallax], [data-swiper-parallax-x], [data-swiper-parallax-y]").each(function() {
                        var progress = Math.min(Math.max(slide[0].progress, -1), 1);
                        setParallaxTransform(this, progress);
                    });
                });
            },
            setTransition: function(duration) {
                if (typeof duration === "undefined") duration = s.params.speed;
                s.container.find("[data-swiper-parallax], [data-swiper-parallax-x], [data-swiper-parallax-y]").each(function() {
                    var el = $(this);
                    var parallaxDuration = parseInt(el.attr("data-swiper-parallax-duration"), 10) || duration;
                    if (duration === 0) parallaxDuration = 0;
                    el.transition(parallaxDuration);
                });
            }
        };
        s.init = function() {
            if (s.params.loop) s.createLoop();
            s.updateContainerSize();
            s.updateSlidesSize();
            s.updatePagination();
            if (s.params.scrollbar && s.scrollbar) {
                s.scrollbar.set();
            }
            if (s.params.effect !== "slide" && s.effects[s.params.effect]) {
                if (!s.params.loop) s.updateProgress();
                s.effects[s.params.effect].setTranslate();
            }
            if (s.params.loop) {
                s.slideTo(s.params.initialSlide + s.loopedSlides, 0, s.params.runCallbacksOnInit);
            } else {
                s.slideTo(s.params.initialSlide, 0, s.params.runCallbacksOnInit);
                if (s.params.initialSlide === 0) {
                    if (s.parallax && s.params.parallax) s.parallax.setTranslate();
                    if (s.lazy && s.params.lazyLoading) s.lazy.load();
                }
            }
            s.attachEvents();
            if (s.params.observer && s.support.observer) {
                s.initObservers();
            }
            if (s.params.preloadImages && !s.params.lazyLoading) {
                s.preloadImages();
            }
            if (s.params.autoplay) {
                s.startAutoplay();
            }
            if (s.params.keyboardControl) {
                if (s.enableKeyboardControl) s.enableKeyboardControl();
            }
            if (s.params.mousewheelControl) {
                if (s.enableMousewheelControl) s.enableMousewheelControl();
            }
            if (s.params.hashnav) {
                if (s.hashnav) s.hashnav.init();
            }
            if (s.params.onInit) s.params.onInit(s);
        };
        s.destroy = function(deleteInstance) {
            s.detachEvents();
            s.disconnectObservers();
            if (s.params.keyboardControl) {
                if (s.disableKeyboardControl) s.disableKeyboardControl();
            }
            if (s.params.mousewheelControl) {
                if (s.disableMousewheelControl) s.disableMousewheelControl();
            }
            if (s.params.onDestroy) s.params.onDestroy();
            if (deleteInstance !== false) s = null;
        };
        s.init();
        return s;
    };
    Swiper.prototype = {
        isSafari: function() {
            var ua = navigator.userAgent.toLowerCase();
            return ua.indexOf("safari") >= 0 && ua.indexOf("chrome") < 0 && ua.indexOf("android") < 0;
        }(),
        isUiWebView: /(iPhone|iPod|iPad).*AppleWebKit(?!.*Safari)/i.test(navigator.userAgent),
        isArray: function(arr) {
            return Object.prototype.toString.apply(arr) === "[object Array]";
        },
        browser: {
            ie: window.navigator.pointerEnabled || window.navigator.msPointerEnabled
        },
        device: function() {
            var ua = navigator.userAgent;
            var android = ua.match(/(Android);?[\s\/]+([\d.]+)?/);
            var ipad = ua.match(/(iPad).*OS\s([\d_]+)/);
            var ipod = ua.match(/(iPod)(.*OS\s([\d_]+))?/);
            var iphone = !ipad && ua.match(/(iPhone\sOS)\s([\d_]+)/);
            return {
                ios: ipad || iphone || ipad,
                android: android
            };
        }(),
        support: {
            touch: window.Modernizr && Modernizr.touch === true || function() {
                return !!("ontouchstart" in window || window.DocumentTouch && document instanceof DocumentTouch);
            }(),
            transforms3d: window.Modernizr && Modernizr.csstransforms3d === true || function() {
                var div = document.createElement("div").style;
                return "webkitPerspective" in div || "MozPerspective" in div || "OPerspective" in div || "MsPerspective" in div || "perspective" in div;
            }(),
            flexbox: function() {
                var div = document.createElement("div").style;
                var styles = "WebkitBox msFlexbox MsFlexbox WebkitFlex MozBox flex".split(" ");
                for (var i = 0; i < styles.length; i++) {
                    if (styles[i] in div) return true;
                }
            }(),
            observer: function() {
                return "MutationObserver" in window || "WebkitMutationObserver" in window;
            }()
        }
    };
    var swiperDomPlugins = [ "jQuery", "Zepto", "Dom7" ];
    function addLibraryPlugin(lib) {
        lib.fn.swiper = function(params) {
            var firstInstance;
            lib(this).each(function() {
                var s = new Swiper(this, params);
                if (!firstInstance) firstInstance = s;
            });
            return firstInstance;
        };
    }
    for (var i = 0; i < swiperDomPlugins.length; i++) {
        if (window[swiperDomPlugins[i]]) {
            addLibraryPlugin(window[swiperDomPlugins[i]]);
        }
    }
    var domLib;
    if (typeof Dom7 === "undefined") {
        domLib = window.Dom7 || window.Zepto || window.jQuery;
    } else {
        domLib = Dom7;
    }
    if (domLib) {
        if (!("transitionEnd" in domLib.fn)) {
            domLib.fn.transitionEnd = function(callback) {
                var events = [ "webkitTransitionEnd", "transitionend", "oTransitionEnd", "MSTransitionEnd", "msTransitionEnd" ], i, j, dom = this;
                function fireCallBack(e) {
                    if (e.target !== this) return;
                    callback.call(this, e);
                    for (i = 0; i < events.length; i++) {
                        dom.off(events[i], fireCallBack);
                    }
                }
                if (callback) {
                    for (i = 0; i < events.length; i++) {
                        dom.on(events[i], fireCallBack);
                    }
                }
                return this;
            };
        }
        if (!("transform" in domLib.fn)) {
            domLib.fn.transform = function(transform) {
                for (var i = 0; i < this.length; i++) {
                    var elStyle = this[i].style;
                    elStyle.webkitTransform = elStyle.MsTransform = elStyle.msTransform = elStyle.MozTransform = elStyle.OTransform = elStyle.transform = transform;
                }
                return this;
            };
        }
        if (!("transition" in domLib.fn)) {
            domLib.fn.transition = function(duration) {
                if (typeof duration !== "string") {
                    duration = duration + "ms";
                }
                for (var i = 0; i < this.length; i++) {
                    var elStyle = this[i].style;
                    elStyle.webkitTransitionDuration = elStyle.MsTransitionDuration = elStyle.msTransitionDuration = elStyle.MozTransitionDuration = elStyle.OTransitionDuration = elStyle.transitionDuration = duration;
                }
                return this;
            };
        }
    }
})();

if (typeof module !== "undefined") {
    module.exports = Swiper;
} else if (typeof define === "function" && define.amd) {
    define([], function() {
        "use strict";
        return Swiper;
    });
}

(function($) {
    var div = document.createElement("div"), all = div.getElementsByTagName("i"), $doc = $(document.documentElement);
    div.innerHTML = "<!--[if lte IE 8]><i></i><![endif]-->";
    if (all[0]) {
        $doc.addClass("ie-lte8");
    }
    if (!("querySelector" in document) || window.blackberry && !window.WebKitPoint || window.operamini) {
        return;
    } else {
        $doc.addClass("tablesaw-enhanced");
        $(function() {
            $(document).trigger("enhance.tablesaw");
        });
    }
})(jQuery);

if (typeof Tablesaw === "undefined") {
    Tablesaw = {};
}

if (!Tablesaw.config) {
    Tablesaw.config = {};
}

(function($) {
    var pluginName = "table", classes = {
        toolbar: "tablesaw-bar"
    }, events = {
        create: "tablesawcreate",
        destroy: "tablesawdestroy",
        refresh: "tablesawrefresh"
    }, defaultMode = "stack", initSelector = "table[data-tablesaw-mode],table[data-tablesaw-sortable]";
    var Table = function(element) {
        if (!element) {
            throw new Error("Tablesaw requires an element.");
        }
        this.table = element;
        this.$table = $(element);
        this.mode = this.$table.attr("data-tablesaw-mode") || defaultMode;
        this.init();
    };
    Table.prototype.init = function() {
        if (!this.$table.attr("id")) {
            this.$table.attr("id", pluginName + "-" + Math.round(Math.random() * 1e4));
        }
        this.createToolbar();
        var colstart = this._initCells();
        this.$table.trigger(events.create, [ this, colstart ]);
    };
    Table.prototype._initCells = function() {
        var colstart, thrs = this.table.querySelectorAll("thead tr"), self = this;
        $(thrs).each(function() {
            var coltally = 0;
            $(this).children().each(function() {
                var span = parseInt(this.getAttribute("colspan"), 10), sel = ":nth-child(" + (coltally + 1) + ")";
                colstart = coltally + 1;
                if (span) {
                    for (var k = 0; k < span - 1; k++) {
                        coltally++;
                        sel += ", :nth-child(" + (coltally + 1) + ")";
                    }
                }
                this.cells = self.$table.find("tr").not($(thrs).eq(0)).not(this).children(sel);
                coltally++;
            });
        });
        return colstart;
    };
    Table.prototype.refresh = function() {
        this._initCells();
        this.$table.trigger(events.refresh);
    };
    Table.prototype.createToolbar = function() {
        var $toolbar = this.$table.prev("." + classes.toolbar);
        if (!$toolbar.length) {
            $toolbar = $("<div>").addClass(classes.toolbar).insertBefore(this.$table);
        }
        this.$toolbar = $toolbar;
        if (this.mode) {
            this.$toolbar.addClass("mode-" + this.mode);
        }
    };
    Table.prototype.destroy = function() {
        this.$table.prev("." + classes.toolbar).each(function() {
            this.className = this.className.replace(/\bmode\-\w*\b/gi, "");
        });
        var tableId = this.$table.attr("id");
        $(document).unbind("." + tableId);
        $(window).unbind("." + tableId);
        this.$table.trigger(events.destroy, [ this ]);
        this.$table.removeAttr("data-tablesaw-mode");
        this.$table.removeData(pluginName);
    };
    $.fn[pluginName] = function() {
        return this.each(function() {
            var $t = $(this);
            if ($t.data(pluginName)) {
                return;
            }
            var table = new Table(this);
            $t.data(pluginName, table);
        });
    };
    $(document).on("enhance.tablesaw", function(e) {
        $(e.target).find(initSelector)[pluginName]();
    });
})(jQuery);

(function(win, $, undefined) {
    var classes = {
        stackTable: "tablesaw-stack",
        cellLabels: "tablesaw-cell-label",
        cellContentLabels: "tablesaw-cell-content"
    };
    var data = {
        obj: "tablesaw-stack"
    };
    var attrs = {
        labelless: "data-tablesaw-no-labels",
        hideempty: "data-tablesaw-hide-empty"
    };
    var Stack = function(element) {
        this.$table = $(element);
        this.labelless = this.$table.is("[" + attrs.labelless + "]");
        this.hideempty = this.$table.is("[" + attrs.hideempty + "]");
        if (!this.labelless) {
            this.allHeaders = this.$table.find("th");
        }
        this.$table.data(data.obj, this);
    };
    Stack.prototype.init = function(colstart) {
        this.$table.addClass(classes.stackTable);
        if (this.labelless) {
            return;
        }
        var reverseHeaders = $(this.allHeaders);
        var hideempty = this.hideempty;
        reverseHeaders.each(function() {
            var $t = $(this), $cells = $(this.cells).filter(function() {
                return !$(this).parent().is("[" + attrs.labelless + "]") && (!hideempty || !$(this).is(":empty"));
            }), hierarchyClass = $cells.not(this).filter("thead th").length && " tablesaw-cell-label-top", $sortableButton = $t.find(".tablesaw-sortable-btn"), html = $sortableButton.length ? $sortableButton.html() : $t.html();
            if (html !== "") {
                if (hierarchyClass) {
                    var iteration = parseInt($(this).attr("colspan"), 10), filter = "";
                    if (iteration) {
                        filter = "td:nth-child(" + iteration + "n + " + colstart + ")";
                    }
                    $cells.filter(filter).prepend("<b class='" + classes.cellLabels + hierarchyClass + "'>" + html + "</b>");
                } else {
                    $cells.wrapInner("<span class='" + classes.cellContentLabels + "'></span>");
                    $cells.prepend("<b class='" + classes.cellLabels + "'>" + html + "</b>");
                }
            }
        });
    };
    Stack.prototype.destroy = function() {
        this.$table.removeClass(classes.stackTable);
        this.$table.find("." + classes.cellLabels).remove();
        this.$table.find("." + classes.cellContentLabels).each(function() {
            $(this).replaceWith(this.childNodes);
        });
    };
    $(document).on("tablesawcreate", function(e, Tablesaw, colstart) {
        if (Tablesaw.mode === "stack") {
            var table = new Stack(Tablesaw.table);
            table.init(colstart);
        }
    });
    $(document).on("tablesawdestroy", function(e, Tablesaw) {
        if (Tablesaw.mode === "stack") {
            $(Tablesaw.table).data(data.obj).destroy();
        }
    });
})(this, jQuery);

(function($) {
    var pluginName = "tablesawbtn", initSelector = ".btn", methods = {
        _create: function() {
            return $(this).each(function() {
                $(this).trigger("beforecreate." + pluginName)[pluginName]("_init").trigger("create." + pluginName);
            });
        },
        _init: function() {
            var oEl = $(this), sel = this.getElementsByTagName("select")[0];
            if (sel) {
                $(this).addClass("btn-select")[pluginName]("_select", sel);
            }
            return oEl;
        },
        _select: function(sel) {
            var update = function(oEl, sel) {
                var opts = $(sel).find("option"), label, el, children;
                opts.each(function() {
                    var opt = this;
                    if (opt.selected) {
                        label = document.createTextNode(opt.text);
                    }
                });
                children = oEl.childNodes;
                if (opts.length > 0) {
                    for (var i = 0, l = children.length; i < l; i++) {
                        el = children[i];
                        if (el && el.nodeType === 3) {
                            oEl.replaceChild(label, el);
                        }
                    }
                }
            };
            update(this, sel);
            $(this).bind("change refresh", function() {
                update(this, sel);
            });
        }
    };
    $.fn[pluginName] = function(arrg, a, b, c) {
        return this.each(function() {
            if (arrg && typeof arrg === "string") {
                return $.fn[pluginName].prototype[arrg].call(this, a, b, c);
            }
            if ($(this).data(pluginName + "active")) {
                return $(this);
            }
            $(this).data(pluginName + "active", true);
            $.fn[pluginName].prototype._create.call(this);
        });
    };
    $.extend($.fn[pluginName].prototype, methods);
    $(document).on("enhance", function(e) {
        $(initSelector, e.target)[pluginName]();
    });
})(jQuery);

(function(win, $, undefined) {
    var ColumnToggle = function(element) {
        this.$table = $(element);
        this.classes = {
            columnToggleTable: "tablesaw-columntoggle",
            columnBtnContain: "tablesaw-columntoggle-btnwrap tablesaw-advance",
            columnBtn: "tablesaw-columntoggle-btn tablesaw-nav-btn down",
            popup: "tablesaw-columntoggle-popup",
            priorityPrefix: "tablesaw-priority-",
            toolbar: "tablesaw-bar"
        };
        this.i18n = {
            columnBtnText: "Columns",
            columnsDialogError: "No eligible columns."
        };
        this.headers = this.$table.find("tr:first > th");
        this.$table.data("tablesaw-coltoggle", this);
    };
    ColumnToggle.prototype.init = function() {
        var tableId, id, $menuButton, $popup, $menu, $btnContain, self = this;
        this.$table.addClass(this.classes.columnToggleTable);
        tableId = this.$table.attr("id");
        id = tableId + "-popup";
        $btnContain = $("<div class='" + this.classes.columnBtnContain + "'></div>");
        $menuButton = $("<a href='#" + id + "' class='btn btn-micro " + this.classes.columnBtn + "' data-popup-link>" + "<span>" + this.i18n.columnBtnText + "</span></a>");
        $popup = $("<div class='dialog-table-coltoggle " + this.classes.popup + "' id='" + id + "'></div>");
        $menu = $("<div class='btn-group'></div>");
        var hasNonPersistentHeaders = false;
        $(this.headers).not("td").each(function() {
            var $this = $(this), priority = $this.attr("data-tablesaw-priority"), $cells = $this.add(this.cells);
            if (priority && priority !== "persist") {
                $cells.addClass(self.classes.priorityPrefix + priority);
                $("<label><input type='checkbox' checked>" + $this.text() + "</label>").appendTo($menu).children(0).data("cells", $cells);
                hasNonPersistentHeaders = true;
            }
        });
        if (!hasNonPersistentHeaders) {
            $menu.append("<label>" + this.i18n.columnsDialogError + "</label>");
        }
        $menu.appendTo($popup);
        $menu.find('input[type="checkbox"]').on("change", function(e) {
            var checked = e.target.checked;
            $(e.target).data("cells").toggleClass("tablesaw-cell-hidden", !checked).toggleClass("tablesaw-cell-visible", checked);
            self.$table.trigger("tablesawcolumns");
        });
        $menuButton.appendTo($btnContain);
        $btnContain.appendTo(this.$table.prev("." + this.classes.toolbar));
        var closeTimeout;
        function openPopup() {
            $btnContain.addClass("visible");
            $menuButton.removeClass("down").addClass("up");
            $(document).unbind("click." + tableId, closePopup);
            window.clearTimeout(closeTimeout);
            closeTimeout = window.setTimeout(function() {
                $(document).one("click." + tableId, closePopup);
            }, 15);
        }
        function closePopup(event) {
            if (event && $(event.target).closest("." + self.classes.popup).length) {
                return;
            }
            $(document).unbind("click." + tableId);
            $menuButton.removeClass("up").addClass("down");
            $btnContain.removeClass("visible");
        }
        $menuButton.on("click.tablesaw", function(event) {
            event.preventDefault();
            if (!$btnContain.is(".visible")) {
                openPopup();
            } else {
                closePopup();
            }
        });
        $popup.appendTo($btnContain);
        this.$menu = $menu;
        $(window).on("resize." + tableId, function() {
            self.refreshToggle();
        });
        this.refreshToggle();
    };
    ColumnToggle.prototype.refreshToggle = function() {
        this.$menu.find("input").each(function() {
            var $this = $(this);
            this.checked = $this.data("cells").eq(0).css("display") === "table-cell";
        });
    };
    ColumnToggle.prototype.refreshPriority = function() {
        var self = this;
        $(this.headers).not("td").each(function() {
            var $this = $(this), priority = $this.attr("data-tablesaw-priority"), $cells = $this.add(this.cells);
            if (priority && priority !== "persist") {
                $cells.addClass(self.classes.priorityPrefix + priority);
            }
        });
    };
    ColumnToggle.prototype.destroy = function() {
        this.$table.removeClass(this.classes.columnToggleTable);
        this.$table.find("th, td").each(function() {
            var $cell = $(this);
            $cell.removeClass("tablesaw-cell-hidden").removeClass("tablesaw-cell-visible");
            this.className = this.className.replace(/\bui\-table\-priority\-\d\b/g, "");
        });
    };
    $(document).on("tablesawcreate", function(e, Tablesaw) {
        if (Tablesaw.mode === "columntoggle") {
            var table = new ColumnToggle(Tablesaw.table);
            table.init();
        }
    });
    $(document).on("tablesawdestroy", function(e, Tablesaw) {
        if (Tablesaw.mode === "columntoggle") {
            $(Tablesaw.table).data("tablesaw-coltoggle").destroy();
        }
    });
})(this, jQuery);

(function(win, $, undefined) {
    $.extend(Tablesaw.config, {
        swipe: {
            horizontalThreshold: 15,
            verticalThreshold: 30
        }
    });
    var config = Tablesaw.config.swipe;
    function createSwipeTable($table) {
        var $btns = $("<div class='tablesaw-advance'></div>"), $prevBtn = $("<a href='#' class='tablesaw-nav-btn btn btn-micro left' title='Previous Column'></a>").appendTo($btns), $nextBtn = $("<a href='#' class='tablesaw-nav-btn btn btn-micro right' title='Next Column'></a>").appendTo($btns), hideBtn = "disabled", persistWidths = "tablesaw-fix-persist", $headerCells = $table.find("thead th"), $headerCellsNoPersist = $headerCells.not('[data-tablesaw-priority="persist"]'), headerWidths = [], $head = $(document.head || "head"), tableId = $table.attr("id"), isIE8 = $("html").is(".ie-lte8");
        if (!$headerCells.length) {
            throw new Error("tablesaw swipe: no header cells found. Are you using <th> inside of <thead>?");
        }
        $table.css("width", "auto");
        $headerCells.each(function() {
            headerWidths.push($(this).outerWidth());
        });
        $table.css("width", "");
        $btns.appendTo($table.prev(".tablesaw-bar"));
        $table.addClass("tablesaw-swipe");
        if (!tableId) {
            tableId = "tableswipe-" + Math.round(Math.random() * 1e4);
            $table.attr("id", tableId);
        }
        function $getCells(headerCell) {
            return $(headerCell.cells).add(headerCell);
        }
        function showColumn(headerCell) {
            $getCells(headerCell).removeClass("tablesaw-cell-hidden");
        }
        function hideColumn(headerCell) {
            $getCells(headerCell).addClass("tablesaw-cell-hidden");
        }
        function persistColumn(headerCell) {
            $getCells(headerCell).addClass("tablesaw-cell-persist");
        }
        function isPersistent(headerCell) {
            return $(headerCell).is('[data-tablesaw-priority="persist"]');
        }
        function unmaintainWidths() {
            $table.removeClass(persistWidths);
            $("#" + tableId + "-persist").remove();
        }
        function maintainWidths() {
            var prefix = "#" + tableId + ".tablesaw-swipe ", styles = [], tableWidth = $table.width();
            $headerCells.each(function(index) {
                var width;
                if (isPersistent(this)) {
                    width = $(this).outerWidth();
                    if (width < tableWidth * .75) {
                        styles.push(prefix + " .tablesaw-cell-persist:nth-child(" + (index + 1) + ") { width: " + width + "px; }");
                    }
                }
            });
            unmaintainWidths();
            $table.addClass(persistWidths);
            $head.append($("<style>" + styles.join("\n") + "</style>").attr("id", tableId + "-persist"));
        }
        function getNext() {
            var next = [], checkFound;
            $headerCellsNoPersist.each(function(i) {
                var $t = $(this), isHidden = $t.css("display") === "none" || $t.is(".tablesaw-cell-hidden");
                if (!isHidden && !checkFound) {
                    checkFound = true;
                    next[0] = i;
                } else if (isHidden && checkFound) {
                    next[1] = i;
                    return false;
                }
            });
            return next;
        }
        function getPrev() {
            var next = getNext();
            return [ next[1] - 1, next[0] - 1 ];
        }
        function nextpair(fwd) {
            return fwd ? getNext() : getPrev();
        }
        function canAdvance(pair) {
            return pair[1] > -1 && pair[1] < $headerCellsNoPersist.length;
        }
        function fakeBreakpoints() {
            var extraPaddingPixels = 20, containerWidth = $table.parent().width(), persist = [], sum = 0, sums = [], visibleNonPersistantCount = $headerCells.length;
            $headerCells.each(function(index) {
                var $t = $(this), isPersist = $t.is('[data-tablesaw-priority="persist"]');
                persist.push(isPersist);
                sum += headerWidths[index] + (isPersist ? 0 : extraPaddingPixels);
                sums.push(sum);
                if (isPersist || sum > containerWidth) {
                    visibleNonPersistantCount--;
                }
            });
            var needsNonPersistentColumn = visibleNonPersistantCount === 0;
            $headerCells.each(function(index) {
                if (persist[index]) {
                    persistColumn(this);
                    return;
                }
                if (sums[index] <= containerWidth || needsNonPersistentColumn) {
                    needsNonPersistentColumn = false;
                    showColumn(this);
                } else {
                    hideColumn(this);
                }
            });
            if (!isIE8) {
                unmaintainWidths();
            }
            $table.trigger("tablesawcolumns");
        }
        function advance(fwd) {
            var pair = nextpair(fwd);
            if (canAdvance(pair)) {
                if (isNaN(pair[0])) {
                    if (fwd) {
                        pair[0] = 0;
                    } else {
                        pair[0] = $headerCellsNoPersist.length - 1;
                    }
                }
                if (!isIE8) {
                    maintainWidths();
                }
                hideColumn($headerCellsNoPersist.get(pair[0]));
                showColumn($headerCellsNoPersist.get(pair[1]));
                $table.trigger("tablesawcolumns");
            }
        }
        $prevBtn.add($nextBtn).click(function(e) {
            advance(!!$(e.target).closest($nextBtn).length);
            e.preventDefault();
        });
        function getCoord(event, key) {
            return (event.touches || event.originalEvent.touches)[0][key];
        }
        $table.bind("touchstart.swipetoggle", function(e) {
            var originX = getCoord(e, "pageX"), originY = getCoord(e, "pageY"), x, y;
            $(this).bind("touchmove", function(e) {
                x = getCoord(e, "pageX");
                y = getCoord(e, "pageY");
                if (Math.abs(x - originX) > config.horizontalThreshold && Math.abs(y - originY) < config.verticalThreshold) {
                    e.preventDefault();
                }
            }).bind("touchend.swipetoggle", function() {
                if (x - originX < -1 * config.horizontalThreshold) {
                    advance(true);
                }
                if (x - originX > config.horizontalThreshold) {
                    advance(false);
                }
                $(this).unbind("touchmove touchend");
            });
        }).bind("tablesawcolumns.swipetoggle", function() {
            $prevBtn[canAdvance(getPrev()) ? "removeClass" : "addClass"](hideBtn);
            $nextBtn[canAdvance(getNext()) ? "removeClass" : "addClass"](hideBtn);
        }).bind("tablesawnext.swipetoggle", function() {
            advance(true);
        }).bind("tablesawprev.swipetoggle", function() {
            advance(false);
        }).bind("tablesawdestroy.swipetoggle", function() {
            var $t = $(this);
            $t.removeClass("tablesaw-swipe");
            $t.prev(".tablesaw-bar").find(".tablesaw-advance").remove();
            $(win).off("resize", fakeBreakpoints);
            $t.unbind(".swipetoggle");
        });
        fakeBreakpoints();
        $(win).on("resize", fakeBreakpoints);
    }
    $(document).on("tablesawcreate", function(e, Tablesaw) {
        if (Tablesaw.mode === "swipe") {
            createSwipeTable(Tablesaw.$table);
        }
    });
})(this, jQuery);

(function($) {
    function getSortValue(cell) {
        return $.map(cell.childNodes, function(el) {
            var $el = $(el);
            if ($el.is("input, select")) {
                return $el.val();
            } else if ($el.hasClass("tablesaw-cell-label")) {
                return;
            }
            return $.trim($el.text());
        }).join("");
    }
    var pluginName = "tablesaw-sortable", initSelector = "table[data-" + pluginName + "]", sortableSwitchSelector = "[data-" + pluginName + "-switch]", attrs = {
        defaultCol: "data-tablesaw-sortable-default-col"
    }, classes = {
        head: pluginName + "-head",
        ascend: pluginName + "-ascending",
        descend: pluginName + "-descending",
        switcher: pluginName + "-switch",
        tableToolbar: "tablesaw-toolbar",
        sortButton: pluginName + "-btn"
    }, i18n = {
        sort: "Sort"
    }, methods = {
        _create: function(o) {
            return $(this).each(function() {
                var init = $(this).data("init" + pluginName);
                if (init) {
                    return false;
                }
                $(this).data("init" + pluginName, true).trigger("beforecreate." + pluginName)[pluginName]("_init", o).trigger("create." + pluginName);
            });
        },
        _init: function() {
            var el = $(this), heads, $switcher;
            var addClassToTable = function() {
                el.addClass(pluginName);
            }, addClassToHeads = function(h) {
                $.each(h, function(i, v) {
                    $(v).addClass(classes.head);
                });
            }, makeHeadsActionable = function(h, fn) {
                $.each(h, function(i, v) {
                    var b = $("<button class='" + classes.sortButton + "'/>");
                    b.bind("click", {
                        col: v
                    }, fn);
                    $(v).wrapInner(b);
                });
            }, clearOthers = function(sibs) {
                $.each(sibs, function(i, v) {
                    var col = $(v);
                    col.removeAttr(attrs.defaultCol);
                    col.removeClass(classes.ascend);
                    col.removeClass(classes.descend);
                });
            }, headsOnAction = function(e) {
                if ($(e.target).is("a[href]")) {
                    return;
                }
                e.stopPropagation();
                var head = $(this).parent(), v = e.data.col, newSortValue = heads.index(head);
                clearOthers(head.siblings());
                if (head.hasClass(classes.descend)) {
                    el[pluginName]("sortBy", v, true);
                    newSortValue += "_asc";
                } else {
                    el[pluginName]("sortBy", v);
                    newSortValue += "_desc";
                }
                if ($switcher) {
                    $switcher.find("select").val(newSortValue).trigger("refresh");
                }
                e.preventDefault();
            }, handleDefault = function(heads) {
                $.each(heads, function(idx, el) {
                    var $el = $(el);
                    if ($el.is("[" + attrs.defaultCol + "]")) {
                        if (!$el.hasClass(classes.descend)) {
                            $el.addClass(classes.ascend);
                        }
                    }
                });
            }, addSwitcher = function(heads) {
                $switcher = $("<div>").addClass(classes.switcher).addClass(classes.tableToolbar).html(function() {
                    var html = [ "<label>" + i18n.sort + ":" ];
                    html.push('<span class="btn btn-small">&#160;<select>');
                    heads.each(function(j) {
                        var $t = $(this), isDefaultCol = $t.is("[" + attrs.defaultCol + "]"), isDescending = $t.hasClass(classes.descend), isNumeric = false;
                        $(this.cells).slice(0, 3).each(function() {
                            if (!isNaN(parseInt(getSortValue(this), 10))) {
                                isNumeric = true;
                                return false;
                            }
                        });
                        html.push("<option" + (isDefaultCol && !isDescending ? " selected" : "") + ' value="' + j + '_asc">' + $t.text() + " " + (isNumeric ? "↑" : "(A-Z)") + "</option>");
                        html.push("<option" + (isDefaultCol && isDescending ? " selected" : "") + ' value="' + j + '_desc">' + $t.text() + " " + (isNumeric ? "↓" : "(Z-A)") + "</option>");
                    });
                    html.push("</select></span></label>");
                    return html.join("");
                });
                var $toolbar = el.prev(".tablesaw-bar"), $firstChild = $toolbar.children().eq(0);
                if ($firstChild.length) {
                    $switcher.insertBefore($firstChild);
                } else {
                    $switcher.appendTo($toolbar);
                }
                $switcher.find(".btn").tablesawbtn();
                $switcher.find("select").on("change", function() {
                    var val = $(this).val().split("_"), head = heads.eq(val[0]);
                    clearOthers(head.siblings());
                    el[pluginName]("sortBy", head.get(0), val[1] === "asc");
                });
            };
            addClassToTable();
            heads = el.find("thead th[data-" + pluginName + "-col]");
            addClassToHeads(heads);
            makeHeadsActionable(heads, headsOnAction);
            handleDefault(heads);
            if (el.is(sortableSwitchSelector)) {
                addSwitcher(heads, el.find("tbody tr:nth-child(-n+3)"));
            }
        },
        getColumnNumber: function(col) {
            return $(col).prevAll().length;
        },
        getTableRows: function() {
            return $(this).find("tbody tr");
        },
        sortRows: function(rows, colNum, ascending, col) {
            var cells, fn, sorted;
            var getCells = function(rows) {
                var cells = [];
                $.each(rows, function(i, r) {
                    cells.push({
                        cell: getSortValue($(r).children().get(colNum)),
                        rowNum: i
                    });
                });
                return cells;
            }, getSortFxn = function(ascending, forceNumeric) {
                var fn, regex = /[^\-\+\d\.]/g;
                if (ascending) {
                    fn = function(a, b) {
                        if (forceNumeric || !isNaN(parseFloat(a.cell))) {
                            return parseFloat(a.cell.replace(regex, "")) - parseFloat(b.cell.replace(regex, ""));
                        } else {
                            return a.cell.toLowerCase() > b.cell.toLowerCase() ? 1 : -1;
                        }
                    };
                } else {
                    fn = function(a, b) {
                        if (forceNumeric || !isNaN(parseFloat(a.cell))) {
                            return parseFloat(b.cell.replace(regex, "")) - parseFloat(a.cell.replace(regex, ""));
                        } else {
                            return a.cell.toLowerCase() < b.cell.toLowerCase() ? 1 : -1;
                        }
                    };
                }
                return fn;
            }, applyToRows = function(sorted, rows) {
                var newRows = [], i, l, cur;
                for (i = 0, l = sorted.length; i < l; i++) {
                    cur = sorted[i].rowNum;
                    newRows.push(rows[cur]);
                }
                return newRows;
            };
            cells = getCells(rows);
            fn = getSortFxn(ascending, $(col).is("[data-sortable-numeric]"));
            sorted = cells.sort(fn);
            rows = applyToRows(sorted, rows);
            return rows;
        },
        replaceTableRows: function(rows) {
            var el = $(this), body = el.find("tbody");
            body.html(rows);
        },
        makeColDefault: function(col, a) {
            var c = $(col);
            c.attr(attrs.defaultCol, "true");
            if (a) {
                c.removeClass(classes.descend);
                c.addClass(classes.ascend);
            } else {
                c.removeClass(classes.ascend);
                c.addClass(classes.descend);
            }
        },
        sortBy: function(col, ascending) {
            var el = $(this), colNum, rows;
            colNum = el[pluginName]("getColumnNumber", col);
            rows = el[pluginName]("getTableRows");
            rows = el[pluginName]("sortRows", rows, colNum, ascending, col);
            el[pluginName]("replaceTableRows", rows);
            el[pluginName]("makeColDefault", col, ascending);
        }
    };
    $.fn[pluginName] = function(arrg) {
        var args = Array.prototype.slice.call(arguments, 1), returnVal;
        if (arrg && typeof arrg === "string") {
            returnVal = $.fn[pluginName].prototype[arrg].apply(this[0], args);
            return typeof returnVal !== "undefined" ? returnVal : $(this);
        }
        if (!$(this).data(pluginName + "data")) {
            $(this).data(pluginName + "active", true);
            $.fn[pluginName].prototype._create.call(this, arrg);
        }
        return $(this);
    };
    $.extend($.fn[pluginName].prototype, methods);
    $(document).on("tablesawcreate", function(e, Tablesaw) {
        if (Tablesaw.$table.is(initSelector)) {
            Tablesaw.$table[pluginName]();
        }
    });
})(jQuery);

(function(win, $, undefined) {
    var MM = {
        attr: {
            init: "data-tablesaw-minimap"
        }
    };
    function createMiniMap($table) {
        var $btns = $('<div class="tablesaw-advance minimap">'), $dotNav = $('<ul class="tablesaw-advance-dots">').appendTo($btns), hideDot = "tablesaw-advance-dots-hide", $headerCells = $table.find("thead th");
        $headerCells.each(function() {
            $dotNav.append("<li><i></i></li>");
        });
        $btns.appendTo($table.prev(".tablesaw-bar"));
        function showMinimap($table) {
            var mq = $table.attr(MM.attr.init);
            return !mq || win.matchMedia && win.matchMedia(mq).matches;
        }
        function showHideNav() {
            if (!showMinimap($table)) {
                $btns.hide();
                return;
            }
            $btns.show();
            var dots = $dotNav.find("li").removeClass(hideDot);
            $table.find("thead th").each(function(i) {
                if ($(this).css("display") === "none") {
                    dots.eq(i).addClass(hideDot);
                }
            });
        }
        showHideNav();
        $(win).on("resize", showHideNav);
        $table.bind("tablesawcolumns.minimap", function() {
            showHideNav();
        }).bind("tablesawdestroy.minimap", function() {
            var $t = $(this);
            $t.prev(".tablesaw-bar").find(".tablesaw-advance").remove();
            $(win).off("resize", showHideNav);
            $t.unbind(".minimap");
        });
    }
    $(document).on("tablesawcreate", function(e, Tablesaw) {
        if ((Tablesaw.mode === "swipe" || Tablesaw.mode === "columntoggle") && Tablesaw.$table.is("[ " + MM.attr.init + "]")) {
            createMiniMap(Tablesaw.$table);
        }
    });
})(this, jQuery);

(function(win, $) {
    var S = {
        selectors: {
            init: "table[data-tablesaw-mode-switch]"
        },
        attributes: {
            excludeMode: "data-tablesaw-mode-exclude"
        },
        classes: {
            main: "tablesaw-modeswitch",
            toolbar: "tablesaw-toolbar"
        },
        modes: [ "stack", "swipe", "columntoggle" ],
        i18n: {
            modes: [ "Stack", "Swipe", "Toggle" ],
            columns: 'Col<span class="a11y-sm">umn</span>s'
        },
        init: function(table) {
            var $table = $(table), ignoreMode = $table.attr(S.attributes.excludeMode), $toolbar = $table.prev(".tablesaw-bar"), modeVal = "", $switcher = $("<div>").addClass(S.classes.main + " " + S.classes.toolbar).html(function() {
                var html = [ "<label>" + S.i18n.columns + ":" ], dataMode = $table.attr("data-tablesaw-mode"), isSelected;
                html.push('<span class="btn btn-small">&#160;<select>');
                for (var j = 0, k = S.modes.length; j < k; j++) {
                    if (ignoreMode && ignoreMode.toLowerCase() === S.modes[j]) {
                        continue;
                    }
                    isSelected = dataMode === S.modes[j];
                    if (isSelected) {
                        modeVal = S.modes[j];
                    }
                    html.push("<option" + (isSelected ? " selected" : "") + ' value="' + S.modes[j] + '">' + S.i18n.modes[j] + "</option>");
                }
                html.push("</select></span></label>");
                return html.join("");
            });
            var $otherToolbarItems = $toolbar.find(".tablesaw-advance").eq(0);
            if ($otherToolbarItems.length) {
                $switcher.insertBefore($otherToolbarItems);
            } else {
                $switcher.appendTo($toolbar);
            }
            $switcher.find(".btn").tablesawbtn();
            $switcher.find("select").bind("change", S.onModeChange);
        },
        onModeChange: function() {
            var $t = $(this), $switcher = $t.closest("." + S.classes.main), $table = $t.closest(".tablesaw-bar").nextUntil($table).eq(0), val = $t.val();
            $switcher.remove();
            $table.data("table").destroy();
            $table.attr("data-tablesaw-mode", val);
            $table.table();
        }
    };
    $(win.document).on("tablesawcreate", function(e, Tablesaw) {
        if (Tablesaw.$table.is(S.selectors.init)) {
            S.init(Tablesaw.table);
        }
    });
})(this, jQuery);

(function(undefined) {
    var moment, VERSION = "2.9.0", globalScope = typeof global !== "undefined" && (typeof window === "undefined" || window === global.window) ? global : this, oldGlobalMoment, round = Math.round, hasOwnProperty = Object.prototype.hasOwnProperty, i, YEAR = 0, MONTH = 1, DATE = 2, HOUR = 3, MINUTE = 4, SECOND = 5, MILLISECOND = 6, locales = {}, momentProperties = [], hasModule = typeof module !== "undefined" && module && module.exports, aspNetJsonRegex = /^\/?Date\((\-?\d+)/i, aspNetTimeSpanJsonRegex = /(\-)?(?:(\d*)\.)?(\d+)\:(\d+)(?:\:(\d+)\.?(\d{3})?)?/, isoDurationRegex = /^(-)?P(?:(?:([0-9,.]*)Y)?(?:([0-9,.]*)M)?(?:([0-9,.]*)D)?(?:T(?:([0-9,.]*)H)?(?:([0-9,.]*)M)?(?:([0-9,.]*)S)?)?|([0-9,.]*)W)$/, formattingTokens = /(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Q|YYYYYY|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|mm?|ss?|S{1,4}|x|X|zz?|ZZ?|.)/g, localFormattingTokens = /(\[[^\[]*\])|(\\)?(LTS|LT|LL?L?L?|l{1,4})/g, parseTokenOneOrTwoDigits = /\d\d?/, parseTokenOneToThreeDigits = /\d{1,3}/, parseTokenOneToFourDigits = /\d{1,4}/, parseTokenOneToSixDigits = /[+\-]?\d{1,6}/, parseTokenDigits = /\d+/, parseTokenWord = /[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i, parseTokenTimezone = /Z|[\+\-]\d\d:?\d\d/gi, parseTokenT = /T/i, parseTokenOffsetMs = /[\+\-]?\d+/, parseTokenTimestampMs = /[\+\-]?\d+(\.\d{1,3})?/, parseTokenOneDigit = /\d/, parseTokenTwoDigits = /\d\d/, parseTokenThreeDigits = /\d{3}/, parseTokenFourDigits = /\d{4}/, parseTokenSixDigits = /[+-]?\d{6}/, parseTokenSignedNumber = /[+-]?\d+/, isoRegex = /^\s*(?:[+-]\d{6}|\d{4})-(?:(\d\d-\d\d)|(W\d\d$)|(W\d\d-\d)|(\d\d\d))((T| )(\d\d(:\d\d(:\d\d(\.\d+)?)?)?)?([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/, isoFormat = "YYYY-MM-DDTHH:mm:ssZ", isoDates = [ [ "YYYYYY-MM-DD", /[+-]\d{6}-\d{2}-\d{2}/ ], [ "YYYY-MM-DD", /\d{4}-\d{2}-\d{2}/ ], [ "GGGG-[W]WW-E", /\d{4}-W\d{2}-\d/ ], [ "GGGG-[W]WW", /\d{4}-W\d{2}/ ], [ "YYYY-DDD", /\d{4}-\d{3}/ ] ], isoTimes = [ [ "HH:mm:ss.SSSS", /(T| )\d\d:\d\d:\d\d\.\d+/ ], [ "HH:mm:ss", /(T| )\d\d:\d\d:\d\d/ ], [ "HH:mm", /(T| )\d\d:\d\d/ ], [ "HH", /(T| )\d\d/ ] ], parseTimezoneChunker = /([\+\-]|\d\d)/gi, proxyGettersAndSetters = "Date|Hours|Minutes|Seconds|Milliseconds".split("|"), unitMillisecondFactors = {
        Milliseconds: 1,
        Seconds: 1e3,
        Minutes: 6e4,
        Hours: 36e5,
        Days: 864e5,
        Months: 2592e6,
        Years: 31536e6
    }, unitAliases = {
        ms: "millisecond",
        s: "second",
        m: "minute",
        h: "hour",
        d: "day",
        D: "date",
        w: "week",
        W: "isoWeek",
        M: "month",
        Q: "quarter",
        y: "year",
        DDD: "dayOfYear",
        e: "weekday",
        E: "isoWeekday",
        gg: "weekYear",
        GG: "isoWeekYear"
    }, camelFunctions = {
        dayofyear: "dayOfYear",
        isoweekday: "isoWeekday",
        isoweek: "isoWeek",
        weekyear: "weekYear",
        isoweekyear: "isoWeekYear"
    }, formatFunctions = {}, relativeTimeThresholds = {
        s: 45,
        m: 45,
        h: 22,
        d: 26,
        M: 11
    }, ordinalizeTokens = "DDD w W M D d".split(" "), paddedTokens = "M D H h m s w W".split(" "), formatTokenFunctions = {
        M: function() {
            return this.month() + 1;
        },
        MMM: function(format) {
            return this.localeData().monthsShort(this, format);
        },
        MMMM: function(format) {
            return this.localeData().months(this, format);
        },
        D: function() {
            return this.date();
        },
        DDD: function() {
            return this.dayOfYear();
        },
        d: function() {
            return this.day();
        },
        dd: function(format) {
            return this.localeData().weekdaysMin(this, format);
        },
        ddd: function(format) {
            return this.localeData().weekdaysShort(this, format);
        },
        dddd: function(format) {
            return this.localeData().weekdays(this, format);
        },
        w: function() {
            return this.week();
        },
        W: function() {
            return this.isoWeek();
        },
        YY: function() {
            return leftZeroFill(this.year() % 100, 2);
        },
        YYYY: function() {
            return leftZeroFill(this.year(), 4);
        },
        YYYYY: function() {
            return leftZeroFill(this.year(), 5);
        },
        YYYYYY: function() {
            var y = this.year(), sign = y >= 0 ? "+" : "-";
            return sign + leftZeroFill(Math.abs(y), 6);
        },
        gg: function() {
            return leftZeroFill(this.weekYear() % 100, 2);
        },
        gggg: function() {
            return leftZeroFill(this.weekYear(), 4);
        },
        ggggg: function() {
            return leftZeroFill(this.weekYear(), 5);
        },
        GG: function() {
            return leftZeroFill(this.isoWeekYear() % 100, 2);
        },
        GGGG: function() {
            return leftZeroFill(this.isoWeekYear(), 4);
        },
        GGGGG: function() {
            return leftZeroFill(this.isoWeekYear(), 5);
        },
        e: function() {
            return this.weekday();
        },
        E: function() {
            return this.isoWeekday();
        },
        a: function() {
            return this.localeData().meridiem(this.hours(), this.minutes(), true);
        },
        A: function() {
            return this.localeData().meridiem(this.hours(), this.minutes(), false);
        },
        H: function() {
            return this.hours();
        },
        h: function() {
            return this.hours() % 12 || 12;
        },
        m: function() {
            return this.minutes();
        },
        s: function() {
            return this.seconds();
        },
        S: function() {
            return toInt(this.milliseconds() / 100);
        },
        SS: function() {
            return leftZeroFill(toInt(this.milliseconds() / 10), 2);
        },
        SSS: function() {
            return leftZeroFill(this.milliseconds(), 3);
        },
        SSSS: function() {
            return leftZeroFill(this.milliseconds(), 3);
        },
        Z: function() {
            var a = this.utcOffset(), b = "+";
            if (a < 0) {
                a = -a;
                b = "-";
            }
            return b + leftZeroFill(toInt(a / 60), 2) + ":" + leftZeroFill(toInt(a) % 60, 2);
        },
        ZZ: function() {
            var a = this.utcOffset(), b = "+";
            if (a < 0) {
                a = -a;
                b = "-";
            }
            return b + leftZeroFill(toInt(a / 60), 2) + leftZeroFill(toInt(a) % 60, 2);
        },
        z: function() {
            return this.zoneAbbr();
        },
        zz: function() {
            return this.zoneName();
        },
        x: function() {
            return this.valueOf();
        },
        X: function() {
            return this.unix();
        },
        Q: function() {
            return this.quarter();
        }
    }, deprecations = {}, lists = [ "months", "monthsShort", "weekdays", "weekdaysShort", "weekdaysMin" ], updateInProgress = false;
    function dfl(a, b, c) {
        switch (arguments.length) {
          case 2:
            return a != null ? a : b;

          case 3:
            return a != null ? a : b != null ? b : c;

          default:
            throw new Error("Implement me");
        }
    }
    function hasOwnProp(a, b) {
        return hasOwnProperty.call(a, b);
    }
    function defaultParsingFlags() {
        return {
            empty: false,
            unusedTokens: [],
            unusedInput: [],
            overflow: -2,
            charsLeftOver: 0,
            nullInput: false,
            invalidMonth: null,
            invalidFormat: false,
            userInvalidated: false,
            iso: false
        };
    }
    function printMsg(msg) {
        if (moment.suppressDeprecationWarnings === false && typeof console !== "undefined" && console.warn) {
            console.warn("Deprecation warning: " + msg);
        }
    }
    function deprecate(msg, fn) {
        var firstTime = true;
        return extend(function() {
            if (firstTime) {
                printMsg(msg);
                firstTime = false;
            }
            return fn.apply(this, arguments);
        }, fn);
    }
    function deprecateSimple(name, msg) {
        if (!deprecations[name]) {
            printMsg(msg);
            deprecations[name] = true;
        }
    }
    function padToken(func, count) {
        return function(a) {
            return leftZeroFill(func.call(this, a), count);
        };
    }
    function ordinalizeToken(func, period) {
        return function(a) {
            return this.localeData().ordinal(func.call(this, a), period);
        };
    }
    function monthDiff(a, b) {
        var wholeMonthDiff = (b.year() - a.year()) * 12 + (b.month() - a.month()), anchor = a.clone().add(wholeMonthDiff, "months"), anchor2, adjust;
        if (b - anchor < 0) {
            anchor2 = a.clone().add(wholeMonthDiff - 1, "months");
            adjust = (b - anchor) / (anchor - anchor2);
        } else {
            anchor2 = a.clone().add(wholeMonthDiff + 1, "months");
            adjust = (b - anchor) / (anchor2 - anchor);
        }
        return -(wholeMonthDiff + adjust);
    }
    while (ordinalizeTokens.length) {
        i = ordinalizeTokens.pop();
        formatTokenFunctions[i + "o"] = ordinalizeToken(formatTokenFunctions[i], i);
    }
    while (paddedTokens.length) {
        i = paddedTokens.pop();
        formatTokenFunctions[i + i] = padToken(formatTokenFunctions[i], 2);
    }
    formatTokenFunctions.DDDD = padToken(formatTokenFunctions.DDD, 3);
    function meridiemFixWrap(locale, hour, meridiem) {
        var isPm;
        if (meridiem == null) {
            return hour;
        }
        if (locale.meridiemHour != null) {
            return locale.meridiemHour(hour, meridiem);
        } else if (locale.isPM != null) {
            isPm = locale.isPM(meridiem);
            if (isPm && hour < 12) {
                hour += 12;
            }
            if (!isPm && hour === 12) {
                hour = 0;
            }
            return hour;
        } else {
            return hour;
        }
    }
    function Locale() {}
    function Moment(config, skipOverflow) {
        if (skipOverflow !== false) {
            checkOverflow(config);
        }
        copyConfig(this, config);
        this._d = new Date(+config._d);
        if (updateInProgress === false) {
            updateInProgress = true;
            moment.updateOffset(this);
            updateInProgress = false;
        }
    }
    function Duration(duration) {
        var normalizedInput = normalizeObjectUnits(duration), years = normalizedInput.year || 0, quarters = normalizedInput.quarter || 0, months = normalizedInput.month || 0, weeks = normalizedInput.week || 0, days = normalizedInput.day || 0, hours = normalizedInput.hour || 0, minutes = normalizedInput.minute || 0, seconds = normalizedInput.second || 0, milliseconds = normalizedInput.millisecond || 0;
        this._milliseconds = +milliseconds + seconds * 1e3 + minutes * 6e4 + hours * 36e5;
        this._days = +days + weeks * 7;
        this._months = +months + quarters * 3 + years * 12;
        this._data = {};
        this._locale = moment.localeData();
        this._bubble();
    }
    function extend(a, b) {
        for (var i in b) {
            if (hasOwnProp(b, i)) {
                a[i] = b[i];
            }
        }
        if (hasOwnProp(b, "toString")) {
            a.toString = b.toString;
        }
        if (hasOwnProp(b, "valueOf")) {
            a.valueOf = b.valueOf;
        }
        return a;
    }
    function copyConfig(to, from) {
        var i, prop, val;
        if (typeof from._isAMomentObject !== "undefined") {
            to._isAMomentObject = from._isAMomentObject;
        }
        if (typeof from._i !== "undefined") {
            to._i = from._i;
        }
        if (typeof from._f !== "undefined") {
            to._f = from._f;
        }
        if (typeof from._l !== "undefined") {
            to._l = from._l;
        }
        if (typeof from._strict !== "undefined") {
            to._strict = from._strict;
        }
        if (typeof from._tzm !== "undefined") {
            to._tzm = from._tzm;
        }
        if (typeof from._isUTC !== "undefined") {
            to._isUTC = from._isUTC;
        }
        if (typeof from._offset !== "undefined") {
            to._offset = from._offset;
        }
        if (typeof from._pf !== "undefined") {
            to._pf = from._pf;
        }
        if (typeof from._locale !== "undefined") {
            to._locale = from._locale;
        }
        if (momentProperties.length > 0) {
            for (i in momentProperties) {
                prop = momentProperties[i];
                val = from[prop];
                if (typeof val !== "undefined") {
                    to[prop] = val;
                }
            }
        }
        return to;
    }
    function absRound(number) {
        if (number < 0) {
            return Math.ceil(number);
        } else {
            return Math.floor(number);
        }
    }
    function leftZeroFill(number, targetLength, forceSign) {
        var output = "" + Math.abs(number), sign = number >= 0;
        while (output.length < targetLength) {
            output = "0" + output;
        }
        return (sign ? forceSign ? "+" : "" : "-") + output;
    }
    function positiveMomentsDifference(base, other) {
        var res = {
            milliseconds: 0,
            months: 0
        };
        res.months = other.month() - base.month() + (other.year() - base.year()) * 12;
        if (base.clone().add(res.months, "M").isAfter(other)) {
            --res.months;
        }
        res.milliseconds = +other - +base.clone().add(res.months, "M");
        return res;
    }
    function momentsDifference(base, other) {
        var res;
        other = makeAs(other, base);
        if (base.isBefore(other)) {
            res = positiveMomentsDifference(base, other);
        } else {
            res = positiveMomentsDifference(other, base);
            res.milliseconds = -res.milliseconds;
            res.months = -res.months;
        }
        return res;
    }
    function createAdder(direction, name) {
        return function(val, period) {
            var dur, tmp;
            if (period !== null && !isNaN(+period)) {
                deprecateSimple(name, "moment()." + name + "(period, number) is deprecated. Please use moment()." + name + "(number, period).");
                tmp = val;
                val = period;
                period = tmp;
            }
            val = typeof val === "string" ? +val : val;
            dur = moment.duration(val, period);
            addOrSubtractDurationFromMoment(this, dur, direction);
            return this;
        };
    }
    function addOrSubtractDurationFromMoment(mom, duration, isAdding, updateOffset) {
        var milliseconds = duration._milliseconds, days = duration._days, months = duration._months;
        updateOffset = updateOffset == null ? true : updateOffset;
        if (milliseconds) {
            mom._d.setTime(+mom._d + milliseconds * isAdding);
        }
        if (days) {
            rawSetter(mom, "Date", rawGetter(mom, "Date") + days * isAdding);
        }
        if (months) {
            rawMonthSetter(mom, rawGetter(mom, "Month") + months * isAdding);
        }
        if (updateOffset) {
            moment.updateOffset(mom, days || months);
        }
    }
    function isArray(input) {
        return Object.prototype.toString.call(input) === "[object Array]";
    }
    function isDate(input) {
        return Object.prototype.toString.call(input) === "[object Date]" || input instanceof Date;
    }
    function compareArrays(array1, array2, dontConvert) {
        var len = Math.min(array1.length, array2.length), lengthDiff = Math.abs(array1.length - array2.length), diffs = 0, i;
        for (i = 0; i < len; i++) {
            if (dontConvert && array1[i] !== array2[i] || !dontConvert && toInt(array1[i]) !== toInt(array2[i])) {
                diffs++;
            }
        }
        return diffs + lengthDiff;
    }
    function normalizeUnits(units) {
        if (units) {
            var lowered = units.toLowerCase().replace(/(.)s$/, "$1");
            units = unitAliases[units] || camelFunctions[lowered] || lowered;
        }
        return units;
    }
    function normalizeObjectUnits(inputObject) {
        var normalizedInput = {}, normalizedProp, prop;
        for (prop in inputObject) {
            if (hasOwnProp(inputObject, prop)) {
                normalizedProp = normalizeUnits(prop);
                if (normalizedProp) {
                    normalizedInput[normalizedProp] = inputObject[prop];
                }
            }
        }
        return normalizedInput;
    }
    function makeList(field) {
        var count, setter;
        if (field.indexOf("week") === 0) {
            count = 7;
            setter = "day";
        } else if (field.indexOf("month") === 0) {
            count = 12;
            setter = "month";
        } else {
            return;
        }
        moment[field] = function(format, index) {
            var i, getter, method = moment._locale[field], results = [];
            if (typeof format === "number") {
                index = format;
                format = undefined;
            }
            getter = function(i) {
                var m = moment().utc().set(setter, i);
                return method.call(moment._locale, m, format || "");
            };
            if (index != null) {
                return getter(index);
            } else {
                for (i = 0; i < count; i++) {
                    results.push(getter(i));
                }
                return results;
            }
        };
    }
    function toInt(argumentForCoercion) {
        var coercedNumber = +argumentForCoercion, value = 0;
        if (coercedNumber !== 0 && isFinite(coercedNumber)) {
            if (coercedNumber >= 0) {
                value = Math.floor(coercedNumber);
            } else {
                value = Math.ceil(coercedNumber);
            }
        }
        return value;
    }
    function daysInMonth(year, month) {
        return new Date(Date.UTC(year, month + 1, 0)).getUTCDate();
    }
    function weeksInYear(year, dow, doy) {
        return weekOfYear(moment([ year, 11, 31 + dow - doy ]), dow, doy).week;
    }
    function daysInYear(year) {
        return isLeapYear(year) ? 366 : 365;
    }
    function isLeapYear(year) {
        return year % 4 === 0 && year % 100 !== 0 || year % 400 === 0;
    }
    function checkOverflow(m) {
        var overflow;
        if (m._a && m._pf.overflow === -2) {
            overflow = m._a[MONTH] < 0 || m._a[MONTH] > 11 ? MONTH : m._a[DATE] < 1 || m._a[DATE] > daysInMonth(m._a[YEAR], m._a[MONTH]) ? DATE : m._a[HOUR] < 0 || m._a[HOUR] > 24 || m._a[HOUR] === 24 && (m._a[MINUTE] !== 0 || m._a[SECOND] !== 0 || m._a[MILLISECOND] !== 0) ? HOUR : m._a[MINUTE] < 0 || m._a[MINUTE] > 59 ? MINUTE : m._a[SECOND] < 0 || m._a[SECOND] > 59 ? SECOND : m._a[MILLISECOND] < 0 || m._a[MILLISECOND] > 999 ? MILLISECOND : -1;
            if (m._pf._overflowDayOfYear && (overflow < YEAR || overflow > DATE)) {
                overflow = DATE;
            }
            m._pf.overflow = overflow;
        }
    }
    function isValid(m) {
        if (m._isValid == null) {
            m._isValid = !isNaN(m._d.getTime()) && m._pf.overflow < 0 && !m._pf.empty && !m._pf.invalidMonth && !m._pf.nullInput && !m._pf.invalidFormat && !m._pf.userInvalidated;
            if (m._strict) {
                m._isValid = m._isValid && m._pf.charsLeftOver === 0 && m._pf.unusedTokens.length === 0 && m._pf.bigHour === undefined;
            }
        }
        return m._isValid;
    }
    function normalizeLocale(key) {
        return key ? key.toLowerCase().replace("_", "-") : key;
    }
    function chooseLocale(names) {
        var i = 0, j, next, locale, split;
        while (i < names.length) {
            split = normalizeLocale(names[i]).split("-");
            j = split.length;
            next = normalizeLocale(names[i + 1]);
            next = next ? next.split("-") : null;
            while (j > 0) {
                locale = loadLocale(split.slice(0, j).join("-"));
                if (locale) {
                    return locale;
                }
                if (next && next.length >= j && compareArrays(split, next, true) >= j - 1) {
                    break;
                }
                j--;
            }
            i++;
        }
        return null;
    }
    function loadLocale(name) {
        var oldLocale = null;
        if (!locales[name] && hasModule) {
            try {
                oldLocale = moment.locale();
                require("./locale/" + name);
                moment.locale(oldLocale);
            } catch (e) {}
        }
        return locales[name];
    }
    function makeAs(input, model) {
        var res, diff;
        if (model._isUTC) {
            res = model.clone();
            diff = (moment.isMoment(input) || isDate(input) ? +input : +moment(input)) - +res;
            res._d.setTime(+res._d + diff);
            moment.updateOffset(res, false);
            return res;
        } else {
            return moment(input).local();
        }
    }
    extend(Locale.prototype, {
        set: function(config) {
            var prop, i;
            for (i in config) {
                prop = config[i];
                if (typeof prop === "function") {
                    this[i] = prop;
                } else {
                    this["_" + i] = prop;
                }
            }
            this._ordinalParseLenient = new RegExp(this._ordinalParse.source + "|" + /\d{1,2}/.source);
        },
        _months: "January_February_March_April_May_June_July_August_September_October_November_December".split("_"),
        months: function(m) {
            return this._months[m.month()];
        },
        _monthsShort: "Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),
        monthsShort: function(m) {
            return this._monthsShort[m.month()];
        },
        monthsParse: function(monthName, format, strict) {
            var i, mom, regex;
            if (!this._monthsParse) {
                this._monthsParse = [];
                this._longMonthsParse = [];
                this._shortMonthsParse = [];
            }
            for (i = 0; i < 12; i++) {
                mom = moment.utc([ 2e3, i ]);
                if (strict && !this._longMonthsParse[i]) {
                    this._longMonthsParse[i] = new RegExp("^" + this.months(mom, "").replace(".", "") + "$", "i");
                    this._shortMonthsParse[i] = new RegExp("^" + this.monthsShort(mom, "").replace(".", "") + "$", "i");
                }
                if (!strict && !this._monthsParse[i]) {
                    regex = "^" + this.months(mom, "") + "|^" + this.monthsShort(mom, "");
                    this._monthsParse[i] = new RegExp(regex.replace(".", ""), "i");
                }
                if (strict && format === "MMMM" && this._longMonthsParse[i].test(monthName)) {
                    return i;
                } else if (strict && format === "MMM" && this._shortMonthsParse[i].test(monthName)) {
                    return i;
                } else if (!strict && this._monthsParse[i].test(monthName)) {
                    return i;
                }
            }
        },
        _weekdays: "Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),
        weekdays: function(m) {
            return this._weekdays[m.day()];
        },
        _weekdaysShort: "Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),
        weekdaysShort: function(m) {
            return this._weekdaysShort[m.day()];
        },
        _weekdaysMin: "Su_Mo_Tu_We_Th_Fr_Sa".split("_"),
        weekdaysMin: function(m) {
            return this._weekdaysMin[m.day()];
        },
        weekdaysParse: function(weekdayName) {
            var i, mom, regex;
            if (!this._weekdaysParse) {
                this._weekdaysParse = [];
            }
            for (i = 0; i < 7; i++) {
                if (!this._weekdaysParse[i]) {
                    mom = moment([ 2e3, 1 ]).day(i);
                    regex = "^" + this.weekdays(mom, "") + "|^" + this.weekdaysShort(mom, "") + "|^" + this.weekdaysMin(mom, "");
                    this._weekdaysParse[i] = new RegExp(regex.replace(".", ""), "i");
                }
                if (this._weekdaysParse[i].test(weekdayName)) {
                    return i;
                }
            }
        },
        _longDateFormat: {
            LTS: "h:mm:ss A",
            LT: "h:mm A",
            L: "MM/DD/YYYY",
            LL: "MMMM D, YYYY",
            LLL: "MMMM D, YYYY LT",
            LLLL: "dddd, MMMM D, YYYY LT"
        },
        longDateFormat: function(key) {
            var output = this._longDateFormat[key];
            if (!output && this._longDateFormat[key.toUpperCase()]) {
                output = this._longDateFormat[key.toUpperCase()].replace(/MMMM|MM|DD|dddd/g, function(val) {
                    return val.slice(1);
                });
                this._longDateFormat[key] = output;
            }
            return output;
        },
        isPM: function(input) {
            return (input + "").toLowerCase().charAt(0) === "p";
        },
        _meridiemParse: /[ap]\.?m?\.?/i,
        meridiem: function(hours, minutes, isLower) {
            if (hours > 11) {
                return isLower ? "pm" : "PM";
            } else {
                return isLower ? "am" : "AM";
            }
        },
        _calendar: {
            sameDay: "[Today at] LT",
            nextDay: "[Tomorrow at] LT",
            nextWeek: "dddd [at] LT",
            lastDay: "[Yesterday at] LT",
            lastWeek: "[Last] dddd [at] LT",
            sameElse: "L"
        },
        calendar: function(key, mom, now) {
            var output = this._calendar[key];
            return typeof output === "function" ? output.apply(mom, [ now ]) : output;
        },
        _relativeTime: {
            future: "in %s",
            past: "%s ago",
            s: "a few seconds",
            m: "a minute",
            mm: "%d minutes",
            h: "an hour",
            hh: "%d hours",
            d: "a day",
            dd: "%d days",
            M: "a month",
            MM: "%d months",
            y: "a year",
            yy: "%d years"
        },
        relativeTime: function(number, withoutSuffix, string, isFuture) {
            var output = this._relativeTime[string];
            return typeof output === "function" ? output(number, withoutSuffix, string, isFuture) : output.replace(/%d/i, number);
        },
        pastFuture: function(diff, output) {
            var format = this._relativeTime[diff > 0 ? "future" : "past"];
            return typeof format === "function" ? format(output) : format.replace(/%s/i, output);
        },
        ordinal: function(number) {
            return this._ordinal.replace("%d", number);
        },
        _ordinal: "%d",
        _ordinalParse: /\d{1,2}/,
        preparse: function(string) {
            return string;
        },
        postformat: function(string) {
            return string;
        },
        week: function(mom) {
            return weekOfYear(mom, this._week.dow, this._week.doy).week;
        },
        _week: {
            dow: 0,
            doy: 6
        },
        firstDayOfWeek: function() {
            return this._week.dow;
        },
        firstDayOfYear: function() {
            return this._week.doy;
        },
        _invalidDate: "Invalid date",
        invalidDate: function() {
            return this._invalidDate;
        }
    });
    function removeFormattingTokens(input) {
        if (input.match(/\[[\s\S]/)) {
            return input.replace(/^\[|\]$/g, "");
        }
        return input.replace(/\\/g, "");
    }
    function makeFormatFunction(format) {
        var array = format.match(formattingTokens), i, length;
        for (i = 0, length = array.length; i < length; i++) {
            if (formatTokenFunctions[array[i]]) {
                array[i] = formatTokenFunctions[array[i]];
            } else {
                array[i] = removeFormattingTokens(array[i]);
            }
        }
        return function(mom) {
            var output = "";
            for (i = 0; i < length; i++) {
                output += array[i] instanceof Function ? array[i].call(mom, format) : array[i];
            }
            return output;
        };
    }
    function formatMoment(m, format) {
        if (!m.isValid()) {
            return m.localeData().invalidDate();
        }
        format = expandFormat(format, m.localeData());
        if (!formatFunctions[format]) {
            formatFunctions[format] = makeFormatFunction(format);
        }
        return formatFunctions[format](m);
    }
    function expandFormat(format, locale) {
        var i = 5;
        function replaceLongDateFormatTokens(input) {
            return locale.longDateFormat(input) || input;
        }
        localFormattingTokens.lastIndex = 0;
        while (i >= 0 && localFormattingTokens.test(format)) {
            format = format.replace(localFormattingTokens, replaceLongDateFormatTokens);
            localFormattingTokens.lastIndex = 0;
            i -= 1;
        }
        return format;
    }
    function getParseRegexForToken(token, config) {
        var a, strict = config._strict;
        switch (token) {
          case "Q":
            return parseTokenOneDigit;

          case "DDDD":
            return parseTokenThreeDigits;

          case "YYYY":
          case "GGGG":
          case "gggg":
            return strict ? parseTokenFourDigits : parseTokenOneToFourDigits;

          case "Y":
          case "G":
          case "g":
            return parseTokenSignedNumber;

          case "YYYYYY":
          case "YYYYY":
          case "GGGGG":
          case "ggggg":
            return strict ? parseTokenSixDigits : parseTokenOneToSixDigits;

          case "S":
            if (strict) {
                return parseTokenOneDigit;
            }

          case "SS":
            if (strict) {
                return parseTokenTwoDigits;
            }

          case "SSS":
            if (strict) {
                return parseTokenThreeDigits;
            }

          case "DDD":
            return parseTokenOneToThreeDigits;

          case "MMM":
          case "MMMM":
          case "dd":
          case "ddd":
          case "dddd":
            return parseTokenWord;

          case "a":
          case "A":
            return config._locale._meridiemParse;

          case "x":
            return parseTokenOffsetMs;

          case "X":
            return parseTokenTimestampMs;

          case "Z":
          case "ZZ":
            return parseTokenTimezone;

          case "T":
            return parseTokenT;

          case "SSSS":
            return parseTokenDigits;

          case "MM":
          case "DD":
          case "YY":
          case "GG":
          case "gg":
          case "HH":
          case "hh":
          case "mm":
          case "ss":
          case "ww":
          case "WW":
            return strict ? parseTokenTwoDigits : parseTokenOneOrTwoDigits;

          case "M":
          case "D":
          case "d":
          case "H":
          case "h":
          case "m":
          case "s":
          case "w":
          case "W":
          case "e":
          case "E":
            return parseTokenOneOrTwoDigits;

          case "Do":
            return strict ? config._locale._ordinalParse : config._locale._ordinalParseLenient;

          default:
            a = new RegExp(regexpEscape(unescapeFormat(token.replace("\\", "")), "i"));
            return a;
        }
    }
    function utcOffsetFromString(string) {
        string = string || "";
        var possibleTzMatches = string.match(parseTokenTimezone) || [], tzChunk = possibleTzMatches[possibleTzMatches.length - 1] || [], parts = (tzChunk + "").match(parseTimezoneChunker) || [ "-", 0, 0 ], minutes = +(parts[1] * 60) + toInt(parts[2]);
        return parts[0] === "+" ? minutes : -minutes;
    }
    function addTimeToArrayFromToken(token, input, config) {
        var a, datePartArray = config._a;
        switch (token) {
          case "Q":
            if (input != null) {
                datePartArray[MONTH] = (toInt(input) - 1) * 3;
            }
            break;

          case "M":
          case "MM":
            if (input != null) {
                datePartArray[MONTH] = toInt(input) - 1;
            }
            break;

          case "MMM":
          case "MMMM":
            a = config._locale.monthsParse(input, token, config._strict);
            if (a != null) {
                datePartArray[MONTH] = a;
            } else {
                config._pf.invalidMonth = input;
            }
            break;

          case "D":
          case "DD":
            if (input != null) {
                datePartArray[DATE] = toInt(input);
            }
            break;

          case "Do":
            if (input != null) {
                datePartArray[DATE] = toInt(parseInt(input.match(/\d{1,2}/)[0], 10));
            }
            break;

          case "DDD":
          case "DDDD":
            if (input != null) {
                config._dayOfYear = toInt(input);
            }
            break;

          case "YY":
            datePartArray[YEAR] = moment.parseTwoDigitYear(input);
            break;

          case "YYYY":
          case "YYYYY":
          case "YYYYYY":
            datePartArray[YEAR] = toInt(input);
            break;

          case "a":
          case "A":
            config._meridiem = input;
            break;

          case "h":
          case "hh":
            config._pf.bigHour = true;

          case "H":
          case "HH":
            datePartArray[HOUR] = toInt(input);
            break;

          case "m":
          case "mm":
            datePartArray[MINUTE] = toInt(input);
            break;

          case "s":
          case "ss":
            datePartArray[SECOND] = toInt(input);
            break;

          case "S":
          case "SS":
          case "SSS":
          case "SSSS":
            datePartArray[MILLISECOND] = toInt(("0." + input) * 1e3);
            break;

          case "x":
            config._d = new Date(toInt(input));
            break;

          case "X":
            config._d = new Date(parseFloat(input) * 1e3);
            break;

          case "Z":
          case "ZZ":
            config._useUTC = true;
            config._tzm = utcOffsetFromString(input);
            break;

          case "dd":
          case "ddd":
          case "dddd":
            a = config._locale.weekdaysParse(input);
            if (a != null) {
                config._w = config._w || {};
                config._w["d"] = a;
            } else {
                config._pf.invalidWeekday = input;
            }
            break;

          case "w":
          case "ww":
          case "W":
          case "WW":
          case "d":
          case "e":
          case "E":
            token = token.substr(0, 1);

          case "gggg":
          case "GGGG":
          case "GGGGG":
            token = token.substr(0, 2);
            if (input) {
                config._w = config._w || {};
                config._w[token] = toInt(input);
            }
            break;

          case "gg":
          case "GG":
            config._w = config._w || {};
            config._w[token] = moment.parseTwoDigitYear(input);
        }
    }
    function dayOfYearFromWeekInfo(config) {
        var w, weekYear, week, weekday, dow, doy, temp;
        w = config._w;
        if (w.GG != null || w.W != null || w.E != null) {
            dow = 1;
            doy = 4;
            weekYear = dfl(w.GG, config._a[YEAR], weekOfYear(moment(), 1, 4).year);
            week = dfl(w.W, 1);
            weekday = dfl(w.E, 1);
        } else {
            dow = config._locale._week.dow;
            doy = config._locale._week.doy;
            weekYear = dfl(w.gg, config._a[YEAR], weekOfYear(moment(), dow, doy).year);
            week = dfl(w.w, 1);
            if (w.d != null) {
                weekday = w.d;
                if (weekday < dow) {
                    ++week;
                }
            } else if (w.e != null) {
                weekday = w.e + dow;
            } else {
                weekday = dow;
            }
        }
        temp = dayOfYearFromWeeks(weekYear, week, weekday, doy, dow);
        config._a[YEAR] = temp.year;
        config._dayOfYear = temp.dayOfYear;
    }
    function dateFromConfig(config) {
        var i, date, input = [], currentDate, yearToUse;
        if (config._d) {
            return;
        }
        currentDate = currentDateArray(config);
        if (config._w && config._a[DATE] == null && config._a[MONTH] == null) {
            dayOfYearFromWeekInfo(config);
        }
        if (config._dayOfYear) {
            yearToUse = dfl(config._a[YEAR], currentDate[YEAR]);
            if (config._dayOfYear > daysInYear(yearToUse)) {
                config._pf._overflowDayOfYear = true;
            }
            date = makeUTCDate(yearToUse, 0, config._dayOfYear);
            config._a[MONTH] = date.getUTCMonth();
            config._a[DATE] = date.getUTCDate();
        }
        for (i = 0; i < 3 && config._a[i] == null; ++i) {
            config._a[i] = input[i] = currentDate[i];
        }
        for (;i < 7; i++) {
            config._a[i] = input[i] = config._a[i] == null ? i === 2 ? 1 : 0 : config._a[i];
        }
        if (config._a[HOUR] === 24 && config._a[MINUTE] === 0 && config._a[SECOND] === 0 && config._a[MILLISECOND] === 0) {
            config._nextDay = true;
            config._a[HOUR] = 0;
        }
        config._d = (config._useUTC ? makeUTCDate : makeDate).apply(null, input);
        if (config._tzm != null) {
            config._d.setUTCMinutes(config._d.getUTCMinutes() - config._tzm);
        }
        if (config._nextDay) {
            config._a[HOUR] = 24;
        }
    }
    function dateFromObject(config) {
        var normalizedInput;
        if (config._d) {
            return;
        }
        normalizedInput = normalizeObjectUnits(config._i);
        config._a = [ normalizedInput.year, normalizedInput.month, normalizedInput.day || normalizedInput.date, normalizedInput.hour, normalizedInput.minute, normalizedInput.second, normalizedInput.millisecond ];
        dateFromConfig(config);
    }
    function currentDateArray(config) {
        var now = new Date();
        if (config._useUTC) {
            return [ now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() ];
        } else {
            return [ now.getFullYear(), now.getMonth(), now.getDate() ];
        }
    }
    function makeDateFromStringAndFormat(config) {
        if (config._f === moment.ISO_8601) {
            parseISO(config);
            return;
        }
        config._a = [];
        config._pf.empty = true;
        var string = "" + config._i, i, parsedInput, tokens, token, skipped, stringLength = string.length, totalParsedInputLength = 0;
        tokens = expandFormat(config._f, config._locale).match(formattingTokens) || [];
        for (i = 0; i < tokens.length; i++) {
            token = tokens[i];
            parsedInput = (string.match(getParseRegexForToken(token, config)) || [])[0];
            if (parsedInput) {
                skipped = string.substr(0, string.indexOf(parsedInput));
                if (skipped.length > 0) {
                    config._pf.unusedInput.push(skipped);
                }
                string = string.slice(string.indexOf(parsedInput) + parsedInput.length);
                totalParsedInputLength += parsedInput.length;
            }
            if (formatTokenFunctions[token]) {
                if (parsedInput) {
                    config._pf.empty = false;
                } else {
                    config._pf.unusedTokens.push(token);
                }
                addTimeToArrayFromToken(token, parsedInput, config);
            } else if (config._strict && !parsedInput) {
                config._pf.unusedTokens.push(token);
            }
        }
        config._pf.charsLeftOver = stringLength - totalParsedInputLength;
        if (string.length > 0) {
            config._pf.unusedInput.push(string);
        }
        if (config._pf.bigHour === true && config._a[HOUR] <= 12) {
            config._pf.bigHour = undefined;
        }
        config._a[HOUR] = meridiemFixWrap(config._locale, config._a[HOUR], config._meridiem);
        dateFromConfig(config);
        checkOverflow(config);
    }
    function unescapeFormat(s) {
        return s.replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g, function(matched, p1, p2, p3, p4) {
            return p1 || p2 || p3 || p4;
        });
    }
    function regexpEscape(s) {
        return s.replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&");
    }
    function makeDateFromStringAndArray(config) {
        var tempConfig, bestMoment, scoreToBeat, i, currentScore;
        if (config._f.length === 0) {
            config._pf.invalidFormat = true;
            config._d = new Date(NaN);
            return;
        }
        for (i = 0; i < config._f.length; i++) {
            currentScore = 0;
            tempConfig = copyConfig({}, config);
            if (config._useUTC != null) {
                tempConfig._useUTC = config._useUTC;
            }
            tempConfig._pf = defaultParsingFlags();
            tempConfig._f = config._f[i];
            makeDateFromStringAndFormat(tempConfig);
            if (!isValid(tempConfig)) {
                continue;
            }
            currentScore += tempConfig._pf.charsLeftOver;
            currentScore += tempConfig._pf.unusedTokens.length * 10;
            tempConfig._pf.score = currentScore;
            if (scoreToBeat == null || currentScore < scoreToBeat) {
                scoreToBeat = currentScore;
                bestMoment = tempConfig;
            }
        }
        extend(config, bestMoment || tempConfig);
    }
    function parseISO(config) {
        var i, l, string = config._i, match = isoRegex.exec(string);
        if (match) {
            config._pf.iso = true;
            for (i = 0, l = isoDates.length; i < l; i++) {
                if (isoDates[i][1].exec(string)) {
                    config._f = isoDates[i][0] + (match[6] || " ");
                    break;
                }
            }
            for (i = 0, l = isoTimes.length; i < l; i++) {
                if (isoTimes[i][1].exec(string)) {
                    config._f += isoTimes[i][0];
                    break;
                }
            }
            if (string.match(parseTokenTimezone)) {
                config._f += "Z";
            }
            makeDateFromStringAndFormat(config);
        } else {
            config._isValid = false;
        }
    }
    function makeDateFromString(config) {
        parseISO(config);
        if (config._isValid === false) {
            delete config._isValid;
            moment.createFromInputFallback(config);
        }
    }
    function map(arr, fn) {
        var res = [], i;
        for (i = 0; i < arr.length; ++i) {
            res.push(fn(arr[i], i));
        }
        return res;
    }
    function makeDateFromInput(config) {
        var input = config._i, matched;
        if (input === undefined) {
            config._d = new Date();
        } else if (isDate(input)) {
            config._d = new Date(+input);
        } else if ((matched = aspNetJsonRegex.exec(input)) !== null) {
            config._d = new Date(+matched[1]);
        } else if (typeof input === "string") {
            makeDateFromString(config);
        } else if (isArray(input)) {
            config._a = map(input.slice(0), function(obj) {
                return parseInt(obj, 10);
            });
            dateFromConfig(config);
        } else if (typeof input === "object") {
            dateFromObject(config);
        } else if (typeof input === "number") {
            config._d = new Date(input);
        } else {
            moment.createFromInputFallback(config);
        }
    }
    function makeDate(y, m, d, h, M, s, ms) {
        var date = new Date(y, m, d, h, M, s, ms);
        if (y < 1970) {
            date.setFullYear(y);
        }
        return date;
    }
    function makeUTCDate(y) {
        var date = new Date(Date.UTC.apply(null, arguments));
        if (y < 1970) {
            date.setUTCFullYear(y);
        }
        return date;
    }
    function parseWeekday(input, locale) {
        if (typeof input === "string") {
            if (!isNaN(input)) {
                input = parseInt(input, 10);
            } else {
                input = locale.weekdaysParse(input);
                if (typeof input !== "number") {
                    return null;
                }
            }
        }
        return input;
    }
    function substituteTimeAgo(string, number, withoutSuffix, isFuture, locale) {
        return locale.relativeTime(number || 1, !!withoutSuffix, string, isFuture);
    }
    function relativeTime(posNegDuration, withoutSuffix, locale) {
        var duration = moment.duration(posNegDuration).abs(), seconds = round(duration.as("s")), minutes = round(duration.as("m")), hours = round(duration.as("h")), days = round(duration.as("d")), months = round(duration.as("M")), years = round(duration.as("y")), args = seconds < relativeTimeThresholds.s && [ "s", seconds ] || minutes === 1 && [ "m" ] || minutes < relativeTimeThresholds.m && [ "mm", minutes ] || hours === 1 && [ "h" ] || hours < relativeTimeThresholds.h && [ "hh", hours ] || days === 1 && [ "d" ] || days < relativeTimeThresholds.d && [ "dd", days ] || months === 1 && [ "M" ] || months < relativeTimeThresholds.M && [ "MM", months ] || years === 1 && [ "y" ] || [ "yy", years ];
        args[2] = withoutSuffix;
        args[3] = +posNegDuration > 0;
        args[4] = locale;
        return substituteTimeAgo.apply({}, args);
    }
    function weekOfYear(mom, firstDayOfWeek, firstDayOfWeekOfYear) {
        var end = firstDayOfWeekOfYear - firstDayOfWeek, daysToDayOfWeek = firstDayOfWeekOfYear - mom.day(), adjustedMoment;
        if (daysToDayOfWeek > end) {
            daysToDayOfWeek -= 7;
        }
        if (daysToDayOfWeek < end - 7) {
            daysToDayOfWeek += 7;
        }
        adjustedMoment = moment(mom).add(daysToDayOfWeek, "d");
        return {
            week: Math.ceil(adjustedMoment.dayOfYear() / 7),
            year: adjustedMoment.year()
        };
    }
    function dayOfYearFromWeeks(year, week, weekday, firstDayOfWeekOfYear, firstDayOfWeek) {
        var d = makeUTCDate(year, 0, 1).getUTCDay(), daysToAdd, dayOfYear;
        d = d === 0 ? 7 : d;
        weekday = weekday != null ? weekday : firstDayOfWeek;
        daysToAdd = firstDayOfWeek - d + (d > firstDayOfWeekOfYear ? 7 : 0) - (d < firstDayOfWeek ? 7 : 0);
        dayOfYear = 7 * (week - 1) + (weekday - firstDayOfWeek) + daysToAdd + 1;
        return {
            year: dayOfYear > 0 ? year : year - 1,
            dayOfYear: dayOfYear > 0 ? dayOfYear : daysInYear(year - 1) + dayOfYear
        };
    }
    function makeMoment(config) {
        var input = config._i, format = config._f, res;
        config._locale = config._locale || moment.localeData(config._l);
        if (input === null || format === undefined && input === "") {
            return moment.invalid({
                nullInput: true
            });
        }
        if (typeof input === "string") {
            config._i = input = config._locale.preparse(input);
        }
        if (moment.isMoment(input)) {
            return new Moment(input, true);
        } else if (format) {
            if (isArray(format)) {
                makeDateFromStringAndArray(config);
            } else {
                makeDateFromStringAndFormat(config);
            }
        } else {
            makeDateFromInput(config);
        }
        res = new Moment(config);
        if (res._nextDay) {
            res.add(1, "d");
            res._nextDay = undefined;
        }
        return res;
    }
    moment = function(input, format, locale, strict) {
        var c;
        if (typeof locale === "boolean") {
            strict = locale;
            locale = undefined;
        }
        c = {};
        c._isAMomentObject = true;
        c._i = input;
        c._f = format;
        c._l = locale;
        c._strict = strict;
        c._isUTC = false;
        c._pf = defaultParsingFlags();
        return makeMoment(c);
    };
    moment.suppressDeprecationWarnings = false;
    moment.createFromInputFallback = deprecate("moment construction falls back to js Date. This is " + "discouraged and will be removed in upcoming major " + "release. Please refer to " + "https://github.com/moment/moment/issues/1407 for more info.", function(config) {
        config._d = new Date(config._i + (config._useUTC ? " UTC" : ""));
    });
    function pickBy(fn, moments) {
        var res, i;
        if (moments.length === 1 && isArray(moments[0])) {
            moments = moments[0];
        }
        if (!moments.length) {
            return moment();
        }
        res = moments[0];
        for (i = 1; i < moments.length; ++i) {
            if (moments[i][fn](res)) {
                res = moments[i];
            }
        }
        return res;
    }
    moment.min = function() {
        var args = [].slice.call(arguments, 0);
        return pickBy("isBefore", args);
    };
    moment.max = function() {
        var args = [].slice.call(arguments, 0);
        return pickBy("isAfter", args);
    };
    moment.utc = function(input, format, locale, strict) {
        var c;
        if (typeof locale === "boolean") {
            strict = locale;
            locale = undefined;
        }
        c = {};
        c._isAMomentObject = true;
        c._useUTC = true;
        c._isUTC = true;
        c._l = locale;
        c._i = input;
        c._f = format;
        c._strict = strict;
        c._pf = defaultParsingFlags();
        return makeMoment(c).utc();
    };
    moment.unix = function(input) {
        return moment(input * 1e3);
    };
    moment.duration = function(input, key) {
        var duration = input, match = null, sign, ret, parseIso, diffRes;
        if (moment.isDuration(input)) {
            duration = {
                ms: input._milliseconds,
                d: input._days,
                M: input._months
            };
        } else if (typeof input === "number") {
            duration = {};
            if (key) {
                duration[key] = input;
            } else {
                duration.milliseconds = input;
            }
        } else if (!!(match = aspNetTimeSpanJsonRegex.exec(input))) {
            sign = match[1] === "-" ? -1 : 1;
            duration = {
                y: 0,
                d: toInt(match[DATE]) * sign,
                h: toInt(match[HOUR]) * sign,
                m: toInt(match[MINUTE]) * sign,
                s: toInt(match[SECOND]) * sign,
                ms: toInt(match[MILLISECOND]) * sign
            };
        } else if (!!(match = isoDurationRegex.exec(input))) {
            sign = match[1] === "-" ? -1 : 1;
            parseIso = function(inp) {
                var res = inp && parseFloat(inp.replace(",", "."));
                return (isNaN(res) ? 0 : res) * sign;
            };
            duration = {
                y: parseIso(match[2]),
                M: parseIso(match[3]),
                d: parseIso(match[4]),
                h: parseIso(match[5]),
                m: parseIso(match[6]),
                s: parseIso(match[7]),
                w: parseIso(match[8])
            };
        } else if (duration == null) {
            duration = {};
        } else if (typeof duration === "object" && ("from" in duration || "to" in duration)) {
            diffRes = momentsDifference(moment(duration.from), moment(duration.to));
            duration = {};
            duration.ms = diffRes.milliseconds;
            duration.M = diffRes.months;
        }
        ret = new Duration(duration);
        if (moment.isDuration(input) && hasOwnProp(input, "_locale")) {
            ret._locale = input._locale;
        }
        return ret;
    };
    moment.version = VERSION;
    moment.defaultFormat = isoFormat;
    moment.ISO_8601 = function() {};
    moment.momentProperties = momentProperties;
    moment.updateOffset = function() {};
    moment.relativeTimeThreshold = function(threshold, limit) {
        if (relativeTimeThresholds[threshold] === undefined) {
            return false;
        }
        if (limit === undefined) {
            return relativeTimeThresholds[threshold];
        }
        relativeTimeThresholds[threshold] = limit;
        return true;
    };
    moment.lang = deprecate("moment.lang is deprecated. Use moment.locale instead.", function(key, value) {
        return moment.locale(key, value);
    });
    moment.locale = function(key, values) {
        var data;
        if (key) {
            if (typeof values !== "undefined") {
                data = moment.defineLocale(key, values);
            } else {
                data = moment.localeData(key);
            }
            if (data) {
                moment.duration._locale = moment._locale = data;
            }
        }
        return moment._locale._abbr;
    };
    moment.defineLocale = function(name, values) {
        if (values !== null) {
            values.abbr = name;
            if (!locales[name]) {
                locales[name] = new Locale();
            }
            locales[name].set(values);
            moment.locale(name);
            return locales[name];
        } else {
            delete locales[name];
            return null;
        }
    };
    moment.langData = deprecate("moment.langData is deprecated. Use moment.localeData instead.", function(key) {
        return moment.localeData(key);
    });
    moment.localeData = function(key) {
        var locale;
        if (key && key._locale && key._locale._abbr) {
            key = key._locale._abbr;
        }
        if (!key) {
            return moment._locale;
        }
        if (!isArray(key)) {
            locale = loadLocale(key);
            if (locale) {
                return locale;
            }
            key = [ key ];
        }
        return chooseLocale(key);
    };
    moment.isMoment = function(obj) {
        return obj instanceof Moment || obj != null && hasOwnProp(obj, "_isAMomentObject");
    };
    moment.isDuration = function(obj) {
        return obj instanceof Duration;
    };
    for (i = lists.length - 1; i >= 0; --i) {
        makeList(lists[i]);
    }
    moment.normalizeUnits = function(units) {
        return normalizeUnits(units);
    };
    moment.invalid = function(flags) {
        var m = moment.utc(NaN);
        if (flags != null) {
            extend(m._pf, flags);
        } else {
            m._pf.userInvalidated = true;
        }
        return m;
    };
    moment.parseZone = function() {
        return moment.apply(null, arguments).parseZone();
    };
    moment.parseTwoDigitYear = function(input) {
        return toInt(input) + (toInt(input) > 68 ? 1900 : 2e3);
    };
    moment.isDate = isDate;
    extend(moment.fn = Moment.prototype, {
        clone: function() {
            return moment(this);
        },
        valueOf: function() {
            return +this._d - (this._offset || 0) * 6e4;
        },
        unix: function() {
            return Math.floor(+this / 1e3);
        },
        toString: function() {
            return this.clone().locale("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ");
        },
        toDate: function() {
            return this._offset ? new Date(+this) : this._d;
        },
        toISOString: function() {
            var m = moment(this).utc();
            if (0 < m.year() && m.year() <= 9999) {
                if ("function" === typeof Date.prototype.toISOString) {
                    return this.toDate().toISOString();
                } else {
                    return formatMoment(m, "YYYY-MM-DD[T]HH:mm:ss.SSS[Z]");
                }
            } else {
                return formatMoment(m, "YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]");
            }
        },
        toArray: function() {
            var m = this;
            return [ m.year(), m.month(), m.date(), m.hours(), m.minutes(), m.seconds(), m.milliseconds() ];
        },
        isValid: function() {
            return isValid(this);
        },
        isDSTShifted: function() {
            if (this._a) {
                return this.isValid() && compareArrays(this._a, (this._isUTC ? moment.utc(this._a) : moment(this._a)).toArray()) > 0;
            }
            return false;
        },
        parsingFlags: function() {
            return extend({}, this._pf);
        },
        invalidAt: function() {
            return this._pf.overflow;
        },
        utc: function(keepLocalTime) {
            return this.utcOffset(0, keepLocalTime);
        },
        local: function(keepLocalTime) {
            if (this._isUTC) {
                this.utcOffset(0, keepLocalTime);
                this._isUTC = false;
                if (keepLocalTime) {
                    this.subtract(this._dateUtcOffset(), "m");
                }
            }
            return this;
        },
        format: function(inputString) {
            var output = formatMoment(this, inputString || moment.defaultFormat);
            return this.localeData().postformat(output);
        },
        add: createAdder(1, "add"),
        subtract: createAdder(-1, "subtract"),
        diff: function(input, units, asFloat) {
            var that = makeAs(input, this), zoneDiff = (that.utcOffset() - this.utcOffset()) * 6e4, anchor, diff, output, daysAdjust;
            units = normalizeUnits(units);
            if (units === "year" || units === "month" || units === "quarter") {
                output = monthDiff(this, that);
                if (units === "quarter") {
                    output = output / 3;
                } else if (units === "year") {
                    output = output / 12;
                }
            } else {
                diff = this - that;
                output = units === "second" ? diff / 1e3 : units === "minute" ? diff / 6e4 : units === "hour" ? diff / 36e5 : units === "day" ? (diff - zoneDiff) / 864e5 : units === "week" ? (diff - zoneDiff) / 6048e5 : diff;
            }
            return asFloat ? output : absRound(output);
        },
        from: function(time, withoutSuffix) {
            return moment.duration({
                to: this,
                from: time
            }).locale(this.locale()).humanize(!withoutSuffix);
        },
        fromNow: function(withoutSuffix) {
            return this.from(moment(), withoutSuffix);
        },
        calendar: function(time) {
            var now = time || moment(), sod = makeAs(now, this).startOf("day"), diff = this.diff(sod, "days", true), format = diff < -6 ? "sameElse" : diff < -1 ? "lastWeek" : diff < 0 ? "lastDay" : diff < 1 ? "sameDay" : diff < 2 ? "nextDay" : diff < 7 ? "nextWeek" : "sameElse";
            return this.format(this.localeData().calendar(format, this, moment(now)));
        },
        isLeapYear: function() {
            return isLeapYear(this.year());
        },
        isDST: function() {
            return this.utcOffset() > this.clone().month(0).utcOffset() || this.utcOffset() > this.clone().month(5).utcOffset();
        },
        day: function(input) {
            var day = this._isUTC ? this._d.getUTCDay() : this._d.getDay();
            if (input != null) {
                input = parseWeekday(input, this.localeData());
                return this.add(input - day, "d");
            } else {
                return day;
            }
        },
        month: makeAccessor("Month", true),
        startOf: function(units) {
            units = normalizeUnits(units);
            switch (units) {
              case "year":
                this.month(0);

              case "quarter":
              case "month":
                this.date(1);

              case "week":
              case "isoWeek":
              case "day":
                this.hours(0);

              case "hour":
                this.minutes(0);

              case "minute":
                this.seconds(0);

              case "second":
                this.milliseconds(0);
            }
            if (units === "week") {
                this.weekday(0);
            } else if (units === "isoWeek") {
                this.isoWeekday(1);
            }
            if (units === "quarter") {
                this.month(Math.floor(this.month() / 3) * 3);
            }
            return this;
        },
        endOf: function(units) {
            units = normalizeUnits(units);
            if (units === undefined || units === "millisecond") {
                return this;
            }
            return this.startOf(units).add(1, units === "isoWeek" ? "week" : units).subtract(1, "ms");
        },
        isAfter: function(input, units) {
            var inputMs;
            units = normalizeUnits(typeof units !== "undefined" ? units : "millisecond");
            if (units === "millisecond") {
                input = moment.isMoment(input) ? input : moment(input);
                return +this > +input;
            } else {
                inputMs = moment.isMoment(input) ? +input : +moment(input);
                return inputMs < +this.clone().startOf(units);
            }
        },
        isBefore: function(input, units) {
            var inputMs;
            units = normalizeUnits(typeof units !== "undefined" ? units : "millisecond");
            if (units === "millisecond") {
                input = moment.isMoment(input) ? input : moment(input);
                return +this < +input;
            } else {
                inputMs = moment.isMoment(input) ? +input : +moment(input);
                return +this.clone().endOf(units) < inputMs;
            }
        },
        isBetween: function(from, to, units) {
            return this.isAfter(from, units) && this.isBefore(to, units);
        },
        isSame: function(input, units) {
            var inputMs;
            units = normalizeUnits(units || "millisecond");
            if (units === "millisecond") {
                input = moment.isMoment(input) ? input : moment(input);
                return +this === +input;
            } else {
                inputMs = +moment(input);
                return +this.clone().startOf(units) <= inputMs && inputMs <= +this.clone().endOf(units);
            }
        },
        min: deprecate("moment().min is deprecated, use moment.min instead. https://github.com/moment/moment/issues/1548", function(other) {
            other = moment.apply(null, arguments);
            return other < this ? this : other;
        }),
        max: deprecate("moment().max is deprecated, use moment.max instead. https://github.com/moment/moment/issues/1548", function(other) {
            other = moment.apply(null, arguments);
            return other > this ? this : other;
        }),
        zone: deprecate("moment().zone is deprecated, use moment().utcOffset instead. " + "https://github.com/moment/moment/issues/1779", function(input, keepLocalTime) {
            if (input != null) {
                if (typeof input !== "string") {
                    input = -input;
                }
                this.utcOffset(input, keepLocalTime);
                return this;
            } else {
                return -this.utcOffset();
            }
        }),
        utcOffset: function(input, keepLocalTime) {
            var offset = this._offset || 0, localAdjust;
            if (input != null) {
                if (typeof input === "string") {
                    input = utcOffsetFromString(input);
                }
                if (Math.abs(input) < 16) {
                    input = input * 60;
                }
                if (!this._isUTC && keepLocalTime) {
                    localAdjust = this._dateUtcOffset();
                }
                this._offset = input;
                this._isUTC = true;
                if (localAdjust != null) {
                    this.add(localAdjust, "m");
                }
                if (offset !== input) {
                    if (!keepLocalTime || this._changeInProgress) {
                        addOrSubtractDurationFromMoment(this, moment.duration(input - offset, "m"), 1, false);
                    } else if (!this._changeInProgress) {
                        this._changeInProgress = true;
                        moment.updateOffset(this, true);
                        this._changeInProgress = null;
                    }
                }
                return this;
            } else {
                return this._isUTC ? offset : this._dateUtcOffset();
            }
        },
        isLocal: function() {
            return !this._isUTC;
        },
        isUtcOffset: function() {
            return this._isUTC;
        },
        isUtc: function() {
            return this._isUTC && this._offset === 0;
        },
        zoneAbbr: function() {
            return this._isUTC ? "UTC" : "";
        },
        zoneName: function() {
            return this._isUTC ? "Coordinated Universal Time" : "";
        },
        parseZone: function() {
            if (this._tzm) {
                this.utcOffset(this._tzm);
            } else if (typeof this._i === "string") {
                this.utcOffset(utcOffsetFromString(this._i));
            }
            return this;
        },
        hasAlignedHourOffset: function(input) {
            if (!input) {
                input = 0;
            } else {
                input = moment(input).utcOffset();
            }
            return (this.utcOffset() - input) % 60 === 0;
        },
        daysInMonth: function() {
            return daysInMonth(this.year(), this.month());
        },
        dayOfYear: function(input) {
            var dayOfYear = round((moment(this).startOf("day") - moment(this).startOf("year")) / 864e5) + 1;
            return input == null ? dayOfYear : this.add(input - dayOfYear, "d");
        },
        quarter: function(input) {
            return input == null ? Math.ceil((this.month() + 1) / 3) : this.month((input - 1) * 3 + this.month() % 3);
        },
        weekYear: function(input) {
            var year = weekOfYear(this, this.localeData()._week.dow, this.localeData()._week.doy).year;
            return input == null ? year : this.add(input - year, "y");
        },
        isoWeekYear: function(input) {
            var year = weekOfYear(this, 1, 4).year;
            return input == null ? year : this.add(input - year, "y");
        },
        week: function(input) {
            var week = this.localeData().week(this);
            return input == null ? week : this.add((input - week) * 7, "d");
        },
        isoWeek: function(input) {
            var week = weekOfYear(this, 1, 4).week;
            return input == null ? week : this.add((input - week) * 7, "d");
        },
        weekday: function(input) {
            var weekday = (this.day() + 7 - this.localeData()._week.dow) % 7;
            return input == null ? weekday : this.add(input - weekday, "d");
        },
        isoWeekday: function(input) {
            return input == null ? this.day() || 7 : this.day(this.day() % 7 ? input : input - 7);
        },
        isoWeeksInYear: function() {
            return weeksInYear(this.year(), 1, 4);
        },
        weeksInYear: function() {
            var weekInfo = this.localeData()._week;
            return weeksInYear(this.year(), weekInfo.dow, weekInfo.doy);
        },
        get: function(units) {
            units = normalizeUnits(units);
            return this[units]();
        },
        set: function(units, value) {
            var unit;
            if (typeof units === "object") {
                for (unit in units) {
                    this.set(unit, units[unit]);
                }
            } else {
                units = normalizeUnits(units);
                if (typeof this[units] === "function") {
                    this[units](value);
                }
            }
            return this;
        },
        locale: function(key) {
            var newLocaleData;
            if (key === undefined) {
                return this._locale._abbr;
            } else {
                newLocaleData = moment.localeData(key);
                if (newLocaleData != null) {
                    this._locale = newLocaleData;
                }
                return this;
            }
        },
        lang: deprecate("moment().lang() is deprecated. Instead, use moment().localeData() to get the language configuration. Use moment().locale() to change languages.", function(key) {
            if (key === undefined) {
                return this.localeData();
            } else {
                return this.locale(key);
            }
        }),
        localeData: function() {
            return this._locale;
        },
        _dateUtcOffset: function() {
            return -Math.round(this._d.getTimezoneOffset() / 15) * 15;
        }
    });
    function rawMonthSetter(mom, value) {
        var dayOfMonth;
        if (typeof value === "string") {
            value = mom.localeData().monthsParse(value);
            if (typeof value !== "number") {
                return mom;
            }
        }
        dayOfMonth = Math.min(mom.date(), daysInMonth(mom.year(), value));
        mom._d["set" + (mom._isUTC ? "UTC" : "") + "Month"](value, dayOfMonth);
        return mom;
    }
    function rawGetter(mom, unit) {
        return mom._d["get" + (mom._isUTC ? "UTC" : "") + unit]();
    }
    function rawSetter(mom, unit, value) {
        if (unit === "Month") {
            return rawMonthSetter(mom, value);
        } else {
            return mom._d["set" + (mom._isUTC ? "UTC" : "") + unit](value);
        }
    }
    function makeAccessor(unit, keepTime) {
        return function(value) {
            if (value != null) {
                rawSetter(this, unit, value);
                moment.updateOffset(this, keepTime);
                return this;
            } else {
                return rawGetter(this, unit);
            }
        };
    }
    moment.fn.millisecond = moment.fn.milliseconds = makeAccessor("Milliseconds", false);
    moment.fn.second = moment.fn.seconds = makeAccessor("Seconds", false);
    moment.fn.minute = moment.fn.minutes = makeAccessor("Minutes", false);
    moment.fn.hour = moment.fn.hours = makeAccessor("Hours", true);
    moment.fn.date = makeAccessor("Date", true);
    moment.fn.dates = deprecate("dates accessor is deprecated. Use date instead.", makeAccessor("Date", true));
    moment.fn.year = makeAccessor("FullYear", true);
    moment.fn.years = deprecate("years accessor is deprecated. Use year instead.", makeAccessor("FullYear", true));
    moment.fn.days = moment.fn.day;
    moment.fn.months = moment.fn.month;
    moment.fn.weeks = moment.fn.week;
    moment.fn.isoWeeks = moment.fn.isoWeek;
    moment.fn.quarters = moment.fn.quarter;
    moment.fn.toJSON = moment.fn.toISOString;
    moment.fn.isUTC = moment.fn.isUtc;
    function daysToYears(days) {
        return days * 400 / 146097;
    }
    function yearsToDays(years) {
        return years * 146097 / 400;
    }
    extend(moment.duration.fn = Duration.prototype, {
        _bubble: function() {
            var milliseconds = this._milliseconds, days = this._days, months = this._months, data = this._data, seconds, minutes, hours, years = 0;
            data.milliseconds = milliseconds % 1e3;
            seconds = absRound(milliseconds / 1e3);
            data.seconds = seconds % 60;
            minutes = absRound(seconds / 60);
            data.minutes = minutes % 60;
            hours = absRound(minutes / 60);
            data.hours = hours % 24;
            days += absRound(hours / 24);
            years = absRound(daysToYears(days));
            days -= absRound(yearsToDays(years));
            months += absRound(days / 30);
            days %= 30;
            years += absRound(months / 12);
            months %= 12;
            data.days = days;
            data.months = months;
            data.years = years;
        },
        abs: function() {
            this._milliseconds = Math.abs(this._milliseconds);
            this._days = Math.abs(this._days);
            this._months = Math.abs(this._months);
            this._data.milliseconds = Math.abs(this._data.milliseconds);
            this._data.seconds = Math.abs(this._data.seconds);
            this._data.minutes = Math.abs(this._data.minutes);
            this._data.hours = Math.abs(this._data.hours);
            this._data.months = Math.abs(this._data.months);
            this._data.years = Math.abs(this._data.years);
            return this;
        },
        weeks: function() {
            return absRound(this.days() / 7);
        },
        valueOf: function() {
            return this._milliseconds + this._days * 864e5 + this._months % 12 * 2592e6 + toInt(this._months / 12) * 31536e6;
        },
        humanize: function(withSuffix) {
            var output = relativeTime(this, !withSuffix, this.localeData());
            if (withSuffix) {
                output = this.localeData().pastFuture(+this, output);
            }
            return this.localeData().postformat(output);
        },
        add: function(input, val) {
            var dur = moment.duration(input, val);
            this._milliseconds += dur._milliseconds;
            this._days += dur._days;
            this._months += dur._months;
            this._bubble();
            return this;
        },
        subtract: function(input, val) {
            var dur = moment.duration(input, val);
            this._milliseconds -= dur._milliseconds;
            this._days -= dur._days;
            this._months -= dur._months;
            this._bubble();
            return this;
        },
        get: function(units) {
            units = normalizeUnits(units);
            return this[units.toLowerCase() + "s"]();
        },
        as: function(units) {
            var days, months;
            units = normalizeUnits(units);
            if (units === "month" || units === "year") {
                days = this._days + this._milliseconds / 864e5;
                months = this._months + daysToYears(days) * 12;
                return units === "month" ? months : months / 12;
            } else {
                days = this._days + Math.round(yearsToDays(this._months / 12));
                switch (units) {
                  case "week":
                    return days / 7 + this._milliseconds / 6048e5;

                  case "day":
                    return days + this._milliseconds / 864e5;

                  case "hour":
                    return days * 24 + this._milliseconds / 36e5;

                  case "minute":
                    return days * 24 * 60 + this._milliseconds / 6e4;

                  case "second":
                    return days * 24 * 60 * 60 + this._milliseconds / 1e3;

                  case "millisecond":
                    return Math.floor(days * 24 * 60 * 60 * 1e3) + this._milliseconds;

                  default:
                    throw new Error("Unknown unit " + units);
                }
            }
        },
        lang: moment.fn.lang,
        locale: moment.fn.locale,
        toIsoString: deprecate("toIsoString() is deprecated. Please use toISOString() instead " + "(notice the capitals)", function() {
            return this.toISOString();
        }),
        toISOString: function() {
            var years = Math.abs(this.years()), months = Math.abs(this.months()), days = Math.abs(this.days()), hours = Math.abs(this.hours()), minutes = Math.abs(this.minutes()), seconds = Math.abs(this.seconds() + this.milliseconds() / 1e3);
            if (!this.asSeconds()) {
                return "P0D";
            }
            return (this.asSeconds() < 0 ? "-" : "") + "P" + (years ? years + "Y" : "") + (months ? months + "M" : "") + (days ? days + "D" : "") + (hours || minutes || seconds ? "T" : "") + (hours ? hours + "H" : "") + (minutes ? minutes + "M" : "") + (seconds ? seconds + "S" : "");
        },
        localeData: function() {
            return this._locale;
        },
        toJSON: function() {
            return this.toISOString();
        }
    });
    moment.duration.fn.toString = moment.duration.fn.toISOString;
    function makeDurationGetter(name) {
        moment.duration.fn[name] = function() {
            return this._data[name];
        };
    }
    for (i in unitMillisecondFactors) {
        if (hasOwnProp(unitMillisecondFactors, i)) {
            makeDurationGetter(i.toLowerCase());
        }
    }
    moment.duration.fn.asMilliseconds = function() {
        return this.as("ms");
    };
    moment.duration.fn.asSeconds = function() {
        return this.as("s");
    };
    moment.duration.fn.asMinutes = function() {
        return this.as("m");
    };
    moment.duration.fn.asHours = function() {
        return this.as("h");
    };
    moment.duration.fn.asDays = function() {
        return this.as("d");
    };
    moment.duration.fn.asWeeks = function() {
        return this.as("weeks");
    };
    moment.duration.fn.asMonths = function() {
        return this.as("M");
    };
    moment.duration.fn.asYears = function() {
        return this.as("y");
    };
    moment.locale("en", {
        ordinalParse: /\d{1,2}(th|st|nd|rd)/,
        ordinal: function(number) {
            var b = number % 10, output = toInt(number % 100 / 10) === 1 ? "th" : b === 1 ? "st" : b === 2 ? "nd" : b === 3 ? "rd" : "th";
            return number + output;
        }
    });
    function makeGlobal(shouldDeprecate) {
        if (typeof ender !== "undefined") {
            return;
        }
        oldGlobalMoment = globalScope.moment;
        if (shouldDeprecate) {
            globalScope.moment = deprecate("Accessing Moment through the global scope is " + "deprecated, and will be removed in an upcoming " + "release.", moment);
        } else {
            globalScope.moment = moment;
        }
    }
    if (hasModule) {
        module.exports = moment;
    } else if (typeof define === "function" && define.amd) {
        define(function(require, exports, module) {
            if (module.config && module.config() && module.config().noGlobal === true) {
                globalScope.moment = oldGlobalMoment;
            }
            return moment;
        });
        makeGlobal(true);
    } else {
        makeGlobal();
    }
}).call(this);

(function(root, factory) {
    "use strict";
    if (typeof define === "function" && define.amd) {
        define([ "moment" ], factory);
    } else if (typeof exports === "object") {
        module.exports = factory(require("moment"));
    } else {
        factory(root.moment);
    }
})(this, function(moment) {
    "use strict";
    if (moment.tz !== undefined) {
        return moment;
    }
    var VERSION = "0.3.0", zones = {}, links = {}, momentVersion = moment.version.split("."), major = +momentVersion[0], minor = +momentVersion[1];
    if (major < 2 || major === 2 && minor < 6) {
        logError("Moment Timezone requires Moment.js >= 2.6.0. You are using Moment.js " + moment.version + ". See momentjs.com");
    }
    function charCodeToInt(charCode) {
        if (charCode > 96) {
            return charCode - 87;
        } else if (charCode > 64) {
            return charCode - 29;
        }
        return charCode - 48;
    }
    function unpackBase60(string) {
        var i = 0, parts = string.split("."), whole = parts[0], fractional = parts[1] || "", multiplier = 1, num, out = 0, sign = 1;
        if (string.charCodeAt(0) === 45) {
            i = 1;
            sign = -1;
        }
        for (i; i < whole.length; i++) {
            num = charCodeToInt(whole.charCodeAt(i));
            out = 60 * out + num;
        }
        for (i = 0; i < fractional.length; i++) {
            multiplier = multiplier / 60;
            num = charCodeToInt(fractional.charCodeAt(i));
            out += num * multiplier;
        }
        return out * sign;
    }
    function arrayToInt(array) {
        for (var i = 0; i < array.length; i++) {
            array[i] = unpackBase60(array[i]);
        }
    }
    function intToUntil(array, length) {
        for (var i = 0; i < length; i++) {
            array[i] = Math.round((array[i - 1] || 0) + array[i] * 6e4);
        }
        array[length - 1] = Infinity;
    }
    function mapIndices(source, indices) {
        var out = [], i;
        for (i = 0; i < indices.length; i++) {
            out[i] = source[indices[i]];
        }
        return out;
    }
    function unpack(string) {
        var data = string.split("|"), offsets = data[2].split(" "), indices = data[3].split(""), untils = data[4].split(" ");
        arrayToInt(offsets);
        arrayToInt(indices);
        arrayToInt(untils);
        intToUntil(untils, indices.length);
        return {
            name: data[0],
            abbrs: mapIndices(data[1].split(" "), indices),
            offsets: mapIndices(offsets, indices),
            untils: untils
        };
    }
    function Zone(packedString) {
        if (packedString) {
            this._set(unpack(packedString));
        }
    }
    Zone.prototype = {
        _set: function(unpacked) {
            this.name = unpacked.name;
            this.abbrs = unpacked.abbrs;
            this.untils = unpacked.untils;
            this.offsets = unpacked.offsets;
        },
        _index: function(timestamp) {
            var target = +timestamp, untils = this.untils, i;
            for (i = 0; i < untils.length; i++) {
                if (target < untils[i]) {
                    return i;
                }
            }
        },
        parse: function(timestamp) {
            var target = +timestamp, offsets = this.offsets, untils = this.untils, max = untils.length - 1, offset, offsetNext, offsetPrev, i;
            for (i = 0; i < max; i++) {
                offset = offsets[i];
                offsetNext = offsets[i + 1];
                offsetPrev = offsets[i ? i - 1 : i];
                if (offset < offsetNext && tz.moveAmbiguousForward) {
                    offset = offsetNext;
                } else if (offset > offsetPrev && tz.moveInvalidForward) {
                    offset = offsetPrev;
                }
                if (target < untils[i] - offset * 6e4) {
                    return offsets[i];
                }
            }
            return offsets[max];
        },
        abbr: function(mom) {
            return this.abbrs[this._index(mom)];
        },
        offset: function(mom) {
            return this.offsets[this._index(mom)];
        }
    };
    function normalizeName(name) {
        return (name || "").toLowerCase().replace(/\//g, "_");
    }
    function addZone(packed) {
        var i, zone, zoneName;
        if (typeof packed === "string") {
            packed = [ packed ];
        }
        for (i = 0; i < packed.length; i++) {
            zone = new Zone(packed[i]);
            zoneName = normalizeName(zone.name);
            zones[zoneName] = zone;
            upgradeLinksToZones(zoneName);
        }
    }
    function getZone(name) {
        return zones[normalizeName(name)] || null;
    }
    function getNames() {
        var i, out = [];
        for (i in zones) {
            if (zones.hasOwnProperty(i) && zones[i]) {
                out.push(zones[i].name);
            }
        }
        return out.sort();
    }
    function addLink(aliases) {
        var i, alias;
        if (typeof aliases === "string") {
            aliases = [ aliases ];
        }
        for (i = 0; i < aliases.length; i++) {
            alias = aliases[i].split("|");
            pushLink(alias[0], alias[1]);
            pushLink(alias[1], alias[0]);
        }
    }
    function upgradeLinksToZones(zoneName) {
        if (!links[zoneName]) {
            return;
        }
        var i, zone = zones[zoneName], linkNames = links[zoneName];
        for (i = 0; i < linkNames.length; i++) {
            copyZoneWithName(zone, linkNames[i]);
        }
        links[zoneName] = null;
    }
    function copyZoneWithName(zone, name) {
        var linkZone = zones[normalizeName(name)] = new Zone();
        linkZone._set(zone);
        linkZone.name = name;
    }
    function pushLink(zoneName, linkName) {
        zoneName = normalizeName(zoneName);
        if (zones[zoneName]) {
            copyZoneWithName(zones[zoneName], linkName);
        } else {
            links[zoneName] = links[zoneName] || [];
            links[zoneName].push(linkName);
        }
    }
    function loadData(data) {
        addZone(data.zones);
        addLink(data.links);
        tz.dataVersion = data.version;
    }
    function zoneExists(name) {
        if (!zoneExists.didShowError) {
            zoneExists.didShowError = true;
            logError("moment.tz.zoneExists('" + name + "') has been deprecated in favor of !moment.tz.zone('" + name + "')");
        }
        return !!getZone(name);
    }
    function needsOffset(m) {
        return !!(m._a && m._tzm === undefined);
    }
    function logError(message) {
        if (typeof console !== "undefined" && typeof console.error === "function") {
            console.error(message);
        }
    }
    function tz(input) {
        var args = Array.prototype.slice.call(arguments, 0, -1), name = arguments[arguments.length - 1], zone = getZone(name), out = moment.utc.apply(null, args);
        if (zone && !moment.isMoment(input) && needsOffset(out)) {
            out.add(zone.parse(out), "minutes");
        }
        out.tz(name);
        return out;
    }
    tz.version = VERSION;
    tz.dataVersion = "";
    tz._zones = zones;
    tz._links = links;
    tz.add = addZone;
    tz.link = addLink;
    tz.load = loadData;
    tz.zone = getZone;
    tz.zoneExists = zoneExists;
    tz.names = getNames;
    tz.Zone = Zone;
    tz.unpack = unpack;
    tz.unpackBase60 = unpackBase60;
    tz.needsOffset = needsOffset;
    tz.moveInvalidForward = true;
    tz.moveAmbiguousForward = false;
    var fn = moment.fn;
    moment.tz = tz;
    moment.defaultZone = null;
    moment.updateOffset = function(mom, keepTime) {
        var offset;
        if (mom._z === undefined) {
            mom._z = moment.defaultZone;
        }
        if (mom._z) {
            offset = mom._z.offset(mom);
            if (Math.abs(offset) < 16) {
                offset = offset / 60;
            }
            if (mom.utcOffset !== undefined) {
                mom.utcOffset(-offset, keepTime);
            } else {
                mom.zone(offset, keepTime);
            }
        }
    };
    fn.tz = function(name) {
        if (name) {
            this._z = getZone(name);
            if (this._z) {
                moment.updateOffset(this);
            } else {
                logError("Moment Timezone has no data for " + name + ". See http://momentjs.com/timezone/docs/#/data-loading/.");
            }
            return this;
        }
        if (this._z) {
            return this._z.name;
        }
    };
    function abbrWrap(old) {
        return function() {
            if (this._z) {
                return this._z.abbr(this);
            }
            return old.call(this);
        };
    }
    function resetZoneWrap(old) {
        return function() {
            this._z = null;
            return old.apply(this, arguments);
        };
    }
    fn.zoneName = abbrWrap(fn.zoneName);
    fn.zoneAbbr = abbrWrap(fn.zoneAbbr);
    fn.utc = resetZoneWrap(fn.utc);
    moment.tz.setDefault = function(name) {
        if (major < 2 || major === 2 && minor < 9) {
            logError("Moment Timezone setDefault() requires Moment.js >= 2.9.0. You are using Moment.js " + moment.version + ".");
        }
        moment.defaultZone = name ? getZone(name) : null;
        return moment;
    };
    var momentProperties = moment.momentProperties;
    if (Object.prototype.toString.call(momentProperties) === "[object Array]") {
        momentProperties.push("_z");
        momentProperties.push("_a");
    } else if (momentProperties) {
        momentProperties._z = null;
    }
    loadData({
        version: "2014j",
        zones: [ "Africa/Abidjan|GMT|0|0|", "Africa/Addis_Ababa|EAT|-30|0|", "Africa/Algiers|CET|-10|0|", "Africa/Bangui|WAT|-10|0|", "Africa/Blantyre|CAT|-20|0|", "Africa/Cairo|EET EEST|-20 -30|0101010101010101010101010101010|1Cby0 Fb0 c10 8n0 8Nd0 gL0 e10 mn0 1o10 jz0 gN0 pb0 1qN0 dX0 e10 xz0 1o10 bb0 e10 An0 1o10 5z0 e10 FX0 1o10 2L0 e10 IL0 1C10 Lz0", "Africa/Casablanca|WET WEST|0 -10|01010101010101010101010101010101010101010|1Cco0 Db0 1zd0 Lz0 1Nf0 wM0 co0 go0 1o00 s00 dA0 vc0 11A0 A00 e00 y00 11A0 uo0 e00 DA0 11A0 rA0 e00 Jc0 WM0 m00 gM0 M00 WM0 jc0 e00 RA0 11A0 dA0 e00 Uo0 11A0 800 gM0 Xc0", "Africa/Ceuta|CET CEST|-10 -20|01010101010101010101010|1BWp0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00", "Africa/Johannesburg|SAST|-20|0|", "Africa/Tripoli|EET CET CEST|-20 -10 -20|0120|1IlA0 TA0 1o00", "Africa/Windhoek|WAST WAT|-20 -10|01010101010101010101010|1C1c0 11B0 1nX0 11B0 1nX0 11B0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1qL0 WN0 1qL0 11B0", "America/Adak|HAST HADT|a0 90|01010101010101010101010|1BR00 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0", "America/Anchorage|AKST AKDT|90 80|01010101010101010101010|1BQX0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0", "America/Anguilla|AST|40|0|", "America/Araguaina|BRT BRST|30 20|010|1IdD0 Lz0", "America/Argentina/Buenos_Aires|ART|30|0|", "America/Asuncion|PYST PYT|30 40|01010101010101010101010|1C430 1a10 1fz0 1a10 1fz0 1cN0 17b0 1ip0 17b0 1ip0 17b0 1ip0 19X0 1fB0 19X0 1fB0 19X0 1ip0 17b0 1ip0 17b0 1ip0", "America/Atikokan|EST|50|0|", "America/Bahia|BRT BRST|30 20|010|1FJf0 Rb0", "America/Bahia_Banderas|MST CDT CST|70 50 60|01212121212121212121212|1C1l0 1nW0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0", "America/Belem|BRT|30|0|", "America/Belize|CST|60|0|", "America/Boa_Vista|AMT|40|0|", "America/Bogota|COT|50|0|", "America/Boise|MST MDT|70 60|01010101010101010101010|1BQV0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0", "America/Campo_Grande|AMST AMT|30 40|01010101010101010101010|1BIr0 1zd0 On0 1zd0 Rb0 1zd0 Lz0 1C10 Lz0 1C10 On0 1zd0 On0 1zd0 On0 1zd0 On0 1C10 Lz0 1C10 Lz0 1C10", "America/Cancun|CST CDT|60 50|01010101010101010101010|1C1k0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0", "America/Caracas|VET|4u|0|", "America/Cayenne|GFT|30|0|", "America/Chicago|CST CDT|60 50|01010101010101010101010|1BQU0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0", "America/Chihuahua|MST MDT|70 60|01010101010101010101010|1C1l0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0", "America/Creston|MST|70|0|", "America/Dawson|PST PDT|80 70|01010101010101010101010|1BQW0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0", "America/Detroit|EST EDT|50 40|01010101010101010101010|1BQT0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0", "America/Eirunepe|AMT ACT|40 50|01|1KLE0", "America/Glace_Bay|AST ADT|40 30|01010101010101010101010|1BQS0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0", "America/Godthab|WGT WGST|30 20|01010101010101010101010|1BWp0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00", "America/Goose_Bay|AST ADT|40 30|01010101010101010101010|1BQQ1 1zb0 Op0 1zcX Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0", "America/Grand_Turk|EST EDT AST|50 40 40|0101010101012|1BQT0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0", "America/Guayaquil|ECT|50|0|", "America/Guyana|GYT|40|0|", "America/Havana|CST CDT|50 40|01010101010101010101010|1BQR0 1wo0 U00 1zc0 U00 1qM0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0", "America/La_Paz|BOT|40|0|", "America/Lima|PET|50|0|", "America/Metlakatla|PST|80|0|", "America/Miquelon|PMST PMDT|30 20|01010101010101010101010|1BQR0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0", "America/Montevideo|UYST UYT|20 30|01010101010101010101010|1BQQ0 1ld0 14n0 1ld0 14n0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 14n0 1ld0 14n0 1ld0 14n0 1o10 11z0 1o10 11z0 1o10", "America/Noronha|FNT|20|0|", "America/North_Dakota/Beulah|MST MDT CST CDT|70 60 60 50|01232323232323232323232|1BQV0 1zb0 Oo0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0", "America/Paramaribo|SRT|30|0|", "America/Port-au-Prince|EST EDT|50 40|0101010101010101010|1GI70 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0", "America/Santa_Isabel|PST PDT|80 70|01010101010101010101010|1C1m0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0", "America/Santiago|CLST CLT|30 40|01010101010101010101010|1C1f0 1fB0 1nX0 G10 1EL0 Op0 1zb0 Rd0 1wn0 Rd0 1wn0 Rd0 1wn0 Rd0 1wn0 Rd0 1zb0 Op0 1zb0 Rd0 1wn0 Rd0", "America/Sao_Paulo|BRST BRT|20 30|01010101010101010101010|1BIq0 1zd0 On0 1zd0 Rb0 1zd0 Lz0 1C10 Lz0 1C10 On0 1zd0 On0 1zd0 On0 1zd0 On0 1C10 Lz0 1C10 Lz0 1C10", "America/Scoresbysund|EGT EGST|10 0|01010101010101010101010|1BWp0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00", "America/St_Johns|NST NDT|3u 2u|01010101010101010101010|1BQPv 1zb0 Op0 1zcX Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0", "Antarctica/Casey|CAST AWST|-b0 -80|0101|1BN30 40P0 KL0", "Antarctica/Davis|DAVT DAVT|-50 -70|0101|1BPw0 3Wn0 KN0", "Antarctica/DumontDUrville|DDUT|-a0|0|", "Antarctica/Macquarie|AEDT MIST|-b0 -b0|01|1C140", "Antarctica/Mawson|MAWT|-50|0|", "Antarctica/McMurdo|NZDT NZST|-d0 -c0|01010101010101010101010|1C120 1a00 1fA0 1a00 1fA0 1cM0 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1cM0 1fA0 1a00 1fA0 1a00", "Antarctica/Rothera|ROTT|30|0|", "Antarctica/Syowa|SYOT|-30|0|", "Antarctica/Troll|UTC CEST|0 -20|01010101010101010101010|1BWp0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00", "Antarctica/Vostok|VOST|-60|0|", "Asia/Aden|AST|-30|0|", "Asia/Almaty|ALMT|-60|0|", "Asia/Amman|EET EEST|-20 -30|010101010101010101010|1BVy0 1qM0 11A0 1o00 11A0 4bX0 Dd0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0", "Asia/Anadyr|ANAT ANAST ANAT|-c0 -c0 -b0|0120|1BWe0 1qN0 WM0", "Asia/Aqtau|AQTT|-50|0|", "Asia/Ashgabat|TMT|-50|0|", "Asia/Baku|AZT AZST|-40 -50|01010101010101010101010|1BWo0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00", "Asia/Bangkok|ICT|-70|0|", "Asia/Beirut|EET EEST|-20 -30|01010101010101010101010|1BWm0 1qL0 WN0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1qL0 WN0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0", "Asia/Bishkek|KGT|-60|0|", "Asia/Brunei|BNT|-80|0|", "Asia/Calcutta|IST|-5u|0|", "Asia/Chita|YAKT YAKST YAKT IRKT|-90 -a0 -a0 -80|01023|1BWh0 1qM0 WM0 8Hz0", "Asia/Choibalsan|CHOT|-80|0|", "Asia/Chongqing|CST|-80|0|", "Asia/Dacca|BDT|-60|0|", "Asia/Damascus|EET EEST|-20 -30|01010101010101010101010|1C0m0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1qL0 WN0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1qL0", "Asia/Dili|TLT|-90|0|", "Asia/Dubai|GST|-40|0|", "Asia/Dushanbe|TJT|-50|0|", "Asia/Gaza|EET EEST|-20 -30|01010101010101010101010|1BVW1 SKX 1xd1 MKX 1AN0 1a00 1fA0 1cL0 1cN0 1cL0 1cN0 1cL0 1fB0 19X0 1fB0 19X0 1fB0 19X0 1fB0 1cL0 1cN0 1cL0", "Asia/Hebron|EET EEST|-20 -30|0101010101010101010101010|1BVy0 Tb0 1xd1 MKX bB0 cn0 1cN0 1a00 1fA0 1cL0 1cN0 1cL0 1cN0 1cL0 1fB0 19X0 1fB0 19X0 1fB0 19X0 1fB0 1cL0 1cN0 1cL0", "Asia/Hong_Kong|HKT|-80|0|", "Asia/Hovd|HOVT|-70|0|", "Asia/Irkutsk|IRKT IRKST IRKT|-80 -90 -90|01020|1BWi0 1qM0 WM0 8Hz0", "Asia/Istanbul|EET EEST|-20 -30|01010101010101010101010|1BWp0 1qM0 Xc0 1qo0 WM0 1qM0 11A0 1o00 1200 1nA0 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00", "Asia/Jakarta|WIB|-70|0|", "Asia/Jayapura|WIT|-90|0|", "Asia/Jerusalem|IST IDT|-20 -30|01010101010101010101010|1BVA0 17X0 1kp0 1dz0 1c10 1aL0 1eN0 1oL0 10N0 1oL0 10N0 1oL0 10N0 1rz0 W10 1rz0 W10 1rz0 10N0 1oL0 10N0 1oL0", "Asia/Kabul|AFT|-4u|0|", "Asia/Kamchatka|PETT PETST PETT|-c0 -c0 -b0|0120|1BWe0 1qN0 WM0", "Asia/Karachi|PKT|-50|0|", "Asia/Kashgar|XJT|-60|0|", "Asia/Kathmandu|NPT|-5J|0|", "Asia/Khandyga|VLAT VLAST VLAT YAKT YAKT|-a0 -b0 -b0 -a0 -90|010234|1BWg0 1qM0 WM0 17V0 7zD0", "Asia/Krasnoyarsk|KRAT KRAST KRAT|-70 -80 -80|01020|1BWj0 1qM0 WM0 8Hz0", "Asia/Kuala_Lumpur|MYT|-80|0|", "Asia/Magadan|MAGT MAGST MAGT MAGT|-b0 -c0 -c0 -a0|01023|1BWf0 1qM0 WM0 8Hz0", "Asia/Makassar|WITA|-80|0|", "Asia/Manila|PHT|-80|0|", "Asia/Nicosia|EET EEST|-20 -30|01010101010101010101010|1BWp0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00", "Asia/Novokuznetsk|KRAT NOVST NOVT NOVT|-70 -70 -60 -70|01230|1BWj0 1qN0 WM0 8Hz0", "Asia/Novosibirsk|NOVT NOVST NOVT|-60 -70 -70|01020|1BWk0 1qM0 WM0 8Hz0", "Asia/Omsk|OMST OMSST OMST|-60 -70 -70|01020|1BWk0 1qM0 WM0 8Hz0", "Asia/Oral|ORAT|-50|0|", "Asia/Pyongyang|KST|-90|0|", "Asia/Qyzylorda|QYZT|-60|0|", "Asia/Rangoon|MMT|-6u|0|", "Asia/Sakhalin|SAKT SAKST SAKT|-a0 -b0 -b0|01020|1BWg0 1qM0 WM0 8Hz0", "Asia/Samarkand|UZT|-50|0|", "Asia/Singapore|SGT|-80|0|", "Asia/Srednekolymsk|MAGT MAGST MAGT SRET|-b0 -c0 -c0 -b0|01023|1BWf0 1qM0 WM0 8Hz0", "Asia/Tbilisi|GET|-40|0|", "Asia/Tehran|IRST IRDT|-3u -4u|01010101010101010101010|1BTUu 1dz0 1cp0 1dz0 1cp0 1dz0 1cN0 1dz0 1cp0 1dz0 1cp0 1dz0 1cp0 1dz0 1cN0 1dz0 1cp0 1dz0 1cp0 1dz0 1cp0 1dz0", "Asia/Thimbu|BTT|-60|0|", "Asia/Tokyo|JST|-90|0|", "Asia/Ulaanbaatar|ULAT|-80|0|", "Asia/Ust-Nera|MAGT MAGST MAGT VLAT VLAT|-b0 -c0 -c0 -b0 -a0|010234|1BWf0 1qM0 WM0 17V0 7zD0", "Asia/Vladivostok|VLAT VLAST VLAT|-a0 -b0 -b0|01020|1BWg0 1qM0 WM0 8Hz0", "Asia/Yakutsk|YAKT YAKST YAKT|-90 -a0 -a0|01020|1BWh0 1qM0 WM0 8Hz0", "Asia/Yekaterinburg|YEKT YEKST YEKT|-50 -60 -60|01020|1BWl0 1qM0 WM0 8Hz0", "Asia/Yerevan|AMT AMST|-40 -50|01010|1BWm0 1qM0 WM0 1qM0", "Atlantic/Azores|AZOT AZOST|10 0|01010101010101010101010|1BWp0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00", "Atlantic/Canary|WET WEST|0 -10|01010101010101010101010|1BWp0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00", "Atlantic/Cape_Verde|CVT|10|0|", "Atlantic/South_Georgia|GST|20|0|", "Atlantic/Stanley|FKST FKT|30 40|010|1C6R0 U10", "Australia/ACT|AEDT AEST|-b0 -a0|01010101010101010101010|1C140 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0", "Australia/Adelaide|ACDT ACST|-au -9u|01010101010101010101010|1C14u 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0", "Australia/Brisbane|AEST|-a0|0|", "Australia/Darwin|ACST|-9u|0|", "Australia/Eucla|ACWST|-8J|0|", "Australia/LHI|LHDT LHST|-b0 -au|01010101010101010101010|1C130 1cMu 1cLu 1cMu 1cLu 1fAu 1cLu 1cMu 1cLu 1cMu 1cLu 1cMu 1cLu 1cMu 1cLu 1cMu 1cLu 1fAu 1cLu 1cMu 1cLu 1cMu", "Australia/Perth|AWST|-80|0|", "Chile/EasterIsland|EASST EAST|50 60|01010101010101010101010|1C1f0 1fB0 1nX0 G10 1EL0 Op0 1zb0 Rd0 1wn0 Rd0 1wn0 Rd0 1wn0 Rd0 1wn0 Rd0 1zb0 Op0 1zb0 Rd0 1wn0 Rd0", "Eire|GMT IST|0 -10|01010101010101010101010|1BWp0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00", "Etc/GMT+1|GMT+1|10|0|", "Etc/GMT+10|GMT+10|a0|0|", "Etc/GMT+11|GMT+11|b0|0|", "Etc/GMT+12|GMT+12|c0|0|", "Etc/GMT+2|GMT+2|20|0|", "Etc/GMT+3|GMT+3|30|0|", "Etc/GMT+4|GMT+4|40|0|", "Etc/GMT+5|GMT+5|50|0|", "Etc/GMT+6|GMT+6|60|0|", "Etc/GMT+7|GMT+7|70|0|", "Etc/GMT+8|GMT+8|80|0|", "Etc/GMT+9|GMT+9|90|0|", "Etc/GMT-1|GMT-1|-10|0|", "Etc/GMT-10|GMT-10|-a0|0|", "Etc/GMT-11|GMT-11|-b0|0|", "Etc/GMT-12|GMT-12|-c0|0|", "Etc/GMT-13|GMT-13|-d0|0|", "Etc/GMT-14|GMT-14|-e0|0|", "Etc/GMT-2|GMT-2|-20|0|", "Etc/GMT-3|GMT-3|-30|0|", "Etc/GMT-4|GMT-4|-40|0|", "Etc/GMT-5|GMT-5|-50|0|", "Etc/GMT-6|GMT-6|-60|0|", "Etc/GMT-7|GMT-7|-70|0|", "Etc/GMT-8|GMT-8|-80|0|", "Etc/GMT-9|GMT-9|-90|0|", "Etc/UCT|UCT|0|0|", "Etc/UTC|UTC|0|0|", "Europe/Belfast|GMT BST|0 -10|01010101010101010101010|1BWp0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00", "Europe/Kaliningrad|EET EEST FET|-20 -30 -30|01020|1BWo0 1qM0 WM0 8Hz0", "Europe/Minsk|EET EEST FET MSK|-20 -30 -30 -30|01023|1BWo0 1qM0 WM0 8Hy0", "Europe/Moscow|MSK MSD MSK|-30 -40 -40|01020|1BWn0 1qM0 WM0 8Hz0", "Europe/Samara|SAMT SAMST SAMT|-40 -40 -30|0120|1BWm0 1qN0 WM0", "Europe/Simferopol|EET EEST MSK MSK|-20 -30 -40 -30|01010101023|1BWp0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11z0 1nW0", "Europe/Volgograd|MSK MSK|-30 -40|01010|1BWn0 1qM0 WM0 8Hz0", "HST|HST|a0|0|", "Indian/Chagos|IOT|-60|0|", "Indian/Christmas|CXT|-70|0|", "Indian/Cocos|CCT|-6u|0|", "Indian/Kerguelen|TFT|-50|0|", "Indian/Mahe|SCT|-40|0|", "Indian/Maldives|MVT|-50|0|", "Indian/Mauritius|MUT|-40|0|", "Indian/Reunion|RET|-40|0|", "Kwajalein|MHT|-c0|0|", "MET|MET MEST|-10 -20|01010101010101010101010|1BWp0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00", "NZ-CHAT|CHADT CHAST|-dJ -cJ|01010101010101010101010|1C120 1a00 1fA0 1a00 1fA0 1cM0 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1cM0 1fA0 1a00 1fA0 1a00", "Pacific/Apia|SST SDT WSDT WSST|b0 a0 -e0 -d0|01012323232323232323232|1Dbn0 1ff0 1a00 CI0 AQ0 1cM0 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1cM0 1fA0 1a00 1fA0 1a00", "Pacific/Bougainville|PGT BST|-a0 -b0|01|1NwE0", "Pacific/Chuuk|CHUT|-a0|0|", "Pacific/Efate|VUT|-b0|0|", "Pacific/Enderbury|PHOT|-d0|0|", "Pacific/Fakaofo|TKT TKT|b0 -d0|01|1Gfn0", "Pacific/Fiji|FJST FJT|-d0 -c0|01010101010101010101010|1BWe0 1o00 Rc0 1wo0 Ao0 1Nc0 Ao0 1Q00 xz0 1SN0 uM0 1SM0 xA0 1SM0 uM0 1SM0 uM0 1SM0 uM0 1SM0 uM0 1SM0", "Pacific/Funafuti|TVT|-c0|0|", "Pacific/Galapagos|GALT|60|0|", "Pacific/Gambier|GAMT|90|0|", "Pacific/Guadalcanal|SBT|-b0|0|", "Pacific/Guam|ChST|-a0|0|", "Pacific/Kiritimati|LINT|-e0|0|", "Pacific/Kosrae|KOST|-b0|0|", "Pacific/Marquesas|MART|9u|0|", "Pacific/Midway|SST|b0|0|", "Pacific/Nauru|NRT|-c0|0|", "Pacific/Niue|NUT|b0|0|", "Pacific/Norfolk|NFT|-bu|0|", "Pacific/Noumea|NCT|-b0|0|", "Pacific/Palau|PWT|-90|0|", "Pacific/Pohnpei|PONT|-b0|0|", "Pacific/Port_Moresby|PGT|-a0|0|", "Pacific/Rarotonga|CKT|a0|0|", "Pacific/Tahiti|TAHT|a0|0|", "Pacific/Tarawa|GILT|-c0|0|", "Pacific/Tongatapu|TOT|-d0|0|", "Pacific/Wake|WAKT|-c0|0|", "Pacific/Wallis|WFT|-c0|0|" ],
        links: [ "Africa/Abidjan|Africa/Accra", "Africa/Abidjan|Africa/Bamako", "Africa/Abidjan|Africa/Banjul", "Africa/Abidjan|Africa/Bissau", "Africa/Abidjan|Africa/Conakry", "Africa/Abidjan|Africa/Dakar", "Africa/Abidjan|Africa/Freetown", "Africa/Abidjan|Africa/Lome", "Africa/Abidjan|Africa/Monrovia", "Africa/Abidjan|Africa/Nouakchott", "Africa/Abidjan|Africa/Ouagadougou", "Africa/Abidjan|Africa/Sao_Tome", "Africa/Abidjan|Africa/Timbuktu", "Africa/Abidjan|America/Danmarkshavn", "Africa/Abidjan|Atlantic/Reykjavik", "Africa/Abidjan|Atlantic/St_Helena", "Africa/Abidjan|Etc/GMT", "Africa/Abidjan|Etc/GMT+0", "Africa/Abidjan|Etc/GMT-0", "Africa/Abidjan|Etc/GMT0", "Africa/Abidjan|Etc/Greenwich", "Africa/Abidjan|GMT", "Africa/Abidjan|GMT+0", "Africa/Abidjan|GMT-0", "Africa/Abidjan|GMT0", "Africa/Abidjan|Greenwich", "Africa/Abidjan|Iceland", "Africa/Addis_Ababa|Africa/Asmara", "Africa/Addis_Ababa|Africa/Asmera", "Africa/Addis_Ababa|Africa/Dar_es_Salaam", "Africa/Addis_Ababa|Africa/Djibouti", "Africa/Addis_Ababa|Africa/Juba", "Africa/Addis_Ababa|Africa/Kampala", "Africa/Addis_Ababa|Africa/Khartoum", "Africa/Addis_Ababa|Africa/Mogadishu", "Africa/Addis_Ababa|Africa/Nairobi", "Africa/Addis_Ababa|Indian/Antananarivo", "Africa/Addis_Ababa|Indian/Comoro", "Africa/Addis_Ababa|Indian/Mayotte", "Africa/Algiers|Africa/Tunis", "Africa/Bangui|Africa/Brazzaville", "Africa/Bangui|Africa/Douala", "Africa/Bangui|Africa/Kinshasa", "Africa/Bangui|Africa/Lagos", "Africa/Bangui|Africa/Libreville", "Africa/Bangui|Africa/Luanda", "Africa/Bangui|Africa/Malabo", "Africa/Bangui|Africa/Ndjamena", "Africa/Bangui|Africa/Niamey", "Africa/Bangui|Africa/Porto-Novo", "Africa/Blantyre|Africa/Bujumbura", "Africa/Blantyre|Africa/Gaborone", "Africa/Blantyre|Africa/Harare", "Africa/Blantyre|Africa/Kigali", "Africa/Blantyre|Africa/Lubumbashi", "Africa/Blantyre|Africa/Lusaka", "Africa/Blantyre|Africa/Maputo", "Africa/Cairo|Egypt", "Africa/Casablanca|Africa/El_Aaiun", "Africa/Ceuta|Arctic/Longyearbyen", "Africa/Ceuta|Atlantic/Jan_Mayen", "Africa/Ceuta|CET", "Africa/Ceuta|Europe/Amsterdam", "Africa/Ceuta|Europe/Andorra", "Africa/Ceuta|Europe/Belgrade", "Africa/Ceuta|Europe/Berlin", "Africa/Ceuta|Europe/Bratislava", "Africa/Ceuta|Europe/Brussels", "Africa/Ceuta|Europe/Budapest", "Africa/Ceuta|Europe/Busingen", "Africa/Ceuta|Europe/Copenhagen", "Africa/Ceuta|Europe/Gibraltar", "Africa/Ceuta|Europe/Ljubljana", "Africa/Ceuta|Europe/Luxembourg", "Africa/Ceuta|Europe/Madrid", "Africa/Ceuta|Europe/Malta", "Africa/Ceuta|Europe/Monaco", "Africa/Ceuta|Europe/Oslo", "Africa/Ceuta|Europe/Paris", "Africa/Ceuta|Europe/Podgorica", "Africa/Ceuta|Europe/Prague", "Africa/Ceuta|Europe/Rome", "Africa/Ceuta|Europe/San_Marino", "Africa/Ceuta|Europe/Sarajevo", "Africa/Ceuta|Europe/Skopje", "Africa/Ceuta|Europe/Stockholm", "Africa/Ceuta|Europe/Tirane", "Africa/Ceuta|Europe/Vaduz", "Africa/Ceuta|Europe/Vatican", "Africa/Ceuta|Europe/Vienna", "Africa/Ceuta|Europe/Warsaw", "Africa/Ceuta|Europe/Zagreb", "Africa/Ceuta|Europe/Zurich", "Africa/Ceuta|Poland", "Africa/Johannesburg|Africa/Maseru", "Africa/Johannesburg|Africa/Mbabane", "Africa/Tripoli|Libya", "America/Adak|America/Atka", "America/Adak|US/Aleutian", "America/Anchorage|America/Juneau", "America/Anchorage|America/Nome", "America/Anchorage|America/Sitka", "America/Anchorage|America/Yakutat", "America/Anchorage|US/Alaska", "America/Anguilla|America/Antigua", "America/Anguilla|America/Aruba", "America/Anguilla|America/Barbados", "America/Anguilla|America/Blanc-Sablon", "America/Anguilla|America/Curacao", "America/Anguilla|America/Dominica", "America/Anguilla|America/Grenada", "America/Anguilla|America/Guadeloupe", "America/Anguilla|America/Kralendijk", "America/Anguilla|America/Lower_Princes", "America/Anguilla|America/Marigot", "America/Anguilla|America/Martinique", "America/Anguilla|America/Montserrat", "America/Anguilla|America/Port_of_Spain", "America/Anguilla|America/Puerto_Rico", "America/Anguilla|America/Santo_Domingo", "America/Anguilla|America/St_Barthelemy", "America/Anguilla|America/St_Kitts", "America/Anguilla|America/St_Lucia", "America/Anguilla|America/St_Thomas", "America/Anguilla|America/St_Vincent", "America/Anguilla|America/Tortola", "America/Anguilla|America/Virgin", "America/Argentina/Buenos_Aires|America/Argentina/Catamarca", "America/Argentina/Buenos_Aires|America/Argentina/ComodRivadavia", "America/Argentina/Buenos_Aires|America/Argentina/Cordoba", "America/Argentina/Buenos_Aires|America/Argentina/Jujuy", "America/Argentina/Buenos_Aires|America/Argentina/La_Rioja", "America/Argentina/Buenos_Aires|America/Argentina/Mendoza", "America/Argentina/Buenos_Aires|America/Argentina/Rio_Gallegos", "America/Argentina/Buenos_Aires|America/Argentina/Salta", "America/Argentina/Buenos_Aires|America/Argentina/San_Juan", "America/Argentina/Buenos_Aires|America/Argentina/San_Luis", "America/Argentina/Buenos_Aires|America/Argentina/Tucuman", "America/Argentina/Buenos_Aires|America/Argentina/Ushuaia", "America/Argentina/Buenos_Aires|America/Buenos_Aires", "America/Argentina/Buenos_Aires|America/Catamarca", "America/Argentina/Buenos_Aires|America/Cordoba", "America/Argentina/Buenos_Aires|America/Jujuy", "America/Argentina/Buenos_Aires|America/Mendoza", "America/Argentina/Buenos_Aires|America/Rosario", "America/Atikokan|America/Cayman", "America/Atikokan|America/Coral_Harbour", "America/Atikokan|America/Jamaica", "America/Atikokan|America/Panama", "America/Atikokan|EST", "America/Atikokan|Jamaica", "America/Belem|America/Fortaleza", "America/Belem|America/Maceio", "America/Belem|America/Recife", "America/Belem|America/Santarem", "America/Belize|America/Costa_Rica", "America/Belize|America/El_Salvador", "America/Belize|America/Guatemala", "America/Belize|America/Managua", "America/Belize|America/Regina", "America/Belize|America/Swift_Current", "America/Belize|America/Tegucigalpa", "America/Belize|Canada/East-Saskatchewan", "America/Belize|Canada/Saskatchewan", "America/Boa_Vista|America/Manaus", "America/Boa_Vista|America/Porto_Velho", "America/Boa_Vista|Brazil/West", "America/Boise|America/Cambridge_Bay", "America/Boise|America/Denver", "America/Boise|America/Edmonton", "America/Boise|America/Inuvik", "America/Boise|America/Ojinaga", "America/Boise|America/Shiprock", "America/Boise|America/Yellowknife", "America/Boise|Canada/Mountain", "America/Boise|MST7MDT", "America/Boise|Navajo", "America/Boise|US/Mountain", "America/Campo_Grande|America/Cuiaba", "America/Cancun|America/Merida", "America/Cancun|America/Mexico_City", "America/Cancun|America/Monterrey", "America/Cancun|Mexico/General", "America/Chicago|America/Indiana/Knox", "America/Chicago|America/Indiana/Tell_City", "America/Chicago|America/Knox_IN", "America/Chicago|America/Matamoros", "America/Chicago|America/Menominee", "America/Chicago|America/North_Dakota/Center", "America/Chicago|America/North_Dakota/New_Salem", "America/Chicago|America/Rainy_River", "America/Chicago|America/Rankin_Inlet", "America/Chicago|America/Resolute", "America/Chicago|America/Winnipeg", "America/Chicago|CST6CDT", "America/Chicago|Canada/Central", "America/Chicago|US/Central", "America/Chicago|US/Indiana-Starke", "America/Chihuahua|America/Mazatlan", "America/Chihuahua|Mexico/BajaSur", "America/Creston|America/Dawson_Creek", "America/Creston|America/Hermosillo", "America/Creston|America/Phoenix", "America/Creston|MST", "America/Creston|US/Arizona", "America/Dawson|America/Ensenada", "America/Dawson|America/Los_Angeles", "America/Dawson|America/Tijuana", "America/Dawson|America/Vancouver", "America/Dawson|America/Whitehorse", "America/Dawson|Canada/Pacific", "America/Dawson|Canada/Yukon", "America/Dawson|Mexico/BajaNorte", "America/Dawson|PST8PDT", "America/Dawson|US/Pacific", "America/Dawson|US/Pacific-New", "America/Detroit|America/Fort_Wayne", "America/Detroit|America/Indiana/Indianapolis", "America/Detroit|America/Indiana/Marengo", "America/Detroit|America/Indiana/Petersburg", "America/Detroit|America/Indiana/Vevay", "America/Detroit|America/Indiana/Vincennes", "America/Detroit|America/Indiana/Winamac", "America/Detroit|America/Indianapolis", "America/Detroit|America/Iqaluit", "America/Detroit|America/Kentucky/Louisville", "America/Detroit|America/Kentucky/Monticello", "America/Detroit|America/Louisville", "America/Detroit|America/Montreal", "America/Detroit|America/Nassau", "America/Detroit|America/New_York", "America/Detroit|America/Nipigon", "America/Detroit|America/Pangnirtung", "America/Detroit|America/Thunder_Bay", "America/Detroit|America/Toronto", "America/Detroit|Canada/Eastern", "America/Detroit|EST5EDT", "America/Detroit|US/East-Indiana", "America/Detroit|US/Eastern", "America/Detroit|US/Michigan", "America/Eirunepe|America/Porto_Acre", "America/Eirunepe|America/Rio_Branco", "America/Eirunepe|Brazil/Acre", "America/Glace_Bay|America/Halifax", "America/Glace_Bay|America/Moncton", "America/Glace_Bay|America/Thule", "America/Glace_Bay|Atlantic/Bermuda", "America/Glace_Bay|Canada/Atlantic", "America/Havana|Cuba", "America/Metlakatla|Pacific/Pitcairn", "America/Noronha|Brazil/DeNoronha", "America/Santiago|Antarctica/Palmer", "America/Santiago|Chile/Continental", "America/Sao_Paulo|Brazil/East", "America/St_Johns|Canada/Newfoundland", "Antarctica/McMurdo|Antarctica/South_Pole", "Antarctica/McMurdo|NZ", "Antarctica/McMurdo|Pacific/Auckland", "Asia/Aden|Asia/Baghdad", "Asia/Aden|Asia/Bahrain", "Asia/Aden|Asia/Kuwait", "Asia/Aden|Asia/Qatar", "Asia/Aden|Asia/Riyadh", "Asia/Aqtau|Asia/Aqtobe", "Asia/Ashgabat|Asia/Ashkhabad", "Asia/Bangkok|Asia/Ho_Chi_Minh", "Asia/Bangkok|Asia/Phnom_Penh", "Asia/Bangkok|Asia/Saigon", "Asia/Bangkok|Asia/Vientiane", "Asia/Calcutta|Asia/Colombo", "Asia/Calcutta|Asia/Kolkata", "Asia/Chongqing|Asia/Chungking", "Asia/Chongqing|Asia/Harbin", "Asia/Chongqing|Asia/Macao", "Asia/Chongqing|Asia/Macau", "Asia/Chongqing|Asia/Shanghai", "Asia/Chongqing|Asia/Taipei", "Asia/Chongqing|PRC", "Asia/Chongqing|ROC", "Asia/Dacca|Asia/Dhaka", "Asia/Dubai|Asia/Muscat", "Asia/Hong_Kong|Hongkong", "Asia/Istanbul|Europe/Istanbul", "Asia/Istanbul|Turkey", "Asia/Jakarta|Asia/Pontianak", "Asia/Jerusalem|Asia/Tel_Aviv", "Asia/Jerusalem|Israel", "Asia/Kashgar|Asia/Urumqi", "Asia/Kathmandu|Asia/Katmandu", "Asia/Kuala_Lumpur|Asia/Kuching", "Asia/Makassar|Asia/Ujung_Pandang", "Asia/Nicosia|EET", "Asia/Nicosia|Europe/Athens", "Asia/Nicosia|Europe/Bucharest", "Asia/Nicosia|Europe/Chisinau", "Asia/Nicosia|Europe/Helsinki", "Asia/Nicosia|Europe/Kiev", "Asia/Nicosia|Europe/Mariehamn", "Asia/Nicosia|Europe/Nicosia", "Asia/Nicosia|Europe/Riga", "Asia/Nicosia|Europe/Sofia", "Asia/Nicosia|Europe/Tallinn", "Asia/Nicosia|Europe/Tiraspol", "Asia/Nicosia|Europe/Uzhgorod", "Asia/Nicosia|Europe/Vilnius", "Asia/Nicosia|Europe/Zaporozhye", "Asia/Pyongyang|Asia/Seoul", "Asia/Pyongyang|ROK", "Asia/Samarkand|Asia/Tashkent", "Asia/Singapore|Singapore", "Asia/Tehran|Iran", "Asia/Thimbu|Asia/Thimphu", "Asia/Tokyo|Japan", "Asia/Ulaanbaatar|Asia/Ulan_Bator", "Atlantic/Canary|Atlantic/Faeroe", "Atlantic/Canary|Atlantic/Faroe", "Atlantic/Canary|Atlantic/Madeira", "Atlantic/Canary|Europe/Lisbon", "Atlantic/Canary|Portugal", "Atlantic/Canary|WET", "Australia/ACT|Australia/Canberra", "Australia/ACT|Australia/Currie", "Australia/ACT|Australia/Hobart", "Australia/ACT|Australia/Melbourne", "Australia/ACT|Australia/NSW", "Australia/ACT|Australia/Sydney", "Australia/ACT|Australia/Tasmania", "Australia/ACT|Australia/Victoria", "Australia/Adelaide|Australia/Broken_Hill", "Australia/Adelaide|Australia/South", "Australia/Adelaide|Australia/Yancowinna", "Australia/Brisbane|Australia/Lindeman", "Australia/Brisbane|Australia/Queensland", "Australia/Darwin|Australia/North", "Australia/LHI|Australia/Lord_Howe", "Australia/Perth|Australia/West", "Chile/EasterIsland|Pacific/Easter", "Eire|Europe/Dublin", "Etc/UCT|UCT", "Etc/UTC|Etc/Universal", "Etc/UTC|Etc/Zulu", "Etc/UTC|UTC", "Etc/UTC|Universal", "Etc/UTC|Zulu", "Europe/Belfast|Europe/Guernsey", "Europe/Belfast|Europe/Isle_of_Man", "Europe/Belfast|Europe/Jersey", "Europe/Belfast|Europe/London", "Europe/Belfast|GB", "Europe/Belfast|GB-Eire", "Europe/Moscow|W-SU", "HST|Pacific/Honolulu", "HST|Pacific/Johnston", "HST|US/Hawaii", "Kwajalein|Pacific/Kwajalein", "Kwajalein|Pacific/Majuro", "NZ-CHAT|Pacific/Chatham", "Pacific/Chuuk|Pacific/Truk", "Pacific/Chuuk|Pacific/Yap", "Pacific/Guam|Pacific/Saipan", "Pacific/Midway|Pacific/Pago_Pago", "Pacific/Midway|Pacific/Samoa", "Pacific/Midway|US/Samoa", "Pacific/Pohnpei|Pacific/Ponape" ]
    });
    return moment;
});

(function(root, factory) {
    "use strict";
    if (typeof define === "function" && define.amd) {
        define([ "moment" ], factory);
    } else if (typeof exports === "object") {
        module.exports = factory(require("moment"));
    } else {
        factory(root.moment);
    }
})(this, function(moment) {
    "use strict";
    if (moment.tz !== undefined) {
        return moment;
    }
    var VERSION = "0.3.0", zones = {}, links = {}, momentVersion = moment.version.split("."), major = +momentVersion[0], minor = +momentVersion[1];
    if (major < 2 || major === 2 && minor < 6) {
        logError("Moment Timezone requires Moment.js >= 2.6.0. You are using Moment.js " + moment.version + ". See momentjs.com");
    }
    function charCodeToInt(charCode) {
        if (charCode > 96) {
            return charCode - 87;
        } else if (charCode > 64) {
            return charCode - 29;
        }
        return charCode - 48;
    }
    function unpackBase60(string) {
        var i = 0, parts = string.split("."), whole = parts[0], fractional = parts[1] || "", multiplier = 1, num, out = 0, sign = 1;
        if (string.charCodeAt(0) === 45) {
            i = 1;
            sign = -1;
        }
        for (i; i < whole.length; i++) {
            num = charCodeToInt(whole.charCodeAt(i));
            out = 60 * out + num;
        }
        for (i = 0; i < fractional.length; i++) {
            multiplier = multiplier / 60;
            num = charCodeToInt(fractional.charCodeAt(i));
            out += num * multiplier;
        }
        return out * sign;
    }
    function arrayToInt(array) {
        for (var i = 0; i < array.length; i++) {
            array[i] = unpackBase60(array[i]);
        }
    }
    function intToUntil(array, length) {
        for (var i = 0; i < length; i++) {
            array[i] = Math.round((array[i - 1] || 0) + array[i] * 6e4);
        }
        array[length - 1] = Infinity;
    }
    function mapIndices(source, indices) {
        var out = [], i;
        for (i = 0; i < indices.length; i++) {
            out[i] = source[indices[i]];
        }
        return out;
    }
    function unpack(string) {
        var data = string.split("|"), offsets = data[2].split(" "), indices = data[3].split(""), untils = data[4].split(" ");
        arrayToInt(offsets);
        arrayToInt(indices);
        arrayToInt(untils);
        intToUntil(untils, indices.length);
        return {
            name: data[0],
            abbrs: mapIndices(data[1].split(" "), indices),
            offsets: mapIndices(offsets, indices),
            untils: untils
        };
    }
    function Zone(packedString) {
        if (packedString) {
            this._set(unpack(packedString));
        }
    }
    Zone.prototype = {
        _set: function(unpacked) {
            this.name = unpacked.name;
            this.abbrs = unpacked.abbrs;
            this.untils = unpacked.untils;
            this.offsets = unpacked.offsets;
        },
        _index: function(timestamp) {
            var target = +timestamp, untils = this.untils, i;
            for (i = 0; i < untils.length; i++) {
                if (target < untils[i]) {
                    return i;
                }
            }
        },
        parse: function(timestamp) {
            var target = +timestamp, offsets = this.offsets, untils = this.untils, max = untils.length - 1, offset, offsetNext, offsetPrev, i;
            for (i = 0; i < max; i++) {
                offset = offsets[i];
                offsetNext = offsets[i + 1];
                offsetPrev = offsets[i ? i - 1 : i];
                if (offset < offsetNext && tz.moveAmbiguousForward) {
                    offset = offsetNext;
                } else if (offset > offsetPrev && tz.moveInvalidForward) {
                    offset = offsetPrev;
                }
                if (target < untils[i] - offset * 6e4) {
                    return offsets[i];
                }
            }
            return offsets[max];
        },
        abbr: function(mom) {
            return this.abbrs[this._index(mom)];
        },
        offset: function(mom) {
            return this.offsets[this._index(mom)];
        }
    };
    function normalizeName(name) {
        return (name || "").toLowerCase().replace(/\//g, "_");
    }
    function addZone(packed) {
        var i, zone, zoneName;
        if (typeof packed === "string") {
            packed = [ packed ];
        }
        for (i = 0; i < packed.length; i++) {
            zone = new Zone(packed[i]);
            zoneName = normalizeName(zone.name);
            zones[zoneName] = zone;
            upgradeLinksToZones(zoneName);
        }
    }
    function getZone(name) {
        return zones[normalizeName(name)] || null;
    }
    function getNames() {
        var i, out = [];
        for (i in zones) {
            if (zones.hasOwnProperty(i) && zones[i]) {
                out.push(zones[i].name);
            }
        }
        return out.sort();
    }
    function addLink(aliases) {
        var i, alias;
        if (typeof aliases === "string") {
            aliases = [ aliases ];
        }
        for (i = 0; i < aliases.length; i++) {
            alias = aliases[i].split("|");
            pushLink(alias[0], alias[1]);
            pushLink(alias[1], alias[0]);
        }
    }
    function upgradeLinksToZones(zoneName) {
        if (!links[zoneName]) {
            return;
        }
        var i, zone = zones[zoneName], linkNames = links[zoneName];
        for (i = 0; i < linkNames.length; i++) {
            copyZoneWithName(zone, linkNames[i]);
        }
        links[zoneName] = null;
    }
    function copyZoneWithName(zone, name) {
        var linkZone = zones[normalizeName(name)] = new Zone();
        linkZone._set(zone);
        linkZone.name = name;
    }
    function pushLink(zoneName, linkName) {
        zoneName = normalizeName(zoneName);
        if (zones[zoneName]) {
            copyZoneWithName(zones[zoneName], linkName);
        } else {
            links[zoneName] = links[zoneName] || [];
            links[zoneName].push(linkName);
        }
    }
    function loadData(data) {
        addZone(data.zones);
        addLink(data.links);
        tz.dataVersion = data.version;
    }
    function zoneExists(name) {
        if (!zoneExists.didShowError) {
            zoneExists.didShowError = true;
            logError("moment.tz.zoneExists('" + name + "') has been deprecated in favor of !moment.tz.zone('" + name + "')");
        }
        return !!getZone(name);
    }
    function needsOffset(m) {
        return !!(m._a && m._tzm === undefined);
    }
    function logError(message) {
        if (typeof console !== "undefined" && typeof console.error === "function") {
            console.error(message);
        }
    }
    function tz(input) {
        var args = Array.prototype.slice.call(arguments, 0, -1), name = arguments[arguments.length - 1], zone = getZone(name), out = moment.utc.apply(null, args);
        if (zone && !moment.isMoment(input) && needsOffset(out)) {
            out.add(zone.parse(out), "minutes");
        }
        out.tz(name);
        return out;
    }
    tz.version = VERSION;
    tz.dataVersion = "";
    tz._zones = zones;
    tz._links = links;
    tz.add = addZone;
    tz.link = addLink;
    tz.load = loadData;
    tz.zone = getZone;
    tz.zoneExists = zoneExists;
    tz.names = getNames;
    tz.Zone = Zone;
    tz.unpack = unpack;
    tz.unpackBase60 = unpackBase60;
    tz.needsOffset = needsOffset;
    tz.moveInvalidForward = true;
    tz.moveAmbiguousForward = false;
    var fn = moment.fn;
    moment.tz = tz;
    moment.defaultZone = null;
    moment.updateOffset = function(mom, keepTime) {
        var offset;
        if (mom._z === undefined) {
            mom._z = moment.defaultZone;
        }
        if (mom._z) {
            offset = mom._z.offset(mom);
            if (Math.abs(offset) < 16) {
                offset = offset / 60;
            }
            if (mom.utcOffset !== undefined) {
                mom.utcOffset(-offset, keepTime);
            } else {
                mom.zone(offset, keepTime);
            }
        }
    };
    fn.tz = function(name) {
        if (name) {
            this._z = getZone(name);
            if (this._z) {
                moment.updateOffset(this);
            } else {
                logError("Moment Timezone has no data for " + name + ". See http://momentjs.com/timezone/docs/#/data-loading/.");
            }
            return this;
        }
        if (this._z) {
            return this._z.name;
        }
    };
    function abbrWrap(old) {
        return function() {
            if (this._z) {
                return this._z.abbr(this);
            }
            return old.call(this);
        };
    }
    function resetZoneWrap(old) {
        return function() {
            this._z = null;
            return old.apply(this, arguments);
        };
    }
    fn.zoneName = abbrWrap(fn.zoneName);
    fn.zoneAbbr = abbrWrap(fn.zoneAbbr);
    fn.utc = resetZoneWrap(fn.utc);
    moment.tz.setDefault = function(name) {
        if (major < 2 || major === 2 && minor < 9) {
            logError("Moment Timezone setDefault() requires Moment.js >= 2.9.0. You are using Moment.js " + moment.version + ".");
        }
        moment.defaultZone = name ? getZone(name) : null;
        return moment;
    };
    var momentProperties = moment.momentProperties;
    if (Object.prototype.toString.call(momentProperties) === "[object Array]") {
        momentProperties.push("_z");
        momentProperties.push("_a");
    } else if (momentProperties) {
        momentProperties._z = null;
    }
    return moment;
});

usga = window.usga || {};

usga.BaseCampaignWorkflow = can.Construct.extend({
    init: function(campaignData) {
        var me = this;
        this.teamApproachMemberInfoWebserviceUrl = usga.config.teamApproachMemberInfoWebserviceUrl;
        this.pipCheckOutUrl = usga.config.pipCheckOutUrl;
        this.clubhouseHomeUrl = usga.config.clubhouseHomeUrl;
        this.defaultRenewFlowUrl = usga.config.defaultRenewFlowUrl;
        this.defaultJoinFlowUrl = usga.config.defaultJoinFlowUrl;
        this.defaultReacquisitionUrl = usga.config.defaultReacquisitionUrl;
        this.alternateJoinUrl = usga.config.alternateJoinUrl;
        if (typeof campaignData !== "object") {
            throw "campaignData is not defined.";
        }
        for (i = 0; i < campaignData.campaign.levels.length; i++) {
            campaignData.campaign.levels[i].button = campaignData.campaign.button;
            for (j = 0; j < campaignData.membershipLevels.length; j++) {
                var m = campaignData.membershipLevels[j];
                if (m.id == campaignData.campaign.levels[i].id) {
                    campaignData.campaign.levels[i].membership = m;
                    break;
                }
            }
        }
        campaignData.oneElementArray = [ {} ];
        this.campaignData = campaignData;
        this.campaignData.showDualOption = true;
        this.campaignData.showIndividualOption = true;
        if (!this.campaignData.campaign.levelsTitle) this.campaignData.campaign.levelsTitle = "";
        this.callbacks = {};
    },
    start: function(params) {
        var me = this;
        if (typeof params !== "object") {
            console.log("params was not supplied.");
            params = {};
        }
        if (typeof params.showCampaign !== "function") {
            console.log("params.showCampaign is not defined.");
            this.callbacks.showCampaign = function() {};
        } else this.callbacks.showCampaign = params.showCampaign;
        if (typeof params.showLoader !== "function") {
            console.log("params.showLoader is not defined.");
            this.callbacks.showLoader = function() {};
        } else this.callbacks.showLoader = params.showLoader;
        if (typeof params.hideLoader !== "function") {
            console.log("params.hideLoader is not defined.");
            this.callbacks.hideLoader = function() {};
        } else this.callbacks.hideLoader = params.hideLoader;
        usga.Gigya.onUser(function(user) {
            if (typeof me.callbacks.ssoSuccessful !== "function") return;
            if (user) {
                me.user = user;
                me.ssoId = user.UID;
                me.callbacks.ssoSuccessful(user);
            }
        });
        usga.Gigya.onConnectMemberId(this.proxy(this.connectMemberIdSSO));
        usga.Gigya.onClosePopup(this.proxy(this.closePopupSSO));
    },
    getTeamApproachMemberInfoById: function(params) {
        var me = this;
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("POST", this.teamApproachMemberInfoWebserviceUrl, true);
        var sr = '<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema"><GetMemberInfoByID xmlns="http://tempuri.org/"><Member_ID>' + params.memberId + "</Member_ID></GetMemberInfoByID></s:Body></s:Envelope>";
        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.status == 500) {
                alert("Error loading data from teamapproach for the following memberID: " + params.memberId);
                return;
            }
            if (xmlhttp.readyState == 4) {
                if (xmlhttp.status == 200) {
                    var x2js = new X2JS();
                    var taUser = x2js.xml_str2json(xmlhttp.responseText).Envelope.Body.GetMemberInfoByIDResponse.GetMemberInfoByIDResult.MemberInfo;
                    if (typeof taUser == "undefined") {
                        alert("No records found in teamapproach for the following memberID: " + params.memberId);
                        return;
                    }
                    for (var key in taUser) {
                        if (typeof taUser[key] == "object" && taUser[key]["_xsi:nil"]) taUser[key] = "";
                    }
                    me.taUser = taUser;
                    me.userLevelInfo = me.getCurrentUserLevelInfo();
                    params.callback(taUser);
                }
            }
        };
        xmlhttp.setRequestHeader("Content-Type", "text/xml");
        xmlhttp.setRequestHeader("SOAPAction", "http://tempuri.org/GetMemberInfoByID");
        xmlhttp.send(sr);
    },
    connectMemberIdSSO: function() {
        if (typeof this.callbacks.connectMemberIdSuccessful !== "function") {
            console.log("connectMemberIdSuccessful is not defined.");
        } else {
            this.callbacks.connectMemberIdSuccessful(usga.Gigya.getConnectedMember());
        }
        this.callbacks.closePopup = null;
    },
    closePopupSSO: function() {
        if (typeof this.callbacks.closePopup !== "function") {
            console.log("closePopup is not defined.");
        } else {
            this.callbacks.closePopup();
        }
        this.callbacks.closePopup = null;
    },
    successfulEventSSO: function(params) {
        var me = this;
        if (typeof this.callbacks.ssoSuccessful !== "function") {
            console.log("ssoSuccessful is not defined.");
        } else {
            usga.Gigya.getUserInfo(function(user) {
                this.callbacks.showLoader();
                me.ssoId = user.UID;
                me.callbacks.ssoSuccessful(user);
            });
        }
    },
    showLoginSSO: function(params) {
        this.callbacks.hideLoader();
        usga.Gigya.login({
            campaign: true,
            email: params.email ? params.email : this.taUser ? this.taUser.Email_Address : ""
        });
        this.callbacks.ssoSuccessful = params.callback;
    },
    showRegistrationSSO: function(params) {
        this.callbacks.hideLoader();
        usga.Gigya.register({
            campaign: true,
            email: params.email ? params.email : this.taUser ? this.taUser.Email_Address : ""
        });
        this.callbacks.ssoSuccessful = params.callback;
    },
    showConnectMemberIdSSO: function(params) {
        this.callbacks.hideLoader();
        if (typeof params !== "object") {
            console.log("params was not supplied.");
            params = {};
        }
        if (typeof params.callback !== "function") {
            params.callback = function() {};
        }
        if (typeof params.closePopup !== "function") {
            params.closePopup = function() {};
        }
        params.campaign = true;
        this.callbacks.connectMemberIdSuccessful = params.callback;
        this.callbacks.closePopup = params.closePopup;
        usga.Gigya.connect(params);
    },
    prepareCampaignDataBeforeUI: function() {
        this.campaignData.campaign.filteredLevels = this.campaignData.campaign.levels;
    },
    getCurrentUserLevelInfo: function() {
        if (!this.taUser) {
            return null;
        }
        var type = "single";
        var memberCodeDec = 0;
        if (this.taUser.Member_Type == "Dual") {
            memberCodeDec = 1;
            type = "dual";
        }
        var memberLevel = this.taUser.Member_Level_Code - memberCodeDec;
        return {
            level: (memberLevel < 10 ? "0" : "") + memberLevel,
            type: type,
            giftType: this.taUser.Gift_Type,
            lastPayment: this.taUser.Last_Payment_Amount,
            ssoId: this.taUser.SSOID,
            alternateId: this.taUser.Alternate_ID,
            isDual: type == "dual",
            isIndividual: type != "dual"
        };
    },
    failedConnectMemberId: function() {},
    connectMemberId: function(params) {
        var me = this;
        if (typeof params !== "object") {
            console.log("params was not supplied.");
            params = {};
        }
        if (typeof params.yesCallback !== "function") {
            params.yesCallback = function() {};
        }
        if (typeof params.noCallback !== "function") {
            params.noCallback = function() {};
        }
        this.showConnectMemberIdSSO({
            callback: function(data) {
                if (data.MemberId === 0) {
                    me.failedConnectMemberId();
                    return;
                }
                me.isThisYou({
                    memberId: data.MemberId,
                    yesCallback: function() {
                        me.taAccountId = data.MemberId;
                        params.yesCallback();
                    },
                    noCallback: function() {
                        me.taUser = null;
                        params.noCallback();
                        me.connectMemberId(params);
                    }
                });
            },
            closePopup: function() {
                me.failedConnectMemberId();
                return;
            }
        });
    },
    handleLevelUp: function() {
        if (!this.userLevelInfo) return;
        this.handleLevelUpByLevel(this.userLevelInfo.level);
    },
    handleLevelUpByLevel: function(level) {
        this.campaignData.campaign.filteredLevels = [];
        for (var i = 0; i < this.campaignData.campaign.levels.length; i++) {
            if (this.campaignData.campaign.levels[i].id == level) {
                this.campaignData.campaign.filteredLevels.push(this.campaignData.campaign.levels[i]);
                if (this.campaignData.campaign.oneLevelUp && i + 1 < this.campaignData.campaign.levels.length) {
                    var el = this.campaignData.campaign.levels[i + 1];
                    if (this.campaignData.campaign.buttonRight) el.button = this.campaignData.campaign.buttonRight;
                    this.campaignData.campaign.filteredLevels.push(el);
                }
                break;
            }
        }
    },
    handlePriceRange: function() {
        var me = this;
        if (this.campaignData.campaign.filteredLevels && this.campaignData.campaign.filteredLevels.length === 0) return;
        var levels = [];
        this.campaignData.showDualOption = true;
        this.campaignData.showIndividualOption = this.userLevelInfo.isIndividual;
        for (var i = 0; i < this.campaignData.campaign.filteredLevels.length; i++) {
            var level = this.campaignData.campaign.filteredLevels[i];
            if (!level.price) {
                continue;
            }
            if (!level.priceRange) level.priceRange = level.price;
            var priceObjectArray = this.userLevelInfo.isDual ? level.priceRange.dual : level.priceRange.individual;
            var type = i === 0 ? "renew" : "upgrade";
            for (var j = 0; j < priceObjectArray.length; j++) {
                var priceObject = priceObjectArray[j];
                if (!priceObject.fromPrice) priceObject.fromPrice = 0;
                if (!priceObject.toPrice && priceObject.toPrice !== 0) priceObject.toPrice = 999999;
                if (this.userLevelInfo.lastPayment >= priceObject.fromPrice && this.userLevelInfo.lastPayment <= priceObject.toPrice) {
                    level.price = priceObject[type + "Individual"];
                    level.priceDual = priceObject[type + "Dual"];
                    if (this.userLevelInfo.isDual) level.price = level.priceDual;
                    levels.push(level);
                    break;
                }
            }
        }
        this.campaignData.campaign.filteredLevels = levels;
        if (levels.length === 0) {
            this.displayNotAppropriateCampaignModal({
                closeCallback: function() {
                    me.redirectToClubhouseHome();
                }
            });
            return;
        }
    },
    handlePricingBook: function() {
        var me = this;
        if (this.campaignData.campaign.filteredLevels && this.campaignData.campaign.filteredLevels.length === 0) {
            this.displayNotAppropriateCampaignModal({
                closeCallback: function() {
                    me.redirectToClubhouseHome();
                }
            });
            return;
        }
        var priceBook = this.campaignData.campaign.priceBook;
        for (var i = 0; i < priceBook.length; i++) {
            var priceBookEntry = priceBook[i];
            var priceBookLevel = priceBookEntry.currentLevel;
            priceBookEntry.isDual = false;
            if (priceBookEntry.currentType && priceBookEntry.currentType == "DUAL") {
                priceBookEntry.isDual = true;
            }
            if (priceBookEntry.isDual == this.userLevelInfo.isDual && this.compareCaseInsensitive(priceBookLevel, this.userLevelInfo.level) && this.compareCaseInsensitive(priceBookEntry.currentGiftType, this.userLevelInfo.giftType) && priceBookEntry.lastPayment == this.userLevelInfo.lastPayment) {
                if (this.userLevelInfo.isDual) {
                    this.campaignData.campaign.filteredLevels[0].price = this.campaignData.campaign.filteredLevels[0].priceDual = priceBookEntry.price;
                } else this.campaignData.campaign.filteredLevels[0].price = priceBookEntry.price;
                this.campaignData.campaign.sourceCode = priceBookEntry.sourceCode;
                this.campaignData.showDualOption = this.userLevelInfo.isDual;
                this.campaignData.showIndividualOption = !this.campaignData.showDualOption;
                return;
            }
        }
        this.displayNotAppropriateCampaignModal({
            closeCallback: function() {
                me.redirectToClubhouseHome();
            }
        });
    },
    showCampaignUI: function(params) {
        if (typeof params !== "object") {
            console.log("params was not supplied.");
            params = {};
        }
        if (typeof params.doneButtonClick !== "function") {
            console.log("doneButtonClick is not defined.");
            this.callbacks.doneButtonClick = function() {};
        } else this.callbacks.doneButtonClick = params.doneButtonClick;
        if (this.taUser) this.campaignData.taUser = this.taUser;
        if (this.uiShowed) {
            this.uiShowed = null;
            this.callbacks.doneButtonClick();
            return;
        }
        this.prepareCampaignDataBeforeUI();
        this.callbacks.showCampaign(this.campaignData);
    },
    processAction: function(params) {
        if (typeof params !== "object") {
            throw "params was not supplied.";
        }
        if (!params.hasOwnProperty("selectedLevel")) {
            throw "params.selectedLevel was not supplied.";
        }
        this.selectedLevel = params.selectedLevel;
        this.uiShowed = true;
        this.callbacks.doneButtonClick();
    },
    getHiddenElement: function(name, value) {
        return $("<input>").attr("type", "hidden").attr("name", name).val(typeof value != "undefined" ? value : "");
    },
    gotoPIPCheckOut: function() {
        var url = this.pipCheckOutUrl;
        var pipForm = $("<form>").attr("action", this.pipCheckOutUrl).attr("method", "post");
        if (this.taUser) {
            pipForm.append(this.getHiddenElement("curr_mem_level", this.taUser.Member_Level_Desc));
            pipForm.append(this.getHiddenElement("curr_mem_level_numeric", this.taUser.Member_Level_Code));
            pipForm.append(this.getHiddenElement("curr_member_status", this.taUser.Activity_Status));
            pipForm.append(this.getHiddenElement("curr_member_expiration", this.taUser.Expiration_Date));
            pipForm.append(this.getHiddenElement("curr_member_last_payment", this.taUser.Last_Payment_Amount));
            pipForm.append(this.getHiddenElement("auto_renew_status", this.taUser.Auto_Renew));
            pipForm.append(this.getHiddenElement("gift_type", this.taUser.Gift_Type));
        }
        pipForm.append(this.getHiddenElement("qs", document.URL));
        pipForm.append(this.getHiddenElement("cid", this.campaignData.queryString.c));
        pipForm.append(this.getHiddenElement("cmp", this.campaignData.queryString.cmp));
        pipForm.append(this.getHiddenElement("r", this.campaignData.queryString.r));
        pipForm.append(this.getHiddenElement("Urlmemberid", this.campaignData.queryString.id));
        pipForm.append(this.getHiddenElement("memberID", this.taAccountId));
        var type = this.campaignData.campaign.type.charAt(0).toUpperCase() + this.campaignData.campaign.type.slice(1);
        pipForm.append(this.getHiddenElement("od_trans_type", type));
        pipForm.append(this.getHiddenElement("Mem_type", this.selectedLevel.memberType));
        pipForm.append(this.getHiddenElement("PriceValues", this.selectedLevel.memberType == "Individual" ? this.selectedLevel.price : this.selectedLevel.priceDual));
        var level = this.selectedLevel.memberType == "Individual" ? this.selectedLevel.membership.id : (1 * this.selectedLevel.membership.id + 1).toString();
        if (level.length == 1) level = "0" + level;
        pipForm.append(this.getHiddenElement("Mem_level_numeric", level));
        pipForm.append(this.getHiddenElement("Mem_level", this.selectedLevel.membership.shortTitle));
        var benefits = this.selectedLevel.additionalBenefits[this.selectedLevel.button.toLowerCase() + "Benefits"];
        if (benefits) {
            for (var i = 0; i < benefits.length; i++) {
                pipForm.append(this.getHiddenElement("benefit" + (i + 1), benefits[i].code));
                pipForm.append(this.getHiddenElement("benefit" + (i + 1) + "_description", benefits[i].description));
            }
        }
        if (this.campaignData.campaign.type == "upgrade") {
            pipForm.append(this.getHiddenElement("ref_number", this.campaignData.campaign.sourceCode));
            pipForm.append(this.getHiddenElement("def_ref_number", ""));
        } else {
            pipForm.append(this.getHiddenElement("ref_number", this.campaignData.queryString.source));
            pipForm.append(this.getHiddenElement("def_ref_number", this.campaignData.campaign.sourceCode));
        }
        pipForm.append(this.getHiddenElement("Ssoid", this.ssoId));
        $("body").append(pipForm);
        pipForm.submit();
    },
    isMemberExpirationDateGreaterThan6MonthsFromToday: function(months) {
        return this.isMemberExpirationDateGreaterThanMonthsFromToday(6);
    },
    isMemberExpirationDateGreaterThanMonthsFromToday: function(months) {
        var d = new Date(this.taUser.Expiration_Date);
        return new Date(new Date(d).setMonth(d.getMonth() - months)) > new Date();
    },
    hasUserBeenExpiredForMorThan6Months: function(months) {
        return this.hasUserBeenExpiredForMorThanMonths(6);
    },
    hasUserBeenExpiredForMorThanMonths: function(months) {
        var d = new Date(this.taUser.Expiration_Date);
        return new Date(new Date(d).setMonth(d.getMonth() + months)) < new Date();
    },
    isAlternateIdAssociated: function() {
        return this.taUser.Alternate_ID !== "";
    },
    isSSOUserFederated: function() {
        if (!this.user) return false;
        if (!this.user.data) return false;
        var result = this.user.data.memberId !== "";
        if (result) {
            this.taAccountId = this.user.data.memberId;
        }
        return result;
    },
    doesMemberHaveExpirationDate: function() {
        return this.taUser.Expiration_Date !== "";
    },
    doesTaAccountIdPresentInUrl: function() {
        return this.campaignData.queryString.id ? true : false;
    },
    isUserEnrolledInAutoRenew: function() {
        return this.taUser.Auto_Renew == "true";
    },
    isThisYou: function(params) {
        var me = this;
        this.getTeamApproachMemberInfoById({
            memberId: params.memberId,
            callback: function() {
                me.displayConfirmationModal({
                    yesCallback: params.yesCallback,
                    noCallback: params.noCallback
                });
            }
        });
    },
    displayConfirmationModal: function(params) {
        if (typeof params !== "object") params = {};
        if (typeof params.yesCallback !== "function") params.yesCallback = function() {};
        if (typeof params.noCallback !== "function") params.noCallback = function() {};
        if (usga.url.query.confirmed) {
            params.yesCallback();
            return;
        }
        if (this.taUser.First_Name || this.taUser.Last_Name) params.message = "Are you " + this.taUser.First_Name + " " + this.taUser.Last_Name + "?"; else if (this.taUser.Email_Address) params.message = "Is your email " + this.taUser.Email_Address + "?"; else params.message = "Is your member id " + this.taUser.Member_ID + "?";
        this.showCampaignModal(".confirmation", params);
    },
    displayAutoRenewModal: function(params) {
        this.showCampaignModal(".auto-renew", params);
    },
    displayActiveMemberModal: function(params) {
        this.showCampaignModal(".active-member", params);
    },
    displayIneligibleRenewalModal: function(params) {
        this.showCampaignModal(".ineligible-for-renewal", params);
    },
    displayNotAppropriateCampaignModal: function(params) {
        this.showCampaignModal(".not-eligible-offer", params);
    },
    showCampaignModal: function(selector, params) {
        if (!this.campaignModal && $("#campaignModal").length) {
            this.campaignModal = new usga.ModalCampaign("#campaignModal");
        }
        if (this.campaignModal) {
            this.callbacks.hideLoader();
            if (typeof params.closeCallback !== "function") params.closeCallback = function() {};
            if (typeof params.yesCallback !== "function") params.yesCallback = function() {};
            if (typeof params.noCallback !== "function") params.noCallback = function() {};
            var me = this;
            var originalCloseCallback = params.closeCallback;
            var originalYesCallback = params.yesCallback;
            var originalNoCallback = params.noCallback;
            params.closeCallback = function() {
                me.callbacks.hideLoader();
                originalCloseCallback();
            };
            params.yesCallback = function() {
                me.callbacks.hideLoader();
                originalYesCallback();
            };
            params.noCallback = function() {
                me.callbacks.hideLoader();
                originalNoCallback();
            };
            this.campaignModal.open(selector, params);
        }
    },
    redirectQueryString: function() {
        if (!this.taAccountId) return "";
        return "?confirmed=yes&id=" + this.taAccountId;
    },
    redirectToClubhouseHome: function() {
        document.location = this.clubhouseHomeUrl;
    },
    redirectToRenewFlow: function() {
        document.location = this.defaultRenewFlowUrl + this.redirectQueryString();
    },
    redirectToJoinFlow: function() {
        document.location = this.defaultJoinFlowUrl + this.redirectQueryString();
    },
    redirectToReacquisitionFlow: function() {
        document.location = this.defaultReacquisitionUrl + this.redirectQueryString();
    },
    redirectToAlternateJoinFlow: function() {
        document.location = this.alternateJoinUrl + this.redirectQueryString();
    },
    nullShieldLowerCase: function(value) {
        if (!value) return "";
        return value.toLowerCase();
    },
    compareCaseInsensitive: function(value1, value2) {
        return this.nullShieldLowerCase(value1) == this.nullShieldLowerCase(value2);
    }
});

usga.CampaignWorkflowFactory = {
    create: function(campaignData) {
        if (typeof campaignData !== "object") {
            throw "campaignData was not supplied.";
        }
        if (typeof campaignData.campaign !== "object") {
            throw "campaignData.campaign was not supplied.";
        }
        switch (campaignData.campaign.type) {
          case "join":
            return new usga.JoinCampaignWorkflow(campaignData);

          case "reacquisition":
            return new usga.ReacquisitionCampaignWorkflow(campaignData);

          case "renew":
            return new usga.RenewCampaignWorkflow(campaignData);

          case "upgrade":
            return new usga.UpgradeCampaignWorkflow(campaignData);

          default:
            throw campaignData.campaign.type + " is not correct or not implemented yet.";
        }
    }
};

usga = window.usga || {};

usga.BaseMap = can.Map.extend({
    setup: function() {
        can.Map.setup.apply(this, arguments);
        this.List = can.List({
            Map: this
        }, {});
    }
}, {});

usga = window.usga || {};

usga.BaseModule = can.Control.extend({
    biggerMaxWidth: 1170,
    bigMaxWidth: 960,
    mediumMaxWidth: 767,
    smallMaxWidth: 480,
    resizeTimeout: 100,
    offsetVisible: 50,
    lazyLoading: true,
    domReady: false,
    loaded: false,
    hasProtectedContent: false,
    setup: function(element, options) {
        var result = this._super(element, options);
        this.$element = this.element;
        return result;
    },
    init: function() {
        this.screenSize = this.getScreenSize();
        if (this.onDocumentReady) {
            if (usga.domReady) {
                this.onDocumentReady();
            } else {
                this.on(document, "ready", this.proxy(this.onDocumentReady));
            }
        }
        if (this.onWindowLoad) {
            if (usga.windowLoad) {
                this.onWindowLoad();
            } else {
                this.on(window, "load", this.proxy(this.onWindowLoad));
            }
        }
        if (this.onWindowScroll || this.onFirstShow) {
            this.on(window, "scroll", this.proxy(this._onWindowScroll));
        }
        if (this.onWindowResize || this.onLayout) {
            this.on(window, "resize", this.proxy(this._onWindowResize));
        }
        if (this.hasProtectedContent) {
            usga.Gigya.onUser(this.proxy(this.onUserLogged));
        }
        if (this.onFirstShow) {
            if (this.lazyLoading) {
                this.checkModuleVisible();
            } else {
                this.loaded = true;
                this.onFirstShow();
            }
        } else {
            this.loaded = true;
        }
    },
    getViewportSize: function() {
        var e = window, a = "inner";
        if (!("innerWidth" in window)) {
            a = "client";
            e = document.documentElement || document.body;
        }
        var bs = document.body.style;
        return {
            width: bs.width ? parseInt(bs.width) : e[a + "Width"],
            height: bs.height ? parseInt(bs.height) : e[a + "Height"]
        };
    },
    getScreenSize: function() {
        var vSize = this.getViewportSize();
        var size;
        if (vSize.width <= this.smallMaxWidth) {
            size = "small";
        } else if (vSize.width <= this.mediumMaxWidth) {
            size = "medium";
        } else if (vSize.width <= this.bigMaxWidth) {
            size = "big";
        } else if (vSize.width <= this.biggerMaxWidth) {
            size = "bigger";
        } else {
            size = "infinity";
        }
        return size;
    },
    isDomReady: function() {
        return usga.domReady;
    },
    isSmallScreen: function() {
        return this.getScreenSize() == "small";
    },
    isMediumScreen: function() {
        return this.getScreenSize() == "medium";
    },
    isBigScreen: function() {
        return this.getScreenSize() == "big";
    },
    isBiggerScreen: function() {
        return this.getScreenSize() == "bigger";
    },
    isInfinityScreen: function() {
        return this.getScreenSize() == "infinity";
    },
    checkModuleVisible: function() {
        var windowScrollTop = $(window).scrollTop();
        var offset = this.$element.offset();
        if (offset && windowScrollTop + $(window).height() >= offset.top - this.offsetVisible) {
            this.loaded = true;
            this.onFirstShow();
        }
    },
    applyCloudinaryConfig: function(images, cfg) {
        var config = can.extend({}, cfg);
        if (!config.quality) {
            config.quality = 70;
            if (config.width > 1200) {
                config.quality = 50;
            }
        }
        images.cloudinary(config);
    },
    trigger: function(eventName) {
        can.event.trigger.call(this, eventName, usga.getArgs(arguments, 1));
    },
    bind: function(eventName, handler) {
        can.event.bind.call(this, eventName, handler);
    },
    unbind: function(eventName, handler) {
        can.event.unbind.call(this, eventName, handler);
    },
    updateProtectedLinks: function() {
        var protectedLinks = this.element.find("a[href*='/protected/'], a.protected__link");
        protectedLinks.off("click");
        if (usga.Gigya.isUserHasAccessToProtectedContent()) {
            protectedLinks.removeClass("locked").addClass("unlocked");
        } else {
            protectedLinks.removeClass("unlocked").addClass("locked");
        }
        protectedLinks.filter(".locked").click(this.onProtectedLinkClick);
    },
    _onWindowResize: function() {
        if (this.resizeTimer) {
            clearTimeout(this.resizeTimer);
        }
        this.resizeTimer = setTimeout(this.proxy(this.onResizeTimer), this.resizeTimeout);
    },
    onResizeTimer: function() {
        this.resizeTimer = null;
        if (this.onFirstShow && this.lazyLoading && !this.loaded) {
            this.checkModuleVisible();
        }
        var screenSize = this.getScreenSize();
        if (this.screenSize !== screenSize) {
            this.screenSize = screenSize;
            if (this.onLayout && this.loaded) {
                this.onLayout(this.screenSize);
            }
        }
        if (this.onWindowResize) {
            this.onWindowResize();
        }
    },
    _onWindowScroll: function() {
        if (this.onFirstShow && this.lazyLoading && !this.loaded) {
            this.checkModuleVisible();
        }
        if (this.onWindowScroll) {
            this.onWindowScroll();
        }
    },
    onUserLogged: function(user) {
        this.updateProtectedLinks();
    },
    onProtectedLinkClick: function(evt) {
        evt.preventDefault();
        if (!usga.Gigya.isLoggedIn()) {
            usga.Gigya.openNotLoggedInDialog();
        } else if (!usga.Gigya.isMember()) {
            usga.Gigya.openNonMemberDialog();
        } else if (!usga.Gigya.isMembershipActualOrInGracePeriod()) {
            usga.Gigya.openMembershipExpiredDialog();
        }
        usga.Gigya.setRedirectionUrl($(this).attr("href"));
    }
});

usga.BaseCloudinaryModule = usga.BaseModule.extend({
    getCloudinaryConfigParameterFromCss: function(image, name) {
        var param = image.css(name);
        if (param && param != "auto" && param != "none") {
            return parseInt(param.replace("px", ""));
        }
    },
    getImageAttr: function(image, name, isNumeric) {
        var val = image.attr(name);
        if (val) {
            if (isNumeric) {
                val = parseInt(val);
            }
            return val;
        }
    },
    applyCloudinary: function(container) {
        container = container || this.$element;
        var images = container.find("img[data-src]");
        var image, config, width, height, curWidth, curHeight, quality, crop;
        var dpr = $.cloudinary.device_pixel_ratio();
        for (var i = 0; i < images.length; i++) {
            image = $(images[i]);
            width = this.getCloudinaryConfigParameterFromCss(image, "max-width");
            height = this.getCloudinaryConfigParameterFromCss(image, "max-height");
            curWidth = this.getImageAttr(image, "width", true);
            curHeight = this.getImageAttr(image, "height", true);
            if (width != curWidth || height != curHeight) {
                image.removeAttr("height");
                image.removeAttr("width");
                quality = width > 1170 ? 50 : 70;
                dpr = width < 1170 ? dpr : null;
                config = {
                    width: width,
                    height: height,
                    crop: this.getImageAttr(image, "data-crop") || "fill",
                    quality: this.getImageAttr(image, "data-quality") || quality
                };
                if (width < 1170 && dpr > 1) {
                    config.dpr = Math.ceil(dpr * 2) / 2;
                }
                image.cloudinary(config);
            }
        }
    },
    onFirstShow: function() {
        this.applyCloudinary();
    },
    onLayout: function() {
        this.applyCloudinary();
    }
});

usga.VariableSlider = usga.BaseCloudinaryModule.extend({
    sliderSelector: "",
    getSliderConfig: function() {},
    initSlider: function() {
        var config = this.getSliderConfig();
        if (config) {
            this.slider = this.$element.find(this.sliderSelector).bxSlider(config);
        }
    },
    reinitSlider: function() {
        var config = this.getSliderConfig();
        if (!can.Object.same(config, this.lastConfig)) {
            this.lastConfig = config;
            if (!config && this.slider) {
                this.slider.destroySlider();
            } else if (config && !this.slider) {
                this.initSlider();
            } else if (config && this.slider) {
                this.slider.reloadSlider(config);
            }
        }
    },
    onFirstShow: function() {
        this._super();
        this.$element.removeClass("loading");
        this.initSlider();
    },
    onLayout: function(screen) {
        this._super();
        this.reinitSlider();
    }
});

usga.Paginator = can.Map.extend({
    count: 0,
    offset: 0,
    limit: 10,
    next: function() {
        this.attr("offset", this.offset + this.limit);
    },
    prev: function() {
        this.attr("offset", this.offset - this.limit);
    },
    canNext: function() {
        return this.attr("offset") < this.attr("count") - this.attr("limit");
    },
    canPrev: function() {
        return this.attr("offset") > 0;
    },
    page: function(newVal) {
        if (newVal === undefined) {
            return Math.floor(this.attr("offset") / this.attr("limit")) + 1;
        } else {
            this.attr("offset", (parseInt(newVal, 10) - 1) * this.attr("limit"));
        }
    },
    pageCount: function() {
        return this.attr("count") ? Math.ceil(this.attr("count") / this.attr("limit")) : null;
    }
});

usga.BaseModal = usga.BaseModule.extend({
    init: function() {
        this._super();
        this.element.appendTo($("body"));
    },
    open: function() {
        this.$element.show();
    },
    close: function(causedByWorkflow) {
        this.$element.hide();
        this.onClose(causedByWorkflow);
    },
    onClose: function() {}
});

can.Component.extend({
    tag: "cloudinary-image",
    template: '<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=" data-src="{{src}}" data-crop="{{crop}}" alt="{{alt}}">',
    scope: {
        define: {
            src: {
                set: function(value) {
                    if (!value) return "";
                    if (this.stripPrefix && value.indexOf(this.stripPrefix) === 0) {
                        value = value.substr(this.stripPrefix.length);
                    }
                    return value;
                }
            }
        },
        stripPrefix: "/content/dam"
    }
});

usga.BaseSearchModule = usga.BaseCloudinaryModule.extend({
    KEYS: {
        ENTER: 13
    },
    defaults: {
        baseUrl: usga.embed ? "http://www.usga.org" : location.protocol + "//" + location.host,
        baseSearchPageUrl: "",
        searchPageUrl: "/search-results.html#q={query}{type}",
        template: "",
        attivioSearchQueryData: {
            q: ""
        }
    },
    getResultsUrl: function(baseSearchPageUrl, searchPageUrl, queryText, type) {
        var typeParam = "";
        if (type) {
            typeParam = "&type=" + type;
        }
        return baseSearchPageUrl + can.sub(searchPageUrl, {
            query: usga.BaseSearchModule.prepareQueryText(queryText),
            type: typeParam
        });
    },
    navigateToUrl: function(url) {
        var pathName = location.pathname, newPath = usga.url.trimHost(url);
        location.href = url;
        if (pathName && pathName !== "/" && newPath.indexOf(pathName) === 0) {
            setTimeout(function() {
                location.reload(true);
            }, 0);
        }
    },
    prepareQueryText: function(text) {
        if (!text || typeof text !== "string") {
            return "";
        }
        return encodeURIComponent(text);
    }
}, {
    hasProtectedContent: true,
    init: function(element, options) {
        this._super();
    },
    _renderTemplate: function() {
        if (this.options.template && $(this.options.template)[0]) {
            return can.view(this.options.template, this.context, {
                "protected": this.proxy(this._handleByProtectedHelper),
                pages: this.proxy(this._handleByPagesHelper),
                activePageLink: this.proxy(this._handleByActivePageLinkHelper),
                activeType: this.proxy(this._handleByActiveTypeHelper)
            });
        }
        return "";
    },
    _handleByProtectedHelper: function(options) {
        if (options.context.isProtected) {
            $(options.nodeList[0]).addClass("protected__link");
        }
    },
    _handleByPagesHelper: function(options) {
        if (this.context && this.context.paginator) {
            var page = this.context.paginator.page(), pageCount = this.context.paginator.pageCount(), links = [], links2 = [], rendered = [];
            for (var i = 0; i < pageCount; i++) {
                links.push({
                    page: i + 1
                });
            }
            var left = page - 3;
            if (left < 1) {
                left = 1;
            }
            links2 = links.slice(left - 1, left + 4);
            for (var i2 = 0, len2 = links2.length; i2 < len2; i2++) {
                rendered.push(options.fn(links2[i2]));
            }
            return rendered;
        }
    },
    _handleByActiveTypeHelper: function(options) {
        if (this.context && "type" in this.context) {
            var $el = $(options.nodeList), typeVal = this.context.type || "";
            $el.find("a[data-type]").removeClass("active");
            $el.find(can.sub('a[data-type="{type}"]', {
                type: typeVal
            })).addClass("active");
        }
    },
    _handleByActivePageLinkHelper: function(pageVal, options) {
        var $el = $(options.nodeList[0]), $parent = $el.parent();
        if (this.context.paginator && this.context.paginator.page() === pageVal) {
            $parent.find("[data-page]").removeClass("active");
            $el.addClass("active");
        }
    },
    _getQueryText: function() {
        return this.$query.val().trim().replace(/\s+/g, " ");
    },
    getResultsUrl: function(typeName) {
        var typeParam = "";
        if (typeName) {
            typeParam = "&type=" + typeName;
        }
        return this.options.baseSearchPageUrl + can.sub(this.options.searchPageUrl, {
            query: usga.BaseSearchModule.prepareQueryText(this._getQueryText()),
            type: typeParam
        });
    },
    _makeRequest: function(term, additionalData) {
        return $.ajax({
            url: usga.config.attivioSearchUrl,
            data: $.extend({}, this.options.attivioSearchQueryData, {
                q: usga.quote(term)
            }, additionalData || {}),
            dataType: "jsonp"
        });
    },
    _getSynonyms: function(data) {
        if (usga.isObject(data) && data.feedback) {
            for (var i = 0, len = data.feedback.length; i < len; i++) {
                var item = data.feedback[i];
                if (item.name && item.name === "synonyms.expansion" && item.message) {
                    var match = item.message.match(/=>\s*\[([^\]]+)\]$/);
                    if (match[1]) {
                        return {
                            label: match[1]
                        };
                    }
                }
            }
        }
        return false;
    },
    _getPredictiveDocumentsCount: function(data) {
        if (usga.isObject(data) && data.documents && $.isArray(data.documents)) {
            return data.documents.length;
        }
        return 0;
    },
    _getDocumentsCount: function(data) {
        var facetCountsVal = this._getFacetCounts(data);
        return usga.reduce(facetCountsVal, function(p, o) {
            return p + o.count;
        }, 0);
    },
    _getFacetBucket: function(data) {
        if (usga.isObject(data) && data.facets) {
            var bucket = null;
            for (var i = 0, len = data.facets.length; i < len; i++) {
                var facet = data.facets[i];
                if (facet.field && facet.field === "concepts" && $.isArray(facet.buckets)) {
                    return facet.buckets[0];
                }
            }
        }
        return false;
    },
    _getFacetCounts: function(data) {
        var counts = {};
        if (usga.isObject(data) && data.facets) {
            for (var i = 0, len = data.facets.length; i < len; i++) {
                var facet = data.facets[i];
                if (facet.field === "contentType") {
                    if ($.isArray(facet.buckets)) {
                        var buckets = $.merge([], facet.buckets);
                        for (var i2 = 0, len2 = buckets.length; i2 < len2; i2++) {
                            var documentType = this._plainDocumentType(buckets[i2].label);
                            if (documentType.match(/rules/i)) {
                                documentType = "rules";
                            }
                            if (!counts[documentType]) {
                                counts[documentType] = {
                                    count: 0,
                                    label: buckets[i2].label || "",
                                    type: documentType
                                };
                            }
                            counts[documentType].count += buckets[i2].count || 0;
                        }
                    }
                }
            }
        }
        $.each(usga.keys(counts), function(key, item) {
            if (!item.count || item.count === null) {
                delete counts[key];
            }
        });
        return counts;
    },
    _getDocuments: function(data) {
        return usga.isObject(data) && data.documents ? data.documents : [];
    },
    _plainDocumentType: function(type) {
        return type.toLowerCase().replace(/[^a-z\s]/g, "").replace(/\s+/g, "_");
    },
    _getDocumentType: function(doc) {
        var type = this._getDocumentProperty(doc, "contentType", true);
        if (!type || type === null) {
            type = "all";
        } else if (type && typeof type !== "string") {
            type = "" + type;
        }
        if (type) {
            return {
                name: this._plainDocumentType(type),
                label: type
            };
        } else {
            return null;
        }
    },
    _getDocumentProperty: function(document, property, getFirstItem, doJoin, joinStr) {
        if (!document || !usga.isObject(document) || !document[property]) {
            return undefined;
        }
        if ($.isArray(document[property])) {
            if (getFirstItem) {
                return document[property][0];
            } else if (doJoin) {
                return document[property].join(joinStr || "");
            }
        }
        return document[property];
    },
    _prepareRenderItem: function(document, doNotStripTags) {
        var item = {}, title = this._getDocumentProperty(document, "title", true), text = this._getDocumentProperty(document, "text", true) || "", uri = this._getDocumentProperty(document, "uri", true), imageUrl = this._getDocumentProperty(document, "imageUrl", true), type = this._getDocumentProperty(document, "contentType", true), contentType = this._getDocumentType(document), isProtected = "" + this._getDocumentProperty(document, "protected", true) === "true", defaultTitle = "Title";
        item.title = doNotStripTags ? title || defaultTitle : usga.stripTags(title || defaultTitle);
        item.text = doNotStripTags ? text || "" : usga.stripTags(text);
        item.uri = uri;
        if (uri && uri.search(/^[^:]+:\/\//) !== 0) {
            item.uri = this.options.baseUrl.replace(/\/$/, "") + "/" + uri.replace(/^\//g, "");
        }
        item.shortUrl = usga.url.short(item.uri);
        if (imageUrl) {
            item.imageUrl = usga.trimDamInUrl(imageUrl);
        }
        item.type = type;
        item.isProtected = isProtected;
        return item;
    },
    _trackDtmFullSearch: function(q, documentCount) {
        usga.trackDtm("user-full-search", {
            search: {
                term: q,
                results: documentCount
            }
        });
    },
    _trackDtmTypedSearch: function(q, documentCount, type) {
        usga.trackDtm("user-search-filter-" + (type || "all"), {
            search: {
                term: q,
                results: documentCount
            }
        });
    }
});

window.usga = window.usga || {};

(function(usga, $) {
    var isProd = usga.isProd !== undefined ? $.isFunction(usga.isProd) ? usga.isProd() : !!usga.isProd : true;
    usga.config = {
        cloudName: isProd ? "usga" : "usga",
        gigyaApiKey: isProd ? "3_2XjOryTsvLPQvhvmmwB8TY-OB_6VT05LD5NVNZjYl1TTvIhq_2kEmKcC9MG1LbVw" : "3_5B0rrVdH06F8hPSY0XgLXrpXMRDgP6M5v5lF60lKTkALovXxebE6I0IvdNBV0w2g",
        gigyaBaseServiceUrl: isProd ? "//account.usga.org" : "//staging.account.usga.org",
        teamApproachMemberInfoWebserviceUrl: isProd ? "https://members.usga.org/data/endpoints/MemberInfo.asmx" : "https://members.usga.org/qa/data/endpoints/MemberInfo.asmx",
        pipCheckOutUrl: isProd ? "https://members.usga.org/signup_membership/" : "https://members.usga.org/qa/signup_2015/signup.aspx",
        clubhouseHomeUrl: isProd ? "https://www.usga.org/clubhouse/" : "/clubhouse.html",
        defaultJoinFlowUrl: isProd ? "/clubhouse/campaigns/members-join.html" : "/clubhouse/campaigns/members-join.html",
        defaultRenewFlowUrl: isProd ? "/clubhouse/campaigns/members-renew.html" : "/clubhouse/campaigns/members-renew.html",
        defaultReacquisitionUrl: isProd ? "/clubhouse/campaigns/members-renew-offer.html" : "/clubhouse/campaigns/members-renew-offer.html",
        alternateJoinUrl: isProd ? "/clubhouse/campaigns/members-renew-guest.html" : "/clubhouse/campaigns/members-renew-guest.html",
        attivioSearchUrl: isProd ? "//search.usga.org/usga/json" : "//209.48.25.21:17000/usga/json",
        eventsPhpApiUrl: isProd ? "https://membersclubhouse.usga.org/api/" : "//events-usgamc.mngd.org/api/"
    };
})(window.usga, window.jQuery);

var usga = window.usga || {};

usga.FormValidator = usga.BaseModule.extend({
    customRules: [],
    error: null,
    errors: [],
    isValid: false,
    emailRegEx: new RegExp("^" + "[+a-zA-Z0-9_.!#$%&'*\\/=?^`{|}~-]+" + "@" + "([a-zA-Z0-9-]+\\.)+[a-zA-Z0-9]{2,63}" + "$"),
    validate: function() {
        var result = true, rules = [];
        this.error = null;
        this.errors = [];
        this.isValid = true;
        $.merge(rules, this.options.rules || []);
        $.merge(rules, this.customRules || []);
        $.each(rules, this.proxy(function(index, rule) {
            if (rule.elements && rule.validator) {
                var $elements = this.$element.find(rule.elements), validator = this.getValidatorMethod(rule.validator);
                if (!this.invokeValidator($elements, validator, rule)) {
                    result = false;
                }
            }
        }));
        if (!result && this.errors.length) {
            this.error = this.errors[0];
        }
        this.isValid = result;
        return result;
    },
    getValidatorMethod: function(field) {
        var methodName = can.camelize("validate-" + field + "-" + "field");
        return this[methodName] || null;
    },
    invokeValidator: function($elements, validator, rule) {
        if (!$elements[0] || !$.isFunction(validator) || !rule) {
            return true;
        }
        var result = true;
        $elements.each(this.proxy(function(i, el) {
            var $el = $(el);
            if (!this.validateField($el, validator, rule.options || {})) {
                result = false;
                this.errors.push({
                    message: rule.message || "",
                    field: $el.attr("name") || rule.elements || "",
                    element: $el[0]
                });
            }
        }));
        return result;
    },
    validateField: function($el, validator, validatorOptions) {
        if (!$el[0] || !$.isFunction(validator)) {
            return true;
        }
        var type = $el.prop("tagName").toLowerCase(), value;
        switch (type) {
          case "select":
            value = $el.val() === "" ? null : $el.val();
            break;

          default:
            value = $el.val().trim();
            break;
        }
        return validator.call(this, value, validatorOptions);
    },
    validateRequiredField: function(value, options) {
        var result = !!value && value.length > 0;
        return result;
    },
    validateEmailField: function(value, options) {
        if (!value) {
            return true;
        }
        return value.match(this.emailRegEx);
    },
    validateLengthofField: function(value, options) {
        if (!value || !options.maxLength) {
            return true;
        }
        return value.length <= options.maxLength;
    }
});

window.usga = window.usga || {};

(function(usga, $, UA) {
    var gigyaConfig, gigyaLoaded = false, gigyaReady = false, gigyaLoggedIn = false, gigyaCallbacks = {}, gigyaUser = null, connectedMember = null, redirectionUrl = "";
    var addCallback = function(type, callback) {
        var callbacks = gigyaCallbacks[type];
        if (!callbacks) {
            callbacks = gigyaCallbacks[type] = [];
        }
        callbacks.push(callback);
    };
    var executeCallbacks = function(type) {
        var callbacks = gigyaCallbacks[type];
        if (callbacks) {
            var args = usga.getArgs(arguments, 1);
            $.each(callbacks, function(i, callback) {
                executeCallback.apply(null, [ callback ].concat(args));
            });
        }
    };
    var executeCallback = function(callback) {
        if (typeof callback === "function") {
            var args = usga.getArgs(arguments, 1);
            callback.apply(null, args);
        }
    };
    var onGigyaEvent = function(event, data) {
        if (event === "gigya-loaded") {
            gigyaLoaded = true;
            setTimeout(getGigyaAccountInfo, 10);
        } else if (~[ "login-successful", "register-successful", "register-fan-successful", "login-connect-successful", "connect-account-successful" ].indexOf(event)) {
            var expDate = data.memberExpDate ? new Date(data.memberExpDate) : false;
            if (expDate && moment(expDate).isValid() && moment() < moment(expDate).add(1, "month")) {
                $.cookie.raw = true;
                $.cookie("__LoggedIn__", data.akamaiToken, {
                    expires: 30,
                    path: "/",
                    domain: "usga.org"
                });
            }
            var timeout = 10;
            if ((event === "register-successful" || event === "register-fan-successful") && usga.browser.safari) {
                timeout = 1e3;
            }
            setTimeout(getGigyaAccountInfo, timeout);
        } else if (event === "logout") {
            me.resetDtm();
            setLoginSessionState(true);
            $.cookie("__LoggedIn__", null, {
                path: "/"
            });
            $.removeCookie("__LoggedIn__", {
                path: "/"
            });
            setGigyaUser(null);
            executeCallbacks("logout");
        } else if (event === "connect-member-id") {
            connectedMember = data;
            executeCallbacks("connect-member-id");
        } else if (event === "close-popup") {
            executeCallbacks("close-popup");
        }
    };
    var inSsoContext = function() {
        return usga.url.query.show === "sso";
    };
    var setLoginSessionState = function(remove) {
        if (remove) {
            $.removeCookie("sessionLogin", {
                path: "/"
            });
        } else {
            $.cookie("sessionLogin", true, {
                path: "/"
            });
        }
    };
    var getLoginSessionState = function() {
        return $.cookie("sessionLogin") !== undefined;
    };
    var getGigyaAccountInfo = function() {
        if (!UA) return;
        UA.gigya.accounts.getAccountInfo({
            callback: function(response) {
                var user = response.status == "OK" ? response : null;
                setGigyaUser(user);
                if (!isAemAuthEnv() && me.isUserOnProtectedContentPage() && !me.isUserHasAccessToProtectedContent()) {
                    document.location.href = usga.config.clubhouseHomeUrl;
                }
                if (user) {
                    executeCallbacks("login", gigyaUser);
                    if (redirectionUrl && me.isUserHasAccessToProtectedContent()) {
                        document.location.href = redirectionUrl;
                    }
                    if (inSsoContext() && !me.isUserHasAccessToProtectedContent()) {
                        me.openMembershipExpiredDialog();
                    }
                    me.setDtm();
                    if (!getLoginSessionState()) {
                        setLoginSessionState();
                        me.trackDtm();
                    }
                } else {
                    if (!gigyaReady && inSsoContext()) {
                        if (usga.url.query.target) {
                            me.setRedirectionUrl(usga.url.query.target);
                        }
                        me.openNotLoggedInDialog();
                    }
                }
                if (!gigyaReady) {
                    gigyaReady = true;
                    executeCallbacks("ready", gigyaUser);
                }
            },
            include: "profile,data",
            extraProfileFields: "address,phones"
        });
    };
    var getGigyaDataStore = function(userId, callback) {
        if (!UA) return;
        UA.gigya.ds.get({
            type: "Member",
            oid: userId,
            callback: function(response) {
                if (response.status == "OK") {
                    executeCallback(callback, response);
                } else {
                    console.warn("DataStore object can not be retrieved.");
                    executeCallback(callback);
                }
            }
        });
    };
    var getProfileMailingAddress = function(userId) {
        if (!UA) {
            usga.log("usga.Gigya: UA is not available");
            return;
        }
        var d = $.Deferred(), pending = $.Deferred();
        pending.promise().then(function(profile) {
            if (profile) {
                UA.gigya.ds.get({
                    oid: userId,
                    type: "Member",
                    callback: function(response) {
                        if (!usga.isObject(response)) {
                            usga.log("usga.Gigya: wrong ds response");
                            d.resolve(false);
                        }
                        if (response.status === "OK") {
                            var address = response.data && response.data !== null && response.data.address && response.data.address !== null && response.data.address.shipping && response.data.address.billing !== null && usga.isObject(response.data.address.shipping) ? response.data.address.shipping : {};
                            profile.address1 = profile.address && profile.address !== null ? profile.address : "";
                            profile.address2 = address.address2 && address.address2 !== null ? address.address2 : "";
                            d.resolve(profile);
                        } else {
                            usga.log("usga.Gigya: " + response.errorMessage);
                            d.resolve(false);
                        }
                    }
                });
            } else {
                d.resolve(false);
            }
        });
        UA.gigya.accounts.getAccountInfo({
            callback: function(response) {
                if (!usga.isObject(response)) {
                    usga.log("usga.Gigya: wrong info response");
                    pending.resolve(false);
                }
                if (response.status == "OK") {
                    pending.resolve(response.profile && response.profile !== null && usga.isObject(response.profile) ? response.profile : {});
                } else {
                    usga.log("usga.Gigya: " + response.errorMessage);
                    pending.resolve(false);
                }
            },
            include: "profile",
            extraProfileFields: "address"
        });
        return d.promise();
    };
    var setProfileMailingAddress = function(userId, updatedAddress) {
        if (!UA) {
            usga.log("usga.Gigya: UA is not available");
            return;
        }
        var d = $.Deferred(), serializedData = JSON.stringify(updatedAddress), xhr = $.ajax({
            url: usga.config.gigyaBaseServiceUrl.replace(/\/+$/, "") + "/Services/SetProfileData.ashx",
            method: "post",
            dataType: "jsonp",
            data: {
                uid: userId,
                apiKey: usga.config.gigyaApiKey,
                data: serializedData
            }
        });
        xhr.done(function(response) {
            if (!usga.isObject(response)) {
                usga.log("usga.Gigya: wrong response");
                d.resolve(false);
            }
            if (response.status === "success") {
                d.resolve(true);
            } else {
                usga.log("usga.Gigya: " + response.error);
                d.resolve(false);
            }
        });
        xhr.fail(function(xhr, textStatus) {
            usga.log("usga.Gigya: " + textStatus);
            d.resolve(false);
        });
        return d.promise();
    };
    var setGigyaUser = function(user) {
        gigyaUser = user;
        gigyaLoggedIn = !!user;
        executeCallbacks("user", user);
    };
    var executeGigyaDisplay = function(action, options) {
        if (!UA) return;
        UA.display($.extend(options, {
            action: action
        }));
    };
    var isAemAuthEnv = function() {
        return window.CQ !== undefined;
    };
    var me = usga.Gigya = {
        init: function(config) {
            if (!UA) return;
            gigyaConfig = $.extend({}, config, {
                eventHandler: onGigyaEvent
            });
            UA.init(gigyaConfig);
        },
        isReady: function() {
            return gigyaReady;
        },
        setDtm: function() {
            var loginState = "User not logged in";
            if (gigyaUser) {
                if (this.isFederatedUserOutsideRenewalWindow()) {
                    loginState = "Federated User outside renewal window";
                } else if (this.isExpiringFederatedUserWithinRenewalWindow()) {
                    loginState = "Federated User within renewal window";
                } else if (this.isExpiredFederatedUser()) {
                    loginState = "Expired Federated User";
                } else if (this.isLapsedFederatedUser()) {
                    loginState = "Lapsed Federated User";
                } else if (this.isFan()) {
                    loginState = "Logged In Fan Account";
                } else if (this.isProspect()) {
                    loginState = "Logged in Prospect Account";
                }
            }
            usga.setDtm({
                user: {
                    loginstate: loginState,
                    id: gigyaUser ? gigyaUser.UID : "",
                    level: gigyaUser && gigyaUser.data ? gigyaUser.data.memberLevel : ""
                }
            });
        },
        resetDtm: function() {
            $.extend(window.digitalData, {
                user: null
            });
        },
        trackDtm: function() {
            usga.trackDtm("userlogin", {});
        },
        isLoggedIn: function() {
            return gigyaLoggedIn;
        },
        isMember: function() {
            if (gigyaUser) {
                var data = gigyaUser.data;
                return !!data.memberExpDate;
            }
        },
        isMembershipActual: function() {
            if (gigyaUser) {
                var data = gigyaUser.data;
                var expDate = data.memberExpDate;
                if (expDate) {
                    return moment().add(1, "month") < moment(new Date(expDate));
                }
            }
        },
        isMembershipActualOrInGracePeriod: function() {
            if (gigyaUser) {
                var data = gigyaUser.data;
                var expDate = data.memberExpDate;
                if (expDate) {
                    return moment() < moment(new Date(expDate)).add(1, "month");
                }
            }
        },
        isExpiredMember: function() {
            return this.isMember() && !this.isMembershipActual();
        },
        isUserState: function(state) {
            var isUserState = false;
            if (gigyaUser) {
                var data = gigyaUser.data;
                if (data.memberExpDate) {
                    var now = moment(), expDate = new Date(data.memberExpDate);
                    switch (state) {
                      case "standard-active":
                        isUserState = now.add(45, "day") < moment(expDate);
                        break;

                      case "standard-expiring":
                        isUserState = now.add(45, "day") >= moment(expDate);
                        break;

                      case "standard-expired":
                        isUserState = moment(expDate).add(30, "day") < now;
                        break;

                      case "standard-in-grace":
                        isUserState = moment(expDate).add(30, "day") >= now && moment(expDate) < now;
                        break;

                      default:
                        isUserState = false;
                        break;
                    }
                }
            }
            return isUserState;
        },
        isExpiringFederatedUserWithinRenewalWindow: function() {
            if (gigyaUser && this.isMember()) {
                if (gigyaUser.data.memberExpDate) {
                    var expDate = new Date(gigyaUser.data.memberExpDate);
                    return moment().add(6, "M") > moment(expDate) && moment() < moment(expDate);
                }
            }
        },
        isFederatedUserOutsideRenewalWindow: function() {
            if (gigyaUser && this.isMember() && !this.isExpiredMember()) {
                var expDate = gigyaUser.data.memberExpDate;
                if (expDate) {
                    return moment().add(6, "M") < moment(new Date(expDate));
                }
            }
        },
        isExpiredFederatedUser: function() {
            if (gigyaUser && this.isExpiredMember()) {
                var expDate = gigyaUser.data.memberExpDate;
                if (expDate) {
                    return moment() < moment(new Date(expDate)).add(6, "M");
                }
            }
        },
        isLapsedFederatedUser: function() {
            if (gigyaUser && this.isExpiredMember()) {
                return !this.isExpiredFederatedUser();
            }
        },
        isFan: function() {
            if (gigyaUser) {
                var data = gigyaUser.data;
                return !data.memberId && !data.memberExpDate;
            }
        },
        isProspect: function() {
            if (gigyaUser) {
                var data = gigyaUser.data;
                return data.memberId && !data.memberExpDate;
            }
        },
        getUser: function(callback) {
            if (gigyaReady) {
                executeCallback(callback, gigyaUser);
            } else {
                this.onReady(callback);
            }
        },
        getDataStore: function(callback) {
            me.getUser(function(user) {
                if (user) {
                    getGigyaDataStore(user.UID, callback);
                } else {
                    executeCallback(callback);
                }
            });
        },
        getProfileMailingAddress: function() {
            if (gigyaUser) {
                return getProfileMailingAddress(gigyaUser.UID);
            }
            return $.when(false);
        },
        setProfileMailingAddress: function(updatedAddress) {
            if (gigyaUser) {
                return setProfileMailingAddress(gigyaUser.UID, updatedAddress);
            }
            return $.when(false);
        },
        getConnectedMember: function() {
            return connectedMember;
        },
        login: function(options) {
            executeGigyaDisplay("sign-in", options);
        },
        logout: function() {
            if (UA) {
                UA.logout();
            }
        },
        register: function(options) {
            executeGigyaDisplay("register", options);
        },
        campaignRegister: function() {
            this.register({
                campaign: true
            });
        },
        campaignLogin: function() {
            this.login({
                campaign: true
            });
        },
        profile: function(options) {
            executeGigyaDisplay("profile", options);
        },
        connect: function(options) {
            executeGigyaDisplay("connect-member-id", options);
        },
        connectAccount: function(options) {
            executeGigyaDisplay("connect-account", options);
        },
        isUserOnProtectedContentPage: function() {
            return document.location.href.indexOf("/clubhouse/protected/") != -1;
        },
        isUserHasAccessToProtectedContent: function() {
            return this.isLoggedIn() && this.isMember() && this.isMembershipActualOrInGracePeriod();
        },
        showProtectedContentModal: function(selector, disableClose) {
            if (!this.protectedContentModal && $("#protectedContentModal").length) {
                this.protectedContentModal = new usga.ProtectedContentModal("#protectedContentModal");
            }
            if (this.protectedContentModal) {
                this.protectedContentModal.open(selector, disableClose);
            }
        },
        openNotLoggedInDialog: function() {
            this.showProtectedContentModal(".sign-in");
        },
        openNonMemberDialog: function() {
            this.showProtectedContentModal(".non-member");
        },
        openMembershipExpiredDialog: function() {
            this.showProtectedContentModal(".expired");
        },
        setRedirectionUrl: function(url) {
            redirectionUrl = url;
        },
        onReady: function(callback) {
            if (gigyaReady) {
                executeCallback(callback, gigyaUser);
            } else {
                addCallback("ready", callback);
            }
        },
        onLogin: function(callback) {
            addCallback("login", callback);
        },
        onLogout: function(callback) {
            addCallback("logout", callback);
        },
        onUser: function(callback) {
            addCallback("user", callback);
            if (gigyaReady) {
                executeCallback(callback, gigyaUser);
            }
        },
        onConnectMemberId: function(callback) {
            addCallback("connect-member-id", callback);
        },
        onClosePopup: function(callback) {
            addCallback("close-popup", callback);
        }
    };
})(window.usga, window.jQuery, window.UA);

usga = window.usga || {};

usga.JoinCampaignWorkflow = usga.BaseCampaignWorkflow.extend({
    init: function(campaignData) {
        this._super(campaignData);
    },
    start: function(params) {
        this._super(params);
        var me = this;
        this.startParams = params;
        usga.Gigya.getUser(function(user) {
            if (user) {
                me.user = user;
                me.ssoId = user.UID;
                me.loggedIn = true;
                me.loggedInWorkflow();
            } else {
                me.user = null;
                me.loggedIn = false;
                me.notLoggedInWorkflow();
            }
        });
    },
    loadedTeamApproachMemberInfoLoggedInStandardChecks: function() {
        var me = this;
        if (!this.doesMemberHaveExpirationDate()) {
            if (this.campaignData.campaign.type == "join") {
                this.showCampaignUI({
                    doneButtonClick: function() {
                        me.gotoPIPCheckOut();
                    }
                });
            } else {
                this.redirectToJoinFlow();
            }
            return;
        }
        if (this.isUserEnrolledInAutoRenew()) {
            this.displayAutoRenewModal({
                closeCallback: function() {
                    me.redirectToClubhouseHome();
                }
            });
            return;
        }
        if (this.isMemberExpirationDateGreaterThan6MonthsFromToday()) {
            this.displayIneligibleRenewalModal({
                closeCallback: function() {
                    me.redirectToClubhouseHome();
                }
            });
            return;
        }
        if (!this.hasUserBeenExpiredForMorThan6Months()) {
            this.redirectToRenewFlow();
            return;
        }
        if (this.campaignData.campaign.type == "join") {
            this.redirectToReacquisitionFlow();
            return;
        }
        this.showCampaignUI({
            doneButtonClick: function() {
                me.gotoPIPCheckOut();
            }
        });
    },
    showUIAndRequireLoginRegister: function() {
        var me = this;
        this.showCampaignUI({
            doneButtonClick: function() {
                if (me.isAlternateIdAssociated()) {
                    me.showLoginSSO({
                        email: me.taUser.Email_Address,
                        callback: function(o) {
                            if (!me.isSSOUserFederated()) {
                                me.gotoPIPCheckOut();
                                return;
                            } else {
                                me.loggedInStandardChecks();
                            }
                        }
                    });
                } else {
                    me.showRegistrationSSO({
                        email: me.taUser.Email_Address,
                        callback: function(o) {
                            if (me.isSSOUserFederated()) {
                                me.loggedInStandardChecks();
                            } else {
                                me.gotoPIPCheckOut();
                                return;
                            }
                        }
                    });
                }
            }
        });
    },
    loadedTeamApproachMemberInfoNotLoggedInStandardChecks: function() {
        var me = this;
        if (!this.doesMemberHaveExpirationDate()) {
            if (this.campaignData.campaign.type == "join") {
                this.showUIAndRequireLoginRegister();
            } else {
                this.redirectToJoinFlow();
            }
            return;
        }
        if (this.isUserEnrolledInAutoRenew()) {
            this.displayAutoRenewModal({
                closeCallback: function() {
                    me.redirectToClubhouseHome();
                }
            });
            return;
        }
        if (this.isMemberExpirationDateGreaterThan6MonthsFromToday()) {
            this.displayIneligibleRenewalModal({
                closeCallback: function() {
                    me.redirectToClubhouseHome();
                }
            });
            return;
        }
        if (!this.hasUserBeenExpiredForMorThan6Months()) {
            this.redirectToRenewFlow();
            return;
        }
        if (this.campaignData.campaign.type == "join") {
            this.redirectToReacquisitionFlow();
            return;
        }
        this.showUIAndRequireLoginRegister();
    },
    loggedInStandardChecks: function() {
        var me = this;
        this.getTeamApproachMemberInfoById({
            memberId: this.taAccountId,
            callback: function() {
                me.loadedTeamApproachMemberInfoLoggedInStandardChecks();
            }
        });
    },
    notLoggedInStandardChecks: function() {
        var me = this;
        this.getTeamApproachMemberInfoById({
            memberId: this.taAccountId,
            callback: function() {
                me.loadedTeamApproachMemberInfoNotLoggedInStandardChecks();
            }
        });
    },
    loggedInWorkflow: function() {
        var me = this;
        if (this.isSSOUserFederated()) {
            this.getTeamApproachMemberInfoById({
                memberId: this.taAccountId,
                callback: function() {
                    me.loadedTeamApproachMemberInfoLoggedInStandardChecks();
                }
            });
        } else {
            if (this.doesTaAccountIdPresentInUrl()) {
                this.isThisYou({
                    memberId: this.campaignData.queryString.id,
                    yesCallback: function() {
                        me.taAccountId = me.campaignData.queryString.id;
                        me.loadedTeamApproachMemberInfoLoggedInStandardChecks();
                    },
                    noCallback: function() {
                        me.taUser = null;
                        me.showCampaignUI({
                            doneButtonClick: function() {
                                me.gotoPIPCheckOut();
                            }
                        });
                    }
                });
            } else {
                me.showCampaignUI({
                    doneButtonClick: function() {
                        me.gotoPIPCheckOut();
                    }
                });
            }
        }
    },
    notLoggedInWorkflowShowCampaignUI: function() {
        var me = this;
        this.showCampaignUI({
            doneButtonClick: function() {
                me.showRegistrationSSO({
                    callback: function(o) {
                        if (me.isSSOUserFederated()) {
                            me.loggedInStandardChecks();
                        } else {
                            me.gotoPIPCheckOut();
                            return;
                        }
                    }
                });
            }
        });
    },
    notLoggedInWorkflow: function() {
        var me = this;
        if (this.doesTaAccountIdPresentInUrl()) {
            this.isThisYou({
                memberId: this.campaignData.queryString.id,
                yesCallback: function() {
                    me.taAccountId = me.campaignData.queryString.id;
                    me.loadedTeamApproachMemberInfoNotLoggedInStandardChecks();
                },
                noCallback: function() {
                    me.taUser = null;
                    me.notLoggedInWorkflowShowCampaignUI();
                }
            });
        } else {
            this.notLoggedInWorkflowShowCampaignUI();
        }
    }
});

usga = window.usga || {};

usga.ReacquisitionCampaignWorkflow = usga.JoinCampaignWorkflow.extend({
    prepareCampaignDataBeforeUI: function() {
        this._super();
        this.handleLevelUpByLevel("01");
    }
});

usga = window.usga || {};

usga.RenewCampaignWorkflow = usga.JoinCampaignWorkflow.extend({
    prepareCampaignDataBeforeUI: function() {
        this._super();
        this.handleLevelUp();
        this.handlePriceRange();
    },
    loggedInWorkflow: function() {
        var me = this;
        if (this.isSSOUserFederated()) {
            this.getTeamApproachMemberInfoById({
                memberId: this.taAccountId,
                callback: function() {
                    me.loadedTeamApproachMemberInfoStandardChecks();
                }
            });
        } else {
            if (this.doesTaAccountIdPresentInUrl()) {
                this.isThisYou({
                    memberId: me.campaignData.queryString.id,
                    yesCallback: function() {
                        me.taAccountId = me.campaignData.queryString.id;
                        me.loadedTeamApproachMemberInfoStandardChecks();
                    },
                    noCallback: function() {
                        me.taUser = null;
                        me.connectMemberId({
                            yesCallback: function() {
                                me.loadedTeamApproachMemberInfoStandardChecks();
                            }
                        });
                    }
                });
            } else {
                me.connectMemberId({
                    yesCallback: function() {
                        me.loadedTeamApproachMemberInfoStandardChecks();
                    }
                });
            }
        }
    },
    notLoggedInWorkflow: function() {
        var me = this;
        if (this.doesTaAccountIdPresentInUrl()) {
            this.isThisYou({
                memberId: me.campaignData.queryString.id,
                yesCallback: function() {
                    me.taAccountId = me.campaignData.queryString.id;
                    me.loadedTeamApproachMemberInfoStandardChecks();
                },
                noCallback: function() {
                    me.taUser = null;
                    me.connectMemberId({
                        yesCallback: function() {
                            me.loadedTeamApproachMemberInfoStandardChecks();
                        }
                    });
                }
            });
        } else {
            me.connectMemberId({
                yesCallback: function() {
                    me.loadedTeamApproachMemberInfoStandardChecks();
                }
            });
        }
    },
    handlingExpirationDate: function() {
        var me = this;
        if (this.isMemberExpirationDateGreaterThan6MonthsFromToday()) {
            this.displayIneligibleRenewalModal({
                closeCallback: function() {
                    me.redirectToClubhouseHome();
                }
            });
            return true;
        }
        if (this.hasUserBeenExpiredForMorThan6Months()) {
            this.redirectToReacquisitionFlow();
            return true;
        }
        return false;
    },
    loadedTeamApproachMemberInfoStandardChecks: function() {
        var me = this;
        if (this.isUserEnrolledInAutoRenew()) {
            this.displayAutoRenewModal({
                closeCallback: function() {
                    me.redirectToClubhouseHome();
                }
            });
            return;
        }
        if (this.doesMemberHaveExpirationDate()) {
            if (this.handlingExpirationDate()) return;
            this.showCampaignUI({
                doneButtonClick: function() {
                    if (me.loggedIn) me.gotoPIPCheckOut(); else {
                        me.loadedTeamApproachMemberInfoNotLoggedInStandardChecks();
                    }
                }
            });
        } else {
            this.redirectToJoinFlow();
        }
    },
    loadedTeamApproachMemberInfoNotLoggedInStandardChecks: function() {
        var me = this;
        if (this.userLevelInfo.alternateId) {
            this.showLoginSSO({
                callback: function(o) {
                    me.handleUserAfterSSONotLoggedIn();
                }
            });
        } else {
            this.showRegistrationSSO({
                callback: function(o) {
                    me.handleUserAfterSSONotLoggedIn();
                }
            });
        }
    },
    handleUserAfterSSONotLoggedIn: function() {
        var me = this;
        var accountId = me.taAccountId;
        if (me.isSSOUserFederated()) {
            if (accountId == me.taAccountId) {
                me.gotoPIPCheckOut();
                return;
            }
            me.getTeamApproachMemberInfoById({
                memberId: me.taAccountId,
                callback: function() {
                    me.uiShowed = null;
                    me.loggedIn = true;
                    me.loadedTeamApproachMemberInfoStandardChecks();
                }
            });
        } else {
            me.taAccountId = accountId;
            me.gotoPIPCheckOut();
        }
    },
    failedConnectMemberId: function() {
        this.redirectToAlternateJoinFlow();
    }
});

usga = window.usga || {};

usga.UpgradeCampaignWorkflow = usga.RenewCampaignWorkflow.extend({
    prepareCampaignDataBeforeUI: function() {
        this.campaignData.campaign.filteredLevels = [];
        for (var i = 0; i < this.campaignData.campaign.levels.length - 1; i++) {
            if (this.campaignData.campaign.levels[i].id == this.userLevelInfo.level) {
                this.campaignData.campaign.filteredLevels.push(this.campaignData.campaign.levels[i + 1]);
                break;
            }
        }
        this.handlePricingBook();
    },
    handlingExpirationDate: function() {
        var me = this;
        if (this.isMemberExpirationDateGreaterThan6MonthsFromToday()) {
            return false;
        }
        if (this.hasUserBeenExpiredForMorThan6Months()) {
            this.redirectToReacquisitionFlow();
            return true;
        }
        this.redirectToRenewFlow();
        return true;
    },
    failedConnectMemberId: function() {
        var me = this;
        this.displayNotAppropriateCampaignModal({
            closeCallback: function() {
                me.redirectToClubhouseHome();
            }
        });
    }
});

window.usga = window.usga || {};

(function(usga, $) {
    var ua = window.navigator.userAgent.toLowerCase();
    var appName = window.navigator.appName;
    var checkIE = function() {
        var re;
        var rv = false;
        if (appName == "Microsoft Internet Explorer") {
            re = new RegExp("MSIE ([0-9]{1,}[\\.0-9]{0,})", "i");
            if (!!re.exec(ua)) {
                rv = parseFloat(RegExp.$1);
            }
        } else if (appName == "Netscape") {
            re = new RegExp("Trident/.*rv:([0-9]{1,}[\\.0-9]{0,})", "i");
            if (!!re.exec(ua)) {
                rv = parseFloat(RegExp.$1);
            }
        }
        return rv;
    };
    var checkSafari = function() {
        return /^((?!chrome).)*safari/i.test(ua);
    };
    var isTouchAvailable = function() {
        var isAvailable = "ontouchstart" in window;
        if (window.navigator.msPointerEnabled) {
            isAvailable = navigator.msMaxTouchPoints > 0;
        }
        return isAvailable;
    };
    var getUrlHash = function() {
        return can.deparam(document.location.hash.substr(1));
    };
    var createUrlHash = function(params) {
        var hash = "#";
        if (usga.isObject(params)) {
            hash = hash.concat(can.param(params));
        }
        return hash;
    };
    var shortUrl = function(url, limit) {
        if (url) {
            var shortUrl = "" + url;
            limit = limit || 30;
            shortUrl = shortUrl.replace(/^(?:[^\:]+\:\/\/)*(.*)$/, "$1").replace(/(\/|#|\?)*$/, "");
            if (shortUrl.length > limit) {
                shortUrl = (shortUrl.substr(0, limit) + "...").replace(/(\?|#|\/)\.\.\./, "...");
            }
            return shortUrl;
        }
        return "";
    };
    var trimHostFromUrl = function(url) {
        if (url) {
            url = url.replace(/^(?:[^\:]+\:\/\/)*(.*)$/, "$1").replace(location.host, "").replace(/^\/+/, "/");
            return url;
        }
        return url;
    };
    $.extend(usga, {
        $: $,
        domReady: false,
        windowLoad: false,
        device: {
            ios: ua.match(/i(pod|pad|phone)/),
            android: ua.match(/android/),
            mobile: ua.search(/(i(pod|pad|phone)|android)/) !== -1
        },
        browser: {
            ie: checkIE(),
            safari: checkSafari()
        },
        supports: {
            touch: isTouchAvailable()
        },
        url: {
            query: can.deparam(document.location.search.substr(1)),
            getHash: getUrlHash,
            createHash: createUrlHash,
            "short": shortUrl,
            trimHost: trimHostFromUrl
        },
        setDtm: function(props) {
            window.digitalData = window.digitalData || {};
            window.digitalData = $.extend(true, window.digitalData, props);
        },
        trackDtm: function(event, props, onDtmTrack) {
            if (window._satellite) {
                this.setDtm(props);
                window._satellite.track(event);
                if ($.isFunction(onDtmTrack)) {
                    setTimeout(function() {
                        onDtmTrack(event, props, window.digitalData);
                    }, 1e3);
                }
            }
        },
        log: function() {
            var console = window.console;
            if (console && typeof console.log === "function") {
                console.log.apply(console, arguments);
            }
        },
        getArgs: function(args, start, count) {
            start = start || 0;
            var end = count ? start + count : args.length;
            return Array.prototype.slice.call(args, start, end);
        },
        cutText: function(text, len, appendix) {
            if (!text || text === null) {
                text = "";
            }
            text = "" + text;
            if (!len || isNaN(+len) || +len < 1) {
                len = 80;
            }
            if (appendix === undefined) {
                appendix = " ...";
            }
            if (text.length <= len) {
                return text;
            }
            var cutText = text.substr(0, len + 1), lastDelimIndex = cutText.lastIndexOf(" ");
            if (lastDelimIndex >= 0) {
                cutText = cutText.substr(0, lastDelimIndex);
            }
            if (cutText) {
                cutText += appendix;
            }
            return cutText;
        },
        quote: function(text) {
            return text.replace("\\", "\\\\").replace("'", "\\'");
        },
        stripTags: function(text) {
            if (false === (text && typeof text === "string")) {
                text = text ? "" + text : "";
            }
            return text.replace(/<[^>]+>/gi, "");
        },
        trimDamInUrl: function(url) {
            if (false === (url && typeof url === "string")) {
                url = url ? "" + url : "";
            }
            return url.replace(/^\/*content\/dam\/*/, "");
        },
        getMomentInNewYorkTimezone: function(strDate) {
            if (!strDate || typeof strDate !== "string" || !moment(strDate).isValid()) {
                return moment().tz("America/New_York");
            }
            return moment(new Date(strDate)).tz("America/New_York");
        },
        isObject: function(obj) {
            var type = typeof obj;
            return type === "function" || type === "object" && !!obj;
        },
        keys: function(obj) {
            if (!usga.isObject(obj)) {
                return [];
            }
            if (Object.keys) {
                return Object.keys(obj);
            }
            var keys = [];
            for (var key in obj) {
                if (usga.has(obj, key)) {
                    keys.push(key);
                }
            }
            return keys;
        },
        values: function(obj) {
            var keys = usga.keys(obj), length = keys.length, values = Array(length);
            for (var i = 0; i < length; i++) {
                values[i] = obj[keys[i]];
            }
            return values;
        },
        findWhere: function(items, properties) {
            var found = false;
            if (!usga.isObject(properties)) {
                properties = {};
            }
            if ($.isArray(items)) {
                $.each(items, function(index, item) {
                    var obj = item, result = true;
                    if (!usga.isObject(obj)) {
                        return true;
                    }
                    var keys = usga.keys(properties), length = keys.length;
                    for (var i = 0; i < length; i++) {
                        var key = keys[i].replace(/^\!/, ""), testKey = keys[i], negative = false;
                        if (testKey.substr(0, 1) === "!") {
                            negative = true;
                        }
                        if (negative) {
                            result = $.isArray(properties[testKey]) ? $.inArray(obj[key], properties[testKey]) === -1 : obj[key] !== properties[testKey];
                        } else {
                            result = obj[key] !== undefined && ($.isArray(properties[testKey]) ? $.inArray(obj[key], properties[testKey]) !== -1 : obj[key] === properties[key]);
                        }
                    }
                    if (result) {
                        found = index;
                        return false;
                    }
                });
            }
            return found;
        },
        has: function(obj, key) {
            return obj !== null && hasOwnProperty.call(obj, key);
        },
        reduce: function(array, callback, initialValue) {
            if (this === null) {
                return initialValue;
            }
            if (typeof callback !== "function") {
                return initialValue;
            }
            var t = usga.values(array), len = t.length >>> 0, k = 0, value = initialValue;
            for (;k < len; k++) {
                if (k in t) {
                    value = callback(value, t[k]);
                }
            }
            return value;
        },
        sum: function(array) {
            return usga.reduce(array, function(p, v) {
                return p + v;
            }, 0);
        },
        replaceURLWithHTMLLinks: function(text, newWindow) {
            var exp = /(\b(https?|ftp|file):\/\/[\-A-Z0-9+&@#\/%?=~_|!:,.;]*[\-A-Z0-9+&@#\/%=~_|])/gi, template = '<a href="$1">$1</a>';
            if (newWindow) {
                template = '<a href="$1" target="_blank">$1</a>';
            }
            return text.replace(exp, template);
        },
        replaceTwitterUsernameWithHTMLLinks: function(text, newWindow) {
            var exp = /(^|\s)@([a-z0-9_]+)/gi, template = '$1<a href="http://www.twitter.com/$2">@$2</a>';
            if (newWindow) {
                template = '$1<a href="http://www.twitter.com/$2" target="_blank">@$2</a>';
            }
            return text.replace(exp, template);
        },
        replaceHashtagsWithHTMLLinks: function(text, newWindow, network) {
            var exp = /(^|\s)#([a-z0-9_]+)/gi, socialUrl = network === "twitter" ? "http://www.twitter.com/search?q=$2" : "https://www.facebook.com/hashtag/$2", template = '$1<a href="' + socialUrl + '">#$2</a>';
            if (newWindow) {
                template = '$1<a href="' + socialUrl + '" target="_blank">#$2</a>';
            }
            return text.replace(exp, template);
        },
        scrollTo: function(element, speed) {
            var $element = $(element);
            if ($element.length) {
                speed = speed || 500;
                var top = $element.offset().top;
                $("html, body").animate({
                    scrollTop: top
                }, speed);
            }
        }
    });
    var $html = $("html");
    if (usga.browser.ie) {
        $html.addClass("ie ie" + usga.browser.ie);
    }
    if (usga.device.ios) {
        $html.addClass("ios");
    }
    if (usga.supports.touch) {
        $html.addClass("touch");
    } else {
        $html.addClass("no-touch");
    }
    $(function() {
        usga.domReady = true;
    });
    $(window).load(function() {
        usga.windowLoad = true;
    });
})(window.usga, window.jQuery);

function X2JS(config) {
    "use strict";
    var VERSION = "1.1.7";
    config = config || {};
    initConfigDefaults();
    initRequiredPolyfills();
    function initConfigDefaults() {
        if (config.escapeMode === undefined) {
            config.escapeMode = true;
        }
        config.attributePrefix = config.attributePrefix || "_";
        config.arrayAccessForm = config.arrayAccessForm || "none";
        config.emptyNodeForm = config.emptyNodeForm || "text";
        if (config.enableToStringFunc === undefined) {
            config.enableToStringFunc = true;
        }
        config.arrayAccessFormPaths = config.arrayAccessFormPaths || [];
        if (config.skipEmptyTextNodesForObj === undefined) {
            config.skipEmptyTextNodesForObj = true;
        }
        if (config.stripWhitespaces === undefined) {
            config.stripWhitespaces = true;
        }
        config.datetimeAccessFormPaths = config.datetimeAccessFormPaths || [];
        if (config.useDoubleQuotes === undefined) {
            config.useDoubleQuotes = false;
        }
    }
    var DOMNodeTypes = {
        ELEMENT_NODE: 1,
        TEXT_NODE: 3,
        CDATA_SECTION_NODE: 4,
        COMMENT_NODE: 8,
        DOCUMENT_NODE: 9
    };
    function initRequiredPolyfills() {
        function pad(number) {
            var r = String(number);
            if (r.length === 1) {
                r = "0" + r;
            }
            return r;
        }
        if (typeof String.prototype.trim !== "function") {
            String.prototype.trim = function() {
                return this.replace(/^\s+|^\n+|(\s|\n)+$/g, "");
            };
        }
        if (typeof Date.prototype.toISOString !== "function") {
            Date.prototype.toISOString = function() {
                return this.getUTCFullYear() + "-" + pad(this.getUTCMonth() + 1) + "-" + pad(this.getUTCDate()) + "T" + pad(this.getUTCHours()) + ":" + pad(this.getUTCMinutes()) + ":" + pad(this.getUTCSeconds()) + "." + String((this.getUTCMilliseconds() / 1e3).toFixed(3)).slice(2, 5) + "Z";
            };
        }
    }
    function getNodeLocalName(node) {
        var nodeLocalName = node.localName;
        if (nodeLocalName == null) nodeLocalName = node.baseName;
        if (nodeLocalName == null || nodeLocalName == "") nodeLocalName = node.nodeName;
        return nodeLocalName;
    }
    function getNodePrefix(node) {
        return node.prefix;
    }
    function escapeXmlChars(str) {
        if (typeof str == "string") return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#x27;"); else return str;
    }
    function unescapeXmlChars(str) {
        return str.replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&quot;/g, '"').replace(/&#x27;/g, "'").replace(/&amp;/g, "&");
    }
    function toArrayAccessForm(obj, childName, path) {
        switch (config.arrayAccessForm) {
          case "property":
            if (!(obj[childName] instanceof Array)) obj[childName + "_asArray"] = [ obj[childName] ]; else obj[childName + "_asArray"] = obj[childName];
            break;
        }
        if (!(obj[childName] instanceof Array) && config.arrayAccessFormPaths.length > 0) {
            var idx = 0;
            for (;idx < config.arrayAccessFormPaths.length; idx++) {
                var arrayPath = config.arrayAccessFormPaths[idx];
                if (typeof arrayPath === "string") {
                    if (arrayPath == path) break;
                } else if (arrayPath instanceof RegExp) {
                    if (arrayPath.test(path)) break;
                } else if (typeof arrayPath === "function") {
                    if (arrayPath(obj, childName, path)) break;
                }
            }
            if (idx != config.arrayAccessFormPaths.length) {
                obj[childName] = [ obj[childName] ];
            }
        }
    }
    function fromXmlDateTime(prop) {
        var bits = prop.split(/[-T:+Z]/g);
        var d = new Date(bits[0], bits[1] - 1, bits[2]);
        var secondBits = bits[5].split(".");
        d.setHours(bits[3], bits[4], secondBits[0]);
        if (secondBits.length > 1) d.setMilliseconds(secondBits[1]);
        if (bits[6] && bits[7]) {
            var offsetMinutes = bits[6] * 60 + Number(bits[7]);
            var sign = /\d\d-\d\d:\d\d$/.test(prop) ? "-" : "+";
            offsetMinutes = 0 + (sign == "-" ? -1 * offsetMinutes : offsetMinutes);
            d.setMinutes(d.getMinutes() - offsetMinutes - d.getTimezoneOffset());
        } else if (prop.indexOf("Z", prop.length - 1) !== -1) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate(), d.getHours(), d.getMinutes(), d.getSeconds(), d.getMilliseconds()));
        }
        return d;
    }
    function checkFromXmlDateTimePaths(value, childName, fullPath) {
        if (config.datetimeAccessFormPaths.length > 0) {
            var path = fullPath.split(".#")[0];
            var idx = 0;
            for (;idx < config.datetimeAccessFormPaths.length; idx++) {
                var dtPath = config.datetimeAccessFormPaths[idx];
                if (typeof dtPath === "string") {
                    if (dtPath == path) break;
                } else if (dtPath instanceof RegExp) {
                    if (dtPath.test(path)) break;
                } else if (typeof dtPath === "function") {
                    if (dtPath(obj, childName, path)) break;
                }
            }
            if (idx != config.datetimeAccessFormPaths.length) {
                return fromXmlDateTime(value);
            } else return value;
        } else return value;
    }
    function parseDOMChildren(node, path) {
        if (node.nodeType == DOMNodeTypes.DOCUMENT_NODE) {
            var result = new Object();
            var nodeChildren = node.childNodes;
            for (var cidx = 0; cidx < nodeChildren.length; cidx++) {
                var child = nodeChildren.item(cidx);
                if (child.nodeType == DOMNodeTypes.ELEMENT_NODE) {
                    var childName = getNodeLocalName(child);
                    result[childName] = parseDOMChildren(child, childName);
                }
            }
            return result;
        } else if (node.nodeType == DOMNodeTypes.ELEMENT_NODE) {
            var result = new Object();
            result.__cnt = 0;
            var nodeChildren = node.childNodes;
            for (var cidx = 0; cidx < nodeChildren.length; cidx++) {
                var child = nodeChildren.item(cidx);
                var childName = getNodeLocalName(child);
                if (child.nodeType != DOMNodeTypes.COMMENT_NODE) {
                    result.__cnt++;
                    if (result[childName] == null) {
                        result[childName] = parseDOMChildren(child, path + "." + childName);
                        toArrayAccessForm(result, childName, path + "." + childName);
                    } else {
                        if (result[childName] != null) {
                            if (!(result[childName] instanceof Array)) {
                                result[childName] = [ result[childName] ];
                                toArrayAccessForm(result, childName, path + "." + childName);
                            }
                        }
                        result[childName][result[childName].length] = parseDOMChildren(child, path + "." + childName);
                    }
                }
            }
            for (var aidx = 0; aidx < node.attributes.length; aidx++) {
                var attr = node.attributes.item(aidx);
                result.__cnt++;
                result[config.attributePrefix + attr.name] = attr.value;
            }
            var nodePrefix = getNodePrefix(node);
            if (nodePrefix != null && nodePrefix != "") {
                result.__cnt++;
                result.__prefix = nodePrefix;
            }
            if (result["#text"] != null) {
                result.__text = result["#text"];
                if (result.__text instanceof Array) {
                    result.__text = result.__text.join("\n");
                }
                if (config.stripWhitespaces) result.__text = result.__text.trim();
                delete result["#text"];
                if (config.arrayAccessForm == "property") delete result["#text_asArray"];
                result.__text = checkFromXmlDateTimePaths(result.__text, childName, path + "." + childName);
            }
            if (result["#cdata-section"] != null) {
                result.__cdata = result["#cdata-section"];
                delete result["#cdata-section"];
                if (config.arrayAccessForm == "property") delete result["#cdata-section_asArray"];
            }
            if (result.__cnt == 1 && result.__text != null) {
                result = result.__text;
            } else if (result.__cnt == 0 && config.emptyNodeForm == "text") {
                result = "";
            } else if (result.__cnt > 1 && result.__text != null && config.skipEmptyTextNodesForObj) {
                if (config.stripWhitespaces && result.__text == "" || result.__text.trim() == "") {
                    delete result.__text;
                }
            }
            delete result.__cnt;
            if (config.enableToStringFunc && (result.__text != null || result.__cdata != null)) {
                result.toString = function() {
                    return (this.__text != null ? this.__text : "") + (this.__cdata != null ? this.__cdata : "");
                };
            }
            return result;
        } else if (node.nodeType == DOMNodeTypes.TEXT_NODE || node.nodeType == DOMNodeTypes.CDATA_SECTION_NODE) {
            return node.nodeValue;
        }
    }
    function startTag(jsonObj, element, attrList, closed) {
        var resultStr = "<" + (jsonObj != null && jsonObj.__prefix != null ? jsonObj.__prefix + ":" : "") + element;
        if (attrList != null) {
            for (var aidx = 0; aidx < attrList.length; aidx++) {
                var attrName = attrList[aidx];
                var attrVal = jsonObj[attrName];
                if (config.escapeMode) attrVal = escapeXmlChars(attrVal);
                resultStr += " " + attrName.substr(config.attributePrefix.length) + "=";
                if (config.useDoubleQuotes) resultStr += '"' + attrVal + '"'; else resultStr += "'" + attrVal + "'";
            }
        }
        if (!closed) resultStr += ">"; else resultStr += "/>";
        return resultStr;
    }
    function endTag(jsonObj, elementName) {
        return "</" + (jsonObj.__prefix != null ? jsonObj.__prefix + ":" : "") + elementName + ">";
    }
    function endsWith(str, suffix) {
        return str.indexOf(suffix, str.length - suffix.length) !== -1;
    }
    function jsonXmlSpecialElem(jsonObj, jsonObjField) {
        if (config.arrayAccessForm == "property" && endsWith(jsonObjField.toString(), "_asArray") || jsonObjField.toString().indexOf(config.attributePrefix) == 0 || jsonObjField.toString().indexOf("__") == 0 || jsonObj[jsonObjField] instanceof Function) return true; else return false;
    }
    function jsonXmlElemCount(jsonObj) {
        var elementsCnt = 0;
        if (jsonObj instanceof Object) {
            for (var it in jsonObj) {
                if (jsonXmlSpecialElem(jsonObj, it)) continue;
                elementsCnt++;
            }
        }
        return elementsCnt;
    }
    function parseJSONAttributes(jsonObj) {
        var attrList = [];
        if (jsonObj instanceof Object) {
            for (var ait in jsonObj) {
                if (ait.toString().indexOf("__") == -1 && ait.toString().indexOf(config.attributePrefix) == 0) {
                    attrList.push(ait);
                }
            }
        }
        return attrList;
    }
    function parseJSONTextAttrs(jsonTxtObj) {
        var result = "";
        if (jsonTxtObj.__cdata != null) {
            result += "<![CDATA[" + jsonTxtObj.__cdata + "]]>";
        }
        if (jsonTxtObj.__text != null) {
            if (config.escapeMode) result += escapeXmlChars(jsonTxtObj.__text); else result += jsonTxtObj.__text;
        }
        return result;
    }
    function parseJSONTextObject(jsonTxtObj) {
        var result = "";
        if (jsonTxtObj instanceof Object) {
            result += parseJSONTextAttrs(jsonTxtObj);
        } else if (jsonTxtObj != null) {
            if (config.escapeMode) result += escapeXmlChars(jsonTxtObj); else result += jsonTxtObj;
        }
        return result;
    }
    function parseJSONArray(jsonArrRoot, jsonArrObj, attrList) {
        var result = "";
        if (jsonArrRoot.length == 0) {
            result += startTag(jsonArrRoot, jsonArrObj, attrList, true);
        } else {
            for (var arIdx = 0; arIdx < jsonArrRoot.length; arIdx++) {
                result += startTag(jsonArrRoot[arIdx], jsonArrObj, parseJSONAttributes(jsonArrRoot[arIdx]), false);
                result += parseJSONObject(jsonArrRoot[arIdx]);
                result += endTag(jsonArrRoot[arIdx], jsonArrObj);
            }
        }
        return result;
    }
    function parseJSONObject(jsonObj) {
        var result = "";
        var elementsCnt = jsonXmlElemCount(jsonObj);
        if (elementsCnt > 0) {
            for (var it in jsonObj) {
                if (jsonXmlSpecialElem(jsonObj, it)) continue;
                var subObj = jsonObj[it];
                var attrList = parseJSONAttributes(subObj);
                if (subObj == null || subObj == undefined) {
                    result += startTag(subObj, it, attrList, true);
                } else if (subObj instanceof Object) {
                    if (subObj instanceof Array) {
                        result += parseJSONArray(subObj, it, attrList);
                    } else if (subObj instanceof Date) {
                        result += startTag(subObj, it, attrList, false);
                        result += subObj.toISOString();
                        result += endTag(subObj, it);
                    } else {
                        var subObjElementsCnt = jsonXmlElemCount(subObj);
                        if (subObjElementsCnt > 0 || subObj.__text != null || subObj.__cdata != null) {
                            result += startTag(subObj, it, attrList, false);
                            result += parseJSONObject(subObj);
                            result += endTag(subObj, it);
                        } else {
                            result += startTag(subObj, it, attrList, true);
                        }
                    }
                } else {
                    result += startTag(subObj, it, attrList, false);
                    result += parseJSONTextObject(subObj);
                    result += endTag(subObj, it);
                }
            }
        }
        result += parseJSONTextObject(jsonObj);
        return result;
    }
    this.parseXmlString = function(xmlDocStr) {
        var isIEParser = window.ActiveXObject || "ActiveXObject" in window;
        if (xmlDocStr === undefined) {
            return null;
        }
        var xmlDoc;
        if (window.DOMParser) {
            var parser = new window.DOMParser();
            var parsererrorNS = null;
            if (!isIEParser) {
                try {
                    parsererrorNS = parser.parseFromString("INVALID", "text/xml").childNodes[0].namespaceURI;
                } catch (err) {
                    parsererrorNS = null;
                }
            }
            try {
                xmlDoc = parser.parseFromString(xmlDocStr, "text/xml");
                if (parsererrorNS != null && xmlDoc.getElementsByTagNameNS(parsererrorNS, "parsererror").length > 0) {
                    xmlDoc = null;
                }
            } catch (err) {
                xmlDoc = null;
            }
        } else {
            if (xmlDocStr.indexOf("<?") == 0) {
                xmlDocStr = xmlDocStr.substr(xmlDocStr.indexOf("?>") + 2);
            }
            xmlDoc = new ActiveXObject("Microsoft.XMLDOM");
            xmlDoc.async = "false";
            xmlDoc.loadXML(xmlDocStr);
        }
        return xmlDoc;
    };
    this.asArray = function(prop) {
        if (prop === undefined || prop == null) return []; else if (prop instanceof Array) return prop; else return [ prop ];
    };
    this.toXmlDateTime = function(dt) {
        if (dt instanceof Date) return dt.toISOString(); else if (typeof dt === "number") return new Date(dt).toISOString(); else return null;
    };
    this.asDateTime = function(prop) {
        if (typeof prop == "string") {
            return fromXmlDateTime(prop);
        } else return prop;
    };
    this.xml2json = function(xmlDoc) {
        return parseDOMChildren(xmlDoc);
    };
    this.xml_str2json = function(xmlDocStr) {
        var xmlDoc = this.parseXmlString(xmlDocStr);
        if (xmlDoc != null) return this.xml2json(xmlDoc); else return null;
    };
    this.json2xml_str = function(jsonObj) {
        return parseJSONObject(jsonObj);
    };
    this.json2xml = function(jsonObj) {
        var xmlDocStr = this.json2xml_str(jsonObj);
        return this.parseXmlString(xmlDocStr);
    };
    this.getVersion = function() {
        return VERSION;
    };
}

usga.ArticleListing = usga.BaseModule.extend({
    onDocumentReady: function() {
        this.$element.find(".article-listing__filter__dropdown .dropdown").chosen({
            disable_search_threshold: 10,
            width: "100%"
        });
    }
});

usga.Article = usga.BaseCloudinaryModule.extend({
    galleries: [],
    init: function() {
        this._super();
        this.$socialBar = this.$element.find(".side-social");
        this.applyCloudinary();
    },
    checkSocialVisibility: function() {
        var moduleHeight = this.$element.height() - 120;
        var moduleTop = this.$element.offset().top;
        var scrollTop = $(window).scrollTop();
        if (scrollTop > moduleTop + moduleHeight - this.$socialBar.height()) {
            this.$socialBar.hide();
        } else {
            this.$socialBar.show();
        }
    },
    onWindowResize: function() {
        if (!this.isSmallScreen() && !this.isMediumScreen()) {
            this.checkSocialVisibility();
        }
    },
    showMediaGallery: function(target, title, url) {
        var gallery = this.galleries[target];
        if (!gallery) {
            this.galleries[target] = gallery = new usga.Gallery(target, {
                items: url
            });
        }
        gallery.toggleExpand();
        gallery.trackDtmGallery(title);
    },
    ".article-media_gallery click": function(el) {
        this.showMediaGallery(el.data("gallery-target"), el.data("gallery-title"), el.data("gallery-url"));
    }
});

usga.BrightcovePlayer = usga.BaseModule.extend({
    scriptUrlTemplate: "//players.brightcove.net/{accountId}/{playerId}_default/index.min.js",
    onFirstShow: function() {
        var data = {
            accountId: this.options.accountId,
            playerId: this.options.playerId,
            videoId: this.options.videoId
        }, autoplay = this.options.autoplay && this.options.autoplay !== null || false, scriptUrl = can.sub(this.scriptUrlTemplate, data);
        this.$element.append(can.view("#brightcovePlayerTemplate", data));
        jQuery.ajax({
            url: scriptUrl,
            dataType: "script",
            cache: false
        }).done(function() {
            if (usga.browser.ie && usga.browser.ie < 11) {
                this.element.find(".vjs-fullscreen-control").hide();
            }
            videojs("myPlayer").ready(function() {
                if (autoplay) {
                    this.autoplay(true);
                }
            });
        });
    }
});

usga.Calculator = usga.BaseModule.extend({
    init: function() {
        this._super();
        this.$form = this.$element.find(".box-calc__general");
        this.$index = this.$form.find("input[name=index]");
        this.$rating = this.$form.find("input[name=rating]");
        this.$error = this.$element.find(".box-calc__error");
        this.$results = this.$element.find(".box-calc__result");
        if (this.options.mobile) {
            this.$fullResults = this.$results.find(".box-calc__result__full-results-content");
            this.$fullResultsButton = this.$results.find("#fullResults");
            this.$resultsTable = this.$results.find("tbody");
        }
        if (window.location.search) {
            var search = window.location.search.substring(1);
            var params = can.deparam(search);
            if (params.index && params.rating) {
                this.$index.val(params.index);
                this.$rating.val(params.rating);
                this.runCalculation();
                this.$fullResults.show();
                this.$fullResultsButton.hide();
            }
        }
    },
    calcCourse: function(strHandy, slope) {
        var handy = parseFloat(strHandy);
        var course = handy / 113 * slope;
        var isPlus = strHandy.indexOf("+") != -1;
        var floorRound = handy >= 1.5 && handy <= 9.5 && handy % 1 == .5;
        if (slope == 113 && isPlus && floorRound) {
            course = Math.floor(handy);
        } else {
            course = Math.round(course);
        }
        if (isPlus && course !== 0) {
            course = "+" + course;
        }
        return course;
    },
    formatIndex: function(index) {
        return index.toFixed(1).replace("-", "+");
    },
    calcCourseTable: function(slope) {
        var results = [ {
            start: "+9.9",
            value: this.calcCourse("+9.9", slope)
        } ];
        var course, index, end;
        for (var i = -9.8; i <= 40.4; i = i + .1) {
            index = this.formatIndex(i);
            course = this.calcCourse(index, slope);
            if (course != results[results.length - 1].value) {
                results[results.length - 1].end = this.formatIndex(i - .1);
                results.push({
                    start: index,
                    value: course
                });
            }
        }
        results[results.length - 1].end = 40.4;
        return results;
    },
    runCalculation: function() {
        var index = this.$index.val();
        var rating = this.$rating.val();
        this.clearErrorMessages();
        var valIndex = this.validateHandicapIndex(index);
        var valRating = this.validateValue(rating, ".rating", 55, 155);
        if (valIndex && valRating) {
            rating = Math.round(parseFloat(rating));
            if (index.indexOf("+") != -1) {
                index = "+" + parseFloat(index).toFixed(1);
            } else {
                index = parseFloat(index).toFixed(1);
            }
            var course = this.calcCourse(index, rating);
            this.showResults(course, index, rating);
            if (this.options.mobile) {
                this.calculateTable(rating);
            }
        } else {
            this.$error.show();
            if (this.options.mobile) {
                this.$results.hide();
                this.$form.addClass("black").addClass("collapsed");
            }
        }
    },
    calculateTable: function(rating) {
        this.$resultsTable.empty();
        var results = this.calcCourseTable(rating);
        var html = "";
        for (var i = 0; i < results.length; i++) {
            html += can.sub('<tr><td>{start} to {end}</td><td class="play">{value}</td></tr>', results[i]);
        }
        this.$resultsTable.html(html);
    },
    clearErrorMessages: function() {
        this.$error.find(".box-calc__text").hide();
    },
    validateHandicapIndex: function(index) {
        var val = index;
        if (val !== "") {
            val = parseFloat(index);
        }
        if (index.indexOf("+") != -1) {
            val = -val;
            return this.validateValue(val, ".index", -9.9, 40.4);
        } else {
            return this.validateValue(val, ".index", -500, 40.4);
        }
    },
    validateValue: function(val, selector, min, max) {
        if (val === "") {
            this.addErrorMessage(selector + ".empty");
        } else if (isNaN(val)) {
            this.addErrorMessage(selector + ".wrong");
        } else if (parseFloat(val) < min || parseFloat(val) > max) {
            this.addErrorMessage(selector + ".wrong");
        } else {
            return true;
        }
    },
    addErrorMessage: function(selector) {
        this.$error.find(selector).show();
    },
    showResults: function(course, index, rating) {
        this.$results.find(".index").html(index);
        this.$results.find(".rating").html(rating);
        this.$results.find(".course").html(course);
        if (this.options.mobile) {
            this.$error.hide();
            this.$fullResults.hide();
            this.$fullResultsButton.show();
            this.$form.addClass("black").addClass("collapsed");
        } else {
            this.$form.hide();
        }
        this.$results.show();
    },
    onDocumentReady: function() {
        this.$element.find(".custom-select").chosen();
    },
    "#calcButton click": function() {
        this.runCalculation();
    },
    "#closeErrorButton click": function() {
        this.$error.hide();
    },
    "#calcAgain click": function() {
        this.$results.hide();
        this.$index.val("");
        this.$rating.val("");
        this.$form.show();
    },
    ".box-calc__switcher__hide click": function() {
        this.$form.addClass("collapsed");
    },
    ".box-calc__switcher__show click": function() {
        this.$index.val("");
        this.$rating.val("");
        this.$form.removeClass("collapsed");
    },
    "#fullResults click": function() {
        this.$fullResults.show();
        this.$fullResultsButton.hide();
    },
    ".box-calc__link click": function(el, evt) {
        var index = encodeURIComponent(this.$index.val());
        var rating = encodeURIComponent(this.$rating.val());
        var params = "?index=" + index + "&rating=" + rating;
        var ref = el.attr("href");
        el.attr("href", ref + params);
    }
});

usga.Championships = usga.VariableSlider.extend({
    sliderSelector: ".championships__slider",
    config: {},
    _isSliderLoaded: false,
    initSlider: function() {
        this._super();
        this.togglePager();
    },
    getSliderConfig: function() {
        var config = {
            infiniteLoop: false,
            minSlides: 2,
            maxSlides: 2,
            slideWidth: this.mediumMaxWidth - 8,
            slideMargin: 30,
            adaptiveHeight: true,
            hideControlOnEnd: true,
            pager: true,
            onSliderLoad: this.proxy(this.onSliderLoaded)
        }, vSize = this.getViewportSize();
        if (vSize.width <= this.bigMaxWidth) {
            config.maxSlides = 1;
            config.minSlides = 1;
        }
        this.config = config;
        return config;
    },
    isPagerAvailable: function() {
        var items = this.$element.find(".championships__slider__item");
        if (items.length > 1) {
            var viewportWidth = this.$element.find(".bx-viewport").width(), accum = 0;
            for (var i = 0, len = items.length; i < len; i++) {
                var item = $(items[i]);
                accum += item.outerWidth(true);
            }
            if (accum - this.config.slideMargin <= viewportWidth) {
                return false;
            }
        } else {
            return false;
        }
        return true;
    },
    togglePager: function() {
        if (!this.isPagerAvailable()) {
            this.$element.addClass("championships__slider-no-pager");
            this.$element.find(".bx-controls").removeClass("bx-has-pager").find(".bx-pager").toggle(false);
        } else {
            this.$element.removeClass("championships__slider-no-pager");
            this.$element.find(".bx-controls").addClass("bx-has-pager").find(".bx-pager").toggle(true);
        }
    },
    onWindowResize: function() {
        if (this._isSliderLoaded) {
            this.togglePager();
        }
    },
    onSliderLoaded: function() {
        this._isSliderLoaded = true;
        this.togglePager();
    }
});

usga.ClubhouseEvent = usga.ClubhouseEvent || {};

usga.ClubhouseEvent.PhpApi = can.Construct({
    CLASS_NAME: "PhpApi",
    userId: 0,
    init: function() {
        if (!usga.config || !usga.config.eventsPhpApiUrl) {
            throw new Error("Endpoint is not specified", this.CLASS_NAME);
        }
    },
    setUserId: function(userId) {
        this.userId = userId;
    },
    subscribe: function(eventId) {
        return this.makeRequest("subscribe", {
            event_id: eventId,
            user_id: this.userId
        });
    },
    unsubscribe: function(eventId) {
        return this.makeRequest("unsubscribe", {
            event_id: eventId,
            user_id: this.userId
        });
    },
    getSubscribeStatus: function(eventId) {
        return this.makeRequest("getsubscribestatus", {
            event_id: eventId,
            user_id: this.userId
        });
    },
    setGuestNumber: function(eventId, guestsNumber) {
        return this.makeRequest("setguestnumber", {
            event_id: eventId,
            user_id: this.userId,
            guest_number: guestsNumber
        });
    },
    submitQuestion: function(eventId, questionText) {
        return this.makeRequest("askquestion", {
            event_id: eventId,
            user_id: this.userId,
            question: questionText
        });
    },
    makeRequest: function(method, params) {
        var p, d = $.Deferred();
        p = $.ajax({
            url: usga.config.eventsPhpApiUrl.replace(/\/+$/, "") + "/" + method,
            data: params,
            type: "post",
            dataType: "json"
        });
        p.done(function(data, textStatus, xhr) {
            if (!usga.isObject(data) || xhr.status !== 200) {
                d.resolve(new usga.ClubhouseEvent.ApiResponse({}, "usga.ClubhouseEvent.PhpApi: " + textStatus, true));
            } else {
                var response = new usga.ClubhouseEvent.ApiResponse(data);
                if (response.data.attr("status") !== "ok") {
                    response.error = true;
                    response.statusText = response.data.attr("message");
                }
                d.resolve(response);
            }
        });
        p.fail(function(xhr, textStatus) {
            d.resolve(new usga.ClubhouseEvent.ApiResponse({}, "usga.ClubhouseEvent.PhpApi: " + textStatus, true));
        });
        return d.promise();
    }
});

usga.ClubhouseEvent.ApiResponse = can.Construct({
    error: false,
    statusText: "",
    data: {},
    init: function(data, statusText, error) {
        this.data = new usga.ClubhouseEvent.ApiResponseData(data || {});
        this.statusText = statusText || "";
        this.error = error || false;
    }
});

usga.ClubhouseEvent.ApiResponseData = can.Map.extend({
    define: {
        status: {
            type: "string",
            value: "error"
        },
        message: {
            type: "string",
            value: ""
        },
        subscribed: {
            type: "boolean",
            value: false
        },
        rsvpCount: {
            type: "number",
            get: function() {
                if (!this.rsvp_count || this.rsvp_count === null) {
                    return 0;
                }
                return +this.rsvp_count;
            }
        }
    }
});

usga.ClubhouseEvent = usga.ClubhouseEvent || {};

usga.ClubhouseEvent.BaseMap = can.Map.extend({
    init: function(obj, options) {
        this._super();
        if (this.define) {
            $.each(this.define, this.proxy(function(attr, def) {
                var val = !obj || obj === null || !obj[attr] || obj[attr] === null ? undefined : obj[attr];
                if (!val && def.value !== undefined) {
                    this.attr(attr, def.value);
                }
                if (def.Type !== undefined) {
                    var type = def.Type;
                    this.attr(attr, val ? new type(val) : new type());
                }
            }));
        }
    }
});

usga.ClubhouseEvent.CustomButtonProperties = usga.ClubhouseEvent.BaseMap.extend({
    define: {
        text: {
            type: "string",
            value: ""
        },
        location: {
            type: "string",
            value: ""
        },
        target: {
            type: "string",
            value: "_self"
        }
    }
});

usga.ClubhouseEvent.Messages = usga.ClubhouseEvent.BaseMap.extend({
    define: {
        pre: {
            type: "string",
            value: "You can subscribe to this event"
        },
        exceededLimit: {
            type: "string",
            value: "Unfortunately subscribing limit is reached"
        },
        thankYou: {
            type: "string",
            value: "Thank you!"
        }
    }
});

usga.ClubhouseEvent.ProfileInformation = usga.ClubhouseEvent.BaseMap.extend({
    define: {
        firstName: {
            type: "string",
            value: ""
        },
        lastName: {
            type: "string",
            value: ""
        },
        address1: {
            type: "string",
            value: ""
        },
        city: {
            type: "string",
            value: ""
        },
        country: {
            type: "string",
            value: "US"
        },
        state: {
            type: "string",
            value: "NY"
        },
        zip: {
            type: "string",
            value: ""
        }
    }
});

usga.ClubhouseEvent.Event = usga.ClubhouseEvent.BaseMap.extend({
    define: {
        id: {
            type: "number",
            value: 0
        },
        image: {
            type: "string",
            value: ""
        },
        isMemberExclusive: {
            type: "boolean",
            value: false
        },
        isFull: {
            type: "boolean",
            value: false
        },
        title: {
            type: "string",
            value: ""
        },
        url: {
            type: "string",
            value: ""
        },
        location: {
            type: "string",
            value: ""
        },
        startDate: {
            type: "string",
            value: ""
        },
        endDate: {
            type: "string",
            value: ""
        },
        rsvpMessages: {
            Type: usga.ClubhouseEvent.Messages
        },
        details: {
            type: "string",
            value: ""
        },
        guestsMax: {
            type: "number",
            value: 0
        },
        rsvpButton: {
            type: "boolean",
            value: true
        },
        rsvpButtonText: {
            type: "string",
            value: "RSVP"
        },
        rsvpCancelButtonText: {
            type: "string",
            value: "Cancel"
        },
        askQuestionButton: {
            type: "boolean",
            value: true
        },
        askQuestionButtonText: {
            type: "string",
            value: "Ask question"
        },
        customButton: {
            type: "boolean",
            value: false
        },
        customButtonProperties: {
            Type: usga.ClubhouseEvent.CustomButtonProperties
        },
        rsvpMessage: {
            type: "string",
            value: ""
        },
        guests: {
            type: "number",
            value: 0
        },
        isUserSubscribed: {
            type: "string",
            value: ""
        },
        status: {
            type: "string",
            value: ""
        },
        statusType: {
            type: "string",
            value: ""
        }
    }
});

usga.ClubhouseEvent.EventList = can.List.extend({
    Map: usga.ClubhouseEvent.Event
}, {});

usga.BaseProfileInformation = usga.ClubhouseEvent.BaseMap.extend({
    define: {
        firstName: {
            type: "string",
            value: ""
        },
        lastName: {
            type: "string",
            value: ""
        },
        address1: {
            type: "string",
            value: ""
        },
        address2: {
            type: "string",
            value: ""
        },
        city: {
            type: "string",
            value: ""
        },
        state: {
            type: "string",
            value: "NY"
        },
        country: {
            type: "string",
            value: "US"
        },
        zip: {
            type: "string",
            value: ""
        }
    }
});

usga.RsvpProfileInformation = usga.BaseProfileInformation.extend({
    init: function() {
        this.validatePresenceOf([ "firstName" ], {
            message: "Enter first name"
        });
        this.validatePresenceOf([ "lastName" ], {
            message: "Enter last name"
        });
        this.validatePresenceOf([ "address1" ], {
            message: "Enter address"
        });
        this.validatePresenceOf([ "country" ], {
            message: "Select country"
        });
        this.validatePresenceOf([ "state" ], {
            message: "Select state"
        });
        this.validatePresenceOf([ "city" ], {
            message: "Enter city"
        });
        this.validatePresenceOf([ "zip" ], {
            message: "Enter zip"
        });
    }
}, {});

usga.AskQuestionProfileInformation = usga.BaseProfileInformation.extend({
    init: function() {
        this.validatePresenceOf([ "firstName" ], {
            message: "Enter first name"
        });
        this.validatePresenceOf([ "lastName" ], {
            message: "Enter last name"
        });
        this.validatePresenceOf([ "country" ], {
            message: "Select country"
        });
        this.validatePresenceOf([ "state" ], {
            message: "Select state"
        });
    }
}, {});

usga.ClubhouseEvent = usga.ClubhouseEvent || {};

usga.ClubhouseEvent.GigyaAuthObserver = can.Construct({
    CLASS_NAME: "GigyaAuthObserver",
    targetObj: null,
    init: function(obj) {
        this.targetObj = obj;
        if (!usga.isObject(obj) || !obj.reflectToAuthChanges) {
            throw new Error("object is not supported", this.CLASS_NAME);
        }
        if (!usga.Gigya || !usga.Gigya.onUser) {
            throw new Error("usga.Gigya is not available", this.CLASS_NAME);
        }
    },
    start: function() {
        usga.Gigya.onUser(this.proxy(this.onUser));
    },
    onUser: function(user) {
        if (user && user !== null) {
            usga.Gigya.getProfileMailingAddress().then(this.proxy(function(address) {
                if (address) {
                    this.targetObj.reflectToAuthChanges(user, address, usga.Gigya);
                }
            }));
        } else {
            this.targetObj.reflectToAuthChanges(false, {}, usga.Gigya);
        }
    }
});

usga.ClubhouseEvent = usga.ClubhouseEvent || {};

usga.ClubhouseEventList = usga.BaseCloudinaryModule.extend({
    defaults: {
        template: "list",
        events: [],
        pagination: false,
        limit: 6
    }
}, {
    CLASS_NAME: "ClubhouseEventList",
    context: {},
    api: undefined,
    observer: undefined,
    protectedContentModal: undefined,
    auth: undefined,
    user: undefined,
    userProfile: undefined,
    profileInformationModal: undefined,
    askQuestionModal: undefined,
    signInModal: undefined,
    queuedAction: "",
    helpers: undefined,
    hasProtectedContent: true,
    init: function() {
        this._super();
        var events = new usga.ClubhouseEvent.EventList(this.options.events);
        if ($("#protectedContentModal").length !== 0) {
            this.protectedContentModal = new usga.ProtectedContentModal("#protectedContentModal");
        }
        if ($("#signInModal").length !== 0) {
            this.signInModal = new usga.SignInModal("#signInModal");
        }
        this.setPagination();
        if (events.length <= this.options.limit) {
            this.options.pagination = false;
        }
        this.helpers = new usga.ClubhouseEventListRenderHelpers(this);
        this.context = new can.Map({
            options: this.options,
            isUserLoggedIn: false,
            hasAccessToExclusiveContent: false,
            currentEvent: false,
            events: events,
            filter: "all",
            paginator: new usga.Paginator({
                limit: this.options.limit
            })
        });
        this.setContextEvents();
        try {
            this.api = new usga.ClubhouseEvent.PhpApi();
            this.observer = new usga.ClubhouseEvent.GigyaAuthObserver(this);
            this.observer.start();
        } catch (e) {
            usga.log(e);
        }
        this.renderTemplate();
        this.$element.find(".guest-selection select").chosen({
            disable_search_threshold: 999,
            width: "100%"
        });
        this.context.paginator.attr("count", events.length);
        this.setPage(true);
        this.updateItemsAccordingToAuthState();
        this.applyCloudinary();
    },
    setPagination: function() {
        can.Component.extend({
            tag: "paginator",
            template: $("#clubhouseEventListPaginatorTemplate").length !== 0 ? can.view("#clubhouseEventListPaginatorTemplate") : "",
            events: {
                "a[data-page] click": this.proxy(function($el, event) {
                    event.preventDefault();
                    this.context.paginator.page($el.data("page"));
                    this.setPage();
                }),
                ".container__pagination__direction click": this.proxy(function($el, event) {
                    event.preventDefault();
                    this.setPage();
                })
            }
        });
    },
    setContextEvents: function() {
        this.context.bind("change", this.proxy(function(ev, attr, how, newVal, oldVal) {
            if (attr === "filter") {
                this.onFilterContextChanged(newVal);
            }
        }));
    },
    renderTemplate: function() {
        var template = this.getTemplate();
        if (template) {
            this.renderTemplateHtml(can.template(template, this.context, {
                setActiveFilterLink: this.proxy(this.helpers.setActiveFilterLink),
                setProtectedLink: this.proxy(this.helpers.setProtectedLink),
                renderGuestOptions: this.proxy(this.helpers.renderGuestOptions),
                renderStartDate: this.proxy(this.helpers.renderStartDate),
                renderEndDate: this.proxy(this.helpers.renderEndDate),
                renderStartTime: this.proxy(this.helpers.renderStartTime),
                hideGuestsDropdown: this.proxy(this.helpers.hideGuestsDropdown),
                testSubscriptionStatus: this.proxy(this.helpers.testSubscriptionStatus),
                testAgainstFilter: this.proxy(this.helpers.testAgainstFilter),
                renderPages: this.proxy(this.helpers.renderPages),
                setActivePage: this.proxy(this.helpers.setActivePage)
            }));
        }
    },
    getTemplate: function() {
        var selector = !usga.isObject(this.options) || !this.options.template && this.options.template === null || this.options.template === "list" ? "#clubhouseEventListTemplate" : "#clubhouseEventSingleTemplate";
        if ($(selector)[0]) {
            return selector;
        } else {
            return false;
        }
    },
    renderTemplateHtml: function(renderedTemplate) {
        if (renderedTemplate) {
            this.element.append(renderedTemplate);
        }
    },
    setPage: function(doNotScroll) {
        if (this.options.pagination) {
            var offset = this.context.paginator.attr("offset"), limit = this.options.limit && this.options.limit !== null ? this.options.limit : 10;
            var items = this.element.find(".event-item");
            items.hide();
            items.filter(":eq(" + offset + "), :gt(" + offset + ")").filter(":lt(" + limit + ")").show();
        }
        if (!doNotScroll) {
            usga.scrollTo(this.element);
        }
    },
    updateItemsAccordingToAuthState: function() {
        this.updateProtectedLinks();
        this.updateMemberExclusiveStatus(this.auth && this.auth.isUserHasAccessToProtectedContent());
        this.updateRsvpMessages();
        if (this.auth) {
            this.updateEventsAccordingToSubscriptionStatus();
        }
    },
    updateMemberExclusiveStatus: function(hasAccessToExclusiveContent) {
        if (hasAccessToExclusiveContent) {
            this.$element.find(".exclusive").removeClass("locked").addClass("unlocked");
        } else {
            this.$element.find(".exclusive").removeClass("unlocked").addClass("locked");
        }
    },
    updateRsvpMessages: function() {
        this.context.events.each(this.proxy(function(itemContext, index) {
            this.updateRsvpMessage(itemContext);
        }));
    },
    updateEventsAccordingToSubscriptionStatus: function() {
        if (this.user) {
            this.api.setUserId(this.user.UID);
        }
        var lastItemIndex = this.context.events.length;
        this.context.events.each(this.proxy(function(itemContext, index) {
            this.proxy(function() {
                if (this.user) {
                    this.api.getSubscribeStatus(itemContext.attr("id")).then(this.proxy(function(response) {
                        if (response.error) {
                            usga.log(response.statusText);
                        } else {
                            itemContext.attr("isUserSubscribed", response.data.subscribed ? "Y" : "N");
                        }
                        lastItemIndex -= 1;
                        this.updateRsvpMessage(itemContext);
                        if (lastItemIndex === 0) {
                            var events = this.context.attr("events");
                            this.context.attr("events", []);
                            this.context.attr("events", events);
                            this.calculatePages();
                            this.setPage(true);
                            this.applyCloudinary();
                        }
                    }));
                } else {
                    itemContext.attr("isUserSubscribed", "N");
                }
            })();
        }));
    },
    updateRsvpMessage: function(event) {
        if (this.user) {
            if (event.attr("isUserSubscribed") === "Y") {
                event.attr("rsvpMessage", event.attr("rsvpMessages.thankYou"));
            } else if (event.attr("isFull")) {
                event.attr("rsvpMessage", event.attr("rsvpMessages.exceededLimit"));
            } else {
                event.attr("rsvpMessage", event.attr("rsvpMessages.pre"));
            }
        } else {
            if (event.attr("isFull")) {
                event.attr("rsvpMessage", event.attr("rsvpMessages.exceededLimit"));
            } else {
                event.attr("rsvpMessage", event.attr("rsvpMessages.pre"));
            }
        }
    },
    reflectToAuthChanges: function(user, userProfile, auth) {
        this.user = user && user !== null && auth.isLoggedIn() ? user : undefined;
        this.userProfile = userProfile && userProfile !== null ? new usga.ClubhouseEvent.ProfileInformation(userProfile) : undefined;
        this.auth = auth;
        this.context.attr("isUserLoggedIn", this.user);
        this.context.attr("hasAccessToExclusiveContent", this.auth.isUserHasAccessToProtectedContent());
        this.updateItemsAccordingToAuthState();
        if (this.user) {
            this.executeQueuedAction();
        }
    },
    executeQueuedAction: function() {
        if (this.queuedAction) {
            if (this[this.queuedAction]) {
                this[this.queuedAction]();
            }
        }
    },
    rsvpToEvent: function() {
        var event = this.context.attr("currentEvent"), isQueuedAction = this.queuedAction === "rsvpToEvent";
        this.queuedAction = "";
        event.attr("status", "");
        event.attr("statusType", "");
        if (this.user) {
            if (event.isMemberExclusive && !this.auth.isMember()) {
                if (this.protectedContentModal) {
                    this.protectedContentModal.open(".non-member");
                    this.protectedContentModal.onClose = this.proxy(this.onModalInQueueClosed);
                    this.queuedAction = "rsvpToEvent";
                }
                return false;
            }
            if (event.isMemberExclusive && this.auth.isExpiredMember()) {
                if (this.protectedContentModal) {
                    this.protectedContentModal.open(".expired");
                    this.protectedContentModal.onClose = this.proxy(this.onModalInQueueClosed);
                    this.queuedAction = "rsvpToEvent";
                }
                return false;
            }
            if (!this.userProfile.attr("firstName") || !this.userProfile.attr("lastName") || !this.userProfile.attr("address1") || !this.userProfile.attr("country") || !this.userProfile.attr("state") || !this.userProfile.attr("city") || !this.userProfile.attr("zip")) {
                if (!this.profileInformationModal && $("#profileInformationModal").length !== 0) {
                    this.profileInformationModal = new usga.ProfileInformationModal("#profileInformationModal", {
                        onProfileUpdated: this.proxy(function(profile) {
                            this.userProfile.attr(profile.attr());
                            this.rsvpToEvent();
                        }),
                        profileScope: "rsvp"
                    });
                }
                if (this.profileInformationModal) {
                    this.profileInformationModal.onClose = this.proxy(this.onModalInQueueClosed);
                    this.profileInformationModal.open();
                }
                return false;
            }
        } else if (!this.user) {
            var modal = event.isMemberExclusive ? this.protectedContentModal : this.signInModal;
            if (modal) {
                modal.onClose = this.proxy(this.onModalInQueueClosed);
                if (event.isMemberExclusive) {
                    modal.open(".sign-in");
                } else {
                    modal.open();
                }
            }
            this.queuedAction = "rsvpToEvent";
            return false;
        }
        if (isQueuedAction && event.attr("guests") === 0 && event.attr("guestsMax") > 0) {
            return false;
        }
        this.api.setUserId(this.user.UID);
        this.api.getSubscribeStatus(event.attr("id")).then(this.proxy(function(response) {
            if (response.error) {
                usga.log(response.statusText);
            } else if (!response.data.subscribed) {
                this.api.subscribe(event.attr("id")).then(this.proxy(function(response) {
                    if (response.error) {
                        usga.log(response.statusText);
                        event.attr("status", "Server error");
                        event.attr("statusType", "error");
                    } else {
                        event.attr("isUserSubscribed", "Y");
                        if (event.attr("guests") > 0) {
                            this.api.setGuestNumber(event.attr("id"), event.attr("guests")).then(this.proxy(function(response) {
                                if (response.error) {
                                    usga.log(response.statusText);
                                    event.attr("status", "Server error while setting guests number");
                                    event.attr("statusType", "error");
                                }
                            }));
                        }
                    }
                    this.updateRsvpMessage(event);
                }));
            }
        }));
    },
    rsvpCancel: function() {
        var event = this.context.attr("currentEvent");
        this.queuedAction = "";
        event.attr("status", "");
        event.attr("statusType", "");
        this.api.setUserId(this.user.UID);
        this.api.unsubscribe(event.attr("id")).then(this.proxy(function(response) {
            if (response.error) {
                usga.log(response.statusText);
                event.attr("status", "Server error");
                event.attr("statusType", "error");
            } else {
                event.attr("isUserSubscribed", "N");
                var events = this.context.attr("events");
                this.context.attr("events", []);
                this.context.attr("events", events);
                var items = this.calculatePages(), page = this.context.paginator.page(), offset = this.context.paginator.attr("offset");
                if (offset == items || items < offset) {
                    if (page > 1) {
                        page -= 1;
                        this.context.paginator.page(page);
                    }
                }
                this.setPage();
                this.applyCloudinary();
            }
            this.updateRsvpMessage(event);
        }));
    },
    askQuestion: function() {
        var event = this.context.attr("currentEvent");
        this.queuedAction = "";
        event.attr("status", "");
        event.attr("statusType", "");
        if (this.user) {
            if (event.isMemberExclusive && !this.auth.isMember()) {
                if (this.protectedContentModal) {
                    this.protectedContentModal.open(".non-member");
                    this.queuedAction = "askQuestion";
                }
                return false;
            }
            if (event.isMemberExclusive && this.auth.isExpiredMember()) {
                if (this.protectedContentModal) {
                    this.protectedContentModal.open(".expired");
                    this.queuedAction = "askQuestion";
                }
                return false;
            }
            if (!this.userProfile.attr("firstName") || !this.userProfile.attr("lastName") || !this.userProfile.attr("address1") || !this.userProfile.attr("country") || !this.userProfile.attr("state")) {
                if (!this.profileInformationModal && $("#profileInformationModal").length !== 0) {
                    this.profileInformationModal = new usga.ProfileInformationModal("#profileInformationModal", {
                        onProfileUpdated: this.proxy(function(profile) {
                            this.userProfile.attr(profile.attr());
                            this.askQuestion();
                        }),
                        profileScope: "ask"
                    });
                }
                if (this.profileInformationModal) {
                    this.profileInformationModal.onClose = this.proxy(this.onModalInQueueClosed);
                    this.profileInformationModal.open();
                }
                return false;
            }
        } else if (!this.user) {
            var modal = event.isMemberExclusive ? this.protectedContentModal : this.signInModal;
            if (modal) {
                modal.onClose = this.proxy(this.onModalInQueueClosed);
                if (event.isMemberExclusive) {
                    modal.open(".sign-in");
                } else {
                    modal.open();
                }
            }
            this.queuedAction = "askQuestion";
            return false;
        }
        if (!this.askQuestionModal) {
            this.askQuestionModal = new usga.AskQuestionModal("#askQuestionModal", {
                onMessageWritten: this.proxy(function(message) {
                    this.api.setUserId(this.user.UID);
                    this.api.submitQuestion(event.attr("id"), message).then(this.proxy(function(response) {
                        if (response.error) {
                            var error = response.data.attr("message");
                            usga.log(response.statusText);
                            this.askQuestionModal.setError(error ? error : "Server error");
                        } else {
                            this.askQuestionModal.close();
                        }
                    }));
                })
            });
        }
        this.askQuestionModal.open();
    },
    calculatePages: function() {
        if (this.context.attr("filter") === "all") {
            this.context.paginator.attr("count", this.context.events.length);
            return this.context.events.length;
        } else {
            var count = 0;
            this.context.paginator.attr("count", this.context.events.length);
            this.context.events.each(this.proxy(function(itemContext, index) {
                if (itemContext.attr("isUserSubscribed") === "Y") {
                    count++;
                }
            }));
            this.context.paginator.attr("count", count);
            return count;
        }
    },
    onModalInQueueClosed: function(causedByWorkflow) {
        if (!causedByWorkflow) {
            this.queuedAction = "";
        }
    },
    onFilterContextChanged: function(newVal) {
        this.context.paginator.page(1);
        this.calculatePages();
        this.setPage();
    },
    onRsvpButtonClick: function(context, $element, event) {
        this.context.attr("currentEvent", context);
        this.queuedAction = "";
        this.rsvpToEvent();
    },
    onRsvpCancelButtonClick: function(context, $element, event) {
        this.context.attr("currentEvent", context);
        this.queuedAction = "";
        this.rsvpCancel();
    },
    onAskQuestionButtonClick: function(context, $element, event) {
        this.context.attr("currentEvent", context);
        this.queuedAction = "";
        this.askQuestion();
    },
    onLayout: function() {
        this.applyCloudinary();
    },
    ".rsvp-button click": function($element, event) {
        event.preventDefault();
        this.onRsvpButtonClick(this.context.attr("events." + $element.data("event-index")), $element, event);
    },
    ".rsvp-cancel-button click": function($element, event) {
        event.preventDefault();
        this.onRsvpCancelButtonClick(this.context.attr("events." + $element.data("event-index")), $element, event);
    },
    ".ask-question-button click": function($element, event) {
        event.preventDefault();
        this.onAskQuestionButtonClick(this.context.attr("events." + $element.data("event-index")), $element, event);
    },
    ".container__filter__dropdown select change": function($select, event) {
        $(".container__filter__dropdown select").trigger("chosen:updated");
    },
    ".container__filter__list__item click": function($item, event) {
        event.preventDefault();
        this.context.attr("filter", $item.data("filter-value"));
        this.applyCloudinary();
    }
});

usga.ClubhouseEventListRenderHelpers = can.Construct.extend({
    setActiveFilterLink: function(options) {
        var filter = this.context.filter || "all", parent = $(options.nodeList[0]).parentsUntil("ul").parent();
        parent.find(".container__filter__list__item").removeClass("active");
        parent.find('[data-filter-value="' + filter + '"]').addClass("active");
    },
    setProtectedLink: function(options) {
        var element = $(options.nodeList[0]);
        if (options.context.isMemberExclusive) {
            element.addClass("protected__link");
        }
    },
    renderGuestOptions: function(options) {
        if (options.context.guestsMax > 0) {
            var html = [];
            for (var n = 1; n <= options.context.guestsMax; n++) {
                html.push(options.fn({
                    number: n,
                    label: "+" + n + " Guests"
                }));
            }
            return html;
        }
        return "";
    },
    renderStartDate: function(options) {
        var val = options.context.attr("startDate");
        if (val === null || !val || !moment(new Date(val)).isValid()) {
            return "";
        }
        return usga.getMomentInNewYorkTimezone(val).format("MMMM D");
    },
    renderEndDate: function(options) {
        var val = options.context.attr("endDate");
        if (val === null || !val || !moment(new Date(val)).isValid()) {
            return "";
        }
        return usga.getMomentInNewYorkTimezone(val).format("D");
    },
    renderStartTime: function(options) {
        var val = options.context.attr("startDate");
        if (val === null || !val || !moment(new Date(val)).isValid()) {
            return "";
        }
        return usga.getMomentInNewYorkTimezone(val).format("h:mm a");
    },
    testSubscriptionStatus: function(flag, options) {
        if (flag === options.context.attr("isUserSubscribed")) {
            return options.fn(options.context);
        }
        return "";
    },
    hideGuestsDropdown: function(options) {
        var event = options.context;
        if (event.attr("isUserSubscribed") !== "N") {
            return options.fn(event);
        }
    },
    testAgainstFilter: function(options) {
        if (this.context.attr("filter") === "all" || this.context.attr("filter") === "my" && options.context.isUserSubscribed === "Y") {
            return options.fn(options.context);
        }
    },
    renderPages: function(options) {
        if (this.context && this.context.paginator) {
            var page = this.context.paginator.page(), pageCount = this.context.paginator.pageCount(), links = [], links2 = [], rendered = [];
            for (var i = 0; i < pageCount; i++) {
                links.push({
                    page: i + 1
                });
            }
            var left = page - 3;
            if (left < 1) {
                left = 1;
            }
            links2 = links.slice(left - 1, left + 4);
            for (var i2 = 0, len2 = links2.length; i2 < len2; i2++) {
                rendered.push(options.fn(links2[i2]));
            }
            return rendered;
        }
    },
    setActivePage: function(pageVal, options) {
        var $el = $(options.nodeList[0]), $parent = $el.parent();
        if (this.context.paginator && this.context.paginator.page() === pageVal) {
            $parent.find("[data-page]").removeClass("active");
            $el.addClass("active");
        }
    }
});

usga.Event = usga.BaseCloudinaryModule.extend({
    $slider: null,
    _slider: null,
    _sliderIsInitialized: false,
    initSlider: function() {
        var parameters = {
            slidesPerView: 1,
            simulateTouch: false,
            onSlideChangeEnd: this.proxy(this.onSliderSlideChanged)
        };
        if (this.options.delay) {
            parameters.autoplay = this.options.delay * 1e3;
        }
        if (this.options.carousel) {
            parameters.loop = true;
        }
        this.$slider = this.$element.find(".slider-wrapper");
        this._slider = new Swiper(this.$slider, parameters);
        this._sliderIsInitialized = true;
    },
    showLoader: function() {
        this.loaderModal.open();
    },
    hideLoader: function() {
        this.loaderModal.close();
    },
    showCampaign: function(data) {
        this.hideLoader();
        this.campaignData = data;
        this.campaignData.campaign.levelsTitleText = data.campaign.levelsTitle.replace("##FirstName##", data.taUser ? data.taUser.First_Name : "").replace("##LastName##", data.taUser ? data.taUser.Last_Name : "");
        if (data.campaign.filteredLevels.length > 0) this.selectLevel(data.campaign.filteredLevels[0].id);
        if (!this.campaignData.campaign.banner.slides || !$.isArray(this.campaignData.campaign.banner.slides) || this.campaignData.campaign.banner.slides.length < 2) {
            this.context.attr("hidePager", true);
        }
        this.context.attr("banner", this.campaignData.campaign.banner);
        var template = can.view("#clubhouseMembershipCampaign", this.context);
        this.$element.find(".campaign_content").empty().append(template);
        this.onFirstShow();
        var me = this;
        setTimeout(function() {
            me.initializateCategoryDropdowns();
        }, 100);
        this.onSliderSlideChanged();
    },
    initializateCategoryDropdowns: function() {
        this.$element.find(".categoryLarge").prop("selectedIndex", 0);
        this.$element.find(".categorySmall").prop("selectedIndex", 0);
        this.beautifyDropdowns();
    },
    ".member-level__item click": function(el) {
        this.selectLevel($(el).attr("levelId"));
    },
    ".level-small change": function(el) {
        this.selectLevel($(el).val());
    },
    ".done_button click": function() {
        var selectedLevel = this.context.attr("selectedLevel");
        var categoryLarge = this.$element.find(".categoryLarge");
        var categorySmall = this.$element.find(".categorySmall");
        if (this.$element.find(".inner-membership .visible-large").is(":visible")) selectedLevel.memberType = categoryLarge.val(); else selectedLevel.memberType = categorySmall.val();
        if (!selectedLevel.memberType || selectedLevel.memberType === "") {
            alert("Please specify member type.");
            return;
        }
        this.showLoader();
        this.workflow.processAction({
            selectedLevel: selectedLevel
        });
    },
    onSliderSlideChanged: function() {
        if (this._slider && this._slider !== null) {
            var $pager = this.$element.find("#slider-menu_join");
            $pager.find("a").removeClass("active");
            $pager.find("a:eq(" + (this._slider.activeIndex || 0) + ")").addClass("active");
        }
    },
    onFirstShow: function() {
        this._super();
        this.initSlider();
    },
    ensureCampaignIsNotExpired: function() {
        if (!this.options.expired) return false;
        if (this.options.expired.expiredRedirect) {
            document.location = this.options.expired.expiredRedirect;
            return true;
        }
        if (this.options.expired.expiredMessage) {
            var template = can.view("#clubhouseMembershipCampaignExpired", this.options.expired);
            this.$element.find(".campaign_content").empty().append(template);
            return true;
        }
        return false;
    },
    onDocumentReady: function() {
        if (this.ensureCampaignIsNotExpired()) return;
        this.$element.find(".guest-selection .dropdown, .container__filter__dropdown .dropdown").chosen({
            disable_search_threshold: 10,
            width: "100%"
        });
        this.loaderModal = new usga.BaseModal("#loaderModal");
        this.showLoader();
        this.context = new can.Map(this.options);
        this.context.attr("selectedLevel", null);
        $.get(this.options.campaignDataUrl, this.proxy(this.onCampaignDataLoaded));
    },
    ensureQueryStringPropertyIsNotNull: function(propertyName) {
        if (this.options.queryString[propertyName]) return;
        this.options.queryString[propertyName] = "";
    },
    onCampaignDataLoaded: function(rawdata) {
        var data;
        if (typeof rawdata === "string") data = JSON.parse(rawdata); else data = rawdata;
        if (!this.options.queryString) {
            this.options.queryString = {
                c: usga.url.query.c,
                id: usga.url.query.id,
                source: usga.url.query.source,
                cmp: usga.url.query.cmp,
                r: usga.url.query.r
            };
        }
        var queryStrings = [ "c", "id", "source", "cmp", "r" ];
        for (var i = 0; i < queryStrings.length; i++) {
            this.ensureQueryStringPropertyIsNotNull(queryStrings[i]);
        }
        data.queryString = this.options.queryString;
        this.workflow = usga.CampaignWorkflowFactory.create(data);
        this.workflow.start({
            showCampaign: this.proxy(this.showCampaign),
            showLoader: this.proxy(this.showLoader),
            hideLoader: this.proxy(this.hideLoader)
        });
    },
    selectLevel: function(levelId) {
        var me = this;
        for (i = 0; i < this.campaignData.campaign.filteredLevels.length; i++) {
            var result = this.campaignData.campaign.filteredLevels[i].id == levelId;
            this.campaignData.campaign.filteredLevels[i].selected = result;
            if (result) this.context.attr("selectedLevel", this.campaignData.campaign.filteredLevels[i]);
        }
        this.context.attr("campaignData", this.campaignData);
        this.applyCloudinary();
        this.initializateCategoryDropdowns();
    },
    beautifyDropdowns: function() {
        this.$element.find(".dropdown-white_member-level .dropdown").chosen({
            disable_search_threshold: 10,
            width: "100%"
        });
        this.$element.find(".join-membership__item_above .dropdown").chosen({
            disable_search_threshold: 10,
            width: "100%"
        });
        this.$element.find(".join-membership__item_under .dropdown").chosen({
            disable_search_threshold: 10,
            width: "100%"
        });
    },
    "#slider-menu_join a click": function($page, event) {
        event.preventDefault();
        if (this._slider && this._slider !== null && this._slider.slideTo) {
            this._slider.slideTo($page.data("slide-index") || 0);
            if (this._slider.startAutoplay) {
                this._slider.startAutoplay();
            }
        }
    }
});

usga.ClubhouseMembership = usga.BaseCloudinaryModule.extend({
    $slider: null,
    _slider: null,
    _sliderIsInitialized: false,
    initSlider: function() {
        var parameters = {
            slidesPerView: 1,
            simulateTouch: false,
            onSlideChangeEnd: this.proxy(this.onSliderSlideChanged)
        };
        if (this.options.delay) {
            parameters.autoplay = this.options.delay * 1e3;
        }
        if (this.options.carousel) {
            parameters.loop = true;
        }
        this.$slider = this.$element.find(".slider-wrapper");
        this._slider = new Swiper(this.$slider, parameters);
        this._sliderIsInitialized = true;
    },
    showLoader: function() {
        this.loaderModal.open();
    },
    hideLoader: function() {
        this.loaderModal.close();
    },
    showCampaign: function(data) {
        this.hideLoader();
        this.campaignData = data;
        this.campaignData.campaign.levelsTitleText = data.campaign.levelsTitle.replace("##FirstName##", data.taUser ? data.taUser.First_Name : "").replace("##LastName##", data.taUser ? data.taUser.Last_Name : "");
        if (data.campaign.filteredLevels.length > 0) this.selectLevel(data.campaign.filteredLevels[0].id);
        if (!this.campaignData.campaign.banner.slides || !$.isArray(this.campaignData.campaign.banner.slides) || this.campaignData.campaign.banner.slides.length < 2) {
            this.context.attr("hidePager", true);
        }
        this.context.attr("banner", this.campaignData.campaign.banner);
        var template = can.view("#clubhouseMembershipCampaign", this.context);
        this.$element.find(".campaign_content").empty().append(template);
        this.onFirstShow();
        var me = this;
        setTimeout(function() {
            me.initializateCategoryDropdowns();
        }, 100);
        this.onSliderSlideChanged();
    },
    initializateCategoryDropdowns: function() {
        this.$element.find(".categoryLarge").prop("selectedIndex", 0);
        this.$element.find(".categorySmall").prop("selectedIndex", 0);
        this.beautifyDropdowns();
    },
    ".member-level__item click": function(el) {
        this.selectLevel($(el).attr("levelId"));
    },
    ".level-small change": function(el) {
        this.selectLevel($(el).val());
    },
    ".done_button click": function() {
        var selectedLevel = this.context.attr("selectedLevel");
        var categoryLarge = this.$element.find(".categoryLarge");
        var categorySmall = this.$element.find(".categorySmall");
        if (this.$element.find(".inner-membership .visible-large").is(":visible")) selectedLevel.memberType = categoryLarge.val(); else selectedLevel.memberType = categorySmall.val();
        if (!selectedLevel.memberType || selectedLevel.memberType === "") {
            alert("Please specify member type.");
            return;
        }
        this.showLoader();
        this.workflow.processAction({
            selectedLevel: selectedLevel
        });
    },
    onSliderSlideChanged: function() {
        if (this._slider && this._slider !== null) {
            var $pager = this.$element.find("#slider-menu_join");
            $pager.find("a").removeClass("active");
            $pager.find("a:eq(" + (this._slider.activeIndex || 0) + ")").addClass("active");
        }
    },
    onFirstShow: function() {
        this._super();
        this.initSlider();
    },
    ensureCampaignIsNotExpired: function() {
        if (!this.options.expired) return false;
        if (this.options.expired.expiredRedirect) {
            document.location = this.options.expired.expiredRedirect;
            return true;
        }
        if (this.options.expired.expiredMessage) {
            var template = can.view("#clubhouseMembershipCampaignExpired", this.options.expired);
            this.$element.find(".campaign_content").empty().append(template);
            return true;
        }
        return false;
    },
    onDocumentReady: function() {
        if (this.ensureCampaignIsNotExpired()) return;
        this.loaderModal = new usga.BaseModal("#loaderModal");
        this.showLoader();
        this.context = new can.Map(this.options);
        this.context.attr("selectedLevel", null);
        $.get(this.options.campaignDataUrl, this.proxy(this.onCampaignDataLoaded));
    },
    ensureQueryStringPropertyIsNotNull: function(propertyName) {
        if (this.options.queryString[propertyName]) return;
        this.options.queryString[propertyName] = "";
    },
    onCampaignDataLoaded: function(rawdata) {
        var data;
        if (typeof rawdata === "string") data = JSON.parse(rawdata); else data = rawdata;
        if (!this.options.queryString) {
            this.options.queryString = {
                c: usga.url.query.c,
                id: usga.url.query.id,
                source: usga.url.query.source,
                cmp: usga.url.query.cmp,
                r: usga.url.query.r
            };
        }
        var queryStrings = [ "c", "id", "source", "cmp", "r" ];
        for (var i = 0; i < queryStrings.length; i++) {
            this.ensureQueryStringPropertyIsNotNull(queryStrings[i]);
        }
        data.queryString = this.options.queryString;
        this.workflow = usga.CampaignWorkflowFactory.create(data);
        this.workflow.start({
            showCampaign: this.proxy(this.showCampaign),
            showLoader: this.proxy(this.showLoader),
            hideLoader: this.proxy(this.hideLoader)
        });
    },
    selectLevel: function(levelId) {
        var me = this;
        for (i = 0; i < this.campaignData.campaign.filteredLevels.length; i++) {
            var result = this.campaignData.campaign.filteredLevels[i].id == levelId;
            this.campaignData.campaign.filteredLevels[i].selected = result;
            if (result) this.context.attr("selectedLevel", this.campaignData.campaign.filteredLevels[i]);
        }
        this.context.attr("campaignData", this.campaignData);
        this.applyCloudinary();
        this.initializateCategoryDropdowns();
    },
    beautifyDropdowns: function() {
        this.$element.find(".dropdown-white_member-level .dropdown").chosen({
            disable_search_threshold: 10,
            width: "100%"
        });
        this.$element.find(".join-membership__item_above .dropdown").chosen({
            disable_search_threshold: 10,
            width: "100%"
        });
        this.$element.find(".join-membership__item_under .dropdown").chosen({
            disable_search_threshold: 10,
            width: "100%"
        });
    },
    "#slider-menu_join a click": function($page, event) {
        event.preventDefault();
        if (this._slider && this._slider !== null && this._slider.slideTo) {
            this._slider.slideTo($page.data("slide-index") || 0);
            if (this._slider.startAutoplay) {
                this._slider.startAutoplay();
            }
        }
    }
});

usga.contactUs = usga.BaseModule.extend({
    defaults: {
        successMessage: "Thank you for your Submission",
        memberIdRequiredMessage: "Enter Member ID",
        requiredMemberFieldForSubject: null,
        visibleMemberFieldForSubject: null
    }
}, {
    $memberId: null,
    init: function() {
        this._super();
        this.$memberId = this.$element.find('select[name="Member_ID"]');
        this.initMemberIdField();
    },
    initMemberIdField: function(selectedSubjectIndex) {
        selectedSubjectIndex = selectedSubjectIndex || this.$element.find(".contact-us__form__select_subject option:selected").index();
        this.$element.find(".contact-us__form__member_id").toggle(false);
        this.options.validator.customRules = [];
        if (selectedSubjectIndex !== -1) {
            if (this.options.requiredMemberFieldForSubject && this.options.requiredMemberFieldForSubject[selectedSubjectIndex]) {
                this.options.validator.customRules = [ {
                    elements: 'input[name="Member_ID"]',
                    validator: "required",
                    message: this.options.memberIdRequiredMessage
                } ];
            }
            this.$element.find(".contact-us__form__member_id").toggle(this.options.visibleMemberFieldForSubject && this.options.visibleMemberFieldForSubject[selectedSubjectIndex]);
        }
    },
    reset: function() {
        this.$element.removeClass("error").removeClass("success").find(".invalid").removeClass("invalid");
        this.$element.find(".contact-us__error").find(".contact-us__error__text").empty();
        this.$element.find(".contact-us__success").find(".contact-us__success__inner").empty();
    },
    setBasicError: function(message) {
        this.setError(message);
    },
    setValidationClass: function(el) {
        $(el).each(function() {
            $(this).closest(".contact-us__form__container").addClass("invalid");
        });
    },
    setValidationError: function() {
        var validator = this.options.validator;
        for (var i = 0, len = validator.errors.length; i < len; i++) {
            var result = validator.errors[i];
            this.setValidationClass(result.element);
        }
        this.setError(validator.error.message);
    },
    setError: function(message) {
        var $errorElement = this.$element.find(".contact-us__error .contact-us__error__text");
        this.$element.addClass("error");
        if (message) {
            $errorElement.append(message);
        }
    },
    setSuccess: function(message) {
        this.$element.find(".contact-us__form__wrap").hide();
        this.$element.find(".contact-us__success-message").show();
    },
    serializeForm: function() {
        var serialized = this.$element.find(".contact-us__form").serializeArray(), serializedObj = {};
        for (var i = 0, len = serialized.length; i < len; i++) {
            serializedObj[serialized[i].name] = serialized[i].value;
        }
        return serializedObj;
    },
    serialize: function() {
        var serializedObj = this.serializeForm(), obj = {}, selectedSubjectIndex = this.$element.find(".contact-us__form__select_subject option:selected").index();
        $.each([ "Full_Name", "Email", "Country", "Subject", "Email_Target", "Message", "Member_ID" ], function(i, property) {
            if (serializedObj[property]) {
                obj[property] = serializedObj[property];
            }
        });
        if (false === (selectedSubjectIndex !== -1 && this.options.visibleMemberFieldForSubject && this.options.visibleMemberFieldForSubject[selectedSubjectIndex])) {
            delete obj.Member_ID;
        }
        return obj;
    },
    submit: function() {
        var xhr = $.ajax({
            url: this.options.defaultAction || "#",
            type: "POST",
            data: this.serialize()
        });
        xhr.fail(this.proxy(this.onFailedSubmit));
        xhr.done(this.proxy(this.onSuccessSubmit));
    },
    onDocumentReady: function() {
        this.$element.find(".contact-us__form__select .dropdown").chosen({
            disable_search_threshold: 10,
            width: "100%"
        });
    },
    onFailedSubmit: function(xhr) {
        this.setBasicError(xhr.statusText);
    },
    onSuccessSubmit: function(xhr) {
        this.setSuccess();
    },
    ".contact-us__form__select_subject change": function($el, event) {
        var selectedIndex = $el.find("option:selected").index();
        if (selectedIndex !== -1) {
            this.$element.find(".contact-us__form__target option:eq(" + selectedIndex + ")").prop("selected", "selected");
        }
        this.initMemberIdField(selectedIndex);
    },
    ".contact-us__form submit": function($el, event) {
        var validator = this.options.validator, isValid = validator.validate();
        this.reset();
        if (!isValid) {
            this.setValidationError();
        } else {
            this.submit();
        }
        if (!(this.isBiggerScreen() || this.isInfinityScreen())) {
            window.usga.scrollTo(this.$element);
        }
        event.preventDefault();
        event.stopPropagation();
    }
});

usga.CourseOverview = usga.BaseCloudinaryModule.extend({
    initSlider: function() {
        this.slider = this.$element.find(".course-overview__slider").bxSlider({
            adaptiveHeight: true,
            onSliderLoad: this.proxy(this.onSliderLoad),
            touchEnabled: usga.supports.touch
        });
        this.$pager = this.$element.find(".bx-controls");
    },
    setPagerPosition: function() {
        if (this.isSmallScreen() || this.isMediumScreen()) {
            var imageHeight = this.$element.find(".course-overview__slider__item:nth-child(2) > img").height();
            this.$pager.css("top", imageHeight);
        }
    },
    redrawSlider: function() {
        var self = this;
        setTimeout(function() {
            self.slider.redrawSlider();
        }, 500);
    },
    onSliderLoad: function() {
        this.setPagerPosition();
        this.redrawSlider();
    },
    onWindowResize: function() {
        this.setPagerPosition();
    },
    onFirstShow: function() {
        this._super();
        this.initSlider();
    }
});

usga.Definitions = usga.BaseCloudinaryModule.extend({
    sliders: [],
    onDocumentReady: function() {
        var $items = this.$element.find(".definition__item__slider .slider");
        var slider;
        for (var i = 0; i < $items.length; i++) {
            slider = $($items[i]).bxSlider({
                adaptiveHeight: true,
                touchEnabled: usga.supports.touch
            });
            this.sliders.push(slider);
        }
    }
});

usga.FAQ = usga.BaseCloudinaryModule.extend({
    queriedQuestion: null,
    context: null,
    $categoriesSelect: null,
    $questionsSelect: null,
    onDocumentReady: function() {
        this.queriedQuestion = this.getQueriedQuestion();
        this.context = new can.Map(this.options);
        this.context.attr("selectedCategoryOption", null);
        this.context.attr("selectedQuestionOption", null);
        this.context.attr("selectedQuestion", null);
        this.$element.find(".faq__content").append(can.view("#faqForm", this.context));
        this.$categoriesSelect = this.$element.find(".dropdown-categories .dropdown");
        this.$questionsSelect = this.$element.find(".dropdown-questions .dropdown");
        this.preselect();
        this.scrollIntoView();
        this.updateCategories();
        this.updateQuestions();
        this.context.bind("change", this.proxy(this.onCategoryContextChange));
    },
    getQueriedQuestion: function() {
        var found = null, searchingId = usga.url.getHash()["faq-id"];
        if (searchingId) {
            $.each(this.options.categories, function(categoryPosition, category) {
                var position = usga.findWhere(category.questions, {
                    id: searchingId
                });
                if (position !== false) {
                    found = {
                        id: searchingId,
                        category: categoryPosition,
                        question: position
                    };
                }
            });
        }
        return found;
    },
    preselect: function() {
        var selectedCategoryIndex = null, selectedQuestionIndex = null, selectedQuestion = null;
        if (this.queriedQuestion !== null) {
            selectedCategoryIndex = this.queriedQuestion.category;
            selectedQuestionIndex = this.queriedQuestion.question;
            selectedQuestion = this.context.categories[selectedCategoryIndex].questions[selectedQuestionIndex];
        } else if (this.context.categories.length === 1) {
            selectedCategoryIndex = 0;
            if (this.context.categories[0].questions.length === 1) {
                selectedQuestionIndex = 0;
                selectedQuestion = this.context.categories[selectedCategoryIndex].questions[selectedQuestionIndex];
            }
        }
        if (selectedCategoryIndex !== null) {
            this.$questionsSelect.removeAttr("disabled");
        }
        this.context.attr("selectedCategoryOption", selectedCategoryIndex);
        this.context.attr("selectedQuestionOption", selectedQuestionIndex);
        this.context.attr("selectedQuestion", selectedQuestion);
        if (selectedQuestion) {
            this.trackDtm(selectedQuestion);
        }
    },
    scrollIntoView: function() {
        this.setLocation(this.queriedQuestion, true);
    },
    setLocation: function(question, isOnLoad) {
        if (question && question.id) {
            document.location.replace(usga.url.createHash({
                "faq-id": question.id
            }));
        }
    },
    trackDtm: function(question) {
        usga.trackDtm("faq", {
            page: {
                attributes: {
                    FAQ: question.question
                }
            }
        });
    },
    updateCategories: function() {
        var me = this, select = this.$categoriesSelect;
        select.empty();
        select.append($("<option/>").html("Select a Category"));
        $.each(this.context.categories, function(i, category) {
            var option = $("<option/>");
            option.val(i).html(category.name);
            if (me.context.selectedCategoryOption === i) {
                option.prop("selected", "selected");
            }
            select.append(option);
        });
        select.selectOrDie("destroy");
        select.selectOrDie({
            placeholderOption: true,
            onChange: function() {
                me.onCategorySelect.call(me, $(this));
            }
        });
    },
    updateQuestions: function() {
        var me = this, select = this.$questionsSelect, group = $("<optgroup/>").attr("label", "Select a Question");
        select.empty();
        select.append($("<option/>").html("Select a Question"));
        if (this.context.selectedCategoryOption !== null) {
            $.each(this.context.categories[this.context.selectedCategoryOption].questions, function(i, question) {
                var option = $("<option/>");
                option.val(i);
                option.html(question.question);
                if (me.context.selectedQuestionOption === i) {
                    option.prop("selected", "selected");
                }
                group.append(option);
            });
        }
        select.append(group);
        select.selectOrDie("destroy");
        select.selectOrDie({
            placeholderOption: true,
            onChange: function() {
                me.onQuestionSelect.call(me, $(this));
            }
        });
    },
    onCategoryContextChange: function(ev, attr, how, newVal, oldVal) {
        if (attr === "selectedCategoryOption") {
            this.updateQuestions();
        }
    },
    onCategorySelect: function($el) {
        var i = +$el.val(), selectedQuestionOption = null, selectedQuestion = null;
        if (this.context.categories[i].questions.length === 1) {
            selectedQuestionOption = 0;
            selectedQuestion = this.context.categories[i].questions[0];
            this.trackDtm(selectedQuestion);
            this.setLocation(selectedQuestion);
        }
        this.context.attr("selectedQuestionOption", selectedQuestionOption);
        this.context.attr("selectedQuestion", selectedQuestion);
        this.context.attr("selectedCategoryOption", i);
        this.$questionsSelect.selectOrDie("enable");
    },
    onQuestionSelect: function($el) {
        var i = +$el.val(), question = this.context.categories[this.context.selectedCategoryOption].questions[i];
        this.trackDtm(question);
        this.setLocation(question);
        this.context.attr("selectedQuestionOption", i);
        this.context.attr("selectedQuestion", question);
    }
});

usga.Footer = usga.BaseCloudinaryModule.extend({
    socialApiLoaded: false,
    onDocumentReady: function() {
        this.$element.find(".footer__list__item_gmod1 :link").each(function(i, link) {
            var newHref = $(link).data("href") || $(link).attr("href");
            if (usga.device.ios && $(link).data("href-ios")) {
                newHref = $(link).data("href-ios");
            } else if (usga.device.android && $(link).data("href-android")) {
                newHref = $(link).data("href-android");
            }
            $(link).attr("href", newHref);
        });
    },
    loadSocialAPI: function() {
        if (!this.socialApiLoaded && !this.isSmallScreen()) {
            this.socialApiLoaded = true;
            $.getScript("//apis.google.com/js/platform.js");
            $.getScript("//platform.linkedin.com/in.js");
        }
    },
    onFirstShow: function() {
        this._super();
        this.loadSocialAPI();
    },
    onLayout: function() {
        this._super();
        if (this.loaded) {
            this.loadSocialAPI();
        }
    }
});

var usga = window.usga || {};

usga.Gallery = usga.BaseModule.extend({
    galleryScriptUrl: "js/juicebox.min.js",
    galleryLoaded: false,
    loadGallery: function(callback) {
        if (this.galleryLoaded) {
            callback();
        } else {
            $.getScript(usga.config.galleryScriptUrl || this.galleryScriptUrl, callback);
        }
    }
}, {
    gallery: null,
    expanded: false,
    toggleExpand: function() {
        this.expanded = !this.expanded;
        if (this.gallery) {
            this.gallery.toggleExpand();
        }
    },
    trackDtmGallery: function(title) {
        if (title) {
            usga.trackDtm("photo-gallery-launch", {
                photogallery: {
                    name: title
                }
            });
        }
    },
    trackDtmPhoto: function(title) {
        if (title) {
            usga.trackDtm("photo-gallery-image-view", {
                photo: {
                    name: title
                }
            });
        }
    },
    onFirstShow: function() {
        usga.Gallery.loadGallery(this.proxy(this.onGalleryLoad));
        this.trackDtmGallery(this.options.title);
    },
    onGalleryLoad: function() {
        if (window.juicebox) {
            this.gallery = new window.juicebox({
                containerId: this.$element.attr("id"),
                configUrl: this.options.items,
                screenMode: "large",
                thumbWidth: 128,
                thumbHeight: 72,
                galleryTitle: "",
                thumbFrameColor: "rgba(101,104,107,.9)",
                thumbSelectedFrameWidth: "6",
                backgroundColor: "2a2e34",
                showOpenButton: false,
                showAutoPlayButton: false,
                showThumbsOnLoad: false,
                showThumbsButton: true,
                showImageOverlay: "always",
                expandInNewPage: false,
                buttonBarPosition: "top",
                buttonBarIconSize: "15",
                captionPosition: "bottom",
                themeUrl: "#juicebox.css"
            });
            this.gallery.onImageChange = this.proxy(this.onImageShow);
            if (this.expanded) {
                this.gallery.toggleExpand();
            }
        }
    },
    onImageShow: function(e) {
        var imageInfo = this.gallery.getImageInfo(e.id);
        this.trackDtmPhoto(imageInfo.title || imageInfo.id);
    }
});

usga.HeaderBox = usga.BaseModule.extend({
    onDocumentReady: function() {
        this.$element.find(".header-box__list-dropdown .dropdown").chosen({
            disable_search_threshold: 10,
            width: "100%"
        });
    }
});

usga.Hero = usga.BaseCloudinaryModule.extend({
    hasProtectedContent: true,
    hasLiveEvent: null,
    isLive: null,
    updateDelay: 1e4,
    slides: null,
    links: null,
    init: function() {
        this._super();
        if (this.options.live) {
            this.element.addClass("live");
        }
        if (!this.isPagerAvailable()) {
            this.$element.addClass("hero__slider-no-pager");
        }
    },
    initLiveUpdate: function() {
        this.slides = this.$element.find(".hero__slider__item");
        this.links = this.$element.find(".slider-menu__item");
        this.selectLiveSlides();
    },
    selectLiveSlides: function() {
        this.hasLiveEvent = false;
        var now = new Date().valueOf();
        var startDates = this.options.tickerStartDates;
        var endDates = this.options.tickerEndDates;
        var output = {
            activeLiveSlidesIndexes: [],
            inActiveLiveSlidesIndexes: []
        };
        for (var i = 0, ii = startDates.length; i < ii; i++) {
            var startDate = startDates[i];
            var endDate = endDates[i];
            if (startDate && endDate) {
                if (startDate < now && now < endDate) {
                    this.hasLiveEvent = true;
                    output.activeLiveSlidesIndexes.push(i);
                } else {
                    output.inActiveLiveSlidesIndexes.push(i);
                }
            }
        }
        this.toggleSlides(output);
    },
    toggleSlides: function(data) {
        if (this.isLive !== this.hasLiveEvent) {
            this.destroySlider();
            if (this.hasLiveEvent) {
                this.switchOnLive(data);
            } else {
                this.switchOffLive(data);
            }
            this.changeFirstLink();
            this.initSlider();
            this.isLive = this.hasLiveEvent;
        }
        window.setTimeout(this.proxy(function() {
            this.selectLiveSlides();
        }), this.updateDelay);
    },
    changeFirstLink: function() {
        var links = this.element.find(".slider-menu__item");
        links.removeClass("first-in-set").find(".slider-menu__item__link").removeClass("active");
        for (var i = 0, ii = links.length; i < ii; i++) {
            var link = $(links[i]);
            if (link.is(":visible")) {
                link.addClass("first-in-set").find(".slider-menu__item__link").addClass("active");
                break;
            }
        }
    },
    setFirstSlide: function() {
        var slides = this.element.find(".hero__slider__item");
        for (var i = 0, ii = slides.length; i < ii; i++) {
            var slide = $(slides[i]);
            if (slide.is(":visible")) {
                this.slider.goToSlide(i);
                break;
            }
        }
    },
    switchOnLive: function(data) {
        this.slides.hide().filter(function(index) {
            return data.activeLiveSlidesIndexes.indexOf(index) !== -1;
        }).show();
        this.links.hide().filter(function(index) {
            return data.activeLiveSlidesIndexes.indexOf(index) !== -1;
        }).show();
    },
    switchOffLive: function(data) {
        this.slides.show().filter(function(index) {
            return data.activeLiveSlidesIndexes.indexOf(index) !== -1 || data.inActiveLiveSlidesIndexes.indexOf(index) !== -1;
        }).hide();
        this.links.show().filter(function(index) {
            return data.activeLiveSlidesIndexes.indexOf(index) !== -1 || data.inActiveLiveSlidesIndexes.indexOf(index) !== -1;
        }).hide();
    },
    initSlider: function() {
        var self = this;
        var $pager = this.$element.find("#hero__pagination");
        var config = {
            infiniteLoop: false,
            pagerCustom: $pager,
            controls: this.options.live ? false : true,
            adaptiveHeight: true,
            touchEnabled: usga.supports.touch,
            onSliderLoad: function() {
                window.setTimeout(function() {
                    self.setFirstSlide();
                }, 10);
            }
        };
        if (this.isPagerAvailable()) {
            if (this.options.delay) {
                config.auto = true;
                config.pause = this.options.delay * 1e3;
            }
            $pager.toggle(true);
        } else {
            config.touchEnabled = false;
            config.infiniteLoop = false;
            $pager.toggle(false);
        }
        this.slider = this.$element.find(".hero__slider").bxSlider(config);
        this.updateProtectedLinks();
    },
    redrawSlider: function() {
        var self = this;
        setTimeout(function() {
            self.slider.redrawSlider();
        }, 800);
    },
    destroySlider: function() {
        if (this.slider) {
            this.slider.destroySlider();
            this.slider = null;
        }
    },
    onLayout: function() {
        this._super();
        this.redrawSlider();
    },
    onFirstShow: function() {
        this._super();
        this.$element.removeClass("loading");
        if (this.options.tickerStartDates && this.options.tickerEndDates) {
            this.initLiveUpdate();
        } else {
            this.initSlider();
        }
    },
    isPagerAvailable: function() {
        return this.$element.find(".hero__slider__item").length > 1;
    }
});

usga.History = usga.BaseCloudinaryModule.extend({
    applyCloudinary2: function() {
        var photos = this.$element.find(".history__item__media img[data-src]");
        var pConfig = {
            width: 370,
            height: 434,
            quality: 70,
            crop: "fill"
        };
        this.applyCloudinaryConfig(photos, pConfig);
        var roundPhoto = this.$element.find("img.history__item__img[data-src]");
        rpConfig = {
            width: 158,
            height: 158,
            crop: "fill",
            radius: "max"
        };
        this.applyCloudinaryConfig(roundPhoto, rpConfig);
    },
    onFirstShow: function() {
        if (!this.isSmallScreen()) {
            this._super();
        } else {
            this.applyCloudinary(this.$element.find(".box-redirect-small"));
        }
    },
    onLayout: function() {
        if (!this.isSmallScreen()) {
            this._super();
        } else {
            this.applyCloudinary(this.$element.find(".box-redirect-small"));
        }
    }
});

usga.Join = usga.BaseModule.extend({
    onDocumentReady: function() {
        this.$element.find(".dropdown_above").chosen({
            disable_search_threshold: 10,
            width: "100%"
        });
        this.$element.find(".dropdown_under").chosen({
            disable_search_threshold: 10,
            width: "100%"
        });
    }
});

var usga = window.usga || {};

usga.Latest = usga.BaseCloudinaryModule.extend({
    CSS_DOUBLE_SIZE_CLASS: "block__card_double",
    CSS_ONLY_CHANNELS_CLASS: "latest__only_channels",
    defaults: {
        channelsLabels: {
            everything: "everything",
            news: "news",
            videos: "video",
            photos: "photo",
            social: "social"
        },
        channels: {
            everything: "",
            videos: "",
            photos: "",
            news: "",
            social: ""
        },
        editorialFeed: "",
        defaultChannel: "everything",
        hubMode: false,
        hubType: "long",
        limit: 5,
        adaptItems: true,
        hubLongModeLimit: 22,
        hubShortModeLimit: 10,
        hubSmallLongModeLimit: 9,
        hubSmallShortModeLimit: 7,
        hubLongModeShowMoreCount: 20,
        hubShortModeShowMoreCount: 8,
        hubSmallLongModeShowMoreCount: 8,
        hubSmallShortModeShowMoreCount: 6,
        category: "",
        subCategory: "",
        categories: {},
        moreLinkUrl: "",
        moreLinkText: "",
        hideFilters: true,
        hideCategoriesFilter: false,
        hideChannelsFilter: false,
        hideShowMoreButton: true,
        instagramPageUrl: "http://instagram.com",
        facebookPageUrl: "https://www.facebook.com/USGA",
        twitterPageUrl: "https://twitter.com/usga"
    }
}, {
    hasProtectedContent: true,
    $category: null,
    $showMoreButton: null,
    context: {},
    channels: {},
    editorialChannel: null,
    _renderSubCategory: false,
    _isDoubleSizeDisabled: false,
    _adapting: false,
    _notRenderedItems: [],
    _screenSize: "infinity",
    init: function() {
        this._super();
        this._screenSize = this.getScreenSize();
        this.options.limit = this._getLimit();
        this.options.showMoreCount = this._getShowMoreCount();
        this.options.adaptItems = this.options.adaptItems && this.options.adaptItems !== null;
        this.options.moreLinkUrl = this.options.moreLinkUrl && typeof this.options.moreLinkUrl === "string" ? this.options.moreLinkUrl : "";
        this.options.moreLinkText = this.options.moreLinkText && typeof this.options.moreLinkText === "string" ? this.options.moreLinkText : "LATEST FROM THE USGA";
        this.context = new can.Map({
            channel: this.options.defaultChannel || "everything",
            categories: this.options.categories,
            category: null,
            subCategory: this.options.subCategory && this.options.subCategory !== null ? this.options.subCategory : "",
            items: [],
            options: this.options,
            isLoading: true
        });
        this._setupChannels();
        if (!this.channels[this.context.channel]) {
            usga.log("Latest: select default channel");
            return;
        }
        this._setEvents();
        this._setClassesToContainer();
        if (this.options.category) {
            this._renderSubCategory = !this.options.subCategory;
        }
        this._renderTemplate();
        this.context.attr("category", this.options.category || "all");
        this.updateChosen();
    },
    _getHubType: function() {
        return !this.options.hubType || this.options.hubType === null || this.options.hubType === "long" || [ "long", "short" ].indexOf(this.options.hubType) === -1 ? "long" : "short";
    },
    _getHubLimit: function(screen) {
        var mode = this._getHubType();
        if (screen !== "small") {
            if (mode === "long") {
                return !this.options.hubLongModeLimit || this.options.hubLongModeLimit === null ? 22 : this.options.hubLongModeLimit;
            } else {
                return !this.options.hubShortModeLimit || this.options.hubShortModeLimit === null ? 10 : this.options.hubShortModeLimit;
            }
        } else {
            if (mode === "long") {
                return !this.options.hubSmallLongModeLimit || this.options.hubSmallLongModeLimit === null ? 9 : this.options.hubSmallLongModeLimit;
            } else {
                return !this.options.hubSmallShortModeLimit || this.options.hubSmallShortModeLimit === null ? 7 : this.options.hubSmallShortModeLimit;
            }
        }
    },
    _getHubShowMoreCount: function(screen) {
        var mode = this._getHubType();
        if (screen !== "small") {
            if (mode === "long") {
                return !this.options.hubLongModeShowMoreCount || this.options.hubLongModeShowMoreCount === null ? 20 : this.options.hubLongModeShowMoreCount;
            } else {
                return !this.options.hubShortModeShowMoreCount || this.options.hubShortModeShowMoreCount === null ? 8 : this.options.hubShortModeShowMoreCount;
            }
        } else {
            if (mode === "long") {
                return !this.options.hubSmallLongModeShowMoreCount || this.options.hubSmallLongModeShowMoreCount === null ? 8 : this.options.hubSmallLongModeShowMoreCount;
            } else {
                return !this.options.hubSmallShortModeShowMoreCount || this.options.hubSmallShortModeShowMoreCount === null ? 6 : this.options.hubSmallShortModeShowMoreCount;
            }
        }
    },
    _getLimit: function() {
        if (!this.options.hubMode) {
            return !this.options.limit || this.options.limit === null ? 5 : this.options.limit;
        } else {
            return this._getHubLimit(this._screenSize);
        }
    },
    _getShowMoreCount: function() {
        if (!this.options.hubMode) {
            return this._getLimit();
        } else {
            return this._getHubShowMoreCount(this._screenSize);
        }
    },
    _setupChannels: function() {
        var availableChannels = {};
        $.each(this.options.channels, this.proxy(function(key, item) {
            if (item) {
                availableChannels[key] = this.options.channelsLabels[key] || "";
            }
        }));
        this.context.attr("availableChannels", availableChannels);
        $.each(availableChannels, this.proxy(function(key, item) {
            this.channels[key] = new usga.Latest.Channel(this.options.channels[key], this.options.limit, false);
        }));
        if (this.options.editorialFeed) {
            this.editorialChannel = new usga.Latest.Channel(this.options.editorialFeed, -1, true);
        }
    },
    _setClassesToContainer: function() {
        if (this.options.hideFilters || this.options.hideCategoriesFilter && this.options.hideChannelsFilter) {
            this.$element.closest(".frame").addClass("frame_no-filter");
        }
    },
    _setEvents: function() {
        this.context.bind("change", this.proxy(function(ev, attr) {
            if (attr === "channel") {
                this._onChannelChangeContext();
            }
            if (attr === "category") {
                this._onCategoryChangeContext();
            }
        }));
    },
    _renderTemplate: function() {
        this.$element.append(can.view("#latestTemplate", this.context, {
            renderTweetButtons: this.proxy(usga.Latest.Helpers.renderTweetButtons),
            renderFacebookButtons: this.proxy(usga.Latest.Helpers.renderFacebookButtons)
        }));
        this.$category = this.$element.find(".latest-filter__categories__select").chosen({
            disable_search_threshold: 10,
            width: "100%"
        });
        this.$showMoreButton = this.$element.find(".show-more");
        this._setChannelSelection();
        if (!this.options.hideFilters && !this.options.hideChannelsFilter && this.options.hideCategoriesFilter) {
            this.$element.addClass(usga.Latest.CSS_ONLY_CHANNELS_CLASS);
        }
    },
    _getRequestParams: function() {
        var params = {}, tags = [];
        if (this.context.subCategory) {
            tags.push(this.context.subCategory);
        } else if (this.context.category && this.context.category !== "all") {
            tags.push(this.context.category);
        }
        if (tags.length) {
            params.tags = tags.join("+");
        }
        return params;
    },
    _getItemCategoryTitle: function(item) {
        var hasCategories = item.categories && item.categories.length, hasSubCategories = item.subCategories && item.subCategories.length, title = "";
        if (hasCategories || hasSubCategories) {
            if (this._renderSubCategory && hasSubCategories) {
                title = item.subCategories[0] || "";
            } else if (!this.options.subCategory && hasCategories) {
                title = item.categories[0] || "";
            }
            return title.toUpperCase();
        }
        return "";
    },
    _prepareSocialItemText: function(text, network) {
        if (!text || text === null) {
            return "";
        }
        text = usga.replaceURLWithHTMLLinks(text);
        if (network) {
            if (network === "twitter") {
                text = usga.replaceTwitterUsernameWithHTMLLinks(text);
            }
            if ([ "twitter", "facebook" ].indexOf(network) !== -1) {
                text = usga.replaceHashtagsWithHTMLLinks(text, false, network);
            }
        }
        return text;
    },
    _areAllInitialItemsSocial: function(itemsObj) {
        if (usga.isObject(itemsObj) && itemsObj.ref && $.isArray(itemsObj.ref)) {
            var len = this.options.limit;
            if (itemsObj.ref.length < this.options.limit) {
                len = itemsObj.ref.length;
            }
            for (var i = 0; i < len; i++) {
                if (itemsObj.ref[i].type !== "social") {
                    return false;
                }
            }
            return true;
        }
        return false;
    },
    _areAllInitialItemsWithoutImage: function(itemsObj) {
        if (usga.isObject(itemsObj) && itemsObj.ref && $.isArray(itemsObj.ref)) {
            var len = this.options.limit;
            if (itemsObj.ref.length < this.options.limit) {
                len = itemsObj.ref.length;
            }
            for (var i = 0; i < len; i++) {
                if (itemsObj.ref[i].image !== null) {
                    return false;
                }
            }
            return true;
        }
        return false;
    },
    _swapSocialCardWithOtherCard: function(itemsObj, isInitialFetchingNeeded, isInitialFetch) {
        var channel = this.channels[this.context.channel];
        if (isInitialFetchingNeeded && this._areAllInitialItemsSocial(itemsObj) && channel.data._notRenderedItems && channel.data._notRenderedItems.length > 0) {
            var foundIndex = usga.findWhere(channel.data._notRenderedItems, {
                "!type": "social",
                "!image": [ "", null ]
            });
            if (foundIndex !== false) {
                var item = channel.data._notRenderedItems[foundIndex], swapItem = channel.data._notRenderedItems.splice(foundIndex, 1)[0];
                itemsObj.ref.splice(0, 0, swapItem);
                if (itemsObj.ref.length > this._getFetchLimit(isInitialFetch)) {
                    for (var i = this._getFetchLimit(isInitialFetch), index = i, len = itemsObj.ref.length; i < len; i++) {
                        channel.data._notRenderedItems.push(itemsObj.ref.splice(index, 1)[0]);
                    }
                }
                channel.fetchedItems = itemsObj.ref;
            }
        }
    },
    _swapCardWoImageWithOtherCard: function(itemsObj, isInitialFetchingNeeded, isInitialFetch) {
        var channel = this.channels[this.context.channel];
        if (isInitialFetchingNeeded && this._areAllInitialItemsWithoutImage(itemsObj) && channel.data._notRenderedItems && channel.data._notRenderedItems.length > 0) {
            var foundIndex = usga.findWhere(channel.data._notRenderedItems, {
                "!type": "social",
                "!image": null
            });
            if (foundIndex !== false) {
                var item = channel.data._notRenderedItems[foundIndex], swapItem = channel.data._notRenderedItems.splice(foundIndex, 1)[0];
                itemsObj.ref.splice(0, 0, swapItem);
                if (itemsObj.ref.length > this._getFetchLimit(isInitialFetch)) {
                    for (var i = this._getFetchLimit(isInitialFetch), index = i, len = itemsObj.ref.length; i < len; i++) {
                        channel.data._notRenderedItems.push(itemsObj.ref.splice(index, 1)[0]);
                    }
                }
                channel.fetchedItems = itemsObj.ref;
            }
        }
    },
    _getFetchLimit: function(isInitialFetch) {
        if (isInitialFetch) {
            return this._getLimit();
        } else {
            return this._getShowMoreCount();
        }
    },
    _getNetworkPageUrl: function(network) {
        if (network && typeof network === "string") {
            var option = network.toLowerCase() + "PageUrl";
            if (this.options[option] && typeof this.options[option] === "string") {
                return this.options[option];
            }
        }
        return "";
    },
    _updateRenderableItems: function(items, limit, isInitialFetch, isInitialFetchingNeeded) {
        items = $.isArray(items) ? items : [];
        this._swapSocialCardWithOtherCard({
            ref: items
        }, isInitialFetchingNeeded, isInitialFetch);
        this._swapCardWoImageWithOtherCard({
            ref: items
        }, isInitialFetchingNeeded, isInitialFetch);
        can.batch.start();
        if (isInitialFetch) {
            this.context.items.splice(0, this.context.items.length);
        }
        for (var i = 0, len = items.length; i < len; i++) {
            var item = items[i], renderableItem = {
                id: item.id ? "" + item.id : "",
                title: item.title || "",
                contentUrl: item.link || "",
                media: item.image && item.image !== null ? item.image : "",
                follow: false,
                network: item.provider || "",
                networkPageUrl: ""
            }, socialSuggestion = renderableItem.id ? renderableItem.id.match(/^(facebook|instagram|twitter)/i) : false, renderImage = true;
            if (!item.type) {
                return true;
            }
            if (socialSuggestion && socialSuggestion[1]) {
                renderableItem.network = socialSuggestion[1].toLowerCase();
            }
            if (renderableItem.media) {
                renderableItem.media = usga.trimDamInUrl(renderableItem.media);
            }
            renderableItem["is_" + item.type] = true;
            if (renderableItem.network) {
                renderableItem.is_social = true;
                renderableItem["is_" + renderableItem.network] = true;
            }
            if (renderableItem.is_twitter || !renderableItem.media) {
                renderImage = false;
            }
            if (item.type === "social") {
                renderableItem.networkPageUrl = this._getNetworkPageUrl(renderableItem.network);
                renderableItem.title = this._prepareSocialItemText(item.description || "", renderableItem.network);
                renderableItem.above2 = renderableItem.network.toUpperCase();
                renderableItem.above_img = true;
                renderableItem.follow = true;
            } else {
                if (item.description) {
                    if (!item.title && item.description) {
                        renderableItem.title = usga.cutText(item.description, this.options.cutTitleLength, "");
                    }
                }
            }
            if (!renderImage && !renderableItem.is_twitter) {
                renderableItem.render_as_article = true;
                renderableItem.text = usga.cutText(item.description, this.options.cutBodyLength, " ...");
            }
            if (renderableItem.is_instagram) {
                if (renderImage) {
                    renderableItem.title = "";
                    renderableItem.description = "";
                }
            } else {
                renderableItem.above = this._getItemCategoryTitle(item);
            }
            this.context.items.push(renderableItem);
        }
        can.batch.stop();
        if (!this._adapting) {
            this._toggleShowMoreButton(items, limit);
        }
        this._toggleDoubleSizeMode(items, isInitialFetch);
        this._setDoubleSizedItem();
        this._onItemsRendered();
        this.applyCloudinary();
    },
    _toggleShowMoreButton: function(items, limit) {
        if (!this.options.hideShowMoreButton) {
            if (items.length && items.length >= limit) {
                this.$showMoreButton.toggle(true);
            } else {
                this.$showMoreButton.toggle(false);
            }
        }
    },
    _toggleDoubleSizeMode: function(items, isInitialFetch) {
        if (isInitialFetch) {
            var socialCardsCount = this.$element.find(".block__card__social:lt(" + this.options.limit + ")").length, cardsWoImageCount = this.$element.find(".block__card-no-img:lt(" + this.options.limit + ")").length;
            if (socialCardsCount && (socialCardsCount === this.options.limit || socialCardsCount < this.options.limit && socialCardsCount === items.length) || cardsWoImageCount && (cardsWoImageCount === this.options.limit || cardsWoImageCount < this.options.limit && cardsWoImageCount === items.length)) {
                this._isDoubleSizeDisabled = true;
            } else {
                this._isDoubleSizeDisabled = false;
            }
        }
    },
    _setDoubleSizedItem: function() {
        if (this._isDoubleSizeDisabled) {
            return;
        }
        var first = this.$element.find(".block__card:first"), second = first.next();
        if (first[0]) {
            var target = [];
            if (this.isInfinityScreen()) {
                target = second;
                if (second.is(".block__card__social, .block__card-no-img")) {
                    target = second.prev(":not(.block__card__social):not(.block__card-no-img)");
                    if (!target[0]) {
                        target = second.nextAll(":not(.block__card__social):not(.block__card-no-img):first");
                        if (target[0]) {
                            second.before(target);
                        }
                    } else {
                        target.before(second);
                    }
                }
            } else {
                target = first;
                if (first.is(".block__card__social, .block__card-no-img")) {
                    target = first.nextAll(":not(.block__card__social):not(.block__card-no-img):first");
                    if (target[0]) {
                        first.parent().prepend(target);
                    }
                }
            }
            $.each([ target, first, second ], this.proxy(function(i, item) {
                item.removeClass(usga.Latest.CSS_DOUBLE_SIZE_CLASS);
            }));
            if (target[0]) {
                target.addClass(usga.Latest.CSS_DOUBLE_SIZE_CLASS);
            }
        }
    },
    _setChannelSelection: function() {
        this.$element.find(".latest-filter__tags__item__link").removeClass("active");
        this.$element.find('.latest-filter__tags__item__link[data-channel="' + this.context.channel + '"]').addClass("active");
    },
    _onItemsRendered: function() {
        if (!this._adapting) {
            this._adaptItemsCount();
        }
        this.updateProtectedLinks();
    },
    _onChannelChangeContext: function() {
        this._fetch(true);
        this._setChannelSelection();
    },
    _onCategoryChangeContext: function() {
        this._fetch();
    },
    _fetch: function(newChannel) {
        var channel = this.channels[this.context.channel], params = this._getRequestParams(), isInitialFetchingNeeded = channel.isInitialFetchingNeeded(params), isInitialFetch = isInitialFetchingNeeded || newChannel, limit = isInitialFetchingNeeded ? this.options.limit : this.options.showMoreCount, additionalItems = this.isSmallScreen() || !this.options.adaptItems ? 0 : this._getLineFitItemsCount();
        this.context.attr("isLoading", isInitialFetch && isInitialFetchingNeeded && this.context.items.length === 0);
        if (isInitialFetch) {
            if (isInitialFetchingNeeded) {
                channel.data.skipItems = [];
                channel.data._notRenderedItems = [];
            }
            if (this.editorialChannel && isInitialFetchingNeeded && (!this.context.channel || this.context.channel === "everything")) {
                this.editorialChannel.fetchOffset = "";
                limit += additionalItems + 1;
                $.when(channel.fetch(this._getRequestParams(), true, limit), this.editorialChannel.fetch({}, true)).done(this.proxy(function(response, editorialResponse) {
                    this._processFetchResponce(response, editorialResponse, isInitialFetchingNeeded, isInitialFetch);
                }));
            } else {
                if (isInitialFetchingNeeded) {
                    limit += additionalItems + 1;
                } else {
                    limit += additionalItems;
                }
                this.channels[this.context.channel].fetch(this._getRequestParams(), true, limit).done(this.proxy(function(response) {
                    if (isInitialFetchingNeeded) {
                        this._processFetchResponce(response, null, isInitialFetchingNeeded, isInitialFetch);
                    } else {
                        this._processFetchResponce(response, null, false, isInitialFetch);
                    }
                }));
            }
        } else {
            limit = limit - channel.data._notRenderedItems.length + additionalItems;
            if (channel.data.skipItems && $.isArray(channel.data.skipItems)) {
                limit += channel.data.skipItems.length;
            }
            if (limit < 1) {
                limit = 0;
            }
            this.channels[this.context.channel].fetch(this._getRequestParams(), false, limit).done(this.proxy(function(response) {
                this._processFetchResponce(response);
            }));
        }
    },
    _processFetchResponce: function(response, editorialResponse, isInitialFetchingNeeded, isInitialFetch) {
        this.context.attr("isLoading", false);
        this._swapItemsWithEditorialItems(response, editorialResponse, isInitialFetchingNeeded);
        this._skipItems(response);
        this._addNotRenderedItemsToFetch(response, isInitialFetch);
        if (isInitialFetchingNeeded || !isInitialFetch) {
            this._storeExceedingLimitItems(response, isInitialFetch);
        }
        this._updateRenderableItems(response.items, !isInitialFetch ? this._getShowMoreCount() : this.options.limit, isInitialFetch, isInitialFetchingNeeded);
    },
    _swapItemsWithEditorialItems: function(response, editorialResponse, isInitialFetchingNeeded) {
        if (editorialResponse && isInitialFetchingNeeded) {
            var channel = this.channels[this.context.channel], items = $.merge([], response.items), skipItems = {};
            editorialResponse.items.sort(function(item1, item2) {
                if (usga.isObject(item1) && item1.id && item1.id.indexOf("-") !== -1 && usga.isObject(item2) && item2.id && item2.id.indexOf("-") !== -1) {
                    var pos1 = +item1.id.split("-").pop(), pos2 = +item2.id.split("-").pop();
                    if (pos1 > pos2) {
                        return 1;
                    }
                    if (pos1 < pos2) {
                        return -1;
                    }
                }
                return 0;
            });
            $.each(editorialResponse.items, function(i, item) {
                var idParts = item.id.split("-"), pos = idParts.pop();
                if (pos > items.length) {
                    pos = items.length + 1;
                }
                skipItems[idParts[0]] = true;
                items.splice(pos - 1, 0, item);
            });
            if (items.length > this.options.limit) {
                channel.data._notRenderedItems = items.splice(this.options.limit, items.length - this.options.limit);
            }
            response.items = items;
            channel.fetchedItems = items;
            channel.data.skipItems = skipItems;
        }
    },
    _skipItems: function(response) {
        var channel = this.channels[this.context.channel], skipped = 0;
        if (channel.data.skipItems) {
            response.items = $.map(response.items, function(item) {
                if (channel.data.skipItems[item.id]) {
                    skipped += 1;
                    return null;
                }
                return item;
            });
            if (skipped > 0 && channel.data._notRenderedItems && $.isArray(channel.data._notRenderedItems)) {
                var len = skipped;
                if (len > channel.data._notRenderedItems.length) {
                    len = channel.data._notRenderedItems.length;
                }
                for (var i = 0; i < len; i++) {
                    var item = channel.data._notRenderedItems.splice(0, 1)[0];
                    response.items.push(item);
                    channel.fetchedItems.push(item);
                }
            }
        }
    },
    _storeExceedingLimitItems: function(response, isInitialFetch) {
        if (response.items.length > this._getFetchLimit(isInitialFetch)) {
            var limitExceedingItems = response.items.length - this._getFetchLimit(isInitialFetch), channel = this.channels[this.context.channel], cacheOffset = -limitExceedingItems;
            if (!channel.data._notRenderedItems || !$.isArray(channel.data._notRenderedItems)) {
                channel.data._notRenderedItems = [];
            }
            channel.data._notRenderedItems = $.merge(channel.data._notRenderedItems, response.items.splice(-limitExceedingItems));
            channel.fetchedItems.splice(cacheOffset, limitExceedingItems);
        }
    },
    _appendNotRenderedItemsFromFetch: function(count) {
        if (count) {
            var channel = this.channels[this.context.channel];
            for (var i = 0; i < count; i++) {
                var item = channel.fetchedItems.splice(-1)[0];
                channel.data._notRenderedItems.splice(0, 0, item);
            }
        }
    },
    _addNotRenderedItemsToFetch: function(response, isInitialFetch) {
        var channel = this.channels[this.context.channel];
        if (!isInitialFetch && channel.data._notRenderedItems && channel.data._notRenderedItems.length > 0) {
            var cacheOffset = -response.items.length;
            for (var i = 0, len = channel.data._notRenderedItems.length; i < len; i++) {
                var item = channel.data._notRenderedItems.splice(0, 1)[0];
                response.items.splice(i, 0, item);
                channel.fetchedItems.splice(cacheOffset, 0, item);
            }
        }
    },
    _appendNotRenderedItemsToFetch: function(count) {
        var channel = this.channels[this.context.channel];
        if (channel.data._notRenderedItems && channel.data._notRenderedItems.length > 0) {
            for (var i = 0; i < count; i++) {
                var item = channel.data._notRenderedItems.splice(0, 1)[0];
                channel.fetchedItems.push(item);
            }
        }
    },
    _getLineFitItemsCount: function() {
        var itemsInLine;
        switch (this.getScreenSize()) {
          case "small":
            itemsInLine = 1;
            break;

          case "medium":
            itemsInLine = 2;
            break;

          case "big":
            itemsInLine = 3;
            break;

          default:
            itemsInLine = 4;
            if (this.$element.closest(".frame__left").next(".frame__right").length) {
                itemsInLine -= 1;
            }
            break;
        }
        return itemsInLine;
    },
    _getNeededAdaptItems: function() {
        var itemsInLine = this._getLineFitItemsCount(), visualItemsCount = this.context.items.length, hasDoubleItem = !!this.$element.find("." + usga.Latest.CSS_DOUBLE_SIZE_CLASS)[0];
        if (itemsInLine > 1) {
            if (hasDoubleItem) {
                visualItemsCount += 1;
            }
            if (visualItemsCount % itemsInLine === 0) {
                return 0;
            }
            return itemsInLine - visualItemsCount % itemsInLine;
        }
        return 0;
    },
    _getOddItemsCount: function() {
        var itemsInLine = this._getLineFitItemsCount(), visualItemsCount = this.context.items.length, hasDoubleItem = !!this.$element.find("." + usga.Latest.CSS_DOUBLE_SIZE_CLASS)[0];
        if (itemsInLine > 1) {
            if (hasDoubleItem) {
                visualItemsCount += 1;
            }
            if (visualItemsCount % itemsInLine === 0) {
                return 0;
            }
            return visualItemsCount % itemsInLine;
        }
    },
    _adaptItemsCount: function() {
        if (!this.options.adaptItems) {
            return false;
        }
        var channel = this.channels[this.context.channel], needFetch = this._getNeededAdaptItems(), linesAreFull = !needFetch || needFetch === 0 || needFetch === null, limit = this._getLimit();
        if (!linesAreFull && this.context.items.length < limit === false) {
            this._adapting = true;
            if (needFetch > channel.data._notRenderedItems.length) {
                var hideCount = this._getLineFitItemsCount() - needFetch;
                this._appendNotRenderedItemsFromFetch(hideCount);
                this.context.attr("items", this.context.items.splice(0, this.context.items.length - hideCount));
                this._setDoubleSizedItem();
            } else {
                this._appendNotRenderedItemsToFetch(needFetch);
                this._updateRenderableItems(channel.fetchedItems.slice(-needFetch));
            }
            this._adapting = false;
        }
    },
    onLayout: function() {
        if (this.context.items.length) {
            this._adaptItemsCount();
        }
        this._setDoubleSizedItem();
        this._super();
    },
    onDocumentReady: function() {
        this.$element.find(".latest-filter__categories__select").chosen({
            disable_search_threshold: 10,
            width: "100%"
        });
    },
    updateChosen: function() {
        this.$element.find(".latest-filter__categories__select").trigger("chosen:updated");
    },
    ".latest-filter__categories__select": function($select, event) {
        this.updateChosen();
    },
    ".latest-filter__tags__item__link click": function($tag, event) {
        event.preventDefault();
        var channelName = $tag.data("channel");
        if (channelName && this.channels && this.channels[channelName]) {
            this.context.attr("channel", channelName);
        }
    },
    ".show-more__button click": function($button, event) {
        event.preventDefault();
        this._fetch();
    }
});

usga.Latest.Helpers = can.Construct.extend({
    renderTweetButtons: function() {
        return function(el) {
            var twttr = window.twttr;
            if (twttr && twttr.widgets && twttr.widgets.load) {
                twttr.widgets.load(el.parentNode);
            }
        };
    },
    renderFacebookButtons: function() {
        return function(el) {
            var fb = window.FB;
            if (fb && fb.XFBML && fb.XFBML.parse) {
                fb.XFBML.parse(el.parentNode);
            }
        };
    }
}, {});

usga.Latest.Channel = can.Construct.extend({
    limit: 5,
    url: "",
    paramsPrefix: "",
    itemsProcessor: null,
    data: null,
    fetchedItems: null,
    itemsCacheKey: "",
    fetchOffset: "",
    _activeTransfer: null,
    init: function(url, limit) {
        if (!url) {
            throw new Error("LatestChannel: set url");
        }
        this.data = {};
        this.url = url;
        this.limit = limit === undefined || limit === null ? 5 : limit;
        this.itemsProcessor = new usga.Latest.Channel.ItemsProcessor();
    },
    _prepareJsonPath: function(urlParams) {
        var jsonPath = this.url, jsonParams = "";
        if (urlParams.limit && this.limit !== -1) {
            jsonParams += ".size_" + urlParams.limit;
        }
        if (urlParams.offset) {
            jsonParams += ".offset_" + urlParams.offset;
        }
        if (urlParams.tags) {
            jsonParams += ".tags_" + urlParams.tags.replace(/:/g, "_");
        }
        jsonPath = jsonPath.replace(/(\.json)$/i, jsonParams + "$1");
        return jsonPath;
    },
    fetch: function(params, fetchFromCache, newLimit) {
        var newItemsCacheKey = this.getCacheKeyFromParams(params), isUpdateNeeded = this.isInitialFetchingNeeded(params), offset = false, limit = newLimit || this.limit, process = $.Deferred();
        if (isUpdateNeeded || !fetchFromCache) {
            if (!fetchFromCache) {
                if (this.fetchOffset) {
                    params.offset = this.fetchOffset;
                }
            } else {
                this.fetchedItems = null;
                this.fetchOffset = "";
            }
            params.limit = limit;
            if (this._activeTransfer) {
                this._activeTransfer.abort();
                this._activeTransfer = null;
            }
            var items = [];
            this._activeTransfer = $.ajax({
                url: this._prepareJsonPath(params),
                type: "GET",
                dataType: "text",
                contentType: "application/json; charset=utf-8",
                data: {},
                success: this.proxy(function(data) {
                    if (!this.fetchedItems) {
                        this.fetchedItems = [];
                    }
                    try {
                        if (!usga.isObject(data)) {
                            data = JSON.parse(data);
                        }
                    } catch (e) {
                        data = {
                            items: []
                        };
                        usga.log("Latest: parsing error - " + e.message);
                    }
                    items = $.merge(items, data && data.items ? data.items : []);
                    items = this.itemsProcessor.process(items, limit, this.fetchOffset, params);
                    this.fetchedItems = $.merge(this.fetchedItems, items || []);
                    this.itemsCacheKey = newItemsCacheKey;
                    this.fetchOffset = items.length ? items[items.length - 1].id : this.fetchOffset;
                    process.resolve(new usga.Latest.Channel.FetchResponse(items, limit, isUpdateNeeded));
                }),
                error: this.proxy(function(xhr) {
                    usga.log("Latest: fetching error - " + (xhr.statusText || "") + " - " + (xhr.responseText || ""));
                    process.resolve(new usga.Latest.Channel.FetchResponse([], limit, isUpdateNeeded));
                })
            });
            return process.promise();
        } else if (fetchFromCache) {
            return $.when(new usga.Latest.Channel.FetchResponse(this.fetchedItems, limit, true));
        }
    },
    getCacheKeyFromParams: function(params) {
        return JSON.stringify(params || {});
    },
    isInitialFetchingNeeded: function(params) {
        var cacheKey = this.getCacheKeyFromParams(params);
        return !this.itemsCacheKey || !this.fetchedItems || cacheKey !== this.itemsCacheKey;
    }
});

usga.Latest.Channel.FetchResponse = can.Construct.extend({
    items: [],
    limit: 0,
    isInitialFetch: false,
    init: function(items, limit, isInitialFetch) {
        this.items = items;
        this.limit = limit;
        this.isInitialFetch = isInitialFetch;
    }
});

usga.Latest.Channel.ItemsProcessor = can.Construct.extend({
    process: function(items, limit, offset, params) {
        return items;
    }
});

usga.LeaderBoardBaseMap = usga.BaseMap.extend({
    define: {
        lbType: {
            type: "string",
            value: ""
        },
        screenSize: {
            type: "string",
            value: "infinity"
        }
    },
    isTeamStrokeLb: can.compute(function() {
        return this.attr("lbType") == "teamStroke";
    }),
    isIndStateStrokeLb: can.compute(function() {
        return this.attr("lbType") == "individualStateStroke";
    }),
    isIndIntlStrokeLb: can.compute(function() {
        return this.attr("lbType") == "individualIntlStroke";
    }),
    isIndMatchPlayLb: can.compute(function() {
        return this.attr("lbType") == "individualMatchPlay";
    }),
    isFourBallMatchPlayLb: can.compute(function() {
        return this.attr("lbType") == "fourballMatchPlay";
    }),
    isFourBallIntlStrokeLb: can.compute(function() {
        return this.attr("lbType") == "fourballIntlStroke";
    }),
    isTeamMatchPlayLb: can.compute(function() {
        return this.attr("lbType") == "teamMatchPlay";
    }),
    isFourballChampionship: can.compute(function() {
        return this.attr("lbType") == "fourballMatchPlay" || this.attr("lbType") == "fourballIntlStroke" || this.attr("lbType") == "fourball";
    }),
    hasMatchStatusBar: can.compute(function() {
        return false;
    }),
    isMobileScreen: can.compute(function() {
        return this.attr("screenSize") == "small";
    })
});

usga.LeaderBoardBaseModel = usga.LeaderBoardBaseMap.extend({
    define: {
        tableLegend: {
            type: "*",
            value: null
        },
        teamsData: {
            Type: usga.BaseMap,
            Value: usga.BaseMap
        },
        playersData: {
            Type: usga.BaseMap,
            Value: usga.BaseMap
        },
        courseData: {
            Type: usga.BaseMap.List,
            Value: usga.BaseMap.List
        },
        currentRound: {
            type: "*",
            value: null
        },
        roundData: {
            Type: usga.BaseMap.List,
            Value: usga.BaseMap.List
        },
        cutData: {
            Type: usga.BaseMap,
            Value: usga.BaseMap
        },
        matchesData: {
            Type: usga.BaseMap,
            Value: usga.BaseMap
        },
        matchPlayRounds: {
            Type: usga.BaseMap.List,
            Value: usga.BaseMap.List
        },
        matchPlayTeamsData: {
            Type: usga.BaseMap,
            Value: usga.BaseMap
        }
    },
    rounds: can.compute(function() {
        return this.attr("courseData.yardlist.roundlist");
    })
});

usga.LeaderBoardBaseControl = usga.BaseModule.extend({
    initialized: false,
    defaultSortDirection: "asc",
    defaultSortType: "number-t",
    currentSortDirection: "asc",
    currentSortType: "number-t",
    updateInterval: null,
    updateIntervalDuration: 3e4,
    partialsUpdateTimeout: 100,
    changedData: [],
    dataUrl: null,
    init: function() {
        this._super();
    },
    destroy: function() {
        if (this.updateInterval) {
            window.clearInterval(this.updateInterval);
        }
        can.Control.prototype.destroy.call(this);
    },
    getData: function() {
        can.ajax({
            type: "GET",
            url: this.dataUrl,
            headers: {
                "Content-Type": "application/json"
            },
            success: this.proxy(function(data) {
                if (!this.initialized) {
                    this.initialized = true;
                    this.applyInitialContextData(data);
                } else {
                    this.applyDataChanges(data);
                }
            }),
            error: this.proxy(function(xhr) {
                this.handleError(xhr);
            })
        });
    },
    handleError: function(xhr) {
        console.log(xhr);
    },
    initCustomSelect: function() {
        this.$element.find(".header-box__list-dropdown .dropdown").chosen({
            disable_search_threshold: 10,
            width: "100%"
        });
    },
    getHelpers: function() {
        var context = this.context;
        return {
            isCurrentRound: function(roundNumber, options) {
                roundNumber = can.isFunction(roundNumber) ? roundNumber() : roundNumber;
                return roundNumber == context.attr("currentRound") ? options.fn() : options.inverse();
            },
            isTwoRoundsEvent: function(roundData, options) {
                roundData = can.isFunction(roundData) ? roundData() : roundData;
                if (roundData.attr("length") == 2) {
                    return options.fn(this);
                }
                return options.inverse(this);
            },
            isEqual: function(value1, value2, options) {
                value1 = can.isFunction(value1) ? value1() : value1();
                if (value1 == value2) {
                    return options.fn(this);
                }
                return options.inverse(this);
            }
        };
    },
    getLegends: function(data) {
        if (data) {
            var legendsData = data.legend;
            var legends = [];
            if (can.isArray(legendsData)) {
                for (var i = 0, ii = legendsData.length; i < ii; i++) {
                    legends.push(legendsData[i].text);
                }
            } else {
                legends.push(legendsData.text);
            }
            return legends;
        } else {
            return null;
        }
    },
    initDataUpdating: function() {
        if (this.updateInterval) {
            window.clearInterval(this.updateInterval);
            this.updateInterval = null;
        }
        this.updateInterval = window.setInterval(this.proxy(function() {
            this.getData();
        }), this.updateIntervalDuration);
    },
    applyPartialData: function(list, start, chunk, callback) {
        var self = this;
        var part;
        if (can.isArray(list)) {
            part = list.slice(start, start + chunk);
        } else {
            part = [];
            part.push(list);
        }
        can.batch.start(function() {
            window.setTimeout(function() {
                var nextStart = start + chunk;
                if (nextStart < list.length) {
                    self.applyPartialData(list, nextStart, chunk, callback);
                } else {
                    self.initDataUpdating();
                }
            }, this.partialsUpdateTimeout);
        });
        if (callback) {
            callback(part);
        }
        can.batch.stop();
    },
    compareAndSetAttr: function(changedValue, modelValue, model, attr) {
        if (typeof changedValue !== "object") {
            if (changedValue != modelValue && model && attr) {
                model.attr(attr, changedValue);
                this.hasChanges = true;
            }
        } else if (can.isArray(changedValue)) {
            if (modelValue instanceof can.List) {
                for (var i = 0, ii = changedValue.length; i < ii; i++) {
                    if (modelValue.attr(i)) {
                        this.compareAndSetAttr(changedValue[i], modelValue.attr(i), modelValue, i);
                    } else {
                        modelValue.push(changedValue[i]);
                    }
                }
            } else {
                model.attr(attr, changedValue);
            }
        } else {
            if (modelValue !== "") {
                for (var a in changedValue) {
                    if (changedValue.hasOwnProperty(a)) {
                        this.compareAndSetAttr(changedValue[a], modelValue.attr(a), modelValue, a);
                    }
                }
            } else {
                model.attr(attr, changedValue);
            }
        }
        return this.hasChanges;
    },
    sortDomElements: function(attr, direction, type, elementClass, appendClass) {
        var domElements = this.$element.find("." + elementClass);
        domElements.sort(this.setSortingArgument(attr, direction, type, true));
        domElements.each(function() {
            can.$(this).detach().insertAfter(can.$("." + appendClass).last());
        });
    },
    sortList: function(list, attr, direction, type) {
        this.currentSortAttr = attr;
        this.currentSortDirection = direction;
        this.currentSortType = type;
        list.sort(this.setSortingArgument(attr, direction, type));
    },
    setSortingArgument: function(attr, direction, type, isDomElement) {
        var self = this;
        return function(a, b) {
            if (isDomElement) {
                a = can.$(a).data(attr);
                b = can.$(b).data(attr);
            } else {
                a = typeof a[attr] === "function" ? a[attr]() : a[attr];
                b = typeof b[attr] === "function" ? b[attr]() : b[attr];
            }
            a = self.parseSortingData(a, direction, type);
            b = self.parseSortingData(b, direction, type);
            if (direction == "asc") {
                return a === b ? 0 : a < b ? -1 : 1;
            } else {
                return a === b ? 0 : a > b ? -1 : 1;
            }
        };
    },
    parseSortingData: function(val, direction, type) {
        var sortingMax = 1e5;
        var dqValue = sortingMax + 1;
        var mcValue = sortingMax + 2;
        var wdValue = sortingMax + 3;
        var spaceValue = sortingMax;
        var dashValue = sortingMax + 5;
        var timeIncrement = 1200;
        if (type == "number" || type == "number-nan" || type == "number-t") {
            if (typeof val == "string") {
                val = val.replace(/t/i, "").replace(/mc/i, mcValue).replace(/wd/i, wdValue).replace(/dq/i, dqValue);
            }
            if (val === "" || /^\s*$/.test(val) || val === undefined) {
                val = spaceValue;
            } else if (val == "-") {
                val = direction == "asc" ? dashValue : -dashValue;
            } else if (val == "e" || val == "E") {
                val = 0;
            } else {
                val = typeof val == "number" ? val : parseInt(val);
            }
        } else if (type == "float") {
            val = typeof val == "number" ? val : parseFloat(val);
        } else if (type == "time") {
            val = val.replace(/^12:/i, "0:");
            if (/pm$/i.test(val)) {
                val = val.replace(/([0-9]{1,2})\:([0-9]{1,2})\s*p?a?m/i, "$1$2");
                val = parseInt(val) + timeIncrement;
            } else {
                val = val.replace(/([0-9]{1,2})\:([0-9]{1,2})\s*p?a?m/i, "$1$2");
                val = parseInt(val);
            }
        }
        return val;
    },
    setSortType: function(element, attr, type, data, headers) {
        if (data === null) {
            data = [];
        }
        if (element.hasClass("sort-asc")) {
            element.removeClass("sort-asc");
            element.addClass("sort-desc");
            this.sortList(data, attr, "desc", type);
            this.sortTables(attr, "desc", type);
        } else if (element.hasClass("sort-desc")) {
            element.removeClass("sort-desc");
            element.addClass("sort-asc");
            this.sortList(data, attr, "asc", type);
            this.sortTables(attr, "asc", type);
        } else {
            headers.removeClass("sort-asc").removeClass("sort-desc");
            element.addClass("sort-asc");
            this.sortList(data, attr, "asc", type);
            this.sortTables(attr, "asc", type);
        }
    },
    createScorecardDrawer: function(element, model) {
        var playerDrawer;
        var drawerWrap = can.$('<tr class="attached-drawer"><td colspan="12" id="drawer' + model.attr("idField") + '"></td></tr>');
        element.after(drawerWrap);
        if (model.attr("isFourBallIntlStrokeLb")) {
            playerDrawer = new usga.LeaderboardDrawerScorecardFourball("#drawer" + model.attr("idField"), model);
        } else {
            playerDrawer = new usga.LeaderboardDrawerScorecard("#drawer" + model.attr("idField"), model);
        }
    },
    createMatchPlayDrawer: function(element, model) {
        var drawerWrap = can.$('<div id="drawer' + model.attr("idField") + '" class="lb-match__container__item__drawer attached-drawer"></div>');
        element.after(drawerWrap);
        var matchDrawer = new usga.LeaderboardDrawerMatchPlay("#drawer" + model.attr("idField"), model);
    },
    findTableElement: function(value, elements) {
        value = value.replace(/\s/, "\\s*");
        var searchRegExp = new RegExp(value, "ig");
        if (value === "" || !value) {
            elements.show();
        } else {
            elements.each(function() {
                var $element = can.$(this);
                var searchText = $element.data("search") || $element.text();
                if (searchRegExp.test(searchText)) {
                    $element.show();
                } else {
                    $element.hide();
                }
            });
        }
    },
    applyCourseData: function(list, courseData) {
        if (can.isArray(courseData)) {
            for (var i = 0, ii = courseData.length; i < ii; i++) {
                list.push(courseData[i]);
            }
        } else {
            list.push(courseData);
        }
    },
    getObjByKeyName: function(list, key, value) {
        for (var i = 0, ii = list.length; i < ii; i++) {
            var item = list[i];
            if (item[key] && item[key] == value) {
                return item;
            }
        }
        return null;
    },
    dataToArray: function(data) {
        var outputData = [];
        if (can.isArray(data)) {
            return data;
        } else {
            outputData.push(data);
            return outputData;
        }
    },
    getPlaySuspended: function(data) {
        if (data && data.suspended) {
            if (data.suspended != "false" && data.suspended != "0") {
                return data.message;
            }
        }
        return null;
    },
    renderSuspended: function(data) {
        var suspended = this.getPlaySuspended(data.event.tournament.playsuspended);
        var template = $('<div class="alert alert_warning"><span class="alert__title">COURSE ALERT:</span>&nbsp;' + '<span class="s-text"></span></div>');
        var suspendedElement = this.$element.find(".alert_warning");
        if (suspended) {
            if (!suspendedElement.length) {
                template.find(".s-text").text(suspended);
                this.$element.prepend(template);
            } else {
                suspendedElement.find(".s-text").text(suspended);
                suspendedElement.show();
            }
        } else {
            suspendedElement.hide();
        }
    },
    renderHeader: function() {
        var header = $('<div class="lb-match__cut-line">Match Status</div>');
        this.$element.append(header);
    },
    getItemsByKeyValue: function(data, key, value) {
        var output = [];
        for (var i = 0, ii = data.length; i < ii; i++) {
            var obj = data[i];
            if (obj[key] == value) {
                output.push(obj);
            }
        }
        return output;
    },
    saveToStorage: function(key, value) {
        window.localStorage.setItem(key, value);
    },
    getFromStorage: function(key) {
        return window.localStorage.getItem(key);
    },
    removeFromStorage: function(key) {
        window.localStorage.removeItem(key);
    }
});

usga.LeaderBoardPlayerControl = usga.BaseModule.extend({
    init: function() {
        this._super();
        this.context = this.options.context;
        this.render();
    },
    render: function() {
        this.context.attr("screenSize", this.getScreenSize());
        var renderer = can.view("#leaderBoardPlayer", this.context, this.getHelpers());
        this.element.append(renderer);
        this.addToFavorite();
    },
    addToFavorite: function() {
        var lbType = this.context.attr("lbType");
        var id = this.context.attr("idField");
        if (window.localStorage.getItem(lbType + "." + id) && !this.element.hasClass("my-player-row")) {
            this.element.find(".favorite").trigger("click");
        }
    },
    getHelpers: function() {
        var context = this.context;
        return {
            isCurrentRound: function(roundNumber, options) {
                roundNumber = can.isFunction(roundNumber) ? roundNumber() : roundNumber;
                return roundNumber == context.attr("currentRound") ? options.fn() : options.inverse();
            },
            getRoundAttr: function(roundName) {
                roundName = can.isFunction(roundName) ? roundName() : roundName;
                if (context.attr("r" + roundName) !== null && context.attr("r" + roundName) !== undefined) {
                    return context.attr("r" + roundName);
                } else {
                    return context.attr("R" + roundName);
                }
            },
            getFlag: function(player) {
                player = can.isFunction(player) ? player() : player;
                var flag = null;
                if (player.attr("ctyCode")) {
                    flag = player.attr("ctyCode").toUpperCase();
                    if (player.attr("lbType") == "individualStateStroke") {
                        flag = "state " + flag.replace(/([A-z]*)\s([A-z]*)/, "$1-$2");
                    }
                } else {
                    flag = player.attr("country").toUpperCase();
                }
                return flag;
            },
            isTwoRoundsEvent: function(roundData, options) {
                roundData = can.isFunction(roundData) ? roundData() : roundData;
                if (roundData.attr("length") == 2) {
                    return options.fn(this);
                }
                return options.inverse(this);
            },
            parColor: function(attr) {
                attr = can.isFunction(attr) ? attr() : attr;
                if (attr && parseInt(attr) < 0) {
                    return "red";
                }
                return null;
            },
            roundParColor: function(roundName) {
                roundName = can.isFunction(roundName) ? roundName() : roundName;
                var roundValue = context.attr("R" + roundName) || context.attr("r" + roundName);
                var round, course, coursePar;
                if (roundValue && roundValue !== "" && roundValue !== " " && roundValue != "-") {
                    round = context.attr("round").attr("length") > 0 ? context.attr("round") : context.attr("roundData");
                    course = context.attr("course.0");
                    coursePar = course.par;
                    if (coursePar) {
                        if (roundValue < coursePar) {
                            return "red";
                        }
                    }
                }
                return null;
            }
        };
    },
    onLayout: function() {
        this.context.attr("screenSize", this.getScreenSize());
    },
    "{context} change": function(map, evt, attr, how, newValue) {
        this.element.data(attr, newValue);
    }
});

usga.LeaderBoardPlayersRounds = usga.LeaderBoardBaseMap.extend({
    define: {
        round: {
            Type: usga.BaseMap.List,
            Value: usga.BaseMap.List
        }
    }
});

usga.LeaderBoardPlayer = usga.LeaderBoardBaseMap.extend({
    define: {
        name: {
            type: "string",
            value: ""
        },
        firstname: {
            type: "string",
            value: ""
        },
        lastname: {
            type: "string",
            value: ""
        },
        rounds: {
            Type: usga.LeaderBoardPlayersRounds,
            Value: usga.LeaderBoardPlayersRounds
        },
        round: {
            Type: usga.BaseMap.List,
            Value: usga.BaseMap.List
        },
        roundData: {
            type: "*",
            value: null
        }
    },
    isAmateur: can.compute(function() {
        var name = this.attr("name");
        var amateurRegExp = /\(a\)$/gi;
        return amateurRegExp.test(name);
    }),
    displayName: can.compute(function() {
        var name = this.attr("name");
        var amateurRegExp = /\(a\)$/gi;
        if (name !== "") {
            name = name.split(",");
            var firstName = name[1] ? name[1].replace(/^\s/, "") : "";
            var lastName = name[0] ? name[0].replace(/^\s/, "") : "";
            if (amateurRegExp.test(name)) {
                firstName = firstName.replace(amateurRegExp, "");
                lastName = lastName.replace(amateurRegExp, "");
                return firstName + " " + can.capitalize(lastName.toLowerCase()) + " (a)";
            } else {
                return firstName + " " + can.capitalize(lastName.toLowerCase());
            }
        }
        return null;
    }),
    shortName: can.compute(function() {
        var name = this.attr("name");
        var displayName = this.attr("displayName");
        var firtsName = this.attr("firstname");
        var lastName = this.attr("lastname");
        var shortName;
        if (/[A-z-\.\s]*\/[A-z-\.\s]*/.test(name)) {
            shortName = name.replace(/([A-Z]{1})[a-z]*(\s[A-z\.]*)(\s?\/\s?)([A-Z]{1})[a-z]*(\s[A-z\.]*)/, "$1.$2$3<br>$4.$5");
        } else {
            if (firtsName !== "" && lastName !== "") {
                shortName = firtsName.charAt(0) + ". " + lastName;
            } else {
                shortName = displayName.replace(/([A-Z]{1})[a-z]*(\s[A-z\.]*)/, "$1.$2");
            }
        }
        return shortName;
    }),
    splitTeamNames: can.compute(function() {
        var name = this.attr("name");
        var country = this.attr("countryname") ? this.attr("countryname") : this.attr("country");
        var firstPlayer, secondPlayer;
        if (name !== "") {
            name = name.split("/");
            firstPlayer = name[0];
            secondPlayer = name[1];
            return [ {
                name: firstPlayer,
                country: country
            }, {
                name: secondPlayer,
                country: country
            } ];
        }
        return null;
    }),
    getCountry: can.compute(function() {
        var state = this.attr("state");
        var country = this.attr("country");
        var countryName = this.attr("countryname");
        if (state) {
            return state;
        } else if (countryName) {
            return countryName;
        } else {
            return country;
        }
    }),
    idField: can.compute(function() {
        if (this.attr("idint")) {
            return "player" + this.attr("idint");
        } else {
            return this.attr("name").replace(/\s/gi, "").replace(/\./gi, "").replace(/,/, "");
        }
    }),
    getRounds: can.compute(function() {
        var rounds;
        if (this.rounds.round.attr("length")) {
            rounds = this.rounds.attr("round");
        } else {
            rounds = this.attr("round");
        }
        return rounds;
    }),
    getHomeTown: can.compute(function() {
        if (this.attr("hometown")) {
            return this.attr("hometown");
        }
        return null;
    }),
    fullName: can.compute(function() {
        return this.attr("firstname") + " " + this.attr("lastname");
    }),
    residence: can.compute(function() {
        var homeTown = this.attr("hometown") || "";
        var country = this.attr("country") || "";
        return homeTown + ", " + country;
    }),
    teamName: can.compute(function() {
        var name = this.attr("name");
        name = name.replace(/([A-z\.-]*),\s*([A-z\.-]*)\s*(\/)\s*([A-z\.-]*),\s*([A-z\.-]*)/, "$2 $1 $3 $5 $4");
        return name;
    }),
    shortTeamName: can.compute(function() {
        var name = this.attr("name");
        name = name.replace(/([A-z\.-]*),\s*([A-Z]{1})[A-z\.-]*\s*(\/)\s*([A-z\.-]*),\s*([A-Z]{1})[A-z\.-]*/, "$2. $1 $3<br/>$5. $4");
        return name;
    }),
    photoUrl: can.compute(function() {
        return "/pic/photo_1.png";
    })
});

usga.LeaderBoardPlayers = usga.LeaderBoardBaseMap.extend({
    define: {
        player: {
            Type: usga.LeaderBoardPlayer.List,
            Value: usga.LeaderBoardPlayer.List
        }
    }
});

usga.LeaderBoardTeam = usga.LeaderBoardBaseMap.extend({
    define: {
        state: {
            type: "string",
            value: ""
        },
        players: {
            Type: usga.LeaderBoardPlayers,
            Value: usga.LeaderBoardPlayers
        },
        player: {
            Type: usga.LeaderBoardPlayer,
            Value: usga.LeaderBoardPlayer
        },
        roundData: {
            type: "*",
            value: null
        }
    },
    idField: can.compute(function() {
        if (this.attr("idint")) {
            return "team" + this.attr("idint");
        } else {
            return this.attr("state").replace(/\s/gi, "");
        }
    })
});

usga.CourseStatisticsControl = usga.LeaderBoardBaseControl.extend({
    init: function() {
        this._super();
        this.context = new usga.CourseStatisticsModel();
        this.dataUrl = this.options.dataUrl;
        this.render();
        this.getData();
    },
    render: function() {
        var renderer = can.view("#courseStatisticsTable", this.context, this.getHelpers());
        this.element.append(renderer);
    },
    applyInitialContextData: function(data) {
        var tournament = data.event.tournament;
        var courseData;
        if (tournament) {
            courseData = this.getCourseStatsData(tournament.courses.course, tournament.coursestats.coursestat);
            can.batch.start();
            for (var i = 0, ii = courseData.length; i < ii; i++) {
                this.context.courses.push(courseData[i]);
            }
            can.batch.stop();
        }
        this.initDataUpdating();
    },
    getCourseStatsData: function(coursesData, statsData) {
        var courses = this.dataToArray(coursesData);
        var stats = this.dataToArray(statsData);
        var output = [];
        for (var i = 0, ii = courses.length; i < ii; i++) {
            var course = courses[i];
            var stat = stats[i];
            var statData = {
                name: course.name,
                holes: []
            };
            var holesLength = course.hole.length;
            for (var h = 0; h < holesLength; h++) {
                var hole = course.hole[h];
                hole.stats = this.getObjByKeyName(stat.roundstats.holestats, "hole", hole.no);
                statData.holes.push(hole);
                if (h == holesLength / 2 - 1) {
                    hole = {
                        no: "Out",
                        par: course.frontpar,
                        yards: course.frontyards,
                        stats: this.getObjByKeyName(stat.roundstats.sidestats, "side", "front9")
                    };
                    statData.holes.push(hole);
                } else if (h == holesLength - 1) {
                    hole = {
                        no: "In",
                        par: course.backpar,
                        yards: course.backyards,
                        stats: this.getObjByKeyName(stat.roundstats.sidestats, "side", "back9")
                    };
                    statData.holes.push(hole);
                    hole = {
                        no: "Total",
                        par: course.par,
                        yards: course.totalyards,
                        stats: this.getObjByKeyName(stat.roundstats.sidestats, "side", "total")
                    };
                    statData.holes.push(hole);
                }
            }
            output.push(statData);
        }
        return output;
    },
    applyDataChanges: function(data) {
        var tournament = data.event.tournament;
        var courseData;
        if (tournament) {
            courseData = this.getCourseStatsData(tournament.courses.course, tournament.coursestats.coursestat);
            this.compareAndSetAttr(courseData, this.context.attr("courses"), this.context.attr("courses"));
        }
    }
});

usga.CourseStatisticsModel = usga.BaseMap.extend({
    define: {
        tabControl: {
            Type: usga.BaseMap.List,
            Value: usga.BaseMap.List
        },
        courses: {
            Type: usga.BaseMap.List,
            Value: usga.BaseMap.List
        }
    }
});

usga.CourseStatisticsTabControl = usga.LeaderBoardBaseControl.extend({
    currentRoundIndex: null,
    currentControl: null,
    init: function() {
        this._super();
        this.context = new usga.CourseStatisticsModel();
        this.dataUrl = this.options.tabControlUrl;
        this.courseStatsUrls = this.options.courseStatsUrls;
        this.render();
        this.getData();
    },
    render: function() {
        var renderer = can.view("#courseStatisticsTabs", this.context, this.getHelpers());
        this.element.append(renderer);
    },
    applyInitialContextData: function(data) {
        var rounds = data.coursestatsControl.coursestatItem;
        this.createTabsData(rounds);
    },
    createTabsData: function(rounds) {
        var strokePlayRegexp = /stroke\s*play\s*-\s*/i;
        var defaultTab;
        for (var i = 0, ii = rounds.length; i < ii; i++) {
            var round = rounds[i];
            var isDefault = false;
            if (round.default.toLowerCase() == "true") {
                defaultTab = i;
                isDefault = true;
                this.currentRoundIndex = i;
            }
            this.context.tabControl.push({
                name: round.type.replace(strokePlayRegexp, ""),
                "default": isDefault,
                dataUrl: this.courseStatsUrls[i]
            });
        }
        this.setCurrentLink();
        this.showCurrentLeaderBoard();
        this.initCustomSelect();
    },
    setCurrentLink: function() {
        if (this.currentRoundIndex === null) {
            this.currentRoundIndex = this.courseStatsUrls.length - 1;
        }
        var tabLinks = this.element.find(".lb-tab-link");
        tabLinks.removeClass("active");
        this.element.find(".lb-tab-link-" + this.currentRoundIndex).addClass("active");
        this.element.find(".link-select").find(".tab-option-" + this.currentRoundIndex).prop("selected", true);
    },
    showCurrentLeaderBoard: function() {
        if (this.currentControl) {
            this.element.find("#courseStatisticsContainer").empty();
            this.currentControl.destroy();
            this.currentControl = null;
        }
        this.currentControl = new usga.CourseStatisticsControl("#courseStatisticsContainer", {
            dataUrl: this.courseStatsUrls[this.currentRoundIndex]
        });
    },
    ".lb-tab-link click": function(element, event) {
        event.preventDefault();
        if (!element.hasClass("active")) {
            this.currentRoundIndex = element.data("index");
            this.setCurrentLink();
            this.showCurrentLeaderBoard();
        }
    },
    ".link-select change": function(element) {
        this.currentRoundIndex = element.val();
        this.setCurrentLink();
        this.showCurrentLeaderBoard();
    }
});

usga.LeaderboardDrawerMatchPlay = usga.BaseModule.extend({
    slideTdLength: 6,
    minRoundsLength: 18,
    currentOptions: {
        controls: false,
        infiniteLoop: false,
        minSlides: 1,
        maxSlides: 1,
        slideMargin: 0,
        adaptiveHeight: true,
        touchEnabled: usga.supports.touch
    },
    init: function() {
        this._super();
        this.context = this.options;
        this.context.attr("results", this.splitDrawerData());
        this.render();
    },
    render: function() {
        var renderer = can.view("#leaderBoardDrawerMatchPlay", this.context, this.getHelpers());
        this.element.html(renderer);
        window.setTimeout(this.proxy(function() {
            this.updateSlider();
        }), 50);
    },
    getHelpers: function() {
        return {
            renderStanding: function(standing, offset) {
                standing = can.isFunction(standing) ? standing().toLowerCase() : standing.toLowerCase();
                offset = can.isFunction(offset) ? offset() : offset;
                if (standing == "a/s" || standing == "as") {
                    return "AS";
                } else if (standing == "up") {
                    return offset + " up";
                } else {
                    return "";
                }
            },
            renderWinner: function(won) {
                won = can.isFunction(won) ? won() : won;
                if (won == 1) {
                    return "won";
                }
                return "";
            }
        };
    },
    splitDrawerData: function() {
        var playerOneScore, playerTwoScore;
        if (this.context.team.attr("length") > 0) {
            playerOneScore = this.context.team[0].player.attr("scores.score");
            playerTwoScore = this.context.team[1].player.attr("scores.score");
        } else {
            playerOneScore = this.context.players.player[0].attr("scores.score");
            playerTwoScore = this.context.players.player[1].attr("scores.score");
        }
        if (!playerOneScore.attr("length")) {
            playerOneScore = [ playerOneScore ];
        }
        if (!playerTwoScore.attr("length")) {
            playerTwoScore = [ playerTwoScore ];
        }
        var roundsLength = playerOneScore.length < this.minRoundsLength ? this.minRoundsLength : playerOneScore.length;
        var result = [];
        var defaultHoleNum = 1;
        for (var i = 0, ii = roundsLength; i < ii; i += this.slideTdLength) {
            var playerOneDataChunk = playerOneScore.slice(i, i + this.slideTdLength);
            var playerTwoDataChunk = playerTwoScore.slice(i, i + this.slideTdLength);
            var holesChunk = [];
            var holeNumbersChunk = [];
            for (var j = 0, jj = this.slideTdLength; j < jj; j++) {
                var playerOneRoundData, holeNumber, holePlayNumber, hole;
                if (playerOneDataChunk[j]) {
                    playerOneRoundData = playerOneDataChunk[j];
                    holeNumber = playerOneRoundData.attr("coursehole");
                    holePlayNumber = playerOneRoundData.attr("hole");
                    hole = this.getHoleByNumber(holeNumber);
                    holesChunk.push(hole);
                    holeNumbersChunk.push(holePlayNumber);
                } else {
                    playerOneDataChunk.push(null);
                    playerTwoDataChunk.push(null);
                    hole = this.getHoleByNumber(defaultHoleNum);
                    if (hole) {
                        holeNumbersChunk.push(defaultHoleNum);
                        holesChunk.push(hole);
                    } else {
                        holesChunk.push(null);
                    }
                }
                defaultHoleNum++;
            }
            result.push({
                holes: holesChunk,
                holeNumbers: holeNumbersChunk,
                playerOne: playerOneDataChunk,
                playerTwo: playerTwoDataChunk
            });
        }
        return result;
    },
    getHoleByNumber: function(holeNumber) {
        var holes = this.getCurrentCourseByNo(this.context.courseData, this.context.course).attr("hole");
        for (var i = 0, ii = holes.length; i < ii; i++) {
            if (holes[i].attr("no") == holeNumber) {
                return holes[i];
            }
        }
        return null;
    },
    getCurrentCourseByNo: function(courses, no) {
        for (var i = 0, ii = courses.attr("length"); i < ii; i++) {
            if (courses[i].no == no) {
                return courses[i];
            }
        }
        return null;
    },
    initSlider: function(options) {
        var sliderElement = this.$element.find(".drawer__content__slider");
        if (sliderElement.length) {
            this.slider = sliderElement.bxSlider(options);
        }
    },
    updateSlider: function() {
        if (this.isBigScreen() || this.isBiggerScreen() || this.isInfinityScreen()) {
            this.currentOptions.minSlides = 3;
            this.currentOptions.maxSlides = 3;
            this.currentOptions.slideWidth = can.$(".drawer__content__slider__wrap").width() / 3;
        } else if (!this.isBigScreen() && !this.isBiggerScreen() && !this.isInfinityScreen()) {
            this.currentOptions.minSlides = 1;
            this.currentOptions.maxSlides = 1;
            this.currentOptions.slideWidth = 0;
        }
        if (this.slider) {
            this.slider.reloadSlider(this.currentOptions);
        } else {
            this.initSlider(this.currentOptions);
            this.showLatestData();
        }
        this.toggleSliderLinks();
    },
    showLatestData: function() {
        var slidesCount = this.slider.getSlideCount();
        this.slider.goToSlide(Math.ceil(slidesCount / this.currentOptions.maxSlides) - 1);
    },
    toggleSliderLinks: function() {
        var slideLinksWrap = this.element.find(".bx-pager");
        var slideLinks = this.element.find(".bx-pager-item");
        if (slideLinks.length > 1) {
            slideLinksWrap.show();
        } else {
            slideLinksWrap.hide();
        }
    },
    onWindowResize: function() {
        if (this.sliderUpdateTimeout) {
            window.clearTimeout(this.sliderUpdateTimeout);
            this.sliderUpdateTimeout = null;
        }
        this.sliderUpdateTimeout = window.setTimeout(this.proxy(function() {
            this.updateSlider();
        }), 100);
    },
    "{players.player} change": function() {
        can.batch.start();
        this.context.attr("results", this.splitDrawerData());
        this.onWindowResize();
        can.batch.stop();
        console.log("player.change");
    },
    "{team} change": function() {
        can.batch.start();
        this.context.attr("results", this.splitDrawerData());
        this.onWindowResize();
        can.batch.stop();
        console.log("team.change");
    }
});

usga.LeaderboardDrawerScorecardFourball = usga.BaseModule.extend({
    init: function() {
        this._super();
        this.context = this.options;
        this.context.attr("results", this.splitDrawerData());
        this.render();
    },
    render: function() {
        var renderer = can.view("#leaderBoardDrawerScoreCardFourball", this.context, this.getHelpers());
        this.element.html(renderer);
        this.showTab(this.getCurrentTab());
    },
    getCurrentTab: function() {
        var completedRounds = this.context.attr("roundsCompleted");
        var totalRounds = this.context.round.attr("length");
        var tab;
        if (!completedRounds || completedRounds == "0" || completedRounds === "" || completedRounds == " ") {
            tab = "item1";
        } else if (completedRounds == totalRounds) {
            tab = "all";
        } else {
            tab = "item" + (parseInt(completedRounds) + 1);
        }
        this.element.find(".rounds-switcher").removeClass("active");
        this.element.find('[data-tab="' + tab + '"]').addClass("active");
        return tab;
    },
    splitDrawerData: function() {
        var course = this.context.attr("courseData");
        var rounds = this.context.attr("round");
        var results = {
            outData: {
                rounds: []
            },
            inData: {
                rounds: []
            },
            totalData: {
                rounds: []
            }
        };
        for (var i = 0, ii = rounds.length; i < ii; i++) {
            var round = rounds[i];
            if (round.courseNo && round.courseNo !== "" && round.courseNo !== " ") {
                var currentCourse = this.getCurrentCourseByNo(course, round.courseNo);
                var holes = round.attr("hole");
                var roundData = this.fillRoundsWithHoles(holes, currentCourse);
                var inIndex = roundData.inIndex;
                var outIndex = roundData.outIndex;
                results.outData.rounds.push(holes.slice(0, outIndex + 1));
                results.inData.rounds.push(holes.slice(outIndex + 1, inIndex + 1));
                results.totalData.rounds.push(holes.slice(inIndex + 1, inIndex + 2));
            }
        }
        return results;
    },
    fillRoundsWithHoles: function(holes, course) {
        var holeIndex = 0;
        var output = {
            inIndex: null,
            outIndex: null
        };
        for (var j = 0, jj = holes.length; j < jj; j++) {
            var hole = holes[j];
            if (hole.no.toLowerCase() == "out") {
                hole.attr("yards", course.frontyards);
                hole.attr("holePar", course.frontpar);
                output.outIndex = j;
            } else if (hole.no.toLowerCase() == "in") {
                hole.attr("yards", course.backyards);
                hole.attr("holePar", course.backpar);
                output.inIndex = j;
            } else if (hole.no.toLowerCase() == "total") {
                hole.attr("yards", course.totalyards);
                hole.attr("holePar", course.par);
            } else {
                hole.attr("yards", course.hole[holeIndex].yards);
                holeIndex++;
            }
        }
        return output;
    },
    getCurrentCourseByNo: function(courses, no) {
        for (var i = 0, ii = courses.attr("length"); i < ii; i++) {
            if (courses[i].no == no) {
                return courses[i];
            }
        }
        return null;
    },
    getHelpers: function() {
        return {
            strikeColor: function(namedScore, holePar, strokes) {
                namedScore = can.isFunction(namedScore) ? namedScore() : namedScore;
                holePar = can.isFunction(holePar) ? holePar() : holePar;
                strokes = can.isFunction(strokes) ? strokes() : strokes;
                holePar = parseInt(holePar);
                strokes = parseInt(strokes);
                if (namedScore != "other" && namedScore != "better") {
                    return namedScore;
                } else {
                    if (holePar < strokes) {
                        return "dblbogey";
                    } else if (holePar > strokes) {
                        return "eagle";
                    }
                }
                return "";
            },
            roundByIndex: function(index) {
                index = can.isFunction(index) ? index() : index;
                return index + 1;
            }
        };
    },
    initSlider: function() {
        var sliderElement = this.$element.find(".drawer__content__slider");
        if (sliderElement.length) {
            this.slider = sliderElement.bxSlider({
                controls: false,
                infiniteLoop: false,
                minSlides: 1,
                maxSlides: 1,
                slideMargin: 0,
                adaptiveHeight: true,
                touchEnabled: usga.supports.touch
            });
        }
    },
    onDocumentReady: function() {
        this.onLayout();
        this.$element.find(".drawer__header__dropdown__item").chosen({
            disable_search_threshold: 10,
            width: "100%"
        });
    },
    onLayout: function() {
        if ((this.isBiggerScreen() || this.isInfinityScreen()) && this.slider) {
            this.slider.destroySlider();
            this.slider = null;
        } else if (!this.isBiggerScreen() && !this.isInfinityScreen() && !this.slider) {
            this.initSlider();
        }
    },
    showTab: function(tabName) {
        var tabs = this.element.find(".tab-round");
        if (tabName != "all") {
            tabs.hide();
            this.element.find(".tab-" + tabName).show();
        } else {
            tabs.show();
        }
        if (this.slider) {
            this.slider.reloadSlider();
        } else {
            this.onDocumentReady();
        }
        this.currentTab = tabName;
    },
    ".rounds-switcher click": function(element, event) {
        event.preventDefault();
        var tabName = element.data("tab");
        this.element.find(".rounds-switcher").removeClass("active");
        element.addClass("active");
        this.showTab(tabName);
    },
    ".rounds-select change": function(element) {
        var tabName = element.val();
        this.showTab(tabName);
    },
    "{rounds.round} change": function() {
        can.batch.start();
        this.context.attr("results", this.splitDrawerData());
        can.batch.stop();
        this.showTab(this.currentTab);
    },
    "{round} change": function() {
        can.batch.start();
        this.context.attr("results", this.splitDrawerData());
        can.batch.stop();
        this.showTab(this.currentTab);
    }
});

usga.LeaderboardDrawerScorecard = usga.BaseModule.extend({
    init: function() {
        this._super();
        this.context = this.options;
        this.context.attr("results", this.splitDrawerData());
        this.render();
    },
    render: function() {
        var renderer = can.view("#leaderBoardDrawerScoreCard", this.context, this.getHelpers());
        this.element.html(renderer);
        this.showTab(this.getCurrentTab());
    },
    getCurrentTab: function() {
        var completedRounds = this.context.attr("roundsCompleted");
        var totalRounds = this.context.round.attr("length");
        var tab;
        if (!completedRounds || completedRounds == "0" || completedRounds === "" || completedRounds == " ") {
            tab = "item1";
        } else if (completedRounds == totalRounds) {
            tab = "all";
        } else {
            tab = "item" + (parseInt(completedRounds) + 1);
        }
        this.element.find(".rounds-switcher").removeClass("active");
        this.element.find('[data-tab="' + tab + '"]').addClass("active");
        return tab;
    },
    splitDrawerData: function() {
        var course = this.context.attr("course.0");
        var holeList = course.holelist.mList;
        var parList = course.parlist.mList;
        var yardList = course.yardlist.roundlist;
        var resultsList = this.context.getRounds();
        var inIndex = this.getInOutIndexes(holeList).inIndex;
        var outIndex = this.getInOutIndexes(holeList).outIndex;
        return {
            outData: {
                holeList: holeList.slice(0, outIndex + 1),
                parList: parList.slice(0, outIndex + 1),
                rounds: this.getInOutRoundsData(yardList, resultsList, 0, outIndex + 1)
            },
            inData: {
                holeList: holeList.slice(outIndex + 1, inIndex + 1),
                parList: parList.slice(outIndex + 1, inIndex + 1),
                rounds: this.getInOutRoundsData(yardList, resultsList, outIndex + 1, inIndex + 1)
            },
            totalData: {
                hole: holeList[holeList.length - 1],
                par: parList[parList.length - 1],
                rounds: this.getInOutRoundsData(yardList, resultsList, inIndex + 1, inIndex + 2)
            }
        };
    },
    getInOutRoundsData: function(yardList, resultsList, startIndex, endIndex) {
        var output = [];
        for (var i = 0, ii = yardList.length; i < ii; i++) {
            var roundYardData = yardList[i].mList;
            var roundResultData = resultsList[i].hole;
            var roundOutput = [];
            for (var j = startIndex; j < endIndex; j++) {
                var holeYardData = roundYardData[j];
                var holeResultData = roundResultData[j];
                var holeOutput = {
                    yards: holeYardData.mList,
                    no: holeResultData.no,
                    namedScore: holeResultData.namedScore,
                    strokes: holeResultData.strokes,
                    holePar: holeResultData.holePar
                };
                roundOutput.push(holeOutput);
            }
            output.push(roundOutput);
        }
        return output;
    },
    getInOutIndexes: function(holeData) {
        var outIndex, inIndex;
        for (var i = 0, ii = holeData.length; i < ii; i++) {
            var holeName = holeData[i].mList.toLowerCase();
            if (holeName == "out") {
                outIndex = i;
            } else if (holeName == "in") {
                inIndex = i;
            }
        }
        return {
            outIndex: outIndex,
            inIndex: inIndex
        };
    },
    getHelpers: function() {
        var model = this.context;
        return {
            strikeColor: function(namedScore, holePar, strokes) {
                namedScore = can.isFunction(namedScore) ? namedScore() : namedScore;
                holePar = can.isFunction(holePar) ? holePar() : holePar;
                strokes = can.isFunction(strokes) ? strokes() : strokes;
                holePar = parseInt(holePar);
                strokes = parseInt(strokes);
                if (namedScore != "other" && namedScore != "better") {
                    return namedScore;
                } else {
                    if (holePar < strokes) {
                        return "dblbogey";
                    } else if (holePar > strokes) {
                        return "eagle";
                    }
                }
                return "";
            },
            roundByIndex: function(index) {
                index = can.isFunction(index) ? index() : index;
                return index + 1;
            }
        };
    },
    initSlider: function() {
        var sliderElement = this.$element.find(".drawer__content__slider");
        if (sliderElement.length) {
            this.slider = sliderElement.bxSlider({
                controls: false,
                infiniteLoop: false,
                minSlides: 1,
                maxSlides: 1,
                slideMargin: 0,
                adaptiveHeight: true,
                touchEnabled: usga.supports.touch
            });
        }
    },
    onDocumentReady: function() {
        this.onLayout();
        this.$element.find(".drawer__header__dropdown__item").chosen({
            disable_search_threshold: 10,
            width: "100%"
        });
    },
    onLayout: function() {
        if ((this.isBiggerScreen() || this.isInfinityScreen()) && this.slider) {
            this.slider.destroySlider();
            this.slider = null;
        } else if (!this.isBiggerScreen() && !this.isInfinityScreen() && !this.slider) {
            this.initSlider();
        }
    },
    showTab: function(tabName) {
        var tabs = this.element.find(".tab-round");
        if (tabName != "all") {
            tabs.hide();
            this.element.find(".tab-" + tabName).show();
        } else {
            tabs.show();
        }
        if (this.slider) {
            this.slider.reloadSlider();
        } else {
            this.onDocumentReady();
        }
        this.currentTab = tabName;
    },
    ".rounds-switcher click": function(element, event) {
        event.preventDefault();
        var tabName = element.data("tab");
        this.element.find(".rounds-switcher").removeClass("active");
        element.addClass("active");
        this.showTab(tabName);
    },
    ".rounds-select change": function(element) {
        var tabName = element.val();
        this.showTab(tabName);
    },
    "{rounds.round} change": function() {
        can.batch.start();
        this.context.attr("results", this.splitDrawerData());
        can.batch.stop();
        this.showTab(this.currentTab);
    },
    "{round} change": function() {
        can.batch.start();
        this.context.attr("results", this.splitDrawerData());
        can.batch.stop();
        this.showTab(this.currentTab);
    }
});

usga.LeaderboardDrawer = usga.BaseModule.extend({
    initSlider: function() {
        this.slider = this.$element.find(".drawer__content__slider").bxSlider({
            controls: false,
            infiniteLoop: false,
            minSlides: 1,
            maxSlides: 1,
            slideMargin: 0,
            adaptiveHeight: true,
            touchEnabled: usga.supports.touch
        });
    },
    onDocumentReady: function() {
        this.onLayout();
    },
    onLayout: function() {
        if ((this.isBigScreen() || this.isBiggerScreen() || this.isInfinityScreen()) && this.slider) {
            this.slider.destroySlider();
            this.slider = null;
        } else if (!this.isBigScreen() && !this.isBiggerScreen() && !this.isInfinityScreen() && !this.slider) {
            this.initSlider();
        }
    }
});

usga.LeaderBoardFourballStrokeControl = usga.LeaderBoardBaseControl.extend({
    defaultSortAttr: "position",
    currentSortAttr: "position",
    chunkSize: 15,
    init: function() {
        this._super();
        this.context = new usga.LeaderBoardBaseModel();
        this.render();
        this.dataUrl = this.options.dataUrl;
        this.getData();
    },
    render: function() {
        var renderer = can.view("#leaderBoardStateIndividualStroke", this.context, this.getHelpers());
        this.element.addClass("leaderboard-state-team-stroke");
        this.element.append(renderer);
        if (this.options.playOff && this.options.playOff !== "") {
            var playOffControl = new usga.LeaderboardPlayoffControl("#leaderboardPlayoff", {
                dataUrl: this.options.playOff,
                lbType: this.options.lbType
            });
        }
    },
    applyInitialContextData: function(data) {
        var tournament = data.event.tournament;
        if (tournament) {
            can.batch.start();
            this.context.attr("tableLegend", this.getLegends(tournament.legends));
            this.context.attr("currentRound", tournament.currentround);
            this.context.attr("lbType", this.options.lbType);
            this.context.attr("roundData", tournament.tabcontrol.round);
            this.context.attr("cutData", tournament.cut);
            this.context.attr("suspended", this.getPlaySuspended(tournament.playsuspended));
            if (tournament.courses) {
                this.applyCourseData(this.context.attr("courseData"), tournament.courses.course);
            } else {
                this.applyCourseData(this.context.attr("courseData"), tournament.course);
            }
            var teams = tournament.teams.team;
            can.batch.stop();
            this.applyPartialData(teams, 0, this.chunkSize, this.proxy(this.createTeamsControls));
        }
    },
    createTeamsControls: function(teams) {
        for (var i = 0, ii = teams.length; i < ii; i++) {
            var team = new usga.LeaderBoardFourballTeam(teams[i]);
            team.attr("courseData", this.context.courseData);
            team.attr("roundData", this.context.roundData);
            team.attr("stateIndividual", true);
            team.attr("currentRound", this.context.currentRound);
            team.attr("lbType", this.options.lbType);
            var teamId = team.attr("idField");
            this.createTeamElement(team, "full-leader-board", "team-row", teamId);
            this.context.teamsData.attr(teamId, team);
        }
        if (this.currentSortAttr !== this.defaultSortAttr || this.currentSortDirection !== this.defaultSortDirection) {
            this.sortTables(this.currentSortAttr, this.currentSortDirection, this.currentSortType);
        }
        this.createCutLine();
    },
    createTeamElement: function(teamData, elementClass, playerClass, elementId, isFavorite) {
        var searchDataAttr = "displayName";
        var tbody = $('<tbody data-search="' + teamData.attr(searchDataAttr) + '" class="' + elementClass + " " + playerClass + '" id="' + elementId + '"></tbody>');
        if (isFavorite) {
            tbody.data("favorite", "true");
        }
        for (var attr in teamData) {
            if (teamData.hasOwnProperty(attr) && attr != "round") {
                tbody.data(attr, teamData.attr(attr));
            }
        }
        if (this.element) {
            this.element.find("." + elementClass).last().after(tbody);
            var teamControl = new usga.LeaderBoardFourballTeamControl("#" + elementId, {
                context: teamData
            });
        }
    },
    applyDataChanges: function(data) {
        this.context.attr("suspended", this.getPlaySuspended(data.event.tournament.playsuspended));
        this.context.attr("cutData", data.event.tournament.cut);
        this.changedData = data.event.tournament.teams.team;
        if (this.currentSortAttr !== this.defaultSortAttr || this.currentSortDirection !== this.defaultSortDirection) {
            this.sortList(this.changedData, this.currentSortAttr, this.currentSortDirection, this.currentSortType);
        }
        this.compareData();
    },
    compareData: function() {
        this.hasChanges = false;
        can.batch.start(this.proxy(function() {
            if (this.hasChanges) {
                this.sortTables(this.currentSortAttr, this.currentSortDirection, this.currentSortType);
                this.createCutLine();
            }
        }));
        for (var i = 0, ii = this.changedData.length; i < ii; i++) {
            var changedTeam = this.changedData[i];
            var changedTeamId = changedTeam.idint ? "team" + changedTeam.idint : changedTeam.name.replace(/\s/gi, "").replace(/\./gi, "").replace(/,/, "");
            var team = this.context.teamsData.attr(changedTeamId);
            if (this.hasChanges === false) {
                this.hasChanges = this.compareAndSetAttr(changedTeam, team, team);
            } else {
                this.compareAndSetAttr(changedTeam, team, team);
            }
        }
        can.batch.stop();
    },
    sortTables: function(attr, direction, type) {
        this.sortDomElements(attr, direction, type, "team-row", "full-leader-board");
        var favorites = this.element.find(".my-team-row");
        if (favorites.length) {
            this.sortDomElements(attr, direction, type, "my-team-row", "my-leader-board");
        }
        this.toggleCutLine(direction, attr);
    },
    addToFavorites: function(element) {
        var teamData = element.closest("tr").data("player");
        var teamId = "my" + teamData.attr("idField");
        teamData.attr("selected", true);
        this.createTeamElement(teamData, "my-leader-board", "my-team-row", teamId, true);
        this.sortDomElements(this.currentSortAttr, this.currentSortDirection, this.currentSortType, "my-team-row", "my-leader-board");
        this.showTitles();
        this.saveToStorage(this.context.attr("lbType") + "." + teamData.attr("idField"), true);
    },
    removeFromFavorites: function(element) {
        var teamData = element.closest("tr").data("player");
        var teamId = teamData.attr("idField");
        teamData.attr("selected", false);
        var teamElement = element.closest("tbody");
        var isFavorite = teamElement.data("favorite");
        if (isFavorite) {
            teamElement.remove();
        } else {
            this.element.find("#my" + teamId).remove();
        }
        var favorites = this.element.find(".my-leader-board");
        if (favorites.length <= 1) {
            this.hideTitles();
        }
        this.removeFromStorage(this.context.attr("lbType") + "." + teamData.attr("idField"));
    },
    showTitles: function() {
        this.element.find("#myLeaderBoardTitle").show();
    },
    hideTitles: function() {
        this.element.find("#myLeaderBoardTitle").hide();
    },
    createCutLine: function() {
        var cutData = this.context.attr("cutData");
        var cutToPar, cutText, cutPosition, cutElement, teamsElements, teamCut;
        if (cutData.attr("showCut") && this.element) {
            cutToPar = cutData.attr("cuttopar");
            cutText = cutData.attr("cutlineText");
            cutPosition = cutData.attr("finalCut") != "false" ? cutData.attr("madeCut") : cutData.attr("underCutLine");
            teamsElements = this.element.find(".team-row");
            teamCut = teamsElements.filter(function(index) {
                return index == cutPosition - 1;
            });
            cutElement = can.$('<tr class="cut-line"><td colspan="15" class="lb-match__cut-line">' + cutText + " " + cutToPar + "</td></tr>");
            this.element.find("tr.cut-line").remove();
            teamCut.append(cutElement);
        }
    },
    toggleCutLine: function(direction, attr) {
        var cutLine = this.element.find(".cut-line");
        if (direction == "asc" && attr == this.defaultSortAttr) {
            cutLine.show();
        } else {
            cutLine.hide();
        }
    },
    ".sort-table click": function(element, event) {
        event.preventDefault();
        can.batch.start();
        var headers = this.element.find(".sort-table");
        this.setSortType(element, element.data("attr"), element.data("type"), this.changedData, headers);
        can.batch.stop();
    },
    ".favorite click": function(element, event) {
        event.preventDefault();
        event.stopPropagation();
        if (!element.hasClass("inactive")) {
            if (element.hasClass("add")) {
                this.addToFavorites(element);
            } else {
                this.removeFromFavorites(element);
            }
        }
    },
    ".leader-board-player click": function(element) {
        this.element.find(".attached-drawer").remove();
        var teamModel = element.data("player");
        this.createScorecardDrawer(element, teamModel);
    },
    ".close-drawer click": function() {
        this.element.find(".attached-drawer").remove();
    }
});

usga.LeaderBoardFourballTeamControl = usga.BaseModule.extend({
    init: function() {
        this._super();
        this.context = this.options.context;
        this.render();
    },
    render: function() {
        this.context.attr("screenSize", this.getScreenSize());
        var renderer = can.view("#leaderBoardPlayer", this.context, this.getHelpers());
        this.element.append(renderer);
        this.addToFavorite();
    },
    addToFavorite: function() {
        var lbType = this.context.attr("lbType");
        var id = this.context.attr("idField");
        if (window.localStorage.getItem(lbType + "." + id) && !this.element.hasClass("my-team-row")) {
            this.element.find(".favorite").trigger("click");
        }
    },
    getHelpers: function() {
        var context = this.context;
        return {
            isCurrentRound: function(roundNumber, options) {
                roundNumber = can.isFunction(roundNumber) ? roundNumber() : roundNumber;
                return roundNumber == context.attr("currentRound") ? options.fn() : options.inverse();
            },
            getRoundAttr: function(roundName) {
                roundName = can.isFunction(roundName) ? roundName() : roundName;
                if (context.attr("r" + roundName) !== null && context.attr("r" + roundName) !== undefined) {
                    return context.attr("r" + roundName);
                } else {
                    return context.attr("R" + roundName);
                }
            },
            isTwoRoundsEvent: function(roundData, options) {
                roundData = can.isFunction(roundData) ? roundData() : roundData;
                if (roundData.attr("length") == 2) {
                    return options.fn(this);
                }
                return options.inverse(this);
            },
            parColor: function(attr) {
                attr = can.isFunction(attr) ? attr() : attr;
                if (attr && parseInt(attr) < 0) {
                    return "red";
                }
                return null;
            },
            roundParColor: function(roundName) {
                roundName = can.isFunction(roundName) ? roundName() : roundName;
                var roundValue = context.attr("R" + roundName);
                var coursePar, courseNo, courses;
                if (roundValue && roundValue !== "" && roundValue !== " ") {
                    courseNo = context.attr("round").attr(roundName - 1).attr("courseNo");
                    courses = context.attr("courseData");
                    for (var i = 0, ii = courses.attr("length"); i < ii; i++) {
                        if (courses[i].no == courseNo) {
                            coursePar = courses[i].par;
                        }
                    }
                    if (coursePar) {
                        if (roundValue < coursePar) {
                            return "red";
                        }
                    }
                }
                return null;
            }
        };
    },
    onLayout: function() {
        this.context.attr("screenSize", this.getScreenSize());
    },
    "{context} change": function(map, evt, attr, how, newValue) {
        this.element.data(attr, newValue);
    }
});

usga.LeaderBoardFourballTeam = usga.LeaderBoardBaseMap.extend({
    define: {
        players: {
            Type: usga.LeaderBoardPlayers,
            Value: usga.LeaderBoardPlayers
        },
        rounds: {
            Type: usga.LeaderBoardPlayersRounds,
            Value: usga.LeaderBoardPlayersRounds
        },
        round: {
            Type: usga.BaseMap.List,
            Value: usga.BaseMap.List
        }
    },
    idField: can.compute(function() {
        if (this.attr("idint")) {
            return "team" + this.attr("idint");
        } else {
            return this.attr("name").replace(/\s/gi, "").replace(/\./gi, "").replace(/,/, "");
        }
    }),
    displayName: can.compute(function() {
        var playerOne = this.players.attr("player.0");
        var playerTwo = this.players.attr("player.1");
        if (playerOne && playerTwo) {
            return playerOne.attr("fullName") + " / " + playerTwo.attr("fullName");
        } else {
            return this.attr("team");
        }
    }),
    shortName: can.compute(function() {
        var playerOne = this.players.attr("player.0");
        var playerTwo = this.players.attr("player.1");
        if (playerOne && playerTwo) {
            return playerOne.attr("shortName") + " / " + playerTwo.attr("shortName");
        } else {
            return this.attr("team");
        }
    }),
    getRounds: can.compute(function() {
        var rounds;
        if (this.rounds.round.attr("length")) {
            rounds = this.rounds.attr("round");
        } else {
            rounds = this.attr("round");
        }
        return rounds;
    })
});

usga.LeaderBoardIndividualStrokeControl = usga.LeaderBoardBaseControl.extend({
    defaultSortAttr: "position",
    currentSortAttr: "position",
    isCutCreated: false,
    chunkSize: 15,
    init: function() {
        this._super();
        this.context = new usga.LeaderBoardBaseModel();
        this.render();
        this.dataUrl = this.options.dataUrl;
        this.getData();
    },
    render: function() {
        var renderer = can.view("#leaderBoardStateIndividualStroke", this.context, this.getHelpers());
        this.element.addClass("leaderboard-state-team-stroke");
        this.element.append(renderer);
    },
    applyInitialContextData: function(data) {
        var tournament = data.event.tournament;
        if (tournament) {
            can.batch.start();
            this.context.attr("tableLegend", this.getLegends(tournament.legends));
            this.context.attr("courseData", tournament.course);
            this.context.attr("currentRound", tournament.currentround);
            this.context.attr("lbType", this.options.lbType);
            this.context.attr("roundData", tournament.tabcontrol.round);
            this.context.attr("cutData", tournament.cut);
            this.context.attr("suspended", this.getPlaySuspended(tournament.playsuspended));
            var players = tournament.players.player;
            can.batch.stop();
            this.applyPartialData(players, 0, this.chunkSize, this.proxy(this.createPlayersControls));
        }
    },
    createPlayersControls: function(players) {
        for (var i = 0, ii = players.length; i < ii; i++) {
            var player = new usga.LeaderBoardPlayer(players[i]);
            player.attr("course", this.context.courseData);
            player.attr("roundData", this.context.roundData);
            player.attr("stateIndividual", true);
            player.attr("currentRound", this.context.currentRound);
            player.attr("lbType", this.options.lbType);
            var playerId = player.attr("idField");
            this.createPlayerElement(player, "full-leader-board", "player-row", playerId);
            this.context.playersData.attr(playerId, player);
        }
        if (this.currentSortAttr !== this.defaultSortAttr || this.currentSortDirection !== this.defaultSortDirection) {
            this.sortTables(this.currentSortAttr, this.currentSortDirection, this.currentSortType);
        }
        this.createCutLine();
    },
    createPlayerElement: function(playerData, elementClass, playerClass, elementId, isFavorite) {
        var searchDataAttr = this.options.lbType == "fourballIntlStroke" ? "name" : "displayName";
        var tbody = $('<tbody data-search="' + playerData.attr(searchDataAttr) + '" class="' + elementClass + " " + playerClass + '" id="' + elementId + '"></tbody>');
        if (isFavorite) {
            tbody.data("favorite", "true");
        }
        if (playerData.attr("isAmateur")) {
            tbody.addClass("player-amateur");
        }
        for (var attr in playerData) {
            if (playerData.hasOwnProperty(attr) && attr != "round") {
                tbody.data(attr, playerData.attr(attr));
            }
        }
        if (this.element) {
            this.element.find("." + elementClass).last().after(tbody);
            var playerControl = new usga.LeaderBoardPlayerControl("#" + elementId, {
                context: playerData
            });
        }
    },
    applyDataChanges: function(data) {
        this.context.attr("suspended", this.getPlaySuspended(data.event.tournament.playsuspended));
        this.context.attr("cutData", data.event.tournament.cut);
        this.changedData = data.event.tournament.players.player;
        if (this.currentSortAttr !== this.defaultSortAttr || this.currentSortDirection !== this.defaultSortDirection) {
            this.sortList(this.changedData, this.currentSortAttr, this.currentSortDirection, this.currentSortType);
        }
        this.compareData();
    },
    compareData: function() {
        this.hasChanges = false;
        can.batch.start(this.proxy(function() {
            if (this.hasChanges) {
                this.sortTables(this.currentSortAttr, this.currentSortDirection, this.currentSortType);
                this.createCutLine();
            }
        }));
        for (var i = 0, ii = this.changedData.length; i < ii; i++) {
            var changedPlayer = this.changedData[i];
            var changedPlayerId = changedPlayer.idint ? "player" + changedPlayer.idint : changedPlayer.name.replace(/\s/gi, "").replace(/\./gi, "").replace(/,/, "");
            var player = this.context.playersData.attr(changedPlayerId);
            if (this.hasChanges === false) {
                this.hasChanges = this.compareAndSetAttr(changedPlayer, player, player);
            } else {
                this.compareAndSetAttr(changedPlayer, player, player);
            }
        }
        can.batch.stop();
    },
    sortTables: function(attr, direction, type) {
        this.sortDomElements(attr, direction, type, "player-row", "full-leader-board");
        var favorites = this.element.find(".my-player-row");
        if (favorites.length) {
            this.sortDomElements(attr, direction, type, "my-player-row", "my-leader-board");
        }
        this.toggleCutLine(direction, attr);
    },
    addToFavorites: function(element) {
        var playerData = element.closest("tr").data("player");
        var playerId = "my" + playerData.attr("idField");
        playerData.attr("selected", true);
        this.createPlayerElement(playerData, "my-leader-board", "my-player-row", playerId, true);
        this.sortDomElements(this.currentSortAttr, this.currentSortDirection, this.currentSortType, "my-player-row", "my-leader-board");
        this.showTitles();
        this.saveToStorage(this.context.attr("lbType") + "." + playerData.attr("idField"), true);
    },
    removeFromFavorites: function(element) {
        var playerData = element.closest("tr").data("player");
        var playerId = playerData.attr("idField");
        playerData.attr("selected", false);
        var playerElement = element.closest("tbody");
        var isFavorite = playerElement.data("favorite");
        if (isFavorite) {
            playerElement.remove();
        } else {
            this.element.find("#my" + playerId).remove();
        }
        var favorites = this.element.find(".my-leader-board");
        if (favorites.length <= 1) {
            this.hideTitles();
        }
        this.removeFromStorage(this.context.attr("lbType") + "." + playerData.attr("idField"));
    },
    showTitles: function() {
        this.element.find("#myLeaderBoardTitle").show();
    },
    hideTitles: function() {
        this.element.find("#myLeaderBoardTitle").hide();
    },
    createCutLine: function() {
        var cutData = this.context.attr("cutData");
        var cutToPar, cutText, cutPosition, cutElement, playersElements, playerCut;
        if (cutData.attr("showCut") == "true" && this.element) {
            cutToPar = cutData.attr("cuttopar");
            cutText = cutData.attr("cutlineText");
            cutPosition = cutData.attr("finalCut") != "false" ? cutData.attr("madeCut") : cutData.attr("underCutLine");
            playersElements = this.element.find(".player-row");
            playerCut = playersElements.filter(function(index) {
                return index == cutPosition - 1;
            });
            cutElement = can.$('<tr class="cut-line"><td colspan="15" class="lb-match__cut-line">' + cutText + " " + cutToPar + "</td></tr>");
            this.element.find("tr.cut-line").remove();
            playerCut.append(cutElement);
        }
    },
    toggleCutLine: function(direction, attr) {
        var cutLine = this.element.find(".cut-line");
        if (direction == "asc" && attr == this.defaultSortAttr) {
            cutLine.show();
        } else {
            cutLine.hide();
        }
    },
    ".sort-table click": function(element, event) {
        event.preventDefault();
        can.batch.start();
        var headers = this.element.find(".sort-table");
        this.setSortType(element, element.data("attr"), element.data("type"), this.changedData, headers);
        can.batch.stop();
    },
    ".favorite click": function(element, event) {
        event.preventDefault();
        event.stopPropagation();
        if (!element.hasClass("inactive")) {
            if (element.hasClass("add")) {
                this.addToFavorites(element);
            } else {
                this.removeFromFavorites(element);
            }
        }
    },
    ".leader-board-player click": function(element) {
        this.element.find(".attached-drawer").remove();
        var playerModel = element.data("player");
        this.createScorecardDrawer(element, playerModel);
    },
    ".close-drawer click": function() {
        this.element.find(".attached-drawer").remove();
    }
});

usga.LeaderBoardMatchControl = usga.BaseModule.extend({
    init: function() {
        this._super();
        this.context = this.options;
        this.render();
    },
    render: function() {
        this.context.attr("screenSize", this.getScreenSize());
        var renderer = can.view("#leaderBoardMatch", this.context, this.getHelpers());
        this.element.append(renderer);
    },
    getHelpers: function() {
        return {
            getFlag: function(player) {
                player = can.isFunction(player) ? player() : player;
                if (player.attr("ctyCode")) {
                    return player.attr("ctyCode").toUpperCase();
                } else {
                    return player.attr("country").toUpperCase();
                }
            },
            setLeaderIndicator: function(round, playerNum) {
                round = can.isFunction(round) ? round() : round;
                var status = round.attr("status");
                var leaderNum = round.attr("leader");
                if (leaderNum == "A") {
                    leaderNum = 1;
                } else if (leaderNum == "B") {
                    leaderNum = 2;
                }
                if (leaderNum == playerNum) {
                    if (status == "completed") {
                        return "winner";
                    } else {
                        return "leader";
                    }
                }
                return "";
            }
        };
    },
    onLayout: function() {
        this.context.attr("screenSize", this.getScreenSize());
    }
});

usga.LeaderBoardMatch = usga.LeaderBoardBaseMap.extend({
    define: {
        number: {
            type: "*",
            value: null
        },
        status: {
            type: "string",
            value: ""
        },
        players: {
            Type: usga.LeaderBoardPlayers,
            Value: usga.LeaderBoardPlayers
        },
        team: {
            Type: usga.LeaderBoardTeam.List,
            Value: usga.LeaderBoardTeam.List
        },
        courseData: {
            Type: usga.BaseMap.List,
            Value: usga.BaseMap.List
        }
    },
    idField: can.compute(function() {
        if (this.attr("idint")) {
            return "match" + this.attr("idint");
        } else {
            return "match" + this.attr("number");
        }
    }),
    getStatus: can.compute(function() {
        var status = this.attr("status");
        var standingData = this.attr("standing");
        var thru = this.parseStanding(standingData).status;
        if (status != "completed" && status != "notstarted") {
            return thru ? "thru " + thru : "";
        }
        return null;
    }),
    getStanding: can.compute(function() {
        var status = this.attr("status");
        var standingData = this.attr("standing");
        if (status == "notstarted") {
            return this.attr("teetime");
        } else {
            return this.parseStanding(standingData).standing;
        }
    }),
    getMiniLbStanding: can.compute(function() {
        var status = this.attr("status");
        var standingData = this.attr("standing");
        if (status == "notstarted") {
            return this.attr("standing");
        } else {
            return this.parseStanding(standingData).standing;
        }
    }),
    parseStanding: function(standingData) {
        var output = {
            standing: null,
            status: null
        };
        var standingParts = [];
        if (standingData) {
            standingParts = standingData.split(/thru/i);
            output.standing = standingParts[0];
            output.status = standingParts[1];
        }
        return output;
    },
    isCompleted: can.compute(function() {
        return this.attr("status") == "completed";
    }),
    isInProgress: can.compute(function() {
        return this.attr("status") != "completed" && this.attr("status") != "notstarted";
    }),
    isStarted: can.compute(function() {
        return this.attr("status") != "notstarted";
    })
});

usga.LeaderBoardMatchPlayControl = usga.LeaderBoardBaseControl.extend({
    chunkSize: 15,
    init: function() {
        this._super();
        this.context = new usga.LeaderBoardBaseModel();
        this.dataUrl = this.options.dataUrl;
        this.getData();
    },
    applyInitialContextData: function(data) {
        var tournament = data.event.tournament;
        if (tournament) {
            can.batch.start();
            if (tournament.courses) {
                this.applyCourseData(this.context.attr("courseData"), tournament.courses.course);
            } else {
                this.applyCourseData(this.context.attr("courseData"), tournament.course);
            }
            if (tournament.tabcontrol) {
                this.context.attr("roundData", tournament.tabcontrol.round);
            } else {
                this.context.attr("roundData", this.options.tabControl);
            }
            this.context.attr("currentRound", tournament.currentround);
            this.context.attr("suspended", this.getPlaySuspended(tournament.playsuspended));
            this.context.attr("lbType", this.options.lbType);
            var matches = tournament.matches.match;
            can.batch.stop();
            this.renderSuspended(data);
            this.renderHeader();
            this.applyPartialData(matches, 0, this.chunkSize, this.proxy(this.createMatchesControls));
        }
    },
    createMatchesControls: function(matches) {
        for (var i = 0, ii = matches.length; i < ii; i++) {
            var match = new usga.LeaderBoardMatch(matches[i]);
            var matchId = match.attr("idField");
            match.attr("courseData", this.context.courseData);
            match.attr("lbType", this.options.lbType);
            this.context.matchesData.attr(matchId, match);
            var matchElement = can.$('<div class="lb-match__container__item" id="' + matchId + '"></div>');
            matchElement.data("search", this.getMatchSearchData(match));
            if (this.element) {
                this.element.append(matchElement);
                var matchControl = new usga.LeaderBoardMatchControl(matchElement, match);
            }
        }
    },
    getMatchSearchData: function(match) {
        var playerOne, playerTwo;
        if (match.team.attr("length") > 0) {
            playerOne = match.attr("team.0.player").attr("teamName");
            playerTwo = match.attr("team.1.player").attr("teamName");
            return playerOne + " " + playerTwo;
        } else {
            playerOne = match.attr("players.player.0");
            playerTwo = match.attr("players.player.1");
            return playerOne.attr("fullName") + " " + playerTwo.attr("fullName");
        }
    },
    applyDataChanges: function(data) {
        this.renderSuspended(data);
        this.changedData = data.event.tournament.matches.match;
        can.batch.start();
        for (var i = 0, ii = this.changedData.length; i < ii; i++) {
            var changedMatch = this.changedData[i];
            var changedMatchId = changedMatch.idint ? "match" + changedMatch.idint : "match" + changedMatch.number;
            var match = this.context.matchesData.attr(changedMatchId);
            this.compareAndSetAttr(changedMatch, match, match);
        }
        can.batch.stop();
    },
    ".match-item.lb-clickable click": function(element, event) {
        this.element.find(".attached-drawer").remove();
        var matchData = element.data("match");
        this.createMatchPlayDrawer(element, matchData);
    },
    ".close-drawer click": function() {
        this.element.find(".attached-drawer").remove();
    }
});

usga.LeaderBoardTeamMatchPlayControl = usga.LeaderBoardBaseControl.extend({
    init: function() {
        this._super();
        this.context = new usga.LeaderBoardBaseModel();
        this.render();
        this.getInitialData();
    },
    destroy: function() {
        if (this.updateInterval) {
            window.clearInterval(this.updateInterval);
        }
        can.Control.prototype.destroy.call(this);
    },
    render: function() {
        var renderer = can.view("#leaderBoardTeamMatchPlay", this.context, this.getHelpers());
        this.element.html(renderer);
    },
    getInitialData: function() {
        can.ajax({
            type: "GET",
            url: this.options.dataUrl.matchStatusUrl,
            headers: {
                "Content-Type": "application/json"
            },
            success: this.proxy(function(data) {
                if (!this.initialized) {
                    this.initialized = true;
                    this.applyInitialContextData(data);
                } else {
                    this.applyInitialDataChanges(data);
                }
                this.getAllRoundsData();
            }),
            error: this.proxy(function(xhr) {
                console.log(xhr);
            })
        });
    },
    getAllRoundsData: function() {
        var roundsUrls = this.options.dataUrl.roundsUrls;
        for (var i = 0, ii = roundsUrls.length; i < ii; i++) {
            this.getRoundData(roundsUrls[i], i);
            this.context.matchPlayRounds.push(new usga.LeaderBoardBaseMap({
                matchesData: new usga.BaseMap()
            }));
        }
    },
    getRoundData: function(url, roundIndex) {
        can.ajax({
            type: "GET",
            url: url,
            headers: {
                "Content-Type": "application/json"
            },
            success: this.proxy(function(data) {
                if (!this["round" + roundIndex + "initialized"]) {
                    this["round" + roundIndex + "initialized"] = true;
                    this.applyRoundData(data, roundIndex);
                } else {
                    this.applyRoundDataChanges(data, roundIndex);
                }
                this.renderSuspended(data);
            }),
            error: this.proxy(function(xhr) {
                console.log(xhr);
            })
        });
    },
    applyInitialContextData: function(data) {
        var tournament = data.event.tournament;
        if (tournament) {
            can.batch.start();
            this.context.attr("matchPlayTeamsData", tournament.cupteams);
            this.context.attr("lbType", this.options.lbType);
            can.batch.stop();
        }
        this.initDataUpdating();
    },
    applyInitialDataChanges: function(data) {
        var changedData = data.event.tournament.cupteams;
        var teamsData = this.context.attr("matchPlayTeamsData");
        this.compareAndSetAttr(changedData, teamsData, teamsData);
    },
    applyRoundData: function(data, roundIndex) {
        var tournament = data.event.tournament;
        var roundName = tournament.roundlabel;
        var teamsData = tournament.teams.team;
        var roundElement = can.$('<div class="round-container ' + this.getRoundType(roundName) + '"><div class="lb-match__cut-line">' + roundName + "</div></div>");
        this.element.append(roundElement);
        var roundContext = this.context.matchPlayRounds.attr(roundIndex);
        can.batch.start();
        roundContext.attr("courseData", tournament.course);
        roundContext.attr("roundData", tournament.tabcontrol.round);
        roundContext.attr("currentRound", tournament.currentround);
        roundContext.attr("teamData", teamsData);
        roundContext.attr("lbType", this.options.lbType);
        this.context.matchPlayTeamsData.attr("teamOneFlag", teamsData[0].flag);
        this.context.matchPlayTeamsData.attr("teamTwoFlag", teamsData[1].flag);
        var matches = tournament.matches.match;
        this.createMatchesControls(matches, roundElement, roundIndex);
        can.batch.stop();
    },
    applyRoundDataChanges: function(data, roundIndex) {
        var roundContext = this.context.matchPlayRounds.attr(roundIndex);
        this.changedData = data.event.tournament.matches.match;
        can.batch.start();
        for (var i = 0, ii = this.changedData.length; i < ii; i++) {
            var changedMatch = this.changedData[i];
            var changedMatchId = changedMatch.idint ? "match" + changedMatch.idint : "match" + changedMatch.number;
            var match = roundContext.matchesData.attr(changedMatchId);
            this.compareAndSetAttr(changedMatch, match, match);
        }
        can.batch.stop();
    },
    getRoundType: function(roundName) {
        var singlesRegExp = /singles/gi;
        var foursomesRegExp = /foursomes/gi;
        var fourballRegExp = /four-ball/gi;
        if (singlesRegExp.test(roundName)) {
            return "singles-table";
        } else if (foursomesRegExp.test(roundName)) {
            return "foursomes-table";
        } else if (fourballRegExp.test(roundName)) {
            return "fourball-table";
        }
    },
    initDataUpdating: function() {
        this.updateInterval = window.setInterval(this.proxy(function() {
            this.getInitialData();
        }), this.updateIntervalDuration);
    },
    createMatchesControls: function(matches, element, roundIndex) {
        for (var i = 0, ii = matches.length; i < ii; i++) {
            var match = new usga.LeaderBoardMatch(matches[i]);
            var matchId = match.attr("idField");
            var roundContext = this.context.matchPlayRounds.attr(roundIndex);
            this.context.attr("teamData", roundContext.teamData);
            match.attr("courseData", roundContext.courseData);
            match.attr("course", roundContext.courseData.no);
            match.attr("teamData", roundContext.teamData);
            match.attr("lbType", this.options.lbType);
            roundContext.matchesData.attr(matchId, match);
            var matchElement = can.$('<div class="lb-match__container__item" id="' + matchId + '"></div>');
            matchElement.data("search", this.getMatchSearchData(match));
            element.append(matchElement);
            var matchControl = new usga.LeaderBoardMatchControl(matchElement, match);
        }
    },
    getMatchSearchData: function(match) {
        var playerOne = match.attr("players.player.0");
        var playerTwo = match.attr("players.player.1");
        return playerOne.attr("name") + " " + playerTwo.attr("name");
    },
    ".match-item click": function(element, event) {
        this.element.find(".attached-drawer").remove();
        var matchData = element.data("match");
        this.createMatchPlayDrawer(element, matchData);
    },
    ".close-drawer click": function() {
        this.element.find(".attached-drawer").remove();
    }
});

usga.LeaderBoardMiniBaseControl = usga.LeaderBoardBaseControl.extend({
    currentTab: "mini-lb-tab",
    templates: {
        live: "#leaderBoardMiniLiveEvent",
        summary: "#leaderBoardMiniSummaryBox",
        latest: "#leaderBoardMiniLatest"
    },
    itemsPerView: {
        match: 4,
        stroke: 5,
        times: 5
    },
    latestItemsPerView: 6,
    init: function() {
        this._super();
        this.context = new usga.LeaderBoardMiniModel();
        this.applyConfig();
    },
    render: function() {
        var renderer = can.view(this.template, this.context, this.getHelpers());
        this.element.append(renderer);
    },
    getHelpers: function() {
        return {
            matchPlayerName: function(name) {
                name = can.isFunction(name) ? name() : name;
                if (name) {
                    return name.replace(/([A-z\-]*),\s*([A-z\-\.])*/, "$2. $1");
                }
                return null;
            },
            teamPlayerName: function(name) {
                name = can.isFunction(name) ? name() : name;
                if (name) {
                    return name.replace(/([A-z\.-]*),\s*([A-Z]{1})[A-z\.-]*\s*(\/)\s*([A-z\.-]*),\s*([A-Z]{1})[A-z\.-]*/, "$2. $1 $3<br/>$5. $4");
                }
                return null;
            },
            teamTimesPlayerName: function(name) {
                name = can.isFunction(name) ? name() : name;
                if (name) {
                    return name.replace(/([A-z\.-]*),\s*([A-Z]{1})[A-z\.-]*\s*(\/)\s*([A-z\.-]*),\s*([A-Z]{1})[A-z\.-]*/, "$2. $1 $3 $5. $4");
                }
                return null;
            },
            setLeaderIndicator: function(round, playerNum) {
                round = can.isFunction(round) ? round() : round;
                var status = round.attr("status");
                var leaderNum = round.attr("leader");
                if (leaderNum == "A") {
                    leaderNum = 1;
                } else if (leaderNum == "B") {
                    leaderNum = 2;
                }
                if (leaderNum == playerNum) {
                    if (status == "completed") {
                        return "winner";
                    } else {
                        return "leader";
                    }
                }
                return "";
            },
            parColor: function(attr) {
                attr = can.isFunction(attr) ? attr() : attr;
                if (attr && parseInt(attr) < 0) {
                    return "red";
                }
                return null;
            }
        };
    },
    isTimes: function() {
        return this.currentTab == "mini-st-tab";
    },
    isLatestModule: function() {
        return this.options.module == "latest";
    },
    applyConfig: function() {
        var options = this.options;
        var isStarted = this.checkStartTime();
        can.batch.start();
        this.context.attr("lbType", options.type);
        if (options.sponsors) {
            this.context.attr("sponsors", options.sponsors);
        }
        this.template = this.templates[options.module];
        this.context.attr("hasLeaderBoard", isStarted);
        this.context.attr("hasStartingTimes", !!options.miniTeeTimesUrl);
        this.context.attr("name", options.name);
        this.context.attr("fullLBUrl", options.fullLBUrl);
        this.context.attr("fullStartingTimesUrl", options.fullStartingTimesUrl);
        can.batch.stop();
        this.render();
        if (isStarted || this.isLatestModule()) {
            this.dataUrl = options.miniLBUrl;
            this.currentTab = "mini-lb-tab";
        } else {
            if (options.miniTeeTimesUrl && options.miniTeeTimesUrl !== "") {
                this.dataUrl = options.miniTeeTimesUrl;
                this.currentTab = "mini-st-tab";
            } else {
                this.dataUrl = options.miniLBUrl;
                this.currentTab = null;
            }
        }
        this.switchTabs();
        if (this.dataUrl && this.dataUrl !== "") {
            this.getData();
        }
    },
    checkStartTime: function() {
        var now = new Date().valueOf();
        var start = this.options.startDate;
        return now >= start;
    },
    switchTabs: function() {
        var buttons = this.element.find(".mini-tab-btn");
        var tabs = this.element.find(".mini-tab");
        var currentTab = this.element.find("." + this.currentTab);
        var currentBtn = this.element.find("." + this.currentTab + "-btn");
        if (this.currentTab) {
            buttons.removeClass("active");
            tabs.hide();
            currentBtn.addClass("active");
            currentTab.show();
        } else {
            tabs.hide();
        }
    },
    applyInitialContextData: function(data) {
        if (data && (data.event || data.players || data.teams)) {
            var lbData;
            can.batch.start(this.proxy(function() {
                if (!this.updateInitialized) {
                    this.initDataUpdating();
                    this.updateInitialized = true;
                }
            }));
            if (this.checkStartTime() && !this.currentTab) {
                this.dataUrl = this.options.miniLBUrl;
                this.currentTab = "mini-lb-tab";
                this.switchTabs();
            }
            lbData = this.checkData(data);
            this.suspended = lbData.suspended;
            this.context.attr("suspended", lbData.suspended);
            can.batch.stop();
        }
    },
    applyDataChanges: function(data) {
        this.applyInitialContextData(data);
    },
    checkData: function(data) {
        var rawData;
        var tableData = {};
        switch (this.options.type) {
          case "fourball":
            rawData = data.event.tournament;
            break;

          case "state":
            if (data.teams) {
                rawData = data.teams;
            } else if (data.players) {
                rawData = data.players;
            }
            break;

          case "cup":
            rawData = data.event.tournament;
            break;

          case "open":
            rawData = data.players;
            break;

          case "amateur":
            rawData = data.event.tournament;
            break;
        }
        tableData.suspended = this.getPlaySuspended(rawData.playsuspended);
        if (this.isTimes()) {
            this.getTimes(rawData);
        } else {
            this.getItems(rawData);
        }
        return tableData;
    },
    getItems: function(data) {
        var tableType;
        switch (this.options.type) {
          case "fourball":
            if (data.display.phase == "matchplay") {
                this.context.attr("tableType", "match");
                this.context.attr("roundName", data.matchplay.matches.round);
                this.applyContextItems(data.matchplay.matches.match, "match");
            } else if (data.display.phase == "strokeplay") {
                this.context.attr("tableType", "stroke");
                this.context.attr("teeLegend", this.getLegend(data.strokeplay.legends, "tee"));
                this.applyContextItems(data.strokeplay.teams.team, "player");
            }
            break;

          case "amateur":
            if (data.display.phase == "matchplay") {
                this.context.attr("tableType", "match");
            } else if (data.display.phase == "strokeplay") {
                this.context.attr("tableType", "stroke");
                this.applyContextItems(data.strokeplay.players.player, "player");
            }
            break;

          case "cup":
            this.context.attr("tableType", "cup");
            this.applyCupItems(data);
            break;

          case "open":
            this.context.attr("tableType", "stroke");
            this.applyContextItems(data.player, "player");
            break;

          case "state":
            this.context.attr("tableType", "stroke");
            if (data.player) {
                this.applyContextItems(data.player, "player");
            } else if (data.team) {
                this.applyContextItems(data.team, "player");
            }
            break;
        }
    },
    applyContextItems: function(items, itemType) {
        this.context.items.splice(0);
        var itemsPerView;
        if (this.options.module == "latest") {
            itemsPerView = this.latestItemsPerView;
        } else {
            itemsPerView = this.itemsPerView[this.context.tableType];
        }
        var itemsLength = items.length > itemsPerView ? itemsPerView : items.length;
        for (var i = 0; i < itemsLength; i++) {
            var itemData = items[i];
            var item;
            if (itemType == "player") {
                item = new usga.LeaderBoardPlayer(itemData);
            } else if (itemType == "match") {
                item = new usga.LeaderBoardMatch(itemData);
            }
            item.attr("lbType", this.options.type);
            this.context.items.push(item);
        }
    },
    applyCupItems: function(data) {
        var itemsData = data.cupteams;
        this.context.items.splice(0);
        this.context.items.push({
            teamOneName: itemsData.teamOneName,
            teamOnePoints: itemsData.teamOnePoints,
            teamOneAbbr: itemsData.cupteam[0].name,
            teamTwoName: itemsData.teamTwoName,
            teamTwoPoints: itemsData.teamTwoPoints,
            teamTwoAbbr: itemsData.cupteam[1].name
        });
    },
    getTimes: function(data) {
        this.context.attr("timeLegend", this.getLegend(data.strokeplay.legends, "times"));
        var tableType;
        switch (this.options.type) {
          case "fourball":
            if (data.display.phase == "matchplay") {
                this.context.attr("tableType", "match");
                this.context.attr("roundName", data.matchplay.matches.round);
                this.applyContextTimes(data.matchplay.matches.match, "match");
            } else if (data.display.phase == "strokeplay") {
                this.context.attr("tableType", "stroke");
                this.context.attr("teeTimes", this.getLegend(data.strokeplay.legends, "times"));
                this.applyContextTimes(data.strokeplay.players.player, "player");
            }
            break;

          case "amateur":
            if (data.display.phase == "matchplay") {
                this.context.attr("tableType", "match");
            } else if (data.display.phase == "strokeplay") {
                this.context.attr("tableType", "stroke");
                this.applyContextTimes(data.strokeplay.players.player, "player");
            }
            break;

          case "cup":
            this.context.attr("tableType", "cup");
            break;

          case "open":
            this.context.attr("tableType", "stroke");
            this.applyContextTimes(data.player, "player");
            break;

          case "state":
            this.context.attr("tableType", "stroke");
            if (data.player) {
                this.applyContextTimes(data.player, "player");
            } else if (data.team) {
                this.applyContextTimes(data.team, "player");
            }
            break;
        }
    },
    getLegend: function(data, type) {
        if (data && data.legend) {
            var teeData = this.getObjByKeyName(data.legend, "type", type);
            if (teeData) {
                return teeData.text;
            }
        }
        return null;
    },
    applyContextTimes: function(data, itemType) {
        this.context.times.splice(0);
        var itemsPerView = this.itemsPerView.times;
        var itemsLength = data.length > itemsPerView ? itemsPerView : data.length;
        if (itemType == "player") {
            this.createStrokeData(data, itemsLength);
        } else if (itemType == "match") {
            for (var m = 0; m < itemsLength; m++) {
                var match = new usga.LeaderBoardMatch(data[m]);
                match.attr("lbType", this.options.type);
                this.context.times.push(match);
            }
        }
    },
    createStrokeData: function(data, itemsLength) {
        var players = data;
        var currentTime = null;
        var currentTee = null;
        var timeData;
        var output = [];
        var rowLength;
        if (this.context.attr("isFourballChampionship")) {
            rowLength = 2;
        } else {
            rowLength = 3;
        }
        var timeDataPlayersLength;
        for (var i = 0, ii = players.length; i < ii; i++) {
            var player = new usga.LeaderBoardPlayer(players[i]);
            player.attr("lbType", this.options.type);
            var teetime = players[i].teetime;
            var tee = players[i].startingtee;
            if (currentTime != teetime || currentTee != tee) {
                if (timeData) {
                    if (timeData.players.length < rowLength) {
                        timeDataPlayersLength = timeData.players.length;
                        for (var j = 0; j < rowLength - timeDataPlayersLength; j++) {
                            timeData.players.push(null);
                        }
                    }
                }
                timeData = new can.Map({
                    teetime: teetime,
                    startingtee: tee,
                    players: []
                });
                timeData.players.push(player);
                currentTime = teetime;
                currentTee = tee;
                if (output.length < itemsLength) {
                    output.push(timeData);
                }
            } else {
                if (timeData) {
                    if (timeData.players.length >= rowLength) {
                        timeData = new can.Map({
                            teetime: teetime,
                            startingtee: tee,
                            players: []
                        });
                        if (output.length < itemsLength) {
                            output.push(timeData);
                        }
                        timeData.players.push(player);
                    } else {
                        timeData.players.push(player);
                    }
                }
            }
        }
        this.context.attr("times", output);
    },
    ".mini-tab-btn click": function(element, event) {
        event.preventDefault();
        this.currentTab = element.data("target");
        if (this.isTimes()) {
            this.dataUrl = this.options.miniTeeTimesUrl;
        } else {
            this.dataUrl = this.options.miniLBUrl;
        }
        if (this.updateInterval) {
            window.clearInterval(this.updateInterval);
            this.updateInterval = null;
        }
        this.updateInitialized = false;
        this.getData();
        this.switchTabs();
    }
});

usga.LeaderBoardMiniModel = usga.LeaderBoardBaseMap.extend({
    define: {
        items: {
            Type: usga.BaseMap.List,
            Value: usga.BaseMap.List
        },
        times: {
            Type: usga.BaseMap.List,
            Value: usga.BaseMap.List
        },
        tableType: {
            type: "string",
            value: ""
        }
    },
    isStroke: can.compute(function() {
        return this.attr("tableType") == "stroke";
    }),
    isMatch: can.compute(function() {
        return this.attr("tableType") == "match";
    }),
    isCup: can.compute(function() {
        return this.attr("tableType") == "cup";
    })
});

usga.PlayerStatisticsControl = usga.LeaderBoardBaseControl.extend({
    currentTabIndex: 0,
    tabs: null,
    init: function() {
        this._super();
        this.context = new usga.PlayerStatisticsModel();
        this.tabs = [ {
            tab: "drives",
            name: "Driving Distance",
            url: this.options.drivesDataUrl,
            initialized: false,
            template: "#playerStatisticsDrives"
        }, {
            tab: "aces",
            name: "Eagles and Aces",
            url: this.options.acesDataUrl,
            initialized: false,
            template: "#playerStatisticsAces"
        }, {
            tab: "fairways",
            name: "Fairways Hit",
            url: this.options.fairwaysDataUrl,
            initialized: false,
            template: "#playerStatisticsFairways"
        }, {
            tab: "gir",
            name: "Greens in Regulation",
            url: this.options.girDataUrl,
            initialized: false,
            template: "#playerStatisticsGir"
        }, {
            tab: "putts",
            name: "Putts",
            url: this.options.puttsDataUrl,
            initialized: false,
            template: "#playerStatisticsPutts"
        } ];
        this.context.attr("tabs", this.tabs);
        this.render();
        this.initCustomSelect();
    },
    render: function() {
        var renderer = can.view("#playerStatisticsTabs", this.context, this.getHelpers());
        this.element.append(renderer);
        this.showTab(this.currentTabIndex);
    },
    showTab: function(index) {
        this.currentTabIndex = index;
        this.context.attr("currentTab", index);
        var links = this.element.find(".lb-tab-link");
        var currentLink = this.element.find(".lb-tab-link-" + index);
        var tabData = this.tabs[index];
        links.removeClass("active");
        currentLink.addClass("active");
        if (this.statsControl) {
            this.element.find("#tab-table").empty();
            this.statsControl.destroy();
            this.statsControl = null;
        }
        this.statsControl = new usga.PlayerStatisticsTableControl("#tab-table", {
            context: this.context,
            template: tabData.template,
            url: tabData.url,
            attr: tabData.tab
        });
    },
    ".lb-tab-link click": function(element, event) {
        event.preventDefault();
        var tabIndex = element.data("index");
        this.showTab(tabIndex);
    },
    ".link-select change": function(element) {
        var tabIndex = element.val();
        this.showTab(tabIndex);
    }
});

usga.PlayerStatisticsModel = usga.BaseMap.extend({
    define: {
        currentTab: {
            type: "number",
            value: 0
        },
        tabs: {
            Type: usga.BaseMap.List,
            Value: usga.BaseMap.List
        },
        holes: {
            Type: usga.BaseMap,
            Value: usga.BaseMap
        },
        drives: {
            Type: usga.BaseMap,
            Value: usga.BaseMap
        },
        aces: {
            Type: usga.BaseMap,
            Value: usga.BaseMap
        },
        fairways: {
            Type: usga.BaseMap,
            Value: usga.BaseMap
        },
        gir: {
            Type: usga.BaseMap,
            Value: usga.BaseMap
        },
        putts: {
            Type: usga.BaseMap,
            Value: usga.BaseMap
        }
    },
    showHoles: can.compute(function() {
        return this.attr("currentTab") === 0;
    })
});

usga.PlayerStatisticsPlayerControl = usga.BaseModule.extend({
    init: function() {
        this._super();
        this.context = this.options.context;
        this.template = this.options.template;
        this.render();
    },
    render: function() {
        this.context.attr("screenSize", this.getScreenSize());
        var renderer = can.view(this.template, this.context, this.getHelpers());
        this.element.append(renderer);
    },
    getHelpers: function() {
        return {};
    },
    "{context} change": function(map, evt, attr, how, newValue) {
        this.element.data(attr, newValue);
    },
    onLayout: function() {
        this.context.attr("screenSize", this.getScreenSize());
    }
});

usga.PlayerStatisticsPlayer = usga.LeaderBoardBaseMap.extend({
    define: {
        name: {
            type: "string",
            value: ""
        },
        round: {
            type: "*",
            value: null
        },
        rank: {
            type: "*",
            value: null
        }
    },
    displayName: can.compute(function() {
        var name = this.attr("name");
        var amateurRegExp = /\(a\)$/gi;
        if (name !== "") {
            name = name.split(",");
            var firstName = name[1] ? name[1].replace(/^\s/, "") : "";
            var lastName = name[0] ? name[0].replace(/^\s/, "") : "";
            if (amateurRegExp.test(name)) {
                firstName = firstName.replace(amateurRegExp, "");
                lastName = lastName.replace(amateurRegExp, "");
                return firstName + " " + can.capitalize(lastName.toLowerCase()) + " (a)";
            } else {
                return firstName + " " + can.capitalize(lastName.toLowerCase());
            }
        }
        return null;
    }),
    shortName: can.compute(function() {
        var name = this.attr("name");
        var displayName = this.attr("displayName");
        var firtsName = this.attr("firstname");
        var lastName = this.attr("lastname");
        var shortName;
        if (/[A-z-\.\s]*\/[A-z-\.\s]*/.test(name)) {
            shortName = name.replace(/([A-Z]{1})[a-z]*(\s[A-z\.]*)(\s?\/\s?)([A-Z]{1})[a-z]*(\s[A-z\.]*)/, "$1.$2$3<br>$4.$5");
        } else {
            shortName = displayName.replace(/([A-Z]{1})[a-z]*(\s[A-z\.]*)/, "$1.$2");
        }
        return shortName;
    }),
    idField: can.compute(function() {
        if (this.attr("idint")) {
            return "player" + this.attr("idint");
        } else {
            return this.attr("name").replace(/\s/gi, "").replace(/\./gi, "").replace(/,/, "");
        }
    })
});

usga.PlayerStatisticsTableControl = usga.LeaderBoardBaseControl.extend({
    initialized: false,
    defaultSortAttr: "rank",
    currentSortAttr: "rank",
    chunkSize: 15,
    init: function() {
        this._super();
        this.context = this.options.context;
        this.dataAttr = this.options.attr;
        this.template = this.options.template;
        if (this.dataAttr == "aces") {
            this.defaultSortAttr = "round";
            this.currentSortAttr = "round";
            this.defaultSortDirection = "desc";
            this.currentSortDirection = "desc";
        }
        this.render();
    },
    render: function() {
        var renderer = can.view(this.template, this.context, this.getHelpers());
        this.element.append(renderer);
        this.dataUrl = this.options.url;
        this.getData();
    },
    applyInitialContextData: function(data) {
        if (this.dataAttr == "drives") {
            this.options.context.attr("holes", data.event.tournament.holes);
        }
        var players = this.getPlayersData(data);
        if (players) {
            this.applyPartialData(players, 0, this.chunkSize, this.proxy(this.createPlayers));
        }
    },
    createPlayers: function(players) {
        for (var i = 0, ii = players.length; i < ii; i++) {
            var player = new usga.PlayerStatisticsPlayer(players[i]);
            var playerId = player.attr("idField");
            this.createPlayerElement(player, "statistics-row", "player-row", playerId);
            this.context[this.dataAttr].attr(playerId, player);
        }
        if (this.currentSortAttr !== this.defaultSortAttr || this.currentSortDirection !== this.defaultSortDirection) {
            this.sortTables(this.currentSortAttr, this.currentSortDirection, this.currentSortType);
        }
    },
    createPlayerElement: function(playerData, elementClass, playerClass, elementId) {
        var tbody = $('<tbody data-search="displayName" class="' + elementClass + " " + playerClass + '" id="' + elementId + '"></tbody>');
        for (var attr in playerData) {
            if (playerData.hasOwnProperty(attr)) {
                tbody.data(attr, playerData.attr(attr));
            }
        }
        if (this.element) {
            this.element.find("." + elementClass).last().after(tbody);
            var playerControl = new usga.PlayerStatisticsPlayerControl("#" + elementId, {
                context: playerData,
                template: this.template + "Player"
            });
        }
    },
    applyDataChanges: function(data) {
        this.changedData = this.getPlayersData(data);
        if (this.currentSortAttr !== this.defaultSortAttr || this.currentSortDirection !== this.defaultSortDirection) {
            this.sortList(this.changedData, this.currentSortAttr, this.currentSortDirection, this.currentSortType);
        }
        this.compareData();
    },
    compareData: function() {
        this.hasChanges = false;
        can.batch.start(this.proxy(function() {
            if (this.hasChanges) {
                this.sortTables(this.currentSortAttr, this.currentSortDirection, this.currentSortType);
            }
        }));
        var players = this.context.attr(this.dataAttr);
        for (var i = 0, ii = this.changedData.length; i < ii; i++) {
            var changedPlayer = this.changedData[i];
            var changedPlayerId = changedPlayer.idint ? "player" + changedPlayer.idint : changedPlayer.name.replace(/\s/gi, "").replace(/\./gi, "").replace(/,/, "");
            var player = players.attr(changedPlayerId);
            if (this.hasChanges === false) {
                this.hasChanges = this.compareAndSetAttr(changedPlayer, player, player);
            } else {
                this.compareAndSetAttr(changedPlayer, player, player);
            }
        }
        can.batch.stop();
    },
    getPlayersData: function(data) {
        var tournament = data.event.tournament;
        var players;
        if (this.dataAttr == "aces") {
            players = tournament.highlight;
        } else {
            players = tournament.players.player;
        }
        return players;
    },
    sortTables: function(attr, direction, type) {
        this.sortDomElements(attr, direction, type, "player-row", "statistics-row");
    },
    ".sort-table click": function(element, event) {
        event.preventDefault();
        can.batch.start();
        var headers = this.element.find(".sort-table");
        this.setSortType(element, element.data("attr"), element.data("type"), this.changedData, headers);
        can.batch.stop();
    }
});

usga.LeaderboardPlayoffControl = usga.LeaderBoardBaseControl.extend({
    slidesMinLength: 3,
    slideTdLength: 6,
    minHolesLength: 18,
    currentOptions: {
        controls: false,
        infiniteLoop: false,
        minSlides: 1,
        maxSlides: 1,
        slideMargin: 0,
        adaptiveHeight: true,
        touchEnabled: usga.supports.touch
    },
    init: function() {
        this._super();
        this.context = new usga.LeaderboardPlayoffModel();
        this.context.attr("lbType", this.options.lbType);
        this.render();
        this.dataUrl = this.options.dataUrl;
        this.getData();
    },
    render: function() {
        var renderer = can.view("#playOffTable", this.context, this.getHelpers());
        this.element.append(renderer);
    },
    getHelpers: function() {
        return {
            getStatus: function(status) {
                status = can.isFunction(status) ? status() : status;
                if (status) {
                    status = status.toLowerCase();
                    if (status == "winner" || status == "qualified") {
                        return "winner";
                    } else if (status == "eliminated" || status == "failed to qualify") {
                        return "eliminated";
                    }
                }
                return "";
            },
            renderShortName: function(player) {
                player = can.isFunction(player) ? player() : player;
                var nameParts;
                var firstName = "";
                var lastName = "";
                if (player) {
                    nameParts = player.split(" ");
                    lastName = nameParts[nameParts.length - 1];
                    for (var i = 0, ii = nameParts.length - 1; i < ii; i++) {
                        var namePart = nameParts[i];
                        namePart = namePart.charAt(0) + ".";
                        firstName = firstName + namePart;
                    }
                }
                return firstName + " " + lastName;
            }
        };
    },
    handleError: function(xhr) {
        this.getData();
    },
    applyInitialContextData: function(data) {
        this.createPlayOffData(data);
        this.initDataUpdating();
    },
    applyDataChanges: function(data) {
        this.createPlayOffData(data);
    },
    createPlayOffData: function(data) {
        if (data && data.event) {
            var tournament = data.event.tournament;
            if (tournament && (tournament.display == "True" || tournament.display == "true")) {
                this.element.show();
                can.batch.start();
                this.createPlayersData(data.event.tournament);
                this.createRoundsData(data.event.tournament);
                can.batch.stop();
                this.updateSlider();
            } else {
                this.element.hide();
            }
        } else {
            this.element.hide();
        }
    },
    createPlayersData: function(data) {
        this.context.attr("legends", this.getLegends(data.legends));
        if (this.context.attr("isFourballChampionship")) {
            this.context.attr("playoffPlayers", data.teams.team);
        } else {}
    },
    createRoundsData: function(data) {
        var courseHoles = this.dataToArray(data.course.hole);
        this.context.holesData.splice(0);
        this.context.attr("courseHoles", courseHoles);
        var players = this.context.attr("playoffPlayers");
        if (courseHoles.length > this.minHolesLength) {
            this.slidesMinLength = Math.ceil(courseHoles.length / this.slideTdLength);
        }
        var currentHoleIndex = 0;
        for (var s = 0; s < this.slidesMinLength; s++) {
            var slide = {
                holeNumbers: [],
                holePar: [],
                holeYards: [],
                playersScores: []
            };
            for (var h = 0; h < this.slideTdLength; h++) {
                var hole = courseHoles[currentHoleIndex];
                if (hole) {
                    slide.holeNumbers.push(hole.coursehole);
                    slide.holePar.push(hole.par);
                    slide.holeYards.push(hole.yard);
                } else {
                    slide.holeNumbers.push("--");
                    slide.holePar.push("--");
                    slide.holeYards.push("--");
                }
                currentHoleIndex++;
            }
            for (var p = 0, pp = players.length; p < pp; p++) {
                var player = players[p];
                var slideScoreData = [];
                var scoreData;
                if (player.attr("score") instanceof can.Map && !player.score.attr("length")) {
                    scoreData = player.attr("score");
                    player.attr("score", new can.List());
                    player.score.push(scoreData);
                }
                for (var i = 0; i < this.slideTdLength; i++) {
                    var scoreIndex = s === 0 ? i : i + s * this.slideTdLength;
                    var score = player.score.attr(scoreIndex);
                    if (score) {
                        if (!score.strokes || score.strokes === "") {
                            score.attr("strokes", "--");
                        }
                    } else {
                        player.score.attr(scoreIndex, {
                            strokes: "--"
                        });
                    }
                    slideScoreData.push(player.score.attr(scoreIndex));
                }
                slide.playersScores.push(slideScoreData);
            }
            this.context.holesData.push(slide);
        }
    },
    initSlider: function(options) {
        var sliderElement = this.$element.find(".playoff-slider");
        if (sliderElement.length) {
            this.slider = sliderElement.bxSlider(options);
        }
    },
    updateSlider: function() {
        if (this.isBigScreen() || this.isBiggerScreen() || this.isInfinityScreen()) {
            this.currentOptions.minSlides = 3;
            this.currentOptions.maxSlides = 3;
            this.currentOptions.slideWidth = can.$(".playoff-slider-wrap").width() / 3;
        } else if (!this.isBigScreen() && !this.isBiggerScreen() && !this.isInfinityScreen()) {
            this.currentOptions.minSlides = 1;
            this.currentOptions.maxSlides = 1;
            this.currentOptions.slideWidth = 0;
        }
        if (this.slider) {
            this.slider.reloadSlider(this.currentOptions);
        } else {
            this.initSlider(this.currentOptions);
        }
    },
    onWindowResize: function() {
        if (this.slider) {
            if (this.sliderUpdateTimeout) {
                window.clearTimeout(this.sliderUpdateTimeout);
                this.sliderUpdateTimeout = null;
            }
            this.sliderUpdateTimeout = window.setTimeout(this.proxy(function() {
                this.updateSlider();
            }), 50);
        }
    }
});

usga.LeaderboardPlayoffModel = usga.LeaderBoardBaseModel.extend({
    define: {
        playoffPlayers: {
            Type: usga.BaseMap.List,
            Value: usga.BaseMap.List
        },
        totalData: {
            Type: usga.BaseMap.List,
            Value: usga.BaseMap.List
        },
        holesData: {
            Type: usga.BaseMap.List,
            Value: usga.BaseMap.List
        },
        courseHoles: {
            Type: usga.BaseMap.List,
            Value: usga.BaseMap.List
        }
    }
});

usga.StartingTimesMatchControl = usga.LeaderBoardBaseControl.extend({
    initialized: false,
    defaultSortAttr: "teetime",
    currentSortAttr: "teetime",
    chunkSize: 15,
    init: function() {
        this._super();
        this.context = new usga.StartingTimesModel();
        this.context.attr("tabControl", this.options.tabControl);
        this.context.attr("lbType", this.options.lbType);
        this.render();
    },
    render: function() {
        var renderer = can.view("#startingTimesMatch", this.context, this.getHelpers());
        this.element.append(renderer);
        this.dataUrl = this.options.dataUrl;
        this.getData();
    },
    getHelpers: function() {
        var context = this.context;
        return {
            getFlag: function(player) {
                player = can.isFunction(player) ? player() : player;
                var flag = null;
                return flag;
            },
            renderSearchData: function(data) {
                data = can.isFunction(data) ? data() : data;
                var result = "";
                var players;
                var teams;
                if (context.attr("isFourballChampionship")) {
                    teams = data.attr("team");
                    result += teams[0].player.attr("teamName") + " " + teams[1].player.attr("teamName");
                } else {
                    players = data.players;
                    for (var i = 0, ii = players.length; i < ii; i++) {
                        var player = players[i];
                        if (player) {
                            result += player.attr("displayName") + " ";
                        }
                    }
                }
                return result;
            }
        };
    },
    applyInitialContextData: function(data) {
        var tournament = data.event.tournament;
        if (tournament) {
            can.batch.start();
            this.context.attr("tableLegend", this.getLegends(tournament.legends));
            can.batch.stop();
            this.createMatchData(tournament);
        }
    },
    applyDataChanges: function(data) {},
    createMatchData: function(data) {
        var matches = data.matches.match;
        if (can.isArray(matches)) {
            for (var i = 0, ii = matches.length; i < ii; i++) {
                var match = new usga.LeaderBoardMatch(matches[i]);
                match.attr("lbType", this.options.lbType);
                this.context.matches.push(match);
            }
        } else {
            this.context.matches.push(matches);
        }
    },
    sortTables: function(attr, direction, type) {
        this.sortDomElements(attr, direction, type, "sortable-row", "starting-times-row");
    },
    ".sort-table click": function(element, event) {
        event.preventDefault();
        can.batch.start();
        var headers = this.element.find(".sort-table");
        this.setSortType(element, element.data("attr"), element.data("type"), null, headers);
        can.batch.stop();
    }
});

usga.StartingTimesModel = usga.LeaderBoardBaseMap.extend({
    define: {
        tableLegend: {
            type: "*",
            value: null
        },
        lbType: {
            type: "*",
            value: null
        },
        currentTab: {
            type: "number",
            value: 0
        },
        tabcontrol: {
            Type: usga.BaseMap,
            Value: usga.BaseMap
        },
        times: {
            Type: usga.BaseMap.List,
            Value: usga.BaseMap.List
        },
        matches: {
            Type: usga.LeaderBoardMatch.List,
            Value: usga.LeaderBoardMatch.List
        }
    }
});

usga.StartingTimesStrokeControl = usga.LeaderBoardBaseControl.extend({
    initialized: false,
    defaultSortAttr: "teetime",
    currentSortAttr: "teetime",
    chunkSize: 15,
    init: function() {
        this._super();
        this.context = new usga.StartingTimesModel();
        this.context.attr("tabControl", this.options.tabControl);
        this.context.attr("lbType", this.options.lbType);
        this.render();
    },
    render: function() {
        var renderer = can.view("#startingTimesStroke", this.context, this.getHelpers());
        this.element.append(renderer);
        this.dataUrl = this.options.dataUrl;
        this.getData();
    },
    getHelpers: function() {
        var context = this.context;
        return {
            getFlag: function(player) {
                player = can.isFunction(player) ? player() : player;
                var flag = null;
                if (player) {
                    if (player.attr("ctyCode")) {
                        flag = "flag " + player.attr("ctyCode").toUpperCase();
                        if (context.attr("isTeamEvent")) {
                            flag = "flag state " + player.attr("ctyCode").toUpperCase().replace(/([A-z]*)\s([A-z]*)/, "$1-$2");
                        }
                    } else {
                        flag = "flag " + player.attr("country").toUpperCase();
                    }
                }
                return flag;
            },
            renderSearchData: function(data) {
                data = can.isFunction(data) ? data() : data;
                var players = data.players;
                var result = "";
                for (var i = 0, ii = players.length; i < ii; i++) {
                    var player = players[i];
                    if (player) {
                        if (context.attr("isFourballChampionship")) {
                            result += player.attr("teamName") + " ";
                        } else {
                            result += player.attr("displayName");
                        }
                    }
                }
                return result;
            }
        };
    },
    applyInitialContextData: function(data) {
        var tournament = data.event.tournament;
        if (tournament) {
            can.batch.start(this.proxy(function() {
                this.sortDomElements("teetime", "asc", "time", "sortable-row", "starting-times-row");
            }));
            this.context.attr("tableLegend", this.getLegends(tournament.legends));
            this.createStrokeData(tournament);
            can.batch.stop();
        }
    },
    applyDataChanges: function(data) {},
    createStrokeData: function(data) {
        var currentTime = null;
        var currentTee = null;
        var currentCoursecode;
        var timeData;
        var output = [];
        var rowLength;
        var players;
        if (this.context.attr("isFourballChampionship")) {
            rowLength = 2;
            players = this.createTeamsData(data.players.player);
        } else {
            rowLength = 3;
            players = data.players.player;
        }
        var timeDataPlayersLength;
        for (var i = 0, ii = players.length; i < ii; i++) {
            var player = new usga.LeaderBoardPlayer(players[i]);
            player.attr("lbType", this.options.lbType);
            var teetime = players[i].teetime;
            var tee = players[i].startingtee;
            var coursecode = players[i].coursecode;
            if (currentTime != teetime || currentTee != tee || currentCoursecode != coursecode) {
                if (timeData) {
                    if (timeData.players.length < rowLength) {
                        timeDataPlayersLength = timeData.players.length;
                        for (var j = 0; j < rowLength - timeDataPlayersLength; j++) {
                            timeData.players.push(null);
                        }
                    }
                }
                timeData = new can.Map({
                    teetime: teetime,
                    startingtee: tee,
                    coursecode: coursecode,
                    players: []
                });
                timeData.players.push(player);
                currentTime = teetime;
                currentTee = tee;
                currentCoursecode = coursecode;
                output.push(timeData);
            } else {
                if (timeData) {
                    if (timeData.players.length >= rowLength) {
                        timeData = new can.Map({
                            teetime: teetime,
                            startingtee: tee,
                            coursecode: coursecode,
                            players: []
                        });
                        output.push(timeData);
                        timeData.players.push(player);
                    } else {
                        timeData.players.push(player);
                    }
                }
            }
        }
        this.context.attr("times", output);
    },
    createTeamsData: function(data) {
        var teamsData = [];
        var teamsIds = this.getUniqueTeamsIds(data);
        for (var i = 0, ii = teamsIds.length; i < ii; i++) {
            var teamId = teamsIds[i];
            var teamPlayers = this.getItemsByKeyValue(data, "teamID", teamId);
            var firstPlayer, secondPlayer;
            if (teamPlayers && teamPlayers.length > 1) {
                firstPlayer = teamPlayers[0];
                secondPlayer = teamPlayers[1];
                firstPlayer.name = firstPlayer.name + " / " + secondPlayer.name;
                teamsData.push(firstPlayer);
            }
        }
        return teamsData;
    },
    getUniqueTeamsIds: function(data) {
        var teamsIds = [];
        for (var i = 0, ii = data.length; i < ii; i++) {
            var player = data[i];
            var teamId = player.teamID;
            if (teamsIds.indexOf(teamId) == -1) {
                teamsIds.push(teamId);
            }
        }
        return teamsIds;
    },
    sortTables: function(attr, direction, type) {
        this.sortDomElements(attr, direction, type, "sortable-row", "starting-times-row");
    },
    ".sort-table click": function(element, event) {
        event.preventDefault();
        can.batch.start();
        var headers = this.element.find(".sort-table");
        this.setSortType(element, element.data("attr"), element.data("type"), null, headers);
        can.batch.stop();
    }
});

usga.LeaderBoardStateTeamStrokeControl = usga.LeaderBoardBaseControl.extend({
    defaultSortAttr: "pos",
    currentSortAttr: "pos",
    chunkSize: 5,
    init: function() {
        this._super();
        this.context = new usga.LeaderBoardBaseModel();
        this.render();
        this.dataUrl = this.options.dataUrl;
        this.getData();
    },
    render: function() {
        var renderer = can.view("#leaderBoardStateTeamStroke", this.context, this.getHelpers());
        this.element.addClass("leaderboard-state-team-stroke");
        this.element.append(renderer);
    },
    applyInitialContextData: function(data) {
        var tournament = data.event.tournament;
        if (tournament) {
            can.batch.start();
            this.context.attr("tableLegend", this.getLegends(tournament.legends));
            this.context.attr("courseData", tournament.course);
            this.context.attr("roundData", tournament.tabcontrol.round);
            this.context.attr("currentRound", tournament.currentround);
            this.context.attr("lbType", this.options.lbType);
            this.context.attr("suspended", this.getPlaySuspended(tournament.playsuspended));
            var teams = tournament.teams.team;
            can.batch.stop();
            this.applyPartialData(teams, 0, this.chunkSize, this.proxy(this.createTeamsControls));
        }
    },
    createTeamsControls: function(teams) {
        for (var i = 0, ii = teams.length; i < ii; i++) {
            var team = new usga.LeaderBoardTeam(teams[i]);
            var teamId = team.attr("idField");
            team.attr("currentRound", this.context.currentRound);
            team.attr("courseData", this.context.courseData);
            team.attr("roundData", this.context.roundData);
            team.attr("lbType", this.options.lbType);
            this.createTeamElement(team, "full-leader-board", "team-row", teamId);
            this.context.teamsData.attr(teamId, team);
        }
        if (this.currentSortAttr !== this.defaultSortAttr || this.currentSortDirection !== this.defaultSortDirection) {
            this.sortTables(this.currentSortAttr, this.currentSortDirection, this.currentSortType);
        }
    },
    createTeamElement: function(teamData, elementClass, teamClass, elementId, isFavorite) {
        var tbody = $('<tbody data-search="' + teamData.state + '" class="' + elementClass + " " + teamClass + '" id="' + elementId + '"></tbody>');
        if (isFavorite) {
            tbody.data("favorite", "true");
        }
        for (var attr in teamData) {
            if (teamData.hasOwnProperty(attr) && attr != "players") {
                tbody.data(attr, teamData[attr]);
            }
        }
        if (this.element) {
            this.element.find("." + elementClass).last().after(tbody);
            var teamControl = new usga.LeaderBoardTeamControl("#" + elementId, {
                context: teamData
            });
        }
    },
    applyDataChanges: function(data) {
        this.context.attr("suspended", this.getPlaySuspended(data.event.tournament.playsuspended));
        this.changedData = data.event.tournament.teams.team;
        if (this.currentSortAttr !== this.defaultSortAttr || this.currentSortDirection !== this.defaultSortDirection) {
            this.sortList(this.changedData, this.currentSortAttr, this.currentSortDirection, this.currentSortType);
        }
        this.compareData();
    },
    compareData: function() {
        this.hasChanges = false;
        can.batch.start(this.proxy(function() {
            if (this.hasChanges) {
                this.sortTables(this.currentSortAttr, this.currentSortDirection, this.currentSortType);
            }
        }));
        for (var i = 0, ii = this.changedData.length; i < ii; i++) {
            var changedTeam = this.changedData[i];
            var changedTeamId = changedTeam.idint ? "team" + changedTeam.idint : changedTeam.state.replace(/\s/gi, "");
            var team = this.context.teamsData.attr(changedTeamId);
            if (this.hasChanges === false) {
                this.hasChanges = this.compareAndSetAttr(changedTeam, team, team);
            } else {
                this.compareAndSetAttr(changedTeam, team, team);
            }
        }
        can.batch.stop();
    },
    sortTables: function(attr, direction, type) {
        this.sortDomElements(attr, direction, type, "team-row", "full-leader-board");
        var favorites = this.element.find(".my-team-row");
        if (favorites.length) {
            this.sortDomElements(attr, direction, type, "my-team-row", "my-leader-board");
        }
    },
    addToFavorites: function(element) {
        var teamData = element.closest("tr").data("team");
        var teamId = "my" + teamData.attr("idField");
        teamData.attr("selected", true);
        this.createTeamElement(teamData, "my-leader-board", "my-team-row", teamId, true);
        this.sortDomElements(this.currentSortAttr, this.currentSortDirection, this.currentSortType, "my-team-row", "my-leader-board");
        this.showTitles();
        this.saveToStorage(this.context.attr("lbType") + "." + teamData.attr("idField"), true);
    },
    removeFromFavorites: function(element) {
        var teamData = element.closest("tr").data("team");
        var teamId = teamData.attr("idField");
        teamData.attr("selected", false);
        var teamElement = element.closest("tbody");
        var isFavorite = teamElement.data("favorite");
        if (isFavorite) {
            teamElement.remove();
        } else {
            this.element.find("#my" + teamId).remove();
        }
        var favorites = this.element.find(".my-leader-board");
        if (favorites.length <= 1) {
            this.hideTitles();
        }
        this.removeFromStorage(this.context.attr("lbType") + "." + teamData.attr("idField"));
    },
    showTitles: function() {
        this.element.find("#myLeaderBoardTitle").show();
    },
    hideTitles: function() {
        this.element.find("#myLeaderBoardTitle").hide();
    },
    ".sort-table click": function(element, event) {
        event.preventDefault();
        can.batch.start();
        var headers = this.element.find(".sort-table");
        this.setSortType(element, element.data("attr"), element.data("type"), this.changedData, headers);
        can.batch.stop();
    },
    ".favorite click": function(element, event) {
        event.preventDefault();
        if (!element.hasClass("inactive")) {
            if (element.hasClass("add")) {
                this.addToFavorites(element);
            } else {
                this.removeFromFavorites(element);
            }
        }
    },
    ".leader-board-player click": function(element) {
        this.element.find(".attached-drawer").remove();
        var playerModel = element.data("player");
        this.createScorecardDrawer(element, playerModel);
    },
    ".close-drawer click": function() {
        this.element.find(".attached-drawer").remove();
    }
});

usga.LeaderBoardBracketsControl = usga.LeaderBoardBaseControl.extend({
    templates: {
        fourball: "#leaderBoardBrackets32",
        amateur: ""
    },
    init: function() {
        this._super();
        this.context = new usga.LeaderBoardBracketsModel();
        this.dataUrl = this.options.dataUrl;
        this.context.attr("lbType", this.options.lbType);
        this.render();
    },
    render: function() {
        var renderer = can.view(this.templates[this.options.lbType], this.context, this.getHelpers());
        this.element.html(renderer);
        this.getData();
    },
    getHelpers: function() {
        return {
            formatDate: function(date) {
                date = can.isFunction(date) ? date() : date;
                if (date) {
                    return window.moment(date).format("dddd, MMMM D");
                }
            },
            renderNumber: function(index) {
                index = can.isFunction(index) ? index() : index;
                if (index) {
                    return index + 1;
                }
            },
            splitNames: function(name, index) {
                name = can.isFunction(name) ? name() : name;
                var names = name.split("/");
                if (names[index]) {
                    return names[index].replace(/([A-z\.-]*)\,\s*([A-z\.-]*)/, "$2 $1");
                }
                return index === 0 ? name : null;
            },
            renderLeader: function(match, attr) {
                match = can.isFunction(match) ? match() : match;
                var output = {
                    status: "",
                    standing: "",
                    leaderClass: ""
                };
                var standing, status;
                var statusData = match.attr("status");
                var teeTime = match.attr("teetime");
                var standingData = match.attr("standing");
                var leader = match.attr("leader");
                var standingParts = [];
                if (standingData) {
                    standingParts = standingData.split(/thru/i);
                    standing = standingParts[0];
                    status = standingParts[1] ? "thru" + standingParts[1] : "";
                }
                if (statusData == "notstarted") {
                    output.standing = teeTime;
                } else if (statusData == "completed") {} else {
                    output.status = status;
                    if (leader == 1) {
                        output.leaderClass = "leader-up";
                        output.standing = standing;
                    } else if (leader == 2) {
                        output.leaderClass = "leader-down";
                        output.standing = standing;
                    } else {
                        output.standing = "All Square";
                        output.leaderClass = "";
                    }
                }
                return output[attr];
            },
            getPreviousRoundStanding: function(playerNum, roundIndex, rounds) {
                playerNum = can.isFunction(playerNum) ? playerNum() : playerNum;
                roundIndex = can.isFunction(roundIndex) ? roundIndex() : roundIndex;
                rounds = can.isFunction(rounds) ? rounds() : rounds;
                var roundsLength = rounds.attr("length");
                var round, matches;
                if (roundsLength > 0) {
                    round = rounds.attr(roundIndex - 1);
                    matches = round.attr("match");
                    for (var i = 0, ii = matches.length; i < ii; i++) {
                        var match = matches[i];
                        var playerOneNumber = match.team.attr(0).attr("player.number");
                        var playerTwoNumber = match.team.attr(1).attr("player.number");
                        if (playerOneNumber == playerNum || playerTwoNumber == playerNum) {
                            return match.attr("standing");
                        }
                    }
                }
                return null;
            },
            getTeamsLength: function(round) {
                round = can.isFunction(round) ? round() : round;
                return round.match.attr("length") * 2;
            },
            notFirstRound: function(index, options) {
                index = can.isFunction(index) ? index() : index;
                this.attr("roundIndex", index);
                if (index > 0) {
                    return options.fn(this);
                }
                return options.inverse(this);
            },
            getFinalIndex: function(rounds) {
                rounds = can.isFunction(rounds) ? rounds() : rounds;
                if (rounds.attr("length")) {
                    return rounds.attr("length");
                }
            }
        };
    },
    applyInitialContextData: function(data) {
        var tournament = data.event.tournament;
        if (tournament) {
            can.batch.start();
            this.context.attr("columns", tournament.columns.column);
            var rounds = tournament.rounds.round;
            this.context.attr("champion", this.getChampion(rounds));
            for (var i = 0, ii = rounds.length; i < ii; i++) {
                var round = new usga.LeaderBoardBracketsRoundModel(rounds[i]);
                round.attr("lbType", this.options.lbType);
                this.context.rounds.push(round);
            }
            can.batch.stop();
            this.initDataUpdating();
            this.switchRounds(0);
        }
    },
    applyDataChanges: function(data) {
        var tournament = data.event.tournament;
        if (tournament) {
            can.batch.start();
            this.context.attr("champion", this.getChampion(tournament.rounds.round));
            var changedData = this.roundMatchToArray(tournament.rounds.round);
            var rounds = this.context.attr("rounds");
            this.compareAndSetAttr(changedData, rounds, rounds);
            can.batch.stop();
        }
    },
    getChampion: function(roundsModel) {
        var lastRoundIndex = roundsModel.length - 1;
        var round = roundsModel[lastRoundIndex];
        var player;
        if (round) {
            var match = round.match;
            var teams = match.team;
            for (var i = 0, ii = teams.length; i < ii; i++) {
                var team = teams[i];
                if (team.number == match.leader) {
                    player = team.player;
                    player.roundIndex = lastRoundIndex + 1;
                    return player;
                }
            }
        }
        return player;
    },
    roundMatchToArray: function(rounds) {
        for (var i = 0, ii = rounds.length; i < ii; i++) {
            var round = rounds[i];
            var matchObject;
            if (!can.isArray(round.match)) {
                matchObject = round.match;
                round.match = [];
                round.match.push(matchObject);
            }
        }
        return rounds;
    },
    handleError: function() {
        this.getData();
    },
    switchRounds: function(index) {
        var buttons = this.element.find(".round-switcher");
        var currentButton = this.element.find(".round-switcher" + index);
        var bracketKeys = this.element.find(".bracket-key-round");
        var currentBracketKey = this.element.find(".bracket-key" + index);
        var bracketPagination = this.element.find(".brackets__pagination__item");
        var currentBracketPage = this.element.find(".bracket-pagination-item" + index);
        var bracketSection = this.element.find(".section");
        var currentLeftSection = this.element.find(".bracket-section" + index);
        var currentRightSection = this.element.find(".bracket-section" + (index + 1));
        buttons.removeClass("active");
        currentButton.addClass("active");
        bracketKeys.removeClass("active");
        currentBracketKey.addClass("active");
        bracketPagination.removeClass("active");
        currentBracketPage.addClass("active");
        bracketSection.removeClass("mobile-right").removeClass("mobile-left");
        currentLeftSection.addClass("mobile-left");
        currentRightSection.addClass("mobile-right");
    },
    ".brackets__sections__item click": function(element, event) {
        event.preventDefault();
        var index = element.data("index");
        this.switchRounds(index);
    },
    ".brackets__pagination__item click": function(element, event) {
        event.preventDefault();
        var index = element.data("index");
        this.switchRounds(index);
    },
    ".brackets__sections__item touchend": function(element, event) {
        event.preventDefault();
        var index = element.data("index");
        this.switchRounds(index);
    },
    ".brackets__pagination__item touchend": function(element, event) {
        event.preventDefault();
        var index = element.data("index");
        this.switchRounds(index);
    }
});

usga.LeaderBoardBracketsRoundModel = usga.LeaderBoardBaseModel.extend({
    define: {
        name: {
            type: "string",
            value: ""
        },
        match: {
            Type: usga.LeaderBoardMatch.List,
            Value: usga.LeaderBoardMatch.List
        }
    }
});

usga.LeaderBoardBracketsModel = usga.BaseMap.extend({
    define: {
        rounds: {
            Type: usga.LeaderBoardBracketsRoundModel.List,
            Value: usga.LeaderBoardBracketsRoundModel.List
        },
        columns: {
            Type: usga.BaseMap.List,
            Value: usga.BaseMap.List
        }
    }
});

usga.LeaderBoardBaseTabsControl = usga.LeaderBoardBaseControl.extend({
    currentTab: 0,
    currentControl: null,
    currentLbData: null,
    currentType: null,
    currentElement: null,
    tabControl: null,
    init: function() {
        this._super();
        this.setupData(this.options);
    },
    render: function() {
        var renderer = can.view("#leaderBoardMainControl", this.context, this.getHelpers());
        this.element.html(renderer);
        if (this.options.tabControlUrl) {
            this.getTabsData();
        } else {
            this.applyUrls(this.currentType);
            this.showLeaderBoard();
            this.initCustomSelect();
        }
    },
    setupData: function(data) {},
    getTabsData: function() {
        can.ajax({
            type: "GET",
            url: this.options.tabControlUrl,
            headers: {
                "Content-Type": "application/json"
            },
            success: this.proxy(function(data) {
                this.applyTabsData(data);
            }),
            error: this.proxy(function(xhr) {
                console.log(xhr);
            })
        });
    },
    applyTabsData: function(data) {
        var tabTextRegexp = /match\s*play\s*\-\s*/i;
        var matchPlayRegexp = /match/i;
        var strokePlayRegexp = /stroke/i;
        for (var i = 0, ii = this.tabControl.length; i < ii; i++) {
            var lbTabData;
            var tab = this.tabControl[i];
            var tabText = tab.type.toLowerCase().replace(tabTextRegexp, "");
            var tabName = tabText.replace(/\s/gi, "");
            var isStroke = strokePlayRegexp.test(tab.type);
            var isMatch = matchPlayRegexp.test(tab.type);
            var lbData = {
                name: tabName,
                text: tabText,
                altText: tabText.replace(/round/i, "RD").replace(/finals/i, "final").replace(/\s-\s/, "-")
            };
            if (tab.active.toLowerCase() == "true") {
                lbData.display = true;
            }
            if (tab.default.toLowerCase() == "true") {
                this.currentTab = i;
                lbData.selected = true;
            }
            if (isStroke) {
                lbTabData = {
                    container: this.currentLbData.strokeContainer + i,
                    name: this.currentLbData.strokeName + i,
                    lbType: this.currentLbData.strokeLbType,
                    control: this.currentLbData.strokeControl,
                    tableType: "stroke"
                };
            } else if (isMatch) {
                lbTabData = {
                    container: this.currentLbData.matchContainer + i,
                    name: this.currentLbData.matchName + i,
                    lbType: this.currentLbData.matchLbType,
                    control: this.currentLbData.matchControl,
                    tableType: "match"
                };
            }
            this.currentLbData.tabs.push(lbTabData);
            this.context.tabs.push(lbTabData);
            this.currentLbData.links.push(lbData);
            this.context.links.push(lbData);
        }
        this.applyUrls(this.currentType);
        this.showLeaderBoard();
        this.initCustomSelect();
    },
    showLeaderBoard: function(tab) {
        tab = tab || this.currentTab;
        var linkElements = this.element.find(".lb-tab-link");
        var currentLb = this.currentLbData;
        if (this.currentElement && this.currentControl) {
            this.currentElement.empty();
            this.currentControl.destroy();
            this.currentControl = null;
        }
        this.element.find(".leaderboard-tab").hide();
        var dataUrl;
        var cs = this.championships;
        var currentTab = currentLb.tabs[tab];
        if (this.currentType == cs.state.type || this.currentType == cs.open.type) {
            dataUrl = currentLb.tabs[tab].url;
        } else if (this.currentType == cs.amateur.type || this.currentType == cs.fourball.type) {
            dataUrl = currentLb.links[tab].url;
            if (currentTab.tableType == "stroke") {
                this.context.attr("isBracketActive", false);
            } else {
                this.context.attr("isBracketActive", true);
            }
        } else if (this.currentType == cs.cup.type) {
            dataUrl = currentLb.dataUrl;
        }
        if (currentLb.filters) {
            this.element.find("." + currentLb.filters[0].name).addClass("active");
        }
        linkElements.removeClass("active");
        linkElements.filter(function(i) {
            return i == tab;
        }).addClass("active");
        this.context.attr("lbType", currentTab.lbType);
        this.currentElement = this.element.find(currentTab.container).show();
        this.currentControl = new currentTab.control(currentTab.container, {
            dataUrl: dataUrl,
            lbType: currentTab.lbType,
            tabControl: this.tabControl,
            playOff: this.options.playOffUrl
        });
    },
    initCustomSelect: function() {
        this.element.find(".header-box__list-dropdown .dropdown").chosen({
            disable_search_threshold: 10,
            width: "100%"
        });
    },
    ".lb-tab-link click": function(element, event) {
        event.preventDefault();
        if (!element.hasClass("active")) {
            this.currentTab = element.data("index");
            this.showLeaderBoard(this.currentTab);
        }
    },
    ".link-select change": function(element) {
        this.showLeaderBoard(element.val());
    }
});

usga.LeaderBoardInitialControl = usga.LeaderBoardBaseTabsControl.extend({
    currentTab: 0,
    currentControl: null,
    currentLbData: null,
    currentType: null,
    currentElement: null,
    tabControl: null,
    brackets: null,
    championships: {
        state: {
            type: "state",
            tabs: [ {
                container: "#leaderboard-stroke",
                name: "leaderboard-stroke",
                lbType: null,
                control: null,
                url: null
            } ],
            links: false,
            filters: [ {
                name: "show-all-players",
                text: "all",
                tab: "show-all-players"
            }, {
                name: "show-amateurs",
                text: "amateurs",
                tab: "show-amateurs"
            } ]
        },
        open: {
            type: "open",
            tabs: [ {
                container: "#leaderboard-stroke",
                name: "leaderboard-stroke",
                lbType: "individualIntlStroke",
                control: usga.LeaderBoardIndividualStrokeControl,
                url: null
            } ],
            links: false,
            filters: [ {
                name: "show-all-players",
                text: "all",
                tab: "show-all-players"
            }, {
                name: "show-amateurs",
                text: "amateurs",
                tab: "show-amateurs"
            } ]
        },
        cup: {
            type: "cup",
            tabs: [ {
                container: "#leaderboardTeamMatch",
                name: "leaderboardTeamMatch",
                lbType: "teamMatchPlay",
                control: usga.LeaderBoardTeamMatchPlayControl
            } ],
            links: false,
            filters: [ {
                name: "show-all-tabs",
                text: "all",
                tab: "all"
            }, {
                name: "show-singles",
                text: "singles",
                tab: "singles-table"
            }, {
                name: "show-foursomes",
                text: "foursomes",
                tab: "foursomes-table"
            }, {
                name: "show-fourball",
                text: "four ball",
                tab: "fourball-table"
            } ],
            dataUrl: {
                matchStatusUrl: null,
                roundsUrls: null
            }
        },
        amateur: {
            type: "amateur",
            strokeContainer: "#leaderboard-stroke",
            strokeName: "leaderboard-stroke",
            strokeLbType: "individualIntlStroke",
            strokeControl: usga.LeaderBoardIndividualStrokeControl,
            matchContainer: "#leaderboardIndidvidualMatch",
            matchName: "leaderboardIndidvidualMatch",
            matchLbType: "individualMatchPlay",
            matchControl: usga.LeaderBoardMatchPlayControl,
            tabs: [],
            links: [],
            filters: false,
            bracket: true
        },
        fourball: {
            type: "fourball",
            strokeContainer: "#leaderboard-stroke",
            strokeName: "leaderboard-stroke",
            strokeLbType: "fourballIntlStroke",
            strokeControl: usga.LeaderBoardFourballStrokeControl,
            matchContainer: "#leaderboardIndidvidualMatch",
            matchName: "leaderboardIndidvidualMatch",
            matchLbType: "fourballMatchPlay",
            matchControl: usga.LeaderBoardMatchPlayControl,
            tabs: [],
            links: [],
            filters: false,
            bracket: true
        }
    },
    applyTabsData: function(data) {
        this.tabControl = data.menuControl.menuItem;
        this._super();
    },
    setupData: function(data) {
        this.currentType = data.type;
        this.currentLbData = this.championships[this.currentType];
        if (this.currentType == this.championships.state.type) {
            this.currentLbData.tabs[0].lbType = data.lbType;
            if (data.lbType == "individualStateStroke") {
                this.currentLbData.tabs[0].control = usga.LeaderBoardIndividualStrokeControl;
            } else if (data.lbType == "teamStroke") {
                this.currentLbData.tabs[0].control = usga.LeaderBoardStateTeamStrokeControl;
                this.currentLbData.filters = false;
            }
        }
        this.context = new usga.LeaderBoardBaseMap(this.currentLbData);
        this.context.attr("lbType", data.lbType);
        this.render();
    },
    applyUrls: function(type) {
        var cs = this.championships;
        var currentLb = this.currentLbData;
        var options = this.options;
        if (type == cs.state.type || type == cs.open.type) {
            currentLb.tabs[0].url = options.strokeDataUrl;
        } else if (type == cs.amateur.type || type == cs.fourball.type) {
            currentLb.links[0].url = options.strokeDataUrl;
            for (var i = 0, ii = options.matchPlayDataUrls.length; i < ii; i++) {
                currentLb.links[i + 1].url = options.matchPlayDataUrls[i];
            }
        } else if (type == cs.cup.type) {
            currentLb.dataUrl.matchStatusUrl = options.matchStatusUrl;
            currentLb.dataUrl.roundsUrls = options.matchPlayDataUrls;
        }
    },
    showAllPlayers: function() {
        this.element.find(".player-row").show();
    },
    showAmateurs: function() {
        this.element.find(".player-row").hide();
        this.element.find(".player-amateur").show();
    },
    hideRoundContainers: function() {
        this.element.find(".round-container").hide();
    },
    showRoundContainers: function() {
        this.element.find(".round-container").show();
    },
    switchMatchRounds: function(value) {
        if (value != "all") {
            this.hideRoundContainers();
            this.element.find("." + value).show();
        } else {
            this.showRoundContainers();
        }
    },
    switchView: function(target) {
        if (target == "brackets") {
            this.element.find(".leaderboard-view-item").hide();
            this.element.find(".brackets-view-item").show();
            this.initBrackets();
            if (this.currentControl) {
                this.currentElement.empty();
                this.currentControl.destroy();
                this.currentControl = null;
            }
        } else {
            this.element.find(".leaderboard-view-item").show();
            this.element.find(".brackets-view-item").hide();
            this.showLeaderBoard(this.currentTab);
            if (this.brackets) {
                this.element.find("#leaderboardBracketsContainer").empty();
                this.brackets.destroy();
                this.brackets = null;
            }
        }
    },
    initBrackets: function() {
        this.brackets = new usga.LeaderBoardBracketsControl("#leaderboardBracketsContainer", {
            dataUrl: this.options.bracketDataUrl,
            lbType: this.options.type
        });
    },
    toggleSearchButton: function(value, gotFocus, lostFocus) {
        var button = this.$element.find(".search-button");
        if (value) {
            button.toggleClass("search-active", true);
        } else {
            button.toggleClass("search-active", false);
        }
    },
    search: function(value) {
        var lbType = this.context.attr("lbType");
        var rows;
        if (lbType == "stateTeam" || lbType == "fourballIntlStroke") {
            rows = this.element.find(".team-row");
        } else if (lbType == "fourballMatchPlay" || lbType == "individualMatchPlay" || lbType == "teamMatchPlay") {
            rows = this.element.find(".lb-match__container__item");
        } else {
            rows = this.element.find(".player-row");
        }
        this.findTableElement(value, rows);
    },
    ".show-all-players click": function(element, event) {
        event.preventDefault();
        if (!element.hasClass("active")) {
            this.element.find(".header-box__list__item").removeClass("active");
            element.addClass("active");
            this.showAllPlayers();
        }
    },
    ".show-amateurs click": function(element, event) {
        event.preventDefault();
        if (!element.hasClass("active")) {
            this.element.find(".header-box__list__item").removeClass("active");
            element.addClass("active");
            this.showAmateurs();
        }
    },
    ".lb-tab-link click": function(element, event) {
        event.preventDefault();
        if (!element.hasClass("active")) {
            this.currentTab = element.data("index");
            this.showLeaderBoard(this.currentTab);
        }
    },
    ".search-button click": function(element) {
        var field = this.$element.find(".search-field");
        field.val("");
        this.toggleSearchButton();
        this.search("");
    },
    ".search-field keyup": function(element) {
        var value = element.val();
        this.toggleSearchButton(value);
        this.search(value);
    },
    ".search-field focus": function(element) {
        var value = element.val();
        this.toggleSearchButton(value, true);
    },
    ".search-field blur": function(element) {
        var value = element.val();
        this.toggleSearchButton(value, false, true);
    },
    ".header-box__list__item click": function(element, event) {
        event.preventDefault();
        var value = element.data("tab");
        this.element.find(".header-box__list__item").removeClass("active");
        element.addClass("active");
        this.switchMatchRounds(value);
    },
    ".filter-select change": function(element) {
        if (element.val() == "show-all-players") {
            this.showAllPlayers();
        } else if (element.val() == "show-amateurs") {
            this.showAmateurs();
        } else {
            this.switchMatchRounds(element.val());
        }
    },
    ".link-select change": function(element) {
        this.showLeaderBoard(element.val());
    },
    ".view-item-switcher click": function(element, event) {
        event.preventDefault();
        var target = element.data("target");
        if (!element.hasClass("active")) {
            this.element.find(".view-item-switcher").removeClass("active");
            element.addClass("active");
            this.switchView(target);
        }
    }
});

usga.StartingTimesInitialControl = usga.LeaderBoardBaseTabsControl.extend({
    championships: {
        state: {
            type: "state",
            tabs: [],
            links: false,
            filters: false
        },
        open: {
            type: "open",
            tabs: [],
            links: false,
            filters: false
        },
        cup: {
            type: "cup",
            tabs: [],
            links: false,
            filters: false,
            dataUrl: {
                matchStatusUrl: null,
                roundsUrls: null
            }
        },
        amateur: {
            type: "amateur",
            strokeContainer: "#leaderboard-stroke",
            strokeName: "startingTimesStroke",
            strokeLbType: "stroke",
            strokeControl: usga.StartingTimesStrokeControl,
            matchContainer: "#leaderboardIndidvidualMatch",
            matchName: "startingTimesMatch",
            matchLbType: "match",
            matchControl: usga.StartingTimesMatchControl,
            tabs: [],
            links: [],
            filters: false,
            bracket: true
        },
        fourball: {
            type: "fourball",
            strokeContainer: "#startingTimesStroke",
            strokeName: "startingTimesStroke",
            strokeLbType: "fourballIntlStroke",
            strokeControl: usga.StartingTimesStrokeControl,
            matchContainer: "#startingTimesMatch",
            matchName: "startingTimesMatch",
            matchLbType: "fourballMatchPlay",
            matchControl: usga.StartingTimesMatchControl,
            tabs: [],
            links: [],
            filters: false,
            bracket: false
        }
    },
    applyTabsData: function(data) {
        this.tabControl = data.teetimeControl.teetimeItem;
        this._super();
    },
    setupData: function(data) {
        this.currentType = data.type;
        this.currentLbData = this.championships[this.currentType];
        this.context = new usga.LeaderBoardBaseMap(this.currentLbData);
        this.context.attr("lbType", data.lbType);
        this.render();
    },
    applyUrls: function(type) {
        var cs = this.championships;
        var currentLb = this.currentLbData;
        var options = this.options;
        if (type == cs.state.type || type == cs.open.type) {
            currentLb.tabs[0].url = options.strokeDataUrl;
        } else if (type == cs.amateur.type || type == cs.fourball.type) {
            for (var j = 0, jj = options.strokeDataUrls.length; j < jj; j++) {
                currentLb.links[j].url = options.strokeDataUrls[j];
            }
            for (var i = 0, ii = options.matchPlayDataUrls.length; i < ii; i++) {
                currentLb.links[i + options.strokeDataUrls.length].url = options.matchPlayDataUrls[i];
            }
        } else if (type == cs.cup.type) {
            currentLb.dataUrl.matchStatusUrl = options.matchStatusUrl;
            currentLb.dataUrl.roundsUrls = options.matchPlayDataUrls;
        }
    },
    toggleSearchButton: function(value) {
        var button = this.$element.find(".search-button");
        if (value) {
            button.toggleClass("search-active", true);
        } else {
            button.toggleClass("search-active", false);
        }
    },
    ".search-button click": function(element) {
        var field = this.element.find(".search-field");
        field.val("");
        this.toggleSearchButton("");
        var rows = this.element.find(".starting-times-row");
        this.findTableElement("", rows);
    },
    ".search-field keyup": function(element) {
        var value = element.val();
        this.toggleSearchButton(value);
        var rows = this.element.find(".starting-times-row");
        this.findTableElement(value, rows);
    },
    ".search-field focus": function(element) {
        var value = element.val();
        this.toggleSearchButton(value);
    },
    ".search-field blur": function(element) {
        var value = element.val();
        this.toggleSearchButton(value);
    }
});

usga.LeaderBoardTeamControl = usga.BaseModule.extend({
    init: function() {
        this._super();
        this.context = this.options.context;
        this.render();
    },
    render: function() {
        var renderer = can.view("#leaderBoardTeam", this.context, this.getHelpers());
        this.element.html(renderer);
        this.initPlayers();
    },
    getHelpers: function() {
        var context = this.context;
        return {
            isCurrentRound: function(roundNumber, options) {
                roundNumber = can.isFunction(roundNumber) ? roundNumber() : roundNumber;
                return roundNumber == context.attr("currentRound") ? options.fn() : options.inverse();
            },
            getRoundAttr: function(roundName) {
                roundName = can.isFunction(roundName) ? roundName() : roundName;
                if (context.attr("r" + roundName) !== null && context.attr("r" + roundName) !== undefined) {
                    return context.attr("r" + roundName);
                } else {
                    return context.attr("R" + roundName);
                }
            },
            getFlag: function(team) {
                team = can.isFunction(team) ? team() : team;
                return team.attr("state").toUpperCase().replace(/([A-z]*)\s([A-z]*)/, "$1-$2");
            }
        };
    },
    initPlayers: function() {
        var players = this.context.players.player;
        for (var i = 0, ii = players.length; i < ii; i++) {
            var player = players[i];
            player.attr("course", this.context.courseData);
            player.attr("roundData", this.context.roundData);
            player.attr("state", this.context.state);
            player.attr("stateTeam", true);
            player.attr("currentRound", this.context.currentRound);
            player.attr("lbType", this.context.lbType);
            var playerControl = new usga.LeaderBoardPlayerControl(this.element, {
                context: player
            });
        }
        this.addToFavorite();
    },
    addToFavorite: function() {
        var lbType = this.context.attr("lbType");
        var id = this.context.attr("idField");
        if (window.localStorage.getItem(lbType + "." + id) && !this.element.hasClass("my-team-row")) {
            this.element.find(".favorite").trigger("click");
        }
    },
    "{context} change": function(map, evt, attr, how, newValue) {
        if (attr != "players") {
            this.element.data(attr, newValue);
        }
    }
});

usga.LeaderboardTickerContentControl = usga.LeaderBoardBaseControl.extend({
    updateInitialized: false,
    suspended: false,
    currentTemplate: null,
    sliderOptions: {
        slidesPerView: "auto",
        spaceBetween: 0
    },
    init: function() {
        this._super();
        this.context = this.options.context;
        this.config = this.options.leaderBoardConfig;
        this.dataUrl = this.config.dataUrl;
        this.context.attr("buttonLink", this.config.pageLink);
        this.context.attr("lbType", this.config.type);
        this.render();
    },
    render: function() {
        var renderer = can.view("#leaderBoardTickerTables", this.context, this.getHelpers());
        this.element.append(renderer);
        this.getData();
    },
    destroy: function() {
        this.element.empty();
        this._super();
    },
    handleError: function(xhr) {
        this.getData();
    },
    getHelpers: function() {
        return {
            matchPlayerName: function(name) {
                name = can.isFunction(name) ? name() : name;
                if (name) {
                    return name.replace(/([A-z\-]*),\s*([A-z\-\.])*/, "$2. $1");
                }
                return null;
            },
            teamPlayerName: function(name) {
                name = can.isFunction(name) ? name() : name;
                if (name) {
                    return name.replace(/([A-z\.-]*),\s*([A-Z]{1})[A-z\.-]*\s*(\/)\s*([A-z\.-]*),\s*([A-Z]{1})[A-z\.-]*/, "$2. $1 $3 $5. $4");
                }
                return null;
            },
            renderArrow: function(match) {
                match = can.isFunction(match) ? match() : match;
                var isCompleted = match.attr("isCompleted");
                var leader = match.attr("leader");
                var isLeftWinner = leader == "mini-winl" || leader == "1";
                var isRightWinner = leader == "mini-winr" || leader == "2";
                if (isCompleted) {
                    if (isLeftWinner) {
                        return "arrow-1";
                    } else if (isRightWinner) {
                        return "arrow-4";
                    }
                } else {
                    if (isLeftWinner) {
                        return "arrow-2";
                    } else if (isRightWinner) {
                        return "arrow-3";
                    }
                }
            }
        };
    },
    applyInitialContextData: function(data) {
        can.batch.start(this.proxy(function() {
            if (!lbData.suspended && this.config.type != "cup") {
                this.initSlider(this.sliderOptions);
            }
            if (!this.updateInitialized) {
                this.initDataUpdating();
                this.updateInitialized = true;
            }
        }));
        var lbData = this.checkData(data);
        this.suspended = lbData.suspended;
        this.context.attr("suspended", lbData.suspended);
        this.context.attr("isLive", this.checkIsLive());
        can.batch.stop();
    },
    applyDataChanges: function(data) {
        this.applyInitialContextData(data);
    },
    checkIsLive: function() {
        var now = new Date().valueOf();
        var endDate = this.config.endDate;
        var startDate = this.config.startDate;
        return startDate <= now && endDate >= now;
    },
    checkData: function(data) {
        var rawData;
        var tableData = {};
        switch (this.config.type) {
          case "fourball":
            rawData = data.event.tournament;
            break;

          case "state":
            if (data.teams) {
                rawData = data.teams;
            } else if (data.players) {
                rawData = data.players;
            }
            break;

          case "cup":
            rawData = data.event.tournament;
            break;

          case "open":
            rawData = data.players;
            break;

          case "amateur":
            rawData = data.event.tournament;
            break;
        }
        tableData.suspended = this.getPlaySuspended(rawData.playsuspended);
        tableData.items = this.getItems(rawData);
        return tableData;
    },
    getItems: function(data) {
        var tableType;
        switch (this.config.type) {
          case "fourball":
            if (data.display.phase == "matchplay") {
                tableType = "match";
                this.applyContextItems(data.matchplay.matches.match, "match");
            } else if (data.display.phase == "strokeplay") {
                this.applyContextItems(data.strokeplay.teams.team, "player");
                tableType = "stroke";
            }
            break;

          case "amateur":
            if (data.display.phase == "matchplay") {
                tableType = "match";
            } else if (data.display.phase == "strokeplay") {
                this.applyContextItems(data.strokeplay.players.player, "player");
                tableType = "stroke";
            }
            break;

          case "cup":
            this.applyCupItems(data);
            tableType = "cup";
            break;

          case "open":
            this.applyContextItems(data.player, "player");
            tableType = "stroke";
            break;

          case "state":
            if (data.player) {
                this.applyContextItems(data.player, "player");
            } else if (data.team) {
                this.applyContextItems(data.team, "player");
            }
            tableType = "stroke";
            break;
        }
        this.context.attr("tableType", tableType);
    },
    applyContextItems: function(items, itemType) {
        this.context.items.splice(0);
        for (var i = 0, ii = items.length; i < ii; i++) {
            var itemData = items[i];
            var item;
            if (itemType == "player") {
                item = new usga.LeaderBoardPlayer(itemData);
            } else if (itemType == "match") {
                item = new usga.LeaderBoardMatch(itemData);
            }
            item.attr("lbType", this.config.type);
            this.context.items.push(item);
        }
    },
    applyCupItems: function(data) {
        var itemsData = data.cupteams;
        this.context.items.splice(0);
        this.context.items.push({
            teamOneName: itemsData.teamOneName,
            teamOnePoints: itemsData.teamOnePoints,
            teamOneAbbr: itemsData.cupteam[0].name,
            teamTwoName: itemsData.teamTwoName,
            teamTwoPoints: itemsData.teamTwoPoints,
            teamTwoAbbr: itemsData.cupteam[1].name
        });
    },
    initSlider: function(options) {
        this.slider = new Swiper(".swiper-container", options);
    }
});

usga.LeaderBoardTickerModel = usga.LeaderBoardBaseMap.extend({
    define: {
        items: {
            Type: usga.BaseMap.List,
            Value: usga.BaseMap.List
        },
        tableType: {
            type: "string",
            value: ""
        },
        tabs: {
            Type: usga.BaseMap.List,
            Value: usga.BaseMap.List
        }
    },
    isStroke: can.compute(function() {
        return this.attr("tableType") == "stroke";
    }),
    isMatch: can.compute(function() {
        return this.attr("tableType") == "match";
    }),
    isCup: can.compute(function() {
        return this.attr("tableType") == "cup";
    })
});

usga.LeaderboardTickerControl = usga.LeaderBoardBaseControl.extend({
    tabs: null,
    dropdown: null,
    currentLeaderBoard: null,
    currentLeaderBoardData: null,
    currentTabIndex: null,
    init: function() {
        this._super();
        this.context = new usga.LeaderBoardTickerModel();
        this.context.attr("screenSize", this.getScreenSize());
        this.dataUrl = this.options.tickerUrl;
        this.hideTicker();
        $("body").addClass("leaderboard-live-ticker");
        this.render();
        this.getData();
    },
    render: function() {
        var renderer = can.view("#leaderBoardTickerTabs", this.context, this.getHelpers());
        this.element.append(renderer);
    },
    applyInitialContextData: function(data) {
        if (data && data.items && data.items.length) {
            this.tabs = data.items;
            this.applyTabs();
        }
        this.initDataUpdating();
    },
    applyDataChanges: function(data) {
        if (data && data.items && data.items.length) {
            if (this.checkTabsChanges(data.items)) {
                this.tabs = data.items;
                this.applyTabs();
            }
        }
    },
    applyTabs: function() {
        this.context.tabs.splice(0);
        for (var i = 0, ii = this.tabs.length; i < ii; i++) {
            var tab = this.tabs[i];
            var now = new Date().valueOf();
            var endDate = tab.endDate;
            var startDate = tab.startDate;
            if (startDate <= now && now < endDate) {
                this.context.tabs.push(tab);
            }
            this.toggleLBMenuTabs(tab, now);
        }
        if (this.context.tabs.attr("length") > 0) {
            this.showTicker();
            this.currentLeaderBoardData = this.context.tabs.attr(0);
            if (this.dropdown) {
                this.dropdown.trigger("chosen:updated");
            } else {
                this.initCustomSelect();
            }
            this.showLeaderBoard();
        } else {
            this.clearTicker();
        }
    },
    toggleLBMenuTabs: function(tab, now) {
        var startDate = tab.startDate;
        var pageLocation = window.location.href;
        var tabUrl = tab.pageLink;
        var scoringTab = $("#lbScoringTab");
        var courseTab = $("#lbCourseStatistics");
        var pageRegExp = new RegExp(tabUrl.replace(/\.html/i, "").replace(/\/scoring/i, "").replace(/\/starting-times/i, "").replace(/\/course-statistics/i, ""));
        if (pageRegExp.test(pageLocation)) {
            if (now < startDate) {
                scoringTab.hide();
                courseTab.hide();
            } else {
                scoringTab.show();
                courseTab.show();
            }
        } else {
            scoringTab.hide();
            courseTab.hide();
        }
    },
    handleError: function(xhr) {
        this.clearTicker();
        this.getData();
    },
    showTicker: function() {
        this.element.show();
        $("body").addClass("leaderboard-live");
    },
    hideTicker: function() {
        this.element.hide();
        $("body").removeClass("leaderboard-live");
    },
    clearTicker: function() {
        this.tabs = null;
        if (this.context.attr("tabs")) {
            this.context.tabs.splice(0);
        }
        this.currentLeaderBoardData = null;
        this.destroyLeaderboard();
        this.hideTicker();
    },
    showLeaderBoard: function() {
        this.destroyLeaderboard();
        this.currentLeaderBoard = new usga.LeaderboardTickerContentControl("#tickerContent", {
            context: this.context,
            leaderBoardConfig: this.currentLeaderBoardData
        });
    },
    destroyLeaderboard: function() {
        if (this.currentLeaderBoard) {
            this.currentLeaderBoard.destroy();
            this.currentLeaderBoard = null;
        }
    },
    checkTabsChanges: function(newTabs) {
        if (this.tabs === null) {
            return true;
        } else if (this.tabs.length !== newTabs.length) {
            return true;
        } else {
            for (var i = 0, ii = this.tabs.length; i < ii; i++) {
                var tab = this.tabs[i];
                var newTab = newTabs[i];
                for (var prop in tab) {
                    if (tab.hasOwnProperty(prop)) {
                        if (!newTab[prop] || tab[prop] !== newTab[prop]) {
                            return true;
                        }
                    }
                }
                var now = new Date().valueOf();
                var endDate = tab.endDate;
                var startDate = tab.startDate;
                if (startDate > now || now > endDate) {
                    return true;
                }
            }
            return false;
        }
    },
    initCustomSelect: function() {
        this.dropdown = this.element.find(".ticker-dropdown").chosen({
            disable_search_threshold: 10,
            width: "100%"
        });
    },
    onLayout: function() {
        this.context.attr("screenSize", this.getScreenSize());
    },
    ".ticker-dropdown change": function(element) {
        var dataIndex = element.val();
        this.currentLeaderBoardData = this.context.tabs.attr(dataIndex);
        this.currentTabIndex = dataIndex;
        this.showLeaderBoard();
    }
});

usga.Microsite = usga.BaseCloudinaryModule.extend({
    init: function() {
        this._super();
        this.$cloudContainer = this.$element.find(".microsite__media, .microsite__header");
        this.applyCloudinary(this.$cloudContainer);
    },
    onFirstShow: function() {},
    onLayout: function() {
        this.applyCloudinary(this.$cloudContainer);
    }
});

usga.AskQuestionModal = usga.BaseModal.extend({
    defaults: {
        onMessageWritten: function(message) {}
    }
}, {
    message: undefined,
    context: {},
    init: function() {
        this._super();
        this.context = new can.Map({
            status: ""
        });
        this.renderTemplate();
        var messageField = this.element.find('[name="message"]');
        if (messageField.length > 0) {
            this.message = can.compute(messageField[0], "value", "change");
        }
    },
    renderTemplate: function() {
        if ($("#askQuestionModalTemplate").length !== 0) {
            this.element.append(can.view("#askQuestionModalTemplate", this.context));
        }
    },
    setError: function(message) {
        this.element.addClass("error");
        this.element.find(".invalid").removeClass("invalid");
        this.context.attr("status", message || "Error");
    },
    open: function() {
        this.$element.show();
    },
    onSubmitButtonClick: function($element, context) {
        this.element.removeClass("error");
        this.element.find(".invalid").removeClass("invalid");
        this.context.attr("status", "");
        if (this.message && this.message()) {
            if ($.isFunction(this.options.onMessageWritten)) {
                this.options.onMessageWritten(this.message());
            }
        } else {
            this.element.addClass("error");
            this.element.find('[name="message"]').addClass("invalid");
            this.context.attr("status", "Enter message");
        }
    },
    ".ask-button click": function($element, event) {
        event.preventDefault();
        this.onSubmitButtonClick($element, this.context);
    },
    ".modal__body__close click": function() {
        this.close();
    }
});

usga = window.usga || {};

usga.ModalCampaign = usga.BaseModal.extend({
    init: function(element, options) {
        this._super(element, options);
        this.$dialogs = this.$element.find(".modal__inner");
    },
    open: function(selector, params) {
        this.$dialogs.hide().filter(selector).show();
        this.$element.show();
        if (typeof params !== "object") params = {};
        if (typeof params.closeCallback !== "function") params.closeCallback = function() {};
        if (typeof params.yesCallback !== "function") params.yesCallback = function() {};
        if (typeof params.noCallback !== "function") params.noCallback = function() {};
        this.$element.find(".confirmation .message").text(params.message);
        this.params = params;
    },
    ".modal__body__close click": function() {
        this.close();
        this.params.closeCallback();
    },
    ".button.yes click": function() {
        this.close();
        this.params.yesCallback();
    },
    ".button.no click": function() {
        this.close();
        this.params.noCallback();
    }
});

usga.IE9Modal = usga.BaseModal.extend({
    init: function(element, options) {
        this._super(element, options);
        var cookieName = "__old-ie-message-displayed__";
        if (usga.browser.ie && usga.browser.ie < 10 && !$.cookie(cookieName)) {
            $.cookie(cookieName, "true");
            this.$element.find(".modal__body__content__version").text(usga.browser.ie);
            this.open();
        }
    },
    ".modal__body__dismiss click": function() {
        this.close();
    }
});

var usga = window.usga || {};

usga.PartnerModal = usga.BaseCloudinaryModule.extend({
    defaults: {
        autoShow: false,
        activatorSelector: "[data-partner-modal]"
    }
}, {
    init: function(element, options) {
        this._super(element, options);
        this.$element.each(function() {
            var $container = $(this), $el = $container, partner, insertedModalClassName;
            if (!$container.hasClass("modal")) {
                $el = $container.find("modal");
            }
            partner = $el.data("partner");
            insertedModalClassName = "partner-modal-" + partner;
            $("body > ." + insertedModalClassName).remove();
            $el.addClass(insertedModalClassName);
            if (!options.autoShow) {
                $el.css("display", "none");
            }
            $("body").append($el);
        });
        $("body").on("click", options.activatorSelector, this.proxy(this.onActivatorClick)).on("click", ".modal_partner .modal__body__close", this.proxy(this.onCloseClick));
    },
    onActivatorClick: function(event) {
        var $el = $(event.currentTarget);
        $("body").find('[data-partner="' + $el.data("partner-modal") + '"]').toggle(true);
        event.preventDefault();
    },
    onCloseClick: function(event) {
        var $el = $(event.currentTarget);
        $el.closest(".modal_partner").toggle(false);
    }
});

usga.ProfileInformationModal = usga.BaseModal.extend({
    COUNTRY_STATES: {
        US: [ {
            name: "Alabama",
            code: "AL"
        }, {
            name: "Alaska",
            code: "AK"
        }, {
            name: "Arizona",
            code: "AZ"
        }, {
            name: "Arkansas",
            code: "AR"
        }, {
            name: "California",
            code: "CA"
        }, {
            name: "Colorado",
            code: "CO"
        }, {
            name: "Connecticut",
            code: "CT"
        }, {
            name: "Delaware",
            code: "DE"
        }, {
            name: "District of Columbia",
            code: "DC"
        }, {
            name: "Florida",
            code: "FL"
        }, {
            name: "Georgia",
            code: "GA"
        }, {
            name: "Hawaii",
            code: "HI"
        }, {
            name: "Idaho",
            code: "ID"
        }, {
            name: "Illinois",
            code: "IL"
        }, {
            name: "Indiana",
            code: "IN"
        }, {
            name: "Iowa",
            code: "IA"
        }, {
            name: "Kansas",
            code: "KS"
        }, {
            name: "Kentucky",
            code: "KY"
        }, {
            name: "Louisiana",
            code: "LA"
        }, {
            name: "Maine",
            code: "ME"
        }, {
            name: "Maryland",
            code: "MD"
        }, {
            name: "Massachusetts",
            code: "MA"
        }, {
            name: "Michigan",
            code: "MI"
        }, {
            name: "Minnesota",
            code: "MN"
        }, {
            name: "Mississippi",
            code: "MS"
        }, {
            name: "Missouri",
            code: "MO"
        }, {
            name: "Montana",
            code: "MT"
        }, {
            name: "Nebraska",
            code: "NE"
        }, {
            name: "Nevada",
            code: "NV"
        }, {
            name: "New Hampshire",
            code: "NH"
        }, {
            name: "New Jersey",
            code: "NJ"
        }, {
            name: "New Mexico",
            code: "NM"
        }, {
            name: "New York",
            code: "NY"
        }, {
            name: "North Carolina",
            code: "NC"
        }, {
            name: "North Dakota",
            code: "ND"
        }, {
            name: "Ohio",
            code: "OH"
        }, {
            name: "Oklahoma",
            code: "OK"
        }, {
            name: "Oregon",
            code: "OR"
        }, {
            name: "Pennsylvania",
            code: "PA"
        }, {
            name: "Rhode Island",
            code: "RI"
        }, {
            name: "South Carolina",
            code: "SC"
        }, {
            name: "South Dakota",
            code: "SD"
        }, {
            name: "Tennessee",
            code: "TN"
        }, {
            name: "Texas",
            code: "TX"
        }, {
            name: "Utah",
            code: "UT"
        }, {
            name: "Vermont",
            code: "VT"
        }, {
            name: "Virginia",
            code: "VA"
        }, {
            name: "Washington",
            code: "WA"
        }, {
            name: "West Virginia",
            code: "WV"
        }, {
            name: "Wisconsin",
            code: "WI"
        }, {
            name: "Wyoming",
            code: "WY"
        } ],
        Canada: [ {
            name: "Alberta",
            code: "AB"
        }, {
            name: "British Columbia",
            code: "BC"
        }, {
            name: "Manitoba",
            code: "MB"
        }, {
            name: "New Brunswick",
            code: "NB"
        }, {
            name: "Newfoundland and Labrador",
            code: "NL"
        }, {
            name: "Northwest Territories",
            code: "NT"
        }, {
            name: "Nova Scotia",
            code: "NS"
        }, {
            name: "Nunavut",
            code: "NU"
        }, {
            name: "Ontario",
            code: "ON"
        }, {
            name: "Prince Edward Island",
            code: "PE"
        }, {
            name: "Quebec",
            code: "QC"
        }, {
            name: "Saskatchewan",
            code: "SK"
        }, {
            name: "Yukon",
            code: "YT"
        } ]
    },
    defaults: {
        onProfileUpdated: function(profile) {},
        profileScope: "rsvp"
    }
}, {
    context: {},
    profile: undefined,
    init: function() {
        this._super();
        this.profile = this.createProfile();
        this.context = new can.Map({
            countryStates: usga.ProfileInformationModal.COUNTRY_STATES.US,
            profile: this.profile.attr()
        });
        this.renderTemplate();
    },
    renderTemplate: function() {
        if ($("#profileInformationModalTemplate").length !== 0) {
            this.element.append(can.view("#profileInformationModalTemplate", this.context));
        }
    },
    open: function() {
        usga.Gigya.getProfileMailingAddress().then(this.proxy(function(address) {
            if (address) {
                this.profile = this.createProfile(address);
                this.context.attr("profile", this.profile.attr());
                if (this.context.attr("profile.country")) {
                    this.context.attr("countryStates", usga.ProfileInformationModal.COUNTRY_STATES[this.context.attr("profile.country")]);
                    var state = this.context.attr("profile.state");
                    this.context.attr("profile.state", "");
                    this.context.attr("profile.state", state);
                }
                this.element.show();
                if (this.isSmallScreen()) {
                    usga.scrollTo($("body"));
                }
            }
        }));
    },
    createProfile: function(address) {
        var type = !this.options.profileScope || this.options.profileScope === null || [ "rsvp", "ask" ].indexOf(this.options.profileScope) !== -1 || this.options.profileScope === "rsvp" ? usga.RsvpProfileInformation : usga.AskQuestionProfileInformation;
        return address ? new type(address) : new type();
    },
    onCountryChanged: function($element, context) {
        this.context.attr("countryStates", usga.ProfileInformationModal.COUNTRY_STATES[this.context.attr("profile.country")]);
    },
    onUpdateButtonClick: function($element, context) {
        this.profile.attr(this.context.attr("profile").attr());
        var errors = this.profile.errors();
        this.element.removeClass("error");
        this.element.find(".invalid").removeClass("invalid");
        this.context.attr("status", "");
        if (errors !== null) {
            var status = "Please, fill required fields";
            this.element.addClass("error");
            this.context.attr("status", status);
        } else {
            usga.Gigya.setProfileMailingAddress(this.profile.attr()).then(this.proxy(function(result) {
                if (result) {
                    this.close();
                    if ($.isFunction(this.options.onProfileUpdated)) {
                        this.options.onProfileUpdated(this.profile);
                    }
                } else {
                    this.context.attr("status", "Server error");
                    this.element.addClass("error");
                }
            }));
        }
    },
    '[name="country"] change': function($element, context) {
        this.onCountryChanged($element, context);
    },
    ".update-button click": function($element, context) {
        this.onUpdateButtonClick($element, context);
    },
    ".modal__body__close click": function() {
        this.close();
    }
});

usga.ProtectedContentModal = usga.BaseModal.extend({
    init: function(element, options) {
        this._super(element, options);
        this.$dialogs = this.$element.find(".modal__body__content");
    },
    open: function(selector, isCloseDisabled) {
        this.$dialogs.hide().filter(selector).show();
        this.$element.find(".modal__body__close").toggle(!isCloseDisabled);
        this.$element.show();
        if (this.isSmallScreen()) {
            usga.scrollTo($("body"));
        }
    },
    ".modal__body__close click": function() {
        this.close();
    },
    ".button.sign-in-button click": function() {
        this.close(true);
        usga.Gigya.login();
    },
    ".button.register-button click": function() {
        this.close(true);
        usga.Gigya.register();
    },
    ".button.connect-button click": function() {
        this.close(true);
        usga.Gigya.connect();
    }
});

usga.SignInModal = usga.BaseModal.extend({
    open: function(selector, isCloseDisabled) {
        this.$element.find(".modal__body__close").toggle(!isCloseDisabled);
        this.$element.show();
        if (this.isSmallScreen()) {
            usga.scrollTo($("body"));
        }
    },
    ".modal__body__close click": function() {
        this.close();
    },
    ".button.sign-in-button click": function() {
        this.close(true);
        usga.Gigya.login();
    },
    ".button.register-button click": function() {
        this.close(true);
        usga.Gigya.register();
    }
});

usga.NavSearch = usga.BaseSearchModule.extend({
    defaults: {
        template: "#nav-search-results-template",
        typesLimits: {
            all: 2,
            news: 2,
            photos_videos: 4
        },
        attivioSearchQueryData: {
            predictive: true
        }
    }
}, {
    $search: null,
    $query: null,
    $results: null,
    context: null,
    _stats: {
        total: 0,
        type: {}
    },
    init: function(element, options) {
        this._super();
        this.$search = this.$element.find(".nav-search");
        this.$query = this.$search.find(".nav-search__form__field input");
        this.$results = this.$search.find(".nav-search__result");
        this.context = new can.Map({
            suggestion: "",
            results: {},
            resultLinks: {},
            categories: {}
        });
        this.$results.append(this._renderTemplate());
        this.applyCloudinary(this.$results);
    },
    navigateToSearch: function(type) {
        if (this._getQueryText()) {
            this.navigate(this.getResultsUrl(type || ""));
        }
    },
    navigate: function(url) {
        var pathName = location.pathname, newPath = usga.url.trimHost(url);
        location.href = url;
        if (pathName && pathName !== "/" && newPath.indexOf(pathName) === 0) {
            setTimeout(function() {
                location.reload(true);
            }, 0);
        }
    },
    _trackDtm: function(autocompleteTerm, data) {
        usga.trackDtm("user-predictive-search", {
            search: {
                term: autocompleteTerm,
                results: this._stats.total
            }
        });
    },
    _setStats: function(documents) {
        var stats = {
            total: 0,
            type: {}
        };
        for (var i = 0, len = documents.length; i < len; i++) {
            var document = documents[i], type = this._getDocumentType(document), typeName = type.name;
            if (typeName.match(/rules/i)) {
                typeName = "rules";
            }
            if (!type || [ "courses", "store" ].indexOf(typeName) !== -1) {
                continue;
            }
            if (!stats.type[typeName]) {
                stats.type[typeName] = 0;
            }
            stats.type[typeName] += 1;
            stats.total += 1;
        }
        this._stats = stats;
    },
    autoComplete: function() {
        var autocompleteTerm = this._getQueryText();
        if (autocompleteTerm) {
            this.makeAutocompleteRequest(autocompleteTerm).done(this.proxy(function(data) {
                var documents = this._getDocuments(data);
                this._setStats(documents);
                this._trackDtm(autocompleteTerm);
            })).done(this.proxy(this.setRenderItems)).done(this.proxy(function() {
                this.updateProtectedLinks();
                this.$results.toggle(true);
            }));
        }
    },
    makeAutocompleteRequest: function(term) {
        return this._makeRequest(term);
    },
    clearResults: function() {
        can.batch.start();
        this.context.attr("suggestion", "");
        this.context.attr("results", {});
        this.context.attr("resultLinks", {});
        this.context.attr("categories", {});
        can.batch.stop();
    },
    _hasToSetRenderAllItem: function(items) {
        return this.options.typesLimits && this.options.typesLimits.all && (!items.all || items.all && items.all.length < this.options.typesLimits.all);
    },
    _setRenderItem: function(document, typeName, items) {
        if (this._hasToSetRenderAllItem(items)) {
            typeName = "all";
        } else if (this.options.typesLimits) {
            if (false === (this.options.typesLimits[typeName] && (!items[typeName] || items[typeName] && items[typeName].length < this.options.typesLimits[typeName]))) {
                return false;
            }
        }
        if (!items[typeName]) {
            items[typeName] = [];
        }
        items[typeName].push(this._prepareRenderItem(document));
        return true;
    },
    setRenderItems: function(data) {
        var facetBucket = this._getFacetBucket(data) || this._getSynonyms(data), documents = this._getDocuments(data), categories = {}, items = {}, maxRenderItems = !this.options.typesLimits || !usga.isObject(this.options.typesLimits) || usga.sum(this.options.typesLimits), stats = {};
        can.batch.start();
        if (facetBucket) {
            if (this._getQueryText() !== facetBucket.label) {
                this.context.attr("suggestion", facetBucket.label);
            }
        }
        for (var i = 0, len = documents.length, q = 0; i < len; i++) {
            var document = documents[i], type = this._getDocumentType(document), typeName = type.name;
            if (typeName.match(/rules/i)) {
                typeName = "rules";
            }
            if (!type || [ "courses", "store" ].indexOf(typeName) !== -1) {
                continue;
            }
            if (!categories[typeName]) {
                categories[typeName] = type.label;
            }
            if (this._setRenderItem(document, typeName, items)) {
                q++;
            }
            if (false === (maxRenderItems !== true && q < maxRenderItems)) {
                break;
            }
        }
        this.context.attr("categories", categories);
        this.context.attr("resultLinks.all", this.getResultsUrl("all"));
        this.context.categories.each(this.proxy(function(label, type) {
            this.context.attr("resultLinks." + type, this.getResultsUrl(type));
        }));
        this.context.attr("results", items);
        can.batch.stop();
        this.applyCloudinary();
    },
    toggleSearch: function(state) {
        this.$search.toggle(state);
        this.toggleResults(false);
        if (state) {
            this.$search.find(".nav-search__form__field input:text:visible:first").focus();
        }
        if (this._getQueryText()) {
            this.$results.toggle(true);
            this.autoComplete();
        }
    },
    toggleResults: function(state) {
        this.$results.toggle(state);
    },
    onQueryTyping: function(event) {
        switch (event.keyCode) {
          case usga.NavSearch.KEYS.ENTER:
            event.preventDefault();
            this.navigateToSearch();
            break;

          default:
            this.onQueryTyped();
            break;
        }
    },
    onQueryTyped: function() {
        this.$results.toggle(false);
        this.clearResults();
        if (this.changeTimeout) {
            clearTimeout(this.changeTimeout);
            this.changeTimeout = null;
        }
        this.changeTimeout = setTimeout(this.proxy(this.autoComplete), 1e3);
    },
    ".nav-search__form__btn click": function($el, event) {
        event.preventDefault();
        if (this._getQueryText()) {
            this.navigateToSearch();
        }
    },
    ".nav-search__form__field input keydown": function($el, event) {
        this.onQueryTyping(event);
    },
    '.nav-search__suggest__text[data-words!=""] click': function($el, event) {
        event.preventDefault();
        this.$query.val($el.data("words"));
        this.navigateToSearch("all");
    },
    ".nav-search__category-title click": function($link, event) {
        event.preventDefault();
        var type = $link.data("type");
        this._trackDtmTypedSearch(this._getQueryText(), this._stats.type[type], $link.data("type"));
        setTimeout(this.proxy(this.navigate, $link[0].href), 1e3);
    },
    ".nav-search__all-results click": function($link, event) {
        event.preventDefault();
        this._trackDtmTypedSearch(this._getQueryText(), this._stats.total, "all");
        setTimeout(this.proxy(this.navigate, $link[0].href), 1e3);
    },
    ".nav-search__more.all click": function($link, event) {
        event.preventDefault();
        this._trackDtmTypedSearch(this._getQueryText(), this._stats.total, "all");
        setTimeout(this.proxy(this.navigate, $link[0].href), 1e3);
    }
});

(function() {
    var getAuthorizationData = function() {
        if (usga.Gigya.isLoggedIn()) {
            var d = $.Deferred();
            usga.Gigya.getDataStore(function(ds) {
                var obj = {};
                if (ds && usga.isObject(ds) && ds.data && usga.isObject(ds.data) && ds.data.membership && usga.isObject(ds.data.membership)) {
                    obj = ds.data.membership;
                }
                return d.resolve(obj);
            });
            return d.promise();
        } else {
            return $.when(false);
        }
    };
    usga.Navigation = usga.BaseCloudinaryModule.extend({
        MAIN_MENU_ANIMATABLE_CLASS: "animatable",
        MAIN_MENU_ACTIVE_CLASS: "active",
        MAIN_MENU_SUB_VISIBLE_CLASS: "main-menu__item_sub_mod1",
        SUB_MAIN_MENU_SUB_VISIBLE_CLASS: "sub-main-menu__item_sub_mod1",
        MAIN_MENU_ACTIVE_PAGE_MENU_ITEM_CLASS: "active-page-item",
        MAIN_MENU_ACTIVE_PAGE_ITEM_SUBMENU_CLASS: "active-page-item-submenu",
        defaults: {
            submenuDissapearDelay: 1e3,
            moreMenuDissapearDelay: 2e3,
            sticky: true,
            cover: false,
            baseUrl: location.protocol + "//" + location.host,
            baseSearchPageUrl: "",
            highlightActiveItem: true,
            showActivePageSubMenu: false
        }
    }, {
        minIndent: 0,
        flyClass: "navigation_scroll",
        invokableAction: false,
        navSearch: null,
        menuLayoutDelay: 550,
        init: function() {
            if (this.options.sticky) {
                this.$element.addClass("navigation_fixed");
            }
            this.$mainMenuContainer = this.$element.find(".main-menu");
            this.$mainMenu = this.$element.find(".main-menu__inner");
            this.$secondaryMenu = this.$element.find(".secondary_main-menu");
            this.$dropdown = this.$mainMenu.find("li.main-menu__dropdown");
            this.minIndent = this.getMinStickyIndent();
            this.navSearch = new usga.NavSearch(this.$element, {
                baseUrl: this.options.baseUrl,
                baseSearchPageUrl: this.options.baseSearchPageUrl
            });
            this._super();
            this.setInitialClasses();
            this.highlightActivePageMenuItem();
            this.showActivePageSubMenu();
            usga.Gigya.onReady(this.proxy(this.onGigyaActionsReady));
            $("body").on("click", this.proxy(this.onOutsideClick));
        },
        isPageHasLiveLeaderboardTicker: function() {
            return $("body").hasClass("leaderboard-live-ticker");
        },
        isMainMenu: function(el) {
            return this.$mainMenu.has(el).length !== 0;
        },
        inSubMoreMenu: function($el) {
            var $more = this.getSubMoreMenu($el), isIn = $more.length !== 0 && !$el.is(".sub-main-menu__more-menu") && $more.has($el);
            if (isIn) {
                var parents = $el.parentsUntil(".sub-main-menu__more-menu");
                isIn = parents.filter(".sub-main-menu__item__submenu").length > 0;
            }
            return isIn;
        },
        isSubMoreMenu: function($el) {
            return $el.is(".sub-main-menu__more-menu") || $el.closest(".sub-main-menu__more-menu").length !== 0;
        },
        isMoreMenu: function(el) {
            return this.$dropdown.has(el).length !== 0;
        },
        isSubMenu: function($el) {
            return $el.is(".sub-main-menu__item_sub") || $el.closest(".sub-main-menu__item_sub").length !== 0;
        },
        isSubMenuItem: function($item) {
            return $item.is(".main-menu__item_sub, .sub-main-menu__item_sub");
        },
        isGigyaAction: function(action) {
            return [ "login", "sign-in", "logout", "register", "sign-up", "profile", "campaignRegister", "campaignLogin" ].indexOf(action) !== -1;
        },
        hasLink: function($element) {
            var $link = $element.is("a") ? $element : $element.find(">a"), href = $link[0].href;
            return href && href.search(/^javascript/i) === -1 && href.search(/#$/) === -1;
        },
        isFlyPosition: function() {
            if (!this.isSmallScreen()) {
                if (this.options.sticky) {
                    return $(window).scrollTop() >= this.minIndent && $(window).scrollTop() > 0;
                }
            } else {
                return false;
            }
        },
        isSubMoreMenuApplicable: function(containerWidth, $items) {
            for (var i = 0, len = $items.length, calcWidth = 0; i < len; i++) {
                var $item = $($items[i]);
                calcWidth += Math.ceil($item.outerWidth(true));
                if (calcWidth > containerWidth) {
                    return true;
                }
            }
            return false;
        },
        hasActiveMainMenuItem: function() {
            return this.$element.find(".main-menu__inner > li.main-menu__item.active").length === 1;
        },
        hasHoveringMenuItemOnFirstLevel: function() {
            return this.$element.find(".main-menu__inner > li.main-menu__item.mouse-on").length !== 0;
        },
        isMainMenuScrolled: function() {
            return this.$element.hasClass(this.flyClass);
        },
        isSearchActive: function() {
            return this.$element.find(".secondary_main-menu__item__link.search").hasClass("search-active");
        },
        isHamburgerOpened: function() {
            return this.$element.find(".navigation__toggle").hasClass("navigation__toggle_mod1");
        },
        getMinStickyIndent: function() {
            var min = this.element.find(".main-menu").outerHeight();
            if ($("body").hasClass("leaderboard-live") && $("#leaderBoardTicker").length > 0) {
                min += $("#leaderBoardTicker").outerHeight();
            }
            return min;
        },
        getOpenedHamburgerHeight: function() {
            if (!this.isHamburgerOpened()) {
                return 0;
            }
            return this.$element.height() + this.$element.find(".navigation__box").height();
        },
        setInitialClasses: function() {
            if (this.options.highlightActiveItem) {
                this.$element.find("li.active").addClass(usga.Navigation.MAIN_MENU_ACTIVE_PAGE_MENU_ITEM_CLASS);
                var activeSubMenu = null, activeSecondLevelItem = this.$element.find("li.sub-main-menu__item_active"), activeThirdLevelItem = this.$element.find("li.sub-main-menu__item__submenu__item_active");
                if (activeThirdLevelItem.length > 0) {
                    activeThirdLevelItem.addClass(usga.Navigation.MAIN_MENU_ACTIVE_CLASS).addClass(usga.Navigation.MAIN_MENU_ACTIVE_PAGE_MENU_ITEM_CLASS);
                    var activeSecondLevelSubMenu = activeThirdLevelItem.closest(".sub-main-menu__item_sub");
                    activeSubMenu = activeThirdLevelItem.closest(".main-menu__item_sub");
                    if (activeSubMenu.length > 0) {
                        activeSubMenu.addClass(this.options.showActivePageSubMenu ? usga.Navigation.MAIN_MENU_ACTIVE_PAGE_ITEM_SUBMENU_CLASS : usga.Navigation.MAIN_MENU_ACTIVE_PAGE_MENU_ITEM_CLASS);
                    }
                    if (activeSecondLevelSubMenu.length > 0) {
                        activeSecondLevelSubMenu.addClass(usga.Navigation.MAIN_MENU_ACTIVE_CLASS).addClass(usga.Navigation.MAIN_MENU_ACTIVE_PAGE_MENU_ITEM_CLASS);
                    }
                }
                if (activeSecondLevelItem.length > 0) {
                    activeSecondLevelItem.addClass(usga.Navigation.MAIN_MENU_ACTIVE_CLASS).addClass(usga.Navigation.MAIN_MENU_ACTIVE_PAGE_MENU_ITEM_CLASS);
                    activeSubMenu = activeSecondLevelItem.closest(".main-menu__item_sub");
                    if (activeSubMenu.length > 0) {
                        activeSubMenu.addClass(this.options.showActivePageSubMenu ? usga.Navigation.MAIN_MENU_ACTIVE_PAGE_ITEM_SUBMENU_CLASS : usga.Navigation.MAIN_MENU_ACTIVE_PAGE_MENU_ITEM_CLASS);
                    }
                }
            } else {
                this.$element.find(".sub-main-menu__item__submenu__item_active, .sub-main-menu__item_active, .active").removeClass("sub-main-menu__item__submenu__item_active").removeClass("sub-main-menu__item_active").removeClass("active");
            }
        },
        layoutMenuItems: function() {
            this.toggleFlyMode();
            if (usga.supports.touch) {
                this.closeMoreMenu();
                this.closeSubMenus(true, true);
                this.closeSecondarySubmenus();
                this.removeActiveStateFromMenuItemsOnFirstLevel();
                this.highlightActivePageMenuItem();
                this.showActivePageSubMenu();
            }
            if (!this.isSmallScreen()) {
                if (!usga.supports.touch && this.isHamburgerOpened()) {
                    if (this.getOpenedHamburgerHeight() < $(window).height()) {
                        this.closeHamburgerMenu();
                    }
                }
            }
            if (this.isSmallScreen() || this.isMediumScreen()) {
                return;
            }
            var collection = [], showDropdown = false, paddingLeft = parseInt(this.$mainMenuContainer.css("padding-left")), menuContainerWidth = this.$mainMenuContainer.width(), $items = null;
            this.$dropdown.addClass("hide");
            this.restoreMainMenuItems();
            this.$dropdown.find("ul:first li:first").siblings().addBack().remove();
            $items = this.$mainMenu.find(">li").not(".main-menu__dropdown");
            $items.each(function() {
                var $item = $(this);
                if ($item.position().left - paddingLeft + $item.width() > menuContainerWidth) {
                    showDropdown = true;
                    return false;
                }
            });
            if (showDropdown) {
                this.$dropdown.removeClass("hide");
                var dropdownWidth = this.$dropdown.find(">a").width();
                this.$mainMenu.append(this.$dropdown.find("ul>li"));
                $items = this.$mainMenu.find(">li").not(".main-menu__dropdown");
                $items.each(function() {
                    var $item = $(this);
                    if ($item.position().left - paddingLeft + $item.width() > menuContainerWidth - dropdownWidth) {
                        collection.push(this);
                    }
                });
            }
            if (collection.length > 0) {
                var $collection = $(collection);
                this.backupMainMenuItems($collection);
                this.$dropdown.find(">ul").empty().append($collection);
                $collection.filter(".main-menu__item_sub").each(function() {
                    $(this).find("a:first")[0].href = "#";
                    $(this).find(".sub-main-menu__item_sub").each(function() {
                        $(this).find("a:first")[0].href = "#";
                    });
                });
                this.$dropdown.find(".active").each(function() {
                    $(this).removeClass(usga.Navigation.MAIN_MENU_ACTIVE_CLASS);
                });
                if (this.$dropdown.hasClass("mouse-on")) {
                    this.$dropdown.addClass("open");
                }
            } else {
                this.$dropdown.addClass("hide");
            }
            var openedMainSubMenu = this.$element.find("ul:first li:first").siblings("li").addBack().filter(".main-menu__item_sub." + usga.Navigation.MAIN_MENU_SUB_VISIBLE_CLASS + ":not(.main-menu__dropdown)");
            if (openedMainSubMenu.length !== 0) {
                this.putSubMenuItemsToSubMoreMenu(openedMainSubMenu);
            }
            if (!this.isSmallScreen() && !this.isMainMenuScrolled()) {
                if (!this.hasActiveMainMenuItem() && !this.hasHoveringMenuItemOnFirstLevel()) {
                    this.highlightActivePageMenuItem();
                    this.showActivePageSubMenu();
                }
            }
        },
        toggleOverlay: function(state) {
            var $overlay = $("body > .nav-overlay");
            if (!$overlay.length) {
                $overlay = $('<div class="nav-overlay"></div>').toggleClass("visible", false);
                $("body").append($overlay);
            }
            $overlay.toggleClass("visible", state);
        },
        toggleFlyMode: function() {
            if (!this.isSmallScreen() && !this.isMediumScreen()) {
                if (this.options.sticky) {
                    var flyPosition = this.isFlyPosition();
                    if (this.menuTimeout) {
                        clearTimeout(this.menuTimeout);
                        this.menuTimeout = undefined;
                    }
                    if (flyPosition) {
                        this.$element.addClass(this.flyClass);
                        $("body").addClass("scroll");
                    } else if (!flyPosition) {
                        this.$element.removeClass(this.flyClass);
                        $("body").removeClass("scroll");
                        if (!this.hasActiveMainMenuItem() && !this.hasHoveringMenuItemOnFirstLevel()) {
                            this.highlightActivePageMenuItem();
                            this.showActivePageSubMenu();
                        }
                    }
                }
            }
        },
        toggleNavigationBox: function($el) {
            var prevState = $el.hasClass("search-active"), newState = !prevState;
            this.navSearch.toggleSearch(newState);
            this.toggleOverlay(newState);
            $el.removeClass("search-" + (prevState ? "" : "in") + "active").addClass("search-" + (newState ? "" : "in") + "active");
            this.$element.find(".navigation__box").removeClass("active");
            this.$element.find(".navigation__toggle").removeClass("navigation__toggle_mod1");
            this.$element.removeClass("hamburger-mode");
        },
        setMouseHoverState: function($el, state) {
            if (!usga.supports.touch) {
                this.$element.find("mouse-on").removeClass("mouse-on");
                $el.toggleClass("mouse-on", state);
            }
        },
        removeActiveStateFromMenuItemsOnFirstLevel: function() {
            this.$element.find(".main-menu__inner > li.main-menu__item").removeClass(usga.Navigation.MAIN_MENU_ACTIVE_CLASS);
        },
        highlightActivePageMenuItem: function() {
            if (!this.isHamburgerOpened()) {
                var activeMenuItem = this.findActivePageMenuItem(true);
                activeMenuItem.addClass(usga.Navigation.MAIN_MENU_ACTIVE_CLASS);
                if (this.isPageHasLiveLeaderboardTicker()) {
                    activeMenuItem = this.findActivePageMenuItem(true, ":not(.sub-main-menu__item_sub)");
                    activeMenuItem.addClass(usga.Navigation.MAIN_MENU_ACTIVE_CLASS);
                }
            }
        },
        unhighlightActivePageMenuItem: function() {
            this.$element.find(".main-menu__inner > li." + usga.Navigation.MAIN_MENU_ACTIVE_PAGE_MENU_ITEM_CLASS).removeClass(usga.Navigation.MAIN_MENU_ACTIVE_CLASS);
        },
        findActivePageMenuItem: function(notWithinMoreMenu, exclude) {
            var element = this.$element.find("." + usga.Navigation.MAIN_MENU_ACTIVE_PAGE_MENU_ITEM_CLASS + (exclude ? exclude : ""));
            if (notWithinMoreMenu && this.isMoreMenu(element)) {
                return $([]);
            }
            return element[0] ? $(element[0]) : element;
        },
        showActivePageSubMenu: function() {
            if (this.$element.find("." + usga.Navigation.MAIN_MENU_ACTIVE_PAGE_ITEM_SUBMENU_CLASS).length === 0) {
                return;
            }
            if (!this.isHamburgerOpened() && !this.isSearchActive() && !this.isMainMenuScrolled() && this.options.showActivePageSubMenu) {
                var $submenu = this.$element.find("." + usga.Navigation.MAIN_MENU_ACTIVE_PAGE_ITEM_SUBMENU_CLASS + ":not(.sub-main-menu__item_sub):first");
                this.closeSubMenus(true);
                $submenu.addClass(usga.Navigation.MAIN_MENU_SUB_VISIBLE_CLASS);
                if (!this.isMoreMenu($submenu) && !this.isHamburgerOpened()) {
                    this.putSubMenuItemsToSubMoreMenu($submenu);
                }
            }
            if (this.isHamburgerOpened()) {
                this.$element.find(".sub-main-menu__item_sub." + usga.Navigation.MAIN_MENU_ACTIVE_PAGE_MENU_ITEM_CLASS).addClass(usga.Navigation.SUB_MAIN_MENU_SUB_VISIBLE_CLASS);
            }
        },
        hideActivePageSubMenu: function() {
            this.$element.find("." + usga.Navigation.MAIN_MENU_ACTIVE_PAGE_ITEM_SUBMENU_CLASS).removeClass(usga.Navigation.MAIN_MENU_SUB_VISIBLE_CLASS);
        },
        updateMenuItemsAccordingToAuthorizationState: function() {
            getAuthorizationData().done(this.proxy(function(membership) {
                var menuItems = this.$element.find(".sub-main-menu__item__submenu__item:has(a[data-role])"), autoRenew = usga.isObject(membership) && membership.autorenew;
                this.$element.toggleClass("login", usga.Gigya.isLoggedIn());
                menuItems.toggle(false);
                if (!usga.Gigya.isLoggedIn() || usga.Gigya.isFan() || usga.Gigya.isProspect()) {
                    menuItems.filter(":has([data-role~=default])").toggle(true);
                } else if (autoRenew) {
                    menuItems.filter(":has([data-role~=user-has-autorenew])").toggle(true);
                } else if (usga.Gigya.isExpiringFederatedUserWithinRenewalWindow() || usga.Gigya.isExpiredFederatedUser()) {
                    menuItems.filter(":has([data-role~=expired-federated]), :has([data-role~=expiring-federated-within-renewal-window])").toggle(true);
                } else if (usga.Gigya.isLapsedFederatedUser()) {
                    menuItems.filter(":has([data-role~=lapsed-federated])").toggle(true);
                } else if (usga.Gigya.isFederatedUserOutsideRenewalWindow()) {
                    menuItems.filter(":has([data-role~=federated-outside-renewal-window])").toggle(true);
                }
            }));
        },
        invokeAction: function(name) {
            if (this.isGigyaAction(name)) {
                var gigya = usga.Gigya;
                var gigyaActionMap = {
                    "sign-in": "login",
                    "sign-up": "register"
                };
                var action = gigya[name] || gigya[gigyaActionMap[name]];
                if (action) {
                    action.apply(gigya);
                }
            }
        },
        putSubMenuItemsToSubMoreMenu: function($submenu) {
            var $container = $submenu.find(".sub-main-menu__inner:first"), $moreContainer, containerWidth = Math.floor($container.width()), moreWidth, $items, $more = $submenu.find(".sub-main-menu__more-menu");
            $container.css("whiteSpace", "nowrap");
            if ($more.length === 0) {
                $more = this.createSubMoreMenu();
                $container.append($more);
            }
            $moreContainer = $more.find(".sub-main-menu__item__submenu");
            this.restoreSubMenuItems($submenu);
            $moreContainer.find("li:first").siblings().addBack().remove();
            $more.css("visibility", "hidden");
            moreWidth = $more.outerWidth(true);
            $items = $container.find("li:first").siblings(":not(.sub-main-menu__more-menu)").addBack();
            if (this.isSubMoreMenuApplicable(containerWidth, $items)) {
                var $movingItems, moveIndex, width = containerWidth - moreWidth;
                for (var i = 0, len = $items.length, calcWidth = 0; i < len; i++) {
                    var $item = $($items[i]);
                    calcWidth += Math.ceil($item.outerWidth(true));
                    if (calcWidth > width) {
                        moveIndex = i;
                        break;
                    }
                }
                if (moveIndex) {
                    $movingItems = $items.filter(":gt(" + (moveIndex - 1) + ")");
                    this.backupSubMenuItems($submenu, $movingItems);
                    $moreContainer.append($movingItems);
                    $moreContainer.find("li:first").siblings().addBack().each(function() {
                        var isSubMenu = $(this).hasClass("sub-main-menu__item_sub");
                        if (isSubMenu) {
                            $(this).find("a:first").attr("href", "#").prop("href", "#");
                        }
                        $(this).removeClass().addClass("sub-main-menu__item");
                        if (isSubMenu) {
                            $(this).addClass("sub-main-menu__item_sub");
                        }
                        $(this).find("a:first").removeClass().addClass("sub-main-menu__item__link");
                    });
                    $more.css("visibility", "");
                }
            } else {
                $more.remove();
            }
        },
        backupSubMenuItems: function($submenu, $items) {
            var $clonedItems = $items.clone(true, true);
            $submenu.data("cloned-items", $clonedItems);
        },
        restoreSubMenuItems: function($submenu) {
            var $more = $submenu.find(".sub-main-menu__more-menu"), $clonedItems = $submenu.data("cloned-items");
            if ($clonedItems) {
                if ($more.length > 0) {
                    $more.before($clonedItems);
                } else {
                    $submenu.find(".sub-main-menu__inner:first").append($clonedItems);
                }
            }
            $submenu.data("cloned-items", null);
        },
        createSubMoreMenu: function() {
            var $more = $("<li/>").addClass("sub-main-menu__item").addClass("sub-main-menu__item_sub").addClass("sub-main-menu__more-menu");
            $more.append($("<a />").addClass("sub-main-menu__item__link sub-main-menu__item__link__more-menu").prop("href", "#").html("More"));
            $more.append($("<ul />").addClass("sub-main-menu__item__submenu"));
            return $more;
        },
        getSubMoreMenu: function($el) {
            var $found = $el.is(".sub-main-menu__more-menu") ? $el : undefined;
            if (!$found) {
                $found = $el.closest(".sub-main-menu__more-menu").first();
            }
            return $found;
        },
        openHamburgerMenu: function() {
            this.$element.toggleClass("hamburger-mode", true);
            this.$element.find(".navigation__box").toggleClass("active", true);
            $el.toggleClass("navigation__toggle_mod1", true);
        },
        closeHamburgerMenu: function() {
            this.$element.find(".navigation__toggle").removeClass("navigation__toggle_mod1");
            this.$element.find(".navigation__box").removeClass("active");
            this.$element.removeClass("hamburger-mode");
            this.toggleOverlay(this.isSearchActive());
        },
        showSubMenu: function($menu, event) {
            if (this.isMoreMenu($menu)) {
                this.closeMoreMenuSubMenus($menu);
            } else {
                this.closeMoreMenu();
                if (event && this.isSubMenu($(event.target))) {
                    var subMenu = this.getSubMenu($(event.target)), subMoreMenu = subMenu.closest(".sub-main-menu__more-menu"), temporaryClass = "submenu-" + new Date().valueOf();
                    subMenu.addClass(temporaryClass);
                    subMoreMenu.addClass(temporaryClass);
                    this.closeSubMenus(this.isMoreMenu($menu), false, "." + temporaryClass);
                    subMenu.removeClass(temporaryClass);
                    subMoreMenu.removeClass(temporaryClass);
                } else {
                    this.closeSubMenus(this.isMoreMenu($menu), false);
                }
            }
            this.removeActiveStateFromMenuItemsOnFirstLevel();
            $menu.addClass(usga.Navigation.MAIN_MENU_SUB_VISIBLE_CLASS);
            if (!this.isMoreMenu($(event.target)) && !this.isSubMoreMenu($(event.target)) && !this.inSubMoreMenu($(event.target)) && !this.isHamburgerOpened()) {
                this.putSubMenuItemsToSubMoreMenu($menu);
            }
            if (!$menu.hasClass(usga.Navigation.MAIN_MENU_ACTIVE_PAGE_MENU_ITEM_CLASS)) {
                this.unhighlightActivePageMenuItem();
            }
            if (!$menu.hasClass(usga.Navigation.MAIN_MENU_ACTIVE_PAGE_ITEM_SUBMENU_CLASS)) {
                this.hideActivePageSubMenu();
            }
        },
        closeSubMenus: function(skipPreActivated, hideAll, skipSubMenu) {
            this.$mainMenu.find("." + usga.Navigation.MAIN_MENU_SUB_VISIBLE_CLASS + (skipPreActivated && !hideAll ? ":not(." + usga.Navigation.MAIN_MENU_ACTIVE_PAGE_ITEM_SUBMENU_CLASS + ")" : "")).removeClass(usga.Navigation.MAIN_MENU_SUB_VISIBLE_CLASS);
            this.$mainMenu.find("." + usga.Navigation.SUB_MAIN_MENU_SUB_VISIBLE_CLASS + skipSubMenu ? ":not(" + skipSubMenu + ")" : "").removeClass(usga.Navigation.SUB_MAIN_MENU_SUB_VISIBLE_CLASS);
            if (!skipPreActivated) {
                this.highlightActivePageMenuItem();
                this.showActivePageSubMenu();
            }
        },
        getSubMenu: function($el) {
            var $found = $el.is(".sub-main-menu__item_sub") ? $el : undefined;
            if (!$found) {
                $found = $el.closest(".sub-main-menu__item_sub").first();
            }
            return $found;
        },
        showSecondarySubmenu: function($menu) {
            this.closeSecondarySubmenus();
            $menu.toggleClass("secondary_main-menu__item_sub_mod1", true);
        },
        closeSecondarySubmenus: function() {
            if (this.secondarySubMenuTimer) {
                clearInterval(this.secondarySubMenuTimer);
                this.secondarySubMenuTimer = null;
            }
            this.$secondaryMenu.find(".secondary_main-menu__item_sub").toggleClass("secondary_main-menu__item_sub_mod1", false);
        },
        toggleTertiaryMenu: function($item, evt, state) {
            evt.preventDefault();
            if ($item.hasClass("sub-main-menu__more-menu")) {
                $item.find("." + usga.Navigation.SUB_MAIN_MENU_SUB_VISIBLE_CLASS).removeClass(usga.Navigation.SUB_MAIN_MENU_SUB_VISIBLE_CLASS);
            }
            if (state) {
                $item.siblings("." + usga.Navigation.SUB_MAIN_MENU_SUB_VISIBLE_CLASS).removeClass(usga.Navigation.SUB_MAIN_MENU_SUB_VISIBLE_CLASS);
            }
            $item.toggleClass(usga.Navigation.SUB_MAIN_MENU_SUB_VISIBLE_CLASS, state);
        },
        openMoreMenu: function($more, event) {
            $more.find(".sub-main-menu__inner").css("whiteSpace", "");
            $more.addClass("open");
            this.onMoreMenuOpen($more, event);
        },
        closeMoreMenu: function($more, event) {
            this.$dropdown.removeClass("open");
            this.highlightActivePageMenuItem();
            this.showActivePageSubMenu();
        },
        backupMainMenuItems: function($items) {
            var $mainmenu = this.$element.find("ul:first"), $clonedItems = $items.clone();
            $mainmenu.data("cloned-items", $clonedItems);
        },
        restoreMainMenuItems: function() {
            var $mainmenu = this.$element.find("ul:first"), $clonedItems = $mainmenu.data("cloned-items");
            if ($clonedItems) {
                this.$dropdown.before($clonedItems);
            }
            $mainmenu.data("cloned-items", null);
        },
        openActivePageItemSubmenuInMoreMenu: function($more, event) {
            $more.find("." + usga.Navigation.MAIN_MENU_ACTIVE_PAGE_ITEM_SUBMENU_CLASS).addClass(usga.Navigation.MAIN_MENU_SUB_VISIBLE_CLASS);
        },
        closeMoreMenuSubMenus: function($moreItemSubmenu) {
            this.$dropdown.find("." + usga.Navigation.MAIN_MENU_SUB_VISIBLE_CLASS).removeClass(usga.Navigation.MAIN_MENU_SUB_VISIBLE_CLASS);
            if ($moreItemSubmenu) {
                $moreItemSubmenu.find("." + usga.Navigation.SUB_MAIN_MENU_SUB_VISIBLE_CLASS).removeClass(usga.Navigation.SUB_MAIN_MENU_SUB_VISIBLE_CLASS);
            }
        },
        removeActiveStateFromMenuItemsInMoreMenu: function() {
            var $items = this.$dropdown.find(".main-menu__dropdown_menu > li");
            $items.filter("." + usga.Navigation.MAIN_MENU_ACTIVE_CLASS).removeClass(usga.Navigation.MAIN_MENU_ACTIVE_CLASS);
            $items.filter("." + usga.Navigation.MAIN_MENU_SUB_VISIBLE_CLASS).removeClass(usga.Navigation.MAIN_MENU_SUB_VISIBLE_CLASS);
        },
        checkDoubleTap: function(element) {
            var elementUid, key;
            if (!this._elementUidTap) {
                this._elementUidTap = 1;
            }
            if (!element.data("element-uid-tap")) {
                element.data("element-uid-tap", this._elementUidTap);
                this._elementUidTap++;
            }
            elementUid = element.data("element-uid-tap");
            key = "_lastTap" + elementUid;
            if (usga.supports.touch) {
                if (this[key]) {
                    if (new Date().valueOf() - this[key] <= 600) {
                        return true;
                    }
                }
                this[key] = new Date().valueOf();
            }
            return false;
        },
        onDocumentReady: function() {
            var $navSpacer = this.$element.next(".navigation-spacer");
            if (this.options.sticky) {
                if (!$navSpacer.length) {
                    $navSpacer = $('<div class="navigation-spacer"></div>').insertAfter(this.$element);
                }
                if (this.options.cover || $("body > .wrapper").hasClass("top-nav-overflow")) {
                    $navSpacer.addClass("navigation-spacer_cover");
                }
            } else {
                $navSpacer.remove();
            }
            usga.Gigya.onUser(this.proxy(this.updateMenuItemsAccordingToAuthorizationState));
            this.layoutMenuItems();
            this.$element.addClass(usga.Navigation.MAIN_MENU_ANIMATABLE_CLASS);
        },
        onWindowLoad: function() {
            this.layoutMenuItems();
        },
        onGigyaActionsReady: function() {
            if (this.invokableAction) {
                this.invokeAction(this.invokableAction);
                this.invokableAction = false;
            }
        },
        onWindowScroll: function() {
            if (usga.device.touch && this.options.sticky && this.isFlyPosition()) {
                this.closeSubMenus(true, true);
                this.closeMoreMenu();
            } else if (!(this.isSmallScreen() || this.isMediumScreen())) {
                if (this.options.sticky) {
                    this.toggleFlyMode();
                    if (this.isFlyPosition() && !this.hasHoveringMenuItemOnFirstLevel()) {
                        this.unhighlightActivePageMenuItem();
                        this.hideActivePageSubMenu();
                    }
                }
            }
            if (this.menuTimeout) {
                clearTimeout(this.menuTimeout);
                this.menuTimeout = undefined;
            }
            this.menuTimeout = window.setTimeout(this.proxy(function() {
                clearTimeout(this.menuTimeout);
                this.menuTimeout = undefined;
                this.layoutMenuItems();
            }), this.menuLayoutDelay);
        },
        onWindowResize: function() {
            if (this.resizeTimeOut) {
                window.clearTimeout(this.resizeTimeOut);
                this.resizeTimeOut = null;
            }
            this.resizeTimeOut = window.setTimeout($.proxy(this.layoutMenuItems, this), this.menuLayoutDelay);
        },
        onMoreMenuOpen: function($more, event, withinMoreMenu) {
            this.unhighlightActivePageMenuItem();
            this.hideActivePageSubMenu();
            if (!withinMoreMenu) {
                this.openActivePageItemSubmenuInMoreMenu($more, event);
            }
        },
        onOutsideClick: function(event) {
            if (!($(event.target).closest(".navigation__box").length !== 0 || $(event.target).is(".navigation__box"))) {
                if (!this.$element.hasClass("hamburger-mode")) {
                    this.removeActiveStateFromMenuItemsInMoreMenu();
                    this.closeSubMenus();
                    this.closeMoreMenu(this.$dropdown);
                }
            }
            if ($(event.target).is(".nav-overlay") && this.isHamburgerOpened()) {
                this.closeHamburgerMenu();
            }
        },
        onSubMenuItemWithSubMenuClick: function(element, evt) {
            var target = $(evt.target);
            if (element.hasClass("sub-main-menu__item_sub")) {
                if (!usga.supports.touch && this.hasLink(element)) {
                    return true;
                }
                if (this.checkDoubleTap(element)) {
                    return true;
                }
                this.toggleTertiaryMenu(element, evt, !element.hasClass(usga.Navigation.SUB_MAIN_MENU_SUB_VISIBLE_CLASS));
            }
        },
        onSubMenuItemWithSubMenuHover: function(on, element, evt) {
            if (this.isHamburgerOpened() || this.isMoreMenu($(evt.target))) {
                return true;
            }
            if (element.hasClass("sub-main-menu__item_sub")) {
                this.toggleTertiaryMenu(element, evt, on);
            }
        },
        ".navigation__toggle click": function($el) {
            var newState = !$el.hasClass("navigation__toggle_mod1");
            if (newState) {
                this.$element.removeClass(this.flyClass);
                var mainSubMenus = this.$element.find("ul:first li:first").siblings("li").addBack().filter(".main-menu__item_sub:not(.main-menu__dropdown)");
                if (mainSubMenus.length !== 0) {
                    mainSubMenus.each(this.proxy(function(i, el) {
                        this.restoreSubMenuItems($(el));
                        $(el).find(".sub-main-menu__more-menu").remove();
                    }));
                }
            }
            this.closeSecondarySubmenus();
            this.removeActiveStateFromMenuItemsInMoreMenu();
            this.restoreMainMenuItems();
            this.$dropdown.find("ul:first li:first").siblings().addBack().remove();
            this.$element.find(".sub-main-menu__more-menu").remove();
            this.$element.toggleClass("hamburger-mode", newState);
            this.$element.find(".navigation__box").toggleClass("active", newState);
            $el.toggleClass("navigation__toggle_mod1", newState);
            this.highlightActivePageMenuItem();
            this.showActivePageSubMenu();
            this.toggleOverlay(this.$element.hasClass("hamburger-mode"));
            this.element.find(".navigation__search").removeClass("search-active").addClass("search-inactive");
            this.element.find(".secondary_main-menu__item__link.search").removeClass("search-active").addClass("search-inactive");
            this.navSearch.toggleSearch(false);
            if (!newState) {
                this.layoutMenuItems();
            }
        },
        "a[data-action] click": function($el, event) {
            var action = $(event.currentTarget).data("action");
            event.preventDefault();
            if (!this.isGigyaAction(action) || usga.Gigya.isReady()) {
                this.invokeAction(action);
            } else {
                this.invokableAction = action;
            }
        },
        ".navigation__search click": function($el, event) {
            this.element.find(".secondary_main-menu__item__link.search").removeClass("search-inactive").addClass("search-active");
            this.toggleNavigationBox($el);
        },
        ".main-menu__item__link click": function($el, evt) {
            var $item = $el.parent();
            if (this.isSubMenuItem($item) && this.checkDoubleTap($el)) {
                return true;
            }
            if (!this.isSubMenuItem($item) || !usga.supports.touch && this.hasLink($el) && !this.isHamburgerOpened()) {
                return;
            } else {
                evt.preventDefault();
            }
            if (this.isSmallScreen() || this.isMediumScreen()) {
                this.closeSecondarySubmenus();
                evt.preventDefault();
            }
            if (this.isHamburgerOpened() && (usga.device.ios || usga.device.android) && !(this.isSmallScreen() || this.isMediumScreen())) {
                evt.preventDefault();
                this.$mainMenu.find(".sub-main-menu__item__submenu").removeClass(usga.Navigation.SUB_MAIN_MENU_SUB_VISIBLE_CLASS);
            }
            if ($item.hasClass(usga.Navigation.MAIN_MENU_SUB_VISIBLE_CLASS)) {
                if (usga.supports.touch) {
                    this.removeActiveStateFromMenuItemsOnFirstLevel();
                }
                if (this.isMoreMenu($el)) {
                    this.closeSubMenus(true, true);
                } else {
                    this.closeSubMenus(!usga.supports.touch);
                }
            } else {
                this.showSubMenu($item, evt);
            }
        },
        ".main-menu__inner > li.main-menu__item:not(.main-menu__item_sub) mouseenter": function($el, evt) {
            this.setMouseHoverState($el, true);
            if (!this.isSmallScreen() && !this.isMediumScreen() && !this.isMoreMenu($(evt.target)) && $(evt.target).closest(".main-menu__item_sub").length === 0) {
                if (this.subMenuTimer) {
                    clearInterval(this.subMenuTimer);
                    this.subMenuTimer = null;
                }
                this.closeMoreMenu();
                this.closeSubMenus();
                this.removeActiveStateFromMenuItemsOnFirstLevel();
                this.hideActivePageSubMenu();
                this.unhighlightActivePageMenuItem();
                if (!$el.hasClass("main-menu__dropdown") && !$el.hasClass("main-menu__item_sub")) {
                    $el.addClass(usga.Navigation.MAIN_MENU_ACTIVE_CLASS);
                }
            }
        },
        ".main-menu__item:not(.main-menu__item_sub).active mouseleave": function($el, evt) {
            this.setMouseHoverState($el, false);
            if (!this.isSmallScreen() && !this.isMoreMenu($(evt.target)) && $(evt.target).closest(".main-menu__item_sub").length === 0) {
                $el.removeClass(usga.Navigation.MAIN_MENU_ACTIVE_CLASS);
                this.highlightActivePageMenuItem();
                this.showActivePageSubMenu();
            }
        },
        ".main-menu__item_sub mouseenter": function($el, evt) {
            this.setMouseHoverState($el, true);
            if (!(this.isSmallScreen() || this.isMediumScreen()) && !this.isMoreMenu($(evt.target)) && !this.inSubMoreMenu($(evt.target))) {
                if (this.moreMenuTimer) {
                    clearTimeout(this.moreMenuTimer);
                    this.moreMenuTimer = null;
                }
                if (usga.device.ios || usga.device.android) {
                    return;
                }
                if (this.subMenuTimer) {
                    clearInterval(this.subMenuTimer);
                    this.subMenuTimer = null;
                }
                this.showSubMenu($el, evt);
            }
        },
        ".main-menu__item_sub mouseleave": function($el, evt) {
            this.setMouseHoverState($el, false);
            if (!(this.isSmallScreen() || this.isMediumScreen()) && !this.isMoreMenu($(evt.target))) {
                if (this.subMenuTimer) {
                    clearInterval(this.subMenuTimer);
                    this.subMenuTimer = null;
                }
                if (usga.device.ios || usga.device.android) {
                    return;
                }
                this.subMenuTimer = setTimeout(this.proxy(this.closeSubMenus), !this.isMoreMenu($(evt.relatedTarget)) ? this.options.moreMenuDissapearDelay : this.options.submenuDissapearDelay);
            }
        },
        ".sub-main-menu__item mouseenter": function(element, evt) {
            if (this.subMenuTimer) {
                clearTimeout(this.subMenuTimer);
                this.subMenuTimer = null;
            }
            if (element.is(".sub-main-menu__item_sub") && !this.inSubMoreMenu($(evt.target))) {
                this.onSubMenuItemWithSubMenuHover(true, element, evt);
                evt.stopPropagation();
            }
        },
        ".sub-main-menu__item mouseleave": function(element, evt) {
            if (element.is(".sub-main-menu__item_sub") && !this.inSubMoreMenu($(evt.target))) {
                if (this.subMenuTimer) {
                    clearTimeout(this.subMenuTimer);
                    this.subMenuTimer = null;
                }
                this.subMenuTimer = setTimeout(this.proxy(function() {
                    this.onSubMenuItemWithSubMenuHover(false, element, evt);
                }), this.options.submenuDissapearDelay);
            }
        },
        ".sub-main-menu__item click": function(element, evt) {
            var target = $(evt.target);
            if (target.is("li.sub-main-menu__item__submenu__item") || target.is("a.sub-main-menu__item__submenu__item__link")) {
                return;
            }
            this.onSubMenuItemWithSubMenuClick(element, evt);
            evt.stopPropagation();
        },
        ".main-menu__dropdown-toggle click": function($el, event) {
            var $more = $el.parent();
            event.preventDefault();
            this.closeSubMenus(true, true);
            if ($more.hasClass("open")) {
                this.closeMoreMenu();
            } else {
                this.openMoreMenu($more, event);
            }
        },
        ".main-menu__dropdown mouseenter": function($el, event) {
            this.setMouseHoverState($el, true);
            if (this.subMenuTimer) {
                clearTimeout(this.subMenuTimer);
            }
            if (this.moreMenuTimer) {
                clearTimeout(this.moreMenuTimer);
                this.moreMenuTimer = null;
            }
            if (usga.device.ios || usga.device.android) {
                return;
            }
            var $target = $(event.target), withinMoreMenu = $el.hasClass("open");
            $el.find(".sub-main-menu__inner").css("whiteSpace", "");
            $el.addClass("open");
            $el.find(".sub-main-menu__more-menu").remove();
            if (!(this.isMoreMenu($target) && ($target.hasClass("main-menu__item_sub") || $target.closest(".main-menu__item_sub").length > 0))) {
                this.closeSubMenus(true);
                this.closeMoreMenuSubMenus();
            }
            this.onMoreMenuOpen($el, event, withinMoreMenu);
        },
        ".main-menu__dropdown mouseleave": function($el, evt) {
            this.setMouseHoverState($el, false);
            if (usga.device.ios || usga.device.android) {
                return;
            }
            if (this.moreMenuTimer) {
                clearTimeout(this.moreMenuTimer);
                this.moreMenuTimer = null;
            }
            var delay = this.options.submenuDissapearDelay;
            if (!this.isMoreMenu($(evt.relatedTarget))) {
                delay = this.options.moreMenuDissapearDelay;
            }
            this.moreMenuTimer = setTimeout(this.proxy(function() {
                $el.removeClass("open");
                this.closeSubMenus();
            }), delay);
        },
        ".main-menu__dropdown .main-menu__item mouseenter": function($el, evt) {
            if (this.isMoreMenu($(evt.target))) {
                if (this.moreMenuTimer) {
                    clearTimeout(this.moreMenuTimer);
                    this.moreMenuTimer = null;
                }
            }
        },
        ".main-menu__dropdown .main-menu__item_sub mouseleave": function($el, evt) {
            if (this.moreMenuTimer) {
                clearTimeout(this.moreMenuTimer);
                this.moreMenuTimer = null;
            }
            var delay = this.options.submenuDissapearDelay;
            if (!this.isMoreMenu($(evt.relatedTarget))) {
                delay = this.options.moreMenuDissapearDelay;
            }
            this.moreMenuTimer = setTimeout(this.proxy(this.closeSubMenus), delay);
        },
        ".secondary_main-menu__item__link click": function($el) {
            var parent = $el.parent(), newState = false;
            if (parent.hasClass("secondary_main-menu__item_sub") && (this.isSmallScreen() || this.isMediumScreen())) {
                newState = !parent.hasClass("secondary_main-menu__item_sub_mod1");
                this.closeSubMenus(true, true);
                this.closeSecondarySubmenus();
                parent.toggleClass("secondary_main-menu__item_sub_mod1", newState);
            }
        },
        ".secondary_main-menu__item_sub mouseenter": function($el) {
            if (!(this.isSmallScreen() || this.isMediumScreen()) && !this.isSearchActive()) {
                this.showSecondarySubmenu($el);
            }
        },
        ".secondary_main-menu__item_sub mouseleave": function($el, event) {
            if (!(this.isSmallScreen() || this.isMediumScreen()) && !this.isSearchActive()) {
                if (this.secondarySubMenuTimer) {
                    this.closeSecondarySubmenus();
                } else {
                    var delay = this.options.submenuDissapearDelay;
                    this.secondarySubMenuTimer = setTimeout(this.proxy(this.closeSecondarySubmenus), delay);
                }
            }
        },
        ".secondary_main-menu__item_sub .secondary_main-menu__item__submenu:first mouseenter": function($el) {
            if (!(this.isSmallScreen() || this.isMediumScreen()) && !this.isSearchActive()) {
                this.showSecondarySubmenu($el.closest(".secondary_main-menu__item_sub"));
            }
        },
        ".secondary_main-menu__item_sub .secondary_main-menu__item__submenu:first mouseleave": function($el) {
            if (!(this.isSmallScreen() || this.isMediumScreen()) && !this.isSearchActive()) {
                if (this.secondarySubMenuTimer) {
                    this.closeSecondarySubmenus();
                } else {
                    var delay = !$el.find(".secondary_main-menu__item__submenu:gt(0)")[0] ? 10 : this.options.submenuDissapearDelay;
                    this.secondarySubMenuTimer = setTimeout(this.proxy(this.closeSecondarySubmenus), delay);
                }
            }
        },
        ".secondary_main-menu__item__link.search click": function($el, event) {
            var isHamburgerOpened = this.isHamburgerOpened();
            this.closeSubMenus();
            this.closeSecondarySubmenus();
            this.element.find(".navigation__search").removeClass("search-inactive").addClass("search-active");
            this.toggleNavigationBox($el);
            if (isHamburgerOpened) {
                usga.scrollTo(this.$element);
            }
            if (this.moreMenuTimer) {
                clearTimeout(this.moreMenuTimer);
                this.moreMenuTimer = null;
            }
            if ($el.hasClass("search-active")) {
                this.hideActivePageSubMenu();
            } else {
                this.showActivePageSubMenu();
            }
        }
    });
})();

usga.Promo = usga.BaseCloudinaryModule.extend({
    onFirstShow: function() {
        if (!this.isSmallScreen()) {
            this._super();
        }
    },
    onLayout: function() {
        if (!this.isSmallScreen()) {
            this._super();
        }
    }
});

usga.Registration = usga.BaseModule.extend({
    onDocumentReady: function() {
        this.$element.find(".registration__header__dropdown .dropdown").chosen({
            disable_search_threshold: 10,
            width: "100%"
        });
    }
});

usga.ReigningChampions = usga.VariableSlider.extend({
    sliderSelector: ".reigning-champions__slider",
    getSliderConfig: function() {
        var screenSize = this.getScreenSize();
        if (this.isSmallScreen() || this.isMediumScreen()) {
            return null;
        }
        var config = {
            infiniteLoop: false,
            hideControlOnEnd: true,
            minSlides: 3,
            maxSlides: 3,
            slideWidth: this.mediumMaxWidth - 8,
            slideMargin: 30,
            adaptiveHeight: true
        };
        if (this.isBigScreen()) {
            config.minSlides = 2;
            config.maxSlides = 2;
        }
        return config;
    },
    getCloudinaryLogoConfig: function() {
        return {
            crop: "fit",
            height: 80
        };
    },
    getCloudinaryPhotosConfig: function() {
        var config = {
            crop: "fill",
            width: 370,
            height: 208
        };
        var screenSize = this.getScreenSize();
        switch (screenSize) {
          case "big":
            config.width = 443;
            config.height = 249;
            break;

          case "medium":
            config.width = 740;
            config.height = 416;
            break;

          case "small":
            config.width = 460;
            config.height = 258;
            break;
        }
        return config;
    },
    showNextItems: function() {
        var nextItem = this.$element.find("li:hidden:first");
        if (nextItem.length) {
            nextItem.show();
        }
        if (this.$element.find("li:hidden").length) {
            this.moreButton.show();
        } else {
            this.moreButton.hide();
        }
    },
    onFirstShow: function() {
        this._super();
        this.moreButton = this.$element.find(".show-more__button");
        if (this.isSmallScreen() || this.isMediumScreen()) {
            this.$element.find("li").hide();
            this.showNextItems();
        } else {
            this.moreButton.hide();
        }
    },
    onLayout: function(screen) {
        if (!(this.isSmallScreen() || this.isMediumScreen())) {
            this.$element.find("li").show();
            this.moreButton.hide();
        }
        this._super();
    },
    ".show-more__button click": function(evt) {
        this.showNextItems();
    }
});

usga.RulesResources = usga.BaseModule.extend({
    initSlider: function() {
        this.slider = this.$element.find(".resources__slider").bxSlider({
            controls: false,
            infiniteLoop: false,
            minSlides: 1,
            maxSlides: 1,
            slideWidth: this.mediumMaxWidth - 8,
            slideMargin: 0,
            adaptiveHeight: true,
            touchEnabled: usga.supports.touch
        });
    },
    onDocumentReady: function() {
        this.onLayout();
    },
    onLayout: function() {
        if ((this.isBiggerScreen() || this.isInfinityScreen()) && this.slider) {
            this.slider.destroySlider();
            this.slider = null;
        } else if (!this.isBiggerScreen() && !this.isInfinityScreen() && !this.slider) {
            this.initSlider();
        }
    }
});

var usga = window.usga || {};

usga.RuleBook = usga.BaseCloudinaryModule.extend({
    context: null,
    helpers: null,
    onDocumentReady: function() {
        var me = this;
        this.rulesOrder = [];
        this.previousRuleId = "";
        this.nextRuleId = "";
        if (this.options.urlMatches) {
            this.urlMatches = this.options.urlMatches;
        } else {
            this.urlMatches = {
                ids: [ "14252", "14253", "14322", "14323", "14324", "21474844050", "14325", "14326" ],
                aliases: [ "etiquette", "definitions", "appendix-i", "appendix-ii", "appendix-iii", "appendix-iv", "amateur-status", "gambling" ]
            };
        }
        if (this.options.decisions) this.decisions = this.options.decisions;
        if (this.options.currentSelectedRule) this.currentSelectedRule = this.options.currentSelectedRule; else this.currentSelectedRule = "01";
        this.viewMode = "rule";
        this.skipUrlSet = false;
        this.context = new can.Map(this.options);
        this.readHash();
        this.initialHash = window.location.hash;
        this.firstLoad = true;
        this.helpers = {
            addNavId: function(itemId) {
                me.rulesOrder.push(itemId());
            },
            rendered: function() {
                return function(el) {
                    setTimeout(function() {
                        me.$element.find(".rule-book__side__item__box__list__block__item .numeric a").each(function() {
                            var anchor = $(this);
                            var href = anchor.attr("href");
                            anchor.attr("href", me.hrefToHash(href));
                            anchor.attr("target", "");
                            anchor.click(function() {
                                var indexAnchor = href.indexOf("#");
                                if (indexAnchor > 0) {
                                    me.iframeHash = href.substring(indexAnchor);
                                }
                                me.$element.find(".contentIframe").attr("src", href);
                                me.hashAlreadySet = false;
                                me.setHash();
                                me.scrollIntoFrameHeader();
                                return false;
                            });
                        });
                        me.selectRule(me.currentSelectedRule, me.viewMode);
                        if (!me.mobileCheck() && me.initialHash) me.scrollIntoFrameHeader();
                    }, 500);
                };
            }
        };
        $.getJSON(this.options.feedUrl, this.proxy(this.onFeedLoaded));
        this.$element.find(".contentIframe").load(function() {
            me.iFrameChanged(this.contentWindow.location);
            return false;
        });
        $(".search .search__button").click(function() {
            var q = encodeURIComponent($(".search .search__input").val());
            if (q) document.location = "/search-results.html#q=" + q + "&type=rules";
        });
    },
    hrefToHash: function(href) {
        return "#!" + href.replace(this.context.baseUrl, "").replace("#", ",").replace(".html", "");
    },
    readHash: function() {
        hash = window.location.hash;
        this.iframeHash = "";
        if (hash) {
            var hashArray = hash.split(",");
            hash = hashArray[0];
            if (hashArray.length > 1) {
                this.iframeHash = "#" + hashArray[1];
            }
        }
        var re = new RegExp("([a-z]+)-([0-9]+)");
        var result = re.exec(hash);
        if (result === null) {
            if (hash && hash.length < 3) return;
            var hash = hash.substring(2);
            for (var i = 0; i < this.urlMatches.aliases.length; i++) {
                if (hash == this.urlMatches.aliases[i]) {
                    result = [];
                    result[1] = "rule";
                    result[2] = this.urlMatches.ids[i];
                    break;
                }
            }
            if (result === null) return;
        }
        if (result[1] != "rule" && result[1] != "decision") return;
        this.viewMode = result[1];
        this.currentSelectedRule = result[2];
    },
    setHash: function() {
        if (this.hashAlreadySet) return;
        this.hashAlreadySet = true;
        this.iframeHashComa = this.iframeHash.replace("#", ",");
        if (this.currentSelectedRule.length < 3) {
            window.location.hash = "#!" + this.viewMode + "-" + this.currentSelectedRule + this.iframeHashComa;
            this.iframeHash = "";
            return;
        }
        for (var i = 0; i < this.urlMatches.ids.length; i++) {
            if (this.currentSelectedRule == this.urlMatches.ids[i]) {
                window.location.hash = "#!" + this.urlMatches.aliases[i] + this.iframeHashComa;
                this.iframeHash = "";
                return;
            }
        }
        window.location.hash = "#!" + this.viewMode + "-" + this.currentSelectedRule + this.iframeHashComa.replace("#", ",");
        this.iframeHash = "";
    },
    onFeedLoaded: function(data) {
        this.context.attr("sections", data.sections);
        this.context.baseUrl = this.options.baseUrl;
        var html = can.view("#ruleBookNavListTemplate", this.context, this.helpers);
        this.$element.find(".rule-book__side").empty().append(html);
    },
    ".ruleLinkDiv a click": function() {
        return this.showRule();
    },
    ".decisionLinkDiv a click": function() {
        return this.showDecision();
    },
    ".previousLink click": function() {
        if (this.previousRuleId !== "") {
            if (this.viewMode == "decision") {
                if (this.previousRuleId > 100) return false;
            }
            this.selectRule(this.previousRuleId, this.viewMode);
        }
        return false;
    },
    ".nextLink click": function() {
        if (this.nextRuleId !== "") {
            if (this.viewMode == "decision") {
                if (this.nextRuleId > 100) return false;
            }
            this.selectRule(this.nextRuleId, this.viewMode);
        }
        return false;
    },
    ".rule-book__side__item__box__list__link click": function(el) {
        var itemId = el.attr("itemId");
        this.selectRule(itemId, "rule");
        if (itemId.length > 2) this.scrollIntoFrameHeader();
    },
    mobileCheck: function() {
        if (navigator.userAgent.match(/Android/i) || navigator.userAgent.match(/webOS/i) || navigator.userAgent.match(/iPhone/i) || navigator.userAgent.match(/iPad/i) || navigator.userAgent.match(/iPod/i) || navigator.userAgent.match(/BlackBerry/i) || navigator.userAgent.match(/Windows Phone/i)) {
            return true;
        } else {
            return false;
        }
    },
    scrollIntoFrameHeader: function() {
        if (this.mobileCheck()) window.scrollBy(0, -100); else {
            document.getElementById("ruleLink").scrollIntoView();
            window.scrollBy(0, -70 - ($("#leaderBoardTicker").is(":visible") ? 61 : 0));
        }
    },
    iFrameChanged: function(url) {
        var me = this;
        if ((url.href.indexOf("#") >= 0 || !this.mobileCheck()) && !me.firstTimeLoadNoHash()) {
            this.scrollIntoFrameHeader();
        }
        me.firstLoad = false;
        var iframeAnchors = this.$element.find(".contentIframe").contents().find("a");
        iframeAnchors.each(function() {
            if (this.href.indexOf("#") >= 0) {
                var o = $(this);
                o.attr("onclick", 'document.location="' + this.href + '";return false;');
                var urlParts = this.href.split("/");
                this.href = "http://" + window.location.hostname + window.location.pathname + me.hrefToHash(urlParts[urlParts.length - 1]);
            }
        });
        iframeAnchors.bind("click", function(e) {
            setTimeout(function() {
                me.scrollIntoFrameHeader();
            }, 200);
        });
        var re = new RegExp("([a-z]+)-([0-9]+)");
        var result = re.exec(url);
        if (result === null) return;
        if (result[1] != "rule" && result[1] != "decision") return;
        if (result[2] != this.currentSelectedRule || result[1] != this.viewMode) {
            this.skipUrlSet = true;
            this.selectRule(result[2], result[1]);
            if (this.mobileCheck()) return;
            var navItem = this.$element.find("." + result[1] + result[2] + "Navigation");
            this.scrollRightMenu(navItem);
        }
    },
    loadContent: function() {
        var currentSelectedRuleString = "";
        if (this.currentSelectedRule.length < 2) {
            currentSelectedRuleString = "0" + this.currentSelectedRule;
        } else {
            currentSelectedRuleString = this.currentSelectedRule;
        }
        this.$element.find(".contentIframe").attr("src", this.options.baseUrl + this.viewMode + "-" + currentSelectedRuleString + ".html" + this.iframeHash);
        this.setHash();
    },
    showDecision: function() {
        if (!this.isDecisionExists()) return false;
        this.viewMode = "decision";
        this.loadContent();
        this.$element.find(".decisionLinkDiv").addClass("active");
        this.$element.find(".ruleLinkDiv").removeClass("active");
        this.collapseEntry(this.currentSelectedRule, "rule");
        this.expandEntry(this.currentSelectedRule, "decision");
        return false;
    },
    showRule: function() {
        this.$element.find(".ruleLinkDiv").addClass("active");
        var decisionLinkDiv = this.$element.find(".decisionLinkDiv");
        decisionLinkDiv.removeClass("active");
        this.collapseEntry(this.currentSelectedRule, "decision");
        this.expandEntry(this.currentSelectedRule, "rule");
        if (this.isDecisionExists()) decisionLinkDiv.show(); else decisionLinkDiv.hide();
        this.viewMode = "rule";
        if (!this.skipUrlSet) this.loadContent();
        this.skipUrlSet = false;
        return false;
    },
    isDecisionExists: function() {
        if (this.decisions) {
            return this.decisions.indexOf(parseFloat(this.currentSelectedRule)) != -1;
        }
        return this.currentSelectedRule < 100;
    },
    selectRule: function(itemId, type) {
        this.collapseEntry(this.currentSelectedRule, "rule");
        this.collapseEntry(this.currentSelectedRule, "decision");
        this.currentSelectedRule = itemId;
        this.hashAlreadySet = false;
        if (type == "rule") this.showRule(); else this.showDecision();
        this.retrieveNextPreviousValues();
        this.setHash();
        return false;
    },
    firstTimeLoadNoHash: function() {
        return this.firstLoad && !this.initialHash;
    },
    expandEntry: function(itemId, type) {
        var navItem = this.$element.find("." + type + itemId + "Navigation");
        navItem.removeClass("off");
        this.$element.find(".rule" + itemId + "Title").addClass("off");
        if (this.mobileCheck()) return;
        if (this.firstTimeLoadNoHash()) return;
        this.scrollRightMenu(navItem);
    },
    scrollRightMenu: function(navItem) {
        var scroller = this.$element.find(".rule-book__side");
        scroller.scrollTop(scroller.scrollTop() + navItem.position().top - 20);
    },
    collapseEntry: function(itemId, type) {
        this.$element.find("." + type + itemId + "Navigation").addClass("off");
        this.$element.find(".rule" + itemId + "Title").removeClass("off");
    },
    retrieveNextPreviousValues: function() {
        for (i = 0; i < this.rulesOrder.length; i++) {
            if (this.rulesOrder[i] == this.currentSelectedRule) {
                if (i > 0) this.previousRuleId = this.rulesOrder[i - 1]; else this.previousRuleId = "";
                if (i < this.rulesOrder.length - 1) this.nextRuleId = this.rulesOrder[i + 1]; else this.nextRuleId = "";
            }
        }
    }
});

var usga = window.usga || {};

usga.ScheduleCompetitions = usga.BaseCloudinaryModule.extend({
    context: null,
    helpers: null,
    onDocumentReady: function() {
        this.tabControl = new usga.Tabs(this.$element.find(".tabbable"));
        this.tabControl.bind("onTabChanged", this.proxy(this.onTabChanged));
        var me = this;
        this.context = new can.Map($.extend({
            items: [],
            sortBy: "date",
            sortOrder: {
                date: "asc",
                name: "asc"
            }
        }, this.options));
        this.helpers = {
            range: function(options) {
                var rangeStart = usga.getMomentInNewYorkTimezone(options.context.startDate), rangeEnd = usga.getMomentInNewYorkTimezone(options.context.endDate);
                return rangeStart.format("MMM D") + (!options.context.oneDayEvent ? "-" + rangeEnd.format((rangeStart.month() != rangeEnd.month() ? "MMM " : "") + "D") : "");
            },
            iconClass: function(options, el) {
                var iconClass = options.context.cssClass;
                if (iconClass) {
                    iconClass = can.hyphenate(iconClass.charAt(0).toLowerCase() + iconClass.substring(1)) + "__icon";
                }
                return iconClass;
            }
        };
        var feedUrl = this.options.feedUrl + "." + this.options.defaultYear + "-01-01." + this.options.defaultYear + "-12-31." + this.options.eventsType + this.options.feedSuffix;
        $.getJSON(feedUrl, this.proxy(this.onFeedLoaded, this.options.defaultYear));
    },
    onFeedLoaded: function(year, data) {
        can.batch.start();
        var items = data && data.items ? data.items : [];
        this.context.items.replace(items);
        this.sortItems();
        var html = can.view("#scheduleCompetitionEventsTemplate", this.context, this.helpers), $container = this.$element.find("div#tab" + year + " .block-schedule-competitions__envelope");
        $container.empty().append(html);
        can.batch.stop();
        this.applyCloudinary();
    },
    sortItems: function() {
        var me = this;
        can.batch.start();
        if (this.context.sortBy === "name") {
            me.context.items.sort(this.proxy(function(item1, item2) {
                var name1 = item1.name.toLowerCase(), name2 = item2.name.toLowerCase(), result = 0;
                if (name1 > name2) {
                    result = 1;
                } else if (name1 < name2) {
                    result = -1;
                }
                if (name1 === name2) {
                    var time1 = usga.getMomentInNewYorkTimezone(item1.startDate).valueOf(), time2 = usga.getMomentInNewYorkTimezone(item2.startDate).valueOf();
                    if (time1 > time2) {
                        result = 1;
                    } else if (time1 < time2) {
                        result = -1;
                    }
                }
                if (result !== 0 && this.context.sortOrder.name === "desc") {
                    result *= -1;
                }
                return result;
            }));
        }
        if (this.context.sortBy === "date") {
            me.context.items.sort(this.proxy(function(item1, item2) {
                var time1 = usga.getMomentInNewYorkTimezone(item1.startDate).valueOf(), time2 = usga.getMomentInNewYorkTimezone(item2.startDate).valueOf(), result = 0;
                if (time1 > time2) {
                    result = 1;
                } else if (time1 < time2) {
                    result = -1;
                }
                if (time1 === time2) {
                    var name1 = item1.name.toLowerCase(), name2 = item2.name.toLowerCase();
                    if (name1 > name2) {
                        result = 1;
                    } else if (name1 < name2) {
                        result = -1;
                    }
                }
                if (result !== 0 && this.context.sortOrder.date === "desc") {
                    result *= -1;
                }
                return result;
            }));
        }
        this.context.attr("items", this.context.items.slice(0));
        can.batch.stop();
        this.applyCloudinary();
    },
    onTabChanged: function(event, tabId) {
        var year = tabId.substr(3);
        if (year) {
            var feedUrl = this.options.feedUrl + "." + year + "-01-01." + year + "-12-31." + this.options.eventsType + this.options.feedSuffix;
            $.getJSON(feedUrl, this.proxy(this.onFeedLoaded, year));
        }
    },
    ".cell-more click": function(el) {
        var elContainer = el.closest("div.tr"), cellMoreItem = el.find("span.cell-more__item"), opened = elContainer.hasClass("tr_open");
        if (opened) {
            elContainer.removeClass("tr_open");
            cellMoreItem.text("more");
        } else {
            elContainer.addClass("tr_open");
            cellMoreItem.text("less");
        }
    },
    "a.sort-link click": function($el) {
        var field = $el.data("sort-field"), $parent = $el.closest(".thead");
        if ($parent.length !== 0 && field) {
            var ordering = this.context.sortOrder && this.context.sortOrder[field] ? this.context.sortOrder[field] : "asc";
            $parent.find('.sort-link[data-sort-field!="' + field + '"]').removeClass("sort-asc").removeClass("sort-desc");
            if ($el.hasClass("sort-asc") || $el.hasClass("sort-desc")) {
                ordering = ordering === "asc" ? "desc" : "asc";
            }
            this.context.attr("sortBy", field);
            this.context.attr("sortOrder." + field, ordering);
            $el.removeClass("sort-asc").removeClass("sort-desc").addClass("sort-" + ordering);
            this.sortItems();
        }
        return false;
    }
});

var usga = window.usga || {};

usga.Schedule = usga.BaseCloudinaryModule.extend({
    context: null,
    helpers: null,
    init: function() {
        this._super();
    },
    onDocumentReady: function() {
        var me = this;
        if (this.$element.closest(".frame").find(".block__social").length === 0) {
            this.$element.addClass("block-schedule-no-socials");
        }
        this.context = new can.Map(this.options);
        this.helpers = {
            range: function(options) {
                var rangeStart = usga.getMomentInNewYorkTimezone(options.context.startDate), rangeEnd = usga.getMomentInNewYorkTimezone(options.context.endDate);
                return rangeStart.format("MMM D") + (!options.context.oneDayEvent ? "-" + rangeEnd.format((rangeStart.month() != rangeEnd.month() ? "MMM " : "") + "D") : "");
            },
            iconClass: function(options) {
                var iconClass = options.context.attr("smallBreakpointEventItem.cssClass");
                if (iconClass) {
                    iconClass = can.hyphenate(iconClass.charAt(0).toLowerCase() + iconClass.substring(1) + "__icon");
                }
                return iconClass;
            }
        };
        var html = can.view("#scheduleItemsTemplate", this.context, this.helpers);
        this.$element.find(".block-schedule__envelope").append(html);
        $.getJSON(this.options.feedUrl, this.proxy(this.onFeedLoaded));
    },
    onFeedLoaded: function(data) {
        this.context.attr("items", data.items);
        var html = can.view("#scheduleItemsTemplate", this.context, this.helpers);
        this.$element.find(".block-schedule__envelope").empty().append(html);
        this.applyCloudinary();
        this.checkItemsVisibility();
    },
    onLayout: function() {
        this.checkItemsVisibility();
    },
    checkItemsVisibility: function() {
        var $container = this.$element.find(".block-schedule__envelope");
        var $items = $container.find(".block-schedule__envelope__item");
        if (this.isSmallScreen() || this.isMediumScreen() || this.isBigScreen()) {
            $items.css("display", "");
        } else {
            var containerHeight = $container.outerHeight(true);
            var itemsHeight = 0;
            $items.each(function() {
                var $item = $(this);
                itemsHeight += $item.outerHeight(true);
                $item.toggle(itemsHeight <= containerHeight);
            });
        }
    }
});

usga.SearchResults = usga.BaseSearchModule.extend({
    defaults: {
        template: "#search-results-template",
        paginatorTemplate: "#search-paginator-template",
        limit: 10
    }
}, {
    $query: null,
    isInitialQuery: false,
    fullSearchExperience: true,
    _queriedPage: 0,
    init: function(element, options) {
        var queriedQuery = this._getQueriedQuery();
        this._super();
        this._setPaginator();
        this._setData();
        this.$element.find("> .inner").append(this._renderTemplate());
        this.$query = this.$element.find(".search-results__form__field input");
        this._setEvents();
        if (queriedQuery) {
            this.$query.val(queriedQuery);
            this.context.attr("query", queriedQuery);
            this.isInitialQuery = true;
            this.search(true, this._getQueriedType() === "");
        }
        this.updateTypeList();
    },
    _setData: function() {
        var queriedType = this._getQueriedType();
        this.context = new can.Map({
            query: "",
            typedQuery: "",
            type: queriedType || "all",
            results: null,
            totalResults: 0,
            facetCounts: null,
            error: null,
            paginator: new usga.Paginator({
                limit: this.options.limit
            })
        });
        this._queriedPage = this._getQueriedPage();
        if (this._queriedPage > 1) {
            this.context.paginator.page(this._queriedPage);
        }
    },
    _setPaginator: function() {
        can.Component.extend({
            tag: "paginator",
            template: $(this.options.paginatorTemplate)[0] ? can.view(this.options.paginatorTemplate) : "",
            events: {
                "a[data-page] click": this.proxy(function($el, event) {
                    event.preventDefault();
                    this.context.paginator.page($el.data("page"));
                    this.search(true, this.fullSearchExperience);
                }),
                ".results__content__pagination__nav_link click": this.proxy(function($el, event) {
                    event.preventDefault();
                    this.search(true, this.fullSearchExperience);
                })
            }
        });
    },
    _setEvents: function() {
        this.context.bind("change", this.proxy(function(ev, attr, how, newVal, oldVal) {
            if (attr === "type" && newVal !== oldVal) {
                this.onTypeChanged();
            }
        }));
    },
    _isFullSearchExperienceApplicable: function() {
        return this.fullSearchExperience && (!this.context.type || this.context.type === "all");
    },
    _getQueriedQuery: function() {
        var fragment = usga.url.getHash(), q = fragment.q ? ("" + fragment.q).trim() : "";
        return decodeURIComponent(q);
    },
    _getQueriedPage: function() {
        var fragment = usga.url.getHash();
        return fragment.page ? +fragment.page : 0;
    },
    _getQueriedType: function() {
        var fragment = usga.url.getHash(), type = fragment.type ? ("" + fragment.type).trim() : "";
        if (type.match(/rules/i)) {
            type = "rules";
        }
        type = [ "all", "news", "videos", "photos", "rules" ].indexOf(type) !== -1 ? type : "";
        return type;
    },
    _setError: function(caption, body) {
        this.context.attr("error", {
            title: caption,
            message: body
        });
    },
    onDocumentReady: function() {
        this.$element.find(".results__content__header__dropdown .dropdown").chosen({
            disable_search_threshold: 10,
            width: "100%"
        });
    },
    search: function(preserveOffset, fullSearch) {
        this.clearForm();
        usga.scrollTo(this.$element.find(".inner:first"));
        if (!preserveOffset) {
            this.context.paginator.attr("offset", 0);
        }
        var currentPage = this.context.paginator.page();
        this.fullSearchExperience = !!fullSearch;
        if (this.context.query) {
            document.location.replace(can.sub("#q={q}{type}{page}", {
                q: usga.BaseSearchModule.prepareQueryText(this.context.query),
                type: this.context.type ? "&type=" + this.context.type : "",
                page: currentPage ? "&page=" + currentPage : ""
            }));
            var additionalData = {}, q = this.context.query;
            if (this.context.type && this.context.type !== "all") {
                additionalData.contentType = can.capitalize(this.context.type);
            }
            if (this.context.paginator.offset > 0) {
                additionalData.offset = this.context.paginator.offset;
            }
            additionalData.hits = this.options.limit;
            this._makeRequest(q, additionalData).done(this.proxy(function(data) {
                if (this.isInitialQuery || this._isFullSearchExperienceApplicable()) {
                    this._trackDtmFullSearch(q, this._getSearchTotal(data));
                } else {
                    this._trackDtmTypedSearch(q, this._getSearchTotal(data), this.context.type);
                }
                this.isInitialQuery = false;
            })).done(this.proxy(this.setRenderItems)).done(this.proxy(function() {
                this.updateProtectedLinks();
            })).fail(this.proxy(function(xhr) {
                this._setError("Error", xhr.statusText);
            }));
        }
    },
    clearForm: function() {
        this.context.attr("error", null);
    },
    _setupHighlightText: function(text) {
        var testElement = $("<div/>").html(text), nextNotValidElement = testElement.find(':first:not(span[class~="highlight"])');
        while (nextNotValidElement[0]) {
            nextNotValidElement.replaceWith(nextNotValidElement.html());
            nextNotValidElement = testElement.find(':first:not(span[class~="highlight"])');
        }
        testElement.find('span[class~="highlight"]').each(function() {
            var $el = $(this);
            $el.removeClass().addClass("results__content__list__item__body-highlight");
            $el.html(usga.stripTags($el.html()));
        });
        return testElement.html();
    },
    _prepareRenderItem: function(document) {
        var prep = this._super(document, true);
        prep.title = this._setupHighlightText(prep.title);
        prep.text = this._setupHighlightText(prep.text);
        return prep;
    },
    _getSearchTotal: function(data) {
        if (!this.context.type || this.context.type === "all") {
            return this._getDocumentsCount(data);
        } else if (this.context.type) {
            var facetCounts = this._getFacetCounts(data);
            if (!facetCounts[this.context.type]) {
                return 0;
            }
            return facetCounts[this.context.type].count || 0;
        }
        return 0;
    },
    _getFacetCounts: function(data) {
        var counts = {};
        if (usga.isObject(data) && data.facets) {
            for (var i = 0, len = data.facets.length; i < len; i++) {
                var facet = data.facets[i];
                if (facet.field === "contentType") {
                    if ($.isArray(facet.buckets)) {
                        var buckets = $.merge([], facet.buckets);
                        for (var i2 = 0, len2 = buckets.length; i2 < len2; i2++) {
                            var documentType = this._plainDocumentType(buckets[i2].label);
                            if (documentType.match(/rules/i)) {
                                documentType = "rules";
                            }
                            if (!counts[documentType]) {
                                counts[documentType] = {
                                    count: 0,
                                    label: buckets[i2].label || "",
                                    type: documentType
                                };
                            }
                            counts[documentType].count += buckets[i2].count || 0;
                        }
                    }
                }
            }
        }
        $.each(usga.keys(counts), function(key, item) {
            if (!item.count || item.count === null) {
                delete counts[key];
            }
        });
        return counts;
    },
    setRenderItems: function(data) {
        var documents = this._getDocuments(data), items = [], categories = {};
        can.batch.start();
        for (var i = 0, len = documents.length; i < len; i++) {
            var document = documents[i], type = this._getDocumentType(document), typeName = type.name;
            if (typeName.match(/rules/i)) {
                typeName = "rules";
            }
            if (!categories[typeName]) {
                categories[typeName] = type.label;
            }
            if (!type || [ "courses", "store" ].indexOf(type.name) !== -1) {
                continue;
            }
            items.push(this._prepareRenderItem(document));
        }
        var totalResults = this._getSearchTotal(data), totalDocuments = this._getDocumentsCount(data), facetCounts = this._getFacetCounts(data);
        if (this.context.type && this.context.type !== "all" && !facetCounts[this.context.type]) {
            facetCounts[this.context.type] = {
                count: 0
            };
        }
        this.context.attr("facetCounts", null);
        this.context.attr("results", null);
        this.context.attr({
            typedQuery: this.context.query,
            results: items,
            facetCounts: facetCounts,
            resultsCount: totalResults,
            documentsCount: totalDocuments
        });
        this.context.paginator.attr("count", totalResults);
        can.batch.stop();
        this.context.attr("foundOfType", this.$element.find(can.sub('.results__content__header__list a[data-type="{type}"]', {
            type: this.context.type || "all"
        })).data("label"));
        this.updateTypeList();
        this.applyCloudinary();
        this.updateProtectedLinks();
    },
    updateTypeList: function() {
        var list = this.$element.find(".results__content__header__list");
        list.find("a[data-type]").removeClass("active");
        list.find(can.sub('[data-type="{type}"]', {
            type: this.context.type
        })).addClass("active");
    },
    onTypeChanged: function() {
        this.updateTypeList();
    },
    _getQueryText: function() {
        var query = this._super();
        this.$query.val(query);
        return query;
    },
    ".search-results__form .button click": function() {
        this.context.attr("query", this._getQueryText());
        if (this.context.query) {
            this.context.attr("type", "all");
            this.search(false, true);
        }
    },
    ".search-results__form__field input keydown": function($el, event) {
        switch (event.keyCode) {
          case usga.BaseSearchModule.KEYS.ENTER:
            event.preventDefault();
            this.context.attr("query", this._getQueryText());
            if (this.context.query) {
                this.context.attr("type", "all");
                this.search(false, true);
            }
            break;

          default:
            break;
        }
    },
    ".results__content__header__list a[data-type] click": function($el, event) {
        event.preventDefault();
        this.context.attr("type", $el.data("type"));
        this.search(false, false);
    },
    ".results__content__header .dropdown change": function($el, event) {
        event.preventDefault();
        this.search(false, false);
    }
});

usga.SearchRules = usga.BaseCloudinaryModule.extend({
    defaults: {
        baseSearchPageUrl: "",
        searchPageUrl: "/search-results.html#q={query}{type}"
    }
}, {
    onFirstShow: function() {
        this._super();
        this.getQuizData();
    },
    getQuizData: function() {
        if (this.options.quizUrl) {
            $.getJSON(this.options.quizUrl, this.proxy(this.onGetQuiz));
        }
    },
    onGetQuiz: function(data) {
        var html = can.view("#quizTemplate", data.item);
        this.$element.find(".quiz-holder").append(html);
        this.$quiz = this.$element.find(".block__test.quiz");
        this.$result = this.$element.find(".block__test.result");
        this.$result.hide();
    },
    ".search-rules__form submit": function($form, event) {
        event.preventDefault();
        var queryText = $form.find(".search-rules__form__input").val().trim();
        if (queryText.length > 0) {
            usga.BaseSearchModule.navigateToUrl(usga.BaseSearchModule.getResultsUrl(this.options.baseSearchPageUrl, this.options.searchPageUrl, queryText, "rules"));
        }
    },
    ".block__test__form__item__input change": function($el, evt) {
        this.correctAnswer = !!$el.attr("data-correct");
    },
    ".block__test__form__item__submit click": function() {
        this.$quiz.hide();
        this.$result.show();
        if (this.isSmallScreen() || this.isMediumScreen()) {
            window.usga.scrollTo(this.$element.find(".quiz-holder"));
        }
        if (this.correctAnswer) {
            this.$result.find(".block__test__answer-status.correct").show();
            this.$result.find(".block__test__answer-status.incorrect").hide();
        } else {
            this.$result.find(".block__test__answer-status.incorrect").show();
            this.$result.find(".block__test__answer-status.correct").hide();
        }
    }
});

usga.ChampionshipSliderLive = usga.VariableSlider.extend({
    sliderSelector: ".main_slider_championships-live",
    getSliderConfig: function() {
        var config = {
            minSlides: 1,
            maxSlides: 3,
            slideWidth: 370,
            slideMargin: 30,
            controls: false,
            adaptiveHeight: true
        };
        var screenSize = this.getScreenSize();
        switch (screenSize) {
          case "bigger":
          case "big":
            config.maxSlides = 2;
            break;

          case "medium":
          case "small":
            config.maxSlides = 1;
            config.slideMargin = 0;
            config.slideWidth = 0;
            break;
        }
        return config;
    }
});

usga.ChampionshipMediaSlider = usga.BaseCloudinaryModule.extend({
    _sliderIsLoaded: false,
    _initSlider: function() {
        var parameters = {
            nextButton: ".swiper-button-next",
            prevButton: ".swiper-button-prev",
            pagination: ".swiper-pagination",
            paginationClickable: true,
            slidesPerView: "auto",
            spaceBetween: 1,
            simulateTouch: false,
            onImagesReady: this.proxy(this._onSliderLoaded)
        };
        if (this.options.delay) {
            parameters.autoplay = this.options.delay * 1e3;
        }
        if (this.options.carousel) {
            parameters.loop = true;
        }
        new Swiper(this.$element.find(".slider-wrapper"), parameters);
    },
    onFirstShow: function() {
        this._super();
        this._initSlider();
    },
    _onSliderLoaded: function() {
        this._sliderIsLoaded = true;
    }
});

usga.ChampionshipSlider = usga.BaseCloudinaryModule.extend({
    initSlider: function() {
        var config = {
            minSlides: 1,
            maxSlides: 8,
            slideWidth: 390,
            slideMargin: 1,
            controls: true,
            adaptiveHeight: true,
            infiniteLoop: false,
            hideControlOnEnd: true,
            adjustOnResize: true,
            touchEnabled: usga.supports.touch
        };
        if (this.options.delay) {
            config.auto = true;
            config.pause = this.options.delay * 1e3;
        }
        if (this.options.carousel) {
            config.infiniteLoop = true;
        }
        this.slider = this.$element.find(".main_slider_championships").bxSlider(config);
    },
    redrawSlider: function() {
        var self = this;
        setTimeout(function() {
            self.slider.redrawSlider();
        }, 500);
    },
    onFirstShow: function() {
        this._super();
        this.initSlider();
    }
});

usga.JoinSlider = usga.BaseCloudinaryModule.extend({
    initSlider: function() {
        var $pager = this.$element.find("#slider-menu_join");
        var config = {
            pagerCustom: $pager,
            controls: false,
            touchEnabled: usga.supports.touch
        };
        if (this.options.delay) {
            config.auto = true;
            config.pause = this.options.delay * 1e3;
        }
        this.$element.find(".main_slider_join").bxSlider(config);
    },
    onFirstShow: function() {
        this._super();
        this.initSlider();
    }
});

usga.TicketSlider = usga.BaseCloudinaryModule.extend({
    $slider: null,
    initSlider: function() {
        this.$slider = this.$element.find(".main_slider_ticket");
        this.$slider.slick({
            dots: false,
            arrows: true,
            draggable: false,
            swipe: true,
            appendArrows: this.$element.find(".slick-nav__inner")
        });
        this.$slider.on("afterChange", this.proxy(this.onSlickSlideChanged));
        this.updateSliderMenu();
    },
    _updateLayout: function() {
        var state = this.getScreenSize() === "infinity";
        this.$slider.find(".main_slider__item").each(function() {
            $(this).find(".slides__item:gt(1)").toggle(state);
        });
    },
    onLayout: function() {
        this._updateLayout();
    },
    onFirstShow: function() {
        this._super();
        this.initSlider();
        this._updateLayout();
    },
    updateSliderMenu: function() {
        var currentSlideIndex = this.$slider.slick("slickCurrentSlide"), links = this.$element.find("#slider-menu_ticket .slider-menu__item__link");
        links.removeClass("active");
        links.filter(":eq(" + currentSlideIndex + ")").addClass("active");
    },
    onSlickSlideChanged: function(slick, slide) {
        this.updateSliderMenu();
    },
    "#slider-menu_ticket .slider-menu__item__link click": function($el, event) {
        event.preventDefault();
        this.$slider.slick("slickGoTo", $el.data("slide-index") || 0);
    }
});

usga = window.usga || {};

usga.SlideLatestNavUp = usga.BaseModule.extend({
    ".main_slider__item__latest_nav_up .slider-menu__item__link click": function(el) {
        var $link = $(el);
        var $parent = $link.closest(".main_slider__item__latest_nav_up");
        var $togglers = $parent.find(".slider-menu__item__link");
        var $index = $togglers.index($link);
        $togglers.filter(":lt(" + $index + "),:gt(" + $index + ")").removeClass("active");
        $link.addClass("active");
        $parent.find(".tab-pane").removeClass("active");
        $parent.find("." + $link.data("toggle-class")).addClass("active");
        return false;
    }
});

var usga = window.usga || {};

usga.SocialShare = usga.BaseModule.extend({
    twitterUrl: function() {
        return "http://www.twitter.com/share?url={shareUrl}";
    },
    facebookUrl: function() {
        return "http://www.facebook.com/sharer/sharer.php?u={shareUrl}";
    },
    googleplusUrl: function() {
        return "https://plus.google.com/share?url={shareUrl}";
    },
    linkedinUrl: function() {
        return "https://www.linkedin.com/shareArticle?url={shareUrl}";
    },
    showSocialWindow: function($el) {
        var socialName = $el.data("social-name"), url = document.URL.split("?")[0].split("#")[0];
        if (socialName === "email") {
            document.location = "mailto:?subject=Share&body=" + encodeURIComponent(url);
        } else if (socialName) {
            url = $el.data("url");
            if (url) {
                window.open(url, "_blank", "resizable=yes");
            } else {
                var shareUrlGetter = socialName.toLowerCase().replace(/[^a-z]/i, "") + "Url";
                if (this[shareUrlGetter]) {
                    var shareUrl = $el.data("share-url") || document.URL.split("?")[0];
                    window.open(this[shareUrlGetter]().replace("{shareUrl}", encodeURIComponent(shareUrl)), "_blank", "width=600,height=400,resizable=yes");
                }
            }
        }
    },
    ".social__item mouseup": function($el, evt) {
        evt.preventDefault();
        this.showSocialWindow($el);
    },
    ".social__item touchend": function($el, evt) {
        evt.preventDefault();
        this.showSocialWindow($el);
    }
});

usga.Store = usga.BaseCloudinaryModule.extend({
    onFirstShow: function() {
        if (!this.isSmallScreen()) {
            this._super();
        }
    },
    onLayout: function() {
        if (!this.isSmallScreen()) {
            this._super();
        }
    }
});

usga.Tabs = usga.BaseCloudinaryModule.extend({
    onDocumentReady: function() {
        this.$element.find(".nav-tabs-drop").tabdrop({
            updateSelect: true
        }).on("tabChange", this.proxy(this.onTabChanged));
    },
    onFirstShow: function() {
        this.applyCloudinary(this.$element.find(".tabbable-head"));
    },
    onLayout: function() {
        this.applyCloudinary(this.$element.find(".tabbable-head"));
    },
    onTabChanged: function(event, tabId) {
        this.trigger("onTabChanged", tabId);
    }
});

usga.VideoDetails = usga.BaseCloudinaryModule.extend({
    init: function() {
        this._super();
        this.$sideBar = this.$element.find(".video-details__container__sidebar");
        this.$playerContainer = this.$element.find(".video-details__container__content__player");
    },
    initSlider: function() {
        this.slider = this.$element.find(".video-details__container__sidebar .related-list").bxSlider({
            controls: false,
            infiniteLoop: false,
            minSlides: 1,
            maxSlides: 1,
            slideWidth: this.mediumMaxWidth - 8,
            slideMargin: 0,
            adaptiveHeight: true,
            touchEnabled: usga.supports.touch
        });
    },
    syncSideBarHeight: function() {
        var height = "auto";
        if (this.isBigSize()) {
            height = this.$playerContainer.height() - 30;
        }
        this.$sideBar.height(height);
    },
    isBigSize: function() {
        return this.isBigScreen() || this.isBiggerScreen() || this.isInfinityScreen();
    },
    onDocumentReady: function() {
        this.syncSideBarHeight();
        if (!this.isBigSize() && !this.slider) {
            this.initSlider();
        }
    },
    onLayout: function() {
        if (this.isBigSize() && this.slider) {
            this.slider.destroySlider();
            this.slider = null;
        } else if (!this.isBigSize() && !this.slider) {
            this.initSlider();
        }
    },
    onWindowResize: function() {
        this.syncSideBarHeight();
    }
});

usga.VideoPlayer = usga.BaseModule.extend({
    onFirstShow: function() {
        var number = Math.floor(Math.random() * 100) + 1;
        window["onTemplateLoad" + number] = this.proxy(this.onTemplateLoad);
        window["onTemplateReady" + number] = this.proxy(this.onTemplateReady);
        var data = {
            playerId: this.options.playerId,
            playerKey: this.options.playerKey,
            videoId: this.options.videoId,
            number: number
        };
        var html = can.view("#videoPlayerTemplate", data);
        this.$element.append(html);
        brightcove.createExperiences();
    },
    onTemplateLoad: function(experienceID) {
        this.player = brightcove.api.getExperience(experienceID);
        this.APIModules = brightcove.api.modules.APIModules;
        this.$experianceContainer = this.$element.find(".BrightcoveExperience");
    },
    onTemplateReady: function(evt) {
        var videoPlayer = this.player.getModule(this.APIModules.VIDEO_PLAYER);
        this.experienceModule = this.player.getModule(this.APIModules.EXPERIENCE);
        if (this.options.autoplay) {
            videoPlayer.play();
        }
    },
    onWindowResize: function() {
        if (this.experienceModule.experience.type == "html") {
            var resizeWidth = this.$experianceContainer.width();
            var resizeHeight = this.$experianceContainer.height();
            this.experienceModule.setSize(resizeWidth, resizeHeight);
        }
    }
});

usga.WelcomeWidget = usga.BaseModule.extend({
    context: null,
    accountUser: null,
    onDocumentReady: function() {
        this.context = new can.Map(this.options);
        usga.Gigya.onUser(this.proxy(this.updateUI));
    },
    createWidgetCustomMessages: function(dsUser) {
        var resultWelcomeWidgetValues = [];
        if (!this.options.overrideMessage) {
            var customMembershipWidgetData = null;
            if (this.accountUser.data.memberLevel && this.options.memberlevels) {
                switch (this.accountUser.data.memberLevel.toLowerCase()) {
                  case "basic membership":
                  case "dual membership":
                    if (this.options.memberlevels.member) customMembershipWidgetData = this.options.memberlevels.member;
                    break;

                  case "championship club membership":
                  case "champion club dual membership":
                    if (this.options.memberlevels.champion) customMembershipWidgetData = this.options.memberlevels.champion;
                    break;

                  case "eagle club membership":
                  case "eagle club dual membership":
                    if (this.options.memberlevels.eagle) customMembershipWidgetData = this.options.memberlevels.eagle;
                    break;

                  case "medal club membership":
                  case "medal club dual membership":
                    if (this.options.memberlevels.medal) customMembershipWidgetData = this.options.memberlevels.medal;
                    break;

                  case "honor club member":
                  case "honor club dual membership":
                    if (this.options.memberlevels.honor) customMembershipWidgetData = this.options.memberlevels.honor;
                    break;

                  case "patron of golf":
                  case "patron of golf dual membership":
                    if (this.options.memberlevels.patron) customMembershipWidgetData = this.options.memberlevels.patron;
                    break;

                  case "patron plus member":
                  case "patron plus dual member":
                    if (this.options.memberlevels.patronplus) customMembershipWidgetData = this.options.memberlevels.patronplus;
                    break;

                  default:
                    if (this.options.memberlevels.member) customMembershipWidgetData = this.options.memberlevels.member;
                    break;
                }
            }
            var customInterestWidgetData = [];
            if (dsUser && dsUser.data && dsUser.data.interests && this.options.interests) {
                var interests = dsUser.data.interests;
                if (interests.amateurgolf && this.options.interests.amateur) {
                    customInterestWidgetData.push(this.options.interests.amateur.values);
                }
                if (interests.coursecare && this.options.interests.course) {
                    customInterestWidgetData.push(this.options.interests.course.values);
                }
                if (interests.equipment && this.options.interests.equipment) {
                    customInterestWidgetData.push(this.options.interests.equipment.values);
                }
                if (interests.handicapping && this.options.interests.handicapping) {
                    customInterestWidgetData.push(this.options.interests.handicapping.values);
                }
                if (interests.history && this.options.interests.history) {
                    customInterestWidgetData.push(this.options.interests.history.values);
                }
                if (interests.juniorgolf && this.options.interests.juniorgolf) {
                    customInterestWidgetData.push(this.options.interests.juniorgolf.values);
                }
                if (interests.paceofplay && this.options.interests.paceofplay) {
                    customInterestWidgetData.push(this.options.interests.paceofplay.values);
                }
                if (interests.rules && this.options.interests.rules) {
                    customInterestWidgetData.push(this.options.interests.rules.values);
                }
                if (interests.usopen && this.options.interests.usopens) {
                    customInterestWidgetData.push(this.options.interests.usopens.values);
                }
                if (interests.volunteering && this.options.interests.volunteering) {
                    customInterestWidgetData.push(this.options.interests.volunteering.values);
                }
                if (interests.etitquette && this.options.interests.etiquette) {
                    customInterestWidgetData.push(this.options.interests.etiquette.values);
                }
            }
            var customUserStateWidgetData = null;
            if (this.options.userstates) {
                if (usga.Gigya.isMember() && usga.Gigya.isUserState("standard-active")) {
                    customUserStateWidgetData = this.options.userstates.standardactive;
                }
                if (usga.Gigya.isMember() && usga.Gigya.isUserState("standard-expiring")) {
                    customUserStateWidgetData = this.options.userstates.standardexpiring;
                    if (dsUser && dsUser.data && dsUser.data.membership && dsUser.data.membership.autorenew === true) {
                        customUserStateWidgetData = this.options.userstates.standardactive;
                    }
                }
                if (usga.Gigya.isMember() && usga.Gigya.isUserState("standard-expired")) {
                    customUserStateWidgetData = this.options.userstates.standardexpired;
                }
                if (usga.Gigya.isMember() && usga.Gigya.isUserState("standard-in-grace")) {
                    customUserStateWidgetData = this.options.userstates.standardingrace;
                }
                if (usga.Gigya.isFan()) {
                    customUserStateWidgetData = this.options.userstates.standardnonmember;
                }
                if (usga.Gigya.isProspect()) {
                    customUserStateWidgetData = this.options.userstates.standardprospect;
                }
            }
            if (customMembershipWidgetData) {
                $.each(customMembershipWidgetData.values, function(i, value) {
                    resultWelcomeWidgetValues.push(value);
                });
            }
            if (customInterestWidgetData) {
                $.each(customInterestWidgetData, function(i, values) {
                    $.each(values, function(i, value) {
                        resultWelcomeWidgetValues.push(value);
                    });
                });
            }
            if (customUserStateWidgetData) {
                $.each(customUserStateWidgetData.values, function(i, value) {
                    resultWelcomeWidgetValues.push(value);
                });
            }
        } else {
            $.each(this.options.overrideMessage.values, function(i, value) {
                resultWelcomeWidgetValues.push(value);
            });
        }
        var filteredWelcomeWidgetValues = [];
        $.each(resultWelcomeWidgetValues, function(i, value) {
            if ((!value.start || !moment(new Date(value.start)).isValid() || moment() > moment(new Date(value.start))) && (!value.end || !moment(new Date(value.end)).isValid() || moment() < moment(new Date(value.end)))) {
                filteredWelcomeWidgetValues.push(value);
            }
        });
        if (filteredWelcomeWidgetValues.length === 0) return;
        var resultWelcomeWidgetValuesCount = filteredWelcomeWidgetValues.length;
        var resultWelcomeWidgetRandNumber = Math.floor(Math.random() * resultWelcomeWidgetValuesCount);
        var wwResult = $.extend(true, {}, filteredWelcomeWidgetValues[resultWelcomeWidgetRandNumber]);
        var resultWelcomeWidget = this.replaceKeys(wwResult, this.accountUser);
        resultWelcomeWidget.buttons = this.parseWelcomeWidgetButton(resultWelcomeWidget);
        var template = can.view("#welcomeWidgetForm", resultWelcomeWidget, this.accountUser);
        this.$element.find(".welcome-widget-content").html(template);
    },
    updateUI: function(user) {
        if (user) {
            this.accountUser = user;
            usga.Gigya.getDataStore(this.proxy(this.createWidgetCustomMessages));
        } else {
            var resultWelcomeWidgetValues = [];
            $.each(this.options.userstates.anonymous.values, function(i, value) {
                resultWelcomeWidgetValues.push(value);
            });
            var anonymousTextCount = this.options.userstates.anonymous.values.length;
            var randNumber = Math.floor(Math.random() * anonymousTextCount);
            var resultWelcomeWidget = resultWelcomeWidgetValues[randNumber];
            resultWelcomeWidget.buttons = this.parseWelcomeWidgetButton(resultWelcomeWidget);
            var template = can.view("#signInWidgetForm", resultWelcomeWidget);
            this.$element.find(".welcome-widget-content").html(template);
        }
    },
    parseWelcomeWidgetButton: function(data) {
        var welcomeWidgetButtons = [];
        welcomeWidgetButtons.push({
            buttonUrl: this.replaceUrl(data.button1url),
            buttonText: data.button1text,
            buttonCss: data.button1css
        });
        welcomeWidgetButtons.push({
            buttonUrl: this.replaceUrl(data.button2url),
            buttonText: data.button2text,
            buttonCss: data.button2css
        });
        welcomeWidgetButtons.push({
            buttonUrl: this.replaceUrl(data.button3url),
            buttonText: data.button3text,
            buttonCss: data.button3css
        });
        return welcomeWidgetButtons;
    },
    replaceUrl: function(url) {
        if (!url || url.indexOf("http") === 0 || url.indexOf("www") === 0 || url.indexOf(".html") != -1) return url;
        return url + ".html";
    },
    replaceKeys: function(data, user) {
        var keys = [ {
            key: "##FirstName##",
            value: user.profile.firstName ? user.profile.firstName : ""
        }, {
            key: "##LastName##",
            value: user.profile.lastName ? user.profile.lastName : ""
        }, {
            key: "##MemberID##",
            value: user.data.memberId ? user.data.memberId : ""
        }, {
            key: "##MembershipLevel##",
            value: user.data.memberLevel ? user.data.memberLevel : ""
        }, {
            key: "##ExpirationDate##",
            value: user.data.memberExpDate ? user.data.memberExpDate : ""
        } ];
        $.each(keys, function(i, memberData) {
            data.subtitle = data.subtitle.replace(memberData.key, memberData.value);
            data.title = data.title.replace(memberData.key, memberData.value);
            data.body = data.body.replace(memberData.key, memberData.value);
            data.footer = data.footer.replace(memberData.key, memberData.value);
        });
        return data;
    },
    ".signin.button.button_color1 click": function(el) {
        usga.Gigya.login();
    },
    ".join.button.button_color1 click": function(el) {
        usga.Gigya.register();
    },
    ".my_account.button.button_color1 click": function(el) {
        usga.Gigya.profile();
    },
    ".member_login click": function(el) {
        usga.Gigya.login();
    },
    ".member_register click": function(el) {
        usga.Gigya.register();
    },
    ".member_connect click": function(el) {
        usga.Gigya.connectAccount();
    }
});

usga.WorldRanking = usga.BaseModule.extend({
    initSlider: function() {
        this.slider = this.$element.find(".world-ranking__slider").bxSlider({
            infiniteLoop: false,
            minSlides: 1,
            maxSlides: 1,
            slideWidth: this.mediumMaxWidth - 8,
            slideMargin: 0,
            adaptiveHeight: true,
            touchEnabled: usga.supports.touch
        });
    },
    onDocumentReady: function() {
        this.onLayout();
    },
    onLayout: function() {
        if ((this.isBiggerScreen() || this.isInfinityScreen()) && this.slider) {
            this.slider.destroySlider();
            this.slider = null;
        } else if (!this.isBiggerScreen() && !this.isInfinityScreen() && !this.slider) {
            this.initSlider();
        }
    }
});